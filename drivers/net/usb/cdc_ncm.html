<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › usb › cdc_ncm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cdc_ncm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * cdc_ncm.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) ST-Ericsson 2010-2012</span>
<span class="cm"> * Contact: Alexey Orishko &lt;alexey.orishko@stericsson.com&gt;</span>
<span class="cm"> * Original author: Hans Petter Selasky &lt;hans.petter.selasky@stericsson.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * USB Host Driver for Network Control Model (NCM)</span>
<span class="cm"> * http://www.usb.org/developers/devclass_docs/NCM10.zip</span>
<span class="cm"> *</span>
<span class="cm"> * The NCM encoding, decoding and initialization logic</span>
<span class="cm"> * derives from FreeBSD 8.x. if_cdce.c and if_cdcereg.h</span>
<span class="cm"> *</span>
<span class="cm"> * This software is available to you under a choice of one of two</span>
<span class="cm"> * licenses. You may choose this file to be licensed under the terms</span>
<span class="cm"> * of the GNU General Public License (GPL) Version 2 or the 2-clause</span>
<span class="cm"> * BSD license listed below:</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *    notice, this list of conditions and the following disclaimer in the</span>
<span class="cm"> *    documentation and/or other materials provided with the distribution.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE AUTHOR AND CONTRIBUTORS ``AS IS&#39;&#39; AND</span>
<span class="cm"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
<span class="cm"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE AUTHOR OR CONTRIBUTORS BE LIABLE</span>
<span class="cm"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
<span class="cm"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
<span class="cm"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="cm"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
<span class="cm"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
<span class="cm"> * SUCH DAMAGE.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/hrtimer.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/usb/usbnet.h&gt;</span>
<span class="cp">#include &lt;linux/usb/cdc.h&gt;</span>

<span class="cp">#define	DRIVER_VERSION				&quot;14-Mar-2012&quot;</span>

<span class="cm">/* CDC NCM subclass 3.2.1 */</span>
<span class="cp">#define USB_CDC_NCM_NDP16_LENGTH_MIN		0x10</span>

<span class="cm">/* Maximum NTB length */</span>
<span class="cp">#define	CDC_NCM_NTB_MAX_SIZE_TX			32768	</span><span class="cm">/* bytes */</span><span class="cp"></span>
<span class="cp">#define	CDC_NCM_NTB_MAX_SIZE_RX			32768	</span><span class="cm">/* bytes */</span><span class="cp"></span>

<span class="cm">/* Minimum value for MaxDatagramSize, ch. 6.2.9 */</span>
<span class="cp">#define	CDC_NCM_MIN_DATAGRAM_SIZE		1514	</span><span class="cm">/* bytes */</span><span class="cp"></span>

<span class="cp">#define	CDC_NCM_MIN_TX_PKT			512	</span><span class="cm">/* bytes */</span><span class="cp"></span>

<span class="cm">/* Default value for MaxDatagramSize */</span>
<span class="cp">#define	CDC_NCM_MAX_DATAGRAM_SIZE		8192	</span><span class="cm">/* bytes */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * Maximum amount of datagrams in NCM Datagram Pointer Table, not counting</span>
<span class="cm"> * the last NULL entry.</span>
<span class="cm"> */</span>
<span class="cp">#define	CDC_NCM_DPT_DATAGRAMS_MAX		40</span>

<span class="cm">/* Restart the timer, if amount of datagrams is less than given value */</span>
<span class="cp">#define	CDC_NCM_RESTART_TIMER_DATAGRAM_CNT	3</span>
<span class="cp">#define	CDC_NCM_TIMER_PENDING_CNT		2</span>
<span class="cp">#define CDC_NCM_TIMER_INTERVAL			(400UL * NSEC_PER_USEC)</span>

<span class="cm">/* The following macro defines the minimum header space */</span>
<span class="cp">#define	CDC_NCM_MIN_HDR_SIZE \</span>
<span class="cp">	(sizeof(struct usb_cdc_ncm_nth16) + sizeof(struct usb_cdc_ncm_ndp16) + \</span>
<span class="cp">	(CDC_NCM_DPT_DATAGRAMS_MAX + 1) * sizeof(struct usb_cdc_ncm_dpe16))</span>

<span class="k">struct</span> <span class="n">cdc_ncm_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_cdc_ncm_nth16</span> <span class="n">nth16</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp16</span> <span class="n">ndp16</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_ncm_dpe16</span> <span class="n">dpe16</span><span class="p">[</span><span class="n">CDC_NCM_DPT_DATAGRAMS_MAX</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_data</span> <span class="n">tx_ncm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_ncm_ntb_parameters</span> <span class="n">ncm_parm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hrtimer</span> <span class="n">tx_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tasklet_struct</span> <span class="n">bh</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_cdc_ncm_desc</span> <span class="o">*</span><span class="n">func_desc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_cdc_header_desc</span> <span class="o">*</span><span class="n">header_desc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_cdc_union_desc</span> <span class="o">*</span><span class="n">union_desc</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_cdc_ether_desc</span> <span class="o">*</span><span class="n">ether_desc</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">in_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">out_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">status_ep</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">control</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_curr_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_rem_skb</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">mtx</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">stop</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">tx_timer_pending</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_curr_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_curr_last_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_curr_frame_num</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_speed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_speed</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rx_max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">max_datagram_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_max_datagrams</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_remainder</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_modulus</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_ndp_modulus</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_seq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_seq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">connected</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cdc_ncm_txpath_bh</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cdc_ncm_tx_timeout_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="n">cdc_ncm_tx_timer_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">hr_timer</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">driver_info</span> <span class="n">cdc_ncm_info</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">cdc_ncm_driver</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">cdc_ncm_ethtool_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">cdc_devs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span>
		<span class="n">USB_CDC_SUBCLASS_NCM</span><span class="p">,</span> <span class="n">USB_CDC_PROTO_NONE</span><span class="p">),</span>
		<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cdc_ncm_info</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">cdc_devs</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cdc_ncm_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">net</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="n">DRIVER_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">));</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">cdc_ncm_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_no</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ntb_fmt_supported</span><span class="p">;</span>

	<span class="n">iface_no</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
				<span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">USB_CDC_GET_NTB_PARAMETERS</span><span class="p">,</span>
				<span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span>
				 <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">iface_no</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">),</span> <span class="mi">10000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;failed GET_NTB_PARAMETERS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* read correct set of parameters according to device mode */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">dwNtbInMaxSize</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">dwNtbOutMaxSize</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_remainder</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">wNdpOutPayloadRemainder</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_modulus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">wNdpOutDivisor</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ndp_modulus</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">wNdpOutAlignment</span><span class="p">);</span>
	<span class="cm">/* devices prior to NCM Errata shall set this field to zero */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max_datagrams</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">wNtbOutMaxDatagrams</span><span class="p">);</span>
	<span class="n">ntb_fmt_supported</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">bmNtbFormatsSupported</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">func_desc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">func_desc</span><span class="o">-&gt;</span><span class="n">bmNetworkCapabilities</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;dwNtbInMaxSize=%u dwNtbOutMaxSize=%u &quot;</span>
		 <span class="s">&quot;wNdpOutPayloadRemainder=%u wNdpOutDivisor=%u &quot;</span>
		 <span class="s">&quot;wNdpOutAlignment=%u wNtbOutMaxDatagrams=%u flags=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_remainder</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_modulus</span><span class="p">,</span>
		 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ndp_modulus</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max_datagrams</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* max count of tx datagrams */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max_datagrams</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max_datagrams</span> <span class="o">&gt;</span> <span class="n">CDC_NCM_DPT_DATAGRAMS_MAX</span><span class="p">))</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max_datagrams</span> <span class="o">=</span> <span class="n">CDC_NCM_DPT_DATAGRAMS_MAX</span><span class="p">;</span>

	<span class="cm">/* verify maximum size of received NTB in bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span> <span class="o">&lt;</span> <span class="n">USB_CDC_NCM_NTB_MIN_IN_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Using min receive length=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">USB_CDC_NCM_NTB_MIN_IN_SIZE</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span> <span class="o">=</span> <span class="n">USB_CDC_NCM_NTB_MIN_IN_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span> <span class="o">&gt;</span> <span class="n">CDC_NCM_NTB_MAX_SIZE_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Using default maximum receive length=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">CDC_NCM_NTB_MAX_SIZE_RX</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span> <span class="o">=</span> <span class="n">CDC_NCM_NTB_MAX_SIZE_RX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* inform device about NTB input size changes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">dwNtbInMaxSize</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USB_CDC_NCM_NCAP_NTB_INPUT_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp_input_size</span> <span class="o">*</span><span class="n">ndp_in_sz</span><span class="p">;</span>

			<span class="n">ndp_in_sz</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ndp_in_sz</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ndp_in_sz</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">size_err</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">USB_CDC_SET_NTB_INPUT_SIZE</span><span class="p">,</span>
					<span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span>
					 <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">iface_no</span><span class="p">,</span> <span class="n">ndp_in_sz</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ndp_in_sz</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">__le32</span> <span class="o">*</span><span class="n">dwNtbInMaxSize</span><span class="p">;</span>
			<span class="n">dwNtbInMaxSize</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dwNtbInMaxSize</span><span class="p">),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dwNtbInMaxSize</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">size_err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">dwNtbInMaxSize</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span><span class="p">);</span>

			<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
					<span class="n">USB_CDC_SET_NTB_INPUT_SIZE</span><span class="p">,</span>
					<span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span>
					 <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">iface_no</span><span class="p">,</span> <span class="n">dwNtbInMaxSize</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">dwNtbInMaxSize</span><span class="p">);</span>
		<span class="p">}</span>
<span class="nl">size_err:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Setting NTB Input Size failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* verify maximum size of transmitted NTB in bytes */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">&lt;</span>
	    <span class="p">(</span><span class="n">CDC_NCM_MIN_HDR_SIZE</span> <span class="o">+</span> <span class="n">CDC_NCM_MIN_DATAGRAM_SIZE</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">&gt;</span> <span class="n">CDC_NCM_NTB_MAX_SIZE_TX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Using default maximum transmit length=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">CDC_NCM_NTB_MAX_SIZE_TX</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">=</span> <span class="n">CDC_NCM_NTB_MAX_SIZE_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * verify that the structure alignment is:</span>
<span class="cm">	 * - power of two</span>
<span class="cm">	 * - not greater than the maximum transmit length</span>
<span class="cm">	 * - not less than four bytes</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ndp_modulus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">USB_CDC_NCM_NDP_ALIGN_MIN_SIZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="p">((</span><span class="o">-</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Using default alignment: 4 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ndp_modulus</span> <span class="o">=</span> <span class="n">USB_CDC_NCM_NDP_ALIGN_MIN_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * verify that the payload alignment is:</span>
<span class="cm">	 * - power of two</span>
<span class="cm">	 * - not greater than the maximum transmit length</span>
<span class="cm">	 * - not less than four bytes</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_modulus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">USB_CDC_NCM_NDP_ALIGN_MIN_SIZE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="p">((</span><span class="o">-</span><span class="n">val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">))</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Using default transmit modulus: 4 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_modulus</span> <span class="o">=</span> <span class="n">USB_CDC_NCM_NDP_ALIGN_MIN_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* verify the payload remainder */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_remainder</span> <span class="o">&gt;=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_modulus</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Using default transmit remainder: 0 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_remainder</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* adjust TX-remainder according to NCM specification. */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_remainder</span> <span class="o">=</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_remainder</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">)</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_modulus</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* additional configuration */</span>

	<span class="cm">/* set CRC Mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USB_CDC_NCM_NCAP_CRC_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">USB_CDC_SET_CRC_MODE</span><span class="p">,</span>
				<span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span>
				 <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
				<span class="n">USB_CDC_NCM_CRC_NOT_APPENDED</span><span class="p">,</span>
				<span class="n">iface_no</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Setting CRC mode off failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set NTB format, if both formats are supported */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntb_fmt_supported</span> <span class="o">&amp;</span> <span class="n">USB_CDC_NCM_NTH32_SIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">USB_CDC_SET_NTB_FORMAT</span><span class="p">,</span> <span class="n">USB_TYPE_CLASS</span>
				 <span class="o">|</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
				<span class="n">USB_CDC_NCM_NTB16_FORMAT</span><span class="p">,</span>
				<span class="n">iface_no</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Setting NTB format to 16-bit failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">=</span> <span class="n">CDC_NCM_MIN_DATAGRAM_SIZE</span><span class="p">;</span>

	<span class="cm">/* set Max Datagram Size (MTU) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">USB_CDC_NCM_NCAP_MAX_DATAGRAM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="o">*</span><span class="n">max_datagram_size</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">eth_max_sz</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ether_desc</span><span class="o">-&gt;</span><span class="n">wMaxSegmentSize</span><span class="p">);</span>

		<span class="n">max_datagram_size</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">max_datagram_size</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">max_datagram_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">max_dgram_err</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">USB_CDC_GET_MAX_DATAGRAM_SIZE</span><span class="p">,</span>
				<span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span>
				 <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">iface_no</span><span class="p">,</span> <span class="n">max_datagram_size</span><span class="p">,</span>
				<span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;GET_MAX_DATAGRAM_SIZE failed, use size=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">CDC_NCM_MIN_DATAGRAM_SIZE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">max_datagram_size</span><span class="p">);</span>
			<span class="cm">/* Check Eth descriptor value */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">&gt;</span> <span class="n">eth_max_sz</span><span class="p">)</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">=</span> <span class="n">eth_max_sz</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">&gt;</span> <span class="n">CDC_NCM_MAX_DATAGRAM_SIZE</span><span class="p">)</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">=</span>
						<span class="n">CDC_NCM_MAX_DATAGRAM_SIZE</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">&lt;</span> <span class="n">CDC_NCM_MIN_DATAGRAM_SIZE</span><span class="p">)</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">=</span>
					<span class="n">CDC_NCM_MIN_DATAGRAM_SIZE</span><span class="p">;</span>

			<span class="cm">/* if value changed, update device */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">!=</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">max_datagram_size</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
						<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
						<span class="n">USB_CDC_SET_MAX_DATAGRAM_SIZE</span><span class="p">,</span>
						<span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span>
						 <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">,</span>
						<span class="n">iface_no</span><span class="p">,</span> <span class="n">max_datagram_size</span><span class="p">,</span>
						<span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SET_MAX_DGRAM_SIZE failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">max_datagram_size</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">max_dgram_err:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">))</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">max_datagram_size</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cdc_ncm_find_endpoints</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ep</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ep</span> <span class="o">&lt;</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">ep</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">e</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">endpoint</span> <span class="o">+</span> <span class="n">ep</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_XFERTYPE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_INT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">status_ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">status_ep</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">USB_ENDPOINT_XFER_BULK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_in</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_ep</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_ep</span> <span class="o">=</span> <span class="n">e</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdc_ncm_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdc_ncm_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iface_no</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">hrtimer_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdc_ncm_tx_timer_cb</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bh</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ctx</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bh</span><span class="p">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">cdc_ncm_txpath_bh</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>

	<span class="cm">/* store ctx pointer in device data field */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ctx</span><span class="p">;</span>

	<span class="cm">/* get some pointers */</span>
	<span class="n">driver</span> <span class="o">=</span> <span class="n">driver_of</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">extralen</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>

	<span class="cm">/* parse through descriptors associated with control interface */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">advance</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">USB_CDC_UNION_TYPE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">union_desc</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">union_desc</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">usb_cdc_union_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">union_desc</span><span class="o">-&gt;</span><span class="n">bMasterInterface0</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">union_desc</span><span class="o">-&gt;</span><span class="n">bSlaveInterface0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">USB_CDC_ETHERNET_TYPE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ether_desc</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ether_desc</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">usb_cdc_ether_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">=</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ether_desc</span><span class="o">-&gt;</span><span class="n">wMaxSegmentSize</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">&lt;</span> <span class="n">CDC_NCM_MIN_DATAGRAM_SIZE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">=</span>	<span class="n">CDC_NCM_MIN_DATAGRAM_SIZE</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">&gt;</span> <span class="n">CDC_NCM_MAX_DATAGRAM_SIZE</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_mtu</span> <span class="o">=</span>	<span class="n">CDC_NCM_MAX_DATAGRAM_SIZE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">USB_CDC_NCM_TYPE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">func_desc</span><span class="p">)))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">func_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">usb_cdc_ncm_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
<span class="nl">advance:</span>
		<span class="cm">/* advance to next descriptor */</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">temp</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">temp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if we got everything */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ether_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">!=</span> <span class="n">intf</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* claim interfaces, if any */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">usb_driver_claim_interface</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">iface_no</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="cm">/* reset data interface */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">iface_no</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>

	<span class="cm">/* initialize data interface */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cdc_ncm_setup</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>

	<span class="cm">/* configure data interface */</span>
	<span class="n">temp</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">iface_no</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>

	<span class="n">cdc_ncm_find_endpoints</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">cdc_ncm_find_endpoints</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">status_ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cdc_ncm_ethtool_ops</span><span class="p">;</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">usbnet_get_ethernet_addr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ether_desc</span><span class="o">-&gt;</span><span class="n">iMACAddress</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error2</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MAC-Address: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">in</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">out</span> <span class="o">=</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="n">USB_ENDPOINT_NUMBER_MASK</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">status_ep</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_urb_size</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We should get an event when network connection is &quot;connected&quot; or</span>
<span class="cm">	 * &quot;disconnected&quot;. Set network connection in &quot;disconnected&quot; state</span>
<span class="cm">	 * (carrier is OFF) during attach, so the IP network stack does not</span>
<span class="cm">	 * start IPv6 negotiation and more.</span>
<span class="cm">	 */</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_speed</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error2:</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">usb_driver_release_interface</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">cdc_ncm_free</span><span class="p">((</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bind() failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdc_ncm_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">usb_driver</span> <span class="o">*</span><span class="n">driver</span> <span class="o">=</span> <span class="n">driver_of</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* no setup */</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hrtimer_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">))</span>
		<span class="n">hrtimer_cancel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">);</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bh</span><span class="p">);</span>

	<span class="cm">/* disconnect master --&gt; disconnect slave */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">usb_driver_release_interface</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">usb_driver_release_interface</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">cdc_ncm_free</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdc_ncm_zero_fill</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">first</span><span class="p">,</span> <span class="n">u32</span> <span class="n">end</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">end</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">first</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">first</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">cdc_ncm_fill_tx_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_out</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rem</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ready2send</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* if there is a remaining skb, it gets priority */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">swap</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ready2send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * +----------------+</span>
<span class="cm">	 * | skb_out        |</span>
<span class="cm">	 * +----------------+</span>
<span class="cm">	 *           ^ offset</span>
<span class="cm">	 *        ^ last_offset</span>
<span class="cm">	 */</span>

	<span class="cm">/* check if we are resuming an OUT skb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pop variables */</span>
		<span class="n">skb_out</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_offset</span><span class="p">;</span>
		<span class="n">last_offset</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_last_offset</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_frame_num</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* reset variables */</span>
		<span class="n">skb_out</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_out</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">exit_no_skb</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* make room for NTH and NDP */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_nth16</span><span class="p">),</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ndp_modulus</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp16</span><span class="p">)</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max_datagrams</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_dpe16</span><span class="p">);</span>

		<span class="cm">/* store last valid offset before alignment */</span>
		<span class="n">last_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="cm">/* align first Datagram offset correctly */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_modulus</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_remainder</span><span class="p">;</span>
		<span class="cm">/* zero buffer till the first IP datagram */</span>
		<span class="n">cdc_ncm_zero_fill</span><span class="p">(</span><span class="n">skb_out</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_frame_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max_datagrams</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check if end of transmit buffer is reached */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ready2send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* compute maximum buffer size */</span>
		<span class="n">rem</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span><span class="p">;</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* check for end of skb */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">rem</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* won&#39;t fit, MTU problem? */</span>
				<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* no room for skb - store for later */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span><span class="p">);</span>
					<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_rem_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">ready2send</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">memcpy</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_out</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">dpe16</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">wDatagramLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">dpe16</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">wDatagramIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>

		<span class="cm">/* update offset */</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

		<span class="cm">/* store last valid offset before alignment */</span>
		<span class="n">last_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

		<span class="cm">/* align offset correctly */</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_modulus</span><span class="p">)</span> <span class="o">+</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_remainder</span><span class="p">;</span>

		<span class="cm">/* zero padding */</span>
		<span class="n">cdc_ncm_zero_fill</span><span class="p">(</span><span class="n">skb_out</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">last_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
								<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* free up any dangling skb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_frame_num</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wait for more frames */</span>
		<span class="cm">/* push variables */</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span> <span class="o">=</span> <span class="n">skb_out</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_last_offset</span> <span class="o">=</span> <span class="n">last_offset</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_no_skb</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max_datagrams</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ready2send</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* wait for more frames */</span>
		<span class="cm">/* push variables */</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span> <span class="o">=</span> <span class="n">skb_out</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_last_offset</span> <span class="o">=</span> <span class="n">last_offset</span><span class="p">;</span>
		<span class="cm">/* set the pending count */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">CDC_NCM_RESTART_TIMER_DATAGRAM_CNT</span><span class="p">)</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer_pending</span> <span class="o">=</span> <span class="n">CDC_NCM_TIMER_PENDING_CNT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_no_skb</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* frame goes out */</span>
		<span class="cm">/* variables will be reset at next call */</span>
	<span class="p">}</span>

	<span class="cm">/* check for overflow */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">last_offset</span> <span class="o">&gt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">)</span>
		<span class="n">last_offset</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">;</span>

	<span class="cm">/* revert offset */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">last_offset</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If collected data size is less or equal CDC_NCM_MIN_TX_PKT bytes,</span>
<span class="cm">	 * we send buffers as it is. If we get more data, it would be more</span>
<span class="cm">	 * efficient for USB HS mobile device with DMA engine to receive a full</span>
<span class="cm">	 * size NTB, than canceling DMA transfer and receiving a short packet.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">CDC_NCM_MIN_TX_PKT</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">;</span>

	<span class="cm">/* final zero padding */</span>
	<span class="n">cdc_ncm_zero_fill</span><span class="p">(</span><span class="n">skb_out</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">last_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">);</span>

	<span class="cm">/* store last offset */</span>
	<span class="n">last_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">last_offset</span> <span class="o">&lt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">last_offset</span> <span class="o">%</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(((</span><span class="n">last_offset</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">%</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_max</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ncm_parm</span><span class="p">.</span><span class="n">dwNtbOutMaxSize</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/* force short packet */</span>
		<span class="o">*</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_out</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">last_offset</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">last_offset</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* zero the rest of the DPEs plus the last NULL entry */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="n">CDC_NCM_DPT_DATAGRAMS_MAX</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">dpe16</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">wDatagramLength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">dpe16</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">wDatagramIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill out 16-bit NTB header */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">nth16</span><span class="p">.</span><span class="n">dwSignature</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">USB_CDC_NCM_NTH16_SIGN</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">nth16</span><span class="p">.</span><span class="n">wHeaderLength</span> <span class="o">=</span>
					<span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">nth16</span><span class="p">));</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">nth16</span><span class="p">.</span><span class="n">wSequence</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">nth16</span><span class="p">.</span><span class="n">wBlockLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">last_offset</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_nth16</span><span class="p">),</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ndp_modulus</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">nth16</span><span class="p">.</span><span class="n">wNdpIndex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_out</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">nth16</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">nth16</span><span class="p">));</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* fill out 16-bit NDP table */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">ndp16</span><span class="p">.</span><span class="n">dwSignature</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">USB_CDC_NCM_NDP16_NOCRC_SIGN</span><span class="p">);</span>
	<span class="n">rem</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">ndp16</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_frame_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_dpe16</span><span class="p">));</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">ndp16</span><span class="p">.</span><span class="n">wLength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rem</span><span class="p">);</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">ndp16</span><span class="p">.</span><span class="n">wNextNdpIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* reserved */</span>

	<span class="n">memcpy</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_out</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">ndp16</span><span class="p">),</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">ndp16</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_out</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">index</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">ndp16</span><span class="p">),</span>
					<span class="o">&amp;</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_ncm</span><span class="p">.</span><span class="n">dpe16</span><span class="p">),</span>
					<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_frame_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_dpe16</span><span class="p">));</span>

	<span class="cm">/* set frame length */</span>
	<span class="n">skb_put</span><span class="p">(</span><span class="n">skb_out</span><span class="p">,</span> <span class="n">last_offset</span><span class="p">);</span>

	<span class="cm">/* return skb */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">+=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_frame_num</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb_out</span><span class="p">;</span>

<span class="nl">exit_no_skb:</span>
	<span class="cm">/* Start timer, if there is a remaining skb */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_curr_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">cdc_ncm_tx_timeout_start</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdc_ncm_tx_timeout_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* start timer, if not already started */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hrtimer_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">)</span> <span class="o">||</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)))</span>
		<span class="n">hrtimer_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer</span><span class="p">,</span>
				<span class="n">ktime_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">CDC_NCM_TIMER_INTERVAL</span><span class="p">),</span>
				<span class="n">HRTIMER_MODE_REL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">hrtimer_restart</span> <span class="nf">cdc_ncm_tx_timer_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">hrtimer</span> <span class="o">*</span><span class="n">timer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">timer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cdc_ncm_ctx</span><span class="p">,</span> <span class="n">tx_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">))</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">bh</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">HRTIMER_NORESTART</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdc_ncm_txpath_bh</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer_pending</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_timer_pending</span><span class="o">--</span><span class="p">;</span>
		<span class="n">cdc_ncm_tx_timeout_start</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="n">netif_tx_lock_bh</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">usbnet_start_xmit</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
		<span class="n">netif_tx_unlock_bh</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">cdc_ncm_tx_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/*</span>
<span class="cm">	 * The Ethernet API we are using does not support transmitting</span>
<span class="cm">	 * multiple Ethernet frames in a single call. This driver will</span>
<span class="cm">	 * accumulate multiple Ethernet frames and send out a larger</span>
<span class="cm">	 * USB frame when the USB buffer is full or when a single jiffies</span>
<span class="cm">	 * timeout happens.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">skb_out</span> <span class="o">=</span> <span class="n">cdc_ncm_fill_tx_frame</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">skb_out</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdc_ncm_rx_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nframes</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_ncm_nth16</span> <span class="o">*</span><span class="n">nth16</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp16</span> <span class="o">*</span><span class="n">ndp16</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_ncm_dpe16</span> <span class="o">*</span><span class="n">dpe16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_nth16</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp16</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;frame too short</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nth16</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_nth16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">dwSignature</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USB_CDC_NCM_NTH16_SIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid NTH16 signature &lt;%u&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">dwSignature</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">wBlockLength</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;unsupported NTB block length %u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
								<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_seq</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">wSequence</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_seq</span> <span class="o">||</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">wSequence</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">((</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_seq</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">wSequence</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;sequence number glitch prev=%d curr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_seq</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">wSequence</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_seq</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">wSequence</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">wNdpIndex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp16</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid DPT16 index &lt;%u&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">nth16</span><span class="o">-&gt;</span><span class="n">wNdpIndex</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ndp16</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp16</span> <span class="o">*</span><span class="p">)(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ndp16</span><span class="o">-&gt;</span><span class="n">dwSignature</span><span class="p">)</span> <span class="o">!=</span> <span class="n">USB_CDC_NCM_NDP16_NOCRC_SIGN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid DPT16 signature &lt;%u&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ndp16</span><span class="o">-&gt;</span><span class="n">dwSignature</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ndp16</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">USB_CDC_NCM_NDP16_LENGTH_MIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid DPT16 length &lt;%u&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ndp16</span><span class="o">-&gt;</span><span class="n">dwSignature</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nframes</span> <span class="o">=</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ndp16</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">)</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp16</span><span class="p">))</span> <span class="o">/</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_dpe16</span><span class="p">));</span>
	<span class="n">nframes</span><span class="o">--</span><span class="p">;</span> <span class="cm">/* we process NDP entries except for the last one */</span>

	<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_ndp16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">+</span> <span class="n">nframes</span> <span class="o">*</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_dpe16</span><span class="p">)))</span> <span class="o">&gt;</span>
								<span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Invalid nframes = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nframes</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dpe16</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_ncm_dpe16</span> <span class="o">*</span><span class="p">)(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">nframes</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">,</span> <span class="n">dpe16</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dpe16</span><span class="o">-&gt;</span><span class="n">wDatagramIndex</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dpe16</span><span class="o">-&gt;</span><span class="n">wDatagramLength</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * CDC NCM ch. 3.7</span>
<span class="cm">		 * All entries after first NULL entry are to be ignored</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span> <span class="cm">/* empty NTB */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* sanity checking */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_max</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ETH_HLEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;invalid frame detected (ignored)&quot;</span>
					<span class="s">&quot;offset[%u]=%u, length=%u, skb=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">x</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">skb_in</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">x</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb_in</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_in</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">skb_set_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">usbnet_skb_return</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cdc_ncm_speed_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">usb_cdc_speed_change</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">rx_speed</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">DLBitRRate</span><span class="p">);</span>
	<span class="kt">uint32_t</span> <span class="n">tx_speed</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">ULBitRate</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Currently the USB-NET API does not support reporting the actual</span>
<span class="cm">	 * device speed. Do print it instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tx_speed</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_speed</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rx_speed</span> <span class="o">!=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_speed</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_speed</span> <span class="o">=</span> <span class="n">tx_speed</span><span class="p">;</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_speed</span> <span class="o">=</span> <span class="n">rx_speed</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">tx_speed</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rx_speed</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">KBUILD_MODNAME</span>
				<span class="s">&quot;: %s: %u mbit/s downlink &quot;</span>
				<span class="s">&quot;%u mbit/s uplink</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">rx_speed</span> <span class="o">/</span> <span class="mi">1000000U</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">tx_speed</span> <span class="o">/</span> <span class="mi">1000000U</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">KBUILD_MODNAME</span>
				<span class="s">&quot;: %s: %u kbit/s downlink &quot;</span>
				<span class="s">&quot;%u kbit/s uplink</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">rx_speed</span> <span class="o">/</span> <span class="mi">1000U</span><span class="p">),</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">tx_speed</span> <span class="o">/</span> <span class="mi">1000U</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdc_ncm_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_cdc_notification</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* test for split data in 8-byte chunks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">EVENT_STS_SPLIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cdc_ncm_speed_change</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
		      <span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_speed_change</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">event</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">bNotificationType</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">USB_CDC_NOTIFY_NETWORK_CONNECTION</span>:
		<span class="cm">/*</span>
<span class="cm">		 * According to the CDC NCM specification ch.7.1</span>
<span class="cm">		 * USB_CDC_NOTIFY_NETWORK_CONNECTION notification shall be</span>
<span class="cm">		 * sent by device after USB_CDC_NOTIFY_SPEED_CHANGE.</span>
<span class="cm">		 */</span>
		<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">KBUILD_MODNAME</span> <span class="s">&quot;: %s: network connection:&quot;</span>
			<span class="s">&quot; %sconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">netdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">tx_speed</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rx_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">USB_CDC_NOTIFY_SPEED_CHANGE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">event</span><span class="p">)</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_speed_change</span><span class="p">)))</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">EVENT_STS_SPLIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cdc_ncm_speed_change</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">usb_cdc_speed_change</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;NCM: unexpected &quot;</span>
			<span class="s">&quot;notification 0x%02x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">bNotificationType</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdc_ncm_check_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">cdc_ncm_ctx</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* disconnected */</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cdc_ncm_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">prod</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usbnet_probe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">prod</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cdc_ncm_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* already disconnected */</span>

	<span class="n">usbnet_disconnect</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cdc_ncm_manage_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">needs_remote_wakeup</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">driver_info</span> <span class="n">cdc_ncm_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="s">&quot;CDC NCM&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FLAG_POINTTOPOINT</span> <span class="o">|</span> <span class="n">FLAG_NO_SETINT</span> <span class="o">|</span> <span class="n">FLAG_MULTI_PACKET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">cdc_ncm_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span> <span class="o">=</span> <span class="n">cdc_ncm_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">check_connect</span> <span class="o">=</span> <span class="n">cdc_ncm_check_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">manage_power</span> <span class="o">=</span> <span class="n">cdc_ncm_manage_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">cdc_ncm_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_fixup</span> <span class="o">=</span> <span class="n">cdc_ncm_rx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_fixup</span> <span class="o">=</span> <span class="n">cdc_ncm_tx_fixup</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">cdc_ncm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cdc_ncm&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">cdc_devs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">cdc_ncm_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">cdc_ncm_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">usbnet_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">usbnet_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_resume</span> <span class="o">=</span>	<span class="n">usbnet_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">cdc_ncm_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">cdc_ncm_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span> <span class="o">=</span> <span class="n">usbnet_get_link</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_msglevel</span> <span class="o">=</span> <span class="n">usbnet_get_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_msglevel</span> <span class="o">=</span> <span class="n">usbnet_set_msglevel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_settings</span> <span class="o">=</span> <span class="n">usbnet_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span> <span class="o">=</span> <span class="n">usbnet_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span> <span class="o">=</span> <span class="n">usbnet_nway_reset</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">cdc_ncm_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Hans Petter Selasky&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;USB CDC NCM host driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
