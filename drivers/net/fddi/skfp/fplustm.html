<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › fddi › skfp › fplustm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>fplustm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *	(C)Copyright 1998,1999 SysKonnect,</span>
<span class="cm"> *	a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.</span>
<span class="cm"> *</span>
<span class="cm"> *	See the file &quot;skfddi.c&quot; for further information.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	The information in this file is provided &quot;AS IS&quot; without warranty.</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * FORMAC+ Driver for tag mode</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;h/types.h&quot;</span>
<span class="cp">#include &quot;h/fddi.h&quot;</span>
<span class="cp">#include &quot;h/smc.h&quot;</span>
<span class="cp">#include &quot;h/supern_2.h&quot;</span>
<span class="cp">#include &lt;linux/bitrev.h&gt;</span>

<span class="cp">#ifndef	lint</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ID_sccs</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;@(#)fplustm.c	1.32 99/02/23 (C) SK &quot;</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifndef UNUSED</span>
<span class="cp">#ifdef  lint</span>
<span class="cp">#define UNUSED(x)	(x) = (x)</span>
<span class="cp">#else</span>
<span class="cp">#define UNUSED(x)</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#define FM_ADDRX	 (FM_ADDET|FM_EXGPA0|FM_EXGPA1)</span>
<span class="cp">#define MS2BCLK(x)	((x)*12500L)</span>
<span class="cp">#define US2BCLK(x)	((x)*1250L)</span>

<span class="cm">/*</span>
<span class="cm"> * prototypes for static function</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">build_claim_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">t_request</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">init_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">all</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rtm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_split_up_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>

<span class="cp">#if (!defined(NO_SMT_PANIC) || defined(DEBUG))</span>
<span class="k">static</span>	<span class="kt">char</span> <span class="n">write_mdr_warning</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;E350 write_mdr() FM_SNPPND is set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span>	<span class="kt">char</span> <span class="n">cam_warning</span> <span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;E_SMT_004: CAM still busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define	DUMMY_READ()	smc-&gt;hw.mc_dummy = (u_short) inp(ADDR(B0_RAP))</span>

<span class="cp">#define	CHECK_NPP() {	unsigned k = 10000 ;\</span>
<span class="cp">			while ((inpw(FM_A(FM_STMCHN)) &amp; FM_SNPPND) &amp;&amp; k) k--;\</span>
<span class="cp">			if (!k) { \</span>
<span class="cp">				SMT_PANIC(smc,SMT_E0130, SMT_E0130_MSG) ; \</span>
<span class="cp">			}	\</span>
<span class="cp">		}</span>

<span class="cp">#define	CHECK_CAM() {	unsigned k = 10 ;\</span>
<span class="cp">			while (!(inpw(FM_A(FM_AFSTAT)) &amp; FM_DONE) &amp;&amp; k) k--;\</span>
<span class="cp">			if (!k) { \</span>
<span class="cp">				SMT_PANIC(smc,SMT_E0131, SMT_E0131_MSG) ; \</span>
<span class="cp">			}	\</span>
<span class="cp">		}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="n">fddi_broadcast</span> <span class="o">=</span> <span class="p">{{</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">,</span><span class="mh">0xff</span><span class="p">}};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="n">null_addr</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="n">dbeacon_multi</span> <span class="o">=</span> <span class="p">{{</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0xc2</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">}};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u_short</span> <span class="n">my_said</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="p">;</span>	<span class="cm">/* short address (n.u.) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u_short</span> <span class="n">my_sagp</span> <span class="o">=</span> <span class="mh">0xffff</span> <span class="p">;</span>	<span class="cm">/* short group address (n.u.) */</span>

<span class="cm">/*</span>
<span class="cm"> * define my address</span>
<span class="cm"> */</span>
<span class="cp">#ifdef	USE_CAN_ADDR</span>
<span class="cp">#define MA	smc-&gt;hw.fddi_canon_addr</span>
<span class="cp">#else</span>
<span class="cp">#define MA	smc-&gt;hw.fddi_home_addr</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * useful interrupt bits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mac_imsk1u</span> <span class="o">=</span> <span class="n">FM_STXABRS</span> <span class="o">|</span> <span class="n">FM_STXABRA0</span> <span class="o">|</span> <span class="n">FM_SXMTABT</span> <span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mac_imsk1l</span> <span class="o">=</span> <span class="n">FM_SQLCKS</span> <span class="o">|</span> <span class="n">FM_SQLCKA0</span> <span class="o">|</span> <span class="n">FM_SPCEPDS</span> <span class="o">|</span> <span class="n">FM_SPCEPDA0</span><span class="o">|</span>
			<span class="n">FM_STBURS</span> <span class="o">|</span> <span class="n">FM_STBURA0</span> <span class="p">;</span>

	<span class="cm">/* delete FM_SRBFL after tests */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mac_imsk2u</span> <span class="o">=</span> <span class="n">FM_SERRSF</span> <span class="o">|</span> <span class="n">FM_SNFSLD</span> <span class="o">|</span> <span class="n">FM_SRCVOVR</span> <span class="o">|</span> <span class="n">FM_SRBFL</span> <span class="o">|</span>
			<span class="n">FM_SMYCLM</span> <span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mac_imsk2l</span> <span class="o">=</span> <span class="n">FM_STRTEXR</span> <span class="o">|</span> <span class="n">FM_SDUPCLM</span> <span class="o">|</span> <span class="n">FM_SFRMCTR</span> <span class="o">|</span>
			<span class="n">FM_SERRCTR</span> <span class="o">|</span> <span class="n">FM_SLSTCTR</span> <span class="o">|</span>
			<span class="n">FM_STRTEXP</span> <span class="o">|</span> <span class="n">FM_SMULTDA</span> <span class="o">|</span> <span class="n">FM_SRNGOP</span> <span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mac_imsk3u</span> <span class="o">=</span> <span class="n">FM_SRCVOVR2</span> <span class="o">|</span> <span class="n">FM_SRBFL2</span> <span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mac_imsk3l</span> <span class="o">=</span> <span class="n">FM_SRPERRQ2</span> <span class="o">|</span> <span class="n">FM_SRPERRQ1</span> <span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">mac_beacon_imsk2u</span> <span class="o">=</span> <span class="n">FM_SOTRBEC</span> <span class="o">|</span> <span class="n">FM_SMYBEC</span> <span class="o">|</span> <span class="n">FM_SBEC</span> <span class="o">|</span>
			<span class="n">FM_SLOCLM</span> <span class="o">|</span> <span class="n">FM_SHICLM</span> <span class="o">|</span> <span class="n">FM_SMYCLM</span> <span class="o">|</span> <span class="n">FM_SCLM</span> <span class="p">;</span>


<span class="k">static</span> <span class="n">u_long</span> <span class="nf">mac_get_tneg</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">tneg</span> <span class="p">;</span>

	<span class="n">tneg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_TNEG</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)((</span><span class="n">tneg</span> <span class="o">+</span> <span class="p">((</span><span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_TMRS</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">10</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x1f</span><span class="p">))</span> <span class="o">|</span>
		<span class="mh">0xffe00000L</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">mac_update_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACFrame_Ct</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACFrame_Ct</span> <span class="o">&amp;</span> <span class="mh">0xffff0000L</span><span class="p">)</span>
		<span class="o">+</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_FCNTR</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACLost_Ct</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACLost_Ct</span> <span class="o">&amp;</span> <span class="mh">0xffff0000L</span><span class="p">)</span>
		<span class="o">+</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_LCNTR</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACError_Ct</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACError_Ct</span> <span class="o">&amp;</span> <span class="mh">0xffff0000L</span><span class="p">)</span>
		<span class="o">+</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_ECNTR</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Neg</span> <span class="o">=</span> <span class="n">mac_get_tneg</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifdef SMT_REAL_TOKEN_CT</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the token counter is emulated it is updated in smt_event.</span>
<span class="cm">	 */</span>
	<span class="n">TBD</span>
<span class="cp">#else</span>
	<span class="n">smt_emulate_token_ct</span><span class="p">(</span> <span class="n">smc</span><span class="p">,</span> <span class="n">MAC0</span> <span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * write long value into buffer memory over memory data register (MDR),</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_mdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">CHECK_NPP</span><span class="p">()</span> <span class="p">;</span>
	<span class="n">MDRW</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c"> * read long value from buffer memory over memory data register (MDR),</span>
<span class="c"> */</span>
<span class="c">static u_long read_mdr(struct s_smc *smc, unsigned int addr)</span>
<span class="c">{</span>
<span class="c">	long p ;</span>
<span class="c">	CHECK_NPP() ;</span>
<span class="c">	MARR(addr) ;</span>
<span class="c">	outpw(FM_A(FM_CMDREG1),FM_IRMEMWO) ;</span>
<span class="c">	CHECK_NPP() ;	/* needed for PCI to prevent from timeing violations */</span>
<span class="c">/*	p = MDRR() ; */	/* bad read values if the workaround */</span>
<span class="c">			/* smc-&gt;hw.mc_dummy = *((short volatile far *)(addr)))*/</span>
<span class="c">			/* is used */</span>
<span class="c">	p = (u_long)inpw(FM_A(FM_MDRU))&lt;&lt;16 ;</span>
<span class="c">	p += (u_long)inpw(FM_A(FM_MDRL)) ;</span>
<span class="c">	return p;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * clear buffer memory</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_ram</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span> <span class="n">i</span> <span class="p">;</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_end</span> <span class="o">=</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">+</span> <span class="n">RBC_MEM_SIZE</span> <span class="p">;</span>
	<span class="n">CHECK_NPP</span><span class="p">()</span> <span class="p">;</span>
	<span class="n">MARW</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_end</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">write_mdr</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0L</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/* Erase the last byte too */</span>
	<span class="n">write_mdr</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0L</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set receive FIFO pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_recvptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * initialize the pointer for receive queue 1</span>
<span class="cm">	 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_RPR1</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_start</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* RPR1 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SWPR1</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_start</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* SWPR1 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_WPR1</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_start</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* WPR1 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_EARV1</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* EARV1 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the pointer for receive queue 2</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_RPR2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_start</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SWPR2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_start</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_WPR2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_start</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_EARV2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_RPR2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SWPR2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_WPR2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_EARV2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_end</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set transmit FIFO pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_txptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG2</span><span class="p">),</span><span class="n">FM_IRSTQ</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* reset transmit queues */</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the pointer for asynchronous transmit queue</span>
<span class="cm">	 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_RPXA0</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* RPXA0 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SWPXA0</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* SWPXA0 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_WPXA0</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* WPXA0 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_EAA0</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* EAA0 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the pointer for synchronous transmit queue</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_RPXS</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_start</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SWPXS</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_start</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_WPXS</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_start</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_EAS</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_RPXS</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SWPXS</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_WPXS</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_EAS</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * init memory buffer management registers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_rbc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span>	<span class="n">rbc_ram_addr</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set unused pointers or permanent pointers</span>
<span class="cm">	 */</span>
	<span class="n">rbc_ram_addr</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_start</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_RPXA1</span><span class="p">),</span><span class="n">rbc_ram_addr</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* a1-send pointer */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_WPXA1</span><span class="p">),</span><span class="n">rbc_ram_addr</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SWPXA1</span><span class="p">),</span><span class="n">rbc_ram_addr</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_EAA1</span><span class="p">),</span><span class="n">rbc_ram_addr</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">set_recvptr</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">set_txptr</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * init rx pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_rx_queue</span>	<span class="o">*</span><span class="n">queue</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * init all tx data structures for receive queue 1</span>
<span class="cm">	 */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_q</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_bmu_ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_R1_CSR</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_bmu_dsc</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R1_DA</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * init all tx data structures for receive queue 2</span>
<span class="cm">	 */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">QUEUE_R2</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_q</span><span class="p">[</span><span class="n">QUEUE_R2</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_bmu_ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_R2_CSR</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_bmu_dsc</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R2_DA</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set the TSYNC register of the FORMAC to regulate synchronous transmission</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">set_formac_tsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">long</span> <span class="n">sync_bw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_TSYNC</span><span class="p">),(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(((</span><span class="o">-</span><span class="n">sync_bw</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * init all tx data structures</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_tx_queue</span>	<span class="o">*</span><span class="n">queue</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * init all tx data structures for the synchronous queue</span>
<span class="cm">	 */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">QUEUE_S</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx_q</span><span class="p">[</span><span class="n">QUEUE_S</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_bmu_ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XS_CSR</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_bmu_dsc</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XS_DA</span><span class="p">)</span> <span class="p">;</span>

<span class="cp">#ifdef ESS</span>
	<span class="n">set_formac_tsync</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sync_bw</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * init all tx data structures for the asynchronous queue 0</span>
<span class="cm">	 */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">QUEUE_A0</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx_q</span><span class="p">[</span><span class="n">QUEUE_A0</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_bmu_ctl</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XA_CSR</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_bmu_dsc</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XA_DA</span><span class="p">)</span> <span class="p">;</span>


	<span class="n">llc_recover_tx</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_counter_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="n">u_long</span> <span class="o">*</span><span class="n">ec</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear FORMAC+ frame-, lost- and error counter</span>
<span class="cm">	 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_FCNTR</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_LCNTR</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_ECNTR</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * clear internal error counter structure</span>
<span class="cm">	 */</span>
	<span class="n">ec</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">err_st</span><span class="p">)</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">))</span> <span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ec</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0L</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACRingOp_Ct</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * set FORMAC address, and t_request</span>
<span class="cm"> */</span>
<span class="k">static</span>	<span class="kt">void</span> <span class="nf">set_formac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span>	<span class="n">t_requ</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Req</span> <span class="p">;</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SAID</span><span class="p">),</span><span class="n">my_said</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set short address */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_LAIL</span><span class="p">),(</span><span class="kt">unsigned</span><span class="p">)((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fddi_home_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fddi_home_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_LAIC</span><span class="p">),(</span><span class="kt">unsigned</span><span class="p">)((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fddi_home_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fddi_home_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_LAIM</span><span class="p">),(</span><span class="kt">unsigned</span><span class="p">)((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fddi_home_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fddi_home_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">;</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SAGP</span><span class="p">),</span><span class="n">my_sagp</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set short group address */</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_LAGL</span><span class="p">),(</span><span class="kt">unsigned</span><span class="p">)((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">group_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">group_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_LAGC</span><span class="p">),(</span><span class="kt">unsigned</span><span class="p">)((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">group_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">group_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_LAGM</span><span class="p">),(</span><span class="kt">unsigned</span><span class="p">)((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">group_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">+</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">group_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">;</span>

	<span class="cm">/* set r_request regs. (MSW &amp; LSW of TRT ) */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_TREQ1</span><span class="p">),(</span><span class="kt">unsigned</span><span class="p">)(</span><span class="n">t_requ</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_TREQ0</span><span class="p">),(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">t_requ</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_int</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">l</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * copy TX descriptor to buffer mem</span>
<span class="cm"> * append FC field and MAC frame</span>
<span class="cm"> * if more bit is set in descr</span>
<span class="cm"> *	append pointer to descriptor (endless loop)</span>
<span class="cm"> * else</span>
<span class="cm"> *	append &#39;end of chain&#39; pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_tx_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">td</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="n">off</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="cm">/* u_long td;		 transmit descriptor */</span>
<span class="cm">/* struct fddi_mac *mac; mac frame pointer */</span>
<span class="cm">/* unsigned off;	 start address within buffer memory */</span>
<span class="cm">/* int len ;		 length of the frame including the FC */</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>
	<span class="n">__le32</span>	<span class="o">*</span><span class="n">p</span> <span class="p">;</span>

	<span class="n">CHECK_NPP</span><span class="p">()</span> <span class="p">;</span>
	<span class="n">MARW</span><span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* set memory address reg for writes */</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">4</span> <span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* last word, set the tag bit */</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG2</span><span class="p">),</span><span class="n">FM_ISTTB</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">write_mdr</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">p</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG2</span><span class="p">),</span><span class="n">FM_ISTTB</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set the tag bit */</span>
	<span class="n">write_mdr</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">td</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* write over memory data reg to buffer */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(module;tests;3)</span>
<span class="cm">	How to test directed beacon frames</span>
<span class="cm">	----------------------------------------------------------------</span>

<span class="cm">	o Insert a break point in the function build_claim_beacon()</span>
<span class="cm">	  before calling copy_tx_mac() for building the claim frame.</span>
<span class="cm">	o Modify the RM3_DETECT case so that the RM6_DETECT state</span>
<span class="cm">	  will always entered from the RM3_DETECT state (function rmt_fsm(),</span>
<span class="cm">	  rmt.c)</span>
<span class="cm">	o Compile the driver.</span>
<span class="cm">	o Set the parameter TREQ in the protocol.ini or net.cfg to a</span>
<span class="cm">	  small value to make sure your station will win the claim</span>
<span class="cm">	  process.</span>
<span class="cm">	o Start the driver.</span>
<span class="cm">	o When you reach the break point, modify the SA and DA address</span>
<span class="cm">	  of the claim frame (e.g. SA = DA = 10005affffff).</span>
<span class="cm">	o When you see RM3_DETECT and RM6_DETECT, observe the direct</span>
<span class="cm">	  beacon frames on the UPPSLANA.</span>

<span class="cm">	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">directed_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_LOC_DECL</span><span class="p">(</span><span class="n">__le32</span><span class="p">,</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set UNA in frame</span>
<span class="cm">	 * enable FORMAC to send endless queue of directed beacon</span>
<span class="cm">	 * important: the UNA starts at byte 1 (not at byte 0)</span>
<span class="cm">	 */</span>
	<span class="o">*</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">DBEACON_INFO</span><span class="o">&lt;&lt;</span><span class="mi">24L</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">CHECK_NPP</span><span class="p">()</span> <span class="p">;</span>
	 <span class="cm">/* set memory address reg for writes */</span>
	<span class="n">MARW</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span><span class="o">+</span><span class="n">DBEACON_FRAME_OFF</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">write_mdr</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG2</span><span class="p">),</span><span class="n">FM_ISTTB</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set the tag bit */</span>
	<span class="n">write_mdr</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">;</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SABC</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">+</span> <span class="n">DBEACON_FRAME_OFF</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	setup claim &amp; beacon pointer</span>
<span class="cm">	NOTE :</span>
<span class="cm">		special frame packets end with a pointer to their own</span>
<span class="cm">		descriptor, and the MORE bit is set in the descriptor</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_claim_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">t_request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_int</span>	<span class="n">td</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">len</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mac_sf</span> <span class="o">*</span><span class="n">mac</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * build claim packet</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">17</span> <span class="p">;</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">TX_DESCRIPTOR</span> <span class="o">|</span> <span class="p">((((</span><span class="n">u_int</span><span class="p">)</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">mac</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mac_sfb</span> <span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_fc</span> <span class="o">=</span> <span class="n">FC_CLAIM</span> <span class="p">;</span>
	<span class="cm">/* DA == SA in claim frame */</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_source</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_dest</span> <span class="o">=</span> <span class="n">MA</span> <span class="p">;</span>
	<span class="cm">/* 2&#39;s complement */</span>
	<span class="n">set_int</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_info</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">t_request</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">copy_tx_mac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">td</span><span class="p">,(</span><span class="k">struct</span> <span class="n">fddi_mac</span> <span class="o">*</span><span class="p">)</span><span class="n">mac</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">+</span> <span class="n">CLAIM_FRAME_OFF</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/* set CLAIM start pointer */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SACL</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">+</span> <span class="n">CLAIM_FRAME_OFF</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * build beacon packet</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">17</span> <span class="p">;</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">TX_DESCRIPTOR</span> <span class="o">|</span> <span class="p">((((</span><span class="n">u_int</span><span class="p">)</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_fc</span> <span class="o">=</span> <span class="n">FC_BEACON</span> <span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_source</span> <span class="o">=</span> <span class="n">MA</span> <span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_dest</span> <span class="o">=</span> <span class="n">null_addr</span> <span class="p">;</span>		<span class="cm">/* DA == 0 in beacon frame */</span>
	<span class="n">set_int</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_info</span><span class="p">,((</span><span class="kt">int</span><span class="p">)</span><span class="n">BEACON_INFO</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">;</span>

	<span class="n">copy_tx_mac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">td</span><span class="p">,(</span><span class="k">struct</span> <span class="n">fddi_mac</span> <span class="o">*</span><span class="p">)</span><span class="n">mac</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">+</span> <span class="n">BEACON_FRAME_OFF</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/* set beacon start pointer */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_SABC</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">+</span> <span class="n">BEACON_FRAME_OFF</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * build directed beacon packet</span>
<span class="cm">	 * contains optional UNA</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">23</span> <span class="p">;</span>
	<span class="n">td</span> <span class="o">=</span> <span class="n">TX_DESCRIPTOR</span> <span class="o">|</span> <span class="p">((((</span><span class="n">u_int</span><span class="p">)</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_fc</span> <span class="o">=</span> <span class="n">FC_BEACON</span> <span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_source</span> <span class="o">=</span> <span class="n">MA</span> <span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_dest</span> <span class="o">=</span> <span class="n">dbeacon_multi</span> <span class="p">;</span>		<span class="cm">/* multicast */</span>
	<span class="n">set_int</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_info</span><span class="p">,((</span><span class="kt">int</span><span class="p">)</span><span class="n">DBEACON_INFO</span><span class="o">&lt;&lt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">;</span>
	<span class="n">set_int</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_info</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">set_int</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">mac_info</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">copy_tx_mac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">td</span><span class="p">,(</span><span class="k">struct</span> <span class="n">fddi_mac</span> <span class="o">*</span><span class="p">)</span><span class="n">mac</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">+</span> <span class="n">DBEACON_FRAME_OFF</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* end of claim/beacon queue */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_EACB</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_start</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_WPXSF</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_RPXSF</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">formac_rcv_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable receive function */</span>
	<span class="n">SETMASK</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span><span class="p">,</span><span class="n">FM_ADDRX</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG1</span><span class="p">),</span><span class="n">FM_ICLLR</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* clear receive lock */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">formac_tx_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG1</span><span class="p">),</span><span class="n">FM_ICLLS</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* clear s-frame lock */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG1</span><span class="p">),</span><span class="n">FM_ICLLA0</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* clear a-frame lock */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_formac</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set formac IMSK : 0 enables irq */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK1U</span><span class="p">),(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">~</span><span class="n">mac_imsk1u</span><span class="p">);</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK1L</span><span class="p">),(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">~</span><span class="n">mac_imsk1l</span><span class="p">);</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK2U</span><span class="p">),(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">~</span><span class="n">mac_imsk2u</span><span class="p">);</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK2L</span><span class="p">),(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">~</span><span class="n">mac_imsk2l</span><span class="p">);</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK3U</span><span class="p">),(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">~</span><span class="n">mac_imsk3u</span><span class="p">);</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK3L</span><span class="p">),(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span><span class="o">~</span><span class="n">mac_imsk3l</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c">	/* Removed because the driver should use the ASICs TX complete IRQ. */</span>
<span class="c">	/* The FORMACs tx complete IRQ should be used any longer */</span>

<span class="c">/*</span>
<span class="c">	BEGIN_MANUAL_ENTRY(if,func;others;4)</span>

<span class="c">	void enable_tx_irq(smc, queue)</span>
<span class="c">	struct s_smc *smc ;</span>
<span class="c">	u_short	queue ;</span>

<span class="c">Function	DOWNCALL	(SMT, fplustm.c)</span>
<span class="c">		enable_tx_irq() enables the FORMACs transmit complete</span>
<span class="c">		interrupt of the queue.</span>

<span class="c">Para	queue	= QUEUE_S:	synchronous queue</span>
<span class="c">		= QUEUE_A0:	asynchronous queue</span>

<span class="c">Note	After any ring operational change the transmit complete</span>
<span class="c">	interrupts are disabled.</span>
<span class="c">	The operating system dependent module must enable</span>
<span class="c">	the transmit complete interrupt of a queue,</span>
<span class="c">		- when it queues the first frame,</span>
<span class="c">		  because of no transmit resources are beeing</span>
<span class="c">		  available and</span>
<span class="c">		- when it escapes from the function llc_restart_tx</span>
<span class="c">		  while some frames are still queued.</span>

<span class="c">	END_MANUAL_ENTRY</span>
<span class="c"> */</span>
<span class="c">void enable_tx_irq(struct s_smc *smc, u_short queue)</span>
<span class="c">/* u_short queue; 0 = synchronous queue, 1 = asynchronous queue 0 */</span>
<span class="c">{</span>
<span class="c">	u_short	imask ;</span>

<span class="c">	imask = ~(inpw(FM_A(FM_IMSK1U))) ;</span>

<span class="c">	if (queue == 0) {</span>
<span class="c">		outpw(FM_A(FM_IMSK1U),~(imask|FM_STEFRMS)) ;</span>
<span class="c">	}</span>
<span class="c">	if (queue == 1) {</span>
<span class="c">		outpw(FM_A(FM_IMSK1U),~(imask|FM_STEFRMA0)) ;</span>
<span class="c">	}</span>
<span class="c">}</span>

<span class="c">/*</span>
<span class="c">	BEGIN_MANUAL_ENTRY(if,func;others;4)</span>

<span class="c">	void disable_tx_irq(smc, queue)</span>
<span class="c">	struct s_smc *smc ;</span>
<span class="c">	u_short	queue ;</span>

<span class="c">Function	DOWNCALL	(SMT, fplustm.c)</span>
<span class="c">		disable_tx_irq disables the FORMACs transmit complete</span>
<span class="c">		interrupt of the queue</span>

<span class="c">Para	queue	= QUEUE_S:	synchronous queue</span>
<span class="c">		= QUEUE_A0:	asynchronous queue</span>

<span class="c">Note	The operating system dependent module should disable</span>
<span class="c">	the transmit complete interrupts if it escapes from the</span>
<span class="c">	function llc_restart_tx and no frames are queued.</span>

<span class="c">	END_MANUAL_ENTRY</span>
<span class="c"> */</span>
<span class="c">void disable_tx_irq(struct s_smc *smc, u_short queue)</span>
<span class="c">/* u_short queue; 0 = synchronous queue, 1 = asynchronous queue 0 */</span>
<span class="c">{</span>
<span class="c">	u_short	imask ;</span>

<span class="c">	imask = ~(inpw(FM_A(FM_IMSK1U))) ;</span>

<span class="c">	if (queue == 0) {</span>
<span class="c">		outpw(FM_A(FM_IMSK1U),~(imask&amp;~FM_STEFRMS)) ;</span>
<span class="c">	}</span>
<span class="c">	if (queue == 1) {</span>
<span class="c">		outpw(FM_A(FM_IMSK1U),~(imask&amp;~FM_STEFRMA0)) ;</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_formac</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clear formac IMSK : 1 disables irq */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK1U</span><span class="p">),</span><span class="n">MW</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK1L</span><span class="p">),</span><span class="n">MW</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK2U</span><span class="p">),</span><span class="n">MW</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK2L</span><span class="p">),</span><span class="n">MW</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK3U</span><span class="p">),</span><span class="n">MW</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK3L</span><span class="p">),</span><span class="n">MW</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_ring_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">formac_rcv_restart</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* enable receive function */</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ring_is_up</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="n">llc_restart_tx</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* TX queue */</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* disable receive function */</span>
		<span class="n">SETMASK</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">FM_MDISRCV</span><span class="p">,</span><span class="n">FM_ADDET</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/* abort current transmit activity */</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG2</span><span class="p">),</span><span class="n">FM_IACTR</span><span class="p">)</span> <span class="p">;</span>

		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ring_is_up</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*--------------------------- ISR handling ----------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * mac1_irq is in drvfbi.c</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * mac2_irq:	status bits for the receive queue 1, and ring status</span>
<span class="cm"> * 		ring status indication bits</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac2_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">code_s2u</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">code_s2l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span>	<span class="n">change_s2l</span> <span class="p">;</span>
	<span class="n">u_short</span>	<span class="n">change_s2u</span> <span class="p">;</span>

	<span class="cm">/* (jd) 22-Feb-1999</span>
<span class="cm">	 * Restart 2_DMax Timer after end of claiming or beaconing</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FM_SCLM</span><span class="o">|</span><span class="n">FM_SHICLM</span><span class="o">|</span><span class="n">FM_SBEC</span><span class="o">|</span><span class="n">FM_SOTRBEC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_TX_STATE_CHANGE</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FM_STKISS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_TX_STATE_CHANGE</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * XOR current st bits with the last to avoid useless RMT event queuing</span>
<span class="cm">	 */</span>
	<span class="n">change_s2l</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">s2l</span> <span class="o">^</span> <span class="n">code_s2l</span> <span class="p">;</span>
	<span class="n">change_s2u</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">s2u</span> <span class="o">^</span> <span class="n">code_s2u</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">change_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SRNGOP</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ring_is_up</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SRNGOP</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SRNGOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mac_ring_up</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_RING_OP</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACRingOp_Ct</span><span class="o">++</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mac_ring_up</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_RING_NON_OP</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">mac2_end</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SMISFRM</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* missed frame */</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACNotCopied_Ct</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FM_SRCVOVR</span> <span class="o">|</span>	<span class="cm">/* recv. FIFO overflow */</span>
			<span class="n">FM_SRBFL</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* recv. buffer full */</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ct</span><span class="p">.</span><span class="n">mac_r_restart_counter</span><span class="o">++</span> <span class="p">;</span>
<span class="cm">/*		formac_rcv_restart(smc) ;	*/</span>
		<span class="n">smt_stat_counter</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
<span class="cm">/*		goto mac2_end ;			*/</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="n">FM_SOTRBEC</span><span class="p">)</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_OTHER_BEACON</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="n">FM_SMYBEC</span><span class="p">)</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_MY_BEACON</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change_s2u</span> <span class="o">&amp;</span> <span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="n">FM_SLOCLM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_RMTN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;RMT : lower claim received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="n">FM_SMYCLM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SDUPCLM</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is my claim and that claim is not detected as a</span>
<span class="cm">		 * duplicate one.</span>
<span class="cm">		 */</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_MY_CLAIM</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SDUPCLM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If a duplicate claim frame (same SA but T_Bid != T_Req)</span>
<span class="cm">		 * this flag will be set.</span>
<span class="cm">		 * In the RMT state machine we need a RM_VALID_CLAIM event</span>
<span class="cm">		 * to do the appropriate state change.</span>
<span class="cm">		 * RM(34c)</span>
<span class="cm">		 */</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_VALID_CLAIM</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change_s2u</span> <span class="o">&amp;</span> <span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="n">FM_SHICLM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_RMTN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;RMT : higher claim received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_STRTEXP</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_STRTEXR</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_TRT_EXP</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SMULTDA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The MAC has found a 2. MAC with the same address.</span>
<span class="cm">		 * Signal dup_addr_test = failed to RMT state machine.</span>
<span class="cm">		 * RM(25)</span>
<span class="cm">		 */</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">dup_addr_test</span> <span class="o">=</span> <span class="n">DA_FAILED</span> <span class="p">;</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_DUP_ADDR</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="n">FM_SBEC</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_bec_stat</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="n">FM_SCLM</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_clm_stat</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_STVXEXP</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACTvxExpired_Ct</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FM_SBEC</span><span class="o">|</span><span class="n">FM_SCLM</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">change_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SRNGOP</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">s2l</span> <span class="o">&amp;</span> <span class="n">FM_SRNGOP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mac_ring_up</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_RING_NON_OP</span><span class="p">)</span> <span class="p">;</span>

			<span class="n">mac_ring_up</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_RING_OP</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACRingOp_Ct</span><span class="o">++</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SPHINV</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_phinv</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SSIFG</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_sifg_det</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_STKISS</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_tkiss</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_STKERR</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_tkerr</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SFRMCTR</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACFrame_Ct</span> <span class="o">+=</span> <span class="mh">0x10000L</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SERRCTR</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACError_Ct</span> <span class="o">+=</span> <span class="mh">0x10000L</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2l</span> <span class="o">&amp;</span> <span class="n">FM_SLSTCTR</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACLost_Ct</span>  <span class="o">+=</span> <span class="mh">0x10000L</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s2u</span> <span class="o">&amp;</span> <span class="n">FM_SERRSF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_E0114</span><span class="p">,</span> <span class="n">SMT_E0114_MSG</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="nl">mac2_end:</span>
	<span class="cm">/* notice old status */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">s2l</span> <span class="o">=</span> <span class="n">code_s2l</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">s2u</span> <span class="o">=</span> <span class="n">code_s2u</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK2U</span><span class="p">),</span><span class="o">~</span><span class="n">mac_imsk2u</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mac3_irq:	receive queue 2 bits and address detection bits</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac3_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">code_s3u</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">code_s3l</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UNUSED</span><span class="p">(</span><span class="n">code_s3l</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code_s3u</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FM_SRCVOVR2</span> <span class="o">|</span>	<span class="cm">/* recv. FIFO overflow */</span>
			<span class="n">FM_SRBFL2</span><span class="p">))</span> <span class="p">{</span>	<span class="cm">/* recv. buffer full */</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ct</span><span class="p">.</span><span class="n">mac_r_restart_counter</span><span class="o">++</span> <span class="p">;</span>
		<span class="n">smt_stat_counter</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">code_s3u</span> <span class="o">&amp;</span> <span class="n">FM_SRPERRQ2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* parity error receive queue 2 */</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_E0115</span><span class="p">,</span> <span class="n">SMT_E0115_MSG</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code_s3u</span> <span class="o">&amp;</span> <span class="n">FM_SRPERRQ1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* parity error receive queue 2 */</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_E0116</span><span class="p">,</span> <span class="n">SMT_E0116_MSG</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * take formac offline</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">formac_offline</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG2</span><span class="p">),</span><span class="n">FM_IACTR</span><span class="p">)</span> <span class="p">;</span><span class="cm">/* abort current transmit activity */</span>

	<span class="cm">/* disable receive function */</span>
	<span class="n">SETMASK</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">FM_MDISRCV</span><span class="p">,</span><span class="n">FM_ADDET</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* FORMAC+ &#39;Initialize Mode&#39; */</span>
	<span class="n">SETMASK</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">FM_MINIT</span><span class="p">,</span><span class="n">FM_MMODE</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">disable_formac</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ring_is_up</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_state</span> <span class="o">=</span> <span class="n">STOPPED</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * bring formac online</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">formac_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">enable_formac</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SETMASK</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">FM_MONLINE</span> <span class="o">|</span> <span class="n">FM_SELRA</span> <span class="o">|</span> <span class="n">MDR1INIT</span> <span class="o">|</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span><span class="p">,</span> <span class="n">FM_MMODE</span> <span class="o">|</span> <span class="n">FM_SELRA</span> <span class="o">|</span> <span class="n">FM_ADDRX</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * FORMAC+ full init. (tx, rx, timer, counter, claim &amp; beacon)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">init_fplus</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">nsa_mode</span> <span class="o">=</span> <span class="n">FM_MRNNSAFNMA</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">FM_MDAMA</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">group_addr</span> <span class="o">=</span> <span class="n">fddi_broadcast</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">func_addr</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">frselreg_init</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="n">init_driver_fplus</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_DAS</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mdr3init</span> <span class="o">|=</span> <span class="n">FM_MENDAS</span> <span class="p">;</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ct</span><span class="p">.</span><span class="n">mac_nobuf_counter</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ct</span><span class="p">.</span><span class="n">mac_r_restart_counter</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fm_st1u</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_ST1U</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fm_st1l</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_ST1L</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fm_st2u</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_ST2U</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fm_st2l</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_ST2L</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fm_st3u</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_ST3U</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fm_st3l</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="n">ADDR</span><span class="p">(</span><span class="n">B0_ST3L</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">s2l</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">s2u</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ring_is_up</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="n">mac_counter_init</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* convert BCKL units to symbol time */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_pa</span><span class="p">.</span><span class="n">t_neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_pa</span><span class="p">.</span><span class="n">t_pri</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="mi">0</span> <span class="p">;</span>

	<span class="cm">/* make sure all PCI settings are correct */</span>
	<span class="n">mac_do_pci_fix</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">return</span> <span class="n">init_mac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* enable_formac(smc) ; */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_short</span>	<span class="n">t_max</span><span class="p">,</span><span class="n">x</span> <span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">time</span><span class="o">=</span><span class="mi">0</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * clear memory</span>
<span class="cm">	 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">FM_MINIT</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* FORMAC+ init mode */</span>
	<span class="n">set_formac_addr</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">FM_MMEMACT</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* FORMAC+ memory activ mode */</span>
	<span class="cm">/* Note: Mode register 2 is set here, incase parity is enabled. */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mdr2init</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_ram</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * reset the HPI, the Master and the BMUs</span>
<span class="cm">		 */</span>
		<span class="n">outp</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_CTRL</span><span class="p">),</span> <span class="n">CTRL_HPI_SET</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">hwt_quick_read</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * set all pointers, frames etc</span>
<span class="cm">	 */</span>
	<span class="n">smt_split_up_fifo</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">init_tx</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">init_rx</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">init_rbc</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">build_claim_beacon</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Req</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* set RX threshold */</span>
	<span class="cm">/* see Errata #SN2 Phantom receive overflow */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_FRMTHR</span><span class="p">),</span><span class="mi">14</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* switch on */</span>

	<span class="cm">/* set formac work mode */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">MDR1INIT</span> <span class="o">|</span> <span class="n">FM_SELRA</span> <span class="o">|</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG2</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mdr2init</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG3</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mdr3init</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_FRSELREG</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">frselreg_init</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* set timer */</span>
	<span class="cm">/*</span>
<span class="cm">	 * errata #22 fplus:</span>
<span class="cm">	 * T_MAX must not be FFFE</span>
<span class="cm">	 * or one of FFDF, FFB8, FF91 (-0x27 etc..)</span>
<span class="cm">	 */</span>
	<span class="n">t_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Max</span><span class="o">/</span><span class="mi">32</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">t_max</span><span class="o">/</span><span class="mh">0x27</span> <span class="p">;</span>
	<span class="n">x</span> <span class="o">*=</span> <span class="mh">0x27</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">t_max</span> <span class="o">==</span> <span class="mh">0xfffe</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">t_max</span> <span class="o">-</span> <span class="n">x</span> <span class="o">==</span> <span class="mh">0x16</span><span class="p">))</span>
		<span class="n">t_max</span><span class="o">--</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_TMAX</span><span class="p">),(</span><span class="n">u_short</span><span class="p">)</span><span class="n">t_max</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* BugFix for report #10204 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACTvxValue</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="p">(</span><span class="o">-</span> <span class="n">US2BCLK</span><span class="p">(</span><span class="mi">52</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_TVX</span><span class="p">),</span> <span class="p">(</span><span class="n">u_short</span><span class="p">)</span> <span class="p">(</span><span class="o">-</span> <span class="n">US2BCLK</span><span class="p">(</span><span class="mi">52</span><span class="p">))</span><span class="o">/</span><span class="mi">255</span> <span class="o">&amp;</span> <span class="n">MB</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_TVX</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u_short</span><span class="p">)((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACTvxValue</span><span class="o">/</span><span class="mi">255</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MB</span><span class="p">))</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG1</span><span class="p">),</span><span class="n">FM_ICLLS</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* clear s-frame lock */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG1</span><span class="p">),</span><span class="n">FM_ICLLA0</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* clear a-frame lock */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG1</span><span class="p">),</span><span class="n">FM_ICLLR</span><span class="p">);</span>	<span class="cm">/* clear receive lock */</span>

	<span class="cm">/* Auto unlock receice threshold for receive queue 1 and 2 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_UNLCKDLY</span><span class="p">),(</span><span class="mh">0xff</span><span class="o">|</span><span class="p">(</span><span class="mh">0xff</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)))</span> <span class="p">;</span>

	<span class="n">rtm_init</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>				<span class="cm">/* RT-Monitor */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">all</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * after 10ms, reset the BMUs and repair the rings</span>
<span class="cm">		 */</span>
		<span class="n">hwt_wait_time</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">time</span><span class="p">,</span><span class="n">MS2BCLK</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_R1_CSR</span><span class="p">),</span><span class="n">CSR_SET_RESET</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XA_CSR</span><span class="p">),</span><span class="n">CSR_SET_RESET</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XS_CSR</span><span class="p">),</span><span class="n">CSR_SET_RESET</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outp</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_CTRL</span><span class="p">),</span> <span class="n">CTRL_HPI_CLR</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_R1_CSR</span><span class="p">),</span><span class="n">CSR_CLR_RESET</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XA_CSR</span><span class="p">),</span><span class="n">CSR_CLR_RESET</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XS_CSR</span><span class="p">),</span><span class="n">CSR_CLR_RESET</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_is_64bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R1_F</span><span class="p">),</span> <span class="n">RX_WATERMARK</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XA_F</span><span class="p">),</span> <span class="n">TX_WATERMARK</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XS_F</span><span class="p">),</span> <span class="n">TX_WATERMARK</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_state</span> <span class="o">=</span> <span class="n">STOPPED</span> <span class="p">;</span>
		<span class="n">mac_drv_repair_descr</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_state</span> <span class="o">=</span> <span class="n">STARTED</span> <span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * called by CFM</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">config_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">plc_config_mux</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mux</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">SETMASK</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">FM_SELRA</span><span class="p">,</span><span class="n">FM_SELRA</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called by RMT</span>
<span class="cm"> * enable CLAIM/BEACON interrupts</span>
<span class="cm"> * (only called if these events are of interest, e.g. in DETECT state</span>
<span class="cm"> * the interrupt must not be permanently enabled</span>
<span class="cm"> * RMT calls this function periodically (timer driven polling)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sm_mac_check_beacon_claim</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* set formac IMSK : 0 enables irq */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_IMSK2U</span><span class="p">),</span><span class="o">~</span><span class="p">(</span><span class="n">mac_imsk2u</span> <span class="o">|</span> <span class="n">mac_beacon_imsk2u</span><span class="p">))</span> <span class="p">;</span>
	<span class="cm">/* the driver must receive the directed beacons */</span>
	<span class="n">formac_rcv_restart</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">process_receive</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*-------------------------- interface functions ----------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * control MAC layer	(called by RMT)</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sm_ma_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MA_OFFLINE</span> :
		<span class="cm">/* Add to make the MAC offline in RM0_ISOLATED state */</span>
		<span class="n">formac_offline</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">MA_RESET</span> :
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">init_mac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">MA_BEACON</span> :
		<span class="n">formac_online</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">MA_DIRECTED</span> :
		<span class="n">directed_beacon</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">MA_TREQ</span> :
		<span class="cm">/*</span>
<span class="cm">		 * no actions necessary, TREQ is already set</span>
<span class="cm">		 */</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">sm_mac_get_tx_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_STMCHN</span><span class="p">))</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * multicast functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s_fpmc</span><span class="o">*</span> <span class="nf">mac_get_mc_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">user</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">own</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">del</span><span class="p">,</span> <span class="kt">int</span> <span class="n">can</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_fpmc</span>	<span class="o">*</span><span class="n">tb</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_fpmc</span>	<span class="o">*</span><span class="n">slot</span> <span class="p">;</span>
	<span class="n">u_char</span>	<span class="o">*</span><span class="n">p</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set own = can(user)</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">own</span> <span class="o">=</span> <span class="o">*</span><span class="n">user</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">own</span><span class="o">-&gt;</span><span class="n">a</span> <span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mc</span><span class="p">.</span><span class="n">table</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FPMAX_MULTICAST</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">tb</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* not used */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">del</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">slot</span><span class="p">)</span>	<span class="cm">/* if !del save first free */</span>
				<span class="n">slot</span> <span class="o">=</span> <span class="n">tb</span> <span class="p">;</span>
			<span class="k">continue</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">own</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
			<span class="k">continue</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">tb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">slot</span><span class="p">;</span>			<span class="cm">/* return first free or NULL */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(if,func;others;2)</span>

<span class="cm">	void mac_clear_multicast(smc)</span>
<span class="cm">	struct s_smc *smc ;</span>

<span class="cm">Function	DOWNCALL	(SMT, fplustm.c)</span>
<span class="cm">		Clear all multicast entries</span>

<span class="cm">	END_MANUAL_ENTRY()</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_clear_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_fpmc</span>	<span class="o">*</span><span class="n">tb</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">os_slots_used</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>	<span class="cm">/* note the SMT addresses */</span>
					<span class="cm">/* will not be deleted */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mc</span><span class="p">.</span><span class="n">table</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FPMAX_MULTICAST</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">tb</span><span class="o">++</span><span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">perm</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tb</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(if,func;others;2)</span>

<span class="cm">	int mac_add_multicast(smc,addr,can)</span>
<span class="cm">	struct s_smc *smc ;</span>
<span class="cm">	struct fddi_addr *addr ;</span>
<span class="cm">	int can ;</span>

<span class="cm">Function	DOWNCALL	(SMC, fplustm.c)</span>
<span class="cm">		Add an entry to the multicast table</span>

<span class="cm">Para	addr	pointer to a multicast address</span>
<span class="cm">	can	= 0:	the multicast address has the physical format</span>
<span class="cm">		= 1:	the multicast address has the canonical format</span>
<span class="cm">		| 0x80	permanent</span>

<span class="cm">Returns	0: success</span>
<span class="cm">	1: address table full</span>

<span class="cm">Note	After a &#39;driver reset&#39; or a &#39;station set address&#39; all</span>
<span class="cm">	entries of the multicast table are cleared.</span>
<span class="cm">	In this case the driver has to fill the multicast table again.</span>
<span class="cm">	After the operating system dependent module filled</span>
<span class="cm">	the multicast table it must call mac_update_multicast</span>
<span class="cm">	to activate the new multicast addresses!</span>

<span class="cm">	END_MANUAL_ENTRY()</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mac_add_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">can</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_LOC_DECL</span><span class="p">(</span><span class="k">struct</span> <span class="n">fddi_addr</span><span class="p">,</span><span class="n">own</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_fpmc</span>	<span class="o">*</span><span class="n">tb</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check if there are free table entries</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">can</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">smt_slots_used</span> <span class="o">&gt;=</span> <span class="n">SMT_MAX_MULTI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">os_slots_used</span> <span class="o">&gt;=</span> <span class="n">FPMAX_MULTICAST</span><span class="o">-</span><span class="n">SMT_MAX_MULTI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * find empty slot</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tb</span> <span class="o">=</span> <span class="n">mac_get_mc_table</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">own</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">can</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x80</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">n</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">=</span> <span class="n">own</span> <span class="p">;</span>
	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">perm</span> <span class="o">=</span> <span class="p">(</span><span class="n">can</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">can</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">smt_slots_used</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">else</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">os_slots_used</span><span class="o">++</span> <span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mode</span>
<span class="cm"> */</span>

<span class="cp">#define RX_MODE_PROM		0x1</span>
<span class="cp">#define RX_MODE_ALL_MULTI	0x2</span>

<span class="cm">/*</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(if,func;others;2)</span>

<span class="cm">	void mac_update_multicast(smc)</span>
<span class="cm">	struct s_smc *smc ;</span>

<span class="cm">Function	DOWNCALL	(SMT, fplustm.c)</span>
<span class="cm">		Update FORMAC multicast registers</span>

<span class="cm">	END_MANUAL_ENTRY()</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_update_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_fpmc</span>	<span class="o">*</span><span class="n">tb</span> <span class="p">;</span>
	<span class="n">u_char</span>	<span class="o">*</span><span class="n">fu</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * invalidate the CAM</span>
<span class="cm">	 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCMD</span><span class="p">),</span><span class="n">FM_IINV_CAM</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the functional address</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">func_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">func_addr</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFMASK2</span><span class="p">),</span><span class="mh">0xffff</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFMASK1</span><span class="p">),(</span><span class="n">u_short</span><span class="p">)</span> <span class="o">~</span><span class="p">((</span><span class="n">fu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">fu</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFMASK0</span><span class="p">),(</span><span class="n">u_short</span><span class="p">)</span> <span class="o">~</span><span class="p">((</span><span class="n">fu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">fu</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFPERS</span><span class="p">),</span><span class="n">FM_VALID</span><span class="o">|</span><span class="n">FM_DA</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCOMP2</span><span class="p">),</span> <span class="mh">0xc000</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCOMP1</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCOMP0</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCMD</span><span class="p">),</span><span class="n">FM_IWRITE_CAM</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the mask and the personality register(s)</span>
<span class="cm">	 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFMASK0</span><span class="p">),</span><span class="mh">0xffff</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFMASK1</span><span class="p">),</span><span class="mh">0xffff</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFMASK2</span><span class="p">),</span><span class="mh">0xffff</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFPERS</span><span class="p">),</span><span class="n">FM_VALID</span><span class="o">|</span><span class="n">FM_DA</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mc</span><span class="p">.</span><span class="n">table</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FPMAX_MULTICAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">tb</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CHECK_CAM</span><span class="p">()</span> <span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * write the multicast address into the CAM</span>
<span class="cm">			 */</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCOMP2</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u_short</span><span class="p">)((</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">;</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCOMP1</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u_short</span><span class="p">)((</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span> <span class="p">;</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCOMP0</span><span class="p">),</span>
				<span class="p">(</span><span class="n">u_short</span><span class="p">)((</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span><span class="o">+</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">5</span><span class="p">]))</span> <span class="p">;</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_AFCMD</span><span class="p">),</span><span class="n">FM_IWRITE_CAM</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(if,func;others;3)</span>

<span class="cm">	void mac_set_rx_mode(smc,mode)</span>
<span class="cm">	struct s_smc *smc ;</span>
<span class="cm">	int mode ;</span>

<span class="cm">Function	DOWNCALL/INTERN	(SMT, fplustm.c)</span>
<span class="cm">		This function enables / disables the selected receive.</span>
<span class="cm">		Don&#39;t call this function if the hardware module is</span>
<span class="cm">		used -- use mac_drv_rx_mode() instead of.</span>

<span class="cm">Para	mode =	1	RX_ENABLE_ALLMULTI	enable all multicasts</span>
<span class="cm">		2	RX_DISABLE_ALLMULTI	disable &quot;enable all multicasts&quot;</span>
<span class="cm">		3	RX_ENABLE_PROMISC	enable promiscuous</span>
<span class="cm">		4	RX_DISABLE_PROMISC	disable promiscuous</span>
<span class="cm">		5	RX_ENABLE_NSA		enable reception of NSA frames</span>
<span class="cm">		6	RX_DISABLE_NSA		disable reception of NSA frames</span>

<span class="cm">Note	The selected receive modes will be lost after &#39;driver reset&#39;</span>
<span class="cm">	or &#39;set station address&#39;</span>

<span class="cm">	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_set_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RX_ENABLE_ALLMULTI</span> :
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_prom</span> <span class="o">|=</span> <span class="n">RX_MODE_ALL_MULTI</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_DISABLE_ALLMULTI</span> :
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_prom</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_MODE_ALL_MULTI</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_ENABLE_PROMISC</span> :
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_prom</span> <span class="o">|=</span> <span class="n">RX_MODE_PROM</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_DISABLE_PROMISC</span> :
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_prom</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RX_MODE_PROM</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_ENABLE_NSA</span> :
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">nsa_mode</span> <span class="o">=</span> <span class="n">FM_MDAMA</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FM_ADDET</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">nsa_mode</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_DISABLE_NSA</span> :
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">nsa_mode</span> <span class="o">=</span> <span class="n">FM_MRNNSAFNMA</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FM_ADDET</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">nsa_mode</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_prom</span> <span class="o">&amp;</span> <span class="n">RX_MODE_PROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">FM_MLIMPROM</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_prom</span> <span class="o">&amp;</span> <span class="n">RX_MODE_ALL_MULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">nsa_mode</span> <span class="o">|</span> <span class="n">FM_EXGPA0</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">nsa_mode</span> <span class="p">;</span>
	<span class="n">SETMASK</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_MDREG1</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_mode</span><span class="p">,</span><span class="n">FM_ADDRX</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">mac_update_multicast</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(module;tests;3)</span>
<span class="cm">	How to test the Restricted Token Monitor</span>
<span class="cm">	----------------------------------------------------------------</span>

<span class="cm">	o Insert a break point in the function rtm_irq()</span>
<span class="cm">	o Remove all stations with a restricted token monitor from the</span>
<span class="cm">	  network.</span>
<span class="cm">	o Connect a UPPS ISA or EISA station to the network.</span>
<span class="cm">	o Give the FORMAC of UPPS station the command to send</span>
<span class="cm">	  restricted tokens until the ring becomes instable.</span>
<span class="cm">	o Now connect your test test client.</span>
<span class="cm">	o The restricted token monitor should detect the restricted token,</span>
<span class="cm">	  and your break point will be reached.</span>
<span class="cm">	o You can ovserve how the station will clean the ring.</span>

<span class="cm">	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rtm_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B2_RTM_CRTL</span><span class="p">),</span><span class="n">TIM_CL_IRQ</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* clear IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B2_RTM_CRTL</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">TIM_RES_TOK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_CMDREG1</span><span class="p">),</span><span class="n">FM_ICL</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* force claim */</span>
		<span class="n">DB_RMT</span><span class="p">(</span><span class="s">&quot;RMT: fddiPATHT_Rmode expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">AIX_EVENT</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_RING_STATUS</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_SMT_EVENT</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_RTT</span><span class="p">,</span> <span class="n">smt_get_event_word</span><span class="p">(</span><span class="n">smc</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B2_RTM_CRTL</span><span class="p">),</span><span class="n">TIM_START</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* enable RTM monitoring */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rtm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B2_RTM_INI</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* timer = 0 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B2_RTM_CRTL</span><span class="p">),</span><span class="n">TIM_START</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* enable IRQ */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">rtm_set_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * MIB timer and hardware timer have the same resolution of 80nS</span>
<span class="cm">	 */</span>
	<span class="n">DB_RMT</span><span class="p">(</span><span class="s">&quot;RMT: setting new fddiPATHT_Rmode, t = %d ns</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHT_Rmode</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B2_RTM_INI</span><span class="p">),</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHT_Rmode</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_split_up_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>

<span class="cm">/*</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(module;mem;1)</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	RECEIVE BUFFER MEMORY DIVERSION</span>
<span class="cm">	-------------------------------------------------------------</span>

<span class="cm">	R1_RxD == SMT_R1_RXD_COUNT</span>
<span class="cm">	R2_RxD == SMT_R2_RXD_COUNT</span>

<span class="cm">	SMT_R1_RXD_COUNT must be unequal zero</span>

<span class="cm">		   | R1_RxD R2_RxD |R1_RxD R2_RxD | R1_RxD R2_RxD</span>
<span class="cm">		   |   x      0	   |  x	    1-3	  |   x     &lt; 3</span>
<span class="cm">	----------------------------------------------------------------------</span>
<span class="cm">		   |   63,75 kB	   |    54,75	  |	R1_RxD</span>
<span class="cm">	rx queue 1 | RX_FIFO_SPACE | RX_LARGE_FIFO| ------------- * 63,75 kB</span>
<span class="cm">		   |		   |		  | R1_RxD+R2_RxD</span>
<span class="cm">	----------------------------------------------------------------------</span>
<span class="cm">		   |		   |    9 kB	  |     R2_RxD</span>
<span class="cm">	rx queue 2 |	0 kB	   | RX_SMALL_FIFO| ------------- * 63,75 kB</span>
<span class="cm">		   |  (not used)   |		  | R1_RxD+R2_RxD</span>

<span class="cm">	END_MANUAL_ENTRY</span>
<span class="cm">*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">SMT_R1_RXD_COUNT</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_E0117</span><span class="p">,</span> <span class="n">SMT_E0117_MSG</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">SMT_R2_RXD_COUNT</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_size</span> <span class="o">=</span> <span class="n">RX_FIFO_SPACE</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_size</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_size</span> <span class="o">=</span> <span class="n">RX_LARGE_FIFO</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_size</span> <span class="o">=</span> <span class="n">RX_SMALL_FIFO</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="nl">default:</span>	<span class="cm">/* this is not the real defaule */</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_size</span> <span class="o">=</span> <span class="n">RX_FIFO_SPACE</span> <span class="o">*</span>
		<span class="n">SMT_R1_RXD_COUNT</span><span class="o">/</span><span class="p">(</span><span class="n">SMT_R1_RXD_COUNT</span><span class="o">+</span><span class="n">SMT_R2_RXD_COUNT</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_size</span> <span class="o">=</span> <span class="n">RX_FIFO_SPACE</span> <span class="o">*</span>
		<span class="n">SMT_R2_RXD_COUNT</span><span class="o">/</span><span class="p">(</span><span class="n">SMT_R1_RXD_COUNT</span><span class="o">+</span><span class="n">SMT_R2_RXD_COUNT</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(module;mem;1)</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	TRANSMIT BUFFER MEMORY DIVERSION</span>
<span class="cm">	-------------------------------------------------------------</span>


<span class="cm">		 | no sync bw	| sync bw available and | sync bw available and</span>
<span class="cm">		 | available	| SynchTxMode = SPLIT	| SynchTxMode = ALL</span>
<span class="cm">	-----------------------------------------------------------------------</span>
<span class="cm">	sync tx	 |     0 kB	|	32 kB		|	55 kB</span>
<span class="cm">	queue	 |		|   TX_MEDIUM_FIFO	|   TX_LARGE_FIFO</span>
<span class="cm">	-----------------------------------------------------------------------</span>
<span class="cm">	async tx |    64 kB	|	32 kB		|	 9 k</span>
<span class="cm">	queue	 | TX_FIFO_SPACE|   TX_MEDIUM_FIFO	|   TX_SMALL_FIFO</span>

<span class="cm">	END_MANUAL_ENTRY</span>
<span class="cm">*/</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the tx mode bits</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef ESS</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_config_mode</span> <span class="o">|=</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSSynchTxMode</span> <span class="o">|</span> <span class="n">SYNC_TRAFFIC_ON</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_config_mode</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">SEND_ASYNC_AS_SYNC</span><span class="o">|</span><span class="n">SYNC_TRAFFIC_ON</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * split up the FIFO</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_config_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_TRAFFIC_ON</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_config_mode</span> <span class="o">&amp;</span> <span class="n">SEND_ASYNC_AS_SYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_size</span> <span class="o">=</span> <span class="n">TX_LARGE_FIFO</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_size</span> <span class="o">=</span> <span class="n">TX_SMALL_FIFO</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_size</span> <span class="o">=</span> <span class="n">TX_MEDIUM_FIFO</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_size</span> <span class="o">=</span> <span class="n">TX_MEDIUM_FIFO</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_size</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_size</span> <span class="o">=</span> <span class="n">TX_FIFO_SPACE</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_start</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span> <span class="o">+</span>
		<span class="n">RX_FIFO_OFF</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_start</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_start</span> <span class="o">+</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_size</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_start</span> <span class="o">+</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_size</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_start</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span> <span class="o">+</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_size</span> <span class="p">;</span>

	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;FIFO split: mode = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_config_mode</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;rbc_ram_start =	%x	 rbc_ram_end = 	%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_start</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rbc_ram_end</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;rx1_fifo_start = %x	 tx_s_start = 	%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx1_fifo_start</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_start</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;tx_a0_start =	%x	 rx2_fifo_start = 	%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_a0_start</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">rx2_fifo_start</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">formac_reinit_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Split up the FIFO and reinitialize the MAC if synchronous</span>
<span class="cm">	 * bandwidth becomes available but no synchronous queue is</span>
<span class="cm">	 * configured.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">tx_s_size</span> <span class="o">&amp;&amp;</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span><span class="p">){</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">init_mac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
