<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › fddi › skfp › ess.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ess.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *	(C)Copyright 1998,1999 SysKonnect,</span>
<span class="cm"> *	a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.</span>
<span class="cm"> *</span>
<span class="cm"> *	See the file &quot;skfddi.c&quot; for further information.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	The information in this file is provided &quot;AS IS&quot; without warranty.</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * *******************************************************************</span>
<span class="cm"> * This SBA code implements the Synchronous Bandwidth Allocation</span>
<span class="cm"> * functions described in the &quot;FDDI Synchronous Forum Implementer&#39;s</span>
<span class="cm"> * Agreement&quot; dated December 1th, 1993.</span>
<span class="cm"> * *******************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *	PURPOSE: The purpose of this function is to control</span>
<span class="cm"> *		 synchronous allocations on a single FDDI segment.</span>
<span class="cm"> *		 Allocations are limited to the primary FDDI ring.</span>
<span class="cm"> *		 The SBM provides recovery mechanisms to recover</span>
<span class="cm"> *		 unused bandwidth also resolves T_Neg and</span>
<span class="cm"> *		 reconfiguration changes. Many of the SBM state</span>
<span class="cm"> *		 machine inputs are sourced by the underlying</span>
<span class="cm"> *		 FDDI sub-system supporting the SBA application.</span>
<span class="cm"> *</span>
<span class="cm"> * *******************************************************************</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;h/types.h&quot;</span>
<span class="cp">#include &quot;h/fddi.h&quot;</span>
<span class="cp">#include &quot;h/smc.h&quot;</span>
<span class="cp">#include &quot;h/smt_p.h&quot;</span>


<span class="cp">#ifndef	SLIM_SMT</span>

<span class="cp">#ifdef ESS</span>

<span class="cp">#ifndef lint</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ID_sccs</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;@(#)ess.c	1.10 96/02/23 (C) SK&quot;</span> <span class="p">;</span>
<span class="cp">#define LINT_USE(x)</span>
<span class="cp">#else</span>
<span class="cp">#define LINT_USE(x)	(x)=(x)</span>
<span class="cp">#endif</span>
<span class="cp">#define MS2BCLK(x)	((x)*12500L)</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	LOCAL VARIABLES:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u_short</span> <span class="n">plist_raf_alc_res</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SMT_P0012</span><span class="p">,</span> <span class="n">SMT_P320B</span><span class="p">,</span> <span class="n">SMT_P320F</span><span class="p">,</span>
					<span class="n">SMT_P3210</span><span class="p">,</span> <span class="n">SMT_P0019</span><span class="p">,</span> <span class="n">SMT_P001A</span><span class="p">,</span>
					<span class="n">SMT_P001D</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u_short</span> <span class="n">plist_raf_chg_req</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SMT_P320B</span><span class="p">,</span> <span class="n">SMT_P320F</span><span class="p">,</span> <span class="n">SMT_P3210</span><span class="p">,</span>
					<span class="n">SMT_P001A</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="n">smt_sba_da</span> <span class="o">=</span> <span class="p">{{</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x80</span><span class="p">,</span><span class="mh">0x0C</span><span class="p">}}</span> <span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="n">null_addr</span> <span class="o">=</span> <span class="p">{{</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">}}</span> <span class="p">;</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	GLOBAL VARIABLES:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>


<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	LOCAL FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ess_send_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">sba_cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ess_config_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ess_send_alc_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ess_send_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	EXTERNAL FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	PUBLIC FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="kt">void</span> <span class="n">ess_timer_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">ess_para_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">ess_raf_received_pack</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">fs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">process_bw_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">overhead</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * --------------------------------------------------------------------------</span>
<span class="cm"> *	End Station Support	(ESS)</span>
<span class="cm"> * --------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * evaluate the RAF frame</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">ess_raf_received_pack</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">fs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">p</span> <span class="p">;</span>		<span class="cm">/* universal pointer */</span>
	<span class="k">struct</span> <span class="n">smt_p_0016</span>	<span class="o">*</span><span class="n">cmd</span> <span class="p">;</span>		<span class="cm">/* para: command for the ESS */</span>
	<span class="n">SMbuf</span>			<span class="o">*</span><span class="n">db</span> <span class="p">;</span>
	<span class="n">u_long</span>			<span class="n">msg_res_type</span> <span class="p">;</span>	<span class="cm">/* recource type */</span>
	<span class="n">u_long</span>			<span class="n">payload</span><span class="p">,</span> <span class="n">overhead</span> <span class="p">;</span>
	<span class="kt">int</span>			<span class="n">local</span> <span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Message Processing Code</span>
<span class="cm">	 */</span>
	 <span class="n">local</span> <span class="o">=</span> <span class="p">((</span><span class="n">fs</span> <span class="o">&amp;</span> <span class="n">L_INDICATOR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get the resource type</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P0015</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: RAF frame error, parameter type not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">msg_res_type</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">smt_p_0015</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">res_type</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get the pointer to the ESS command</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0016</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P0016</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * error in frame: para ESS command was not found</span>
<span class="cm">		 */</span>
		 <span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: RAF frame error, parameter command not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		 <span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;fc %x	ft %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;ver %x	tran %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_version</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;stn_id %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;infolen %x	res %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_len</span><span class="p">,</span> <span class="n">msg_res_type</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;sbacmd %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sba_cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * evaluate the ESS command</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sba_cmd</span><span class="p">)</span> <span class="p">{</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process an ESS Allocation Request</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">REQUEST_ALLOCATION</span> :
		<span class="cm">/*</span>
<span class="cm">		 * check for an RAF Request (Allocation Request)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">==</span> <span class="n">SMT_REQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * process the Allocation request only if the frame is</span>
<span class="cm">			 * local and no static allocation is used</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span> <span class="o">||</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSPayload</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
			
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P0019</span><span class="p">)</span>  <span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">smt_p_0019</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">alloc_addr</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Note: The Application should send a LAN_LOC_FRAME.</span>
<span class="cm">			 *	 The ESS do not send the Frame to the network!</span>
<span class="cm">			 */</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">alloc_trans_id</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="p">;</span>
			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: save Alloc Req Trans ID %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P320F</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">smt_p_320f</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mib_payload</span> <span class="o">=</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span> <span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P3210</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">smt_p_3210</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mib_overhead</span> <span class="o">=</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaOverhead</span> <span class="p">;</span>
			<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="n">smt_sba_da</span> <span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">local_sba_active</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">fs</span> <span class="o">|</span> <span class="n">I_INDICATOR</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">db</span> <span class="o">=</span> <span class="n">smt_get_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">)))</span>
				<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>

			<span class="n">db</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="p">;</span>
			<span class="n">db</span><span class="o">-&gt;</span><span class="n">sm_off</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_off</span> <span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">sm_data</span><span class="o">+</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">sm_off</span><span class="p">)),(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sm</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">sm_len</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">sm_data</span><span class="o">+</span><span class="n">db</span><span class="o">-&gt;</span><span class="n">sm_off</span><span class="p">),</span>
				<span class="s">&quot;RAF&quot;</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smt_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">db</span><span class="p">,</span><span class="n">FC_SMT_INFO</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * The RAF frame is an Allocation Response !</span>
<span class="cm">		 * check the parameters</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smt_check_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">plist_raf_alc_res</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: RAF with para problem, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * VERIFY THE FRAME IS WELL BUILT:</span>
<span class="cm">		 *</span>
<span class="cm">		 *	1. path index = primary ring only</span>
<span class="cm">		 *	2. resource type = sync bw only</span>
<span class="cm">		 *	3. trans action id = alloc_trans_id</span>
<span class="cm">		 *	4. reason code = success</span>
<span class="cm">		 *</span>
<span class="cm">		 * If any are violated, discard the RAF frame</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((((</span><span class="k">struct</span> <span class="n">smt_p_320b</span> <span class="o">*</span><span class="p">)</span><span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P320B</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">path_index</span>
			<span class="o">!=</span> <span class="n">PRIMARY_RING</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">msg_res_type</span> <span class="o">!=</span> <span class="n">SYNC_BW</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(((</span><span class="k">struct</span> <span class="n">smt_p_reason</span> <span class="o">*</span><span class="p">)</span><span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P0012</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">rdf_reason</span>
			<span class="o">!=</span> <span class="n">SMT_RDF_SUCCESS</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="o">!=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">alloc_trans_id</span><span class="p">))</span> <span class="p">{</span>

			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: Allocation Response not accepted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Extract message parameters</span>
<span class="cm">		 */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P320F</span><span class="p">)</span> <span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ESS: sm_to_para failed&quot;</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
                <span class="p">}</span>       
		<span class="n">payload</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">smt_p_320f</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mib_payload</span> <span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P3210</span><span class="p">)</span> <span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ESS: sm_to_para failed&quot;</span><span class="p">);</span>
                        <span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
                <span class="p">}</span>       
		<span class="n">overhead</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">smt_p_3210</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mib_overhead</span> <span class="p">;</span>

		<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;payload= %lx	overhead= %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">payload</span><span class="p">,</span><span class="n">overhead</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * process the bandwidth allocation</span>
<span class="cm">		 */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">process_bw_alloc</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">payload</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">overhead</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="cm">/* end of Process Allocation Request */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process an ESS Change Request</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">CHANGE_ALLOCATION</span> :
		<span class="cm">/*</span>
<span class="cm">		 * except only replies</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">!=</span> <span class="n">SMT_REQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: Do not process Change Responses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * check the para for the Change Request</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smt_check_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">plist_raf_chg_req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: RAF with para problem, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Verify the path index and resource</span>
<span class="cm">		 * type are correct. If any of</span>
<span class="cm">		 * these are false, don&#39;t process this</span>
<span class="cm">		 * change request frame.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((((</span><span class="k">struct</span> <span class="n">smt_p_320b</span> <span class="o">*</span><span class="p">)</span><span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P320B</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">path_index</span>
			<span class="o">!=</span> <span class="n">PRIMARY_RING</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">msg_res_type</span> <span class="o">!=</span> <span class="n">SYNC_BW</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: RAF frame with para problem, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Extract message queue parameters</span>
<span class="cm">		 */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P320F</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">payload</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">smt_p_320f</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mib_payload</span> <span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P3210</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">overhead</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">smt_p_3210</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mib_overhead</span> <span class="p">;</span>

		<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;ESS: Change Request from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;payload= %lx	overhead= %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">payload</span><span class="p">,</span><span class="n">overhead</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * process the bandwidth allocation</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">process_bw_alloc</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">payload</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">overhead</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * send an RAF Change Reply</span>
<span class="cm">		 */</span>
		<span class="n">ess_send_response</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">CHANGE_ALLOCATION</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="cm">/* end of Process Change Request */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Process Report Response</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">REPORT_ALLOCATION</span> :
		<span class="cm">/*</span>
<span class="cm">		 * except only requests</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">!=</span> <span class="n">SMT_REQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: Do not process a Report Reply</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;ESS: Report Request from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">)),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * verify that the resource type is sync bw only</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_res_type</span> <span class="o">!=</span> <span class="n">SYNC_BW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: ignoring RAF with para problem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * send an RAF Change Reply</span>
<span class="cm">		 */</span>
		<span class="n">ess_send_response</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">REPORT_ALLOCATION</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
		<span class="cm">/* end of Process Report Request */</span>

	<span class="nl">default:</span>
		<span class="cm">/*</span>
<span class="cm">		 * error in frame</span>
<span class="cm">		 */</span>
		<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: ignoring RAF with bad sba_cmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">fs</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * determines the synchronous bandwidth, set the TSYNC register and the</span>
<span class="cm"> * mib variables SBAPayload, SBAOverhead and fddiMACT-NEG.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">process_bw_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">overhead</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * determine the synchronous bandwidth (sync_bw) in bytes per T-NEG,</span>
<span class="cm">	 * if the payload is greater than zero.</span>
<span class="cm">	 * For the SBAPayload and the SBAOverhead we have the following</span>
<span class="cm">	 * unite quations</span>
<span class="cm"> 	 *		      _		  _</span>
<span class="cm">	 *		     |	     bytes |</span>
<span class="cm">	 *	SBAPayload = | 8000 ------ |</span>
<span class="cm">	 *		     |		s  |</span>
<span class="cm">	 *		      -		  -</span>
<span class="cm"> 	 *		       _       _</span>
<span class="cm">	 *		      |	 bytes	|</span>
<span class="cm">	 *	SBAOverhead = | ------	|</span>
<span class="cm">	 *		      |	 T-NEG	|</span>
<span class="cm">	 *		       -       -</span>
<span class="cm"> 	 *</span>
<span class="cm">	 * T-NEG is described by the equation:</span>
<span class="cm">	 *</span>
<span class="cm">	 *		     (-) fddiMACT-NEG</span>
<span class="cm">	 *	T-NEG =	    -------------------</span>
<span class="cm">	 *			12500000 1/s</span>
<span class="cm">	 *</span>
<span class="cm">	 * The number of bytes we are able to send is the payload</span>
<span class="cm">	 * plus the overhead.</span>
<span class="cm">	 *</span>
<span class="cm">	 *			  bytes    T-NEG SBAPayload 8000 bytes/s</span>
<span class="cm">	 * sync_bw =  SBAOverhead ------ + -----------------------------</span>
<span class="cm">	 *	   		  T-NEG		T-NEG</span>
<span class="cm">	 *</span>
<span class="cm">	 *</span>
<span class="cm">	 *	      		     1</span>
<span class="cm">	 * sync_bw =  SBAOverhead + ---- (-)fddiMACT-NEG * SBAPayload</span>
<span class="cm">	 *	       		    1562</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the mib attributes fddiPATHSbaOverhead, fddiPATHSbaPayload</span>
<span class="cm">	 */</span>
<span class="cm">/*	if (smt_set_obj(smc,SMT_P320F,payload,S_SET)) {</span>
<span class="cm">		DB_ESS(&quot;ESS: SMT does not accept the payload value\n&quot;,0,0) ;</span>
<span class="cm">		return FALSE;</span>
<span class="cm">	}</span>
<span class="cm">	if (smt_set_obj(smc,SMT_P3210,overhead,S_SET)) {</span>
<span class="cm">		DB_ESS(&quot;ESS: SMT does not accept the overhead value\n&quot;,0,0) ;</span>
<span class="cm">		return FALSE;</span>
<span class="cm">	} */</span>

	<span class="cm">/* premliminary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload</span> <span class="o">&gt;</span> <span class="n">MAX_PAYLOAD</span> <span class="o">||</span> <span class="n">overhead</span> <span class="o">&gt;</span> <span class="mi">5000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS: payload / overhead not accepted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="n">FALSE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * start the iterative allocation process if the payload or the overhead</span>
<span class="cm">	 * are smaller than the parsed values</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSPayload</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">u_long</span><span class="p">)</span><span class="n">payload</span> <span class="o">!=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSPayload</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="n">overhead</span> <span class="o">!=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSOverhead</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">raf_act_timer_poll</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">timer_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * evulate the Payload</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;ESS: turn SMT_ST_SYNC_SERVICE bit on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sync_bw_available</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>

		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sync_bw</span> <span class="o">=</span> <span class="n">overhead</span> <span class="o">-</span>
			<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Neg</span> <span class="o">*</span>
			<span class="n">payload</span> <span class="o">/</span> <span class="mi">1562</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;ESS: turn SMT_ST_SYNC_SERVICE bit off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sync_bw_available</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sync_bw</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">overhead</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span> <span class="o">=</span> <span class="n">payload</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaOverhead</span> <span class="o">=</span> <span class="n">overhead</span> <span class="p">;</span>


	<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;tsync = %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sync_bw</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">ess_config_fifo</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">set_formac_tsync</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sync_bw</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_send_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">sba_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_sba_chg</span>	<span class="o">*</span><span class="n">chg</span> <span class="p">;</span>
	<span class="n">SMbuf</span>			<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>
	<span class="kt">void</span>			<span class="o">*</span><span class="n">p</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get and initialize the response frame</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sba_cmd</span> <span class="o">==</span> <span class="n">CHANGE_ALLOCATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span><span class="o">=</span><span class="n">smt_build_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_RAF</span><span class="p">,</span><span class="n">SMT_REPLY</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_sba_chg</span><span class="p">))))</span>
				<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span><span class="o">=</span><span class="n">smt_build_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_RAF</span><span class="p">,</span><span class="n">SMT_REPLY</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_sba_rep_res</span><span class="p">))))</span>
				<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chg</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="k">struct</span> <span class="n">smt_sba_chg</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span> <span class="p">;</span>

	<span class="cm">/* set P15 */</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">s_type</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P0015</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">s_type</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0015</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">s_type</span><span class="p">.</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">SYNC_BW</span> <span class="p">;</span>

	<span class="cm">/* set P16 */</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P0016</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0016</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">sba_cmd</span> <span class="o">=</span> <span class="n">sba_cmd</span> <span class="p">;</span>

	<span class="cm">/* set P320B */</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P320B</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_320b</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mib_index</span> <span class="o">=</span> <span class="n">SBAPATHINDEX</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">path_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">path_index</span> <span class="o">=</span> <span class="n">PRIMARY_RING</span> <span class="p">;</span>

	<span class="cm">/* set P320F */</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P320F</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_320f</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">mib_index</span> <span class="o">=</span> <span class="n">SBAPATHINDEX</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">mib_payload</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span> <span class="p">;</span>

	<span class="cm">/* set P3210 */</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">overhead</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P3210</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">overhead</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_3210</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">overhead</span><span class="p">.</span><span class="n">mib_index</span> <span class="o">=</span> <span class="n">SBAPATHINDEX</span> <span class="p">;</span>
	<span class="n">chg</span><span class="o">-&gt;</span><span class="n">overhead</span><span class="p">.</span><span class="n">mib_overhead</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaOverhead</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sba_cmd</span> <span class="o">==</span> <span class="n">CHANGE_ALLOCATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set P1A */</span>
		<span class="n">chg</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P001A</span> <span class="p">;</span>
		<span class="n">chg</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_001a</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P001A</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">chg</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">smt_p_001a</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">category</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span><span class="n">chg</span><span class="p">,</span><span class="s">&quot;RAF&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">ess_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ess_timer_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">raf_act_timer_poll</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;ESS: timer_poll</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">timer_count</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">timer_count</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">timer_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">ess_send_alc_req</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_send_alc_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_sba_alc_req</span> <span class="o">*</span><span class="n">req</span> <span class="p">;</span>
	<span class="n">SMbuf</span>	<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * send never allocation request where the requested payload and</span>
<span class="cm">	 * overhead is zero or deallocate bandwidth when no bandwidth is</span>
<span class="cm">	 * parsed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSPayload</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSOverhead</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSOverhead</span><span class="p">)</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSOverhead</span> <span class="o">=</span> <span class="n">DEFAULT_OV</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSOverhead</span> <span class="o">==</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaOverhead</span> <span class="o">&amp;&amp;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSPayload</span> <span class="o">==</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span><span class="p">){</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">raf_act_timer_poll</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">timer_count</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">;</span>	<span class="cm">/* next RAF alc req after 3 s */</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
	
	<span class="cm">/*</span>
<span class="cm">	 * get and initialize the response frame</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span><span class="o">=</span><span class="n">smt_build_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_RAF</span><span class="p">,</span><span class="n">SMT_REQUEST</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_sba_alc_req</span><span class="p">))))</span>
			<span class="k">return</span> <span class="p">;</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="k">struct</span> <span class="n">smt_sba_alc_req</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">alloc_trans_id</span> <span class="o">=</span> <span class="n">smt_get_tid</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="n">smt_sba_da</span> <span class="p">;</span>

	<span class="cm">/* set P15 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">s_type</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P0015</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">s_type</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0015</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">s_type</span><span class="p">.</span><span class="n">res_type</span> <span class="o">=</span> <span class="n">SYNC_BW</span> <span class="p">;</span>

	<span class="cm">/* set P16 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P0016</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0016</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">sba_cmd</span> <span class="o">=</span> <span class="n">REQUEST_ALLOCATION</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set the parameter type and parameter length of all used</span>
<span class="cm">	 * parameters</span>
<span class="cm">	 */</span>

	<span class="cm">/* set P320B */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P320B</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_320b</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">mib_index</span> <span class="o">=</span> <span class="n">SBAPATHINDEX</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">path_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">.</span><span class="n">path_index</span> <span class="o">=</span> <span class="n">PRIMARY_RING</span> <span class="p">;</span>

	<span class="cm">/* set P0017 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pl_req</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P0017</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pl_req</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0017</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">pl_req</span><span class="p">.</span><span class="n">sba_pl_req</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSPayload</span> <span class="o">-</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span> <span class="p">;</span>

	<span class="cm">/* set P0018 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ov_req</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P0018</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ov_req</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0018</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">ov_req</span><span class="p">.</span><span class="n">sba_ov_req</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSOverhead</span> <span class="o">-</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaOverhead</span> <span class="p">;</span>

	<span class="cm">/* set P320F */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P320F</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_320f</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">mib_index</span> <span class="o">=</span> <span class="n">SBAPATHINDEX</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">.</span><span class="n">mib_payload</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span> <span class="p">;</span>

	<span class="cm">/* set P3210 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">overhead</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P3210</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">overhead</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_3210</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">overhead</span><span class="p">.</span><span class="n">mib_index</span> <span class="o">=</span> <span class="n">SBAPATHINDEX</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">overhead</span><span class="p">.</span><span class="n">mib_overhead</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaOverhead</span> <span class="p">;</span>

	<span class="cm">/* set P19 */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_addr</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P0019</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_addr</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0019</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_addr</span><span class="p">.</span><span class="n">sba_pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">a_addr</span><span class="p">.</span><span class="n">alloc_addr</span> <span class="o">=</span> <span class="n">null_addr</span> <span class="p">;</span>

	<span class="cm">/* set P1A */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P001A</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_001a</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">cat</span><span class="p">.</span><span class="n">category</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSCategory</span> <span class="p">;</span>

	<span class="cm">/* set P1B */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tneg</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P001B</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tneg</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_001b</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">tneg</span><span class="p">.</span><span class="n">max_t_neg</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSMaxTNeg</span> <span class="p">;</span>

	<span class="cm">/* set P1C */</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">segm</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P001C</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">segm</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_001c</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">segm</span><span class="p">.</span><span class="n">min_seg_siz</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSMinSegmentSize</span> <span class="p">;</span>

	<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span><span class="n">req</span><span class="p">,</span><span class="s">&quot;RAF&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">ess_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_send_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * check if the frame must be send to the own ESS</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">local_sba_active</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send the Change Reply to the local SBA</span>
<span class="cm">		 */</span>
		<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS:Send to the local SBA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sba_reply_pend</span><span class="p">)</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">ess</span><span class="p">.</span><span class="n">sba_reply_pend</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;Frame is lost - another frame was pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Send the SBA RAF Change Reply to the network</span>
<span class="cm">		 */</span>
		<span class="n">DB_ESS</span><span class="p">(</span><span class="s">&quot;ESS:Send to the network</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">FC_SMT_INFO</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ess_para_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">process_bw_alloc</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">long</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaOverhead</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ess_config_fifo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * if nothing to do exit </span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_config_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_TRAFFIC_ON</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_config_mode</span><span class="o">&amp;</span><span class="n">SEND_ASYNC_AS_SYNC</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiESSSynchTxMode</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">fifo</span><span class="p">.</span><span class="n">fifo_config_mode</span> <span class="o">&amp;</span> <span class="n">SYNC_TRAFFIC_ON</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * split up the FIFO and reinitialize the queues</span>
<span class="cm">	 */</span>
	<span class="n">formac_reinit_tx</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* ESS */</span><span class="cp"></span>

<span class="cp">#endif	</span><span class="cm">/* no SLIM_SMT */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
