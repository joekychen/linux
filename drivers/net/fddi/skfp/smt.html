<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › fddi › skfp › smt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>smt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *	(C)Copyright 1998,1999 SysKonnect,</span>
<span class="cm"> *	a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.</span>
<span class="cm"> *</span>
<span class="cm"> *	See the file &quot;skfddi.c&quot; for further information.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	The information in this file is provided &quot;AS IS&quot; without warranty.</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#include &quot;h/types.h&quot;</span>
<span class="cp">#include &quot;h/fddi.h&quot;</span>
<span class="cp">#include &quot;h/smc.h&quot;</span>
<span class="cp">#include &quot;h/smt_p.h&quot;</span>
<span class="cp">#include &lt;linux/bitrev.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#define KERNEL</span>
<span class="cp">#include &quot;h/smtstate.h&quot;</span>

<span class="cp">#ifndef	lint</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ID_sccs</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;@(#)smt.c	2.43 98/11/23 (C) SK &quot;</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * FC in SMbuf</span>
<span class="cm"> */</span>
<span class="cp">#define m_fc(mb)	((mb)-&gt;sm_data[0])</span>

<span class="cp">#define SMT_TID_MAGIC	0x1f0a7b3c</span>

<span class="cp">#ifdef	DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">smt_type_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;SMT_00??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_INFO&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_02??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_03??&quot;</span><span class="p">,</span>
	<span class="s">&quot;SMT_04??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_05??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_06??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_07??&quot;</span><span class="p">,</span>
	<span class="s">&quot;SMT_08??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_09??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_0A??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_0B??&quot;</span><span class="p">,</span>
	<span class="s">&quot;SMT_0C??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_0D??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_0E??&quot;</span><span class="p">,</span> <span class="s">&quot;SMT_NSA&quot;</span>
<span class="p">}</span> <span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">smt_class_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;UNKNOWN&quot;</span><span class="p">,</span><span class="s">&quot;NIF&quot;</span><span class="p">,</span><span class="s">&quot;SIF_CONFIG&quot;</span><span class="p">,</span><span class="s">&quot;SIF_OPER&quot;</span><span class="p">,</span><span class="s">&quot;ECF&quot;</span><span class="p">,</span><span class="s">&quot;RAF&quot;</span><span class="p">,</span><span class="s">&quot;RDF&quot;</span><span class="p">,</span>
	<span class="s">&quot;SRF&quot;</span><span class="p">,</span><span class="s">&quot;PMF_GET&quot;</span><span class="p">,</span><span class="s">&quot;PMF_SET&quot;</span><span class="p">,</span><span class="s">&quot;ESF&quot;</span>
<span class="p">}</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#define LAST_CLASS	(SMT_PMF_SET)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="n">SMT_Unknown</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x1f</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">}</span>
<span class="p">}</span> <span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * function prototypes</span>
<span class="cm"> */</span>
<span class="cp">#ifdef	LITTLE_ENDIAN</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">smt_swap_short</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mac_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">phy_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">mac_con_resource_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">phy_con_resource_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_send_rdf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">rej</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_send_nif</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> 
			 <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_send_ecf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span>
                         <span class="n">u_long</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_echo_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dna</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_send_sif_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				<span class="n">u_long</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_send_sif_operation</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				   <span class="n">u_long</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">);</span>
<span class="cp">#ifdef LITTLE_ENDIAN</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_string_swap</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_add_frame_len</span><span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_una</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_una</span> <span class="o">*</span><span class="n">una</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_sde</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_sde</span> <span class="o">*</span><span class="n">sde</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_timestamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_timestamp</span> <span class="o">*</span><span class="n">ts</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_latency</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_latency</span> <span class="o">*</span><span class="n">latency</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_neighbor</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_neighbor</span> <span class="o">*</span><span class="n">neighbor</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">smt_fill_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_path</span> <span class="o">*</span><span class="n">path</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_mac_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_mac_status</span> <span class="o">*</span><span class="n">st</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_lem</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_lem</span> <span class="o">*</span><span class="n">lem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_version</span> <span class="o">*</span><span class="n">vers</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_fsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_fsc</span> <span class="o">*</span><span class="n">fsc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_mac_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_mac_counter</span> <span class="o">*</span><span class="n">mc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_mac_fnc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_mac_fnc</span> <span class="o">*</span><span class="n">fnc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_manufacturer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> 
				  <span class="k">struct</span> <span class="n">smp_p_manufacturer</span> <span class="o">*</span><span class="n">man</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smp_p_user</span> <span class="o">*</span><span class="n">user</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_setcount</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_setcount</span> <span class="o">*</span><span class="n">setcount</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_fill_echo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_echo</span> <span class="o">*</span><span class="n">echo</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">seed</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_clear_una_dna</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_clear_old_una_dna</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">entity_to_index</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">report</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">div_ratio</span><span class="p">(</span><span class="n">u_long</span> <span class="n">upper</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">lower</span><span class="p">);</span>
<span class="cp">#ifdef  USE_CAN_ADDR</span>
<span class="k">static</span> <span class="kt">void</span>	<span class="n">hwm_conv_can</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define		hwm_conv_can(smc,data,len)</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_my_addr</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> 
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACSMTAddress</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
	  <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACSMTAddress</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
	  <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">==</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACSMTAddress</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_broadcast</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span>
	       <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span>
	       <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_individual</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">GROUP_ADDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_equal</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">addr1</span><span class="p">,</span> 
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">addr2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr2</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
	       <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr2</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
	       <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr1</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="n">u_short</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">addr2</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * list of mandatory paras in frames</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u_short</span> <span class="n">plist_nif</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SMT_P_UNA</span><span class="p">,</span><span class="n">SMT_P_SDE</span><span class="p">,</span><span class="n">SMT_P_STATE</span><span class="p">,</span><span class="mi">0</span> <span class="p">}</span> <span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * init SMT agent</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">smt_agent_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get MAC address</span>
<span class="cm">	 */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACSMTAddress</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fddi_home_addr</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * get OUI address from driver (bia == built-in-address)</span>
<span class="cm">	 */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span><span class="p">.</span><span class="n">sid_oem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span><span class="p">.</span><span class="n">sid_oem</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">driver_get_bia</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span><span class="p">.</span><span class="n">sid_node</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span><span class="p">.</span><span class="n">sid_node</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">bitrev8</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span><span class="p">.</span><span class="n">sid_node</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTManufacturerData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span><span class="p">.</span><span class="n">sid_node</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTManufacturerData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span><span class="p">.</span><span class="n">sid_node</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTManufacturerData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span><span class="p">.</span><span class="n">sid_node</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDupAddressTest</span> <span class="o">=</span> <span class="n">DA_NONE</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUNDA_Flag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
<span class="cp">#ifndef	SLIM_SMT</span>
	<span class="n">smt_clear_una_dna</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_clear_old_una_dna</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SMT_MAX_TEST</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">please_reconnect</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">uniq_ticks</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SMT task</span>
<span class="cm"> * forever</span>
<span class="cm"> *	delay 30 seconds</span>
<span class="cm"> *	send NIF</span>
<span class="cm"> *	check tvu &amp; tvd</span>
<span class="cm"> * end</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">smt_agent_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smt_timer_start</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_timer</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="mi">1000000L</span><span class="p">,</span>
		<span class="n">EV_TOKEN</span><span class="p">(</span><span class="n">EVENT_SMT</span><span class="p">,</span><span class="n">SM_TIMER</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT agent task</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef SMT_REAL_TOKEN_CT</span>
<span class="kt">void</span> <span class="nf">smt_emulate_token_ct</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">count</span><span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">time</span><span class="p">;</span>


	<span class="n">time</span> <span class="o">=</span> <span class="n">smt_get_time</span><span class="p">();</span>
	<span class="n">count</span> <span class="o">=</span>	<span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">last_tok_time</span><span class="p">[</span><span class="n">mac_index</span><span class="p">])</span> <span class="o">*</span>
					<span class="mi">100</span><span class="p">)</span><span class="o">/</span><span class="n">TICKS_PER_SECOND</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Only when ring is up we will have a token count. The</span>
<span class="cm">	 * flag is unfortunately a single instance value. This</span>
<span class="cm">	 * doesn&#39;t matter now, because we currently have only</span>
<span class="cm">	 * one MAC instance.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ring_is_up</span><span class="p">){</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">mac_index</span><span class="p">].</span><span class="n">fddiMACToken_Ct</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Remember current time */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">last_tok_time</span><span class="p">[</span><span class="n">mac_index</span><span class="p">]</span> <span class="o">=</span> <span class="n">time</span><span class="p">;</span>

<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*ARGSUSED1*/</span>
<span class="kt">void</span> <span class="nf">smt_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>		<span class="n">time</span> <span class="p">;</span>
<span class="cp">#ifndef SMT_REAL_TOKEN_CT</span>
	<span class="kt">int</span>		<span class="n">i</span> <span class="p">;</span>
<span class="cp">#endif</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">please_reconnect</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">please_reconnect</span> <span class="o">--</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">please_reconnect</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Counted down */</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_ECM</span><span class="p">,</span><span class="n">EC_CONNECT</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">event</span> <span class="o">==</span> <span class="n">SM_FAST</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * timer for periodic cleanup in driver</span>
<span class="cm">	 * reset and start the watchdog (FM2)</span>
<span class="cm">	 * ESS timer</span>
<span class="cm">	 * SBA timer</span>
<span class="cm">	 */</span>
	<span class="n">smt_timer_poll</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_start_watchdog</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifndef	SLIM_SMT</span>
<span class="cp">#ifndef BOOT</span>
<span class="cp">#ifdef	ESS</span>
	<span class="n">ess_timer_poll</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	SBA</span>
	<span class="n">sba_timer_poll</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

<span class="cp">#endif	</span><span class="cm">/* no SLIM_SMT */</span><span class="cp"></span>

	<span class="n">time</span> <span class="o">=</span> <span class="n">smt_get_time</span><span class="p">()</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_last_lem</span> <span class="o">&gt;=</span> <span class="n">TICKS_PER_SECOND</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Use 8 sec. for the time intervall, it simplifies the</span>
<span class="cm">		 * LER estimation.</span>
<span class="cm">		 */</span>
		<span class="k">struct</span> <span class="n">fddi_mib_m</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>
		<span class="n">u_long</span>			<span class="n">upper</span> <span class="p">;</span>
		<span class="n">u_long</span>			<span class="n">lower</span> <span class="p">;</span>
		<span class="kt">int</span>			<span class="n">cond</span> <span class="p">;</span>
		<span class="kt">int</span>			<span class="n">port</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">s_phy</span>		<span class="o">*</span><span class="n">phy</span> <span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * calculate LEM bit error rate</span>
<span class="cm">		 */</span>
		<span class="n">sm_lem_evaluate</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_last_lem</span> <span class="o">=</span> <span class="n">time</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * check conditions</span>
<span class="cm">		 */</span>
<span class="cp">#ifndef	SLIM_SMT</span>
		<span class="n">mac_update_counter</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">mib</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span> <span class="p">;</span>
		<span class="n">upper</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACLost_Ct</span> <span class="o">-</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Lost_Ct</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACError_Ct</span> <span class="o">-</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Error_Ct</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">lower</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACFrame_Ct</span> <span class="o">-</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Frame_Ct</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACLost_Ct</span> <span class="o">-</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Lost_Ct</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACFrameErrorRatio</span> <span class="o">=</span> <span class="n">div_ratio</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span><span class="n">lower</span><span class="p">)</span> <span class="p">;</span>

		<span class="n">cond</span> <span class="o">=</span>
			<span class="p">((</span><span class="o">!</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACFrameErrorThreshold</span> <span class="o">&amp;&amp;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACError_Ct</span> <span class="o">!=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Error_Ct</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACFrameErrorRatio</span> <span class="o">&gt;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACFrameErrorThreshold</span><span class="p">))</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACFrameErrorFlag</span><span class="p">)</span>
			<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_COND_MAC_FRAME_ERROR</span><span class="p">,</span>
				<span class="n">INDEX_MAC</span><span class="p">,</span><span class="n">cond</span><span class="p">)</span> <span class="p">;</span>

		<span class="n">upper</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACNotCopied_Ct</span> <span class="o">-</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_NotCopied_Ct</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">lower</span> <span class="o">=</span>
		<span class="n">upper</span> <span class="o">+</span>
		<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACCopied_Ct</span> <span class="o">-</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Copied_Ct</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACNotCopiedRatio</span> <span class="o">=</span> <span class="n">div_ratio</span><span class="p">(</span><span class="n">upper</span><span class="p">,</span><span class="n">lower</span><span class="p">)</span> <span class="p">;</span>

		<span class="n">cond</span> <span class="o">=</span>
			<span class="p">((</span><span class="o">!</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACNotCopiedThreshold</span> <span class="o">&amp;&amp;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACNotCopied_Ct</span> <span class="o">!=</span>
				<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_NotCopied_Ct</span><span class="p">)</span><span class="o">||</span>
			<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACNotCopiedRatio</span> <span class="o">&gt;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACNotCopiedThreshold</span><span class="p">))</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACNotCopiedFlag</span><span class="p">)</span>
			<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_COND_MAC_NOT_COPIED</span><span class="p">,</span>
				<span class="n">INDEX_MAC</span><span class="p">,</span><span class="n">cond</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * set old values</span>
<span class="cm">		 */</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Frame_Ct</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACFrame_Ct</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Copied_Ct</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACCopied_Ct</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Error_Ct</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACError_Ct</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_Lost_Ct</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACLost_Ct</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACOld_NotCopied_Ct</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiMACNotCopied_Ct</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check port EBError Condition</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span> <span class="n">NUMPHYS</span><span class="p">;</span> <span class="n">port</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">port</span><span class="p">]</span> <span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTHardwarePresent</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTEBError_Ct</span> <span class="o">-</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTOldEBError_Ct</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

			<span class="cm">/* If ratio is more than 5 in 8 seconds</span>
<span class="cm">			 * Set the condition.</span>
<span class="cm">			 */</span>
			<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_COND_PORT_EB_ERROR</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">INDEX_PORT</span><span class="o">+</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">)</span> <span class="p">,</span><span class="n">cond</span><span class="p">)</span> <span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * set old values</span>
<span class="cm">			 */</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTOldEBError_Ct</span> <span class="o">=</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTEBError_Ct</span> <span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* no SLIM_SMT */</span><span class="cp"></span>
	<span class="p">}</span>

<span class="cp">#ifndef	SLIM_SMT</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_last_notify</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span>
		<span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTTT_Notify</span> <span class="o">*</span> <span class="n">TICKS_PER_SECOND</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * we can either send an announcement or a request</span>
<span class="cm">		 * a request will trigger a reply so that we can update</span>
<span class="cm">		 * our dna</span>
<span class="cm">		 * note: same tid must be used until reply is received</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF</span><span class="p">])</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF</span><span class="p">]</span> <span class="o">=</span> <span class="n">smt_get_tid</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_send_nif</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fddi_broadcast</span><span class="p">,</span> <span class="n">FC_SMT_NSA</span><span class="p">,</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF</span><span class="p">],</span> <span class="n">SMT_REQUEST</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_last_notify</span> <span class="o">=</span> <span class="n">time</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * check timer</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tvu</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time</span> <span class="o">-</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tvu</span> <span class="o">&gt;</span> <span class="mi">228</span><span class="o">*</span><span class="n">TICKS_PER_SECOND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : UNA expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tvu</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">SMT_Unknown</span><span class="p">)){</span>
			<span class="cm">/* Do not update unknown address */</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACOldUpstreamNbr</span><span class="o">=</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span> <span class="o">=</span> <span class="n">SMT_Unknown</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUNDA_Flag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure the fddiMACUNDA_Flag = FALSE is</span>
<span class="cm">		 * included in the SRF so we don&#39;t generate</span>
<span class="cm">		 * a separate SRF for the deassertion of this</span>
<span class="cm">		 * condition</span>
<span class="cm">		 */</span>
		<span class="n">update_dac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMT_EVENT_MAC_NEIGHBOR_CHANGE</span><span class="p">,</span>
			<span class="n">INDEX_MAC</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tvd</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time</span> <span class="o">-</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tvd</span> <span class="o">&gt;</span> <span class="mi">228</span><span class="o">*</span><span class="n">TICKS_PER_SECOND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : DNA expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tvd</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">SMT_Unknown</span><span class="p">)){</span>
			<span class="cm">/* Do not update unknown address */</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACOldDownstreamNbr</span><span class="o">=</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span> <span class="o">=</span> <span class="n">SMT_Unknown</span> <span class="p">;</span>
		<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMT_EVENT_MAC_NEIGHBOR_CHANGE</span><span class="p">,</span>
			<span class="n">INDEX_MAC</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* no SLIM_SMT */</span><span class="cp"></span>

<span class="cp">#ifndef SMT_REAL_TOKEN_CT</span>
	<span class="cm">/*</span>
<span class="cm">	 * Token counter emulation section. If hardware supports the token</span>
<span class="cm">	 * count, the token counter will be updated in mac_update_counter.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">MAC0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMMACS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">){</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time</span> <span class="o">-</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">last_tok_time</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">*</span><span class="n">TICKS_PER_SECOND</span> <span class="p">){</span>
			<span class="n">smt_emulate_token_ct</span><span class="p">(</span> <span class="n">smc</span><span class="p">,</span> <span class="n">i</span> <span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">smt_timer_start</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_timer</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span><span class="mi">1000000L</span><span class="p">,</span>
		<span class="n">EV_TOKEN</span><span class="p">(</span><span class="n">EVENT_SMT</span><span class="p">,</span><span class="n">SM_TIMER</span><span class="p">))</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">div_ratio</span><span class="p">(</span><span class="n">u_long</span> <span class="n">upper</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">lower</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">upper</span><span class="o">&lt;&lt;</span><span class="mi">16L</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">upper</span><span class="p">)</span>
		<span class="n">upper</span> <span class="o">=</span> <span class="mh">0xffff0000L</span> <span class="p">;</span>
	<span class="k">else</span>
		<span class="n">upper</span> <span class="o">&lt;&lt;=</span> <span class="mi">16L</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lower</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">upper</span><span class="o">/</span><span class="n">lower</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef	SLIM_SMT</span>

<span class="cm">/*</span>
<span class="cm"> * receive packet handler</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">smt_received_pack</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fs</span><span class="p">)</span>
<span class="cm">/* int fs;  frame status */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_header</span>	<span class="o">*</span><span class="n">sm</span> <span class="p">;</span>
	<span class="kt">int</span>			<span class="n">local</span> <span class="p">;</span>

	<span class="kt">int</span>			<span class="n">illegal</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FC_SMT_INFO</span> :
	<span class="k">case</span> <span class="n">FC_SMT_LAN_LOC</span> :
	<span class="k">case</span> <span class="n">FC_SMT_LOC</span> :
	<span class="k">case</span> <span class="n">FC_SMT_NSA</span> :
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">default</span> <span class="o">:</span>
		<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACSMTCopied_Ct</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">sm</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">local</span> <span class="o">=</span> <span class="p">((</span><span class="n">fs</span> <span class="o">&amp;</span> <span class="n">L_INDICATOR</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">hwm_conv_can</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sm</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* check destination address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_individual</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_dest</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_my_addr</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_dest</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if	0</span><span class="c">		/* for DUP recognition, do NOT filter them */</span>
<span class="c">	/* ignore loop back packets */</span>
<span class="c">	if (is_my_addr(smc,&amp;sm-&gt;smt_source) &amp;&amp; !local) {</span>
<span class="c">		smt_free_mbuf(smc,mb) ;</span>
<span class="c">		return ;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">smt_swap_para</span><span class="p">(</span><span class="n">sm</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : received packet [%s] at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">smt_type_name</span><span class="p">[</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">],</span><span class="n">sm</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : version %d, class %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_version</span><span class="p">,</span>
		<span class="n">smt_class_name</span><span class="p">[(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span><span class="o">&gt;</span><span class="n">LAST_CLASS</span><span class="p">)</span><span class="o">?</span><span class="mi">0</span> <span class="o">:</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span><span class="p">])</span> <span class="p">;</span>

<span class="cp">#ifdef	SBA</span>
	<span class="cm">/*</span>
<span class="cm">	 * check if NSA frame</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_SMT_NSA</span> <span class="o">&amp;&amp;</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span> <span class="o">==</span> <span class="n">SMT_NIF</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">==</span> <span class="n">SMT_ANNOUNCE</span> <span class="o">||</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">==</span> <span class="n">SMT_REQUEST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sba</span><span class="p">.</span><span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span> <span class="p">;</span>
			<span class="n">sba</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">NIF</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * ignore any packet with NSA and A-indicator set</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">fs</span> <span class="o">&amp;</span> <span class="n">A_INDICATOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_SMT_NSA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : ignoring NSA with A-indicator set from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * ignore frames with illegal length</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span> <span class="o">==</span> <span class="n">SMT_ECF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_len</span> <span class="o">&gt;</span> <span class="n">SMT_MAX_ECHO_LEN</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span> <span class="o">!=</span> <span class="n">SMT_ECF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_len</span> <span class="o">&gt;</span> <span class="n">SMT_MAX_INFO_LEN</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * check SMT version</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMT_NIF</span> :
	<span class="k">case</span> <span class="n">SMT_SIF_CONFIG</span> :
	<span class="k">case</span> <span class="n">SMT_SIF_OPER</span> :
	<span class="k">case</span> <span class="n">SMT_ECF</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_version</span> <span class="o">!=</span> <span class="n">SMT_VID</span><span class="p">)</span>
			<span class="n">illegal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">default</span> <span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_version</span> <span class="o">!=</span> <span class="n">SMT_VID_2</span><span class="p">)</span>
			<span class="n">illegal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">illegal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : version = %d, dest = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_version</span><span class="p">,</span><span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">smt_send_rdf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">),</span><span class="n">SMT_RDF_VERSION</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_len</span> <span class="o">&gt;</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_len</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span> <span class="o">!=</span> <span class="n">SMT_ECF</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: info length error, len = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_len</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_send_rdf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">),</span><span class="n">SMT_RDF_LENGTH</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMT_NIF</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">smt_check_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">plist_nif</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: NIF with para problem, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SMT_ANNOUNCE</span> :
		<span class="k">case</span> <span class="n">SMT_REQUEST</span> :
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fs</span> <span class="o">&amp;</span> <span class="n">C_INDICATOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_SMT_NSA</span>
				<span class="o">&amp;&amp;</span> <span class="n">is_broadcast</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_dest</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">smt_p_state</span>	<span class="o">*</span><span class="n">st</span> <span class="p">;</span>

				<span class="cm">/* set my UNA */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_equal</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : updated my UNA = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span>
					    <span class="n">fddiMACUpstreamNbr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">SMT_Unknown</span><span class="p">)){</span>
					 <span class="cm">/* Do not update unknown address */</span>
					 <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACOldUpstreamNbr</span><span class="o">=</span>
					 <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span> <span class="p">;</span>
					<span class="p">}</span>

					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span> <span class="o">=</span>
						<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span> <span class="p">;</span>
					<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span>
						<span class="n">SMT_EVENT_MAC_NEIGHBOR_CHANGE</span><span class="p">,</span>
						<span class="n">INDEX_MAC</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">smt_echo_test</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
				<span class="p">}</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tvu</span> <span class="o">=</span> <span class="n">smt_get_time</span><span class="p">()</span> <span class="p">;</span>
				<span class="n">st</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_state</span> <span class="o">*</span><span class="p">)</span>
					<span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P_STATE</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUNDA_Flag</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">st_dupl_addr</span> <span class="o">&amp;</span> <span class="n">SMT_ST_MY_DUPA</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span> <span class="p">;</span>
					<span class="n">update_dac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">==</span> <span class="n">SMT_REQUEST</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">is_individual</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">fs</span> <span class="o">&amp;</span> <span class="n">A_INDICATOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_SMT_NSA</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FC_SMT_NSA</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : replying to NIF request %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smt_send_nif</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">,</span>
					<span class="n">FC_SMT_INFO</span><span class="p">,</span>
					<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span><span class="p">,</span>
					<span class="n">SMT_REPLY</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_REPLY</span> :
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : received NIF response from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fs</span> <span class="o">&amp;</span> <span class="n">A_INDICATOR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : duplicate address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDupAddressTest</span> <span class="o">=</span>
					<span class="n">DA_FAILED</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">dup_addr_test</span> <span class="o">=</span> <span class="n">DA_FAILED</span> <span class="p">;</span>
				<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_DUP_ADDR</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDA_Flag</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
				<span class="n">update_dac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">break</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="o">==</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
				<span class="cm">/* set my DNA */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_equal</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : updated my DNA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_equal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span>
					 <span class="n">fddiMACDownstreamNbr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SMT_Unknown</span><span class="p">)){</span>
					 <span class="cm">/* Do not update unknown address */</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACOldDownstreamNbr</span> <span class="o">=</span>
					 <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span> <span class="p">;</span>
					<span class="p">}</span>

					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span> <span class="o">=</span>
						<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span> <span class="p">;</span>
					<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span>
						<span class="n">SMT_EVENT_MAC_NEIGHBOR_CHANGE</span><span class="p">,</span>
						<span class="n">INDEX_MAC</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">smt_echo_test</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
				<span class="p">}</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDA_Flag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
				<span class="n">update_dac</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tvd</span> <span class="o">=</span> <span class="n">smt_get_time</span><span class="p">()</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDupAddressTest</span> <span class="o">=</span>
					<span class="n">DA_PASSED</span> <span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">dup_addr_test</span> <span class="o">!=</span> <span class="n">DA_PASSED</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">dup_addr_test</span> <span class="o">=</span> <span class="n">DA_PASSED</span> <span class="p">;</span>
					<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_RMT</span><span class="p">,</span><span class="n">RM_DUP_ADDR</span><span class="p">)</span> <span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="o">==</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF_TEST</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : NIF test TID ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : expected TID %lx, got %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF</span><span class="p">],</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">default</span> <span class="o">:</span>
			<span class="n">illegal</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SMT_SIF_CONFIG</span> :	<span class="cm">/* station information */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">!=</span> <span class="n">SMT_REQUEST</span><span class="p">)</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : replying to SIF Config request from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_send_sif_config</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SMT_SIF_OPER</span> :	<span class="cm">/* station information */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">!=</span> <span class="n">SMT_REQUEST</span><span class="p">)</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : replying to SIF Operation request from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smt_send_sif_operation</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">,</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SMT_ECF</span> :		<span class="cm">/* echo frame */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SMT_REPLY</span> :
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">fddiPRIVECF_Reply_Rx</span><span class="o">++</span> <span class="p">;</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: received ECF reply from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P_ECHODATA</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: ECHODATA missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">break</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="o">==</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_ECF</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : ECF test TID ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="o">==</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_ECF_UNA</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : ECF test UNA ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="o">==</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_ECF_DNA</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : ECF test DNA ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : expected TID %lx, got %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_ECF</span><span class="p">],</span>
					<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_REQUEST</span> :
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">fddiPRIVECF_Req_Rx</span><span class="o">++</span> <span class="p">;</span>
			<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_len</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">SMT_P_ECHODATA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: ECF with para problem,sending RDF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smt_send_rdf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">),</span><span class="n">SMT_RDF_LENGTH</span><span class="p">,</span>
					<span class="n">local</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">break</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT - sending ECF reply to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

			<span class="cm">/* set destination addr.  &amp; reply */</span>
			<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span> <span class="p">;</span>
			<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">=</span> <span class="n">SMT_REPLY</span> <span class="p">;</span>
			<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="s">&quot;ECF REPLY&quot;</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">fddiPRIVECF_Reply_Tx</span><span class="o">++</span> <span class="p">;</span>
			<span class="n">smt_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">FC_SMT_INFO</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="p">;</span>		<span class="cm">/* DON&#39;T free mbuf */</span>
			<span class="p">}</span>
		<span class="k">default</span> <span class="o">:</span>
			<span class="n">illegal</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
<span class="cp">#ifndef	BOOT</span>
	<span class="k">case</span> <span class="n">SMT_RAF</span> :		<span class="cm">/* resource allocation */</span>
<span class="cp">#ifdef	ESS</span>
		<span class="n">DB_ESSN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;ESS: RAF frame received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">fs</span> <span class="o">=</span> <span class="n">ess_raf_received_pack</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	SBA</span>
		<span class="n">DB_SBAN</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s">&quot;SBA: RAF frame received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">sba_raf_received_pack</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">fs</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SMT_RDF</span> :		<span class="cm">/* request denied */</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">fddiPRIVRDF_Rx</span><span class="o">++</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SMT_ESF</span> :		<span class="cm">/* extended service - not supported */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">==</span> <span class="n">SMT_REQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT - received ESF, sending RDF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smt_send_rdf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">),</span><span class="n">SMT_RDF_CLASS</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SMT_PMF_GET</span> :
	<span class="k">case</span> <span class="n">SMT_PMF_SET</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">!=</span> <span class="n">SMT_REQUEST</span><span class="p">)</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="cm">/* update statistics */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span> <span class="o">==</span> <span class="n">SMT_PMF_GET</span><span class="p">)</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">fddiPRIVPMF_Get_Rx</span><span class="o">++</span> <span class="p">;</span>
		<span class="k">else</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">fddiPRIVPMF_Set_Rx</span><span class="o">++</span> <span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * ignore PMF SET with I/G set</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span> <span class="o">==</span> <span class="n">SMT_PMF_SET</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">is_individual</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_dest</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: ignoring PMF-SET with I/G set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">smt_pmf_received_pack</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span> <span class="n">local</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SMT_SRF</span> :
		<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="s">&quot;SRF received&quot;</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">default</span> <span class="o">:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">!=</span> <span class="n">SMT_REQUEST</span><span class="p">)</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * For frames with unknown class:</span>
<span class="cm">		 * we need to send a RDF frame according to 8.1.3.1.1,</span>
<span class="cm">		 * only if it is a REQUEST.</span>
<span class="cm">		 */</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : class = %d, send RDF to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_class</span><span class="p">,</span> <span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">))</span> <span class="p">;</span>

		<span class="n">smt_send_rdf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">m_fc</span><span class="p">(</span><span class="n">mb</span><span class="p">),</span><span class="n">SMT_RDF_CLASS</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">illegal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: discarding invalid frame, reason = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">illegal</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_dac</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">report</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">cond</span> <span class="p">;</span>

	<span class="n">cond</span> <span class="o">=</span> <span class="p">(</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUNDA_Flag</span> <span class="o">|</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDA_Flag</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDuplicateAddressCond</span><span class="p">))</span>
		<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMT_COND_MAC_DUP_ADDR</span><span class="p">,</span><span class="n">INDEX_MAC</span><span class="p">,</span><span class="n">cond</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">else</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDuplicateAddressCond</span> <span class="o">=</span> <span class="n">cond</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send SMT frame</span>
<span class="cm"> *	set source address</span>
<span class="cm"> *	set station ID</span>
<span class="cm"> *	send frame</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">smt_send_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">)</span>
<span class="cm">/* SMbuf *mb;	buffer to send */</span>
<span class="cm">/* int fc;	FC value */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_header</span>	<span class="o">*</span><span class="n">sm</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">sm_ma_avail</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sm</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACSMTAddress</span> <span class="p">;</span>
	<span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_sid</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTStationId</span> <span class="p">;</span>

	<span class="n">smt_swap_para</span><span class="p">(</span><span class="n">sm</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* swap para &amp; header */</span>
	<span class="n">hwm_conv_can</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sm</span><span class="p">,</span><span class="mi">12</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* convert SA and DA */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACSMTTransmit_Ct</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">smt_send_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">local</span> <span class="o">?</span> <span class="n">FC_SMT_LOC</span> <span class="o">:</span> <span class="n">fc</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generate and send RDF</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_send_rdf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">rej</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reason</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">local</span><span class="p">)</span>
<span class="cm">/* SMbuf *rej;	mbuf of offending frame */</span>
<span class="cm">/* int fc;	FC of denied frame */</span>
<span class="cm">/* int reason;	reason code */</span>
<span class="p">{</span>
	<span class="n">SMbuf</span>	<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">smt_header</span>	<span class="o">*</span><span class="n">sm</span> <span class="p">;</span>	<span class="cm">/* header of offending frame */</span>
	<span class="k">struct</span> <span class="n">smt_rdf</span>	<span class="o">*</span><span class="n">rdf</span> <span class="p">;</span>
	<span class="kt">int</span>		<span class="n">len</span> <span class="p">;</span>
	<span class="kt">int</span>		<span class="n">frame_len</span> <span class="p">;</span>

	<span class="n">sm</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">rej</span><span class="p">,</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">!=</span> <span class="n">SMT_REQUEST</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: sending RDF to %s,reason = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">addr_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span><span class="p">),</span><span class="n">reason</span><span class="p">)</span> <span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * note: get framelength from MAC length, NOT from SMT header</span>
<span class="cm">	 * smt header length is included in sm_len</span>
<span class="cm">	 */</span>
	<span class="n">frame_len</span> <span class="o">=</span> <span class="n">rej</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span><span class="o">=</span><span class="n">smt_build_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_RDF</span><span class="p">,</span><span class="n">SMT_REPLY</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_rdf</span><span class="p">))))</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="n">rdf</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="k">struct</span> <span class="n">smt_rdf</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="p">;</span>		<span class="cm">/* use TID from sm */</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_source</span> <span class="p">;</span>		<span class="cm">/* set dest = source */</span>

	<span class="cm">/* set P12 */</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P_REASON</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_reason</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">.</span><span class="n">rdf_reason</span> <span class="o">=</span> <span class="n">reason</span> <span class="p">;</span>

	<span class="cm">/* set P14 */</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P_VERSION</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_version</span><span class="p">)</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">v_pad</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">v_n</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">v_index</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">v_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMT_VID_2</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">v_pad2</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="cm">/* set P13 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span> <span class="n">frame_len</span> <span class="o">&lt;=</span> <span class="n">SMT_MAX_INFO_LEN</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdf</span><span class="p">)</span> <span class="o">+</span>
		<span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span><span class="p">))</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">frame_len</span> <span class="p">;</span>
	<span class="k">else</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">SMT_MAX_INFO_LEN</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rdf</span><span class="p">)</span> <span class="o">+</span>
			<span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/* make length multiple of 4 */</span>
	<span class="n">len</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">refused</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P_REFUSED</span> <span class="p">;</span>
	<span class="cm">/* length of para is smt_frame + ref_fc */</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">refused</span><span class="p">.</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">4</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">refused</span><span class="p">.</span><span class="n">ref_fc</span> <span class="o">=</span> <span class="n">fc</span> <span class="p">;</span>

	<span class="cm">/* swap it back */</span>
	<span class="n">smt_swap_para</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span><span class="n">frame_len</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rdf</span><span class="o">-&gt;</span><span class="n">refused</span><span class="p">.</span><span class="n">ref_header</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">sm</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="o">+=</span> <span class="n">len</span> <span class="p">;</span>
	<span class="n">rdf</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_len</span> <span class="o">+=</span> <span class="n">len</span> <span class="p">;</span>

	<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span><span class="n">rdf</span><span class="p">,</span><span class="s">&quot;RDF&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">fddiPRIVRDF_Tx</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">smt_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">FC_SMT_INFO</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generate and send NIF</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_send_nif</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> 
			 <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">)</span>
<span class="cm">/* struct fddi_addr *dest;	dest address */</span>
<span class="cm">/* int fc;			frame control */</span>
<span class="cm">/* u_long tid;			transaction id */</span>
<span class="cm">/* int type;			frame type */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_nif</span>	<span class="o">*</span><span class="n">nif</span> <span class="p">;</span>
	<span class="n">SMbuf</span>		<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span> <span class="o">=</span> <span class="n">smt_build_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_NIF</span><span class="p">,</span><span class="n">type</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_nif</span><span class="p">))))</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="n">nif</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_nif</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_fill_una</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nif</span><span class="o">-&gt;</span><span class="n">una</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set UNA */</span>
	<span class="n">smt_fill_sde</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nif</span><span class="o">-&gt;</span><span class="n">sde</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set station descriptor */</span>
	<span class="n">smt_fill_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nif</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set state information */</span>
<span class="cp">#ifdef	SMT6_10</span>
	<span class="n">smt_fill_fsc</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">nif</span><span class="o">-&gt;</span><span class="n">fsc</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set frame status cap. */</span>
<span class="cp">#endif</span>
	<span class="n">nif</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="o">*</span><span class="n">dest</span> <span class="p">;</span>	<span class="cm">/* destination address */</span>
	<span class="n">nif</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="n">tid</span> <span class="p">;</span>	<span class="cm">/* transaction ID */</span>
	<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span><span class="n">nif</span><span class="p">,</span><span class="s">&quot;NIF&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * send NIF request (test purpose)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_send_nif_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF_TEST</span><span class="p">]</span> <span class="o">=</span> <span class="n">smt_get_tid</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_send_nif</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span> <span class="n">FC_SMT_INFO</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_NIF_TEST</span><span class="p">],</span>
		<span class="n">SMT_REQUEST</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * send ECF request (test purpose)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_send_ecf_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_ECF</span><span class="p">]</span> <span class="o">=</span> <span class="n">smt_get_tid</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_send_ecf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">dest</span><span class="p">,</span> <span class="n">FC_SMT_INFO</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">SMT_TID_ECF</span><span class="p">],</span>
		<span class="n">SMT_REQUEST</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * echo test</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_echo_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">tid</span> <span class="p">;</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">pend</span><span class="p">[</span><span class="n">dna</span> <span class="o">?</span> <span class="n">SMT_TID_ECF_DNA</span> <span class="o">:</span> <span class="n">SMT_TID_ECF_UNA</span><span class="p">]</span> <span class="o">=</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">smt_get_tid</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_send_ecf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">dna</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span> <span class="o">:</span>
		<span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span><span class="p">,</span>
		<span class="n">FC_SMT_INFO</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span> <span class="n">SMT_REQUEST</span><span class="p">,</span> <span class="p">(</span><span class="n">SMT_TEST_ECHO_LEN</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">)</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generate and send ECF</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_send_ecf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span>
			 <span class="n">u_long</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="cm">/* struct fddi_addr *dest;	dest address */</span>
<span class="cm">/* int fc;			frame control */</span>
<span class="cm">/* u_long tid;			transaction id */</span>
<span class="cm">/* int type;			frame type */</span>
<span class="cm">/* int len;			frame length */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_ecf</span>	<span class="o">*</span><span class="n">ecf</span> <span class="p">;</span>
	<span class="n">SMbuf</span>		<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span> <span class="o">=</span> <span class="n">smt_build_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_ECF</span><span class="p">,</span><span class="n">type</span><span class="p">,</span><span class="n">SMT_ECF_LEN</span> <span class="o">+</span> <span class="n">len</span><span class="p">)))</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="n">ecf</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_ecf</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">smt_fill_echo</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ecf</span><span class="o">-&gt;</span><span class="n">ec_echo</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set ECHO */</span>
	<span class="n">ecf</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="o">*</span><span class="n">dest</span> <span class="p">;</span>	<span class="cm">/* destination address */</span>
	<span class="n">ecf</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="n">tid</span> <span class="p">;</span>	<span class="cm">/* transaction ID */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">priv</span><span class="p">.</span><span class="n">fddiPRIVECF_Req_Tx</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">smt_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generate and send SIF config response</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_send_sif_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				<span class="n">u_long</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">)</span>
<span class="cm">/* struct fddi_addr *dest;	dest address */</span>
<span class="cm">/* u_long tid;			transaction id */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_sif_config</span>	<span class="o">*</span><span class="n">sif</span> <span class="p">;</span>
	<span class="n">SMbuf</span>			<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>
	<span class="kt">int</span>			<span class="n">len</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span> <span class="o">=</span> <span class="n">smt_build_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_SIF_CONFIG</span><span class="p">,</span><span class="n">SMT_REPLY</span><span class="p">,</span>
		<span class="n">SIZEOF_SMT_SIF_CONFIG</span><span class="p">)))</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">sif</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_sif_config</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_fill_timestamp</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set time stamp */</span>
	<span class="n">smt_fill_sde</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">sde</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* set station descriptor */</span>
	<span class="n">smt_fill_version</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set version information */</span>
	<span class="n">smt_fill_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set state information */</span>
	<span class="n">smt_fill_policy</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set station policy */</span>
	<span class="n">smt_fill_latency</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">latency</span><span class="p">);</span>	<span class="cm">/* set station latency */</span>
	<span class="n">smt_fill_neighbor</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">neighbor</span><span class="p">);</span>	<span class="cm">/* set station neighbor */</span>
	<span class="n">smt_fill_setcount</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">setcount</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set count */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">smt_fill_path</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">path</span><span class="p">);</span>	<span class="cm">/* set station path descriptor*/</span>
	<span class="n">sif</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="o">*</span><span class="n">dest</span> <span class="p">;</span>		<span class="cm">/* destination address */</span>
	<span class="n">sif</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="n">tid</span> <span class="p">;</span>		<span class="cm">/* transaction ID */</span>
	<span class="n">smt_add_frame_len</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* adjust length fields */</span>
	<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span><span class="n">sif</span><span class="p">,</span><span class="s">&quot;SIF Configuration Reply&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">FC_SMT_INFO</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * generate and send SIF operation response</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_send_sif_operation</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				   <span class="n">u_long</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">local</span><span class="p">)</span>
<span class="cm">/* struct fddi_addr *dest;	dest address */</span>
<span class="cm">/* u_long tid;			transaction id */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_sif_operation</span> <span class="o">*</span><span class="n">sif</span> <span class="p">;</span>
	<span class="n">SMbuf</span>			<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>
	<span class="kt">int</span>			<span class="n">ports</span> <span class="p">;</span>
	<span class="kt">int</span>			<span class="n">i</span> <span class="p">;</span>

	<span class="n">ports</span> <span class="o">=</span> <span class="n">NUMPHYS</span> <span class="p">;</span>
<span class="cp">#ifndef	CONCENTRATOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_SAS</span><span class="p">)</span>
		<span class="n">ports</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span> <span class="o">=</span> <span class="n">smt_build_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_SIF_OPER</span><span class="p">,</span><span class="n">SMT_REPLY</span><span class="p">,</span>
		<span class="n">SIZEOF_SMT_SIF_OPERATION</span><span class="o">+</span><span class="n">ports</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_lem</span><span class="p">))))</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="n">sif</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_sif_operation</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_fill_timestamp</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set time stamp */</span>
	<span class="n">smt_fill_mac_status</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* set mac status */</span>
	<span class="n">smt_fill_mac_counter</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">mc</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* set mac counter field */</span>
	<span class="n">smt_fill_mac_fnc</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">fnc</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* set frame not copied counter */</span>
	<span class="n">smt_fill_manufacturer</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">man</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* set manufacturer field */</span>
	<span class="n">smt_fill_user</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* set user field */</span>
	<span class="n">smt_fill_setcount</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">setcount</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set count */</span>
	<span class="cm">/*</span>
<span class="cm">	 * set link error mon information</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ports</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smt_fill_lem</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">lem</span><span class="p">,</span><span class="n">PS</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ports</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smt_fill_lem</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">sif</span><span class="o">-&gt;</span><span class="n">lem</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">i</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sif</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="o">*</span><span class="n">dest</span> <span class="p">;</span>	<span class="cm">/* destination address */</span>
	<span class="n">sif</span><span class="o">-&gt;</span><span class="n">smt</span><span class="p">.</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="n">tid</span> <span class="p">;</span>	<span class="cm">/* transaction ID */</span>
	<span class="n">dump_smt</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span><span class="n">sif</span><span class="p">,</span><span class="s">&quot;SIF Operation Reply&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_send_frame</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">FC_SMT_INFO</span><span class="p">,</span><span class="n">local</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get and initialize SMT frame</span>
<span class="cm"> */</span>
<span class="n">SMbuf</span> <span class="o">*</span><span class="nf">smt_build_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMbuf</span>			<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">smt_header</span>	<span class="o">*</span><span class="n">smt</span> <span class="p">;</span>

<span class="cp">#if	0</span><span class="c"></span>
<span class="c">	if (!smc-&gt;r.sm_ma_avail) {</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span> <span class="o">=</span> <span class="n">smt_get_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">mb</span><span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="o">=</span> <span class="n">length</span> <span class="p">;</span>
	<span class="n">smt</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_dest</span> <span class="o">=</span> <span class="n">fddi_broadcast</span> <span class="p">;</span> <span class="cm">/* set dest = broadcast */</span>
	<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_class</span> <span class="o">=</span> <span class="n">class</span> <span class="p">;</span>
	<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_type</span> <span class="o">=</span> <span class="n">type</span> <span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMT_NIF</span> :
	<span class="k">case</span> <span class="n">SMT_SIF_CONFIG</span> :
	<span class="k">case</span> <span class="n">SMT_SIF_OPER</span> :
	<span class="k">case</span> <span class="n">SMT_ECF</span> :
		<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_version</span> <span class="o">=</span> <span class="n">SMT_VID</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">default</span> <span class="o">:</span>
		<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_version</span> <span class="o">=</span> <span class="n">SMT_VID_2</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_tid</span> <span class="o">=</span> <span class="n">smt_get_tid</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* set transaction ID */</span>
	<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_pad</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_len</span> <span class="o">=</span> <span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">mb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_add_frame_len</span><span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_header</span>	<span class="o">*</span><span class="n">smt</span> <span class="p">;</span>

	<span class="n">smt</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt</span><span class="o">-&gt;</span><span class="n">smt_len</span> <span class="o">+=</span> <span class="n">len</span> <span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="o">+=</span> <span class="n">len</span> <span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * fill values in UNA parameter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_una</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_una</span> <span class="o">*</span><span class="n">una</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">una</span><span class="p">,</span><span class="n">SMT_P_UNA</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">una</span><span class="o">-&gt;</span><span class="n">una_pad</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">una</span><span class="o">-&gt;</span><span class="n">una_node</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill values in SDE parameter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_sde</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_sde</span> <span class="o">*</span><span class="n">sde</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">sde</span><span class="p">,</span><span class="n">SMT_P_SDE</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">sde</span><span class="o">-&gt;</span><span class="n">sde_non_master</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTNonMaster_Ct</span> <span class="p">;</span>
	<span class="n">sde</span><span class="o">-&gt;</span><span class="n">sde_master</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTMaster_Ct</span> <span class="p">;</span>
	<span class="n">sde</span><span class="o">-&gt;</span><span class="n">sde_mac_count</span> <span class="o">=</span> <span class="n">NUMMACS</span> <span class="p">;</span>		<span class="cm">/* only 1 MAC */</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
	<span class="n">sde</span><span class="o">-&gt;</span><span class="n">sde_type</span> <span class="o">=</span> <span class="n">SMT_SDE_CONCENTRATOR</span> <span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">sde</span><span class="o">-&gt;</span><span class="n">sde_type</span> <span class="o">=</span> <span class="n">SMT_SDE_STATION</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill in values in station state parameter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">top</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">twist</span> <span class="p">;</span>

	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">state</span><span class="p">,</span><span class="n">SMT_P_STATE</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">st_pad</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="cm">/* determine topology */</span>
	<span class="n">top</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTPeerWrapFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top</span> <span class="o">|=</span> <span class="n">SMT_ST_WRAPPED</span> <span class="p">;</span>		<span class="cm">/* state wrapped */</span>
	<span class="p">}</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfm_status_unattached</span><span class="p">(</span><span class="n">smc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">top</span> <span class="o">|=</span> <span class="n">SMT_ST_UNATTACHED</span> <span class="p">;</span>	<span class="cm">/* unattached concentrator */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">twist</span> <span class="o">=</span> <span class="n">pcm_status_twisted</span><span class="p">(</span><span class="n">smc</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top</span> <span class="o">|=</span> <span class="n">SMT_ST_TWISTED_A</span> <span class="p">;</span>	<span class="cm">/* twisted cable */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">twist</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">top</span> <span class="o">|=</span> <span class="n">SMT_ST_TWISTED_B</span> <span class="p">;</span>	<span class="cm">/* twisted cable */</span>
	<span class="p">}</span>
<span class="cp">#ifdef	OPT_SRF</span>
	<span class="n">top</span> <span class="o">|=</span> <span class="n">SMT_ST_SRF</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm_rooted_station</span><span class="p">(</span><span class="n">smc</span><span class="p">))</span>
		<span class="n">top</span> <span class="o">|=</span> <span class="n">SMT_ST_ROOTED_S</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">top</span> <span class="o">|=</span> <span class="n">SMT_ST_SYNC_SERVICE</span> <span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">st_topology</span> <span class="o">=</span> <span class="n">top</span> <span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">st_dupl_addr</span> <span class="o">=</span>
		<span class="p">((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDA_Flag</span> <span class="o">?</span> <span class="n">SMT_ST_MY_DUPA</span> <span class="o">:</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">|</span>
		 <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUNDA_Flag</span> <span class="o">?</span> <span class="n">SMT_ST_UNA_DUPA</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill values in timestamp parameter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_timestamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_timestamp</span> <span class="o">*</span><span class="n">ts</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span><span class="n">SMT_P_TIMESTAMP</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_set_timestamp</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">ts</span><span class="o">-&gt;</span><span class="n">ts_time</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">smt_set_timestamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">time</span> <span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">utime</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * timestamp is 64 bits long ; resolution is 80 nS</span>
<span class="cm">	 * our clock resolution is 10mS</span>
<span class="cm">	 * 10mS/80ns = 125000 ~ 2^17 = 131072</span>
<span class="cm">	 */</span>
	<span class="n">utime</span> <span class="o">=</span> <span class="n">smt_get_time</span><span class="p">()</span> <span class="p">;</span>
	<span class="n">time</span> <span class="o">=</span> <span class="n">utime</span> <span class="o">*</span> <span class="mi">100</span> <span class="p">;</span>
	<span class="n">time</span> <span class="o">/=</span> <span class="n">TICKS_PER_SECOND</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)((</span><span class="n">time</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">time</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">8</span><span class="o">+</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">time</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">+</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">time</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">time</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">uniq_ticks</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">p</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">uniq_ticks</span> <span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * make sure we don&#39;t wrap: restart whenever the upper digits change</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">utime</span> <span class="o">!=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">uniq_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">uniq_ticks</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">uniq_ticks</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">uniq_time</span> <span class="o">=</span> <span class="n">utime</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill values in station policy parameter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_policy</span> <span class="o">*</span><span class="n">policy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>
	<span class="k">const</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">map</span> <span class="p">;</span>
	<span class="n">u_short</span>	<span class="n">in</span> <span class="p">;</span>
	<span class="n">u_short</span>	<span class="n">out</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * MIB para 101b (fddiSMTConnectionPolicy) coding</span>
<span class="cm">	 * is different from 0005 coding</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u_char</span> <span class="n">ansi_weirdness</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">11</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="mi">15</span>
	<span class="p">}</span> <span class="p">;</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">policy</span><span class="p">,</span><span class="n">SMT_P_POLICY</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">out</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">in</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTConnectionPolicy</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">map</span> <span class="o">=</span> <span class="n">ansi_weirdness</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">out</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;*</span><span class="n">map</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">in</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="n">map</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">pl_config</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTConfigPolicy</span> <span class="p">;</span>
	<span class="n">policy</span><span class="o">-&gt;</span><span class="n">pl_connect</span> <span class="o">=</span> <span class="n">out</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill values in latency equivalent parameter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_latency</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_latency</span> <span class="o">*</span><span class="n">latency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">latency</span><span class="p">,</span><span class="n">SMT_P_LATENCY</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">latency</span><span class="o">-&gt;</span><span class="n">lt_phyout_idx1</span> <span class="o">=</span> <span class="n">phy_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">latency</span><span class="o">-&gt;</span><span class="n">lt_latency1</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">;</span>	<span class="cm">/* in octets (byte clock) */</span>
	<span class="cm">/*</span>
<span class="cm">	 * note: latency has two phy entries by definition</span>
<span class="cm">	 * for a SAS, the 2nd one is null</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_DAS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">latency</span><span class="o">-&gt;</span><span class="n">lt_phyout_idx2</span> <span class="o">=</span> <span class="n">phy_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">latency</span><span class="o">-&gt;</span><span class="n">lt_latency2</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">;</span>	<span class="cm">/* in octets (byte clock) */</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">latency</span><span class="o">-&gt;</span><span class="n">lt_phyout_idx2</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">latency</span><span class="o">-&gt;</span><span class="n">lt_latency2</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill values in MAC neighbors parameter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_neighbor</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_neighbor</span> <span class="o">*</span><span class="n">neighbor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">neighbor</span><span class="p">,</span><span class="n">SMT_P_NEIGHBORS</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">neighbor</span><span class="o">-&gt;</span><span class="n">nb_mib_index</span> <span class="o">=</span> <span class="n">INDEX_MAC</span> <span class="p">;</span>
	<span class="n">neighbor</span><span class="o">-&gt;</span><span class="n">nb_mac_index</span> <span class="o">=</span> <span class="n">mac_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">neighbor</span><span class="o">-&gt;</span><span class="n">nb_una</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span> <span class="p">;</span>
	<span class="n">neighbor</span><span class="o">-&gt;</span><span class="n">nb_dna</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill values in path descriptor</span>
<span class="cm"> */</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
<span class="cp">#define ALLPHYS	NUMPHYS</span>
<span class="cp">#else</span>
<span class="cp">#define ALLPHYS	((smc-&gt;s.sas == SMT_SAS) ? 1 : 2)</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smt_fill_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_path</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_LOC_DECL</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">type</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SK_LOC_DECL</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">state</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SK_LOC_DECL</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">remote</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SK_LOC_DECL</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span><span class="n">mac</span><span class="p">)</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">len</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">p</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">physp</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">smt_phy_rec</span>	<span class="o">*</span><span class="n">phy</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">smt_mac_rec</span>	<span class="o">*</span><span class="n">pd_mac</span> <span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span>	<span class="n">PARA_LEN</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_mac_rec</span><span class="p">)</span> <span class="o">*</span> <span class="n">NUMMACS</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_phy_rec</span><span class="p">)</span> <span class="o">*</span> <span class="n">ALLPHYS</span> <span class="p">;</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">SMT_P_PATH</span> <span class="p">;</span>
	<span class="n">path</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">PARA_LEN</span> <span class="p">;</span>

	<span class="cm">/* PHYs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">phy</span> <span class="o">=</span> <span class="n">path</span><span class="o">-&gt;</span><span class="n">pd_phy</span> <span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">ALLPHYS</span> <span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">physp</span> <span class="o">=</span> <span class="n">p</span> <span class="p">;</span>
<span class="cp">#ifndef	CONCENTRATOR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_SAS</span><span class="p">)</span>
			<span class="n">physp</span> <span class="o">=</span> <span class="n">PS</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">pcm_status_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">physp</span><span class="p">,</span><span class="o">&amp;</span><span class="n">type</span><span class="p">,</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span><span class="o">&amp;</span><span class="n">remote</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifdef	LITTLE_ENDIAN</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_mib_index</span> <span class="o">=</span> <span class="n">smt_swap_short</span><span class="p">((</span><span class="n">u_short</span><span class="p">)</span><span class="n">p</span><span class="o">+</span><span class="n">INDEX_PORT</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_mib_index</span> <span class="o">=</span> <span class="n">p</span><span class="o">+</span><span class="n">INDEX_PORT</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_type</span> <span class="o">=</span> <span class="n">type</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_connect_state</span> <span class="o">=</span> <span class="n">state</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_remote_type</span> <span class="o">=</span> <span class="n">remote</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_remote_mac</span> <span class="o">=</span> <span class="n">mac</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_resource_idx</span> <span class="o">=</span> <span class="n">phy_con_resource_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MAC */</span>
	<span class="n">pd_mac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smt_mac_rec</span> <span class="o">*</span><span class="p">)</span> <span class="n">phy</span> <span class="p">;</span>
	<span class="n">pd_mac</span><span class="o">-&gt;</span><span class="n">mac_addr</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACSMTAddress</span> <span class="p">;</span>
	<span class="n">pd_mac</span><span class="o">-&gt;</span><span class="n">mac_resource_idx</span> <span class="o">=</span> <span class="n">mac_con_resource_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill values in mac status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_mac_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_mac_status</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">SMT_P_MAC_STATUS</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_mib_index</span> <span class="o">=</span> <span class="n">INDEX_MAC</span> <span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_mac_index</span> <span class="o">=</span> <span class="n">mac_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">mac_update_counter</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * timer values are represented in SMT as 2&#39;s complement numbers</span>
<span class="cm">	 * units :	internal :  2&#39;s complement BCLK</span>
<span class="cm">	 */</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_t_req</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Req</span> <span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_t_neg</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Neg</span> <span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_t_max</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Max</span> <span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_tvx_value</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACTvxValue</span> <span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_t_min</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACT_Min</span> <span class="p">;</span>

	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_sba</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">a</span><span class="p">[</span><span class="n">PATH0</span><span class="p">].</span><span class="n">fddiPATHSbaPayload</span> <span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_frame_ct</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACFrame_Ct</span> <span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_error_ct</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACError_Ct</span> <span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">st_lost_ct</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACLost_Ct</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill values in LEM status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_lem</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_lem</span> <span class="o">*</span><span class="n">lem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>

	<span class="n">mib</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">phy</span><span class="p">].</span><span class="n">mib</span> <span class="p">;</span>

	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">lem</span><span class="p">,</span><span class="n">SMT_P_LEM</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_mib_index</span> <span class="o">=</span> <span class="n">phy</span><span class="o">+</span><span class="n">INDEX_PORT</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_phy_index</span> <span class="o">=</span> <span class="n">phy_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_pad2</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_cutoff</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Cutoff</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_alarm</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Alarm</span> <span class="p">;</span>
	<span class="cm">/* long term bit error rate */</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_estimate</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span> <span class="p">;</span>
	<span class="cm">/* # of rejected connections */</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_reject_ct</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Reject_Ct</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_ct</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Ct</span> <span class="p">;</span>	<span class="cm">/* total number of errors */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill version parameter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_version</span> <span class="o">*</span><span class="n">vers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">vers</span><span class="p">,</span><span class="n">SMT_P_VERSION</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">vers</span><span class="o">-&gt;</span><span class="n">v_pad</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">vers</span><span class="o">-&gt;</span><span class="n">v_n</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>				<span class="cm">/* one version is enough .. */</span>
	<span class="n">vers</span><span class="o">-&gt;</span><span class="n">v_index</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="n">vers</span><span class="o">-&gt;</span><span class="n">v_version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">SMT_VID_2</span> <span class="p">;</span>
	<span class="n">vers</span><span class="o">-&gt;</span><span class="n">v_pad2</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef	SMT6_10</span>
<span class="cm">/*</span>
<span class="cm"> * fill frame status capabilities</span>
<span class="cm"> */</span>
<span class="cm">/*</span>
<span class="cm"> * note: this para 200B is NOT in swap table, because it&#39;s also set in</span>
<span class="cm"> * PMF add_para</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_fsc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_fsc</span> <span class="o">*</span><span class="n">fsc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">fsc</span><span class="p">,</span><span class="n">SMT_P_FSC</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">fsc_pad0</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">fsc_mac_index</span> <span class="o">=</span> <span class="n">INDEX_MAC</span> <span class="p">;</span>	<span class="cm">/* this is MIB ; MIB is NOT</span>
<span class="cm">						 * mac_index ()i !</span>
<span class="cm">						 */</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">fsc_pad1</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">fsc_value</span> <span class="o">=</span> <span class="n">FSC_TYPE0</span> <span class="p">;</span>		<span class="cm">/* &quot;normal&quot; node */</span>
<span class="cp">#ifdef	LITTLE_ENDIAN</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">fsc_mac_index</span> <span class="o">=</span> <span class="n">smt_swap_short</span><span class="p">(</span><span class="n">INDEX_MAC</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">fsc</span><span class="o">-&gt;</span><span class="n">fsc_value</span> <span class="o">=</span> <span class="n">smt_swap_short</span><span class="p">(</span><span class="n">FSC_TYPE0</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * fill mac counter field</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_mac_counter</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_mac_counter</span> <span class="o">*</span><span class="n">mc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">mc</span><span class="p">,</span><span class="n">SMT_P_MAC_COUNTER</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mc_mib_index</span> <span class="o">=</span> <span class="n">INDEX_MAC</span> <span class="p">;</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mc_index</span> <span class="o">=</span> <span class="n">mac_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mc_receive_ct</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACCopied_Ct</span> <span class="p">;</span>
	<span class="n">mc</span><span class="o">-&gt;</span><span class="n">mc_transmit_ct</span> <span class="o">=</span>  <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACTransmit_Ct</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill mac frame not copied counter</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_mac_fnc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_mac_fnc</span> <span class="o">*</span><span class="n">fnc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">fnc</span><span class="p">,</span><span class="n">SMT_P_MAC_FNC</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">fnc</span><span class="o">-&gt;</span><span class="n">nc_mib_index</span> <span class="o">=</span> <span class="n">INDEX_MAC</span> <span class="p">;</span>
	<span class="n">fnc</span><span class="o">-&gt;</span><span class="n">nc_index</span> <span class="o">=</span> <span class="n">mac_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">fnc</span><span class="o">-&gt;</span><span class="n">nc_counter</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACNotCopied_Ct</span> <span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * fill manufacturer field</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_manufacturer</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> 
				  <span class="k">struct</span> <span class="n">smp_p_manufacturer</span> <span class="o">*</span><span class="n">man</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">man</span><span class="p">,</span><span class="n">SMT_P_MANUFACTURER</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">man</span><span class="o">-&gt;</span><span class="n">mf_data</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTManufacturerData</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">man</span><span class="o">-&gt;</span><span class="n">mf_data</span><span class="p">))</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill user field</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smp_p_user</span> <span class="o">*</span><span class="n">user</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">user</span><span class="p">,</span><span class="n">SMT_P_USER</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">user</span><span class="o">-&gt;</span><span class="n">us_data</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTUserData</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">user</span><span class="o">-&gt;</span><span class="n">us_data</span><span class="p">))</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill set count</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_setcount</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_setcount</span> <span class="o">*</span><span class="n">setcount</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">setcount</span><span class="p">,</span><span class="n">SMT_P_SETCOUNT</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">setcount</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTSetCount</span><span class="p">.</span><span class="n">count</span> <span class="p">;</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">setcount</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTSetCount</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * fill echo data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_fill_echo</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_p_echo</span> <span class="o">*</span><span class="n">echo</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">seed</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>	<span class="o">*</span><span class="n">p</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SMTSETPARA</span><span class="p">(</span><span class="n">echo</span><span class="p">,</span><span class="n">SMT_P_ECHODATA</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">echo</span><span class="o">-&gt;</span><span class="n">para</span><span class="p">.</span><span class="n">p_len</span> <span class="o">=</span> <span class="n">len</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">echo</span><span class="o">-&gt;</span><span class="n">ec_data</span> <span class="p">;</span> <span class="n">len</span> <span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">seed</span> <span class="p">;</span>
		<span class="n">seed</span> <span class="o">+=</span> <span class="mi">13</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * clear DNA and UNA</span>
<span class="cm"> * called from CFM if configuration changes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_clear_una_dna</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACUpstreamNbr</span> <span class="o">=</span> <span class="n">SMT_Unknown</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACDownstreamNbr</span> <span class="o">=</span> <span class="n">SMT_Unknown</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_clear_old_una_dna</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACOldUpstreamNbr</span> <span class="o">=</span> <span class="n">SMT_Unknown</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACOldDownstreamNbr</span> <span class="o">=</span> <span class="n">SMT_Unknown</span> <span class="p">;</span>
<span class="p">}</span>

<span class="n">u_long</span> <span class="nf">smt_get_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">tid</span> <span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tid</span> <span class="o">=</span> <span class="o">++</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">sm</span><span class="p">.</span><span class="n">smt_tid</span><span class="p">)</span> <span class="o">^</span> <span class="n">SMT_TID_MAGIC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span>
	<span class="k">return</span> <span class="n">tid</span> <span class="o">&amp;</span> <span class="mh">0x3fffffffL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * table of parameter lengths</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">smt_pdef</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ptype</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">plen</span> <span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">pswap</span> <span class="p">;</span>
<span class="p">}</span> <span class="n">smt_pdef</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SMT_P_UNA</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_una</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_UNA</span>					<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_SDE</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_sde</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_SDE</span>					<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_STATE</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_state</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_STATE</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_TIMESTAMP</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_timestamp</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_TIMESTAMP</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_POLICY</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_policy</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_POLICY</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_LATENCY</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_latency</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_LATENCY</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_NEIGHBORS</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_neighbor</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_NEIGHBORS</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_PATH</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_path</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_PATH</span>					<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_MAC_STATUS</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_mac_status</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_MAC_STATUS</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_LEM</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_lem</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_LEM</span>					<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_MAC_COUNTER</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_mac_counter</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_MAC_COUNTER</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_MAC_FNC</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_mac_fnc</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_MAC_FNC</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_PRIORITY</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_priority</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_PRIORITY</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_EB</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_eb</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_EB</span>					<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_MANUFACTURER</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smp_p_manufacturer</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_MANUFACTURER</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_REASON</span><span class="p">,</span>	<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_reason</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_REASON</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_REFUSED</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_refused</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_REFUSED</span>				<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P_VERSION</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_version</span><span class="p">)</span> <span class="p">,</span>
		<span class="n">SWAP_SMT_P_VERSION</span>				<span class="p">}</span> <span class="p">,</span>
<span class="cp">#ifdef ESS</span>
	<span class="p">{</span> <span class="n">SMT_P0015</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0015</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P0015</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P0016</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0016</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P0016</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P0017</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0017</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P0017</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P0018</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0018</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P0018</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P0019</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_0019</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P0019</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P001A</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_001a</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P001A</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P001B</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_001b</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P001B</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P001C</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_001c</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P001C</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P001D</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_001d</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P001D</span> <span class="p">}</span> <span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#if	0</span><span class="c"></span>
<span class="c">	{ SMT_P_FSC,	sizeof(struct smt_p_fsc) ,</span>
<span class="c">		SWAP_SMT_P_FSC					} ,</span>
<span class="cp">#endif</span>

	<span class="p">{</span> <span class="n">SMT_P_SETCOUNT</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P_SETCOUNT</span>		<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P1048</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P1048</span>			<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P208C</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P208C</span>			<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P208D</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P208D</span>			<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P208E</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P208E</span>			<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P208F</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P208F</span>			<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P2090</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P2090</span>			<span class="p">}</span> <span class="p">,</span>
<span class="cp">#ifdef	ESS</span>
	<span class="p">{</span> <span class="n">SMT_P320B</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_320b</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P320B</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P320F</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_320f</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P320F</span> <span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P3210</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_p_3210</span><span class="p">)</span> <span class="p">,</span> <span class="n">SWAP_SMT_P3210</span> <span class="p">}</span> <span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">{</span> <span class="n">SMT_P4050</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P4050</span>			<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P4051</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P4051</span>			<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P4052</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P4052</span>			<span class="p">}</span> <span class="p">,</span>
	<span class="p">{</span> <span class="n">SMT_P4053</span><span class="p">,</span>	<span class="mi">0</span><span class="p">,</span>	<span class="n">SWAP_SMT_P4053</span>			<span class="p">}</span> <span class="p">,</span>
<span class="p">}</span> <span class="p">;</span>

<span class="cp">#define N_SMT_PLEN	ARRAY_SIZE(smt_pdef)</span>

<span class="kt">int</span> <span class="nf">smt_check_para</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_header</span>	<span class="o">*</span><span class="n">sm</span><span class="p">,</span>
		   <span class="k">const</span> <span class="n">u_short</span> <span class="n">list</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u_short</span>		<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">list</span> <span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sm_to_para</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">sm</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="o">*</span><span class="n">p</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: smt_check_para - missing para %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">p</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="o">*</span><span class="nf">sm_to_para</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">para</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">p</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">len</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">plen</span> <span class="p">;</span>
	<span class="kt">void</span>	<span class="o">*</span><span class="n">found</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">sm</span><span class="o">-&gt;</span><span class="n">smt_len</span> <span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)(</span><span class="n">sm</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* pointer to info */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">smt_para</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">p_type</span> <span class="o">==</span> <span class="n">para</span><span class="p">)</span>
			<span class="n">found</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span> <span class="p">;</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">smt_para</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">p_len</span> <span class="o">+</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">plen</span> <span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">plen</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : sm_to_para - length error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">plen</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">plen</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">para</span> <span class="o">!=</span> <span class="n">SMT_P_ECHODATA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT : sm_to_para - odd length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">plen</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if	0</span><span class="c"></span>
<span class="c">/*</span>
<span class="c"> * send ANTC data test frame</span>
<span class="c"> */</span>
<span class="c">void fddi_send_antc(struct s_smc *smc, struct fddi_addr *dest)</span>
<span class="c">{</span>
<span class="c">	SK_UNUSED(smc) ;</span>
<span class="c">	SK_UNUSED(dest) ;</span>
<span class="cp">#if	0</span>
<span class="c">	SMbuf			*mb ;</span>
<span class="c">	struct smt_header	*smt ;</span>
<span class="c">	int			i ;</span>
<span class="c">	char			*p ;</span>

<span class="c">	mb = smt_get_mbuf() ;</span>
<span class="c">	mb-&gt;sm_len = 3000+12 ;</span>
<span class="c">	p = smtod(mb, char *) + 12 ;</span>
<span class="c">	for (i = 0 ; i &lt; 3000 ; i++)</span>
<span class="c">		*p++ = 1 &lt;&lt; (i&amp;7) ;</span>

<span class="c">	smt = smtod(mb, struct smt_header *) ;</span>
<span class="c">	smt-&gt;smt_dest = *dest ;</span>
<span class="c">	smt-&gt;smt_source = smc-&gt;mib.m[MAC0].fddiMACSMTAddress ;</span>
<span class="c">	smt_send_mbuf(smc,mb,FC_ASYNC_LLC) ;</span>
<span class="cp">#endif</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	DEBUG</span>
<span class="kt">char</span> <span class="o">*</span><span class="nf">addr_to_string</span><span class="p">(</span><span class="k">struct</span> <span class="n">fddi_addr</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span>	<span class="n">string</span><span class="p">[</span><span class="mi">6</span><span class="o">*</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;****&quot;</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">string</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">string</span><span class="p">[</span><span class="mi">5</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">string</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	AM29K</span>
<span class="kt">int</span> <span class="nf">smt_ifconfig</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="s">&quot;opt_bypass&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="s">&quot;yes&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTBypassPresent</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">amdfddi_config</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * return static mac index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mac_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">NUMPHYS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_SAS</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return static phy index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">phy_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">phy</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return dynamic mac connection resource index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mac_con_resource_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">entity_to_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">cem_get_downstream</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">ENTITY_MAC</span><span class="p">));</span>
<span class="cp">#else</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">mac</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTCF_State</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SC9_C_WRAP_A</span> :
	<span class="k">case</span> <span class="n">SC5_THRU_B</span> :
	<span class="k">case</span> <span class="n">SC11_C_WRAP_S</span> :
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SC10_C_WRAP_B</span> :
	<span class="k">case</span> <span class="n">SC4_THRU_A</span> :
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_SAS</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return dynamic phy connection resource index</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">phy_con_resource_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
	<span class="k">return</span> <span class="n">entity_to_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">cem_get_downstream</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">ENTITY_PHY</span><span class="p">(</span><span class="n">phy</span><span class="p">)))</span> <span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTCF_State</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SC9_C_WRAP_A</span> :
		<span class="k">return</span> <span class="n">phy</span> <span class="o">==</span> <span class="n">PA</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SC10_C_WRAP_B</span> :
		<span class="k">return</span> <span class="n">phy</span> <span class="o">==</span> <span class="n">PA</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SC4_THRU_A</span> :
		<span class="k">return</span> <span class="n">phy</span> <span class="o">==</span> <span class="n">PA</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SC5_THRU_B</span> :
		<span class="k">return</span> <span class="n">phy</span> <span class="o">==</span> <span class="n">PA</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SC11_C_WRAP_S</span> :
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">phy</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef	CONCENTRATOR</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">entity_to_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="n">ENTITY_MAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mac_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">phy_index</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">e</span> <span class="o">-</span> <span class="n">ENTITY_PHY</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	LITTLE_ENDIAN</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smt_swap_short</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">s</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">s</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">smt_swap_para</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="cm">/* int direction;	0 encode 1 decode */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smt_para</span>	<span class="o">*</span><span class="n">pa</span> <span class="p">;</span>
	<span class="k">const</span>  <span class="k">struct</span> <span class="n">smt_pdef</span>	<span class="o">*</span><span class="n">pd</span> <span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">p</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">plen</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">type</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>

<span class="cm">/*	printf(&quot;smt_swap_para sm %x len %d dir %d\n&quot;,</span>
<span class="cm">		sm,len,direction) ;</span>
<span class="cm"> */</span>
	<span class="n">smt_string_swap</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">sm</span><span class="p">,</span><span class="n">SWAP_SMTHEADER</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* swap args */</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">sm</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pa</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smt_para</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span> <span class="p">;</span>
		<span class="n">plen</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">p_len</span> <span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">p_type</span> <span class="p">;</span>
		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">p_type</span> <span class="o">=</span> <span class="n">smt_swap_short</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">p_type</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">pa</span><span class="o">-&gt;</span><span class="n">p_len</span> <span class="o">=</span> <span class="n">smt_swap_short</span><span class="p">(</span><span class="n">pa</span><span class="o">-&gt;</span><span class="n">p_len</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">plen</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">p_len</span> <span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">p_type</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * note: paras can have 0 length !</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="n">plen</span> <span class="o">+=</span> <span class="n">PARA_LEN</span> <span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">N_SMT_PLEN</span><span class="p">,</span> <span class="n">pd</span> <span class="o">=</span> <span class="n">smt_pdef</span><span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span><span class="n">pd</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">ptype</span> <span class="o">==</span> <span class="n">type</span><span class="p">)</span>
				<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">pd</span><span class="o">-&gt;</span><span class="n">pswap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smt_string_swap</span><span class="p">(</span><span class="n">p</span><span class="o">+</span><span class="n">PARA_LEN</span><span class="p">,</span><span class="n">pd</span><span class="o">-&gt;</span><span class="n">pswap</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">plen</span> <span class="p">;</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">plen</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_string_swap</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">open_paren</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">x</span> <span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;[&#39;</span> :
			<span class="n">open_paren</span> <span class="o">=</span> <span class="n">format</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;]&#39;</span> :
			<span class="n">format</span> <span class="o">=</span> <span class="n">open_paren</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;1&#39;</span> :
		<span class="k">case</span> <span class="sc">&#39;2&#39;</span> :
		<span class="k">case</span> <span class="sc">&#39;3&#39;</span> :
		<span class="k">case</span> <span class="sc">&#39;4&#39;</span> :
		<span class="k">case</span> <span class="sc">&#39;5&#39;</span> :
		<span class="k">case</span> <span class="sc">&#39;6&#39;</span> :
		<span class="k">case</span> <span class="sc">&#39;7&#39;</span> :
		<span class="k">case</span> <span class="sc">&#39;8&#39;</span> :
		<span class="k">case</span> <span class="sc">&#39;9&#39;</span> :
			<span class="n">data</span>  <span class="o">+=</span> <span class="o">*</span><span class="n">format</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span> <span class="p">;</span>
			<span class="n">len</span>   <span class="o">-=</span> <span class="o">*</span><span class="n">format</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:
			<span class="n">data</span><span class="o">++</span> <span class="p">;</span>
			<span class="n">len</span><span class="o">--</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;s&#39;</span> :
			<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="mi">2</span> <span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;l&#39;</span> :
			<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">;</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="p">;</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="mi">4</span> <span class="p">;</span>
			<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">format</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">void</span> <span class="nf">smt_swap_para</span><span class="p">(</span><span class="k">struct</span> <span class="n">smt_header</span> <span class="o">*</span><span class="n">sm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">direction</span><span class="p">)</span>
<span class="cm">/* int direction;	0 encode 1 decode */</span>
<span class="p">{</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">sm</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * PMF actions</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">smt_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">class</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">event</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">port</span> <span class="p">;</span>
	<span class="n">DB_SMT</span><span class="p">(</span><span class="s">&quot;SMT: action %d code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">class</span><span class="p">,</span><span class="n">code</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">class</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMT_STATION_ACTION</span> :
		<span class="k">switch</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SMT_STATION_ACTION_CONNECT</span> :
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTRemoteDisconnectFlag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_ECM</span><span class="p">,</span><span class="n">EC_CONNECT</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_STATION_ACTION_DISCONNECT</span> :
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_ECM</span><span class="p">,</span><span class="n">EC_DISCONNECT</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTRemoteDisconnectFlag</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="n">RS_SET</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">RS_DISCONNECT</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">AIX_EVENT</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_RING_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span>
				<span class="n">FDDI_SMT_EVENT</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_REMOTE_DISCONNECT</span><span class="p">,</span>
				<span class="n">smt_get_event_word</span><span class="p">(</span><span class="n">smc</span><span class="p">));</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_STATION_ACTION_PATHTEST</span> :
			<span class="n">AIX_EVENT</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_RING_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span>
				<span class="n">FDDI_SMT_EVENT</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_PATH_TEST</span><span class="p">,</span>
				<span class="n">smt_get_event_word</span><span class="p">(</span><span class="n">smc</span><span class="p">));</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_STATION_ACTION_SELFTEST</span> :
			<span class="n">AIX_EVENT</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_RING_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span>
				<span class="n">FDDI_SMT_EVENT</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_REMOTE_SELF_TEST</span><span class="p">,</span>
				<span class="n">smt_get_event_word</span><span class="p">(</span><span class="n">smc</span><span class="p">));</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_STATION_ACTION_DISABLE_A</span> :
			<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PA</span><span class="p">].</span><span class="n">pc_mode</span> <span class="o">==</span> <span class="n">PM_PEER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RS_SET</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">RS_EVENT</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">PA</span><span class="p">,</span><span class="n">PC_DISABLE</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_STATION_ACTION_DISABLE_B</span> :
			<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PB</span><span class="p">].</span><span class="n">pc_mode</span> <span class="o">==</span> <span class="n">PM_PEER</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">RS_SET</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">RS_EVENT</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">PB</span><span class="p">,</span><span class="n">PC_DISABLE</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_STATION_ACTION_DISABLE_M</span> :
			<span class="k">for</span> <span class="p">(</span><span class="n">port</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">port</span> <span class="o">&lt;</span>  <span class="n">NUMPHYS</span> <span class="p">;</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">p</span><span class="p">[</span><span class="n">port</span><span class="p">].</span><span class="n">fddiPORTMy_Type</span> <span class="o">!=</span> <span class="n">TM</span><span class="p">)</span>
					<span class="k">continue</span> <span class="p">;</span>
				<span class="n">RS_SET</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">RS_EVENT</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">port</span><span class="p">,</span><span class="n">PC_DISABLE</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">default</span> <span class="o">:</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">SMT_PORT_ACTION</span> :
		<span class="k">switch</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SMT_PORT_ACTION_ENABLE</span> :
			<span class="n">event</span> <span class="o">=</span> <span class="n">PC_ENABLE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_PORT_ACTION_DISABLE</span> :
			<span class="n">event</span> <span class="o">=</span> <span class="n">PC_DISABLE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_PORT_ACTION_MAINT</span> :
			<span class="n">event</span> <span class="o">=</span> <span class="n">PC_MAINT</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_PORT_ACTION_START</span> :
			<span class="n">event</span> <span class="o">=</span> <span class="n">PC_START</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_PORT_ACTION_STOP</span> :
			<span class="n">event</span> <span class="o">=</span> <span class="n">PC_STOP</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">default</span> <span class="o">:</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">index</span><span class="p">,</span><span class="n">event</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">default</span> <span class="o">:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * canonical conversion of &lt;len&gt; bytes beginning form *data</span>
<span class="cm"> */</span>
<span class="cp">#ifdef  USE_CAN_ADDR</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hwm_conv_can</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">data</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">bitrev8</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#endif	</span><span class="cm">/* no SLIM_SMT */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
