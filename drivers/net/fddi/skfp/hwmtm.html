<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › fddi › skfp › hwmtm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hwmtm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *	(C)Copyright 1998,1999 SysKonnect,</span>
<span class="cm"> *	a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.</span>
<span class="cm"> *</span>
<span class="cm"> *	See the file &quot;skfddi.c&quot; for further information.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	The information in this file is provided &quot;AS IS&quot; without warranty.</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cp">#ifndef	lint</span>
<span class="k">static</span> <span class="kt">char</span> <span class="k">const</span> <span class="n">ID_sccs</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;@(#)hwmtm.c	1.40 99/05/31 (C) SK&quot;</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#define	HWMTM</span>

<span class="cp">#ifndef FDDI</span>
<span class="cp">#define	FDDI</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;h/types.h&quot;</span>
<span class="cp">#include &quot;h/fddi.h&quot;</span>
<span class="cp">#include &quot;h/smc.h&quot;</span>
<span class="cp">#include &quot;h/supern_2.h&quot;</span>
<span class="cp">#include &quot;h/skfbiinc.h&quot;</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	DOCUMENTATION</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	BEGIN_MANUAL_ENTRY(DOCUMENTATION)</span>

<span class="cm">			T B D</span>

<span class="cm">	END_MANUAL_ENTRY</span>
<span class="cm">*/</span>
<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	LOCAL VARIABLES:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>
<span class="cp">#ifdef COMMON_MB_POOL</span>
<span class="k">static</span>	<span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb_start</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="k">static</span>	<span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb_free</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="k">static</span>	<span class="kt">int</span> <span class="n">mb_init</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
<span class="k">static</span>	<span class="kt">int</span> <span class="n">call_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	EXTERNE VARIABLES:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="cp">#ifdef	DEBUG</span>
<span class="cp">#ifndef	DEBUG_BRD</span>
<span class="k">extern</span>	<span class="k">struct</span> <span class="n">smt_debug</span>	<span class="n">debug</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	NDIS_OS2</span>
<span class="k">extern</span>	<span class="n">u_char</span>	<span class="n">offDepth</span> <span class="p">;</span>
<span class="k">extern</span>	<span class="n">u_char</span>	<span class="n">force_irq_pending</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	LOCAL FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">queue_llc_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">smt_to_llc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_txd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_rxd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">queue_txd_mb</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_long</span> <span class="n">init_descr_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">count</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_long</span> <span class="n">repair_txd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_smt_tx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u_long</span> <span class="n">repair_rxd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_smt_rx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SMbuf</span><span class="o">*</span> <span class="n">get_llc_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">static</span> <span class="n">SMbuf</span><span class="o">*</span> <span class="n">get_txd_mb</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mac_drv_clear_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	EXTERNAL FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>
<span class="cm">/*	The external SMT functions are listed in cmtdef.h */</span>

<span class="k">extern</span> <span class="kt">void</span><span class="o">*</span> <span class="n">mac_drv_get_space</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span><span class="o">*</span> <span class="n">mac_drv_get_desc_mem</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mac_drv_fill_rxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mac_drv_tx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span>
				<span class="k">volatile</span> <span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="o">*</span><span class="n">txd</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mac_drv_rx_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span>
				<span class="k">volatile</span> <span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="o">*</span><span class="n">rxd</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">frag_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mac_drv_requeue_rxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> 
				<span class="k">volatile</span> <span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="o">*</span><span class="n">rxd</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">frag_count</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mac_drv_clear_rxd</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span>
			      <span class="k">volatile</span> <span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="o">*</span><span class="n">rxd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frag_count</span><span class="p">);</span>

<span class="cp">#ifdef	USE_OS_CPY</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">hwm_cpy_rxd2mb</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">hwm_cpy_txd2mb</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	ALL_RX_COMPLETE</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">mac_drv_all_receives_complete</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="n">u_long</span> <span class="n">mac_drv_virt2phys</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">virt</span><span class="p">);</span>
<span class="k">extern</span> <span class="n">u_long</span> <span class="n">dma_master</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>

<span class="cp">#ifdef	NDIS_OS2</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">post_proc</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">dma_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">volatile</span> <span class="k">union</span> <span class="n">s_fp_descr</span> <span class="o">*</span><span class="n">descr</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">flag</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">mac_drv_rx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">look_ahead</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">la_len</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	PUBLIC FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="n">process_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">fddi_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">smt_free_mbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">init_driver_fplus</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">mac_drv_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">init_fddi_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">mac_drv_clear_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">mac_drv_clear_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hwm_tx_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">far</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">phys</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">frame_status</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">hwm_rx_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">far</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">phys</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">frame_status</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">mac_drv_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">hwm_tx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">fc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frag_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame_len</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">frame_status</span><span class="p">);</span>

<span class="n">u_int</span> <span class="n">mac_drv_check_space</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="n">SMbuf</span><span class="o">*</span> <span class="n">smt_get_mbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="kt">void</span> <span class="n">mac_drv_debug_lev</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	MACROS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>
<span class="cp">#ifndef	UNUSED</span>
<span class="cp">#ifdef	lint</span>
<span class="cp">#define UNUSED(x)	(x) = (x)</span>
<span class="cp">#else</span>
<span class="cp">#define UNUSED(x)</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	USE_CAN_ADDR</span>
<span class="cp">#define MA		smc-&gt;hw.fddi_canon_addr.a</span>
<span class="cp">#define	GROUP_ADDR_BIT	0x01</span>
<span class="cp">#else</span>
<span class="cp">#define	MA		smc-&gt;hw.fddi_home_addr.a</span>
<span class="cp">#define	GROUP_ADDR_BIT	0x80</span>
<span class="cp">#endif</span>

<span class="cp">#define RXD_TXD_COUNT	(HWM_ASYNC_TXD_COUNT+HWM_SYNC_TXD_COUNT+\</span>
<span class="cp">			SMT_R1_RXD_COUNT+SMT_R2_RXD_COUNT)</span>

<span class="cp">#ifdef	MB_OUTSIDE_SMC</span>
<span class="cp">#define	EXT_VIRT_MEM	((RXD_TXD_COUNT+1)*sizeof(struct s_smt_fp_txd) +\</span>
<span class="cp">			MAX_MBUF*sizeof(SMbuf))</span>
<span class="cp">#define	EXT_VIRT_MEM_2	((RXD_TXD_COUNT+1)*sizeof(struct s_smt_fp_txd))</span>
<span class="cp">#else</span>
<span class="cp">#define	EXT_VIRT_MEM	((RXD_TXD_COUNT+1)*sizeof(struct s_smt_fp_txd))</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * define critical read for 16 Bit drivers</span>
<span class="cm">	 */</span>
<span class="cp">#if	defined(NDIS_OS2) || defined(ODI2)</span>
<span class="cp">#define CR_READ(var)	((var) &amp; 0xffff0000 | ((var) &amp; 0xffff))</span>
<span class="cp">#else</span>
<span class="cp">#define CR_READ(var)	(__le32)(var)</span>
<span class="cp">#endif</span>

<span class="cp">#define IMASK_SLOW	(IS_PLINT1 | IS_PLINT2 | IS_TIMINT | IS_TOKEN | \</span>
<span class="cp">			 IS_MINTR1 | IS_MINTR2 | IS_MINTR3 | IS_R1_P | \</span>
<span class="cp">			 IS_R1_C | IS_XA_C | IS_XS_C)</span>

<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	INIT- AND SMT FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>


<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(mac_drv_check_space)</span>
<span class="cm"> *	u_int mac_drv_check_space()</span>
<span class="cm"> *</span>
<span class="cm"> *	function	DOWNCALL	(drvsr.c)</span>
<span class="cm"> *			This function calculates the needed non virtual</span>
<span class="cm"> *			memory for MBufs, RxD and TxD descriptors etc.</span>
<span class="cm"> *			needed by the driver.</span>
<span class="cm"> *</span>
<span class="cm"> *	return		u_int	memory in bytes</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="n">u_int</span> <span class="nf">mac_drv_check_space</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef	MB_OUTSIDE_SMC</span>
<span class="cp">#ifdef	COMMON_MB_POOL</span>
	<span class="n">call_count</span><span class="o">++</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">call_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">EXT_VIRT_MEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">EXT_VIRT_MEM_2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">EXT_VIRT_MEM</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(mac_drv_init)</span>
<span class="cm"> *	void mac_drv_init(smc)</span>
<span class="cm"> *</span>
<span class="cm"> *	function	DOWNCALL	(drvsr.c)</span>
<span class="cm"> *			In this function the hardware module allocates it&#39;s</span>
<span class="cm"> *			memory.</span>
<span class="cm"> *			The operating system dependent module should call</span>
<span class="cm"> *			mac_drv_init once, after the adatper is detected.</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">mac_drv_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smt_fp_rxd</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0001</span><span class="p">,</span><span class="n">HWM_E0001_MSG</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smt_fp_txd</span><span class="p">)</span> <span class="o">%</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0002</span><span class="p">,</span><span class="n">HWM_E0002_MSG</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * get the required memory for the RxDs and TxDs</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">descr_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">mac_drv_get_desc_mem</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="n">u_int</span><span class="p">)</span>
		<span class="p">(</span><span class="n">RXD_TXD_COUNT</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smt_fp_txd</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no space the hwm modul can&#39;t work */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * get the memory for the SMT MBufs</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef	MB_OUTSIDE_SMC</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb_start</span><span class="o">=</span><span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">;</span>
<span class="cp">#else</span>
<span class="cp">#ifndef	COMMON_MB_POOL</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac_drv_get_space</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span>
		<span class="n">MAX_MBUF</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SMbuf</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no space the hwm modul can&#39;t work */</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_start</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="p">)</span> <span class="n">mac_drv_get_space</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span>
			<span class="n">MAX_MBUF</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SMbuf</span><span class="p">))))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* no space the hwm modul can&#39;t work */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(init_driver_fplus)</span>
<span class="cm"> *	init_driver_fplus(smc)</span>
<span class="cm"> *</span>
<span class="cm"> * Sets hardware modul specific values for the mode register 2</span>
<span class="cm"> * (e.g. the byte alignment for the received frames, the position of the</span>
<span class="cm"> *	 least significant byte etc.)</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">init_driver_fplus</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mdr2init</span> <span class="o">=</span> <span class="n">FM_LSB</span> <span class="o">|</span> <span class="n">FM_BMMODE</span> <span class="o">|</span> <span class="n">FM_ENNPRQ</span> <span class="o">|</span> <span class="n">FM_ENHSRQ</span> <span class="o">|</span> <span class="mi">3</span> <span class="p">;</span>

<span class="cp">#ifdef	PCI</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mdr2init</span> <span class="o">|=</span> <span class="n">FM_CHKPAR</span> <span class="o">|</span> <span class="n">FM_PARITY</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">mdr3init</span> <span class="o">=</span> <span class="n">FM_MENRQAUNLCK</span> <span class="o">|</span> <span class="n">FM_MENRS</span> <span class="p">;</span>

<span class="cp">#ifdef	USE_CAN_ADDR</span>
	<span class="cm">/* enable address bit swapping */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">frselreg_init</span> <span class="o">=</span> <span class="n">FM_ENXMTADSWAP</span> <span class="o">|</span> <span class="n">FM_ENRCVADSWAP</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_long</span> <span class="nf">init_descr_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span>
			      <span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">d1</span> <span class="p">;</span>
	<span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">d2</span> <span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">phys</span> <span class="p">;</span>

	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;descr ring starts at = %x &quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">start</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">count</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d2</span> <span class="o">=</span> <span class="n">d1</span> <span class="p">;</span>
		<span class="n">d1</span><span class="o">++</span> <span class="p">;</span>		<span class="cm">/* descr is owned by the host */</span>
		<span class="n">d2</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">rxd_rbctrl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_CHECK</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">d2</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">rxd_next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">d1</span><span class="o">-&gt;</span><span class="n">r</span> <span class="p">;</span>
		<span class="n">phys</span> <span class="o">=</span> <span class="n">mac_drv_virt2phys</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">d1</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">d2</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">rxd_nrdadr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;descr ring ends at = %x &quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">d1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">d1</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">rxd_rbctrl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_CHECK</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">d1</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">rxd_next</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">start</span><span class="o">-&gt;</span><span class="n">r</span> <span class="p">;</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">mac_drv_virt2phys</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">start</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">d1</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">rxd_nrdadr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">d1</span><span class="o">=</span><span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d1</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">d1</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">phys</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_txd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">ds</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_tx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">phys</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the transmit descriptors</span>
<span class="cm">	 */</span>
	<span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">descr_p</span> <span class="o">+</span>
		<span class="n">SMT_R1_RXD_COUNT</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smt_fp_rxd</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">QUEUE_A0</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;Init async TxD ring, %d TxDs &quot;</span><span class="p">,</span><span class="n">HWM_ASYNC_TXD_COUNT</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">init_descr_ring</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span><span class="n">ds</span><span class="p">,</span>
		<span class="n">HWM_ASYNC_TXD_COUNT</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">txd_ntdadr</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">ds</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_put</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="o">=</span> <span class="n">ds</span> <span class="p">;</span>
	<span class="n">ds</span><span class="o">--</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span> <span class="o">=</span> <span class="n">HWM_ASYNC_TXD_COUNT</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_used</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XA_DA</span><span class="p">),</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ds</span> <span class="o">+</span>
		<span class="n">HWM_ASYNC_TXD_COUNT</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smt_fp_txd</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">QUEUE_S</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;Init sync TxD ring, %d TxDs &quot;</span><span class="p">,</span><span class="n">HWM_SYNC_TXD_COUNT</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">init_descr_ring</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span><span class="n">ds</span><span class="p">,</span>
		<span class="n">HWM_SYNC_TXD_COUNT</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">txd_ntdadr</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">ds</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_put</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="o">=</span> <span class="n">ds</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span> <span class="o">=</span> <span class="n">HWM_SYNC_TXD_COUNT</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_used</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XS_DA</span><span class="p">),</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_rxd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">ds</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_rx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">phys</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the receive descriptors</span>
<span class="cm">	 */</span>
	<span class="n">ds</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">descr_p</span> <span class="p">;</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;Init RxD ring, %d RxDs &quot;</span><span class="p">,</span><span class="n">SMT_R1_RXD_COUNT</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">init_descr_ring</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span><span class="n">ds</span><span class="p">,</span>
		<span class="n">SMT_R1_RXD_COUNT</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ds</span><span class="o">-&gt;</span><span class="n">rxd_nrdadr</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">ds</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_put</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span> <span class="o">=</span> <span class="n">ds</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_free</span> <span class="o">=</span> <span class="n">SMT_R1_RXD_COUNT</span> <span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_used</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R1_DA</span><span class="p">),</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(init_fddi_driver)</span>
<span class="cm"> *	void init_fddi_driver(smc,mac_addr)</span>
<span class="cm"> *</span>
<span class="cm"> * initializes the driver and it&#39;s variables</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">init_fddi_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_char</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMbuf</span>	<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>

	<span class="n">init_board</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mac_addr</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">init_fplus</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the SMbufs for the SMT</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef	COMMON_MB_POOL</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb_start</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb_free</span> <span class="o">=</span> <span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MBUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_use_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span>	<span class="p">;</span>
		<span class="n">mb</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="n">mb_start</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb_init</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb_free</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MBUF</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_use_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span>	<span class="p">;</span>
			<span class="n">mb</span><span class="o">++</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mb_init</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/*</span>
<span class="cm">	 * initialize the other variables</span>
<span class="cm">	 */</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">llc_rx_pipe</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">llc_rx_tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">txd_tx_pipe</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">txd_tx_tail</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_SMT</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_NSA</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_DB</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_llc_promisc</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">queued_rx_frames</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">queued_txd_mb</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">detec_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_break</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_len_error</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">isr_flag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * make sure that the start pointer is 16 byte aligned</span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">-</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">descr_p</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;i = %d&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">descr_p</span> <span class="o">=</span> <span class="p">(</span><span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span>
			<span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">descr_p</span><span class="o">+</span><span class="n">i</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;pt to descr area = %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">descr_p</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">init_txd_ring</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">init_rxd_ring</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">mac_drv_fill_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">init_plc</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>


<span class="n">SMbuf</span> <span class="o">*</span><span class="nf">smt_get_mbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">SMbuf</span>	<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>

<span class="cp">#ifndef	COMMON_MB_POOL</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb_free</span> <span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">mb</span> <span class="o">=</span> <span class="n">mb_free</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef	COMMON_MB_POOL</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb_free</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">mb_free</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_off</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">;</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_use_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;get SMbuf: mb = %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">mb</span><span class="p">;</span>	<span class="cm">/* May be NULL */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">smt_free_mbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_use_count</span><span class="o">--</span> <span class="p">;</span>
		<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;free_mbuf: sm_use_count = %d&quot;</span><span class="p">,</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_use_count</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * If the use_count is != zero the MBuf is queued</span>
<span class="cm">		 * more than once and must not queued into the</span>
<span class="cm">		 * free MBuf queue</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_use_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;free SMbuf: mb = %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifndef	COMMON_MB_POOL</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb_free</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">mbuf_pool</span><span class="p">.</span><span class="n">mb_free</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="o">=</span> <span class="n">mb_free</span> <span class="p">;</span>
			<span class="n">mb_free</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0003</span><span class="p">,</span><span class="n">HWM_E0003_MSG</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(mac_drv_repair_descr)</span>
<span class="cm"> *	void mac_drv_repair_descr(smc)</span>
<span class="cm"> *</span>
<span class="cm"> * function	called from SMT	(HWM / hwmtm.c)</span>
<span class="cm"> *		The BMU is idle when this function is called.</span>
<span class="cm"> *		Mac_drv_repair_descr sets up the physical address</span>
<span class="cm"> *		for all receive and transmit queues where the BMU</span>
<span class="cm"> *		should continue.</span>
<span class="cm"> *		It may be that the BMU was reseted during a fragmented</span>
<span class="cm"> *		transfer. In this case there are some fragments which will</span>
<span class="cm"> *		never completed by the BMU. The OWN bit of this fragments</span>
<span class="cm"> *		must be switched to be owned by the host.</span>
<span class="cm"> *</span>
<span class="cm"> *		Give a start command to the receive BMU.</span>
<span class="cm"> *		Start the transmit BMUs if transmit frames pending.</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_drv_repair_descr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>	<span class="n">phys</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_state</span> <span class="o">!=</span> <span class="n">STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SK_BREAK</span><span class="p">()</span> <span class="p">;</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0013</span><span class="p">,</span><span class="n">HWM_E0013_MSG</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * repair tx queues: don&#39;t start</span>
<span class="cm">	 */</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">repair_txd_ring</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">QUEUE_A0</span><span class="p">])</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XA_DA</span><span class="p">),</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx_q</span><span class="p">[</span><span class="n">QUEUE_A0</span><span class="p">].</span><span class="n">tx_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XA_CSR</span><span class="p">),</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">repair_txd_ring</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">QUEUE_S</span><span class="p">])</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XS_DA</span><span class="p">),</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx_q</span><span class="p">[</span><span class="n">QUEUE_S</span><span class="p">].</span><span class="n">tx_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XS_CSR</span><span class="p">),</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * repair rx queues</span>
<span class="cm">	 */</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">repair_rxd_ring</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">])</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R1_DA</span><span class="p">),</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_R1_CSR</span><span class="p">),</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_long</span> <span class="nf">repair_txd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_smt_tx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_used</span> <span class="p">;</span>
	<span class="n">u_long</span> <span class="n">phys</span> <span class="p">;</span>
	<span class="n">u_long</span> <span class="n">tbctrl</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">t</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="p">;</span>
	<span class="n">tx_used</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_used</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">tx_used</span><span class="o">+</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="o">-</span><span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_next</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_ntdadr</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tx_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">tbctrl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_tbctrl</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_OWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_STF</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span> <span class="p">;</span>		<span class="cm">/* exit the loop */</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * repair the descriptor</span>
<span class="cm">				 */</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_tbctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_OWN</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">phys</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_ntdadr</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_next</span> <span class="p">;</span>
		<span class="n">tx_used</span><span class="o">--</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">phys</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Repairs the receive descriptor ring and returns the physical address</span>
<span class="cm"> * where the BMU should continue working.</span>
<span class="cm"> *</span>
<span class="cm"> *	o The physical address where the BMU was stopped has to be</span>
<span class="cm"> *	  determined. This is the next RxD after rx_curr_get with an OWN</span>
<span class="cm"> *	  bit set.</span>
<span class="cm"> *	o The BMU should start working at beginning of the next frame.</span>
<span class="cm"> *	  RxDs with an OWN bit set but with a reset STF bit should be</span>
<span class="cm"> *	  skipped and owned by the driver (OWN = 0). </span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u_long</span> <span class="nf">repair_rxd_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_smt_rx_queue</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_used</span> <span class="p">;</span>
	<span class="n">u_long</span> <span class="n">phys</span> <span class="p">;</span>
	<span class="n">u_long</span> <span class="n">rbctrl</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">r</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span> <span class="p">;</span>
	<span class="n">rx_used</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_used</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">SMT_R1_RXD_COUNT</span><span class="o">-</span><span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">phys</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_nrdadr</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span> <span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rx_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">rbctrl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_OWN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_STF</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span> <span class="p">;</span>		<span class="cm">/* exit the loop */</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * repair the descriptor</span>
<span class="cm">				 */</span>
				<span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_OWN</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">phys</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_nrdadr</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span> <span class="p">;</span>
		<span class="n">rx_used</span><span class="o">--</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">phys</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	INTERRUPT SERVICE ROUTINE:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(fddi_isr)</span>
<span class="cm"> *	void fddi_isr(smc)</span>
<span class="cm"> *</span>
<span class="cm"> * function	DOWNCALL	(drvsr.c)</span>
<span class="cm"> *		interrupt service routine, handles the interrupt requests</span>
<span class="cm"> *		generated by the FDDI adapter.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:	The operating system dependent module must guarantee that the</span>
<span class="cm"> *		interrupts of the adapter are disabled when it calls fddi_isr.</span>
<span class="cm"> *</span>
<span class="cm"> *	About the USE_BREAK_ISR mechanismn:</span>
<span class="cm"> *</span>
<span class="cm"> *	The main requirement of this mechanismn is to force an timer IRQ when</span>
<span class="cm"> *	leaving process_receive() with leave_isr set. process_receive() may</span>
<span class="cm"> *	be called at any time from anywhere!</span>
<span class="cm"> *	To be sure we don&#39;t miss such event we set &#39;force_irq&#39; per default.</span>
<span class="cm"> *	We have to force and Timer IRQ if &#39;smc-&gt;os.hwm.leave_isr&#39; AND</span>
<span class="cm"> *	&#39;force_irq&#39; are set. &#39;force_irq&#39; may be reset if a receive complete</span>
<span class="cm"> *	IRQ is pending.</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fddi_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_long</span>		<span class="n">is</span> <span class="p">;</span>		<span class="cm">/* ISR source */</span>
	<span class="n">u_short</span>		<span class="n">stu</span><span class="p">,</span> <span class="n">stl</span> <span class="p">;</span>
	<span class="n">SMbuf</span>		<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>

<span class="cp">#ifdef	USE_BREAK_ISR</span>
	<span class="kt">int</span>	<span class="n">force_irq</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	ODI2</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_break</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_drv_fill_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_q</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">].</span><span class="n">rx_used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_break</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="n">process_receive</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">detec_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="n">smt_force_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">isr_flag</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>

<span class="cp">#ifdef	USE_BREAK_ISR</span>
	<span class="n">force_irq</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">leave_isr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">leave_isr</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">process_receive</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">is</span> <span class="o">=</span> <span class="n">GET_ISR</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">ISR_MASK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;CH0B&quot;</span><span class="p">,</span><span class="n">is</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;ISA = 0x%x&quot;</span><span class="p">,</span><span class="n">is</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IMASK_SLOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;CH1b&quot;</span><span class="p">,</span><span class="n">is</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_PLINT1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* PLC1 */</span>
				<span class="n">plc1_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_PLINT2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* PLC2 */</span>
				<span class="n">plc2_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_MINTR1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* FORMAC+ STU1(U/L) */</span>
				<span class="n">stu</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_ST1U</span><span class="p">))</span> <span class="p">;</span>
				<span class="n">stl</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_ST1L</span><span class="p">))</span> <span class="p">;</span>
				<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;Slow transmit complete&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">mac1_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">stu</span><span class="p">,</span><span class="n">stl</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_MINTR2</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* FORMAC+ STU2(U/L) */</span>
				<span class="n">stu</span><span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_ST2U</span><span class="p">))</span> <span class="p">;</span>
				<span class="n">stl</span><span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_ST2L</span><span class="p">))</span> <span class="p">;</span>
				<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;Slow receive complete&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;stl = %x : stu = %x&quot;</span><span class="p">,</span><span class="n">stl</span><span class="p">,</span><span class="n">stu</span><span class="p">,</span><span class="mi">7</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">mac2_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">stu</span><span class="p">,</span><span class="n">stl</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_MINTR3</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* FORMAC+ STU3(U/L) */</span>
				<span class="n">stu</span><span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_ST3U</span><span class="p">))</span> <span class="p">;</span>
				<span class="n">stl</span><span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">FM_A</span><span class="p">(</span><span class="n">FM_ST3L</span><span class="p">))</span> <span class="p">;</span>
				<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;FORMAC Mode Register 3&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">mac3_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">stu</span><span class="p">,</span><span class="n">stl</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_TIMINT</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Timer 82C54-2 */</span>
				<span class="n">timer_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifdef	NDIS_OS2</span>
				<span class="n">force_irq_pending</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="cp">#endif</span>
				<span class="cm">/*</span>
<span class="cm">				 * out of RxD detection</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">detec_count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * check out of RxD condition</span>
<span class="cm">					 */</span>
					 <span class="n">process_receive</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_TOKEN</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Restricted Token Monitor */</span>
				<span class="n">rtm_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_R1_P</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Parity error rx queue 1 */</span>
				<span class="cm">/* clear IRQ */</span>
				<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R1_CSR</span><span class="p">),</span><span class="n">CSR_IRQ_CL_P</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0004</span><span class="p">,</span><span class="n">HWM_E0004_MSG</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_R1_C</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Encoding error rx queue 1 */</span>
				<span class="cm">/* clear IRQ */</span>
				<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R1_CSR</span><span class="p">),</span><span class="n">CSR_IRQ_CL_C</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0005</span><span class="p">,</span><span class="n">HWM_E0005_MSG</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_XA_C</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Encoding error async tx q */</span>
				<span class="cm">/* clear IRQ */</span>
				<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XA_CSR</span><span class="p">),</span><span class="n">CSR_IRQ_CL_C</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0006</span><span class="p">,</span><span class="n">HWM_E0006_MSG</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_XS_C</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Encoding error sync tx q */</span>
				<span class="cm">/* clear IRQ */</span>
				<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XS_CSR</span><span class="p">),</span><span class="n">CSR_IRQ_CL_C</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0007</span><span class="p">,</span><span class="n">HWM_E0007_MSG</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *	Fast Tx complete Async/Sync Queue (BMU service)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IS_XS_F</span><span class="o">|</span><span class="n">IS_XA_F</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;Fast tx complete queue&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * clear IRQ, Note: no IRQ is lost, because</span>
<span class="cm">			 * 	we always service both queues</span>
<span class="cm">			 */</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XS_CSR</span><span class="p">),</span><span class="n">CSR_IRQ_CL_F</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XA_CSR</span><span class="p">),</span><span class="n">CSR_IRQ_CL_F</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">mac_drv_clear_txd</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">llc_restart_tx</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 *	Fast Rx Complete (BMU service)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is</span> <span class="o">&amp;</span> <span class="n">IS_R1_F</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;Fast receive complete&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>
			<span class="cm">/* clear IRQ */</span>
<span class="cp">#ifndef USE_BREAK_ISR</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R1_CSR</span><span class="p">),</span><span class="n">CSR_IRQ_CL_F</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">process_receive</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">process_receive</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">leave_isr</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">force_irq</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B4_R1_CSR</span><span class="p">),</span><span class="n">CSR_IRQ_CL_F</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">process_receive</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

<span class="cp">#ifndef	NDIS_OS2</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">mb</span> <span class="o">=</span> <span class="n">get_llc_rx</span><span class="p">(</span><span class="n">smc</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">smt_to_llc</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offDepth</span><span class="p">)</span>
			<span class="n">post_proc</span><span class="p">()</span> <span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">offDepth</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mb</span> <span class="o">=</span> <span class="n">get_llc_rx</span><span class="p">(</span><span class="n">smc</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">smt_to_llc</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">offDepth</span> <span class="o">&amp;&amp;</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_break</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">process_receive</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">ev_get</span> <span class="o">!=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">ev_put</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;CH2a&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">ev_dispatcher</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef	NDIS_OS2</span>
		<span class="n">post_proc</span><span class="p">()</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offDepth</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* leave fddi_isr because */</span>
			<span class="k">break</span> <span class="p">;</span>		<span class="cm">/* indications not allowed */</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	USE_BREAK_ISR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">leave_isr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span> <span class="p">;</span>		<span class="cm">/* leave fddi_isr */</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="cm">/* NOTE: when the isr is left, no rx is pending */</span>
	<span class="p">}</span>	<span class="cm">/* end of interrupt source polling loop */</span>

<span class="cp">#ifdef	USE_BREAK_ISR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">leave_isr</span> <span class="o">&amp;&amp;</span> <span class="n">force_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smt_force_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">isr_flag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;CH0E&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	RECEIVE FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="cp">#ifndef	NDIS_OS2</span>
<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(mac_drv_rx_mode)</span>
<span class="cm"> *	void mac_drv_rx_mode(smc,mode)</span>
<span class="cm"> *</span>
<span class="cm"> * function	DOWNCALL	(fplus.c)</span>
<span class="cm"> *		Corresponding to the parameter mode, the operating system</span>
<span class="cm"> *		dependent module can activate several receive modes.</span>
<span class="cm"> *</span>
<span class="cm"> * para	mode	= 1:	RX_ENABLE_ALLMULTI	enable all multicasts</span>
<span class="cm"> *		= 2:	RX_DISABLE_ALLMULTI	disable &quot;enable all multicasts&quot;</span>
<span class="cm"> *		= 3:	RX_ENABLE_PROMISC	enable promiscuous</span>
<span class="cm"> *		= 4:	RX_DISABLE_PROMISC	disable promiscuous</span>
<span class="cm"> *		= 5:	RX_ENABLE_NSA		enable rec. of all NSA frames</span>
<span class="cm"> *			(disabled after &#39;driver reset&#39; &amp; &#39;set station address&#39;)</span>
<span class="cm"> *		= 6:	RX_DISABLE_NSA		disable rec. of all NSA frames</span>
<span class="cm"> *</span>
<span class="cm"> *		= 21:	RX_ENABLE_PASS_SMT	( see description )</span>
<span class="cm"> *		= 22:	RX_DISABLE_PASS_SMT	(  &quot;	   &quot;	  )</span>
<span class="cm"> *		= 23:	RX_ENABLE_PASS_NSA	(  &quot;	   &quot;	  )</span>
<span class="cm"> *		= 24:	RX_DISABLE_PASS_NSA	(  &quot;	   &quot;	  )</span>
<span class="cm"> *		= 25:	RX_ENABLE_PASS_DB	(  &quot;	   &quot;	  )</span>
<span class="cm"> *		= 26:	RX_DISABLE_PASS_DB	(  &quot;	   &quot;	  )</span>
<span class="cm"> *		= 27:	RX_DISABLE_PASS_ALL	(  &quot;	   &quot;	  )</span>
<span class="cm"> *		= 28:	RX_DISABLE_LLC_PROMISC	(  &quot;	   &quot;	  )</span>
<span class="cm"> *		= 29:	RX_ENABLE_LLC_PROMISC	(  &quot;	   &quot;	  )</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *		RX_ENABLE_PASS_SMT / RX_DISABLE_PASS_SMT</span>
<span class="cm"> *</span>
<span class="cm"> *		If the operating system dependent module activates the</span>
<span class="cm"> *		mode RX_ENABLE_PASS_SMT, the hardware module</span>
<span class="cm"> *		duplicates all SMT frames with the frame control</span>
<span class="cm"> *		FC_SMT_INFO and passes them to the LLC receive channel</span>
<span class="cm"> *		by calling mac_drv_rx_init.</span>
<span class="cm"> *		The SMT Frames which are sent by the local SMT and the NSA</span>
<span class="cm"> *		frames whose A- and C-Indicator is not set are also duplicated</span>
<span class="cm"> *		and passed.</span>
<span class="cm"> *		The receive mode RX_DISABLE_PASS_SMT disables the passing</span>
<span class="cm"> *		of SMT frames.</span>
<span class="cm"> *</span>
<span class="cm"> *		RX_ENABLE_PASS_NSA / RX_DISABLE_PASS_NSA</span>
<span class="cm"> *</span>
<span class="cm"> *		If the operating system dependent module activates the</span>
<span class="cm"> *		mode RX_ENABLE_PASS_NSA, the hardware module</span>
<span class="cm"> *		duplicates all NSA frames with frame control FC_SMT_NSA</span>
<span class="cm"> *		and a set A-Indicator and passed them to the LLC</span>
<span class="cm"> *		receive channel by calling mac_drv_rx_init.</span>
<span class="cm"> *		All NSA Frames which are sent by the local SMT</span>
<span class="cm"> *		are also duplicated and passed.</span>
<span class="cm"> *		The receive mode RX_DISABLE_PASS_NSA disables the passing</span>
<span class="cm"> *		of NSA frames with the A- or C-Indicator set.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:	For fear that the hardware module receives NSA frames with</span>
<span class="cm"> *		a reset A-Indicator, the operating system dependent module</span>
<span class="cm"> *		has to call mac_drv_rx_mode with the mode RX_ENABLE_NSA</span>
<span class="cm"> *		before activate the RX_ENABLE_PASS_NSA mode and after every</span>
<span class="cm"> *		&#39;driver reset&#39; and &#39;set station address&#39;.</span>
<span class="cm"> *</span>
<span class="cm"> *		RX_ENABLE_PASS_DB / RX_DISABLE_PASS_DB</span>
<span class="cm"> *</span>
<span class="cm"> *		If the operating system dependent module activates the</span>
<span class="cm"> *		mode RX_ENABLE_PASS_DB, direct BEACON frames</span>
<span class="cm"> *		(FC_BEACON frame control) are passed to the LLC receive</span>
<span class="cm"> *		channel by mac_drv_rx_init.</span>
<span class="cm"> *		The receive mode RX_DISABLE_PASS_DB disables the passing</span>
<span class="cm"> *		of direct BEACON frames.</span>
<span class="cm"> *</span>
<span class="cm"> *		RX_DISABLE_PASS_ALL</span>
<span class="cm"> *</span>
<span class="cm"> *		Disables all special receives modes. It is equal to</span>
<span class="cm"> *		call mac_drv_set_rx_mode successively with the</span>
<span class="cm"> *		parameters RX_DISABLE_NSA, RX_DISABLE_PASS_SMT,</span>
<span class="cm"> *		RX_DISABLE_PASS_NSA and RX_DISABLE_PASS_DB.</span>
<span class="cm"> *</span>
<span class="cm"> *		RX_ENABLE_LLC_PROMISC</span>
<span class="cm"> *</span>
<span class="cm"> *		(default) all received LLC frames and all SMT/NSA/DBEACON</span>
<span class="cm"> *		frames depending on the attitude of the flags</span>
<span class="cm"> *		PASS_SMT/PASS_NSA/PASS_DBEACON will be delivered to the</span>
<span class="cm"> *		LLC layer</span>
<span class="cm"> *</span>
<span class="cm"> *		RX_DISABLE_LLC_PROMISC</span>
<span class="cm"> *</span>
<span class="cm"> *		all received SMT/NSA/DBEACON frames depending on the</span>
<span class="cm"> *		attitude of the flags PASS_SMT/PASS_NSA/PASS_DBEACON</span>
<span class="cm"> *		will be delivered to the LLC layer.</span>
<span class="cm"> *		all received LLC frames with a directed address, Multicast</span>
<span class="cm"> *		or Broadcast address will be delivered to the LLC</span>
<span class="cm"> *		layer too.</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_drv_rx_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RX_ENABLE_PASS_SMT</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_SMT</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_DISABLE_PASS_SMT</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_SMT</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_ENABLE_PASS_NSA</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_NSA</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_DISABLE_PASS_NSA</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_NSA</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_ENABLE_PASS_DB</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_DB</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_DISABLE_PASS_DB</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_DB</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_DISABLE_PASS_ALL</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_SMT</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_NSA</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_DB</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_llc_promisc</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="n">mac_set_rx_mode</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">RX_DISABLE_NSA</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_DISABLE_LLC_PROMISC</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_llc_promisc</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_ENABLE_LLC_PROMISC</span>:
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_llc_promisc</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">RX_ENABLE_ALLMULTI</span>:
	<span class="k">case</span> <span class="n">RX_DISABLE_ALLMULTI</span>:
	<span class="k">case</span> <span class="n">RX_ENABLE_PROMISC</span>:
	<span class="k">case</span> <span class="n">RX_DISABLE_PROMISC</span>:
	<span class="k">case</span> <span class="n">RX_ENABLE_NSA</span>:
	<span class="k">case</span> <span class="n">RX_DISABLE_NSA</span>:
	<span class="nl">default:</span>
		<span class="n">mac_set_rx_mode</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mode</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* ifndef NDIS_OS2 */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * process receive queue</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">process_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_count</span> <span class="p">;</span>		<span class="cm">/* number of RxDs of the curr rx buf */</span>
	<span class="kt">int</span> <span class="n">used_frags</span> <span class="p">;</span>		<span class="cm">/* number of RxDs of the curr frame */</span>
	<span class="k">struct</span> <span class="n">s_smt_rx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">;</span>	<span class="cm">/* points to the queue ctl struct */</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">r</span> <span class="p">;</span>	<span class="cm">/* rxd pointer */</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">rxd</span> <span class="p">;</span>	<span class="cm">/* first rxd of rx frame */</span>
	<span class="n">u_long</span> <span class="n">rbctrl</span> <span class="p">;</span>			<span class="cm">/* receive buffer control word */</span>
	<span class="n">u_long</span> <span class="n">rfsw</span> <span class="p">;</span>			<span class="cm">/* receive frame status word */</span>
	<span class="n">u_short</span> <span class="n">rx_used</span> <span class="p">;</span>
	<span class="n">u_char</span> <span class="n">far</span> <span class="o">*</span><span class="n">virt</span> <span class="p">;</span>
	<span class="kt">char</span> <span class="n">far</span> <span class="o">*</span><span class="n">data</span> <span class="p">;</span>
	<span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span> <span class="p">;</span>
	<span class="n">u_char</span> <span class="n">fc</span> <span class="p">;</span>			<span class="cm">/* Frame control */</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="p">;</span>			<span class="cm">/* Frame length */</span>

	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">detec_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;RHxB&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span> <span class="p">;</span>
		<span class="n">rx_used</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_used</span> <span class="p">;</span>
		<span class="n">frag_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

<span class="cp">#ifdef	USE_BREAK_ISR</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">leave_isr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">rx_end</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	NDIS_OS2</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offDepth</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_break</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="k">goto</span> <span class="n">rx_end</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_break</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	ODI2</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_break</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">rx_end</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;Check RxD %x for OWN and EOF&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">rbctrl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">CR_READ</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_OWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;RHxE&quot;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">rfsw</span><span class="p">,</span><span class="n">rbctrl</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;End of RxDs&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">goto</span> <span class="n">rx_end</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * out of RxD detection</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_used</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">SK_BREAK</span><span class="p">()</span> <span class="p">;</span>
				<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0009</span><span class="p">,</span><span class="n">HWM_E0009_MSG</span><span class="p">)</span> <span class="p">;</span>
				<span class="cm">/* Either we don&#39;t have an RxD or all</span>
<span class="cm">				 * RxDs are filled. Therefore it&#39;s allowed</span>
<span class="cm">				 * for to set the STOPPED flag */</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_state</span> <span class="o">=</span> <span class="n">STOPPED</span> <span class="p">;</span>
				<span class="n">mac_drv_clear_rx_queue</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_state</span> <span class="o">=</span> <span class="n">STARTED</span> <span class="p">;</span>
				<span class="n">mac_drv_fill_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">detec_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
				<span class="k">goto</span> <span class="n">rx_end</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="n">rfsw</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rfsw</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_STF</span><span class="p">)</span> <span class="o">!=</span> <span class="p">((</span><span class="n">rbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_ST_BUF</span><span class="p">)</span> <span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * The BMU_STF bit is deleted, 1 frame is</span>
<span class="cm">				 * placed into more than 1 rx buffer</span>
<span class="cm">				 *</span>
<span class="cm">				 * skip frame by setting the rx len to 0</span>
<span class="cm">				 *</span>
<span class="cm">				 * if fragment count == 0</span>
<span class="cm">				 *	The missing STF bit belongs to the</span>
<span class="cm">				 *	current frame, search for the</span>
<span class="cm">				 *	EOF bit to complete the frame</span>
<span class="cm">				 * else</span>
<span class="cm">				 *	the fragment belongs to the next frame,</span>
<span class="cm">				 *	exit the loop and process the frame</span>
<span class="cm">				 */</span>
				<span class="n">SK_BREAK</span><span class="p">()</span> <span class="p">;</span>
				<span class="n">rfsw</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">frag_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">break</span> <span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">n</span> <span class="o">+=</span> <span class="n">rbctrl</span> <span class="o">&amp;</span> <span class="mh">0xffff</span> <span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span> <span class="p">;</span>
			<span class="n">frag_count</span><span class="o">++</span> <span class="p">;</span>
			<span class="n">rx_used</span><span class="o">--</span> <span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_EOF</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">used_frags</span> <span class="o">=</span> <span class="n">frag_count</span> <span class="p">;</span>
		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;EOF set in RxD, used_frags = %d &quot;</span><span class="p">,</span><span class="n">used_frags</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/* may be next 2 DRV_BUF_FLUSH() can be skipped, because */</span>
		<span class="cm">/* BMU_ST_BUF will not be changed by the ASIC */</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">rx_used</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_ST_BUF</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;Check STF bit in %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span> <span class="p">;</span>
			<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">frag_count</span><span class="o">++</span> <span class="p">;</span>
			<span class="n">rx_used</span><span class="o">--</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;STF bit found&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * The received frame is finished for the process receive</span>
<span class="cm">		 */</span>
		<span class="n">rxd</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span> <span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span> <span class="o">=</span> <span class="n">r</span> <span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_free</span> <span class="o">+=</span> <span class="n">frag_count</span> <span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_used</span> <span class="o">=</span> <span class="n">rx_used</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * ASIC Errata no. 7 (STF - Bit Bug)</span>
<span class="cm">		 */</span>
		<span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">~</span><span class="n">BMU_STF</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">rxd</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">frag_count</span> <span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span><span class="p">,</span> <span class="n">i</span><span class="o">--</span><span class="p">){</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;dma_complete for RxD %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">dma_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span><span class="p">,</span><span class="n">DMA_WR</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_valid</span><span class="o">++</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACCopied_Ct</span><span class="o">++</span> <span class="p">;</span>

		<span class="cm">/* the length of the data including the FC */</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">rfsw</span> <span class="o">&amp;</span> <span class="n">RD_LENGTH</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="p">;</span>

		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;frame length = %d&quot;</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * check the frame_length and all error flags</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfsw</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RX_MSRABT</span><span class="o">|</span><span class="n">RX_FS_E</span><span class="o">|</span><span class="n">RX_FS_CRC</span><span class="o">|</span><span class="n">RX_FS_IMPL</span><span class="p">)){</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rfsw</span> <span class="o">&amp;</span> <span class="n">RD_S_MSRABT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;Frame aborted by the FORMAC&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_abort</span><span class="o">++</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * check frame status</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rfsw</span> <span class="o">&amp;</span> <span class="n">RD_S_SEAC2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;E-Indicator set&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_e_indicator</span><span class="o">++</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rfsw</span> <span class="o">&amp;</span> <span class="n">RD_S_SFRMERR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;CRC error&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_crc</span><span class="o">++</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rfsw</span> <span class="o">&amp;</span> <span class="n">RX_FS_IMPL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;Implementer frame&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_imp_frame</span><span class="o">++</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">abort_frame</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">FDDI_RAW_MTU</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;Frame too long error&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_too_long</span><span class="o">++</span> <span class="p">;</span>
			<span class="k">goto</span> <span class="n">abort_frame</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * SUPERNET 3 Bug: FORMAC delivers status words</span>
<span class="cm">		 * of aborded frames to the BMU</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;Frame length = 0&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">goto</span> <span class="n">abort_frame</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;BMU: rx len differs: [%d:%d]&quot;</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">rx_len_error</span><span class="o">++</span> <span class="p">;</span>
			<span class="k">goto</span> <span class="n">abort_frame</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check SA == MA</span>
<span class="cm">		 */</span>
		<span class="n">virt</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span> <span class="n">far</span> <span class="o">*</span><span class="p">)</span> <span class="n">rxd</span><span class="o">-&gt;</span><span class="n">rxd_virt</span> <span class="p">;</span>
		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;FC = %x&quot;</span><span class="p">,</span><span class="o">*</span><span class="n">virt</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">virt</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">==</span> <span class="n">MA</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">virt</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">==</span> <span class="n">MA</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">virt</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">==</span> <span class="n">MA</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">virt</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="n">MA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="n">virt</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">==</span> <span class="n">MA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">virt</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">GROUP_ADDR_BIT</span><span class="p">)</span> <span class="o">==</span> <span class="n">MA</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">abort_frame</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * test if LLC frame</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfsw</span> <span class="o">&amp;</span> <span class="n">RX_FS_LLC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * if pass_llc_promisc is disable</span>
<span class="cm">			 *	if DA != Multicast or Broadcast or DA!=MA</span>
<span class="cm">			 *		abort the frame</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_llc_promisc</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">virt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">GROUP_ADDR_BIT</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">virt</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MA</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">||</span>
					    <span class="n">virt</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MA</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">||</span>
					    <span class="n">virt</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MA</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span>
					    <span class="n">virt</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MA</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">||</span>
					    <span class="n">virt</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MA</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">||</span>
					    <span class="n">virt</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">MA</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
						<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;DA != MA and not multi- or broadcast&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
						<span class="k">goto</span> <span class="n">abort_frame</span> <span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * LLC frame received</span>
<span class="cm">			 */</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;LLC - receive&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">mac_drv_rx_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">rxd</span><span class="p">,</span><span class="n">frag_count</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">mb</span> <span class="o">=</span> <span class="n">smt_get_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_no_buf</span><span class="o">++</span> <span class="p">;</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;No SMbuf; receive terminated&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">goto</span> <span class="n">abort_frame</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * copy the frame into a SMT_MBuf</span>
<span class="cm">			 */</span>
<span class="cp">#ifdef USE_OS_CPY</span>
			<span class="n">hwm_cpy_rxd2mb</span><span class="p">(</span><span class="n">rxd</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">rxd</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="n">used_frags</span> <span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span><span class="p">,</span> <span class="n">i</span><span class="o">--</span><span class="p">){</span>
				<span class="n">n</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RD_LENGTH</span> <span class="p">;</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;cp SMT frame to mb: len = %d&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_virt</span><span class="p">,</span><span class="n">n</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">data</span> <span class="o">+=</span> <span class="n">n</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">fc</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_data</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span> <span class="p">;</span>
			<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span>		<span class="cm">/* len - fc */</span>
			<span class="n">data</span><span class="o">++</span> <span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * SMT frame received</span>
<span class="cm">			 */</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FC_SMT_INFO</span> :
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_smt_frame</span><span class="o">++</span> <span class="p">;</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;SMT frame received &quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_SMT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;pass SMT frame &quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">mac_drv_rx_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">rxd</span><span class="p">,</span>
						<span class="n">frag_count</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;requeue RxD&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">mac_drv_requeue_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">rxd</span><span class="p">,</span><span class="n">frag_count</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">smt_received_pack</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,(</span><span class="kt">int</span><span class="p">)(</span><span class="n">rfsw</span><span class="o">&gt;&gt;</span><span class="mi">25</span><span class="p">))</span> <span class="p">;</span>
				<span class="k">break</span> <span class="p">;</span>
			<span class="k">case</span> <span class="n">FC_SMT_NSA</span> :
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_smt_frame</span><span class="o">++</span> <span class="p">;</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;SMT frame received &quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

				<span class="cm">/* if pass_NSA set pass the NSA frame or */</span>
				<span class="cm">/* pass_SMT set and the A-Indicator */</span>
				<span class="cm">/* is not set, pass the NSA frame */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_NSA</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_SMT</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="p">(</span><span class="n">rfsw</span> <span class="o">&amp;</span> <span class="n">A_INDIC</span><span class="p">)))</span> <span class="p">{</span>
					<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;pass SMT frame &quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">mac_drv_rx_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">rxd</span><span class="p">,</span>
						<span class="n">frag_count</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;requeue RxD&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">mac_drv_requeue_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">rxd</span><span class="p">,</span><span class="n">frag_count</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="n">smt_received_pack</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">,(</span><span class="kt">int</span><span class="p">)(</span><span class="n">rfsw</span><span class="o">&gt;&gt;</span><span class="mi">25</span><span class="p">))</span> <span class="p">;</span>
				<span class="k">break</span> <span class="p">;</span>
			<span class="k">case</span> <span class="n">FC_BEACON</span> :
				<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_DB</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;pass DB frame &quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">mac_drv_rx_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="n">rxd</span><span class="p">,</span>
						<span class="n">frag_count</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;requeue RxD&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
					<span class="n">mac_drv_requeue_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">rxd</span><span class="p">,</span><span class="n">frag_count</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">break</span> <span class="p">;</span>
			<span class="k">default</span> <span class="o">:</span>
				<span class="cm">/*</span>
<span class="cm">				 * unknown FC abord the frame</span>
<span class="cm">				 */</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;unknown FC error&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;requeue RxD&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">mac_drv_requeue_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">rxd</span><span class="p">,</span><span class="n">frag_count</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="n">FC_MAC</span><span class="p">)</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_mac_frame</span><span class="o">++</span> <span class="p">;</span>
				<span class="k">else</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_imp_frame</span><span class="o">++</span> <span class="p">;</span>

				<span class="k">break</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;next RxD is %x &quot;</span><span class="p">,</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;RHx1&quot;</span><span class="p">,</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">continue</span> <span class="p">;</span>
	<span class="cm">/*--------------------------------------------------------------------*/</span>
<span class="nl">abort_frame:</span>
		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;requeue RxD&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">mac_drv_requeue_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">rxd</span><span class="p">,</span><span class="n">frag_count</span><span class="p">)</span> <span class="p">;</span>

		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;next RxD is %x &quot;</span><span class="p">,</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;RHx2&quot;</span><span class="p">,</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="nl">rx_end:</span>
<span class="cp">#ifdef	ALL_RX_COMPLETE</span>
	<span class="n">mac_drv_all_receives_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="p">;</span>	<span class="cm">/* lint bug: needs return detect end of function */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smt_to_llc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u_char</span>	<span class="n">fc</span> <span class="p">;</span>

	<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;send a queued frame to the llc layer&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">mb_pos</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="o">*</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">mb_pos</span> <span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">mac_drv_rx_init</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">fc</span><span class="p">,</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">r</span><span class="p">.</span><span class="n">mb_pos</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(hwm_rx_frag)</span>
<span class="cm"> *	void hwm_rx_frag(smc,virt,phys,len,frame_status)</span>
<span class="cm"> *</span>
<span class="cm"> * function	MACRO		(hardware module, hwmtm.h)</span>
<span class="cm"> *		This function calls dma_master for preparing the</span>
<span class="cm"> *		system hardware for the DMA transfer and initializes</span>
<span class="cm"> *		the current RxD with the length and the physical and</span>
<span class="cm"> *		virtual address of the fragment. Furthermore, it sets the</span>
<span class="cm"> *		STF and EOF bits depending on the frame status byte,</span>
<span class="cm"> *		switches the OWN flag of the RxD, so that it is owned by the</span>
<span class="cm"> *		adapter and issues an rx_start.</span>
<span class="cm"> *</span>
<span class="cm"> * para	virt	virtual pointer to the fragment</span>
<span class="cm"> *	len	the length of the fragment</span>
<span class="cm"> *	frame_status	status of the frame, see design description</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:	It is possible to call this function with a fragment length</span>
<span class="cm"> *		of zero.</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">hwm_rx_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">far</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">phys</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">frame_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">r</span> <span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">rbctrl</span><span class="p">;</span>

	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;RHfB&quot;</span><span class="p">,</span><span class="n">virt</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">frame_status</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;hwm_rx_frag: len = %d, frame_status = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">frame_status</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_q</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">].</span><span class="n">rx_curr_put</span> <span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_virt</span> <span class="o">=</span> <span class="n">virt</span> <span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbadr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">rbctrl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span> <span class="p">(((</span><span class="n">__u32</span><span class="p">)</span><span class="n">frame_status</span> <span class="o">&amp;</span>
		<span class="p">(</span><span class="n">FIRST_FRAG</span><span class="o">|</span><span class="n">LAST_FRAG</span><span class="p">))</span><span class="o">&lt;&lt;</span><span class="mi">26</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">FIRST_FRAG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">21</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BMU_OWN</span> <span class="o">|</span> <span class="n">BMU_CHECK</span> <span class="o">|</span> <span class="n">BMU_EN_IRQ_EOF</span> <span class="o">|</span> <span class="n">len</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span> <span class="o">=</span> <span class="n">rbctrl</span> <span class="p">;</span>

	<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_R1_CSR</span><span class="p">),</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_q</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">].</span><span class="n">rx_free</span><span class="o">--</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_q</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">].</span><span class="n">rx_used</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx_q</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">].</span><span class="n">rx_curr_put</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span> <span class="p">;</span>
	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;RHfE&quot;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbadr</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGINN_MANUAL_ENTRY(mac_drv_clear_rx_queue)</span>
<span class="cm"> *</span>
<span class="cm"> * void mac_drv_clear_rx_queue(smc)</span>
<span class="cm"> * struct s_smc *smc ;</span>
<span class="cm"> *</span>
<span class="cm"> * function	DOWNCALL	(hardware module, hwmtm.c)</span>
<span class="cm"> *		mac_drv_clear_rx_queue is called by the OS-specific module</span>
<span class="cm"> *		after it has issued a card_stop.</span>
<span class="cm"> *		In this case, the frames in the receive queue are obsolete and</span>
<span class="cm"> *		should be removed. For removing mac_drv_clear_rx_queue</span>
<span class="cm"> *		calls dma_master for each RxD and mac_drv_clear_rxd for each</span>
<span class="cm"> *		receive buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:	calling sequence card_stop:</span>
<span class="cm"> *		CLI_FBI(), card_stop(),</span>
<span class="cm"> *		mac_drv_clear_tx_queue(), mac_drv_clear_rx_queue(),</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:	The caller is responsible that the BMUs are idle</span>
<span class="cm"> *		when this function is called.</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_drv_clear_rx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">r</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_rxd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">next_rxd</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_rx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_count</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_state</span> <span class="o">!=</span> <span class="n">STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SK_BREAK</span><span class="p">()</span> <span class="p">;</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0012</span><span class="p">,</span><span class="n">HWM_E0012_MSG</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">rx</span><span class="p">[</span><span class="n">QUEUE_R1</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;clear_rx_queue&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * dma_complete and mac_drv_clear_rxd for all RxDs / receive buffers</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span> <span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;switch OWN bit of RxD 0x%x &quot;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_OWN</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">frag_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span> <span class="p">;</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_put</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_ST_BUF</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;Check STF bit in %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_rbctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_OWN</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span> <span class="p">;</span>
			<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">frag_count</span><span class="o">++</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;STF bit found&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">next_rxd</span> <span class="o">=</span> <span class="n">r</span> <span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">r</span><span class="o">=</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">frag_count</span><span class="p">;</span> <span class="n">i</span> <span class="p">;</span> <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">rxd_next</span><span class="p">,</span><span class="n">i</span><span class="o">--</span><span class="p">){</span>
			<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;dma_complete for RxD %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">dma_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span><span class="n">r</span><span class="p">,</span><span class="n">DMA_WR</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">DB_RX</span><span class="p">(</span><span class="s">&quot;mac_drv_clear_rxd: RxD %x frag_count %d &quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span><span class="p">,</span><span class="n">frag_count</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">mac_drv_clear_rxd</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span><span class="p">,</span><span class="n">frag_count</span><span class="p">)</span> <span class="p">;</span>

		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_curr_get</span> <span class="o">=</span> <span class="n">next_rxd</span> <span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_used</span> <span class="o">-=</span> <span class="n">frag_count</span> <span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">rx_free</span> <span class="o">+=</span> <span class="n">frag_count</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	SEND FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(hwm_tx_init)</span>
<span class="cm"> *	int hwm_tx_init(smc,fc,frag_count,frame_len,frame_status)</span>
<span class="cm"> *</span>
<span class="cm"> * function	DOWN_CALL	(hardware module, hwmtm.c)</span>
<span class="cm"> *		hwm_tx_init checks if the frame can be sent through the</span>
<span class="cm"> *		corresponding send queue.</span>
<span class="cm"> *</span>
<span class="cm"> * para	fc	the frame control. To determine through which</span>
<span class="cm"> *		send queue the frame should be transmitted.</span>
<span class="cm"> *		0x50 - 0x57:	asynchronous LLC frame</span>
<span class="cm"> *		0xD0 - 0xD7:	synchronous LLC frame</span>
<span class="cm"> *		0x41, 0x4F:	SMT frame to the network</span>
<span class="cm"> *		0x42:		SMT frame to the network and to the local SMT</span>
<span class="cm"> *		0x43:		SMT frame to the local SMT</span>
<span class="cm"> *	frag_count	count of the fragments for this frame</span>
<span class="cm"> *	frame_len	length of the frame</span>
<span class="cm"> *	frame_status	status of the frame, the send queue bit is already</span>
<span class="cm"> *			specified</span>
<span class="cm"> *</span>
<span class="cm"> * return		frame_status</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">hwm_tx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">fc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frag_count</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frame_len</span><span class="p">,</span>
		<span class="kt">int</span> <span class="n">frame_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;THiB&quot;</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">frag_count</span><span class="p">,</span><span class="n">frame_len</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_p</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">QUEUE_A0</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_descr</span> <span class="o">=</span> <span class="n">TX_DESCRIPTOR</span> <span class="o">|</span> <span class="p">(((</span><span class="n">u_long</span><span class="p">)(</span><span class="n">frame_len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">27</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_len</span> <span class="o">=</span> <span class="n">frame_len</span> <span class="p">;</span>
	<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;hwm_tx_init: fc = %x, len = %d&quot;</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="n">frame_len</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">FC_SYNC_BIT</span><span class="o">|</span><span class="n">FC_LLC_PRIOR</span><span class="p">))</span> <span class="o">==</span> <span class="n">FC_ASYNC_LLC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">LAN_TX</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FC_SMT_INFO</span> :
		<span class="k">case</span> <span class="n">FC_SMT_NSA</span> :
			<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">LAN_TX</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">FC_SMT_LOC</span> :
			<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">LOC_TX</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">FC_SMT_LAN_LOC</span> :
			<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">LAN_TX</span> <span class="o">|</span> <span class="n">LOC_TX</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">default</span> <span class="o">:</span>
			<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0010</span><span class="p">,</span><span class="n">HWM_E0010_MSG</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ring_is_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LAN_TX</span> <span class="p">;</span>
		<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">RING_DOWN</span> <span class="p">;</span>
		<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;Ring is down: terminate LAN_TX&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frag_count</span> <span class="o">&gt;</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_p</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef	NDIS_OS2</span>
		<span class="n">mac_drv_clear_txd</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frag_count</span> <span class="o">&gt;</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_p</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;Out of TxDs, terminate LAN_TX&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">frame_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LAN_TX</span> <span class="p">;</span>
			<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">OUT_OF_TXD</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#else</span>
		<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;Out of TxDs, terminate LAN_TX&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">frame_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LAN_TX</span> <span class="p">;</span>
		<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">OUT_OF_TXD</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;frame_status = %x&quot;</span><span class="p">,</span><span class="n">frame_status</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;THiE&quot;</span><span class="p">,</span><span class="n">frame_status</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_p</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">frame_status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(hwm_tx_frag)</span>
<span class="cm"> *	void hwm_tx_frag(smc,virt,phys,len,frame_status)</span>
<span class="cm"> *</span>
<span class="cm"> * function	DOWNCALL	(hardware module, hwmtm.c)</span>
<span class="cm"> *		If the frame should be sent to the LAN, this function calls</span>
<span class="cm"> *		dma_master, fills the current TxD with the virtual and the</span>
<span class="cm"> *		physical address, sets the STF and EOF bits dependent on</span>
<span class="cm"> *		the frame status, and requests the BMU to start the</span>
<span class="cm"> *		transmit.</span>
<span class="cm"> *		If the frame should be sent to the local SMT, an SMT_MBuf</span>
<span class="cm"> *		is allocated if the FIRST_FRAG bit is set in the frame_status.</span>
<span class="cm"> *		The fragment of the frame is copied into the SMT MBuf.</span>
<span class="cm"> *		The function smt_received_pack is called if the LAST_FRAG</span>
<span class="cm"> *		bit is set in the frame_status word.</span>
<span class="cm"> *</span>
<span class="cm"> * para	virt	virtual pointer to the fragment</span>
<span class="cm"> *	len	the length of the fragment</span>
<span class="cm"> *	frame_status	status of the frame, see design description</span>
<span class="cm"> *</span>
<span class="cm"> * return	nothing returned, no parameter is modified</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:	It is possible to invoke this macro with a fragment length</span>
<span class="cm"> *		of zero.</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">hwm_tx_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">char</span> <span class="n">far</span> <span class="o">*</span><span class="n">virt</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">phys</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">frame_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">t</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_tx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">tbctrl</span> <span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_p</span> <span class="p">;</span>

	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;THfB&quot;</span><span class="p">,</span><span class="n">virt</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">frame_status</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/* Bug fix: AF / May 31 1999 (#missing)</span>
<span class="cm">	 * snmpinfo problem reported by IBM is caused by invalid</span>
<span class="cm">	 * t-pointer (txd) if LAN_TX is not set but LOC_TX only.</span>
<span class="cm">	 * Set: t = queue-&gt;tx_curr_put  here !</span>
<span class="cm">	 */</span>
	<span class="n">t</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_put</span> <span class="p">;</span>

	<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;hwm_tx_frag: len = %d, frame_status = %x &quot;</span><span class="p">,</span><span class="n">len</span><span class="p">,</span><span class="n">frame_status</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">LAN_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* &#39;*t&#39; is already defined */</span>
		<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;LAN_TX: TxD = %x, virt = %x &quot;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">virt</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_virt</span> <span class="o">=</span> <span class="n">virt</span> <span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_txdscr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_descr</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_tbadr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">tbctrl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((((</span><span class="n">__u32</span><span class="p">)</span><span class="n">frame_status</span> <span class="o">&amp;</span>
			<span class="p">(</span><span class="n">FIRST_FRAG</span><span class="o">|</span><span class="n">LAST_FRAG</span><span class="o">|</span><span class="n">EN_IRQ_EOF</span><span class="p">))</span><span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BMU_OWN</span><span class="o">|</span><span class="n">BMU_CHECK</span> <span class="o">|</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_tbctrl</span> <span class="o">=</span> <span class="n">tbctrl</span> <span class="p">;</span>

<span class="cp">#ifndef	AIX</span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpd</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_bmu_ctl</span><span class="p">,</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#else	</span><span class="cm">/* ifndef AIX */</span><span class="cp"></span>
		<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">QUEUE_A0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XA_CSR</span><span class="p">),</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XS_CSR</span><span class="p">),</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="o">--</span> <span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_used</span><span class="o">++</span> <span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_put</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_next</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">LAST_FRAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACTransmit_Ct</span><span class="o">++</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">LOC_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;LOC_TX: &quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">FIRST_FRAG</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_mb</span> <span class="o">=</span> <span class="n">smt_get_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">err_stats</span><span class="p">.</span><span class="n">err_no_buf</span><span class="o">++</span> <span class="p">;</span>
				<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;No SMbuf; transmit terminated&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_data</span> <span class="o">=</span>
					<span class="n">smtod</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_mb</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span>
<span class="cp">#ifdef USE_OS_CPY</span>
<span class="cp">#ifdef PASS_1ST_TXD_2_TX_COMP</span>
				<span class="n">hwm_cpy_txd2mb</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_data</span><span class="p">,</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_len</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_mb</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifndef	USE_OS_CPY</span>
			<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;copy fragment into MBuf &quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_data</span><span class="p">,</span><span class="n">virt</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_data</span> <span class="o">+=</span> <span class="n">len</span> <span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">LAST_FRAG</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef	USE_OS_CPY</span>
<span class="cp">#ifndef PASS_1ST_TXD_2_TX_COMP</span>
				<span class="cm">/*</span>
<span class="cm">				 * hwm_cpy_txd2mb(txd,data,len) copies &#39;len&#39; </span>
<span class="cm">				 * bytes from the virtual pointer in &#39;rxd&#39;</span>
<span class="cm">				 * to &#39;data&#39;. The virtual pointer of the </span>
<span class="cm">				 * os-specific tx-buffer should be written</span>
<span class="cm">				 * in the LAST txd.</span>
<span class="cm">				 */</span> 
				<span class="n">hwm_cpy_txd2mb</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_data</span><span class="p">,</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_len</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* nPASS_1ST_TXD_2_TX_COMP */</span><span class="cp"></span>
<span class="cp">#endif	</span><span class="cm">/* USE_OS_CPY */</span><span class="cp"></span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_data</span> <span class="o">=</span>
					<span class="n">smtod</span><span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_mb</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_mb</span><span class="o">-&gt;</span><span class="n">sm_data</span> <span class="o">=</span>
					<span class="o">*</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_data</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_data</span><span class="o">++</span> <span class="p">;</span>
				<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="o">=</span>
					<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_len</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span>
				<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;pass LLC frame to SMT &quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smt_received_pack</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">tx_mb</span><span class="p">,</span>
						<span class="n">RD_FS_LOCAL</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;THfE&quot;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * queues a receive for later send</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_llc_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;queue_llc_rx: mb = %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">queued_rx_frames</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">llc_rx_pipe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">llc_rx_pipe</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">llc_rx_tail</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">llc_rx_tail</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * force an timer IRQ to receive the data</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">isr_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smt_force_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get a SMbuf from the llc_rx_queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="nf">get_llc_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMbuf</span>	<span class="o">*</span><span class="n">mb</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mb</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">llc_rx_pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">queued_rx_frames</span><span class="o">--</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">llc_rx_pipe</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;get_llc_rx: mb = 0x%x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">mb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * queues a transmit SMT MBuf during the time were the MBuf is</span>
<span class="cm"> * queued the TxD ring</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_txd_mb</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;_rx: queue_txd_mb = %x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">queued_txd_mb</span><span class="o">++</span> <span class="p">;</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="o">=</span> <span class="p">(</span><span class="n">SMbuf</span> <span class="o">*</span><span class="p">)</span><span class="nb">NULL</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">txd_tx_pipe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">txd_tx_pipe</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">txd_tx_tail</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">txd_tx_tail</span> <span class="o">=</span> <span class="n">mb</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * get a SMbuf from the txd_tx_queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="nf">get_txd_mb</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mb</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">txd_tx_pipe</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">queued_txd_mb</span><span class="o">--</span> <span class="p">;</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">txd_tx_pipe</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_next</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DB_GEN</span><span class="p">(</span><span class="s">&quot;get_txd_mb: mb = 0x%x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">mb</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">mb</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	SMT Send function</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">smt_send_mbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">far</span> <span class="o">*</span><span class="n">data</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">len</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">n</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">frag_count</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">frame_status</span> <span class="p">;</span>
	<span class="n">SK_LOC_DECL</span><span class="p">(</span><span class="kt">char</span> <span class="n">far</span><span class="p">,</span><span class="o">*</span><span class="n">virt</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">frag_len</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_tx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">t</span> <span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">phys</span> <span class="p">;</span>
	<span class="n">__le32</span>	<span class="n">tbctrl</span><span class="p">;</span>

	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;THSB&quot;</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;smt_send_mbuf: mb = 0x%x, fc = 0x%x&quot;</span><span class="p">,</span><span class="n">mb</span><span class="p">,</span><span class="n">fc</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_off</span><span class="o">--</span> <span class="p">;</span>	<span class="cm">/* set to fc */</span>
	<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span><span class="o">++</span> <span class="p">;</span>	<span class="cm">/* + fc */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">smtod</span><span class="p">(</span><span class="n">mb</span><span class="p">,</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">;</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">fc</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">==</span> <span class="n">FC_SMT_LOC</span><span class="p">)</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">FC_SMT_INFO</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * determine the frag count and the virt addresses of the frags</span>
<span class="cm">	 */</span>
	<span class="n">frag_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span> <span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">SMT_PAGESIZE</span> <span class="o">-</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SMT_PAGESIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">len</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;frag: virt/len = 0x%x/%d &quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">virt</span><span class="p">[</span><span class="n">frag_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="p">;</span>
		<span class="n">frag_len</span><span class="p">[</span><span class="n">frag_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="p">;</span>
		<span class="n">frag_count</span><span class="o">++</span> <span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="n">n</span> <span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">n</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * determine the frame status</span>
<span class="cm">	 */</span>
	<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">QUEUE_A0</span><span class="p">]</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">==</span> <span class="n">FC_BEACON</span> <span class="o">||</span> <span class="n">fc</span> <span class="o">==</span> <span class="n">FC_SMT_LOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame_status</span> <span class="o">=</span> <span class="n">LOC_TX</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">frame_status</span> <span class="o">=</span> <span class="n">LAN_TX</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_NSA</span> <span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">fc</span> <span class="o">==</span> <span class="n">FC_SMT_NSA</span><span class="p">))</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">os</span><span class="p">.</span><span class="n">hwm</span><span class="p">.</span><span class="n">pass_SMT</span> <span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">fc</span> <span class="o">==</span> <span class="n">FC_SMT_INFO</span><span class="p">)))</span>
			<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">LOC_TX</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">mac_ring_is_up</span> <span class="o">||</span> <span class="n">frag_count</span> <span class="o">&gt;</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">LAN_TX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;Ring is down: terminate LAN_TX&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;Ring is down: terminate transmission&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">return</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;frame_status = 0x%x &quot;</span><span class="p">,</span><span class="n">frame_status</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">LAN_TX</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">LOC_TX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_use_count</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">LAN_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_put</span> <span class="p">;</span>
		<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">FIRST_FRAG</span> <span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frag_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;init TxD = 0x%x&quot;</span><span class="p">,(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">frag_count</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frame_status</span> <span class="o">|=</span> <span class="n">LAST_FRAG</span> <span class="p">;</span>
				<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_txdscr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">TX_DESCRIPTOR</span> <span class="o">|</span>
					<span class="p">(((</span><span class="n">__u32</span><span class="p">)(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">sm_len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">))</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_virt</span> <span class="o">=</span> <span class="n">virt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">;</span>
			<span class="n">phys</span> <span class="o">=</span> <span class="n">dma_master</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">far</span> <span class="o">*</span><span class="p">)</span><span class="n">virt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">frag_len</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">DMA_RD</span><span class="o">|</span><span class="n">SMT_BUF</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_tbadr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">phys</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">tbctrl</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">((((</span><span class="n">__u32</span><span class="p">)</span><span class="n">frame_status</span> <span class="o">&amp;</span>
				<span class="p">(</span><span class="n">FIRST_FRAG</span><span class="o">|</span><span class="n">LAST_FRAG</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">BMU_OWN</span> <span class="o">|</span> <span class="n">BMU_CHECK</span> <span class="o">|</span> <span class="n">BMU_SMT_TX</span> <span class="o">|</span><span class="n">frag_len</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_tbctrl</span> <span class="o">=</span> <span class="n">tbctrl</span> <span class="p">;</span>
<span class="cp">#ifndef	AIX</span>
			<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_bmu_ctl</span><span class="p">,</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B0_XA_CSR</span><span class="p">),</span><span class="n">CSR_START</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
			<span class="n">frame_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIRST_FRAG</span> <span class="p">;</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_put</span> <span class="o">=</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_next</span> <span class="p">;</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="o">--</span> <span class="p">;</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_used</span><span class="o">++</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="n">MAC0</span><span class="p">].</span><span class="n">fddiMACTransmit_Ct</span><span class="o">++</span> <span class="p">;</span>
		<span class="n">queue_txd_mb</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">LOC_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;pass Mbuf to LLC queue&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">queue_llc_rx</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to unqueue the free SMT_MBUFs here, because it may</span>
<span class="cm">	 * be that the SMT want&#39;s to send more than 1 frame for one down call</span>
<span class="cm">	 */</span>
	<span class="n">mac_drv_clear_txd</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;THSE&quot;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span><span class="p">,</span><span class="n">frag_count</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*	BEGIN_MANUAL_ENTRY(mac_drv_clear_txd)</span>
<span class="cm"> *	void mac_drv_clear_txd(smc)</span>
<span class="cm"> *</span>
<span class="cm"> * function	DOWNCALL	(hardware module, hwmtm.c)</span>
<span class="cm"> *		mac_drv_clear_txd searches in both send queues for TxD&#39;s</span>
<span class="cm"> *		which were finished by the adapter. It calls dma_complete</span>
<span class="cm"> *		for each TxD. If the last fragment of an LLC frame is</span>
<span class="cm"> *		reached, it calls mac_drv_tx_complete to release the</span>
<span class="cm"> *		send buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * return	nothing</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">mac_drv_clear_txd</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_tx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">t1</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">t2</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">;</span>
	<span class="n">SMbuf</span> <span class="o">*</span><span class="n">mb</span> <span class="p">;</span>
	<span class="n">u_long</span>	<span class="n">tbctrl</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_count</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="p">;</span>

	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;THcB&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">QUEUE_S</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">QUEUE_A0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">;</span>
		<span class="n">t1</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="p">;</span>
		<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;clear_txd: QUEUE = %d (0=sync/1=async)&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">frag_count</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;check OWN/EOF bit of TxD 0x%x&quot;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">tbctrl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">CR_READ</span><span class="p">(</span><span class="n">t1</span><span class="o">-&gt;</span><span class="n">txd_tbctrl</span><span class="p">));</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">tbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_OWN</span> <span class="o">||</span> <span class="o">!</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_used</span><span class="p">){</span>
					<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;End of TxDs queue %d&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
					<span class="k">goto</span> <span class="n">free_next_queue</span> <span class="p">;</span>	<span class="cm">/* next queue */</span>
				<span class="p">}</span>
				<span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span><span class="o">-&gt;</span><span class="n">txd_next</span> <span class="p">;</span>
				<span class="n">frag_count</span><span class="o">++</span> <span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_EOF</span><span class="p">))</span> <span class="p">;</span>

			<span class="n">t1</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="n">frag_count</span><span class="p">;</span> <span class="n">n</span><span class="p">;</span> <span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tbctrl</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">t1</span><span class="o">-&gt;</span><span class="n">txd_tbctrl</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">dma_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span>
					<span class="p">(</span><span class="k">union</span> <span class="n">s_fp_descr</span> <span class="k">volatile</span> <span class="o">*</span><span class="p">)</span> <span class="n">t1</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">DMA_RD</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">tbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_SMT_TX</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)))</span> <span class="p">;</span>
				<span class="n">t2</span> <span class="o">=</span> <span class="n">t1</span> <span class="p">;</span>
				<span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span><span class="o">-&gt;</span><span class="n">txd_next</span> <span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tbctrl</span> <span class="o">&amp;</span> <span class="n">BMU_SMT_TX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mb</span> <span class="o">=</span> <span class="n">get_txd_mb</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">smt_free_mbuf</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">mb</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifndef PASS_1ST_TXD_2_TX_COMP</span>
				<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;mac_drv_tx_comp for TxD 0x%x&quot;</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">mac_drv_tx_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#else</span>
				<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;mac_drv_tx_comp for TxD 0x%x&quot;</span><span class="p">,</span>
					<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">mac_drv_tx_complete</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
			<span class="p">}</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="o">=</span> <span class="n">t1</span> <span class="p">;</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_free</span> <span class="o">+=</span> <span class="n">frag_count</span> <span class="p">;</span>
			<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_used</span> <span class="o">-=</span> <span class="n">frag_count</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="nl">free_next_queue:</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">NDD_TRACE</span><span class="p">(</span><span class="s">&quot;THcE&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	BEGINN_MANUAL_ENTRY(mac_drv_clear_tx_queue)</span>
<span class="cm"> *</span>
<span class="cm"> * void mac_drv_clear_tx_queue(smc)</span>
<span class="cm"> * struct s_smc *smc ;</span>
<span class="cm"> *</span>
<span class="cm"> * function	DOWNCALL	(hardware module, hwmtm.c)</span>
<span class="cm"> *		mac_drv_clear_tx_queue is called from the SMT when</span>
<span class="cm"> *		the RMT state machine has entered the ISOLATE state.</span>
<span class="cm"> *		This function is also called by the os-specific module</span>
<span class="cm"> *		after it has called the function card_stop().</span>
<span class="cm"> *		In this case, the frames in the send queues are obsolete and</span>
<span class="cm"> *		should be removed.</span>
<span class="cm"> *</span>
<span class="cm"> * note		calling sequence:</span>
<span class="cm"> *		CLI_FBI(), card_stop(),</span>
<span class="cm"> *		mac_drv_clear_tx_queue(), mac_drv_clear_rx_queue(),</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:	The caller is responsible that the BMUs are idle</span>
<span class="cm"> *		when this function is called.</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_drv_clear_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_smt_fp_txd</span> <span class="k">volatile</span> <span class="o">*</span><span class="n">t</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_smt_tx_queue</span> <span class="o">*</span><span class="n">queue</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_used</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">hw_state</span> <span class="o">!=</span> <span class="n">STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SK_BREAK</span><span class="p">()</span> <span class="p">;</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">HWM_E0011</span><span class="p">,</span><span class="n">HWM_E0011_MSG</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">QUEUE_S</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">QUEUE_A0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">;</span>
		<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;clear_tx_queue: QUEUE = %d (0=sync/1=async)&quot;</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * switch the OWN bit of all pending frames to the host</span>
<span class="cm">		 */</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="p">;</span>
		<span class="n">tx_used</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_used</span> <span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">tx_used</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORCPU</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">DB_TX</span><span class="p">(</span><span class="s">&quot;switch OWN bit of TxD 0x%x &quot;</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_tbctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BMU_OWN</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">DRV_BUF_FLUSH</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">DDI_DMA_SYNC_FORDEV</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_next</span> <span class="p">;</span>
			<span class="n">tx_used</span><span class="o">--</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * release all TxD&#39;s for both send queues</span>
<span class="cm">	 */</span>
	<span class="n">mac_drv_clear_txd</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">QUEUE_S</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">QUEUE_A0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">fp</span><span class="p">.</span><span class="n">tx</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">;</span>
		<span class="n">t</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * write the phys pointer of the NEXT descriptor into the</span>
<span class="cm">		 * BMU&#39;s current address descriptor pointer and set</span>
<span class="cm">		 * tx_curr_get and tx_curr_put to this position</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">QUEUE_S</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XS_DA</span><span class="p">),</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_ntdadr</span><span class="p">))</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">outpd</span><span class="p">(</span><span class="n">ADDR</span><span class="p">(</span><span class="n">B5_XA_DA</span><span class="p">),</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">txd_ntdadr</span><span class="p">))</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_put</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span><span class="o">-&gt;</span><span class="n">txd_next</span> <span class="p">;</span>
		<span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_get</span> <span class="o">=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">tx_curr_put</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">	TEST FUNCTIONS:</span>
<span class="cm">	-------------------------------------------------------------</span>
<span class="cm">*/</span>

<span class="cp">#ifdef	DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> *	BEGIN_MANUAL_ENTRY(mac_drv_debug_lev)</span>
<span class="cm"> *	void mac_drv_debug_lev(smc,flag,lev)</span>
<span class="cm"> *</span>
<span class="cm"> * function	DOWNCALL	(drvsr.c)</span>
<span class="cm"> *		To get a special debug info the user can assign a debug level</span>
<span class="cm"> *		to any debug flag.</span>
<span class="cm"> *</span>
<span class="cm"> * para	flag	debug flag, possible values are:</span>
<span class="cm"> *			= 0:	reset all debug flags (the defined level is</span>
<span class="cm"> *				ignored)</span>
<span class="cm"> *			= 1:	debug.d_smtf</span>
<span class="cm"> *			= 2:	debug.d_smt</span>
<span class="cm"> *			= 3:	debug.d_ecm</span>
<span class="cm"> *			= 4:	debug.d_rmt</span>
<span class="cm"> *			= 5:	debug.d_cfm</span>
<span class="cm"> *			= 6:	debug.d_pcm</span>
<span class="cm"> *</span>
<span class="cm"> *			= 10:	debug.d_os.hwm_rx (hardware module receive path)</span>
<span class="cm"> *			= 11:	debug.d_os.hwm_tx(hardware module transmit path)</span>
<span class="cm"> *			= 12:	debug.d_os.hwm_gen(hardware module general flag)</span>
<span class="cm"> *</span>
<span class="cm"> *	lev	debug level</span>
<span class="cm"> *</span>
<span class="cm"> *	END_MANUAL_ENTRY</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">mac_drv_debug_lev</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="nb">NULL</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_smtf</span> <span class="o">=</span> <span class="n">DB_P</span><span class="p">.</span><span class="n">d_smt</span> <span class="o">=</span> <span class="n">DB_P</span><span class="p">.</span><span class="n">d_ecm</span> <span class="o">=</span> <span class="n">DB_P</span><span class="p">.</span><span class="n">d_rmt</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_cfm</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_os</span><span class="p">.</span><span class="n">hwm_rx</span> <span class="o">=</span> <span class="n">DB_P</span><span class="p">.</span><span class="n">d_os</span><span class="p">.</span><span class="n">hwm_tx</span> <span class="o">=</span> <span class="n">DB_P</span><span class="p">.</span><span class="n">d_os</span><span class="p">.</span><span class="n">hwm_gen</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="cp">#ifdef	SBA</span>
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_sba</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	ESS</span>
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_ess</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DEBUG_SMTF</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_smtf</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DEBUG_SMT</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_smt</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DEBUG_ECM</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_ecm</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DEBUG_RMT</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_rmt</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DEBUG_CFM</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_cfm</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DEBUG_PCM</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_pcm</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DEBUG_SBA</span>:
<span class="cp">#ifdef	SBA</span>
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_sba</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DEBUG_ESS</span>:
<span class="cp">#ifdef	ESS</span>
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_ess</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_HWM_RX</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_os</span><span class="p">.</span><span class="n">hwm_rx</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_HWM_TX</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_os</span><span class="p">.</span><span class="n">hwm_tx</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">DB_HWM_GEN</span>:
		<span class="n">DB_P</span><span class="p">.</span><span class="n">d_os</span><span class="p">.</span><span class="n">hwm_gen</span> <span class="o">=</span> <span class="n">lev</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
