<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › fddi › skfp › pcmplc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pcmplc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *	(C)Copyright 1998,1999 SysKonnect,</span>
<span class="cm"> *	a business unit of Schneider &amp; Koch &amp; Co. Datensysteme GmbH.</span>
<span class="cm"> *</span>
<span class="cm"> *	See the file &quot;skfddi.c&quot; for further information.</span>
<span class="cm"> *</span>
<span class="cm"> *	This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *	it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *	the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *	(at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *	The information in this file is provided &quot;AS IS&quot; without warranty.</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm">	PCM</span>
<span class="cm">	Physical Connection Management</span>
<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm"> * Hardware independent state machine implemantation</span>
<span class="cm"> * The following external SMT functions are referenced :</span>
<span class="cm"> *</span>
<span class="cm"> * 		queue_event()</span>
<span class="cm"> * 		smt_timer_start()</span>
<span class="cm"> * 		smt_timer_stop()</span>
<span class="cm"> *</span>
<span class="cm"> * 	The following external HW dependent functions are referenced :</span>
<span class="cm"> * 		sm_pm_control()</span>
<span class="cm"> *		sm_ph_linestate()</span>
<span class="cm"> *		sm_pm_ls_latch()</span>
<span class="cm"> *</span>
<span class="cm"> * 	The following HW dependent events are required :</span>
<span class="cm"> *		PC_QLS</span>
<span class="cm"> *		PC_ILS</span>
<span class="cm"> *		PC_HLS</span>
<span class="cm"> *		PC_MLS</span>
<span class="cm"> *		PC_NSE</span>
<span class="cm"> *		PC_LEM</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &quot;h/types.h&quot;</span>
<span class="cp">#include &quot;h/fddi.h&quot;</span>
<span class="cp">#include &quot;h/smc.h&quot;</span>
<span class="cp">#include &quot;h/supern_2.h&quot;</span>
<span class="cp">#define KERNEL</span>
<span class="cp">#include &quot;h/smtstate.h&quot;</span>

<span class="cp">#ifndef	lint</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ID_sccs</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;@(#)pcmplc.c	2.55 99/08/05 (C) SK &quot;</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	FDDI_MIB</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">snmp_fddi_trap</span><span class="p">(</span>
<span class="cp">#ifdef	ANSIC</span>
<span class="k">struct</span> <span class="n">s_smc</span>	<span class="o">*</span> <span class="n">smc</span><span class="p">,</span> <span class="kt">int</span>  <span class="n">type</span><span class="p">,</span> <span class="kt">int</span>  <span class="n">index</span>
<span class="cp">#endif</span>
<span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="nf">plc_is_installed</span><span class="p">(</span>
<span class="cp">#ifdef	ANSIC</span>
<span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span> <span class="p">,</span>
<span class="kt">int</span> <span class="n">p</span>
<span class="cp">#endif</span>
<span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cm">/*</span>
<span class="cm"> * FSM Macros</span>
<span class="cm"> */</span>
<span class="cp">#define AFLAG		(0x20)</span>
<span class="cp">#define GO_STATE(x)	(mib-&gt;fddiPORTPCMState = (x)|AFLAG)</span>
<span class="cp">#define ACTIONS_DONE()	(mib-&gt;fddiPORTPCMState &amp;= ~AFLAG)</span>
<span class="cp">#define ACTIONS(x)	(x|AFLAG)</span>

<span class="cm">/*</span>
<span class="cm"> * PCM states</span>
<span class="cm"> */</span>
<span class="cp">#define PC0_OFF			0</span>
<span class="cp">#define PC1_BREAK		1</span>
<span class="cp">#define PC2_TRACE		2</span>
<span class="cp">#define PC3_CONNECT		3</span>
<span class="cp">#define PC4_NEXT		4</span>
<span class="cp">#define PC5_SIGNAL		5</span>
<span class="cp">#define PC6_JOIN		6</span>
<span class="cp">#define PC7_VERIFY		7</span>
<span class="cp">#define PC8_ACTIVE		8</span>
<span class="cp">#define PC9_MAINT		9</span>

<span class="cp">#ifdef	DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * symbolic state names</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">pcm_states</span><span class="p">[]</span> <span class="o">=</span>  <span class="p">{</span>
	<span class="s">&quot;PC0_OFF&quot;</span><span class="p">,</span><span class="s">&quot;PC1_BREAK&quot;</span><span class="p">,</span><span class="s">&quot;PC2_TRACE&quot;</span><span class="p">,</span><span class="s">&quot;PC3_CONNECT&quot;</span><span class="p">,</span><span class="s">&quot;PC4_NEXT&quot;</span><span class="p">,</span>
	<span class="s">&quot;PC5_SIGNAL&quot;</span><span class="p">,</span><span class="s">&quot;PC6_JOIN&quot;</span><span class="p">,</span><span class="s">&quot;PC7_VERIFY&quot;</span><span class="p">,</span><span class="s">&quot;PC8_ACTIVE&quot;</span><span class="p">,</span><span class="s">&quot;PC9_MAINT&quot;</span>
<span class="p">}</span> <span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * symbolic event names</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">pcm_events</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;NONE&quot;</span><span class="p">,</span><span class="s">&quot;PC_START&quot;</span><span class="p">,</span><span class="s">&quot;PC_STOP&quot;</span><span class="p">,</span><span class="s">&quot;PC_LOOP&quot;</span><span class="p">,</span><span class="s">&quot;PC_JOIN&quot;</span><span class="p">,</span><span class="s">&quot;PC_SIGNAL&quot;</span><span class="p">,</span>
	<span class="s">&quot;PC_REJECT&quot;</span><span class="p">,</span><span class="s">&quot;PC_MAINT&quot;</span><span class="p">,</span><span class="s">&quot;PC_TRACE&quot;</span><span class="p">,</span><span class="s">&quot;PC_PDR&quot;</span><span class="p">,</span>
	<span class="s">&quot;PC_ENABLE&quot;</span><span class="p">,</span><span class="s">&quot;PC_DISABLE&quot;</span><span class="p">,</span>
	<span class="s">&quot;PC_QLS&quot;</span><span class="p">,</span><span class="s">&quot;PC_ILS&quot;</span><span class="p">,</span><span class="s">&quot;PC_MLS&quot;</span><span class="p">,</span><span class="s">&quot;PC_HLS&quot;</span><span class="p">,</span><span class="s">&quot;PC_LS_PDR&quot;</span><span class="p">,</span><span class="s">&quot;PC_LS_NONE&quot;</span><span class="p">,</span>
	<span class="s">&quot;PC_TIMEOUT_TB_MAX&quot;</span><span class="p">,</span><span class="s">&quot;PC_TIMEOUT_TB_MIN&quot;</span><span class="p">,</span>
	<span class="s">&quot;PC_TIMEOUT_C_MIN&quot;</span><span class="p">,</span><span class="s">&quot;PC_TIMEOUT_T_OUT&quot;</span><span class="p">,</span>
	<span class="s">&quot;PC_TIMEOUT_TL_MIN&quot;</span><span class="p">,</span><span class="s">&quot;PC_TIMEOUT_T_NEXT&quot;</span><span class="p">,</span><span class="s">&quot;PC_TIMEOUT_LCT&quot;</span><span class="p">,</span>
	<span class="s">&quot;PC_NSE&quot;</span><span class="p">,</span><span class="s">&quot;PC_LEM&quot;</span>
<span class="p">}</span> <span class="p">;</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef	MOT_ELM</span>
<span class="cm">/*</span>
<span class="cm"> * PCL-S control register</span>
<span class="cm"> * this register in the PLC-S controls the scrambling parameters</span>
<span class="cm"> */</span>
<span class="cp">#define PLCS_CONTROL_C_U	0</span>
<span class="cp">#define PLCS_CONTROL_C_S	(PL_C_SDOFF_ENABLE | PL_C_SDON_ENABLE | \</span>
<span class="cp">				 PL_C_CIPHER_ENABLE)</span>
<span class="cp">#define	PLCS_FASSERT_U		0</span>
<span class="cp">#define	PLCS_FASSERT_S		0xFd76	</span><span class="cm">/* 52.0 us */</span><span class="cp"></span>
<span class="cp">#define	PLCS_FDEASSERT_U	0</span>
<span class="cp">#define	PLCS_FDEASSERT_S	0</span>
<span class="cp">#else	</span><span class="cm">/* nMOT_ELM */</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm"> * PCL-S control register</span>
<span class="cm"> * this register in the PLC-S controls the scrambling parameters</span>
<span class="cm"> * can be patched for ANSI compliance if standard changes</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u_char</span> <span class="n">plcs_control_c_u</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;PLC_CNTRL_C_U=</span><span class="se">\0\0</span><span class="s">&quot;</span> <span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u_char</span> <span class="n">plcs_control_c_s</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;PLC_CNTRL_C_S=</span><span class="se">\01\02</span><span class="s">&quot;</span> <span class="p">;</span>

<span class="cp">#define PLCS_CONTROL_C_U (plcs_control_c_u[14] | (plcs_control_c_u[15]&lt;&lt;8))</span>
<span class="cp">#define PLCS_CONTROL_C_S (plcs_control_c_s[14] | (plcs_control_c_s[15]&lt;&lt;8))</span>
<span class="cp">#endif	</span><span class="cm">/* nMOT_ELM */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * external vars</span>
<span class="cm"> */</span>
<span class="cm">/* struct definition see &#39;cmtdef.h&#39; (also used by CFM) */</span>

<span class="cp">#define PS_OFF		0</span>
<span class="cp">#define PS_BIT3		1</span>
<span class="cp">#define PS_BIT4		2</span>
<span class="cp">#define PS_BIT7		3</span>
<span class="cp">#define PS_LCT		4</span>
<span class="cp">#define PS_BIT8		5</span>
<span class="cp">#define PS_JOIN		6</span>
<span class="cp">#define PS_ACTIVE	7</span>

<span class="cp">#define LCT_LEM_MAX	255</span>

<span class="cm">/*</span>
<span class="cm"> * PLC timing parameter</span>
<span class="cm"> */</span>

<span class="cp">#define PLC_MS(m)	((int)((0x10000L-(m*100000L/2048))))</span>
<span class="cp">#define SLOW_TL_MIN	PLC_MS(6)</span>
<span class="cp">#define SLOW_C_MIN	PLC_MS(10)</span>

<span class="k">static</span>	<span class="k">const</span> <span class="k">struct</span> <span class="n">plt</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">timer</span> <span class="p">;</span>			<span class="cm">/* relative plc timer address */</span>
	<span class="kt">int</span>	<span class="n">para</span> <span class="p">;</span>			<span class="cm">/* default timing parameters */</span>
<span class="p">}</span> <span class="n">pltm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PL_C_MIN</span><span class="p">,</span> <span class="n">SLOW_C_MIN</span> <span class="p">},</span>	<span class="cm">/* min t. to remain Connect State */</span>
	<span class="p">{</span> <span class="n">PL_TL_MIN</span><span class="p">,</span> <span class="n">SLOW_TL_MIN</span> <span class="p">},</span>	<span class="cm">/* min t. to transmit a Line State */</span>
	<span class="p">{</span> <span class="n">PL_TB_MIN</span><span class="p">,</span> <span class="n">TP_TB_MIN</span> <span class="p">},</span>	<span class="cm">/* min break time */</span>
	<span class="p">{</span> <span class="n">PL_T_OUT</span><span class="p">,</span> <span class="n">TP_T_OUT</span> <span class="p">},</span>		<span class="cm">/* Signaling timeout */</span>
	<span class="p">{</span> <span class="n">PL_LC_LENGTH</span><span class="p">,</span> <span class="n">TP_LC_LENGTH</span> <span class="p">},</span>	<span class="cm">/* Link Confidence Test Time */</span>
	<span class="p">{</span> <span class="n">PL_T_SCRUB</span><span class="p">,</span> <span class="n">TP_T_SCRUB</span> <span class="p">},</span>	<span class="cm">/* Scrub Time == MAC TVX time ! */</span>
	<span class="p">{</span> <span class="n">PL_NS_MAX</span><span class="p">,</span> <span class="n">TP_NS_MAX</span> <span class="p">},</span>	<span class="cm">/* max t. that noise is tolerated */</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span> <span class="p">}</span>
<span class="p">}</span> <span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * interrupt mask</span>
<span class="cm"> */</span>
<span class="cp">#ifdef	SUPERNET_3</span>
<span class="cm">/*</span>
<span class="cm"> * Do we need the EBUF error during signaling, too, to detect SUPERNET_3</span>
<span class="cm"> * PLL bug?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">plc_imsk_na</span> <span class="o">=</span> <span class="n">PL_PCM_CODE</span> <span class="o">|</span> <span class="n">PL_TRACE_PROP</span> <span class="o">|</span> <span class="n">PL_PCM_BREAK</span> <span class="o">|</span>
			<span class="n">PL_PCM_ENABLED</span> <span class="o">|</span> <span class="n">PL_SELF_TEST</span> <span class="o">|</span> <span class="n">PL_EBUF_ERR</span><span class="p">;</span>
<span class="cp">#else	</span><span class="cm">/* SUPERNET_3 */</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm"> * We do NOT need the elasticity buffer error during signaling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">plc_imsk_na</span> <span class="o">=</span> <span class="n">PL_PCM_CODE</span> <span class="o">|</span> <span class="n">PL_TRACE_PROP</span> <span class="o">|</span> <span class="n">PL_PCM_BREAK</span> <span class="o">|</span>
			<span class="n">PL_PCM_ENABLED</span> <span class="o">|</span> <span class="n">PL_SELF_TEST</span> <span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* SUPERNET_3 */</span><span class="cp"></span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">plc_imsk_act</span> <span class="o">=</span> <span class="n">PL_PCM_CODE</span> <span class="o">|</span> <span class="n">PL_TRACE_PROP</span> <span class="o">|</span> <span class="n">PL_PCM_BREAK</span> <span class="o">|</span>
			<span class="n">PL_PCM_ENABLED</span> <span class="o">|</span> <span class="n">PL_SELF_TEST</span> <span class="o">|</span> <span class="n">PL_EBUF_ERR</span><span class="p">;</span>

<span class="cm">/* internal functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pcm_fsm</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pc_rcode_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pc_tcode_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">reset_lem_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">plc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sm_ph_lem_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">threshold</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sm_ph_lem_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sm_ph_linestate</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ls</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">real_init_plc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * SMT timer interface</span>
<span class="cm"> *      start PCM timer 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_pcm_timer0</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="n">u_long</span> <span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">timer0_exp</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>       <span class="cm">/* clear timer event flag */</span>
	<span class="n">smt_timer_start</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pcm_timer0</span><span class="p">,</span><span class="n">value</span><span class="p">,</span>
		<span class="n">EV_TOKEN</span><span class="p">(</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">,</span><span class="n">event</span><span class="p">))</span> <span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * SMT timer interface</span>
<span class="cm"> *      stop PCM timer 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">stop_pcm_timer0</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pcm_timer0</span><span class="p">.</span><span class="n">tm_active</span><span class="p">)</span>
		<span class="n">smt_timer_stop</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pcm_timer0</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	init PCM state machine (called by driver)</span>
<span class="cm">	clear all PCM vars and flags</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">pcm_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span>		<span class="n">np</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_phy</span>	<span class="o">*</span><span class="n">phy</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">phy</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="p">;</span> <span class="n">np</span> <span class="o">&lt;</span> <span class="n">NUMPHYS</span> <span class="p">;</span> <span class="n">np</span><span class="o">++</span><span class="p">,</span><span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Indicates the type of PHY being used */</span>
		<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">=</span> <span class="n">ACTIONS</span><span class="p">(</span><span class="n">PC0_OFF</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span> <span class="o">=</span> <span class="n">np</span> <span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
		<span class="k">case</span> <span class="n">SMT_SAS</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TS</span> <span class="o">:</span> <span class="n">TM</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_DAS</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PA</span><span class="p">)</span> <span class="o">?</span> <span class="n">TA</span> <span class="o">:</span>
					<span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PB</span><span class="p">)</span> <span class="o">?</span> <span class="n">TB</span> <span class="o">:</span> <span class="n">TM</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_NAC</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">=</span> <span class="n">TM</span> <span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="k">case</span> <span class="n">SMT_SAS</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TS</span> <span class="o">:</span> <span class="n">TNONE</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTHardwarePresent</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PS</span><span class="p">)</span> <span class="o">?</span> <span class="n">TRUE</span> <span class="o">:</span>
					<span class="n">FALSE</span> <span class="p">;</span>
<span class="cp">#ifndef	SUPERNET_3</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PA</span><span class="p">].</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">=</span> <span class="n">PC0_OFF</span> <span class="p">;</span>
<span class="cp">#else</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PB</span><span class="p">].</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">=</span> <span class="n">PC0_OFF</span> <span class="p">;</span>
<span class="cp">#endif</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_DAS</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PB</span><span class="p">)</span> <span class="o">?</span> <span class="n">TB</span> <span class="o">:</span> <span class="n">TA</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * set PMD-type</span>
<span class="cm">		 */</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pmd_scramble</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pmd_type</span><span class="p">[</span><span class="n">PMD_SK_PMD</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="sc">&#39;P&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_MULTI</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;L&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_LCF</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;D&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_TP</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;S&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_TP</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pmd_scramble</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;U&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_TP</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pmd_scramble</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;1&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_SINGLE1</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;2&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_SINGLE2</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;3&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_SINGLE2</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;4&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_SINGLE1</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;H&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_UNKNOWN</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;I&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_TP</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="sc">&#39;G&#39;</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_TP</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPMDClass</span> <span class="o">=</span> <span class="n">MIB_PMDCLASS_UNKNOWN</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * A and B port can be on primary and secondary path</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TA</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTAvailablePaths</span> <span class="o">|=</span> <span class="n">MIB_PATH_S</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIB_P_PATH_LOCAL</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">MIB_P_PATH_LOCAL</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_CON_ALTER</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_SEC_PREFER</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">MIB_P_PATH_LOCAL</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_CON_ALTER</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_SEC_PREFER</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_THRU</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">TB</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTAvailablePaths</span> <span class="o">|=</span> <span class="n">MIB_PATH_S</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIB_P_PATH_LOCAL</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">MIB_P_PATH_LOCAL</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_PRIM_PREFER</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">MIB_P_PATH_LOCAL</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_PRIM_PREFER</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_CON_PREFER</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_THRU</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">TS</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTAvailablePaths</span> <span class="o">|=</span> <span class="n">MIB_PATH_S</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIB_P_PATH_LOCAL</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">MIB_P_PATH_LOCAL</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_CON_ALTER</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_PRIM_PREFER</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">MIB_P_PATH_LOCAL</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_CON_ALTER</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_PRIM_PREFER</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">TM</span> :
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">MIB_P_PATH_LOCAL</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">MIB_P_PATH_LOCAL</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_SEC_ALTER</span> <span class="o">|</span>
				<span class="n">MIB_P_PATH_PRIM_ALTER</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTRequestedPaths</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMStateX</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLCTFail_Ct</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTBS_Flag</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTCurrentPath</span> <span class="o">=</span> <span class="n">MIB_PATH_ISOLATED</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">=</span> <span class="n">TNONE</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ls_flag</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rc_flag</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">tc_flag</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">td_flag</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;=</span> <span class="n">PM</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="n">np</span> <span class="o">-</span> <span class="n">PM</span> <span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span> <span class="o">+</span> <span class="n">np</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">wc_flag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>		<span class="cm">/* set by SMT */</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lem</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lem_counter</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">reset_lem_struct</span><span class="p">(</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">memset</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">plc</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_plc</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">plc</span><span class="p">.</span><span class="n">p_state</span> <span class="o">=</span> <span class="n">PS_OFF</span> <span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMBITS</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">real_init_plc</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">init_plc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * dummy</span>
<span class="cm">	 * this is an obsolete public entry point that has to remain</span>
<span class="cm">	 * for compat. It is used by various drivers.</span>
<span class="cm">	 * the work is now done in real_init_plc()</span>
<span class="cm">	 * which is called from pcm_init() ;</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">real_init_plc</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">p</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">NUMPHYS</span> <span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span>
		<span class="n">plc_init</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">plc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>
<span class="cp">#ifndef	MOT_ELM</span>
	<span class="kt">int</span>	<span class="n">rev</span> <span class="p">;</span>	<span class="cm">/* Revision of PLC-x */</span>
<span class="cp">#endif	</span><span class="cm">/* MOT_ELM */</span><span class="cp"></span>

	<span class="cm">/* transit PCM state machine to MAINT state */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_PCM_STOP</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_CNTRL_A</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * if PLC-S then set control register C</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef	MOT_ELM</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_STATUS_A</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PLC_REV_MASK</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">!=</span> <span class="n">PLC_REVISION_A</span><span class="p">)</span>
<span class="cp">#endif	</span><span class="cm">/* MOT_ELM */</span><span class="cp"></span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">pmd_scramble</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_CNTRL_C</span><span class="p">),</span><span class="n">PLCS_CONTROL_C_S</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifdef	MOT_ELM</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_T_FOT_ASS</span><span class="p">),</span><span class="n">PLCS_FASSERT_S</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_T_FOT_DEASS</span><span class="p">),</span><span class="n">PLCS_FDEASSERT_S</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* MOT_ELM */</span><span class="cp"></span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_CNTRL_C</span><span class="p">),</span><span class="n">PLCS_CONTROL_C_U</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifdef	MOT_ELM</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_T_FOT_ASS</span><span class="p">),</span><span class="n">PLCS_FASSERT_U</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_T_FOT_DEASS</span><span class="p">),</span><span class="n">PLCS_FDEASSERT_U</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* MOT_ELM */</span><span class="cp"></span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * set timer register</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">pltm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timer</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>	<span class="cm">/* set timer parameter reg */</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">pltm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">timer</span><span class="p">),</span><span class="n">pltm</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">para</span><span class="p">)</span> <span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_INTR_EVENT</span><span class="p">))</span> <span class="p">;</span>	<span class="cm">/* clear interrupt event reg */</span>
	<span class="n">plc_clear_irq</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_INTR_MASK</span><span class="p">),</span><span class="n">plc_imsk_na</span><span class="p">);</span> <span class="cm">/* enable non active irq&#39;s */</span>

	<span class="cm">/*</span>
<span class="cm">	 * if PCM is configured for class s, it will NOT go to the</span>
<span class="cm">	 * REMOVE state if offline (page 3-36;)</span>
<span class="cm">	 * in the concentrator, all inactive PHYS always must be in</span>
<span class="cm">	 * the remove state</span>
<span class="cm">	 * there&#39;s no real need to use this feature at all ..</span>
<span class="cm">	 */</span>
<span class="cp">#ifndef	CONCENTRATOR</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_SAS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">PS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_CLASS_S</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * control PCM state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">plc_go_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HW_PTR</span> <span class="n">port</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">HW_PTR</span><span class="p">)</span> <span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">port</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">PL_PCM_CNTRL</span> <span class="o">|</span> <span class="n">PL_MAINT</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="n">val</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">port</span><span class="p">,</span><span class="n">val</span> <span class="o">|</span> <span class="n">state</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * read current line state (called by ECM &amp; PCM)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">sm_pm_get_ls</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">state</span> <span class="p">;</span>

<span class="cp">#ifdef	CONCENTRATOR</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plc_is_installed</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PC_QLS</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span><span class="n">PL_STATUS_A</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_LINE_ST</span> <span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PL_L_QLS</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">PC_QLS</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PL_L_MLS</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">PC_MLS</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PL_L_HLS</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">PC_HLS</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PL_L_ILS4</span>:
	<span class="k">case</span> <span class="n">PL_L_ILS16</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">PC_ILS</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PL_L_ALS</span>:
		<span class="n">state</span> <span class="o">=</span> <span class="n">PC_LS_PDR</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">default</span> <span class="o">:</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">PC_LS_NONE</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">plc_send_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">np</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span> <span class="p">;</span>		<span class="cm">/* PHY index */</span>
	<span class="kt">int</span>	<span class="n">n</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="cm">/* create bit vector */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_PCM_SIGNAL</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if	0</span><span class="c"></span>
<span class="c">		printf(&quot;PL_PCM_SIGNAL is set\n&quot;) ;</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* write bit[n] &amp; length = 1 to regs */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_VECTOR_LEN</span><span class="p">),</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* len=nr-1 */</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_XMIT_VECTOR</span><span class="p">),</span><span class="n">n</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#ifdef	DEBUG</span>
<span class="cp">#if 1</span>
<span class="cp">#ifdef	DEBUG_BRD</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">.</span><span class="n">d_plc</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">.</span><span class="n">d_plc</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
<span class="cp">#endif</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;SIGNALING bit %d .. %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span><span class="o">+</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * config plc muxes</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">plc_config_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">!=</span> <span class="n">SMT_DAS</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mux</span> <span class="o">==</span> <span class="n">MUX_WRAPB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">PA</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_CONFIG_CNTRL</span><span class="p">,</span><span class="n">PL_CONFIG_CNTRL</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">PA</span><span class="p">,</span><span class="n">PL_CNTRL_A</span><span class="p">),</span><span class="n">PL_SC_REM_LOOP</span><span class="p">,</span><span class="n">PL_SC_REM_LOOP</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">PA</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_CONFIG_CNTRL</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">PA</span><span class="p">,</span><span class="n">PL_CNTRL_A</span><span class="p">),</span><span class="n">PL_SC_REM_LOOP</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">PB</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_CONFIG_CNTRL</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">PB</span><span class="p">,</span><span class="n">PL_CNTRL_A</span><span class="p">),</span><span class="n">PL_SC_REM_LOOP</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	PCM state machine</span>
<span class="cm">	called by dispatcher  &amp; fddi_init() (driver)</span>
<span class="cm">	do</span>
<span class="cm">		display state change</span>
<span class="cm">		process event</span>
<span class="cm">	until SM is stable</span>
<span class="cm">*/</span>
<span class="kt">void</span> <span class="nf">pcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">state</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">oldstate</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_phy</span>	<span class="o">*</span><span class="n">phy</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>

<span class="cp">#ifndef	CONCENTRATOR</span>
	<span class="cm">/*</span>
<span class="cm">	 * ignore 2nd PHY if SAS</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">np</span> <span class="o">!=</span> <span class="n">PS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_SAS</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="p">]</span> <span class="p">;</span>
	<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>
	<span class="n">oldstate</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">DB_PCM</span><span class="p">(</span><span class="s">&quot;PCM %c: state %s&quot;</span><span class="p">,</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span><span class="p">,</span>
			<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">&amp;</span> <span class="n">AFLAG</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ACTIONS &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_PCM</span><span class="p">(</span><span class="s">&quot;%s, event %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pcm_states</span><span class="p">[</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AFLAG</span><span class="p">],</span>
			<span class="n">pcm_events</span><span class="p">[</span><span class="n">event</span><span class="p">])</span> <span class="p">;</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="p">;</span>
		<span class="n">pcm_fsm</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">,</span><span class="n">event</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">event</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span><span class="p">)</span> <span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * because the PLC does the bit signaling for us,</span>
<span class="cm">	 * we&#39;re always in SIGNAL state</span>
<span class="cm">	 * the MIB want&#39;s to see CONNECT</span>
<span class="cm">	 * we therefore fake an entry in the MIB</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">PC5_SIGNAL</span><span class="p">)</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMStateX</span> <span class="o">=</span> <span class="n">PC3_CONNECT</span> <span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMStateX</span> <span class="o">=</span> <span class="n">state</span> <span class="p">;</span>

<span class="cp">#ifndef	SLIM_SMT</span>
	<span class="cm">/*</span>
<span class="cm">	 * path change</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span>	<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">!=</span> <span class="n">oldstate</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">oldstate</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_EVENT_PORT_PATH_CHANGE</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">INDEX_PORT</span><span class="o">+</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef FDDI_MIB</span>
	<span class="cm">/* check whether a snmp-trap has to be sent */</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">!=</span> <span class="n">oldstate</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* a real state change took place */</span>
		<span class="n">DB_SNMP</span> <span class="p">(</span><span class="s">&quot;PCM from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oldstate</span><span class="p">,</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC0_OFF</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send first trap */</span>
			<span class="n">snmp_fddi_trap</span> <span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTIndex</span> <span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">oldstate</span> <span class="o">==</span> <span class="n">PC0_OFF</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send second trap */</span>
			<span class="n">snmp_fddi_trap</span> <span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTIndex</span> <span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">!=</span> <span class="n">PC2_TRACE</span> <span class="o">&amp;&amp;</span>
			<span class="n">oldstate</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send third trap */</span>
			<span class="n">snmp_fddi_trap</span> <span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTIndex</span> <span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send fourth trap */</span>
			<span class="n">snmp_fddi_trap</span> <span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTIndex</span> <span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">pcm_state_change</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,</span><span class="n">state</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PCM state machine</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcm_fsm</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">np</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span> <span class="p">;</span>		<span class="cm">/* PHY index */</span>
	<span class="k">struct</span> <span class="n">s_plc</span>	<span class="o">*</span><span class="n">plc</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>
<span class="cp">#ifndef	MOT_ELM</span>
	<span class="n">u_short</span>	<span class="n">plc_rev</span> <span class="p">;</span>		<span class="cm">/* Revision of the plc */</span>
<span class="cp">#endif	</span><span class="cm">/* nMOT_ELM */</span><span class="cp"></span>

	<span class="n">plc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">plc</span> <span class="p">;</span>
	<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * general transitions independent of state</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PC_STOP</span> :
		<span class="cm">/*PC00-PC80*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">!=</span> <span class="n">PC9_MAINT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC0_OFF</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">AIX_EVENT</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_RING_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span>
				<span class="n">FDDI_PORT_EVENT</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_PORT_STOP</span><span class="p">,</span>
				<span class="n">smt_get_port_event_word</span><span class="p">(</span><span class="n">smc</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC_START</span> :
		<span class="cm">/*PC01-PC81*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">!=</span> <span class="n">PC9_MAINT</span><span class="p">)</span>
			<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC1_BREAK</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC_DISABLE</span> :
		<span class="cm">/* PC09-PC99 */</span>
		<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC9_MAINT</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">AIX_EVENT</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_RING_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span>
			<span class="n">FDDI_PORT_EVENT</span><span class="p">,</span> <span class="p">(</span><span class="n">u_long</span><span class="p">)</span> <span class="n">FDDI_PORT_DISABLED</span><span class="p">,</span>
			<span class="n">smt_get_port_event_word</span><span class="p">(</span><span class="n">smc</span><span class="p">));</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC_TIMEOUT_LCT</span> :
		<span class="cm">/* if long or extended LCT */</span>
		<span class="n">stop_pcm_timer0</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_LONG</span><span class="p">)</span> <span class="p">;</span>
		<span class="cm">/* end of LCT is indicate by PCM_CODE (initiate PCM event) */</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ACTIONS</span><span class="p">(</span><span class="n">PC0_OFF</span><span class="p">)</span> :
		<span class="n">stop_pcm_timer0</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_A</span><span class="p">),</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_PC_JOIN</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_LONG</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">sm_ph_lem_stop</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* disable LEM */</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_loop</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_join</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_CFM</span><span class="p">,</span><span class="n">CF_JOIN</span><span class="o">+</span><span class="n">np</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">plc_go_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,</span><span class="n">PL_PCM_STOP</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTConnectState</span> <span class="o">=</span> <span class="n">PCM_DISABLED</span> <span class="p">;</span>
		<span class="n">ACTIONS_DONE</span><span class="p">()</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC0_OFF</span>:
		<span class="cm">/*PC09*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">PC_MAINT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC9_MAINT</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">ACTIONS</span><span class="p">(</span><span class="n">PC1_BREAK</span><span class="p">)</span> :
		<span class="cm">/* Stop the LCT timer if we came from Signal state */</span>
		<span class="n">stop_pcm_timer0</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">ACTIONS_DONE</span><span class="p">()</span> <span class="p">;</span>
		<span class="n">plc_go_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_PC_JOIN</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_LONG</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">sm_ph_lem_stop</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* disable LEM */</span>
		<span class="cm">/*</span>
<span class="cm">		 * if vector is already loaded, go to OFF to clear PCM_SIGNAL</span>
<span class="cm">		 */</span>
<span class="cp">#if	0</span><span class="c"></span>
<span class="c">		if (inpw(PLC(np,PL_STATUS_B)) &amp; PL_PCM_SIGNAL) {</span>
<span class="c">			plc_go_state(smc,np,PL_PCM_STOP) ;</span>
<span class="c">			/* TB_MIN ? */</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="cm">/*</span>
<span class="cm">		 * Go to OFF state in any case.</span>
<span class="cm">		 */</span>
		<span class="n">plc_go_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,</span><span class="n">PL_PCM_STOP</span><span class="p">)</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPC_Withhold</span> <span class="o">==</span> <span class="n">PC_WH_NONE</span><span class="p">)</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTConnectState</span> <span class="o">=</span> <span class="n">PCM_CONNECTING</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_loop</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_join</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_CFM</span><span class="p">,</span><span class="n">CF_JOIN</span><span class="o">+</span><span class="n">np</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ls_flag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_mode</span> <span class="o">=</span> <span class="n">PM_NONE</span> <span class="p">;</span>	<span class="cm">/* needed by CFM */</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>			<span class="cm">/* bit signaling start bit */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pc_tcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/* Set the non-active interrupt mask register */</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_INTR_MASK</span><span class="p">),</span><span class="n">plc_imsk_na</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the LCT was stopped. There might be a</span>
<span class="cm">		 * PCM_CODE interrupt event present.</span>
<span class="cm">		 * This must be cleared.</span>
<span class="cm">		 */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_INTR_EVENT</span><span class="p">))</span> <span class="p">;</span>
<span class="cp">#ifndef	MOT_ELM</span>
		<span class="cm">/* Get the plc revision for revision dependent code */</span>
		<span class="n">plc_rev</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_A</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PLC_REV_MASK</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">plc_rev</span> <span class="o">!=</span> <span class="n">PLC_REV_SN3</span><span class="p">)</span>
<span class="cp">#endif	</span><span class="cm">/* MOT_ELM */</span><span class="cp"></span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * No supernet III PLC, so set Xmit verctor and</span>
<span class="cm">			 * length BEFORE starting the state machine.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plc_send_bits</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Now give the Start command.</span>
<span class="cm">		 * - The start command shall be done before setting the bits</span>
<span class="cm">		 *   to be signaled. (In PLC-S description and PLCS in SN3.</span>
<span class="cm">		 * - The start command shall be issued AFTER setting the</span>
<span class="cm">		 *   XMIT vector and the XMIT length register.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We do it exactly according this specs for the old PLC and</span>
<span class="cm">		 * the new PLCS inside the SN3.</span>
<span class="cm">		 * For the usual PLCS we try it the way it is done for the</span>
<span class="cm">		 * old PLC and set the XMIT registers again, if the PLC is</span>
<span class="cm">		 * not in SIGNAL state. This is done according to an PLCS</span>
<span class="cm">		 * errata workaround.</span>
<span class="cm">		 */</span>

		<span class="n">plc_go_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,</span><span class="n">PL_PCM_START</span><span class="p">)</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * workaround for PLC-S eng. sample errata</span>
<span class="cm">		 */</span>
<span class="cp">#ifdef	MOT_ELM</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_PCM_SIGNAL</span><span class="p">))</span>
<span class="cp">#else	</span><span class="cm">/* nMOT_ELM */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_A</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PLC_REV_MASK</span><span class="p">)</span> <span class="o">!=</span>
			<span class="n">PLC_REVISION_A</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_PCM_SIGNAL</span><span class="p">))</span>
<span class="cp">#endif	</span><span class="cm">/* nMOT_ELM */</span><span class="cp"></span>
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Set register again (PLCS errata) or the first time</span>
<span class="cm">			 * (new SN3 PLCS).</span>
<span class="cm">			 */</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">plc_send_bits</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * end of workaround</span>
<span class="cm">		 */</span>

		<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC5_SIGNAL</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span> <span class="o">=</span> <span class="n">PS_BIT3</span> <span class="p">;</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_bits</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">;</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_start</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC1_BREAK</span> :
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">ACTIONS</span><span class="p">(</span><span class="n">PC2_TRACE</span><span class="p">)</span> :
		<span class="n">plc_go_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,</span><span class="n">PL_PCM_TRACE</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">ACTIONS_DONE</span><span class="p">()</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC2_TRACE</span> :
		<span class="k">break</span> <span class="p">;</span>

	<span class="k">case</span> <span class="n">PC3_CONNECT</span> :	<span class="cm">/* these states are done by hardware */</span>
	<span class="k">case</span> <span class="n">PC4_NEXT</span> :
		<span class="k">break</span> <span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTIONS</span><span class="p">(</span><span class="n">PC5_SIGNAL</span><span class="p">)</span> :
		<span class="n">ACTIONS_DONE</span><span class="p">()</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC5_SIGNAL</span> :
		<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">PC_SIGNAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">PC_TIMEOUT_LCT</span><span class="p">))</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PS_BIT3</span> :
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pc_rcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">pc_tcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span> <span class="o">=</span> <span class="n">PS_BIT4</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_bits</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_start</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plc_send_bits</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PS_BIT4</span> :
			<span class="n">pc_rcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pc_tcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span> <span class="o">=</span> <span class="n">PS_BIT7</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_bits</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_start</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plc_send_bits</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PS_BIT7</span> :
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">6</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pc_rcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span> <span class="o">=</span> <span class="n">PS_LCT</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_bits</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_start</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">;</span>
		<span class="n">sm_ph_lem_start</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">lct_short</span><span class="p">)</span> <span class="p">;</span> <span class="cm">/* enable LEM */</span>
			<span class="cm">/* start LCT */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PL_PC_LOOP</span> <span class="p">;</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">i</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* must be cleared */</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">i</span> <span class="o">|</span> <span class="n">PL_RLBP</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PS_LCT</span> :
			<span class="cm">/* check for local LCT failure */</span>
			<span class="n">pc_tcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * set tval[7]</span>
<span class="cm">			 */</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span> <span class="o">=</span> <span class="n">PS_BIT8</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_bits</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_start</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plc_send_bits</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PS_BIT8</span> :
			<span class="cm">/* check for remote LCT failure */</span>
			<span class="n">pc_rcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">plc_go_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,</span><span class="n">PL_PCM_STOP</span><span class="p">)</span> <span class="p">;</span>
				<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC1_BREAK</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">break</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">9</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pc_tcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span> <span class="o">=</span> <span class="n">PS_JOIN</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_bits</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_start</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bitn</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">plc_send_bits</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">return</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PS_JOIN</span> :
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">9</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pc_rcode_actions</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span> <span class="o">=</span> <span class="n">PS_ACTIVE</span> <span class="p">;</span>
			<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC6_JOIN</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTIONS</span><span class="p">(</span><span class="n">PC6_JOIN</span><span class="p">)</span> :
		<span class="cm">/*</span>
<span class="cm">		 * prevent mux error when going from WRAP_A to WRAP_B</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_DAS</span> <span class="o">&amp;&amp;</span> <span class="n">np</span> <span class="o">==</span> <span class="n">PB</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PA</span><span class="p">].</span><span class="n">pc_mode</span> <span class="o">==</span> <span class="n">PM_TREE</span> <span class="o">||</span>
			 <span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PB</span><span class="p">].</span><span class="n">pc_mode</span> <span class="o">==</span> <span class="n">PM_TREE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_A</span><span class="p">),</span>
				<span class="n">PL_SC_REM_LOOP</span><span class="p">,</span><span class="n">PL_SC_REM_LOOP</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span>
				<span class="n">PL_CONFIG_CNTRL</span><span class="p">,</span><span class="n">PL_CONFIG_CNTRL</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_PC_JOIN</span><span class="p">,</span><span class="n">PL_PC_JOIN</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_PC_JOIN</span><span class="p">,</span><span class="n">PL_PC_JOIN</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">ACTIONS_DONE</span><span class="p">()</span> <span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="cm">/* fall thru */</span>
	<span class="k">case</span> <span class="n">PC6_JOIN</span> :
		<span class="k">switch</span> <span class="p">(</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PS_ACTIVE</span>:
			<span class="cm">/*PC88b*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_join</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_join</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
				<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_CFM</span><span class="p">,</span><span class="n">CF_JOIN</span><span class="o">+</span><span class="n">np</span><span class="p">)</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">PC_JOIN</span><span class="p">)</span>
				<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC8_ACTIVE</span><span class="p">)</span> <span class="p">;</span>
			<span class="cm">/*PC82*/</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">PC_TRACE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC2_TRACE</span><span class="p">)</span> <span class="p">;</span>
				<span class="k">break</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>

	<span class="k">case</span> <span class="n">PC7_VERIFY</span> :
		<span class="k">break</span> <span class="p">;</span>

	<span class="k">case</span> <span class="n">ACTIONS</span><span class="p">(</span><span class="n">PC8_ACTIVE</span><span class="p">)</span> :
		<span class="cm">/*</span>
<span class="cm">		 * start LEM for SMT</span>
<span class="cm">		 */</span>
		<span class="n">sm_ph_lem_start</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">,</span><span class="n">LCT_LEM_MAX</span><span class="p">)</span> <span class="p">;</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">tr_flag</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTConnectState</span> <span class="o">=</span> <span class="n">PCM_ACTIVE</span> <span class="p">;</span>

		<span class="cm">/* Set the active interrupt mask register */</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_INTR_MASK</span><span class="p">),</span><span class="n">plc_imsk_act</span><span class="p">)</span> <span class="p">;</span>

		<span class="n">ACTIONS_DONE</span><span class="p">()</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC8_ACTIVE</span> :
		<span class="cm">/*PC81 is done by PL_TNE_EXPIRED irq */</span>
		<span class="cm">/*PC82*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">PC_TRACE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC2_TRACE</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*PC88c: is done by TRACE_PROP irq */</span>

		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">ACTIONS</span><span class="p">(</span><span class="n">PC9_MAINT</span><span class="p">)</span> :
		<span class="n">stop_pcm_timer0</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_PC_JOIN</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_LONG</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_INTR_MASK</span><span class="p">),</span><span class="n">PL_LE_CTR</span><span class="p">)</span> <span class="p">;</span>	<span class="cm">/* disable LEM int. */</span>
		<span class="n">sm_ph_lem_stop</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">)</span> <span class="p">;</span>		<span class="cm">/* disable LEM */</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_loop</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_join</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_CFM</span><span class="p">,</span><span class="n">CF_JOIN</span><span class="o">+</span><span class="n">np</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">plc_go_state</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,</span><span class="n">PL_PCM_STOP</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTConnectState</span> <span class="o">=</span> <span class="n">PCM_DISABLED</span> <span class="p">;</span>
		<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_MAINT</span><span class="p">,</span><span class="n">PL_MAINT</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">sm_ph_linestate</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span> <span class="n">MIB2LS</span><span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMaint_LS</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_A</span><span class="p">),</span><span class="n">PL_SC_BYPASS</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">ACTIONS_DONE</span><span class="p">()</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC9_MAINT</span> :
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM %c : MAINT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="cm">/*PC90*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">PC_ENABLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">GO_STATE</span><span class="p">(</span><span class="n">PC0_OFF</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">SMT_PANIC</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_E0118</span><span class="p">,</span> <span class="n">SMT_E0118_MSG</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * force line state on a PHY output	(only in MAINT state)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm_ph_linestate</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">cntrl</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">cntrl</span> <span class="o">=</span> <span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PL_MAINT_LS</span><span class="p">)</span> <span class="o">|</span>
						<span class="n">PL_PCM_STOP</span> <span class="o">|</span> <span class="n">PL_MAINT</span> <span class="p">;</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">ls</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PC_QLS</span>: 		<span class="cm">/* Force Quiet */</span>
		<span class="n">cntrl</span> <span class="o">|=</span> <span class="n">PL_M_QUI0</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC_MLS</span>: 		<span class="cm">/* Force Master */</span>
		<span class="n">cntrl</span> <span class="o">|=</span> <span class="n">PL_M_MASTR</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC_HLS</span>: 		<span class="cm">/* Force Halt */</span>
		<span class="n">cntrl</span> <span class="o">|=</span> <span class="n">PL_M_HALT</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">default</span> <span class="o">:</span>
	<span class="k">case</span> <span class="n">PC_ILS</span>: 		<span class="cm">/* Force Idle */</span>
		<span class="n">cntrl</span> <span class="o">|=</span> <span class="n">PL_M_IDLE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="n">PC_LS_PDR</span>: 	<span class="cm">/* Enable repeat filter */</span>
		<span class="n">cntrl</span> <span class="o">|=</span> <span class="n">PL_M_TPDR</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">phy</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">cntrl</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_lem_struct</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lem_counter</span> <span class="o">*</span><span class="n">lem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lem</span> <span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span> <span class="o">=</span> <span class="mi">15</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_float_ber</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">100</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * link error monitor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lem_evaluate</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ber</span> <span class="p">;</span>
	<span class="n">u_long</span> <span class="n">errors</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">lem_counter</span> <span class="o">*</span><span class="n">lem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lem</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>
	<span class="kt">int</span>			<span class="n">cond</span> <span class="p">;</span>

	<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">errors</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(((</span><span class="kt">int</span><span class="p">)</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">),</span><span class="n">PL_LINK_ERR_CTR</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="o">+=</span> <span class="n">errors</span> <span class="p">;</span>
	<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Ct</span> <span class="o">+=</span> <span class="n">errors</span> <span class="p">;</span>

	<span class="n">errors</span> <span class="o">=</span> <span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * calculation is called on a intervall of 8 seconds</span>
<span class="cm">	 *	-&gt; this means, that one error in 8 sec. is one of 8*125*10E6</span>
<span class="cm">	 *	the same as BER = 10E-9</span>
<span class="cm">	 * Please note:</span>
<span class="cm">	 *	-&gt; 9 errors in 8 seconds mean:</span>
<span class="cm">	 *	   BER = 9 * 10E-9  and this is</span>
<span class="cm">	 *	    &lt; 10E-8, so the limit of 10E-8 is not reached!</span>
<span class="cm">	 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">errors</span><span class="p">)</span>		<span class="n">ber</span> <span class="o">=</span> <span class="mi">15</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">)</span>	<span class="n">ber</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">99</span><span class="p">)</span>	<span class="n">ber</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">999</span><span class="p">)</span>	<span class="n">ber</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">9999</span><span class="p">)</span>	<span class="n">ber</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">99999</span><span class="p">)</span>	<span class="n">ber</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">999999</span><span class="p">)</span>	<span class="n">ber</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">9999999</span><span class="p">)</span>	<span class="n">ber</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">99999999</span><span class="p">)</span>	<span class="n">ber</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">;</span>
	<span class="k">else</span>	<span class="k">if</span> <span class="p">(</span><span class="n">errors</span> <span class="o">&lt;=</span> <span class="mi">999999999</span><span class="p">)</span> <span class="n">ber</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="k">else</span>				<span class="n">ber</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * weighted average</span>
<span class="cm">	 */</span>
	<span class="n">ber</span> <span class="o">*=</span> <span class="mi">100</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_float_ber</span> <span class="o">=</span> <span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_float_ber</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">ber</span> <span class="o">*</span> <span class="mi">3</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_float_ber</span> <span class="o">/=</span> <span class="mi">10</span> <span class="p">;</span>
	<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span> <span class="o">=</span> <span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_float_ber</span> <span class="o">/</span> <span class="mi">100</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;LEM %c :</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span> <span class="o">==</span> <span class="n">PB</span><span class="o">?</span> <span class="sc">&#39;B&#39;</span> <span class="o">:</span> <span class="sc">&#39;A&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;errors      : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;sum_errors  : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Ct</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;current BER : 10E-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ber</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;float BER   : 10E-(%d/100)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_float_ber</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;avg. BER    : 10E-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="o">=</span> <span class="mi">0L</span> <span class="p">;</span>

<span class="cp">#ifndef	SLIM_SMT</span>
	<span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span> <span class="o">&lt;=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Alarm</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">TRUE</span> <span class="o">:</span> <span class="n">FALSE</span> <span class="p">;</span>
<span class="cp">#ifdef	SMT_EXT_CUTOFF</span>
	<span class="n">smt_ler_alarm_check</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">,</span><span class="n">cond</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* nSMT_EXT_CUTOFF */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">!=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLerFlag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_COND_PORT_LER</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">INDEX_PORT</span><span class="o">+</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">)</span> <span class="p">,</span><span class="n">cond</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span>	<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span> <span class="o">&lt;=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Cutoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>		<span class="cm">/* flag */</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Reject_Ct</span><span class="o">++</span> <span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * &quot;forgive 10e-2&quot; if we cutoff so we can come</span>
<span class="cm">		 * up again ..</span>
<span class="cm">		 */</span>
		<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_float_ber</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="mi">100</span> <span class="p">;</span>

		<span class="cm">/*PC81b*/</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM: LER cutoff on port %d cutoff %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">,</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Cutoff</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef	SMT_EXT_CUTOFF</span>
		<span class="n">smt_port_off_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">);</span>
<span class="cp">#else	</span><span class="cm">/* nSMT_EXT_CUTOFF */</span><span class="cp"></span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">int</span><span class="p">)(</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">),</span><span class="n">PC_START</span><span class="p">)</span> <span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* nSMT_EXT_CUTOFF */</span><span class="cp"></span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * called by SMT to calculate LEM bit error rate</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">sm_lem_evaluate</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">np</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">np</span> <span class="o">&lt;</span> <span class="n">NUMPHYS</span> <span class="p">;</span> <span class="n">np</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lem_evaluate</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="p">])</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lem_check_lct</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lem_counter</span>	<span class="o">*</span><span class="n">lem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lem</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">errors</span> <span class="p">;</span>

	<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>		<span class="cm">/* flag */</span>
	<span class="n">errors</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(((</span><span class="kt">int</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">),</span><span class="n">PL_LINK_ERR_CTR</span><span class="p">))</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="o">+=</span> <span class="n">errors</span> <span class="p">;</span>
	<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Ct</span> <span class="o">+=</span> <span class="n">errors</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lc_test</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LC_SHORT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="o">&gt;=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">lct_short</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">LC_MEDIUM</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="o">&gt;=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">lct_medium</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">LC_LONG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="o">&gt;=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">lct_long</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">LC_EXTENDED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="o">&gt;=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">lct_extended</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot; &gt;&gt;errors : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLCTFail_Ct</span><span class="o">++</span> <span class="p">;</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Reject_Ct</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLCTFail_Ct</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * LEM functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm_ph_lem_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="n">threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lem_counter</span> <span class="o">*</span><span class="n">lem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="p">].</span><span class="n">lem</span> <span class="p">;</span>

	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_on</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_errors</span> <span class="o">=</span> <span class="mi">0L</span> <span class="p">;</span>

	<span class="cm">/* Do NOT reset mib-&gt;fddiPORTLer_Estimate here. It is called too</span>
<span class="cm">	 * often.</span>
<span class="cm">	 */</span>

	<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_LE_THRESHOLD</span><span class="p">),</span><span class="n">threshold</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_LINK_ERR_CTR</span><span class="p">))</span> <span class="p">;</span>	<span class="cm">/* clear error counter */</span>

	<span class="cm">/* enable LE INT */</span>
	<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_INTR_MASK</span><span class="p">),</span><span class="n">PL_LE_CTR</span><span class="p">,</span><span class="n">PL_LE_CTR</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sm_ph_lem_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lem_counter</span> <span class="o">*</span><span class="n">lem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="p">].</span><span class="n">lem</span> <span class="p">;</span>

	<span class="n">lem</span><span class="o">-&gt;</span><span class="n">lem_on</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="n">CLEAR</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_INTR_MASK</span><span class="p">),</span><span class="n">PL_LE_CTR</span><span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ARGSUSED */</span>
<span class="kt">void</span> <span class="nf">sm_pm_ls_latch</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on_off</span><span class="p">)</span>
<span class="cm">/* int on_off;	en- or disable ident. ls */</span>
<span class="p">{</span>
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="n">phy</span> <span class="p">;</span> <span class="n">on_off</span> <span class="o">=</span> <span class="n">on_off</span> <span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * PCM pseudo code</span>
<span class="cm"> * receive actions are called AFTER the bit n is received,</span>
<span class="cm"> * i.e. if pc_rcode_actions(5) is called, bit 6 is the next bit to be received</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * PCM pseudo code 5.1 .. 6.1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pc_rcode_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>

	<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>

	<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;SIG rec %x %x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span> <span class="p">)</span> <span class="p">;</span>
	<span class="n">bit</span><span class="o">++</span> <span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">=</span> <span class="n">TA</span> <span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">=</span> <span class="n">TB</span> <span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">=</span> <span class="n">TS</span> <span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">=</span> <span class="n">TM</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">==</span> <span class="n">TM</span> <span class="o">&amp;&amp;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM %c : E100 withhold M-M</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPC_Withhold</span> <span class="o">=</span> <span class="n">PC_WH_M_M</span> <span class="p">;</span>
			<span class="n">RS_SET</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">RS_EVENT</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPC_Withhold</span> <span class="o">=</span> <span class="n">PC_WH_NONE</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">==</span> <span class="n">TM</span> <span class="o">||</span>
			    <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_mode</span> <span class="o">=</span> <span class="n">PM_TREE</span> <span class="p">;</span>
			<span class="k">else</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_mode</span> <span class="o">=</span> <span class="n">PM_PEER</span> <span class="p">;</span>

			<span class="cm">/* reevaluate the selection criteria (wc_flag) */</span>
			<span class="n">all_selection_criteria</span> <span class="p">(</span><span class="n">smc</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">wc_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPC_Withhold</span> <span class="o">=</span> <span class="n">PC_WH_PATH</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPC_Withhold</span> <span class="o">=</span> <span class="n">PC_WH_OTHER</span> <span class="p">;</span>
			<span class="n">RS_SET</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">RS_EVENT</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM %c : E101 withhold other</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">twisted</span> <span class="o">=</span> <span class="p">((</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">!=</span> <span class="n">TS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">!=</span> <span class="n">TM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">==</span>
				<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span><span class="p">))</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">twisted</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM %c : E102 !!! TWISTED !!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span> :
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lc_test</span> <span class="o">=</span> <span class="n">LC_EXTENDED</span> <span class="p">;</span>
			<span class="k">else</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lc_test</span> <span class="o">=</span> <span class="n">LC_LONG</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lc_test</span> <span class="o">=</span> <span class="n">LC_MEDIUM</span> <span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lc_test</span> <span class="o">=</span> <span class="n">LC_SHORT</span> <span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lc_test</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">LC_SHORT</span> :				<span class="cm">/* 50ms */</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">,</span><span class="n">PL_LC_LENGTH</span><span class="p">),</span> <span class="n">TP_LC_LENGTH</span> <span class="p">)</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">pcm_lc_short</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">LC_MEDIUM</span> :			<span class="cm">/* 500ms */</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">,</span><span class="n">PL_LC_LENGTH</span><span class="p">),</span> <span class="n">TP_LC_LONGLN</span> <span class="p">)</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">pcm_lc_medium</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">LC_LONG</span> :
			<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_LONG</span><span class="p">,</span><span class="n">PL_LONG</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">pcm_lc_long</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">LC_EXTENDED</span> :
			<span class="n">SETMASK</span><span class="p">(</span><span class="n">PLC</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">),</span><span class="n">PL_LONG</span><span class="p">,</span><span class="n">PL_LONG</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">pcm_lc_extended</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">pcm_lc_medium</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">start_pcm_timer0</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span><span class="n">PC_TIMEOUT_LCT</span><span class="p">,</span><span class="n">phy</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;LCT timer = %ld us</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_next</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">pcm_t_next_9</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_loop</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">td_flag</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">7</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM %c : E103 LCT fail %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">?</span> <span class="s">&quot;local&quot;</span><span class="o">:</span><span class="s">&quot;remote&quot;</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,(</span><span class="kt">int</span><span class="p">)(</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">),</span><span class="n">PC_START</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">8</span><span class="p">])</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_loop</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">td_flag</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* neighbor intends to have MAC on output */</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMacIndicated</span><span class="p">.</span><span class="n">R_val</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* neighbor does not intend to have MAC on output */</span> <span class="p">;</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMacIndicated</span><span class="p">.</span><span class="n">R_val</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * PCM pseudo code 5.1 .. 6.1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pc_tcode_actions</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">np</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>

	<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>		<span class="cm">/* no escape used */</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">==</span> <span class="n">TS</span> <span class="o">||</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">==</span> <span class="n">TB</span> <span class="o">||</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="p">{</span>
		<span class="kt">int</span>	<span class="n">type</span><span class="p">,</span><span class="n">ne</span> <span class="p">;</span>
		<span class="kt">int</span>	<span class="n">policy</span> <span class="p">;</span>

		<span class="n">type</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="p">;</span>
		<span class="n">ne</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="p">;</span>
		<span class="n">policy</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTConnectionPolicy</span> <span class="p">;</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>	<span class="cm">/* Accept connection */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TA</span> :
			<span class="k">if</span> <span class="p">(</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_AA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TA</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_AB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TB</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_AS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TS</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_AM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span> <span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>	<span class="cm">/* Reject */</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">TB</span> :
			<span class="k">if</span> <span class="p">(</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_BA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TA</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_BB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TB</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_BS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TS</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_BM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span> <span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>	<span class="cm">/* Reject */</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">TS</span> :
			<span class="k">if</span> <span class="p">(</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_SA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TA</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_SB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TB</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_SS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TS</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_SM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span> <span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>	<span class="cm">/* Reject */</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">TM</span> :
			<span class="k">if</span> <span class="p">(</span>	<span class="n">ne</span> <span class="o">==</span> <span class="n">TM</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_MA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TA</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_MB</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TB</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_MS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TS</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">policy</span> <span class="o">&amp;</span> <span class="n">POLICY_MM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span> <span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>	<span class="cm">/* Reject */</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifndef	SLIM_SMT</span>
		<span class="cm">/*</span>
<span class="cm">		 * detect undesirable connection attempt event</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span>	<span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TA</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TA</span> <span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TA</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TS</span> <span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TB</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TB</span> <span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TB</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TS</span> <span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TS</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TA</span> <span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TS</span> <span class="o">&amp;&amp;</span> <span class="n">ne</span> <span class="o">==</span> <span class="n">TB</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">smt_srf_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_EVENT_PORT_CONNECTION</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="n">INDEX_PORT</span><span class="o">+</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">np</span><span class="p">)</span> <span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPC_Withhold</span> <span class="o">==</span> <span class="n">PC_WH_NONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>	<span class="cm">/* long */</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLCTFail_Ct</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>	<span class="cm">/* medium */</span>
				<span class="k">else</span>
					<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>	<span class="cm">/* short */</span>

				<span class="cm">/*</span>
<span class="cm">				 * Implementers choice: use medium</span>
<span class="cm">				 * instead of short when undesired</span>
<span class="cm">				 * connection attempt is made.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">wc_flag</span><span class="p">)</span>
					<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>	<span class="cm">/* medium */</span>
			<span class="p">}</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTConnectState</span> <span class="o">=</span> <span class="n">PCM_CONNECTING</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTConnectState</span> <span class="o">=</span> <span class="n">PCM_STANDBY</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>	<span class="cm">/* extended */</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="cm">/* we do NOT have a MAC for LCT */</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_loop</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="n">lem_check_lct</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">phy</span><span class="p">)</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_lem_fail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM %c : E104 LCT failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>	<span class="cm">/* Don&#39;t request MAC loopback */</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">cf_loop</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPC_Withhold</span> <span class="o">!=</span> <span class="n">PC_WH_NONE</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">((</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">==</span> <span class="n">SMT_DAS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">wc_flag</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">np</span><span class="p">,</span><span class="n">PC_START</span><span class="p">)</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">FALSE</span> <span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SMT_DAS</span> :
			<span class="cm">/*</span>
<span class="cm">			 * MAC intended on output</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_mode</span> <span class="o">==</span> <span class="n">PM_TREE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">np</span> <span class="o">==</span> <span class="n">PB</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">np</span> <span class="o">==</span> <span class="n">PA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PB</span><span class="p">].</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTConnectState</span> <span class="o">!=</span>
					<span class="n">PCM_ACTIVE</span><span class="p">)))</span>
					<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PB</span><span class="p">)</span>
					<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">SMT_SAS</span> :
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PS</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
<span class="cp">#ifdef	CONCENTRATOR</span>
		<span class="k">case</span> <span class="n">SMT_NAC</span> :
			<span class="cm">/*</span>
<span class="cm">			 * MAC intended on output</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">==</span> <span class="n">PB</span><span class="p">)</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="k">break</span> <span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
		<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMacIndicated</span><span class="p">.</span><span class="n">T_val</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;SIG snd %x %x:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="n">bit</span><span class="p">]</span> <span class="p">)</span> <span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return status twisted (called by SMT)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pcm_status_twisted</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">twist</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">sas</span> <span class="o">!=</span> <span class="n">SMT_DAS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PA</span><span class="p">].</span><span class="n">twisted</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PA</span><span class="p">].</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span><span class="p">))</span>
		<span class="n">twist</span> <span class="o">|=</span> <span class="mi">1</span> <span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PB</span><span class="p">].</span><span class="n">twisted</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">PB</span><span class="p">].</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span><span class="p">))</span>
		<span class="n">twist</span> <span class="o">|=</span> <span class="mi">2</span> <span class="p">;</span>
	<span class="k">return</span> <span class="n">twist</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return status	(called by SMT)</span>
<span class="cm"> *	type</span>
<span class="cm"> *	state</span>
<span class="cm"> *	remote phy type</span>
<span class="cm"> *	remote mac yes/no</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pcm_status_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">state</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="o">*</span><span class="n">remote</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_phy</span>	<span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="p">]</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>

	<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>

	<span class="cm">/* remote PHY type and MAC - set only if active */</span>
	<span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>
	<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="p">;</span>		<span class="cm">/* our PHY type */</span>
	<span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTConnectState</span> <span class="p">;</span>
	<span class="o">*</span><span class="n">remote</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PC8_ACTIVE</span> :
		<span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMacIndicated</span><span class="p">.</span><span class="n">R_val</span> <span class="p">;</span>
		<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return rooted station status (called by SMT)</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pcm_rooted_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">n</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">NUMPHYS</span> <span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="o">==</span> <span class="n">TM</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interrupt actions for PLC &amp; PCM events</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">plc_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="cm">/* int np;	PHY index */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="p">]</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_plc</span> <span class="o">*</span><span class="n">plc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">plc</span> <span class="p">;</span>
	<span class="kt">int</span>		<span class="n">n</span> <span class="p">;</span>
<span class="cp">#ifdef	SUPERNET_3</span>
	<span class="kt">int</span>		<span class="n">corr_mask</span> <span class="p">;</span>
<span class="cp">#endif	</span><span class="cm">/* SUPERNET_3 */</span><span class="cp"></span>
	<span class="kt">int</span>		<span class="n">i</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">np</span> <span class="o">&gt;=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">s</span><span class="p">.</span><span class="n">numphys</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">soft_err</span><span class="o">++</span> <span class="p">;</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_EBUF_ERR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* elastic buff. det. over-|underflow*/</span>
		<span class="cm">/*</span>
<span class="cm">		 * Check whether the SRF Condition occurred.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">ebuf_cont</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span><span class="p">){</span>
			<span class="cm">/*</span>
<span class="cm">			 * This is the real Elasticity Error.</span>
<span class="cm">			 * More than one in a row are treated as a</span>
<span class="cm">			 * single one.</span>
<span class="cm">			 * Only count this in the active state.</span>
<span class="cm">			 */</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTEBError_Ct</span> <span class="o">++</span> <span class="p">;</span>

		<span class="p">}</span>

		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">ebuf_err</span><span class="o">++</span> <span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">ebuf_cont</span> <span class="o">&lt;=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Prevent counter from being wrapped after</span>
<span class="cm">			 * hanging years in that interrupt.</span>
<span class="cm">			 */</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">ebuf_cont</span><span class="o">++</span> <span class="p">;</span>	<span class="cm">/* Ebuf continuous error */</span>
		<span class="p">}</span>

<span class="cp">#ifdef	SUPERNET_3</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">ebuf_cont</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span>
			<span class="p">((</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_A</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PLC_REV_MASK</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">PLC_REV_SN3</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * This interrupt remeained high for at least</span>
<span class="cm">			 * 1000 consecutive interrupt calls.</span>
<span class="cm">			 *</span>
<span class="cm">			 * This is caused by a hardware error of the</span>
<span class="cm">			 * ORION part of the Supernet III chipset.</span>
<span class="cm">			 *</span>
<span class="cm">			 * Disable this bit from the mask.</span>
<span class="cm">			 */</span>
			<span class="n">corr_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">plc_imsk_na</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PL_EBUF_ERR</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">outpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_INTR_MASK</span><span class="p">),</span><span class="n">corr_mask</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Disconnect from the ring.</span>
<span class="cm">			 * Call the driver with the reset indication.</span>
<span class="cm">			 */</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_ECM</span><span class="p">,</span><span class="n">EC_DISCONNECT</span><span class="p">)</span> <span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Make an error log entry.</span>
<span class="cm">			 */</span>
			<span class="n">SMT_ERR_LOG</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">SMT_E0136</span><span class="p">,</span> <span class="n">SMT_E0136_MSG</span><span class="p">)</span> <span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Indicate the Reset.</span>
<span class="cm">			 */</span>
			<span class="n">drv_reset_indication</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* SUPERNET_3 */</span><span class="cp"></span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Reset the continuous error variable */</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">ebuf_cont</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span>	<span class="cm">/* reset Ebuf continuous error */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_PHYINV</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* physical layer invalid signal */</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">phyinv</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_VSYM_CTR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* violation symbol counter has incr.*/</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">vsym_ctr</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_MINI_CTR</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* dep. on PLC_CNTRL_A&#39;s MINI_CTR_INT*/</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">mini_ctr</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_LE_CTR</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* link error event counter */</span>
		<span class="kt">int</span>	<span class="n">j</span> <span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * note: PL_LINK_ERR_CTR MUST be read to clear it</span>
<span class="cm">		 */</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_LE_THRESHOLD</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_LINK_ERR_CTR</span><span class="p">))</span> <span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* wrapped around */</span>
			<span class="n">i</span> <span class="o">+=</span> <span class="mi">256</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lem</span><span class="p">.</span><span class="n">lem_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Note: Lem errors shall only be counted when</span>
<span class="cm">			 * link is ACTIVE or LCT is active.</span>
<span class="cm">			 */</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lem</span><span class="p">.</span><span class="n">lem_errors</span> <span class="o">+=</span> <span class="n">i</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Ct</span> <span class="o">+=</span> <span class="n">i</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_TPC_EXPIRED</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* TPC timer reached zero */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_state</span> <span class="o">==</span> <span class="n">PS_LCT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * end of LCT</span>
<span class="cm">			 */</span>
			<span class="p">;</span>
		<span class="p">}</span>
		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">tpc_exp</span><span class="o">++</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_LS_MATCH</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* LS == LS in PLC_CNTRL_B&#39;s MATCH_LS*/</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_CNTRL_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_MATCH_LS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PL_I_IDLE</span> :	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">curr_ls</span> <span class="o">=</span> <span class="n">PC_ILS</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_I_HALT</span> :	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">curr_ls</span> <span class="o">=</span> <span class="n">PC_HLS</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_I_MASTR</span> :	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">curr_ls</span> <span class="o">=</span> <span class="n">PC_MLS</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_I_QUIET</span> :	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">curr_ls</span> <span class="o">=</span> <span class="n">PC_QLS</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_PCM_BREAK</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* PCM has entered the BREAK state */</span>
		<span class="kt">int</span>	<span class="n">reason</span><span class="p">;</span>

		<span class="n">reason</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_BREAK_REASON</span> <span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PL_B_PCS</span> :		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_pcs</span><span class="o">++</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_B_TPC</span> :		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_tpc</span><span class="o">++</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_B_TNE</span> :		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_tne</span><span class="o">++</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_B_QLS</span> :		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_qls</span><span class="o">++</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_B_ILS</span> :		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_ils</span><span class="o">++</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_B_HLS</span> :		<span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_hls</span><span class="o">++</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*jd 05-Aug-1999 changed: Bug #10419 */</span>
		<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PLC %d: MDcF = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">DisconnectFlag</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">DisconnectFlag</span> <span class="o">==</span> <span class="n">FALSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PLC %d: restart (reason %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">np</span><span class="p">,</span><span class="n">PC_START</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PLC %d: NO!! restart (reason %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * If both CODE &amp; ENABLE are set ignore enable</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_PCM_CODE</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* receive last sign.-bit | LCT complete */</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">np</span><span class="p">,</span><span class="n">PC_SIGNAL</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_RCV_VECTOR</span><span class="p">))</span> <span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_bits</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">p_start</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_PCM_ENABLED</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* asserted SC_JOIN, scrub.completed*/</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">np</span><span class="p">,</span><span class="n">PC_JOIN</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_TRACE_PROP</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* MLS while PC8_ACTIV || PC2_TRACE */</span>
		<span class="cm">/*PC22b*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">tr_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM : irq TRACE_PROP %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">np</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">.</span><span class="n">fddiSMTECMState</span><span class="p">)</span> <span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">tr_flag</span> <span class="o">=</span> <span class="n">TRUE</span> <span class="p">;</span>
			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">trace_prop</span> <span class="o">|=</span> <span class="n">ENTITY_BIT</span><span class="p">(</span><span class="n">ENTITY_PHY</span><span class="p">(</span><span class="n">np</span><span class="p">))</span> <span class="p">;</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_ECM</span><span class="p">,</span><span class="n">EC_TRACE_PROP</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * filter PLC glitch ???</span>
<span class="cm">	 * QLS || HLS only while in PC2_TRACE state</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_SELF_TEST</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC2_TRACE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*PC22a*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">path_test</span> <span class="o">==</span> <span class="n">PT_PASSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM : state = %s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get_pcmstate</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">),</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span><span class="p">)</span> <span class="p">;</span>

			<span class="n">smc</span><span class="o">-&gt;</span><span class="n">e</span><span class="p">.</span><span class="n">path_test</span> <span class="o">=</span> <span class="n">PT_PENDING</span> <span class="p">;</span>
			<span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_ECM</span><span class="p">,</span><span class="n">EC_PATH_TEST</span><span class="p">)</span> <span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">PL_TNE_EXPIRED</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* TNE: length of noise events */</span>
		<span class="cm">/* break_required (TNE &gt; NS_Max) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="o">==</span> <span class="n">PC8_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">tr_flag</span><span class="p">)</span> <span class="p">{</span>
			   <span class="n">DB_PCMN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s">&quot;PCM %c : PC81 %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_name</span><span class="p">,</span><span class="s">&quot;NSE&quot;</span><span class="p">);</span>
			   <span class="n">queue_event</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">EVENT_PCM</span><span class="o">+</span><span class="n">np</span><span class="p">,</span><span class="n">PC_START</span><span class="p">)</span> <span class="p">;</span>
			   <span class="k">return</span> <span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#if	0</span><span class="c"></span>
<span class="c">	if (cmd &amp; PL_NP_ERR) {		/* NP has requested to r/w an inv reg*/</span>
<span class="c">		/*</span>
<span class="c">		 * It&#39;s a bug by AMD</span>
<span class="c">		 */</span>
<span class="c">		plc-&gt;np_err++ ;</span>
<span class="c">	}</span>
<span class="c">	/* pin inactiv (GND) */</span>
<span class="c">	if (cmd &amp; PL_PARITY_ERR) {	/* p. error dedected on TX9-0 inp */</span>
<span class="c">		plc-&gt;parity_err++ ;</span>
<span class="c">	}</span>
<span class="c">	if (cmd &amp; PL_LSDO) {		/* carrier detected */</span>
<span class="c">		;</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cp">#ifdef	DEBUG</span>
<span class="cm">/*</span>
<span class="cm"> * fill state struct</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pcm_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smt_state</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_phy</span>	<span class="o">*</span><span class="n">phy</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcm_state</span> <span class="o">*</span><span class="n">pcs</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span> <span class="p">;</span>
	<span class="kt">int</span>	<span class="n">ii</span> <span class="p">;</span>
	<span class="kt">short</span>	<span class="n">rbits</span> <span class="p">;</span>
	<span class="kt">short</span>	<span class="n">tbits</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phy</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">pcs</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">pcm_state</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMPHYS</span> <span class="p">;</span>
		<span class="n">i</span><span class="o">++</span> <span class="p">,</span> <span class="n">phy</span><span class="o">++</span><span class="p">,</span> <span class="n">pcs</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTMy_Type</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTPCMState</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_mode</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">pc_mode</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_neighbor</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTNeighborType</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_bsf</span> <span class="o">=</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTBS_Flag</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_lsf</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ls_flag</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_lct_fail</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_char</span><span class="p">)</span> <span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLCTFail_Ct</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_ls_rx</span> <span class="o">=</span> <span class="n">LS2MIB</span><span class="p">(</span><span class="n">sm_pm_get_ls</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">i</span><span class="p">))</span> <span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ii</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rbits</span> <span class="o">=</span> <span class="n">tbits</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">ii</span> <span class="o">&lt;</span> <span class="n">NUMBITS</span> <span class="p">;</span> <span class="n">ii</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rbits</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="n">tbits</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">r_val</span><span class="p">[</span><span class="n">NUMBITS</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">])</span>
				<span class="n">rbits</span> <span class="o">|=</span> <span class="mi">1</span> <span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">t_val</span><span class="p">[</span><span class="n">NUMBITS</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">ii</span><span class="p">])</span>
				<span class="n">tbits</span> <span class="o">|=</span> <span class="mi">1</span> <span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_r_val</span> <span class="o">=</span> <span class="n">rbits</span> <span class="p">;</span>
		<span class="n">pcs</span><span class="o">-&gt;</span><span class="n">pcm_t_val</span> <span class="o">=</span> <span class="n">tbits</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">get_pcm_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">pcs</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_PCM_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PL_PC0</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_STOP</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC1</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_START</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC2</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_TRACE</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC3</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_SIGNAL</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC4</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_SIGNAL</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC5</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_SIGNAL</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC6</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_JOIN</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC7</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_JOIN</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC8</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_ENABLE</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC9</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_MAINT</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">default</span> <span class="o">:</span>	<span class="n">pcs</span> <span class="o">=</span> <span class="n">PC_DISABLE</span> <span class="p">;</span> 	<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pcs</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">get_linestate</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="p">;</span>

	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_A</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_LINE_ST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PL_L_NLS</span> :	<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;NOISE&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_L_ALS</span> :	<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;ACTIV&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_L_UND</span> :	<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;UNDEF&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_L_ILS4</span>:	<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;ILS 4&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_L_QLS</span> :	<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;QLS&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_L_MLS</span> :	<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;MLS&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_L_HLS</span> :	<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;HLS&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_L_ILS16</span>:<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;ILS16&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
<span class="cp">#ifdef	lint</span>
		<span class="nl">default:</span>	<span class="n">ls</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span> <span class="p">;</span> <span class="k">break</span> <span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ls</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span> <span class="o">*</span><span class="nf">get_pcmstate</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">np</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">pcs</span> <span class="p">;</span>
	
	<span class="n">SK_UNUSED</span><span class="p">(</span><span class="n">smc</span><span class="p">)</span> <span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">inpw</span><span class="p">(</span><span class="n">PLC</span><span class="p">(</span><span class="n">np</span><span class="p">,</span><span class="n">PL_STATUS_B</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">PL_PCM_STATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PL_PC0</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;OFF&quot;</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC1</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;BREAK&quot;</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC2</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;TRACE&quot;</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC3</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;CONNECT&quot;</span><span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC4</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;NEXT&quot;</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC5</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;SIGNAL&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC6</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;JOIN&quot;</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC7</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;VERIFY&quot;</span> <span class="p">;</span>	<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC8</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;ACTIV&quot;</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">case</span> <span class="n">PL_PC9</span> :	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;MAINT&quot;</span> <span class="p">;</span>		<span class="k">break</span> <span class="p">;</span>
		<span class="k">default</span> <span class="o">:</span>	<span class="n">pcs</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN&quot;</span> <span class="p">;</span> 	<span class="k">break</span> <span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pcs</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">list_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s_plc</span> <span class="o">*</span><span class="n">plc</span> <span class="p">;</span>
	<span class="kt">int</span> <span class="n">np</span> <span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">np</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">np</span> <span class="o">&lt;</span> <span class="n">NUMPHYS</span> <span class="p">;</span> <span class="n">np</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">plc</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="p">].</span><span class="n">plc</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;PHY %d:</span><span class="se">\t</span><span class="s">ERRORS</span><span class="se">\t\t\t</span><span class="s">BREAK_REASONS</span><span class="se">\t\t</span><span class="s">STATES:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">np</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">soft_error: %ld </span><span class="se">\t\t</span><span class="s">PC_Start : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">plc</span><span class="o">-&gt;</span><span class="n">soft_err</span><span class="p">,</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_pcs</span><span class="p">);</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">parity_err: %ld </span><span class="se">\t\t</span><span class="s">TPC exp. : %ld</span><span class="se">\t\t</span><span class="s">Line: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">parity_err</span><span class="p">,</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_tpc</span><span class="p">,</span><span class="n">get_linestate</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">ebuf_error: %ld </span><span class="se">\t\t</span><span class="s">TNE exp. : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">plc</span><span class="o">-&gt;</span><span class="n">ebuf_err</span><span class="p">,</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_tne</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">phyinvalid: %ld </span><span class="se">\t\t</span><span class="s">QLS det. : %ld</span><span class="se">\t\t</span><span class="s">PCM : %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">plc</span><span class="o">-&gt;</span><span class="n">phyinv</span><span class="p">,</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_qls</span><span class="p">,</span><span class="n">get_pcmstate</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">np</span><span class="p">))</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">viosym_ctr: %ld </span><span class="se">\t\t</span><span class="s">ILS det. : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">plc</span><span class="o">-&gt;</span><span class="n">vsym_ctr</span><span class="p">,</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_ils</span><span class="p">)</span>  <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">mingap_ctr: %ld </span><span class="se">\t\t</span><span class="s">HLS det. : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">plc</span><span class="o">-&gt;</span><span class="n">mini_ctr</span><span class="p">,</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">b_hls</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">nodepr_err: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">np_err</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">TPC_exp : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">plc</span><span class="o">-&gt;</span><span class="n">tpc_exp</span><span class="p">)</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\t</span><span class="s">LEM_err : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">[</span><span class="n">np</span><span class="p">].</span><span class="n">lem</span><span class="p">.</span><span class="n">lem_errors</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cp">#ifdef	CONCENTRATOR</span>
<span class="kt">void</span> <span class="nf">pcm_lem_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">s_smc</span> <span class="o">*</span><span class="n">smc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>		<span class="n">i</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">s_phy</span>	<span class="o">*</span><span class="n">phy</span> <span class="p">;</span>
	<span class="k">struct</span> <span class="n">fddi_mib_p</span>	<span class="o">*</span><span class="n">mib</span> <span class="p">;</span>

	<span class="kt">char</span>		<span class="o">*</span><span class="n">entostring</span><span class="p">()</span> <span class="p">;</span>

	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;PHY	errors	BER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="n">printf</span><span class="p">(</span><span class="s">&quot;----------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">phy</span> <span class="o">=</span> <span class="n">smc</span><span class="o">-&gt;</span><span class="n">y</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMPHYS</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="n">phy</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plc_is_installed</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span> <span class="p">;</span>
		<span class="n">mib</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="p">;</span>
		<span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\t</span><span class="s">%ld</span><span class="se">\t</span><span class="s">10E-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">entostring</span><span class="p">(</span><span class="n">smc</span><span class="p">,</span><span class="n">ENTITY_PHY</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLem_Ct</span><span class="p">,</span>
			<span class="n">mib</span><span class="o">-&gt;</span><span class="n">fddiPORTLer_Estimate</span><span class="p">)</span> <span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
