<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › b43 › phy_n.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>phy_n.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">  Broadcom B43 wireless driver</span>
<span class="cm">  IEEE 802.11n PHY support</span>

<span class="cm">  Copyright (c) 2008 Michael Buesch &lt;m@bues.ch&gt;</span>
<span class="cm">  Copyright (c) 2010-2011 Rafał Miłecki &lt;zajec5@gmail.com&gt;</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm">  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,</span>
<span class="cm">  Boston, MA 02110-1301, USA.</span>

<span class="cm">*/</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>

<span class="cp">#include &quot;b43.h&quot;</span>
<span class="cp">#include &quot;phy_n.h&quot;</span>
<span class="cp">#include &quot;tables_nphy.h&quot;</span>
<span class="cp">#include &quot;radio_2055.h&quot;</span>
<span class="cp">#include &quot;radio_2056.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>

<span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">txgm</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">pga</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">pad</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">ipa</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nphy_iqcal_params</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">txgm</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pga</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pad</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ipa</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cal_gain</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ncorr</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">nphy_iq_est</span> <span class="p">{</span>
	<span class="n">s32</span> <span class="n">iq0_prod</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i0_pwr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">q0_pwr</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">iq1_prod</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i1_pwr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">q1_pwr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">b43_nphy_rf_sequence</span> <span class="p">{</span>
	<span class="n">B43_RFSEQ_RX2TX</span><span class="p">,</span>
	<span class="n">B43_RFSEQ_TX2RX</span><span class="p">,</span>
	<span class="n">B43_RFSEQ_RESET2RX</span><span class="p">,</span>
	<span class="n">B43_RFSEQ_UPDATE_GAINH</span><span class="p">,</span>
	<span class="n">B43_RFSEQ_UPDATE_GAINL</span><span class="p">,</span>
	<span class="n">B43_RFSEQ_UPDATE_GAINU</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">b43_nphy_rssi_type</span> <span class="p">{</span>
	<span class="n">B43_NPHY_RSSI_X</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">B43_NPHY_RSSI_Y</span><span class="p">,</span>
	<span class="n">B43_NPHY_RSSI_Z</span><span class="p">,</span>
	<span class="n">B43_NPHY_RSSI_PWRDET</span><span class="p">,</span>
	<span class="n">B43_NPHY_RSSI_TSSI_I</span><span class="p">,</span>
	<span class="n">B43_NPHY_RSSI_TSSI_Q</span><span class="p">,</span>
	<span class="n">B43_NPHY_RSSI_TBD</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">b43_nphy_ipa</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span> <span class="o">=</span> <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ipa2g_on</span> <span class="o">&amp;&amp;</span> <span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ipa5g_on</span> <span class="o">&amp;&amp;</span> <span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCoreGetState */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">b43_nphy_get_rx_core_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQCA</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">B43_NPHY_RFSEQCA_RXEN</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">B43_NPHY_RFSEQCA_RXEN_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * RF (just without b43_nphy_rf_control_intc_override)</span>
<span class="cm"> **************************************************/</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ForceRFSeq */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="k">enum</span> <span class="n">b43_nphy_rf_sequence</span> <span class="n">seq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">trigger</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">B43_RFSEQ_RX2TX</span><span class="p">]</span>		<span class="o">=</span> <span class="n">B43_NPHY_RFSEQTR_RX2TX</span><span class="p">,</span>
		<span class="p">[</span><span class="n">B43_RFSEQ_TX2RX</span><span class="p">]</span>		<span class="o">=</span> <span class="n">B43_NPHY_RFSEQTR_TX2RX</span><span class="p">,</span>
		<span class="p">[</span><span class="n">B43_RFSEQ_RESET2RX</span><span class="p">]</span>		<span class="o">=</span> <span class="n">B43_NPHY_RFSEQTR_RST2RX</span><span class="p">,</span>
		<span class="p">[</span><span class="n">B43_RFSEQ_UPDATE_GAINH</span><span class="p">]</span>	<span class="o">=</span> <span class="n">B43_NPHY_RFSEQTR_UPGH</span><span class="p">,</span>
		<span class="p">[</span><span class="n">B43_RFSEQ_UPDATE_GAINL</span><span class="p">]</span>	<span class="o">=</span> <span class="n">B43_NPHY_RFSEQTR_UPGL</span><span class="p">,</span>
		<span class="p">[</span><span class="n">B43_RFSEQ_UPDATE_GAINU</span><span class="p">]</span>	<span class="o">=</span> <span class="n">B43_NPHY_RFSEQTR_UPGU</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq_mode</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">);</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">seq</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">trigger</span><span class="p">));</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">,</span>
		    <span class="n">B43_NPHY_RFSEQMODE_CAOVER</span> <span class="o">|</span> <span class="n">B43_NPHY_RFSEQMODE_TROVER</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQTR</span><span class="p">,</span> <span class="n">trigger</span><span class="p">[</span><span class="n">seq</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">trigger</span><span class="p">[</span><span class="n">seq</span><span class="p">]))</span>
			<span class="k">goto</span> <span class="n">ok</span><span class="p">;</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;RF sequence status timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">ok:</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">,</span> <span class="n">seq_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RFCtrlOverride */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rf_control_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">field</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">core</span><span class="p">,</span> <span class="n">bool</span> <span class="n">off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">en_addr</span><span class="p">,</span> <span class="n">val_addr</span><span class="p">;</span>
	<span class="cm">/* we expect only one bit set */</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">field</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nphy_rf_control_override_rev3</span> <span class="o">*</span><span class="n">rf_ctrl</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
					<span class="s">&quot;Unsupported RF Ctrl Override call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rf_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tbl_rf_control_override_rev3</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">en_addr</span> <span class="o">=</span> <span class="n">B43_PHY_N</span><span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">en_addr0</span> <span class="o">:</span> <span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">en_addr1</span><span class="p">);</span>
			<span class="n">val_addr</span> <span class="o">=</span> <span class="n">B43_PHY_N</span><span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">val_addr0</span> <span class="o">:</span> <span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">val_addr1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">en_addr</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">field</span><span class="p">));</span>
				<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">val_addr</span><span class="p">,</span>
						<span class="o">~</span><span class="p">(</span><span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">val_mask</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">core</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">core</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">en_addr</span><span class="p">,</span> <span class="n">field</span><span class="p">);</span>
					<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">val_addr</span><span class="p">,</span>
						<span class="o">~</span><span class="p">(</span><span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">val_mask</span><span class="p">),</span>
						<span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">val_shift</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">nphy_rf_control_override_rev2</span> <span class="o">*</span><span class="n">rf_ctrl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">field</span><span class="p">));</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="n">field</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
					<span class="s">&quot;Unsupported RF Ctrl Override call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">10</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">13</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">core</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">rf_ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tbl_rf_control_override_rev2</span><span class="p">[</span><span class="n">index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">B43_PHY_N</span><span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">addr0</span> <span class="o">:</span> <span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">core</span><span class="p">)</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">bmask</span><span class="p">),</span>
						<span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">rf_ctrl</span><span class="o">-&gt;</span><span class="n">shift</span><span class="p">));</span>

			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
					<span class="n">B43_NPHY_RFCTL_CMD_START</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="mh">0xFFFE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RFCtrlIntcOverride */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rf_control_intc_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">field</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">field</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">core</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">core</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">i</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">B43_NPHY_RFCTL_INTC1</span> <span class="o">:</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">;</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_RFSEQ_RESET2RX</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span>
						<span class="mh">0xFC3F</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S1</span><span class="p">,</span>
						<span class="mh">0xFFFE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
						<span class="n">B43_NPHY_RFCTL_CMD_START</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">B43_NPHY_RFCTL_CMD_START</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
					<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
						<span class="s">&quot;intc override timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S1</span><span class="p">,</span>
						<span class="mh">0xFFFE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span>
						<span class="mh">0xFC3F</span><span class="p">,</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span>
						<span class="mh">0xFFFE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
						<span class="n">B43_NPHY_RFCTL_CMD_RXTX</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">B43_NPHY_RFCTL_CMD_RXTX</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="p">)</span>
					<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
						<span class="s">&quot;intc override timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span>
						<span class="mh">0xFFFE</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">~</span><span class="n">tmp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x0004</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">~</span><span class="n">tmp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">;</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">~</span><span class="n">tmp</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Various PHY ops</span>
<span class="cm"> **************************************************/</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/clip-detection */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_write_clip_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">clip_st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CLIP1THRES</span><span class="p">,</span> <span class="n">clip_st</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CLIP1THRES</span><span class="p">,</span> <span class="n">clip_st</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/clip-detection */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_read_clip_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">clip_st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clip_st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CLIP1THRES</span><span class="p">);</span>
	<span class="n">clip_st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CLIP1THRES</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/classifier */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_nphy_classifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_CLASSCTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">B43_NPHY_CLASSCTL_CCKEN</span> <span class="o">|</span> <span class="n">B43_NPHY_CLASSCTL_OFDMEN</span> <span class="o">|</span>
		<span class="n">B43_NPHY_CLASSCTL_WAITEDEN</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_CLASSCTL</span><span class="p">,</span> <span class="mh">0xFFF8</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CCA */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_reset_cca</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">bbcfg</span><span class="p">;</span>

	<span class="n">b43_phy_force_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">bbcfg</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">,</span> <span class="n">bbcfg</span> <span class="o">|</span> <span class="n">B43_NPHY_BBCFG_RSTCCA</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">,</span> <span class="n">bbcfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_NPHY_BBCFG_RSTCCA</span><span class="p">);</span>
	<span class="n">b43_phy_force_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_RFSEQ_RESET2RX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/carriersearch */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">clip</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mh">0xFFFF</span> <span class="p">};</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">deaf_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">classifier_state</span> <span class="o">=</span> <span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_nphy_read_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">clip_state</span><span class="p">);</span>
			<span class="n">b43_nphy_write_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clip</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_nphy_reset_cca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">deaf_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7</span><span class="p">,</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">classifier_state</span><span class="p">);</span>
			<span class="n">b43_nphy_write_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">clip_state</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/AdjustLnaGainTbl */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_adjust_lna_gain_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">s16</span> <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">minmax</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">lna_gain</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">25</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">gain_boost</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">gain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">40370</span> <span class="o">-</span> <span class="mi">315</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">gain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">23242</span> <span class="o">-</span> <span class="mi">224</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
			<span class="n">gain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">gain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">elna_gain_config</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">19</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">25</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lna_gain</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lna_gain</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lna_gain</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">lna_gain</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

		<span class="n">minmax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">23</span> <span class="o">+</span> <span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_MINMAX_GAIN</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_C1_MINGAIN</span><span class="p">,</span>
				<span class="n">minmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_C1_MINGAIN_SHIFT</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_MINMAX_GAIN</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_C2_MINGAIN</span><span class="p">,</span>
				<span class="n">minmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_C2_MINGAIN_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetRfSeq */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_set_rf_sequence</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">events</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">delays</span><span class="p">,</span> <span class="n">u8</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x1F</span> <span class="o">:</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset1</span> <span class="o">=</span> <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset2</span> <span class="o">=</span> <span class="n">offset1</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">offset1</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">offset2</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span> <span class="n">delays</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">offset1</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">end</span><span class="p">);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="n">offset2</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Radio 0x2056</span>
<span class="cm"> **************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_chantab_radio_2056_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_nphy_channeltab_entry_rev3</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_VCOCAL1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_vcocal1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_VCOCAL2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_vcocal2</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_REFDIV</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_refdiv</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_MMD2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_mmd2</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_MMD1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_mmd1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER1</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_loopfilter1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER2</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_loopfilter2</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER3</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_loopfilter3</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER4</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_loopfilter4</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER5</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_pll_loopfilter5</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_RESERVED_ADDR27</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_reserved_addr27</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_RESERVED_ADDR28</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_reserved_addr28</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_RESERVED_ADDR29</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_reserved_addr29</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_LOGEN_VCOBUF1</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_logen_vcobuf1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_LOGEN_MIXER2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_logen_mixer2</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_LOGEN_BUF3</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_logen_buf3</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_LOGEN_BUF4</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_syn_logen_buf4</span><span class="p">);</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_LNAA_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_rx0_lnaa_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_LNAG_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_rx0_lnag_tune</span><span class="p">);</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAA_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx0_intpaa_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx0_intpag_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_PADA_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx0_pada_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_PADG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx0_padg_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_PGAA_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx0_pgaa_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_PGAG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx0_pgag_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_MIXA_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx0_mixa_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_MIXG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx0_mixg_boost_tune</span><span class="p">);</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_LNAA_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_rx1_lnaa_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_LNAG_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_rx1_lnag_tune</span><span class="p">);</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAA_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx1_intpaa_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx1_intpag_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_PADA_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx1_pada_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_PADG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx1_padg_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_PGAA_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx1_pgaa_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_PGAG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx1_pgag_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_MIXA_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx1_mixa_boost_tune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_MIXG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_tx1_mixg_boost_tune</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/Radio/2056Setup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_radio_2056_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_nphy_channeltab_entry_rev3</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span> <span class="o">=</span> <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bias</span><span class="p">,</span> <span class="n">cbias</span><span class="p">,</span> <span class="n">pag_boost</span><span class="p">,</span> <span class="n">pgag_boost</span><span class="p">,</span> <span class="n">mixg_boost</span><span class="p">,</span> <span class="n">padg_boost</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">b43_chantab_radio_2056_upload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="n">b2056_upload_syn_pll_cp2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_GPLL_WAR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER1</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER2</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4716</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER4</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_CP2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER4</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_CP2</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_APLL_WAR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER1</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER2</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_LOOPFILTER4</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_CP2</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ipa2g_on</span> <span class="o">&amp;&amp;</span> <span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">?</span> <span class="n">B2056_TX1</span> <span class="o">:</span> <span class="n">B2056_TX0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_PADG_IDAC</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4716</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">bias</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
					<span class="n">cbias</span> <span class="o">=</span> <span class="mh">0x45</span><span class="p">;</span>
					<span class="n">pag_boost</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
					<span class="n">pgag_boost</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>
					<span class="n">mixg_boost</span> <span class="o">=</span> <span class="mh">0x55</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">bias</span> <span class="o">=</span> <span class="mh">0x25</span><span class="p">;</span>
					<span class="n">cbias</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
					<span class="n">pag_boost</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
					<span class="n">pgag_boost</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
					<span class="n">mixg_boost</span> <span class="o">=</span> <span class="mh">0x65</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">padg_boost</span> <span class="o">=</span> <span class="mh">0x77</span><span class="p">;</span>

				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_IMAIN_STAT</span><span class="p">,</span>
					<span class="n">bias</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_IAUX_STAT</span><span class="p">,</span>
					<span class="n">bias</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_CASCBIAS</span><span class="p">,</span>
					<span class="n">cbias</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">pag_boost</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_PGAG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">pgag_boost</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_PADG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">padg_boost</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_MIXG_BOOST_TUNE</span><span class="p">,</span>
					<span class="n">mixg_boost</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bias</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_IMAIN_STAT</span><span class="p">,</span>
					<span class="n">bias</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_IAUX_STAT</span><span class="p">,</span>
					<span class="n">bias</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_INTPAG_CASCBIAS</span><span class="p">,</span>
					<span class="mh">0x30</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">|</span> <span class="n">B2056_TX_PA_SPARE1</span><span class="p">,</span> <span class="mh">0xee</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">ipa5g_on</span> <span class="o">&amp;&amp;</span> <span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO */</span>
	<span class="p">}</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="cm">/* VCO calibration */</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_VCOCAL12</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX_INTPAA_PA_MISC</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX_INTPAA_PA_MISC</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX_INTPAA_PA_MISC</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX_INTPAA_PA_MISC</span><span class="p">,</span> <span class="mh">0x39</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_radio_init2056_pre</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
		     <span class="o">~</span><span class="n">B43_NPHY_RFCTL_CMD_CHIP0PU</span><span class="p">);</span>
	<span class="cm">/* Maybe wl meant to reset and set (order?) RFCTL_CMD_OEPORFORCE? */</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
		     <span class="n">B43_NPHY_RFCTL_CMD_OEPORFORCE</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
		    <span class="o">~</span><span class="n">B43_NPHY_RFCTL_CMD_OEPORFORCE</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
		    <span class="n">B43_NPHY_RFCTL_CMD_CHIP0PU</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_radio_init2056_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_COM_CTRL</span><span class="p">,</span> <span class="mh">0xB</span><span class="p">);</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_COM_PU</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_COM_RESET</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_COM_RESET</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x2</span><span class="p">);</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_PLL_MAST2</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xFC</span><span class="p">);</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_RCCAL_CTRL0</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	if (nphy-&gt;init_por)</span>
<span class="cm">		Call Radio 2056 Recalibrate</span>
<span class="cm">	*/</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize a Broadcom 2056 N-radio</span>
<span class="cm"> * http://bcm-v4.sipsolutions.net/802.11/Radio/2056/Init</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_radio_init2056</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_radio_init2056_pre</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b2056_upload_inittabs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_radio_init2056_post</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Radio 0x2055</span>
<span class="cm"> **************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_chantab_radio_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_nphy_channeltab_entry_rev2</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_PLL_REF</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_pll_ref</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_RF_PLLMOD0</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_rf_pllmod0</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_RF_PLLMOD1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_rf_pllmod1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_VCO_CAPTAIL</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_vco_captail</span><span class="p">);</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span> <span class="cm">/* flush writes */</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_VCO_CAL1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_vco_cal1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_VCO_CAL2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_vco_cal2</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_PLL_LFC1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_pll_lfc1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_PLL_LFR1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_pll_lfr1</span><span class="p">);</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span> <span class="cm">/* flush writes */</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_PLL_LFC2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_pll_lfc2</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_LGBUF_CENBUF</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_lgbuf_cenbuf</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_LGEN_TUNE1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_lgen_tune1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_LGEN_TUNE2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_lgen_tune2</span><span class="p">);</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span> <span class="cm">/* flush writes */</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_LGBUF_ATUNE</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c1_lgbuf_atune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_LGBUF_GTUNE</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c1_lgbuf_gtune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_RX_RFR1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c1_rx_rfr1</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_PGAPADTN</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c1_tx_pgapadtn</span><span class="p">);</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span> <span class="cm">/* flush writes */</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_MXBGTRIM</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c1_tx_mxbgtrim</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_LGBUF_ATUNE</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c2_lgbuf_atune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_LGBUF_GTUNE</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c2_lgbuf_gtune</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_RX_RFR1</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c2_rx_rfr1</span><span class="p">);</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span> <span class="cm">/* flush writes */</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_PGAPADTN</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c2_tx_pgapadtn</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_MXBGTRIM</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">radio_c2_tx_mxbgtrim</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/Radio/2055Setup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_radio_2055_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_nphy_channeltab_entry_rev2</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">b43_chantab_radio_upload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_VCO_CAL10</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_VCO_CAL10</span><span class="p">,</span> <span class="mh">0x45</span><span class="p">);</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span> <span class="cm">/* flush writes */</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_VCO_CAL10</span><span class="p">,</span> <span class="mh">0x65</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_radio_init2055_pre</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
		     <span class="o">~</span><span class="n">B43_NPHY_RFCTL_CMD_PORFORCE</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
		    <span class="n">B43_NPHY_RFCTL_CMD_CHIP0PU</span> <span class="o">|</span>
		    <span class="n">B43_NPHY_RFCTL_CMD_OEPORFORCE</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
		    <span class="n">B43_NPHY_RFCTL_CMD_PORFORCE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_radio_init2055_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">workaround</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">workaround</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">!=</span> <span class="n">PCI_VENDOR_ID_BROADCOM</span>
			      <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="mh">0x46D</span>
			      <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_rev</span> <span class="o">&gt;=</span> <span class="mh">0x41</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">workaround</span> <span class="o">=</span>
			<span class="o">!</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_RXBB_INT_REG_DIS</span><span class="p">);</span>

	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_MASTER1</span><span class="p">,</span> <span class="mh">0xFFF3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">workaround</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_RX_BB_REG</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">);</span>
		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_RX_BB_REG</span><span class="p">,</span> <span class="mh">0x7F</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_RRCCAL_NOPTSEL</span><span class="p">,</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="mh">0x2C</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_MISC</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">);</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_MISC</span><span class="p">,</span> <span class="mh">0xFFBE</span><span class="p">);</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_LPOCTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_MISC</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_MISC</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_COUT2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;radio post init timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_LPOCTL</span><span class="p">,</span> <span class="mh">0xFF7F</span><span class="p">);</span>
	<span class="n">b43_switch_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_RX_BB_LPF</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_RX_BB_LPF</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_RX_BB_MIDACHP</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_RX_BB_MIDACHP</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">);</span>
	<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_LNA_GAINBST</span><span class="p">,</span> <span class="mh">0xFFF8</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
	<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_LNA_GAINBST</span><span class="p">,</span> <span class="mh">0xFFF8</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">gain_boost</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_RX_RFSPC1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
		<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_RX_RFSPC1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_RX_RFSPC1</span><span class="p">,</span> <span class="mh">0xFFFD</span><span class="p">);</span>
		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_RX_RFSPC1</span><span class="p">,</span> <span class="mh">0xFFFD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize a Broadcom 2055 N-radio</span>
<span class="cm"> * http://bcm-v4.sipsolutions.net/802.11/Radio/2055/Init</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_radio_init2055</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_radio_init2055_pre</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Follow wl, not specs. Do not force uploading all regs */</span>
		<span class="n">b2055_upload_inittab</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">ghz5</span> <span class="o">=</span> <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="n">b2055_upload_inittab</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ghz5</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_radio_init2055_post</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Samples</span>
<span class="cm"> **************************************************/</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/LoadSampleTable */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_load_samples</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">b43_c32</span> <span class="o">*</span><span class="n">samples</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;allocation for samples loading failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GenLoadSamples */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_nphy_gen_load_samples</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">max</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bw</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="n">angle</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_c32</span> <span class="o">*</span><span class="n">samples</span><span class="p">;</span>


	<span class="n">bw</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">bw</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">B43_NPHY_BBCFG_RSTRX</span><span class="p">)</span>
			<span class="n">bw</span> <span class="o">=</span> <span class="mi">82</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bw</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span>
			<span class="n">bw</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">bw</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">samples</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_c32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">samples</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;allocation for samples generation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rot</span> <span class="o">=</span> <span class="p">(((</span><span class="n">freq</span> <span class="o">*</span> <span class="mi">36</span><span class="p">)</span> <span class="o">/</span> <span class="n">bw</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_cordic</span><span class="p">(</span><span class="n">angle</span><span class="p">);</span>
		<span class="n">angle</span> <span class="o">+=</span> <span class="n">rot</span><span class="p">;</span>
		<span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span> <span class="o">=</span> <span class="n">CORDIC_CONVERT</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">q</span> <span class="o">*</span> <span class="n">max</span><span class="p">);</span>
		<span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">CORDIC_CONVERT</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">*</span> <span class="n">max</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">b43_nphy_load_samples</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">samples</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RunSamples */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_run_samples</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">samps</span><span class="p">,</span> <span class="n">u16</span> <span class="n">loops</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">wait</span><span class="p">,</span> <span class="n">bool</span> <span class="n">iqmode</span><span class="p">,</span> <span class="n">bool</span> <span class="n">dac_test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">bb_mult_save</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">87</span><span class="p">));</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">bb_mult_save</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x6464</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x4747</span><span class="p">;</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">87</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_DEPCNT</span><span class="p">,</span> <span class="p">(</span><span class="n">samps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loops</span> <span class="o">!=</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_LOOPCNT</span><span class="p">,</span> <span class="p">(</span><span class="n">loops</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_LOOPCNT</span><span class="p">,</span> <span class="n">loops</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_WAITCNT</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="n">seq_mode</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">);</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE_CAOVER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iqmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQLOCAL_CMDGCTL</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQLOCAL_CMDGCTL</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dac_test</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_CMD</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_CMD</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQST</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;run samples timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">,</span> <span class="n">seq_mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * RSSI</span>
<span class="cm"> **************************************************/</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ScaleOffsetRssi */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">scale</span><span class="p">,</span>
					<span class="n">s8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">core</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rail</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">b43_nphy_rssi_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">core1or5</span> <span class="o">=</span> <span class="p">(</span><span class="n">core</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">core</span> <span class="o">==</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">core2or5</span> <span class="o">=</span> <span class="p">(</span><span class="n">core</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">core</span> <span class="o">==</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">scale</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_Z</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_Z</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_Z</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_Z</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_Z</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_Z</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_Z</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_Z</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_X</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_X</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_X</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_X</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_X</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_X</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_X</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_X</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_Y</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_Y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_Y</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_Y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_Y</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_Y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_Y</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_Y</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_TBD</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_TBD</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_TBD</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_TBD</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_TBD</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_TBD</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_TBD</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_TBD</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_PWRDET</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_PWRDET</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_PWRDET</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_PWRDET</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_PWRDET</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_PWRDET</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rail</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_PWRDET</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_PWRDET</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_TSSI_I</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_TSSI</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_TSSI_I</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_TSSI</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">core1or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_TSSI_Q</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_TSSI</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core2or5</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_NPHY_RSSI_TSSI_Q</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_TSSI</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rev3_rssi_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="mh">0xFDFF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="mh">0xFDFF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="mh">0xFCFF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="mh">0xFCFF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S0</span><span class="p">,</span> <span class="mh">0xFFDF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B32S1</span><span class="p">,</span> <span class="mh">0xFFDF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP1</span><span class="p">,</span> <span class="mh">0xFFC3</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP2</span><span class="p">,</span> <span class="mh">0xFFC3</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">code</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">i</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">B43_NPHY_AFECTL_OVER1</span> <span class="o">:</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">;</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0xFDFF</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">B43_NPHY_AFECTL_C1</span> <span class="o">:</span>
					<span class="n">B43_NPHY_AFECTL_C2</span><span class="p">;</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0xFCFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP1</span> <span class="o">:</span>
					<span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP2</span><span class="p">;</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0xFFC3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">val</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
				<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

				<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">B43_NPHY_TXF_40CO_B1S0</span> <span class="o">:</span>
					<span class="n">B43_NPHY_TXF_40CO_B32S1</span><span class="p">;</span>
				<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">val</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">val</span> <span class="o">=</span> <span class="mh">0x0300</span><span class="p">;</span>

				<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">B43_NPHY_AFECTL_C1</span> <span class="o">:</span>
					<span class="n">B43_NPHY_AFECTL_C2</span><span class="p">;</span>

				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0xFCFF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0xF3FF</span><span class="p">,</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span> <span class="o">=</span>
						<span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
						<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xC</span> <span class="o">:</span> <span class="mh">0xE</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="n">val</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
					<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2000</span> <span class="o">:</span> <span class="mh">0x3000</span><span class="p">;</span>
					<span class="n">reg</span> <span class="o">|=</span> <span class="n">B2055_PADDRV</span><span class="p">;</span>
					<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

					<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
						<span class="n">B43_NPHY_AFECTL_OVER1</span> <span class="o">:</span>
						<span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">;</span>
					<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rev2_rssi_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_RSSIO1</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span>
				<span class="p">(</span><span class="n">type</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_RSSIO2</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span>
				<span class="p">(</span><span class="n">type</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x3000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
				<span class="o">~</span><span class="p">(</span><span class="n">B43_NPHY_RFCTL_CMD_RXEN</span> <span class="o">|</span>
				  <span class="n">B43_NPHY_RFCTL_CMD_CORESEL</span><span class="p">));</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span>
				<span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span>
				  <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span>
				  <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span>
				  <span class="mh">0x1</span><span class="p">));</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_RFCTL_CMD_START</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
				<span class="o">~</span><span class="p">(</span><span class="n">B43_NPHY_RFCTL_CMD_RXEN</span> <span class="o">|</span>
				  <span class="n">B43_NPHY_RFCTL_CMD_CORESEL</span><span class="p">),</span>
				<span class="p">(</span><span class="n">B43_NPHY_RFCTL_CMD_RXEN</span> <span class="o">|</span>
				 <span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_RFCTL_CMD_CORESEL_SHIFT</span><span class="p">));</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span>
				<span class="p">(</span><span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="o">|</span>
				  <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span> <span class="o">|</span>
				  <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="o">|</span>
				  <span class="mh">0x1</span><span class="p">));</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
				<span class="n">B43_NPHY_RFCTL_CMD_START</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSISel */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rssi_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_rev3_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_nphy_rev2_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetRssi2055Vcm */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_set_rssi_2055_vcm</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_B0NB_RSSIVCM</span><span class="p">,</span>
						  <span class="mh">0xFC</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_RX_BB_RSSICTL5</span><span class="p">,</span>
						  <span class="mh">0xFC</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_B0NB_RSSIVCM</span><span class="p">,</span>
						  <span class="mh">0xFC</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span><span class="p">]);</span>
				<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_RX_BB_RSSICTL5</span><span class="p">,</span>
						  <span class="mh">0xFC</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_RX_BB_RSSICTL5</span><span class="p">,</span>
						  <span class="mh">0xF3</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_RX_BB_RSSICTL5</span><span class="p">,</span>
						  <span class="mh">0xF3</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/PollRssi */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_poll_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">nsamp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">s</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP1</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP2</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S0</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B32S1</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_RSSIO1</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_RSSIO2</span><span class="p">);</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_GPIO_SEL</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_GPIO_SEL</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nsamp</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_GPIO_LOOUT</span><span class="p">);</span>
			<span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_GPIO_HIOUT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSI1</span><span class="p">);</span>
			<span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSI2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="n">s8</span><span class="p">)((</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="n">s8</span><span class="p">)(((</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="n">s8</span><span class="p">)((</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="n">s8</span><span class="p">)(((</span><span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_GPIO_SEL</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP1</span><span class="p">,</span>
				<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP2</span><span class="p">,</span>
				<span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S0</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B32S1</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_RSSIO1</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_RSSIO2</span><span class="p">,</span> <span class="n">save_regs_phy</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICalRev3 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rev3_rssi_cal</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">saved_regs_phy_rfctl</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">saved_regs_phy</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">regs_to_store</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span>
		<span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span>
		<span class="n">B43_NPHY_TXF_40CO_B1S1</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span>
		<span class="n">B43_NPHY_TXF_40CO_B1S0</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B32S1</span><span class="p">,</span>
		<span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
		<span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP1</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP2</span><span class="p">,</span>
		<span class="n">B43_NPHY_RFCTL_RSSIO1</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_RSSIO2</span>
	<span class="p">};</span>

	<span class="n">u16</span> <span class="n">class</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">clip_state</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">clip_off</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mh">0xFFFF</span> <span class="p">};</span>

	<span class="n">u8</span> <span class="n">vcm_final</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">offset</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">s32</span> <span class="n">results</span><span class="p">[</span><span class="mi">8</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="n">s32</span> <span class="n">results_min</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="n">s32</span> <span class="n">poll_results</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

	<span class="n">u16</span> <span class="o">*</span><span class="n">rssical_radio_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">rssical_phy_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">r</span><span class="p">;</span> <span class="cm">/* routing */</span>
	<span class="n">u8</span> <span class="n">rx_core_state</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">core</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">class</span> <span class="o">=</span> <span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">b43_nphy_read_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clip_state</span><span class="p">);</span>
	<span class="n">b43_nphy_write_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clip_off</span><span class="p">);</span>

	<span class="n">saved_regs_phy_rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">);</span>
	<span class="n">saved_regs_phy_rfctl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regs_to_store</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">saved_regs_phy</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">regs_to_store</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">b43_nphy_rf_control_intc_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">b43_nphy_rf_control_intc_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rx_core_state</span> <span class="o">=</span> <span class="n">b43_nphy_get_rx_core_state</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">core</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">core</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">core</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_core_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">core</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">core</span> <span class="o">?</span> <span class="n">B2056_RX1</span> <span class="o">:</span> <span class="n">B2056_RX0</span><span class="p">;</span>
		<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_RX_RSSI_MISC</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span>
					<span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">b43_nphy_poll_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s32</span> <span class="n">curr</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">mind</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">minpoll</span> <span class="o">=</span> <span class="mi">249</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">minvcm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">core</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">curr</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span>
					<span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="n">mind</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mind</span> <span class="o">=</span> <span class="n">curr</span><span class="p">;</span>
					<span class="n">minvcm</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minpoll</span><span class="p">)</span>
					<span class="n">minpoll</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">vcm_final</span> <span class="o">=</span> <span class="n">minvcm</span><span class="p">;</span>
			<span class="n">results_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">minpoll</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_RX_RSSI_MISC</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span>
				  <span class="n">vcm_final</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">core</span> <span class="o">!=</span> <span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">results</span><span class="p">[</span><span class="n">vcm_final</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">results_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">248</span><span class="p">)</span>
				<span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">32</span><span class="p">;</span>
			<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						   <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
						   <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">core</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">core</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">core</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_core_state</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">core</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">b43_nphy_poll_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">poll_results</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">==</span> <span class="n">core</span><span class="p">)</span>
					<span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">232</span> <span class="o">-</span> <span class="n">poll_results</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">offset</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">core</span><span class="p">],</span> <span class="n">core</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span> <span class="o">%</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span> <span class="n">saved_regs_phy_rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span> <span class="n">saved_regs_phy_rfctl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_RFSEQ_RESET2RX</span><span class="p">);</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD_START</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S1</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD_RXTX</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S1</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">regs_to_store</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">regs_to_store</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">saved_regs_phy</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Store for future configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rssical_radio_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_cache</span><span class="p">.</span><span class="n">rssical_radio_regs_2G</span><span class="p">;</span>
		<span class="n">rssical_phy_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_cache</span><span class="p">.</span><span class="n">rssical_phy_regs_2G</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rssical_radio_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_cache</span><span class="p">.</span><span class="n">rssical_radio_regs_5G</span><span class="p">;</span>
		<span class="n">rssical_phy_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_cache</span><span class="p">.</span><span class="n">rssical_phy_regs_5G</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rssical_radio_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x602B</span><span class="p">);</span>
	<span class="n">rssical_radio_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x702B</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_Z</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_Z</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_Z</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_Z</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_X</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_X</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_X</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_X</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_Y</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_Y</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_Y</span><span class="p">);</span>
	<span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_Y</span><span class="p">);</span>

	<span class="cm">/* Remember for which channel we store configuration */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_chanspec_2G</span><span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_freq</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_chanspec_5G</span><span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_freq</span><span class="p">;</span>

	<span class="cm">/* End of calibration, restore configuration */</span>
	<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
	<span class="n">b43_nphy_write_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clip_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rev2_rssi_cal</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">state</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">class</span><span class="p">,</span> <span class="n">override</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">regs_save_radio</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">regs_save_phy</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">s8</span> <span class="n">offset</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">core</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rail</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">clip_state</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">clip_off</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mh">0xFFFF</span> <span class="p">};</span>
	<span class="n">s32</span> <span class="n">results_min</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">vcm_final</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="n">s32</span> <span class="n">results</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="n">s32</span> <span class="n">miniq</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">class</span> <span class="o">=</span> <span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">b43_nphy_read_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clip_state</span><span class="p">);</span>
	<span class="n">b43_nphy_write_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clip_off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">override</span> <span class="o">=</span> <span class="mh">0x140</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">override</span> <span class="o">=</span> <span class="mh">0x110</span><span class="p">;</span>

	<span class="n">regs_save_phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">);</span>
	<span class="n">regs_save_radio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PD_RXTX</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PD_RXTX</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">regs_save_phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">);</span>
	<span class="n">regs_save_radio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PD_RXTX</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PD_RXTX</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PD_RSSIMISC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PD_RSSIMISC</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PD_RSSIMISC</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">);</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PD_RSSIMISC</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">);</span>
	<span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_SP_RSSI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>
	<span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_SP_RSSI</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">tmp</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">b43_nphy_set_rssi_2055_vcm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43_nphy_poll_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">miniq</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span><span class="p">],</span>
						<span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span> <span class="o">*</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">mind</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">minvcm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s32</span> <span class="n">minpoll</span> <span class="o">=</span> <span class="mi">249</span><span class="p">;</span>
		<span class="n">s32</span> <span class="n">curr</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">curr</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">else</span>
				<span class="n">curr</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">miniq</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">code</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">curr</span> <span class="o">&lt;</span> <span class="n">mind</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">mind</span> <span class="o">=</span> <span class="n">curr</span><span class="p">;</span>
				<span class="n">minvcm</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minpoll</span><span class="p">)</span>
				<span class="n">minpoll</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">results_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">minpoll</span><span class="p">;</span>
		<span class="n">vcm_final</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">minvcm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">b43_nphy_set_rssi_2055_vcm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">vcm_final</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">code</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="n">results</span><span class="p">[</span><span class="n">vcm_final</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">abs</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">results_min</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">248</span><span class="p">)</span>
			<span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">core</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rail</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">b43_nphy_scale_offset_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">core</span><span class="p">,</span> <span class="n">rail</span><span class="p">,</span>
						<span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PD_RSSIMISC</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PD_RSSIMISC</span><span class="p">,</span> <span class="mh">0xF8</span><span class="p">,</span> <span class="n">state</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span> <span class="n">regs_save_phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PD_RXTX</span><span class="p">,</span> <span class="n">regs_save_radio</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span> <span class="n">regs_save_phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PD_RXTX</span><span class="p">,</span> <span class="n">regs_save_radio</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">class</span><span class="p">);</span>
	<span class="n">b43_nphy_write_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clip_state</span><span class="p">);</span>
	<span class="cm">/* Specs don&#39;t say about reset here, but it makes wl and b43 dumps</span>
<span class="cm">	   identical, it really seems wl performs this */</span>
	<span class="n">b43_nphy_reset_cca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * RSSI Calibration</span>
<span class="cm"> * http://bcm-v4.sipsolutions.net/802.11/PHY/N/RSSICal</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rssi_cal</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_nphy_rev3_rssi_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_nphy_rev2_rssi_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSI_Z</span><span class="p">);</span>
		<span class="n">b43_nphy_rev2_rssi_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSI_X</span><span class="p">);</span>
		<span class="n">b43_nphy_rev2_rssi_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSI_Y</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Workarounds</span>
<span class="cm"> **************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_gain_ctl_workarounds_rev3plus</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">ghz5</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ext_lna</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rssi_gain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nphy_gain_ctl_workaround_entry</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lpf_gain</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x12</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">lpf_bits</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span> <span class="p">};</span>

	<span class="cm">/* Prepare values */</span>
	<span class="n">ghz5</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BANDCTL</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">B43_NPHY_BANDCTL_5GHZ</span><span class="p">;</span>
	<span class="n">ext_lna</span> <span class="o">=</span> <span class="n">ghz5</span> <span class="o">?</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_hi</span> <span class="o">&amp;</span> <span class="n">B43_BFH_EXTLNA_5GHZ</span> <span class="o">:</span>
		<span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_EXTLNA</span><span class="p">;</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">b43_nphy_get_gain_ctl_workaround_ent</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ghz5</span><span class="p">,</span> <span class="n">ext_lna</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ghz5</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">rssi_gain</span> <span class="o">=</span> <span class="mh">0x90</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rssi_gain</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RXCTL</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>

	<span class="cm">/* Set Clip 2 detect */</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CGAINI</span><span class="p">,</span>
			<span class="n">B43_NPHY_C1_CGAINI_CL2DETECT</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CGAINI</span><span class="p">,</span>
			<span class="n">B43_NPHY_C2_CGAINI_CL2DETECT</span><span class="p">);</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_BIASPOLE_LNAG1_IDAC</span><span class="p">,</span>
			<span class="mh">0x17</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_BIASPOLE_LNAG1_IDAC</span><span class="p">,</span>
			<span class="mh">0x17</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_LNAG2_IDAC</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_LNAG2_IDAC</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_RSSI_POLE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_RSSI_POLE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_RSSI_GAIN</span><span class="p">,</span>
			<span class="n">rssi_gain</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_RSSI_GAIN</span><span class="p">,</span>
			<span class="n">rssi_gain</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_BIASPOLE_LNAA1_IDAC</span><span class="p">,</span>
			<span class="mh">0x17</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_BIASPOLE_LNAA1_IDAC</span><span class="p">,</span>
			<span class="mh">0x17</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_LNAA2_IDAC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_LNAA2_IDAC</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">);</span>

	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">lna1_gain</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">lna1_gain</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">lna2_gain</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">lna2_gain</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">gain_db</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">gain_db</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">gain_bits</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="mi">10</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">gain_bits</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="n">lpf_gain</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="n">lpf_gain</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="n">lpf_bits</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB8</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">),</span> <span class="mi">6</span><span class="p">,</span> <span class="n">lpf_bits</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_INITGAIN</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">init_gain</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2A7</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">init_gain</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x106</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">e</span><span class="o">-&gt;</span><span class="n">rfseq_init</span><span class="p">);</span>

	<span class="cm">/* TODO: check defines. Do not match variables names */</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CLIP1_MEDGAIN</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">cliphi_gain</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2A9</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">cliphi_gain</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CLIP2_GAIN</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">clipmd_gain</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2AB</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">clipmd_gain</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CLIP1_HIGAIN</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">cliplo_gain</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2AD</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">cliplo_gain</span><span class="p">);</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x27D</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">crsmin</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">crsminl</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x283</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">crsminu</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_NBCLIPTHRES</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">nbclip</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_NBCLIPTHRES</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">nbclip</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CLIPWBTHRES</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_C1_CLIPWBTHRES_CLIP2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">wlclip</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CLIPWBTHRES</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_C2_CLIPWBTHRES_CLIP2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">wlclip</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_CCK_SHIFTB_REF</span><span class="p">,</span> <span class="mh">0x809C</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_gain_ctl_workarounds_rev1_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfseq_events</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">rfseq_delays</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>

	<span class="cm">/* Set Clip 2 detect */</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CGAINI</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CGAINI_CL2DETECT</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CGAINI</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CGAINI_CL2DETECT</span><span class="p">);</span>

	<span class="cm">/* Set narrowband clip threshold */</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_NBCLIPTHRES</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_NBCLIPTHRES</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set dwell lengths */</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_CLIP1_NBDWELL_LEN</span><span class="p">,</span> <span class="mh">0x002B</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_CLIP2_NBDWELL_LEN</span><span class="p">,</span> <span class="mh">0x002B</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_W1CLIP1_DWELL_LEN</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_W1CLIP2_DWELL_LEN</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set wideband clip 2 threshold */</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CLIPWBTHRES</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_C1_CLIPWBTHRES_CLIP2</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CLIPWBTHRES</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_C2_CLIPWBTHRES_CLIP2</span><span class="p">,</span> <span class="mi">21</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CGAINI</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_C1_CGAINI_GAINBKOFF</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CGAINI</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_C2_CGAINI_GAINBKOFF</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_CCK_CGAINI</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_C1_CCK_CGAINI_GAINBKOFF</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CCK_CGAINI</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_C2_CCK_CGAINI_GAINBKOFF</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_CCK_SHIFTB_REF</span><span class="p">,</span> <span class="mh">0x809C</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">gain_boost</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span>
			<span class="n">code</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">code</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">code</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set HPVGA2 index */</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_INITGAIN</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_C1_INITGAIN_HPVGA2</span><span class="p">,</span>
			<span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_C1_INITGAIN_HPVGA2_SHIFT</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_INITGAIN</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_C2_INITGAIN_HPVGA2</span><span class="p">,</span>
			<span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_C2_INITGAIN_HPVGA2_SHIFT</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span> <span class="mh">0x1D06</span><span class="p">);</span>
	<span class="cm">/* specs say about 2 loops, but wl does 4 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="p">(</span><span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="mh">0x7C</span><span class="p">));</span>

	<span class="n">b43_nphy_adjust_lna_gain_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">elna_gain_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span> <span class="mh">0x0C08</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span> <span class="mh">0x1D06</span><span class="p">);</span>
		<span class="cm">/* specs say about 2 loops, but wl does 4 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span>
						<span class="p">(</span><span class="n">code</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="mh">0x74</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span>
					<span class="p">(</span><span class="mh">0x0400</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x0020</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">21</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_set_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">rfseq_events</span><span class="p">,</span> <span class="n">rfseq_delays</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_OVER_DGAIN1</span><span class="p">,</span>
		<span class="o">~</span><span class="n">B43_NPHY_OVER_DGAIN_CCKDGECV</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span>
		<span class="mh">0x5A</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_OVER_DGAIN_CCKDGECV_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N</span><span class="p">(</span><span class="mh">0xC5D</span><span class="p">),</span> <span class="mh">0xFF80</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/WorkaroundsGainCtrl */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_gain_ctl_workarounds</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_gain_ctl_workarounds_rev3plus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_nphy_gain_ctl_workarounds_rev1_2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_workarounds_rev3plus</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>

	<span class="cm">/* TX to RX */</span>
	<span class="n">u8</span> <span class="n">tx2rx_events</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x1F</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">tx2rx_delays</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="cm">/* RX to TX */</span>
	<span class="n">u8</span> <span class="n">rx2tx_events_ipa</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0xF</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span>
					<span class="mh">0x1F</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">rx2tx_delays_ipa</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">rx2tx_events</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x1F</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">rx2tx_delays</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>

	<span class="n">u16</span> <span class="n">tmp16</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x23f</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x240</span><span class="p">,</span> <span class="mh">0x1f8</span><span class="p">);</span>

	<span class="n">tmp32</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="mh">0xffffff</span><span class="p">;</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tmp32</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_A0</span><span class="p">,</span> <span class="mh">0x0125</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_A1</span><span class="p">,</span> <span class="mh">0x01B3</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_A2</span><span class="p">,</span> <span class="mh">0x0105</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_B0</span><span class="p">,</span> <span class="mh">0x016E</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_B1</span><span class="p">,</span> <span class="mh">0x00CD</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_B2</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_CLIP1_MEDGAIN</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2AE</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>

	<span class="cm">/* TX to RX */</span>
	<span class="n">b43_nphy_set_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tx2rx_events</span><span class="p">,</span> <span class="n">tx2rx_delays</span><span class="p">,</span>
				 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tx2rx_events</span><span class="p">));</span>

	<span class="cm">/* RX to TX */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">b43_nphy_set_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rx2tx_events_ipa</span><span class="p">,</span>
				<span class="n">rx2tx_delays_ipa</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rx2tx_events_ipa</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hw_phyrxchain</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hw_phyrxchain</span> <span class="o">!=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hw_phytxchain</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rx2tx_delays</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">59</span><span class="p">;</span>
			<span class="n">rx2tx_delays</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rx2tx_events</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1F</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b43_nphy_set_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rx2tx_events</span><span class="p">,</span> <span class="n">rx2tx_delays</span><span class="p">,</span>
					 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rx2tx_events</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">tmp16</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">?</span>
		<span class="mh">0x2</span> <span class="o">:</span> <span class="mh">0x9C40</span><span class="p">;</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_ENDROP_TLEN</span><span class="p">,</span> <span class="n">tmp16</span><span class="p">);</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x294</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0700</span><span class="p">);</span>

	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mh">0x18D</span><span class="p">);</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">127</span><span class="p">),</span> <span class="mh">0x18D</span><span class="p">);</span>

	<span class="n">b43_nphy_gain_ctl_workarounds</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* TODO */</span>

	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_MAST_BIAS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_MAST_BIAS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_BIAS_MAIN</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_BIAS_MAIN</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_BIAS_AUX</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_BIAS_AUX</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_LOB_BIAS</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_LOB_BIAS</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_CMFB_IDAC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_MIXA_CMFB_IDAC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX0</span> <span class="o">|</span> <span class="n">B2056_RX_MIXG_CMFB_IDAC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_RX1</span> <span class="o">|</span> <span class="n">B2056_RX_MIXG_CMFB_IDAC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* N PHY WAR TX Chain Update with hw_phytxchain as argument */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_APLL_WAR</span> <span class="o">&amp;&amp;</span>
	     <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_GPLL_WAR</span> <span class="o">&amp;&amp;</span>
	     <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">))</span>
		<span class="n">tmp32</span> <span class="o">=</span> <span class="mh">0x00088888</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp32</span> <span class="o">=</span> <span class="mh">0x88888888</span><span class="p">;</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tmp32</span><span class="p">);</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tmp32</span><span class="p">);</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">tmp32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
		<span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_GMBB_IDAC</span><span class="p">,</span>
				<span class="mh">0x70</span><span class="p">);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_GMBB_IDAC</span><span class="p">,</span>
				<span class="mh">0x70</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x224</span><span class="p">,</span> <span class="mh">0x03eb</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x225</span><span class="p">,</span> <span class="mh">0x03eb</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x226</span><span class="p">,</span> <span class="mh">0x0341</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x227</span><span class="p">,</span> <span class="mh">0x0341</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x228</span><span class="p">,</span> <span class="mh">0x042b</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x229</span><span class="p">,</span> <span class="mh">0x042b</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x22a</span><span class="p">,</span> <span class="mh">0x0381</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x22b</span><span class="p">,</span> <span class="mh">0x0381</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x22c</span><span class="p">,</span> <span class="mh">0x042b</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x22d</span><span class="p">,</span> <span class="mh">0x042b</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x22e</span><span class="p">,</span> <span class="mh">0x0381</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x22f</span><span class="p">,</span> <span class="mh">0x0381</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_workarounds_rev1_2</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">events1</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x3</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">delays1</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">};</span>

	<span class="n">u8</span> <span class="n">events2</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x8</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">delays2</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mh">0x1</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span> <span class="o">&amp;&amp;</span>
	    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">band5g_pwrgain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_RF_SPARE</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x8</span><span class="p">);</span>
		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_RF_SPARE</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_RF_SPARE</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_RF_SPARE</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">),</span> <span class="mh">0x000A</span><span class="p">);</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">),</span> <span class="mh">0x000A</span><span class="p">);</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">),</span> <span class="mh">0xCDAA</span><span class="p">);</span>
	<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">),</span> <span class="mh">0xCDAA</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">),</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">),</span> <span class="mh">0x7AAB</span><span class="p">);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">),</span> <span class="mh">0x7AAB</span><span class="p">);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">),</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">),</span> <span class="mh">0x0800</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_LO1</span><span class="p">,</span> <span class="mh">0x2D8</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP1</span><span class="p">,</span> <span class="mh">0x301</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_LO2</span><span class="p">,</span> <span class="mh">0x2D8</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP2</span><span class="p">,</span> <span class="mh">0x301</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_SKWRKFEM_BRD</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="mh">0x8B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delays1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">delays1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x14</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_nphy_set_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">events1</span><span class="p">,</span> <span class="n">delays1</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">b43_nphy_set_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">events2</span><span class="p">,</span> <span class="n">delays2</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">b43_nphy_gain_ctl_workarounds</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RXCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">B43_HF_MLADVW</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_CRSCHECK2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_CRSCHECK3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SCRAM_SIGCTL</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_SCRAM_SIGCTL_SCM</span><span class="p">);</span>

	<span class="cm">/* Set phase track alpha and beta */</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_A0</span><span class="p">,</span> <span class="mh">0x125</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_A1</span><span class="p">,</span> <span class="mh">0x1B3</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_A2</span><span class="p">,</span> <span class="mh">0x105</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_B0</span><span class="p">,</span> <span class="mh">0x16E</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_B1</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PHASETR_B2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PIL_DW1</span><span class="p">,</span>
			<span class="o">~</span><span class="n">B43_NPHY_PIL_DW_64QAM</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_20CO_S2B1</span><span class="p">,</span> <span class="mh">0xB5</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_20CO_S2B2</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_20CO_S2B3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_FINERX2_CGC</span><span class="p">,</span>
				<span class="n">B43_NPHY_FINERX2_CGC_DECGC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/Workarounds */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_workarounds</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQFLIP</span><span class="p">,</span>
		    <span class="n">B43_NPHY_IQFLIP_ADC1</span> <span class="o">|</span> <span class="n">B43_NPHY_IQFLIP_ADC2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_workarounds_rev3plus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_nphy_workarounds_rev1_2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Tx/Rx common</span>
<span class="cm"> **************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Transmits a known value for LO calibration</span>
<span class="cm"> * http://bcm-v4.sipsolutions.net/802.11/PHY/N/TXTone</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_tx_tone</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">u16</span> <span class="n">max_val</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">iqmode</span><span class="p">,</span> <span class="n">bool</span> <span class="n">dac_test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">samp</span> <span class="o">=</span> <span class="n">b43_nphy_gen_load_samples</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">dac_test</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">samp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">b43_nphy_run_samples</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">samp</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iqmode</span><span class="p">,</span> <span class="n">dac_test</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/Chains */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_update_txrx_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">bool</span> <span class="n">override</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chain</span> <span class="o">=</span> <span class="mh">0x33</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txrx_chain</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chain</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="n">override</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txrx_chain</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chain</span> <span class="o">=</span> <span class="mh">0x22</span><span class="p">;</span>
		<span class="n">override</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQCA</span><span class="p">,</span>
			<span class="o">~</span><span class="p">(</span><span class="n">B43_NPHY_RFSEQCA_TXEN</span> <span class="o">|</span> <span class="n">B43_NPHY_RFSEQCA_RXEN</span><span class="p">),</span>
			<span class="n">chain</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">override</span><span class="p">)</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">,</span>
				<span class="n">B43_NPHY_RFSEQMODE_CAOVER</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_RFSEQMODE_CAOVER</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/stop-playback */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_stop_playback</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_STAT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_CMD</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_CMD_STOP</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQLOCAL_CMDGCTL</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>

	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_SAMP_CMD</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0004</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">bb_mult_save</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">bb_mult_save</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">;</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">87</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">bb_mult_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IqCalGainParams */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_iq_cal_gain_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">core</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="n">target</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">nphy_iqcal_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">indx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gain</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">txgm</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">txgm</span><span class="p">[</span><span class="n">core</span><span class="p">];</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">pga</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">pga</span><span class="p">[</span><span class="n">core</span><span class="p">];</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">pad</span><span class="p">[</span><span class="n">core</span><span class="p">];</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">ipa</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">ipa</span><span class="p">[</span><span class="n">core</span><span class="p">];</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cal_gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">txgm</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pga</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">ipa</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">ncorr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x79</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">pad</span><span class="p">[</span><span class="n">core</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">pga</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">txgm</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">indx</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="o">?</span>
			<span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbl_iqcal_gainparams</span><span class="p">[</span><span class="n">indx</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">gain</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

		<span class="n">params</span><span class="o">-&gt;</span><span class="n">txgm</span> <span class="o">=</span> <span class="n">tbl_iqcal_gainparams</span><span class="p">[</span><span class="n">indx</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">pga</span> <span class="o">=</span> <span class="n">tbl_iqcal_gainparams</span><span class="p">[</span><span class="n">indx</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">=</span> <span class="n">tbl_iqcal_gainparams</span><span class="p">[</span><span class="n">indx</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">params</span><span class="o">-&gt;</span><span class="n">cal_gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">txgm</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pga</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">ncorr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tbl_iqcal_gainparams</span><span class="p">[</span><span class="n">indx</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span> <span class="o">+</span> <span class="n">j</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Tx and Rx</span>
<span class="cm"> **************************************************/</span>

<span class="kt">void</span> <span class="nf">b43_nphy_set_rxantenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span><span class="c1">//TODO</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_op_adjust_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span><span class="c1">//TODO</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">b43_txpwr_result</span> <span class="nf">b43_nphy_op_recalc_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">bool</span> <span class="n">ignore_tssi</span><span class="p">)</span>
<span class="p">{</span><span class="c1">//TODO</span>
	<span class="k">return</span> <span class="n">B43_TXPWR_RES_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlEnable */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_power_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bmask</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span> <span class="o">=</span> <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrctrl</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">)</span> <span class="o">&amp;</span>
		     <span class="p">(</span><span class="n">B43_NPHY_TXPCTL_CMD_COEFF</span> <span class="o">|</span>
		      <span class="n">B43_NPHY_TXPCTL_CMD_HWPCTLEN</span> <span class="o">|</span>
		      <span class="n">B43_NPHY_TXPCTL_CMD_PCTLEN</span><span class="p">)))</span> <span class="p">{</span>
			<span class="cm">/* We disable enabled TX pwr ctl, save it&#39;s state */</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_pwr_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">B43_NPHY_C1_TXPCTL_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_pwr_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">B43_NPHY_C2_TXPCTL_STAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span> <span class="mh">0x6840</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">84</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span> <span class="mh">0x6C40</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">84</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">B43_NPHY_TXPCTL_CMD_COEFF</span> <span class="o">|</span> <span class="n">B43_NPHY_TXPCTL_CMD_HWPCTLEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">B43_NPHY_TXPCTL_CMD_PCTLEN</span><span class="p">;</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">,</span> <span class="o">~</span><span class="n">tmp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BPHY_CTL3</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_BPHY_CTL3_SCALE</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BPHY_CTL3</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_BPHY_CTL3_SCALE</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span>
			<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_HF_TSSIRPSMW</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="mi">84</span><span class="p">,</span>
				    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">adj_pwr_tbl</span><span class="p">);</span>
		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="mi">84</span><span class="p">,</span>
				    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">adj_pwr_tbl</span><span class="p">);</span>

		<span class="n">bmask</span> <span class="o">=</span> <span class="n">B43_NPHY_TXPCTL_CMD_COEFF</span> <span class="o">|</span>
			<span class="n">B43_NPHY_TXPCTL_CMD_HWPCTLEN</span><span class="p">;</span>
		<span class="cm">/* wl does useless check for &quot;enable&quot; param here */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">B43_NPHY_TXPCTL_CMD_COEFF</span> <span class="o">|</span> <span class="n">B43_NPHY_TXPCTL_CMD_HWPCTLEN</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmask</span> <span class="o">|=</span> <span class="n">B43_NPHY_TXPCTL_CMD_PCTLEN</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">|=</span> <span class="n">B43_NPHY_TXPCTL_CMD_PCTLEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">bmask</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">,</span>
					<span class="o">~</span><span class="n">B43_NPHY_TXPCTL_CMD_INIT</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_INIT</span><span class="p">,</span>
						<span class="o">~</span><span class="n">B43_NPHY_TXPCTL_INIT_PIDXI1</span><span class="p">,</span>
						<span class="mh">0x64</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_pwr_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span> <span class="o">&amp;&amp;</span>
			    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_pwr_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Recover TX pwr ctl state */</span>
				<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">,</span>
						<span class="o">~</span><span class="n">B43_NPHY_TXPCTL_CMD_INIT</span><span class="p">,</span>
						<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_pwr_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">B43_NPHY_TXPCTL_INIT</span><span class="p">,</span>
						<span class="o">~</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_pwr_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x100</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x4000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BPHY_CTL3</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BPHY_CTL3</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span>
			<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_HF_TSSIRPSMW</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN0</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN1</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrFix */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_power_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">txpi</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">bbmult</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">radio_gain</span><span class="p">,</span> <span class="n">dac_gain</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">txgain</span><span class="p">;</span>
	<span class="cm">/* u32 gaintbl; rev3+ */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">72</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">txpid2g</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">txpid2g</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">4900</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">5100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">txpid5gl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">txpid5gl</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">5100</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">5500</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">txpid5g</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">txpid5g</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">5500</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">txpid5gh</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">txpid5gh</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span>
			<span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span> <span class="o">||</span> <span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">||</span> <span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">40</span> <span class="o">||</span> <span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">))</span>
		<span class="n">txpi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">txpi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">91</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	for (i = 0; i &lt; 2; i++) {</span>
<span class="cm">		nphy-&gt;txpwrindex[i].index_internal = txpi[i];</span>
<span class="cm">		nphy-&gt;txpwrindex[i].index_internal_save = txpi[i];</span>
<span class="cm">	}</span>
<span class="cm">	*/</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txgain</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">b43_nphy_get_tx_gain_table</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">+</span> <span class="n">txpi</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">radio_gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">txgain</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFFF</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">radio_gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">txgain</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1FFF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">dac_gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">txgain</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dac_gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">txgain</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="n">bbmult</span> <span class="o">=</span> <span class="n">txgain</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_DACGAIN1</span><span class="p">,</span> <span class="n">dac_gain</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_DACGAIN2</span><span class="p">,</span> <span class="n">dac_gain</span><span class="p">);</span>

		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mh">0x7</span><span class="p">,</span> <span class="mh">0x110</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">radio_gain</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mh">0xF</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">bbmult</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">|</span> <span class="n">bbmult</span><span class="p">;</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mh">0xF</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">B43_NPHY_PAPD_EN0</span> <span class="o">:</span> <span class="n">B43_NPHY_PAPD_EN1</span><span class="p">;</span>
			<span class="n">tmp32</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">26</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
							      <span class="mi">576</span> <span class="o">+</span> <span class="n">txpi</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0xE00F</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">tmp32</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BPHY_CTL2</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_BPHY_CTL2_LUT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_ipa_internal_tssi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">r</span><span class="p">;</span> <span class="cm">/* routing */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">core</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">core</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">core</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span> <span class="o">?</span> <span class="mh">0x190</span> <span class="o">:</span> <span class="mh">0x170</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0xA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0xB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0xB</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">,</span> <span class="mh">0xC</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0xB</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0xA</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0xA</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0x6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0x7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0x8</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0xC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_RESERVED_ADDR31</span><span class="p">,</span> <span class="mh">0x128</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_RESERVED_ADDR31</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_RESERVED_ADDR30</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2056_SYN_GPIO_MASTER1</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">core</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">core</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">core</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">core</span> <span class="o">?</span> <span class="n">B2056_TX1</span> <span class="o">:</span> <span class="n">B2056_TX0</span><span class="p">;</span>

			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_IQCAL_VCM_HG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_IQCAL_IDAC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSI_VCM</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TX_AMP_DET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSI_MISC1</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSI_MISC2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSI_MISC3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TX_SSI_MASTER</span><span class="p">,</span>
						<span class="mh">0x5</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSIA</span><span class="p">,</span>
							<span class="mh">0x00</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSIG</span><span class="p">,</span>
							<span class="mh">0x31</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSIG</span><span class="p">,</span>
							<span class="mh">0x11</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TX_SSI_MUX</span><span class="p">,</span>
						<span class="mh">0xE</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TX_SSI_MASTER</span><span class="p">,</span>
						<span class="mh">0x9</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSIA</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TSSIG</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">|</span> <span class="n">B2056_TX_TX_SSI_MUX</span><span class="p">,</span>
						<span class="mh">0xC</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Stop radio and transmit known signal. Then check received signal strength to</span>
<span class="cm"> * get TSSI (Transmit Signal Strength Indicator).</span>
<span class="cm"> * http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlIdleTssi</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_power_ctl_idle_tssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rssi</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

	<span class="cm">/* TODO: check if we can transmit */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">b43_nphy_ipa_internal_tssi_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* TODO: Override Rev7 with 0x2000, 0, 3, 0, 0 as arguments */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">b43_nphy_stop_playback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_nphy_tx_tone</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xFA0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_nphy_poll_rssi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rssi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">b43_nphy_stop_playback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_nphy_rssi_select</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/* TODO: Override Rev7 with 0x2000, 0, 3, 1, 0 as arguments */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idle_tssi_5g</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idle_tssi_5g</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idle_tssi_5g</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idle_tssi_5g</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idle_tssi_2g</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idle_tssi_2g</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/PHY/N/TxPwrLimitToTbl */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_prepare_adjusted_power_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">stf_mode</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">adj_pwr_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">stf_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">stf_mode</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">stf_mode</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">stf_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idx</span> <span class="o">=</span> <span class="mi">68</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">?</span> <span class="mi">52</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">?</span> <span class="mi">76</span> <span class="o">:</span> <span class="mi">28</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">?</span> <span class="mi">84</span> <span class="o">:</span> <span class="mi">36</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">idx</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">?</span> <span class="mi">92</span> <span class="o">:</span> <span class="mi">44</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">adj_pwr_tbl</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">stf_mode</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_power_offset</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">idx</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
				<span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">delta</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">||</span>
			    <span class="n">i</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
				<span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlSetup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_power_ctl_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>

	<span class="n">s16</span> <span class="n">a1</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">b0</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">b1</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">idle</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">s8</span> <span class="n">target</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">s32</span> <span class="n">num</span><span class="p">,</span> <span class="n">den</span><span class="p">,</span> <span class="n">pwr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">u16</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_freq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">r</span><span class="p">;</span> <span class="cm">/* routing */</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">);</span>
		<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TSSIMODE</span><span class="p">,</span> <span class="n">B43_NPHY_TSSIMODE_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">,</span>
			     <span class="o">~</span><span class="n">B43_NPHY_TXPCTL_CMD_PCTLEN</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">,</span>
			    <span class="n">B43_NPHY_TXPCTL_CMD_PCTLEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x200000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idle_tssi_2g</span><span class="p">;</span>
		<span class="n">idle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idle_tssi_2g</span><span class="p">;</span>
		<span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">52</span><span class="p">;</span>
		<span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">424</span><span class="p">;</span>
		<span class="n">b0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5612</span><span class="p">;</span>
		<span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1393</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idle</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">idle_tssi_2g</span><span class="p">;</span>
				<span class="n">target</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">maxpwr_2g</span><span class="p">;</span>
				<span class="n">a1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_2g</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">b0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_2g</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">b1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_2g</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">4900</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">5100</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idle</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">idle_tssi_5g</span><span class="p">;</span>
				<span class="n">target</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">maxpwr_5gl</span><span class="p">;</span>
				<span class="n">a1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5gl</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">b0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5gl</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">b1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5gl</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">5100</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">5500</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idle</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">idle_tssi_5g</span><span class="p">;</span>
				<span class="n">target</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">maxpwr_5g</span><span class="p">;</span>
				<span class="n">a1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5g</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">b0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5g</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">b1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5g</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">5500</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idle</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">idle_tssi_5g</span><span class="p">;</span>
				<span class="n">target</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">maxpwr_5gh</span><span class="p">;</span>
				<span class="n">a1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5gh</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">b0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5gh</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">b1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">core_pwr_info</span><span class="p">[</span><span class="n">c</span><span class="p">].</span><span class="n">pa_5gh</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">idle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idle_tssi_5g</span><span class="p">;</span>
			<span class="n">idle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwr_ctl_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">idle_tssi_5g</span><span class="p">;</span>
			<span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">52</span><span class="p">;</span>
			<span class="n">a1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">424</span><span class="p">;</span>
			<span class="n">b0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5612</span><span class="p">;</span>
			<span class="n">b1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1393</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* target[0] = target[1] = nphy-&gt;tx_power_max; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">fem</span><span class="p">.</span><span class="n">ghz2</span><span class="p">.</span><span class="n">tssipos</span><span class="p">)</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_ITSSI</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">c</span> <span class="o">?</span> <span class="mh">0x190</span> <span class="o">:</span> <span class="mh">0x170</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
					<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">r</span> <span class="o">+</span> <span class="mh">0x9</span><span class="p">,</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xE</span> <span class="o">:</span> <span class="mh">0xC</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xC</span> <span class="o">:</span> <span class="mh">0xE</span><span class="p">;</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_TX_SSI_MUX</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_TX_SSI_MUX</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B2056_TX0</span> <span class="o">|</span> <span class="n">B2056_TX_TX_SSI_MUX</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
				<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B2056_TX1</span> <span class="o">|</span> <span class="n">B2056_TX_TX_SSI_MUX</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x200000</span><span class="p">);</span>
		<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_TXPCTL_CMD_INIT</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_INIT</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_TXPCTL_INIT_PIDXI1</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_CMD</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_TXPCTL_CMD_INIT</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_INIT</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_TXPCTL_INIT_PIDXI1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x200000</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_N</span><span class="p">,</span>
		      <span class="mh">0xF0</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_TXPCTL_N_TSSID_SHIFT</span> <span class="o">|</span>
		      <span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_TXPCTL_N_NPTIL2_SHIFT</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_ITSSI</span><span class="p">,</span>
		      <span class="n">idle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_TXPCTL_ITSSI_0_SHIFT</span> <span class="o">|</span>
		      <span class="n">idle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_TXPCTL_ITSSI_1_SHIFT</span> <span class="o">|</span>
		      <span class="n">B43_NPHY_TXPCTL_ITSSI_BINF</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXPCTL_TPWR</span><span class="p">,</span>
		      <span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_TXPCTL_TPWR_0_SHIFT</span> <span class="o">|</span>
		      <span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_TXPCTL_TPWR_1_SHIFT</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">num</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">b0</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="n">b1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">den</span> <span class="o">=</span> <span class="mi">32768</span> <span class="o">+</span> <span class="n">a1</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">pwr</span> <span class="o">=</span> <span class="n">max</span><span class="p">((</span><span class="mi">4</span> <span class="o">*</span> <span class="n">num</span> <span class="o">+</span> <span class="n">den</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">den</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">idle</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
				<span class="n">pwr</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">pwr</span><span class="p">,</span> <span class="n">target</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">regval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pwr</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">26</span> <span class="o">+</span> <span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">64</span><span class="p">,</span> <span class="n">regval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_tx_prepare_adjusted_power_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	b43_ntab_write_bulk(dev, B43_NTAB16(26, 64), 84, nphy-&gt;adj_pwr_tbl);</span>
<span class="cm">	b43_ntab_write_bulk(dev, B43_NTAB16(27, 64), 84, nphy-&gt;adj_pwr_tbl);</span>
<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_gain_table_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfpwr_offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pga_gain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">b43_nphy_get_tx_gain_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">192</span><span class="p">),</span> <span class="mi">128</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">192</span><span class="p">),</span> <span class="mi">128</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		nphy-&gt;gmval = (table[0] &gt;&gt; 16) &amp; 0x7000;</span>
<span class="cp">#endif</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pga_gain</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
				<span class="n">rfpwr_offset</span> <span class="o">=</span>
				 <span class="n">b43_ntab_papd_pga_gain_delta_ipa_2g</span><span class="p">[</span><span class="n">pga_gain</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">rfpwr_offset</span> <span class="o">=</span>
				 <span class="mi">0</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
			<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">26</span><span class="p">,</span> <span class="mi">576</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
				       <span class="n">rfpwr_offset</span><span class="p">);</span>
			<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB32</span><span class="p">(</span><span class="mi">27</span><span class="p">,</span> <span class="mi">576</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
				       <span class="n">rfpwr_offset</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/PA%20override */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_pa_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rfctrl_intc1_save</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">);</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rfctrl_intc2_save</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">);</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x600</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x480</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x180</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x120</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span>
				<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rfctrl_intc1_save</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span>
				<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rfctrl_intc2_save</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxLpFbw */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_lp_fbw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B32S2</span><span class="p">,</span>
			      <span class="p">(((((</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S2</span><span class="p">,</span>
			      <span class="p">(((((</span><span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqEst */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rx_iq_est</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">nphy_iq_est</span> <span class="o">*</span><span class="n">est</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">samps</span><span class="p">,</span> <span class="n">u8</span> <span class="n">time</span><span class="p">,</span> <span class="n">bool</span> <span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_SAMCNT</span><span class="p">,</span> <span class="n">samps</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_WT</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_IQEST_WT_VAL</span><span class="p">,</span> <span class="n">time</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait</span><span class="p">)</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_CMD</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_CMD_MODE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_CMD</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_IQEST_CMD_MODE</span><span class="p">);</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_CMD</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_CMD_START</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_CMD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_NPHY_IQEST_CMD_START</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">est</span><span class="o">-&gt;</span><span class="n">i0_pwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_IPACC_HI0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_IPACC_LO0</span><span class="p">);</span>
			<span class="n">est</span><span class="o">-&gt;</span><span class="n">q0_pwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_QPACC_HI0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_QPACC_LO0</span><span class="p">);</span>
			<span class="n">est</span><span class="o">-&gt;</span><span class="n">iq0_prod</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_IQACC_HI0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_IQACC_LO0</span><span class="p">);</span>

			<span class="n">est</span><span class="o">-&gt;</span><span class="n">i1_pwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_IPACC_HI1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_IPACC_LO1</span><span class="p">);</span>
			<span class="n">est</span><span class="o">-&gt;</span><span class="n">q1_pwr</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_QPACC_HI1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_QPACC_LO1</span><span class="p">);</span>
			<span class="n">est</span><span class="o">-&gt;</span><span class="n">iq1_prod</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_IQACC_HI1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQEST_IQACC_LO1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">est</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">est</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxIqCoeffs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_rx_iq_coeffs</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">write</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">b43_phy_n_iq_comp</span> <span class="o">*</span><span class="n">pcomp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_RXIQ_COMPA0</span><span class="p">,</span> <span class="n">pcomp</span><span class="o">-&gt;</span><span class="n">a0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_RXIQ_COMPB0</span><span class="p">,</span> <span class="n">pcomp</span><span class="o">-&gt;</span><span class="n">b0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_RXIQ_COMPA1</span><span class="p">,</span> <span class="n">pcomp</span><span class="o">-&gt;</span><span class="n">a1</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_RXIQ_COMPB1</span><span class="p">,</span> <span class="n">pcomp</span><span class="o">-&gt;</span><span class="n">b1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pcomp</span><span class="o">-&gt;</span><span class="n">a0</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_RXIQ_COMPA0</span><span class="p">);</span>
		<span class="n">pcomp</span><span class="o">-&gt;</span><span class="n">b0</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_RXIQ_COMPB0</span><span class="p">);</span>
		<span class="n">pcomp</span><span class="o">-&gt;</span><span class="n">a1</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_RXIQ_COMPA1</span><span class="p">);</span>
		<span class="n">pcomp</span><span class="o">-&gt;</span><span class="n">b1</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_RXIQ_COMPB1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* Ready but not used anywhere */</span>
<span class="c">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCalPhyCleanup */</span>
<span class="c">static void b43_nphy_rx_cal_phy_cleanup(struct b43_wldev *dev, u8 core)</span>
<span class="c">{</span>
<span class="c">	u16 *regs = dev-&gt;phy.n-&gt;tx_rx_cal_phy_saveregs;</span>

<span class="c">	b43_phy_write(dev, B43_NPHY_RFSEQCA, regs[0]);</span>
<span class="c">	if (core == 0) {</span>
<span class="c">		b43_phy_write(dev, B43_NPHY_AFECTL_C1, regs[1]);</span>
<span class="c">		b43_phy_write(dev, B43_NPHY_AFECTL_OVER1, regs[2]);</span>
<span class="c">	} else {</span>
<span class="c">		b43_phy_write(dev, B43_NPHY_AFECTL_C2, regs[1]);</span>
<span class="c">		b43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[2]);</span>
<span class="c">	}</span>
<span class="c">	b43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[3]);</span>
<span class="c">	b43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[4]);</span>
<span class="c">	b43_phy_write(dev, B43_NPHY_RFCTL_RSSIO1, regs[5]);</span>
<span class="c">	b43_phy_write(dev, B43_NPHY_RFCTL_RSSIO2, regs[6]);</span>
<span class="c">	b43_phy_write(dev, B43_NPHY_TXF_40CO_B1S1, regs[7]);</span>
<span class="c">	b43_phy_write(dev, B43_NPHY_RFCTL_OVER, regs[8]);</span>
<span class="c">	b43_phy_write(dev, B43_NPHY_PAPD_EN0, regs[9]);</span>
<span class="c">	b43_phy_write(dev, B43_NPHY_PAPD_EN1, regs[10]);</span>
<span class="c">}</span>

<span class="c">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCalPhySetup */</span>
<span class="c">static void b43_nphy_rx_cal_phy_setup(struct b43_wldev *dev, u8 core)</span>
<span class="c">{</span>
<span class="c">	u8 rxval, txval;</span>
<span class="c">	u16 *regs = dev-&gt;phy.n-&gt;tx_rx_cal_phy_saveregs;</span>

<span class="c">	regs[0] = b43_phy_read(dev, B43_NPHY_RFSEQCA);</span>
<span class="c">	if (core == 0) {</span>
<span class="c">		regs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);</span>
<span class="c">		regs[2] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);</span>
<span class="c">	} else {</span>
<span class="c">		regs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);</span>
<span class="c">		regs[2] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);</span>
<span class="c">	}</span>
<span class="c">	regs[3] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);</span>
<span class="c">	regs[4] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);</span>
<span class="c">	regs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO1);</span>
<span class="c">	regs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO2);</span>
<span class="c">	regs[7] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B1S1);</span>
<span class="c">	regs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_OVER);</span>
<span class="c">	regs[9] = b43_phy_read(dev, B43_NPHY_PAPD_EN0);</span>
<span class="c">	regs[10] = b43_phy_read(dev, B43_NPHY_PAPD_EN1);</span>

<span class="c">	b43_phy_mask(dev, B43_NPHY_PAPD_EN0, ~0x0001);</span>
<span class="c">	b43_phy_mask(dev, B43_NPHY_PAPD_EN1, ~0x0001);</span>

<span class="c">	b43_phy_maskset(dev, B43_NPHY_RFSEQCA,</span>
<span class="c">			~B43_NPHY_RFSEQCA_RXDIS &amp; 0xFFFF,</span>
<span class="c">			((1 - core) &lt;&lt; B43_NPHY_RFSEQCA_RXDIS_SHIFT));</span>
<span class="c">	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXEN,</span>
<span class="c">			((1 - core) &lt;&lt; B43_NPHY_RFSEQCA_TXEN_SHIFT));</span>
<span class="c">	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXEN,</span>
<span class="c">			(core &lt;&lt; B43_NPHY_RFSEQCA_RXEN_SHIFT));</span>
<span class="c">	b43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXDIS,</span>
<span class="c">			(core &lt;&lt; B43_NPHY_RFSEQCA_TXDIS_SHIFT));</span>

<span class="c">	if (core == 0) {</span>
<span class="c">		b43_phy_mask(dev, B43_NPHY_AFECTL_C1, ~0x0007);</span>
<span class="c">		b43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x0007);</span>
<span class="c">	} else {</span>
<span class="c">		b43_phy_mask(dev, B43_NPHY_AFECTL_C2, ~0x0007);</span>
<span class="c">		b43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0007);</span>
<span class="c">	}</span>

<span class="c">	b43_nphy_rf_control_intc_override(dev, 2, 0, 3);</span>
<span class="c">	b43_nphy_rf_control_override(dev, 8, 0, 3, false);</span>
<span class="c">	b43_nphy_force_rf_sequence(dev, B43_RFSEQ_RX2TX);</span>

<span class="c">	if (core == 0) {</span>
<span class="c">		rxval = 1;</span>
<span class="c">		txval = 8;</span>
<span class="c">	} else {</span>
<span class="c">		rxval = 4;</span>
<span class="c">		txval = 2;</span>
<span class="c">	}</span>
<span class="c">	b43_nphy_rf_control_intc_override(dev, 1, rxval, (core + 1));</span>
<span class="c">	b43_nphy_rf_control_intc_override(dev, 1, txval, (2 - core));</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalcRxIqComp */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_calc_rx_iq_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">iq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ii</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">qq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iq_nbits</span><span class="p">,</span> <span class="n">qq_nbits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">arsh</span><span class="p">,</span> <span class="n">brsh</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">nphy_iq_est</span> <span class="n">est</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n_iq_comp</span> <span class="n">old</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n_iq_comp</span> <span class="n">new</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="n">bool</span> <span class="n">error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">b43_nphy_rx_iq_coeffs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="p">);</span>
	<span class="n">b43_nphy_rx_iq_coeffs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">);</span>
	<span class="n">b43_nphy_rx_iq_est</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">est</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">new</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iq</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">iq0_prod</span><span class="p">;</span>
			<span class="n">ii</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">i0_pwr</span><span class="p">;</span>
			<span class="n">qq</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">q0_pwr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">iq</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">iq1_prod</span><span class="p">;</span>
			<span class="n">ii</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">i1_pwr</span><span class="p">;</span>
			<span class="n">qq</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">q1_pwr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ii</span> <span class="o">+</span> <span class="n">qq</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">iq_nbits</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">iq</span><span class="p">));</span>
		<span class="n">qq_nbits</span> <span class="o">=</span> <span class="n">fls</span><span class="p">(</span><span class="n">qq</span><span class="p">);</span>

		<span class="n">arsh</span> <span class="o">=</span> <span class="n">iq_nbits</span> <span class="o">-</span> <span class="mi">20</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arsh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">iq</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="n">iq_nbits</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">arsh</span><span class="p">)));</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">&gt;&gt;</span> <span class="n">arsh</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">iq</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="n">iq_nbits</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">ii</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">-</span> <span class="n">arsh</span><span class="p">)));</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="n">arsh</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">a</span> <span class="o">/=</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">brsh</span> <span class="o">=</span> <span class="n">qq_nbits</span> <span class="o">-</span> <span class="mi">11</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brsh</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">qq</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">qq_nbits</span><span class="p">));</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">&gt;&gt;</span> <span class="n">brsh</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">qq</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">31</span> <span class="o">-</span> <span class="n">qq_nbits</span><span class="p">));</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">&lt;&lt;</span> <span class="o">-</span><span class="n">brsh</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">int_sqrt</span><span class="p">(</span><span class="n">b</span> <span class="o">/</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">a</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new</span><span class="p">.</span><span class="n">a0</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
				<span class="n">new</span><span class="p">.</span><span class="n">b0</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">new</span><span class="p">.</span><span class="n">a0</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
				<span class="n">new</span><span class="p">.</span><span class="n">b0</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new</span><span class="p">.</span><span class="n">a1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
				<span class="n">new</span><span class="p">.</span><span class="n">b1</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">new</span><span class="p">.</span><span class="n">a1</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
				<span class="n">new</span><span class="p">.</span><span class="n">b1</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">old</span><span class="p">;</span>

	<span class="n">b43_nphy_rx_iq_coeffs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxIqWar */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_iq_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mh">0xF</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">array</span><span class="p">);</span>

	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_NPHY_TXIQW0</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_NPHY_TXIQW1</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_NPHY_TXIQW2</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_NPHY_TXIQW3</span><span class="p">,</span> <span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SpurWar */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_spur_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tone</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">58</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x3FF</span><span class="p">,</span> <span class="mh">0x3FF</span> <span class="p">};</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">gband_spurwar_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* TODO: N PHY Adjust Analog Pfbw (7) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span>
			<span class="p">;</span> <span class="cm">/* TODO: N PHY Adjust Min Noise Var(2, tone, noise)*/</span>
		<span class="k">else</span>
			<span class="p">;</span> <span class="cm">/* TODO: N PHY Adjust Min Noise Var(0, NULL, NULL)*/</span>
		<span class="cm">/* TODO: N PHY Adjust CRS Min Power (0x1E) */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">aband_spurwar_en</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">54</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x25F</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">38</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">==</span> <span class="mi">102</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">==</span> <span class="mi">118</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="cm">/* FIXME */</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
				<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21F</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">134</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x21F</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">151</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x23F</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">153</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">==</span> <span class="mi">161</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x23F</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="p">;</span> <span class="cm">/* TODO: N PHY Adjust Min Noise Var(1, tone, noise)*/</span>
		<span class="k">else</span>
			<span class="p">;</span> <span class="cm">/* TODO: N PHY Adjust Min Noise Var(0, NULL, NULL)*/</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxPwrCtrlCoefSetup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_pwr_ctrl_coef_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cur_real</span><span class="p">,</span> <span class="n">cur_imag</span><span class="p">,</span> <span class="n">real_part</span><span class="p">,</span> <span class="n">imag_part</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3FF</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span>
				<span class="p">(((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">320</span><span class="p">));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATAHI</span><span class="p">,</span>
					<span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span>
					<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span> <span class="o">+</span> <span class="n">i</span><span class="p">];</span>
		<span class="n">real_part</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">imag_part</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_ADDR</span><span class="p">,</span>
				<span class="p">(((</span><span class="n">i</span> <span class="o">+</span> <span class="mi">26</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mi">448</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur_real</span> <span class="o">=</span> <span class="n">real_part</span><span class="p">;</span>
			<span class="n">cur_imag</span> <span class="o">=</span> <span class="n">imag_part</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">cur_real</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cur_imag</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cur_real</span> <span class="o">=</span> <span class="p">(</span><span class="n">real_part</span> <span class="o">*</span> <span class="n">loscale</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">cur_imag</span> <span class="o">=</span> <span class="p">(</span><span class="n">imag_part</span> <span class="o">*</span> <span class="n">loscale</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">cur_real</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cur_imag</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATAHI</span><span class="p">,</span>
					<span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TABLE_DATALO</span><span class="p">,</span>
					<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
				<span class="n">B43_SHM_SH_NPHY_TXPWR_INDX0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
				<span class="n">B43_SHM_SH_NPHY_TXPWR_INDX1</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Restore RSSI Calibration</span>
<span class="cm"> * http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreRssiCal</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_restore_rssi_cal</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u16</span> <span class="o">*</span><span class="n">rssical_radio_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">rssical_phy_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_chanspec_2G</span><span class="p">.</span><span class="n">center_freq</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">rssical_radio_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_cache</span><span class="p">.</span><span class="n">rssical_radio_regs_2G</span><span class="p">;</span>
		<span class="n">rssical_phy_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_cache</span><span class="p">.</span><span class="n">rssical_phy_regs_2G</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_chanspec_5G</span><span class="p">.</span><span class="n">center_freq</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">rssical_radio_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_cache</span><span class="p">.</span><span class="n">rssical_radio_regs_5G</span><span class="p">;</span>
		<span class="n">rssical_phy_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_cache</span><span class="p">.</span><span class="n">rssical_phy_regs_5G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO use some definitions */</span>
	<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x602B</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="n">rssical_radio_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x702B</span><span class="p">,</span> <span class="mh">0xE3</span><span class="p">,</span> <span class="n">rssical_radio_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_Z</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_Z</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_Z</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_Z</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_X</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_X</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_X</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_X</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0I_RSSI_Y</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_0Q_RSSI_Y</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1I_RSSI_Y</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RSSIMC_1Q_RSSI_Y</span><span class="p">,</span> <span class="n">rssical_phy_regs</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalRadioSetup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_cal_radio_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">save</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_rx_cal_radio_saveregs</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">offset</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x2000</span> <span class="o">:</span> <span class="mh">0x3000</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">11</span><span class="p">;</span>

		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_RVARCTL</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_LPOCTL</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_TS</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_RCCALRTS</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_CAL_RCALRTS</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_PADDRV</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_XOCTL1</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_XOCTL2</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_XOREGUL</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_XOMISC</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_PLL_LFC1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_RVARCTL</span><span class="p">,</span> <span class="mh">0x0A</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_LPOCTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_TS</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_RCCALRTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_RCALRTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">ipa5g_on</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_PADDRV</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_XOCTL1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_PADDRV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_XOCTL1</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_XOCTL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_RVARCTL</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_LPOCTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_TS</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_RCCALRTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_CAL_RCALRTS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_XOCTL1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">ipa2g_on</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_PADDRV</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_XOCTL2</span><span class="p">,</span>
					<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x11</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_PADDRV</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_XOCTL2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_XOREGUL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_XOMISC</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B2055_PLL_LFC1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">save</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_RF_IQCAL1</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_RF_IQCAL1</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">);</span>

		<span class="n">save</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_RF_IQCAL2</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_RF_IQCAL2</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>

		<span class="n">save</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_RF_IQCAL1</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_RF_IQCAL1</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">);</span>

		<span class="n">save</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_RF_IQCAL2</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_RF_IQCAL2</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">);</span>

		<span class="n">save</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PWRDET_RXTX</span><span class="p">);</span>
		<span class="n">save</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PWRDET_RXTX</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BANDCTL</span><span class="p">)</span> <span class="o">&amp;</span>
		    <span class="n">B43_NPHY_BANDCTL_5GHZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PWRDET_RXTX</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PWRDET_RXTX</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_PWRDET_RXTX</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_PWRDET_RXTX</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_BB_MXGM</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_BB_MXGM</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_TX_BB_MXGM</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
			<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_TX_BB_MXGM</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x20</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/UpdateTxCalLadder */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_update_tx_cal_ladder</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scale</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txcal_bbmult</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">core</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">ladder_lo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">percent</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">((</span><span class="n">scale</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ladder_lo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">g_env</span><span class="p">;</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span> <span class="n">entry</span><span class="p">);</span>

		<span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">ladder_iq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">percent</span> <span class="o">*</span> <span class="n">tmp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="p">((</span><span class="n">scale</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">ladder_iq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">g_env</span><span class="p">;</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">32</span><span class="p">),</span> <span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ExtPaSetTxDigiFilts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_ext_pa_set_tx_dig_filters</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N</span><span class="p">(</span><span class="mh">0x2C5</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span>
				<span class="n">tbl_tx_filter_coef_rev4</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/IpaSetTxDigiFilts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_int_pa_set_tx_dig_filters</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="cm">/* B43_NPHY_TXF_20CO_S0A1, B43_NPHY_TXF_40CO_S0A1, unknown */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x186</span><span class="p">,</span> <span class="mh">0x195</span><span class="p">,</span> <span class="mh">0x2C5</span> <span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span>
					<span class="n">tbl_tx_filter_coef_rev4</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span>
					<span class="n">tbl_tx_filter_coef_rev4</span><span class="p">[</span><span class="mi">3</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span>
					<span class="n">tbl_tx_filter_coef_rev4</span><span class="p">[</span><span class="mi">5</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N</span><span class="p">(</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">j</span><span class="p">),</span>
					<span class="n">tbl_tx_filter_coef_rev4</span><span class="p">[</span><span class="mi">6</span><span class="p">][</span><span class="n">j</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/GetTxGain */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="nf">b43_nphy_get_tx_gains</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">curr_gain</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="n">target</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrctrl</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
			<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">curr_gain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
			<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">target</span><span class="p">.</span><span class="n">ipa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">pad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x00F0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">pga</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0F00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">txgm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">target</span><span class="p">.</span><span class="n">ipa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">curr_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">pad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x000C</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">pga</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0070</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">txgm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">curr_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0380</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C1_TXPCTL_STAT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">B43_NPHY_TXPCTL_STAT_BIDX</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">B43_NPHY_TXPCTL_STAT_BIDX_SHIFT</span><span class="p">;</span>
		<span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_C2_TXPCTL_STAT</span><span class="p">)</span> <span class="o">&amp;</span>
			<span class="n">B43_NPHY_TXPCTL_STAT_BIDX</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
			<span class="n">B43_NPHY_TXPCTL_STAT_BIDX_SHIFT</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">table</span> <span class="o">=</span> <span class="n">b43_nphy_get_tx_gain_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">target</span><span class="p">.</span><span class="n">ipa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">pad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">pga</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">txgm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">target</span><span class="p">.</span><span class="n">ipa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">pad</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">18</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">pga</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
				<span class="n">target</span><span class="p">.</span><span class="n">txgm</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;&gt;</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">target</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhyCleanup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_cal_phy_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tx_rx_cal_phy_saveregs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="n">regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN0</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN1</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
		<span class="n">b43_nphy_reset_cca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span> <span class="n">regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/TxCalPhySetup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tx_cal_phy_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">tx_rx_cal_phy_saveregs</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">);</span>
	<span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0A00</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0A00</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x0600</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x0600</span><span class="p">);</span>

		<span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">,</span>
			     <span class="o">~</span><span class="n">B43_NPHY_BBCFG_RSTRX</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">19</span><span class="p">));</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">19</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">);</span>

		<span class="n">b43_nphy_rf_control_intc_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">b43_nphy_rf_control_intc_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_nphy_rf_control_intc_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN0</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN1</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN0</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0001</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN1</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0001</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="mh">0xA000</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="mh">0xA000</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x3000</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">));</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x2000</span><span class="p">;</span>
		<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">);</span>
		<span class="n">regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x0180</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x0120</span><span class="p">;</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SaveCal */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_save_cal</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">b43_phy_n_iq_comp</span> <span class="o">*</span><span class="n">rxcal_coeffs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">txcal_radio_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_chanspec</span> <span class="o">*</span><span class="n">iqcal_chanspec</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxcal_coeffs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">rxcal_coeffs_2G</span><span class="p">;</span>
		<span class="n">txcal_radio_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_radio_regs_2G</span><span class="p">;</span>
		<span class="n">iqcal_chanspec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">iqcal_chanspec_2G</span><span class="p">;</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_coeffs_2G</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rxcal_coeffs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">rxcal_coeffs_5G</span><span class="p">;</span>
		<span class="n">txcal_radio_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_radio_regs_5G</span><span class="p">;</span>
		<span class="n">iqcal_chanspec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">iqcal_chanspec_5G</span><span class="p">;</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_coeffs_5G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_rx_iq_coeffs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">rxcal_coeffs</span><span class="p">);</span>
	<span class="cm">/* TODO use some definitions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2021</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2022</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3021</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3022</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2023</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2024</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3023</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3024</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xBA</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">);</span>
		<span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">iqcal_chanspec</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_freq</span><span class="p">;</span>
	<span class="n">iqcal_chanspec</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_type</span><span class="p">;</span>
	<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">8</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RestoreCal */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_restore_cal</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">coef</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">loft</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">txcal_radio_regs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n_iq_comp</span> <span class="o">*</span><span class="n">rxcal_coeffs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">iqcal_chanspec_2G</span><span class="p">.</span><span class="n">center_freq</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_coeffs_2G</span><span class="p">;</span>
		<span class="n">loft</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_coeffs_2G</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">iqcal_chanspec_5G</span><span class="p">.</span><span class="n">center_freq</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_coeffs_5G</span><span class="p">;</span>
		<span class="n">loft</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_coeffs_5G</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coef</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">coef</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">88</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">coef</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loft</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">93</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">loft</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_nphy_tx_iq_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txcal_radio_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_radio_regs_2G</span><span class="p">;</span>
		<span class="n">rxcal_coeffs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">rxcal_coeffs_2G</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txcal_radio_regs</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">txcal_radio_regs_5G</span><span class="p">;</span>
		<span class="n">rxcal_coeffs</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_cache</span><span class="p">.</span><span class="n">rxcal_coeffs_5G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO use some definitions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2021</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2022</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3021</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3022</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2023</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2024</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3023</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3024</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8B</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xBA</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8D</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xBC</span><span class="p">,</span> <span class="n">txcal_radio_regs</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">b43_nphy_rx_iq_coeffs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">rxcal_coeffs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalTxIqlo */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_cal_tx_iq_lo</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="n">target</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">full</span><span class="p">,</span> <span class="n">bool</span> <span class="n">mphase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">avoid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">numb</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">phy6or5x</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">diq_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">save</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">gain</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nphy_iqcal_params</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">updated</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>

	<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">avoid</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">;</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_nphy_iq_cal_gain_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cal_gain</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>

	<span class="n">b43_nphy_tx_cal_radio_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_nphy_tx_cal_phy_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">phy6or5x</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">ipa2g_on</span> <span class="o">&amp;&amp;</span>
		<span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy6or5x</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">18</span><span class="p">,</span>
					<span class="n">tbl_tx_iqlo_cal_loft_ladder_40</span><span class="p">);</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="mi">18</span><span class="p">,</span>
					<span class="n">tbl_tx_iqlo_cal_iqimb_ladder_40</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">18</span><span class="p">,</span>
					<span class="n">tbl_tx_iqlo_cal_loft_ladder_20</span><span class="p">);</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">32</span><span class="p">),</span> <span class="mi">18</span><span class="p">,</span>
					<span class="n">tbl_tx_iqlo_cal_iqimb_ladder_20</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQLOCAL_CMDGCTL</span><span class="p">,</span> <span class="mh">0x8AA9</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span><span class="p">)</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">2500</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_nphy_run_samples</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">?</span> <span class="mi">40</span> <span class="o">:</span> <span class="mi">20</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
					<span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">b43_nphy_tx_tone</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">table</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_txcal_bestcoeffs</span><span class="p">;</span>
			<span class="n">length</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">length</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">full</span> <span class="o">&amp;&amp;</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_coeffsvalid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">table</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_bestc</span><span class="p">;</span>
				<span class="n">length</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">length</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">full</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">table</span> <span class="o">=</span> <span class="n">tbl_tx_iqlo_cal_startcoefs_nphyrev3</span><span class="p">;</span>
					<span class="n">length</span> <span class="o">=</span> <span class="n">B43_NTAB_TX_IQLO_CAL_STARTCOEFS_REV3</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">table</span> <span class="o">=</span> <span class="n">tbl_tx_iqlo_cal_startcoefs</span><span class="p">;</span>
					<span class="n">length</span> <span class="o">=</span> <span class="n">B43_NTAB_TX_IQLO_CAL_STARTCOEFS</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span> <span class="n">table</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">B43_NTAB_TX_IQLO_CAL_CMDS_RECAL_REV3</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">max</span> <span class="o">=</span> <span class="n">B43_NTAB_TX_IQLO_CAL_CMDS_RECAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mphase</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_txcal_cmdidx</span><span class="p">;</span>
			<span class="n">numb</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u16</span><span class="p">)(</span><span class="n">count</span> <span class="o">+</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_txcal_numcmds</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">numb</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="n">numb</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">full</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">tbl_tx_iqlo_cal_cmds_fullcal</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">tbl_tx_iqlo_cal_cmds_recal_nphyrev3</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">cmd</span> <span class="o">=</span> <span class="n">tbl_tx_iqlo_cal_cmds_recal</span><span class="p">[</span><span class="n">count</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="n">core</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="mh">0x0F00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phy6or5x</span> <span class="o">&amp;&amp;</span> <span class="n">updated</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_nphy_update_tx_cal_ladder</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">);</span>
				<span class="n">updated</span><span class="p">[</span><span class="n">core</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="n">core</span><span class="p">].</span><span class="n">ncorr</span><span class="p">[</span><span class="n">type</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x66</span><span class="p">;</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQLOCAL_CMDNNUM</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_ntab_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">69</span> <span class="o">+</span> <span class="n">core</span><span class="p">));</span>
				<span class="n">diq_start</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">69</span> <span class="o">+</span> <span class="n">core</span><span class="p">),</span>
						<span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQLOCAL_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQLOCAL_CMD</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xC000</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">96</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span>
						<span class="n">buffer</span><span class="p">);</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span>
						<span class="n">buffer</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">diq_start</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mphase</span><span class="p">)</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_txcal_cmdidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">numb</span> <span class="o">&gt;=</span> <span class="n">max</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">numb</span><span class="p">;</span>

		<span class="n">last</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mphase</span> <span class="o">||</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">==</span> <span class="n">last</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">96</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">88</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>
						<span class="n">buffer</span><span class="p">);</span>
			<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">101</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
						<span class="n">buffer</span><span class="p">);</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
						<span class="n">buffer</span><span class="p">);</span>
			<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">93</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
						<span class="n">buffer</span><span class="p">);</span>
			<span class="n">length</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">length</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">96</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span>
						<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_bestc</span><span class="p">);</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_coeffsvalid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_chanspec</span><span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span>
							<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_freq</span><span class="p">;</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_chanspec</span><span class="p">.</span><span class="n">channel_type</span> <span class="o">=</span>
							<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_type</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">length</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">length</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">96</span><span class="p">),</span> <span class="n">length</span><span class="p">,</span>
						<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_txcal_bestcoeffs</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">b43_nphy_stop_playback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_IQLOCAL_CMDGCTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_tx_cal_phy_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">save</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">mphase</span> <span class="o">||</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">==</span> <span class="n">last</span><span class="p">))</span>
		<span class="n">b43_nphy_tx_iq_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span> <span class="o">=</span> <span class="n">avoid</span><span class="p">;</span>

	<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ReapplyTxCalCoeffs */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_reapply_tx_cal_coeffs</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">equal</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_coeffsvalid</span> <span class="o">||</span>
	    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_chanspec</span><span class="p">.</span><span class="n">center_freq</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_freq</span> <span class="o">||</span>
	    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_chanspec</span><span class="p">.</span><span class="n">channel_type</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel_type</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">7</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_bestc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">equal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">equal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>
					<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_bestc</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">88</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>
					<span class="n">buffer</span><span class="p">);</span>
		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">85</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_bestc</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">93</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txiqlocal_bestc</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIqRev2 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_rev2_cal_rx_iq</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="n">target</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">afectl_core</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">cur_hpf1</span><span class="p">),</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">cur_hpf2</span><span class="p">),</span> <span class="n">cur_lna</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">real</span><span class="p">,</span> <span class="n">imag</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">use</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cur_hpf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lna</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">hpf1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">hpf2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">power</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">gain_save</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">cal_gain</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nphy_iqcal_params</span> <span class="n">cal_params</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">nphy_iq_est</span> <span class="n">est</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">playtone</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desired</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>

	<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_nphy_reapply_tx_cal_coeffs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_ntab_read_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">gain_save</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_nphy_iq_cal_gain_params</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cal_params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">cal_gain</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cal_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cal_gain</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cal_gain</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">;</span>
			<span class="n">rfctl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">;</span>
			<span class="n">afectl_core</span> <span class="o">=</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">;</span>
			<span class="n">rfctl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">;</span>
			<span class="n">afectl_core</span> <span class="o">=</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQCA</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">afectl_core</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">);</span>
		<span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQCA</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_RFSEQCA_RXDIS</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">,</span>
				<span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_RFSEQCA_RXDIS_SHIFT</span><span class="p">));</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQCA</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_RFSEQCA_TXEN</span><span class="p">,</span>
				<span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">afectl_core</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>

		<span class="n">band</span> <span class="o">=</span> <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rxcalparams</span> <span class="o">&amp;</span> <span class="mh">0xFF000000</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x140</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x110</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x180</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0x120</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0x148</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0x114</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rxcalparams</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_GENSPARE2</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span>
					<span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">));</span>
			<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_GENSPARE2</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">,</span>
					<span class="p">(</span><span class="mi">2</span> <span class="o">-</span> <span class="n">i</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cur_lna</span> <span class="o">=</span> <span class="n">lna</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">cur_hpf1</span> <span class="o">=</span> <span class="n">hpf1</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
				<span class="n">cur_hpf2</span> <span class="o">=</span> <span class="n">hpf2</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">cur_hpf</span> <span class="o">=</span> <span class="n">cur_hpf1</span><span class="p">;</span>
					<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">use</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
						<span class="n">cur_hpf</span> <span class="o">=</span> <span class="n">cur_hpf1</span><span class="p">;</span>
						<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">use</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
						<span class="n">cur_hpf</span> <span class="o">=</span> <span class="n">cur_hpf2</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">cur_lna</span> <span class="o">=</span> <span class="n">lna</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
				<span class="n">cur_hpf1</span> <span class="o">=</span> <span class="n">hpf1</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
				<span class="n">cur_hpf2</span> <span class="o">=</span> <span class="n">hpf2</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
				<span class="n">cur_hpf</span> <span class="o">+=</span> <span class="n">desired</span> <span class="o">-</span> <span class="n">hweight32</span><span class="p">(</span><span class="n">power</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
				<span class="n">cur_hpf</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">cur_hpf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">use</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">cur_hpf1</span> <span class="o">=</span> <span class="n">cur_hpf</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">cur_hpf2</span> <span class="o">=</span> <span class="n">cur_hpf</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">cur_hpf2</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">cur_hpf1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">cur_lna</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
			<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">3</span><span class="p">,</span>
									<span class="nb">false</span><span class="p">);</span>
			<span class="n">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_RFSEQ_RESET2RX</span><span class="p">);</span>
			<span class="n">b43_nphy_stop_playback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">playtone</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">b43_nphy_tx_tone</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span>
						<span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rxcalparams</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">),</span>
						<span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="n">playtone</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">b43_nphy_run_samples</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">b43_nphy_rx_iq_est</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">est</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
									<span class="nb">false</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">real</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">i0_pwr</span><span class="p">;</span>
						<span class="n">imag</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">q0_pwr</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">real</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">i1_pwr</span><span class="p">;</span>
						<span class="n">imag</span> <span class="o">=</span> <span class="n">est</span><span class="p">.</span><span class="n">q1_pwr</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">power</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">real</span> <span class="o">+</span> <span class="n">imag</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">b43_nphy_calc_rx_iq_comp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">b43_nphy_stop_playback</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C1_GENSPARE2</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">);</span>
		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_C2_GENSPARE2</span><span class="p">,</span> <span class="mh">0xFC</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rfctl</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">afectl_core</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQCA</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_rf_control_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_RFSEQ_RESET2RX</span><span class="p">);</span>
	<span class="n">b43_ntab_write_bulk</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0x110</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">gain_save</span><span class="p">);</span>

	<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_rev3_cal_rx_iq</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="n">target</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/CalRxIq */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_cal_rx_iq</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="n">target</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">b43_nphy_rev3_cal_rx_iq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">debug</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">b43_nphy_rev2_cal_rx_iq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">debug</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/RxCoreSetState */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_set_rx_core_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="cm">/* u16 buf[16]; it&#39;s rev3+ */</span>

	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">phyrxchain</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="cm">/* FIXME clk */</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQCA</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_RFSEQCA_RXEN</span><span class="p">,</span>
			<span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_RFSEQCA_RXEN_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_HPANT_SWTHRES</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TODO */</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_HPANT_SWTHRES</span><span class="p">,</span> <span class="mh">0x1E</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* TODO */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_RFSEQ_RESET2RX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span><span class="p">)</span>
		<span class="n">b43_nphy_stay_in_carrier_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * N-PHY init</span>
<span class="cm"> **************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Upload the N-PHY tables.</span>
<span class="cm"> * http://bcm-v4.sipsolutions.net/802.11/PHY/N/InitTables</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_tables_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_rev0_1_2_tables_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_nphy_rev3plus_tables_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/MIMOConfig */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_update_mimo_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">preamble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">mimocfg</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_MIMOCFG</span><span class="p">);</span>

	<span class="n">mimocfg</span> <span class="o">|=</span> <span class="n">B43_NPHY_MIMOCFG_AUTO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">preamble</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">mimocfg</span> <span class="o">|=</span> <span class="n">B43_NPHY_MIMOCFG_GFMIX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mimocfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_NPHY_MIMOCFG_GFMIX</span><span class="p">;</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_MIMOCFG</span><span class="p">,</span> <span class="n">mimocfg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/BPHYInit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_bphy_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x1E1F</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N_BMODE</span><span class="p">(</span><span class="mh">0x88</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="mh">0x202</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x3E3F</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N_BMODE</span><span class="p">(</span><span class="mh">0x98</span> <span class="o">+</span> <span class="n">i</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="mh">0x202</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_N_BMODE</span><span class="p">(</span><span class="mh">0x38</span><span class="p">),</span> <span class="mh">0x668</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SuperSwitchInit */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_superswitch_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">init</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">init</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="cm">/* FIXME */</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mh">0x211</span><span class="p">);</span>
			<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mh">0x222</span><span class="p">);</span>
			<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="mh">0x144</span><span class="p">);</span>
			<span class="n">b43_ntab_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NTAB16</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span> <span class="mh">0x188</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_GPIO_LOOEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_GPIO_HIOEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
		<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
			<span class="n">bcma_chipco_gpio_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_cc</span><span class="p">,</span>
						 <span class="mh">0xFC00</span><span class="p">,</span> <span class="mh">0xFC00</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
		<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
			<span class="n">ssb_chipco_gpio_control</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">,</span>
						<span class="mh">0xFC00</span><span class="p">,</span> <span class="mh">0xFC00</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_GPOUTSMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_maskset16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GPIO_MASK</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xFC00</span><span class="p">);</span>
		<span class="n">b43_maskset16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GPIO_CONTROL</span><span class="p">,</span> <span class="p">(</span><span class="o">~</span><span class="mh">0xFC00</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">),</span>
			      <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_LO1</span><span class="p">,</span> <span class="mh">0x2D8</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP1</span><span class="p">,</span> <span class="mh">0x301</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_LO2</span><span class="p">,</span> <span class="mh">0x2D8</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_LUT_TRSW_UP2</span><span class="p">,</span> <span class="mh">0x301</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/Init/N */</span>
<span class="kt">int</span> <span class="nf">b43_phy_initn</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_pwr_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">nphy_txgains</span> <span class="n">target</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">tmp2</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">do_rssi_cal</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">clip</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">do_cal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_EXTLNA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
		<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
			<span class="n">bcma_cc_set32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_cc</span><span class="p">,</span>
				      <span class="n">BCMA_CC_CHIPCTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
		<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
			<span class="n">chipco_set32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">,</span>
				     <span class="n">SSB_CHIPCO_CHIPCTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">deaf_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b43_nphy_tables_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">crsminpwr_adjusted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">noisevars_adjusted</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Clear all overrides */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B1S0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXF_40CO_B32S1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_OVER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_INTC4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFSEQMODE</span><span class="p">,</span>
		     <span class="o">~</span><span class="p">(</span><span class="n">B43_NPHY_RFSEQMODE_CAOVER</span> <span class="o">|</span>
		       <span class="n">B43_NPHY_RFSEQMODE_TROVER</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x3B</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BPHY_CTL3</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_BPHY_CTL3_SCALE</span><span class="p">,</span>
				<span class="n">tmp</span> <span class="o">&lt;&lt;</span> <span class="n">B43_NPHY_BPHY_CTL3_SCALE_SHIFT</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFESEQ_TX2RX_PUD_20M</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFESEQ_TX2RX_PUD_40M</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_SKWRKFEM_BRD</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span> <span class="o">&amp;&amp;</span>
	     <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="mh">0x8B</span><span class="p">))</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXREALFD</span><span class="p">,</span> <span class="mh">0xA0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXREALFD</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_MIMO_CRSTXEXT</span><span class="p">,</span> <span class="mh">0xC8</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PLOAD_CSENSE_EXTLEN</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXRIFS_FRDEL</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>

	<span class="n">b43_nphy_update_mimo_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">preamble_override</span><span class="p">);</span>
	<span class="n">b43_nphy_update_txrx_chain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_DUP40_GFBL</span><span class="p">,</span> <span class="mh">0xAA8</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_DUP40_BL</span><span class="p">,</span> <span class="mh">0x9A4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp2</span> <span class="o">=</span> <span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_ipa</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN0</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_EPS_TABLE_ADJ0</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">,</span>
				<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">papd_epsilon_offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PAPD_EN1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_EPS_TABLE_ADJ1</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">,</span>
				<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">papd_epsilon_offset</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">b43_nphy_int_pa_set_tx_dig_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_nphy_ext_pa_set_tx_dig_filters</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_workarounds</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Reset CCA, in init code it differs a little from standard way */</span>
	<span class="n">b43_phy_force_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">B43_NPHY_BBCFG_RSTCCA</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_NPHY_BBCFG_RSTCCA</span><span class="p">);</span>
	<span class="n">b43_phy_force_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">b43_mac_phy_clock_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">b43_nphy_pa_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_RFSEQ_RX2TX</span><span class="p">);</span>
	<span class="n">b43_nphy_force_rf_sequence</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_RFSEQ_RESET2RX</span><span class="p">);</span>
	<span class="n">b43_nphy_pa_override</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_nphy_read_clip_detection</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">clip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">b43_nphy_bphy_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">tx_pwr_state</span> <span class="o">=</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrctrl</span><span class="p">;</span>
	<span class="n">b43_nphy_tx_power_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">b43_nphy_tx_power_fix</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_nphy_tx_power_ctl_idle_tssi</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_nphy_tx_power_ctl_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_nphy_tx_gain_table_upload</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">phyrxchain</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_set_rx_core_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">phyrxchain</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span><span class="cm">/* TODO PHY Periodic Calibration Multi-Phase Restart */</span>

	<span class="n">do_rssi_cal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
			<span class="n">do_rssi_cal</span> <span class="o">=</span> <span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_chanspec_2G</span><span class="p">.</span><span class="n">center_freq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">do_rssi_cal</span> <span class="o">=</span> <span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">rssical_chanspec_5G</span><span class="p">.</span><span class="n">center_freq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_rssi_cal</span><span class="p">)</span>
			<span class="n">b43_nphy_rssi_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_nphy_restore_rssi_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_nphy_rssi_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">measure_hold</span> <span class="o">&amp;</span> <span class="mh">0x6</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
			<span class="n">do_cal</span> <span class="o">=</span> <span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">iqcal_chanspec_2G</span><span class="p">.</span><span class="n">center_freq</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">do_cal</span> <span class="o">=</span> <span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">iqcal_chanspec_5G</span><span class="p">.</span><span class="n">center_freq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">)</span>
			<span class="n">do_cal</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">do_cal</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">target</span> <span class="o">=</span> <span class="n">b43_nphy_get_tx_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">antsel_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">b43_nphy_superswitch_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">perical</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_nphy_rssi_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_orig_pwr_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrindex</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">index_internal</span><span class="p">;</span>
					<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">cal_orig_pwr_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					    <span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrindex</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">index_internal</span><span class="p">;</span>
					<span class="cm">/* TODO N PHY Pre Calibrate TX Gain */</span>
					<span class="n">target</span> <span class="o">=</span> <span class="n">b43_nphy_get_tx_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_nphy_cal_tx_iq_lo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">b43_nphy_cal_rx_iq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
						<span class="n">b43_nphy_save_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">mphase_cal_phase_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">;</span><span class="cm">/* N PHY Periodic Calibration with arg 3 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_nphy_restore_cal</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43_nphy_tx_pwr_ctrl_coef_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_nphy_tx_power_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tx_pwr_state</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXMACIF_HOLDOFF</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_TXMACDELAY</span><span class="p">,</span> <span class="mh">0x0320</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_PLOAD_CSENSE_EXTLEN</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
	<span class="n">b43_nphy_tx_lp_fbw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_spur_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Channel switching ops.</span>
<span class="cm"> **************************************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_chantab_phy_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_phy_n_sfo_cfg</span> <span class="o">*</span><span class="n">e</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BW1A</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_bw1a</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BW2</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_bw2</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BW3</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_bw3</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BW4</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_bw4</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BW5</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_bw5</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BW6</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_bw6</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PmuSpurAvoid */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_pmu_spur_avoid</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">avoid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bcma_drv_cc</span> <span class="n">__maybe_unused</span> <span class="o">*</span><span class="n">cc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__maybe_unused</span> <span class="n">pmu_ctl</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="n">cc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_cc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mi">43224</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mi">43225</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">avoid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x11500010</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x000C0C06</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0F600a08</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x2001E920</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x88888815</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x11100010</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x000c0c06</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x03000a08</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x200005c0</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x88888815</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pmu_ctl</span> <span class="o">=</span> <span class="n">BCMA_CC_PMU_CTL_PLL_UPD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4716</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">avoid</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x11500060</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x080C0C06</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x0F600000</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x2001E924</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x88888815</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x11100060</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x080c0c06</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x03000000</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span> <span class="mh">0x200005c0</span><span class="p">);</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x88888815</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">pmu_ctl</span> <span class="o">=</span> <span class="n">BCMA_CC_PMU_CTL_PLL_UPD</span> <span class="o">|</span>
				  <span class="n">BCMA_CC_PMU_CTL_NOILPONW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4322</span> <span class="o">||</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4340</span> <span class="o">||</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4341</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0x11100070</span><span class="p">);</span>
			<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x1014140a</span><span class="p">);</span>
			<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x5</span><span class="p">,</span> <span class="mh">0x88888854</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">avoid</span><span class="p">)</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x05201828</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">bcma_chipco_pll_write</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x05001828</span><span class="p">);</span>
			<span class="n">pmu_ctl</span> <span class="o">=</span> <span class="n">BCMA_CC_PMU_CTL_PLL_UPD</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bcma_cc_set32</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">BCMA_CC_PMU_CTL</span><span class="p">,</span> <span class="n">pmu_ctl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="cm">/* FIXME */</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/ChanspecSetup */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_channel_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_phy_n_sfo_cfg</span> <span class="o">*</span><span class="n">e</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">new_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">new_channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">old_band_5ghz</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>

	<span class="n">old_band_5ghz</span> <span class="o">=</span>
		<span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BANDCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">B43_NPHY_BANDCTL_5GHZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">old_band_5ghz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp32</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PSM_PHY_HDR</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PSM_PHY_HDR</span><span class="p">,</span> <span class="n">tmp32</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_B_BBCFG</span><span class="p">,</span> <span class="mh">0xC000</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PSM_PHY_HDR</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BANDCTL</span><span class="p">,</span> <span class="n">B43_NPHY_BANDCTL_5GHZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">new_channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">&amp;&amp;</span> <span class="n">old_band_5ghz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BANDCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_NPHY_BANDCTL_5GHZ</span><span class="p">);</span>
		<span class="n">tmp32</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PSM_PHY_HDR</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PSM_PHY_HDR</span><span class="p">,</span> <span class="n">tmp32</span> <span class="o">|</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_B_BBCFG</span><span class="p">,</span> <span class="mh">0x3FFF</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PSM_PHY_HDR</span><span class="p">,</span> <span class="n">tmp32</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_chantab_phy_upload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_channel</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_B_TEST</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_nphy_classifier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_B_TEST</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x840</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrctrl</span><span class="p">)</span>
		<span class="n">b43_nphy_tx_power_fix</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_adjust_lna_gain_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43_nphy_tx_lp_fbw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">spur_avoid</span> <span class="o">!=</span> <span class="n">B43_SPUR_AVOID_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">avoid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span><span class="o">-&gt;</span><span class="n">spur_avoid</span> <span class="o">==</span> <span class="n">B43_SPUR_AVOID_FORCE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">avoid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_channel_type_is_40mhz</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">13</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
				<span class="n">avoid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* 40MHz */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nphy</span><span class="o">-&gt;</span><span class="n">aband_spurwar_en</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ch</span> <span class="o">==</span> <span class="mi">38</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">102</span> <span class="o">||</span> <span class="n">ch</span> <span class="o">==</span> <span class="mi">118</span><span class="p">))</span>
				<span class="n">avoid</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4716</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">b43_nphy_pmu_spur_avoid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">avoid</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mi">43222</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mi">43224</span> <span class="o">||</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mi">43225</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CLK_FRAC_LOW</span><span class="p">,</span>
				    <span class="n">avoid</span> <span class="o">?</span> <span class="mh">0x5341</span> <span class="o">:</span> <span class="mh">0x8889</span><span class="p">);</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CLK_FRAC_HIGH</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="p">;</span> <span class="cm">/* TODO: reset PLL */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">avoid</span><span class="p">)</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG_RSTRX</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_BBCFG</span><span class="p">,</span>
				     <span class="o">~</span><span class="n">B43_NPHY_BBCFG_RSTRX</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>

		<span class="n">b43_nphy_reset_cca</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* wl sets useless phy_isspuravoid here */</span>
	<span class="p">}</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_NDATAT_DUP40</span><span class="p">,</span> <span class="mh">0x3830</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_nphy_spur_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/SetChanspec */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_nphy_channeltab_entry_rev2</span> <span class="o">*</span><span class="n">tabent_r2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_nphy_channeltab_entry_rev3</span> <span class="o">*</span><span class="n">tabent_r3</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tabent_r3</span> <span class="o">=</span> <span class="n">b43_nphy_get_chantabent_rev3</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tabent_r3</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tabent_r2</span> <span class="o">=</span> <span class="n">b43_nphy_get_chantabent_rev2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tabent_r2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Channel is set later in common code, but we need to set it on our</span>
<span class="cm">	   own to let this function&#39;s subcalls work properly. */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel_freq</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_channel_type_is_40mhz</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel_type</span><span class="p">)</span> <span class="o">!=</span>
		<span class="n">b43_channel_type_is_40mhz</span><span class="p">(</span><span class="n">channel_type</span><span class="p">))</span>
		<span class="p">;</span> <span class="cm">/* TODO: BMAC BW Set (channel_type) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT40PLUS</span><span class="p">)</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RXCTL</span><span class="p">,</span>
				<span class="n">B43_NPHY_RXCTL_BSELU20</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT40MINUS</span><span class="p">)</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RXCTL</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_RXCTL_BSELU20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0xFFFB</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43_radio_2056_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tabent_r3</span><span class="p">);</span>
		<span class="n">b43_nphy_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tabent_r3</span><span class="o">-&gt;</span><span class="n">phy_regs</span><span class="p">),</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0020</span> <span class="o">:</span> <span class="mh">0x0050</span><span class="p">;</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B2055_MASTER1</span><span class="p">,</span> <span class="mh">0xFF8F</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43_radio_2055_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tabent_r2</span><span class="p">);</span>
		<span class="n">b43_nphy_channel_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tabent_r2</span><span class="o">-&gt;</span><span class="n">phy_regs</span><span class="p">),</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************************************</span>
<span class="cm"> * Basic PHY ops.</span>
<span class="cm"> **************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_op_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span><span class="p">;</span>

	<span class="n">nphy</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nphy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nphy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">nphy</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_op_prepare_structs</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">nphy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">nphy</span><span class="p">));</span>

	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">hang_avoid</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">spur_avoid</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">B43_SPUR_AVOID_AUTO</span> <span class="o">:</span> <span class="n">B43_SPUR_AVOID_DISABLE</span><span class="p">;</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">gain_boost</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* this way we follow wl, assume it is true */</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txrx_chain</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* sth different than 0 and 1 for now */</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">phyrxchain</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* to avoid b43_nphy_set_rx_core_state like wl */</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">perical</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* avoid additional rssi cal on init (like wl) */</span>
	<span class="cm">/* 128 can mean disabled-by-default state of TX pwr ctl. Max value is</span>
<span class="cm">	 * 0x7f == 127 and we check for 128 when restoring TX pwr ctl. */</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_pwr_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">tx_pwr_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

	<span class="cm">/* Hardware TX power control and 5GHz power gain */</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrctrl</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwg_gain_5ghz</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">11</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrctrl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwg_gain_5ghz</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_TXPWRCTRL_EN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">txpwrctrl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">B43_BUS_SSB</span> <span class="o">&amp;&amp;</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCI</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x4328</span> <span class="o">||</span>
				    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x432a</span><span class="p">)</span>
					<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwg_gain_5ghz</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags2_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL2_5G_PWRGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">pwg_gain_5ghz</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">ipa2g_on</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">fem</span><span class="p">.</span><span class="n">ghz2</span><span class="p">.</span><span class="n">extpa_gain</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">nphy</span><span class="o">-&gt;</span><span class="n">ipa5g_on</span> <span class="o">=</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">fem</span><span class="p">.</span><span class="n">ghz5</span><span class="p">.</span><span class="n">extpa_gain</span> <span class="o">==</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_op_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_n</span> <span class="o">*</span><span class="n">nphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">n</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">nphy</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">n</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_op_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">b43_phy_initn</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">check_phyreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if B43_DEBUG</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">B43_PHYROUTE</span><span class="p">)</span> <span class="o">==</span> <span class="n">B43_PHYROUTE_OFDM_GPHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* OFDM registers are onnly available on A/G-PHYs */</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Invalid OFDM PHY access at &quot;</span>
		       <span class="s">&quot;0x%04X on N-PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">B43_PHYROUTE</span><span class="p">)</span> <span class="o">==</span> <span class="n">B43_PHYROUTE_EXT_GPHY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ext-G registers are only available on G-PHYs */</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Invalid EXT-G PHY access at &quot;</span>
		       <span class="s">&quot;0x%04X on N-PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* B43_DEBUG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_nphy_op_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">check_phyreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_op_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">check_phyreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_op_maskset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">check_phyreg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">b43_maskset16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_DATA</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_nphy_op_radio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Register 1 is a 32-bit register. */</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* N-PHY needs 0x100 for read access */</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_DATA_LOW</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_op_radio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Register 1 is a 32-bit register. */</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_DATA_LOW</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/Radio/Switch%20Radio */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_op_software_rfkill</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">B43_MACCTL_ENABLED</span><span class="p">)</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;MAC not suspended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">blocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_RFCTL_CMD</span><span class="p">,</span>
				<span class="o">~</span><span class="n">B43_NPHY_RFCTL_CMD_CHIP0PU</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x2</span><span class="p">);</span>

			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x204D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2053</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2058</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x205E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2062</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xF0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2064</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x304D</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3053</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3058</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x305E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3062</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xF0</span><span class="p">);</span>
			<span class="n">b43_radio_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3064</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_init2056</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">b43_switch_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_radio_init2055</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/Anacore */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nphy_op_switch_analog</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">override</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span> <span class="mh">0x0</span> <span class="o">:</span> <span class="mh">0x7FFF</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">core</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span> <span class="mh">0xD</span> <span class="o">:</span> <span class="mh">0x00FD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="n">core</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="n">core</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER1</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C1</span><span class="p">,</span> <span class="n">core</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_C2</span><span class="p">,</span> <span class="n">core</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_NPHY_AFECTL_OVER</span><span class="p">,</span> <span class="n">override</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_nphy_op_switch_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_channel_type</span> <span class="n">channel_type</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_channel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_channel</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">b43_nphy_set_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">channel_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">b43_nphy_op_get_default_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">36</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_phy_operations</span> <span class="n">b43_phyops_n</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">allocate</span>		<span class="o">=</span> <span class="n">b43_nphy_op_allocate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span>			<span class="o">=</span> <span class="n">b43_nphy_op_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_structs</span>	<span class="o">=</span> <span class="n">b43_nphy_op_prepare_structs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">b43_nphy_op_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_read</span>		<span class="o">=</span> <span class="n">b43_nphy_op_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_write</span>		<span class="o">=</span> <span class="n">b43_nphy_op_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_maskset</span>		<span class="o">=</span> <span class="n">b43_nphy_op_maskset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">radio_read</span>		<span class="o">=</span> <span class="n">b43_nphy_op_radio_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">radio_write</span>		<span class="o">=</span> <span class="n">b43_nphy_op_radio_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">software_rfkill</span>	<span class="o">=</span> <span class="n">b43_nphy_op_software_rfkill</span><span class="p">,</span>
	<span class="p">.</span><span class="n">switch_analog</span>		<span class="o">=</span> <span class="n">b43_nphy_op_switch_analog</span><span class="p">,</span>
	<span class="p">.</span><span class="n">switch_channel</span>		<span class="o">=</span> <span class="n">b43_nphy_op_switch_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_default_chan</span>	<span class="o">=</span> <span class="n">b43_nphy_op_get_default_chan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recalc_txpower</span>		<span class="o">=</span> <span class="n">b43_nphy_op_recalc_txpower</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adjust_txpower</span>		<span class="o">=</span> <span class="n">b43_nphy_op_adjust_txpower</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
