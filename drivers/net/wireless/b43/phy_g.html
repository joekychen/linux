<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › b43 › phy_g.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>phy_g.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">  Broadcom B43 wireless driver</span>
<span class="cm">  IEEE 802.11g PHY driver</span>

<span class="cm">  Copyright (c) 2005 Martin Langer &lt;martin-langer@gmx.de&gt;,</span>
<span class="cm">  Copyright (c) 2005-2007 Stefano Brivio &lt;stefano.brivio@polimi.it&gt;</span>
<span class="cm">  Copyright (c) 2005-2008 Michael Buesch &lt;m@bues.ch&gt;</span>
<span class="cm">  Copyright (c) 2005, 2006 Danny van Dyk &lt;kugelfang@gentoo.org&gt;</span>
<span class="cm">  Copyright (c) 2005, 2006 Andreas Jaggi &lt;andreas.jaggi@waterwave.ch&gt;</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm">  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,</span>
<span class="cm">  Boston, MA 02110-1301, USA.</span>

<span class="cm">*/</span>

<span class="cp">#include &quot;b43.h&quot;</span>
<span class="cp">#include &quot;phy_g.h&quot;</span>
<span class="cp">#include &quot;phy_common.h&quot;</span>
<span class="cp">#include &quot;lo.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>

<span class="cp">#include &lt;linux/bitrev.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>


<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">b43_tssi2dbm_g_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">77</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span>
	<span class="mi">76</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span>
	<span class="mi">74</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span>
	<span class="mi">73</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span>
	<span class="mi">71</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span>
	<span class="mi">68</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span>
	<span class="mi">66</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
	<span class="mi">63</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span>
	<span class="mi">60</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span>
	<span class="mi">56</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span>
	<span class="mi">52</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
	<span class="mi">45</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>
	<span class="mi">33</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span>
	<span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">7</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span>
	<span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">b43_radio_channel_codes_bg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>
	<span class="mi">32</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
	<span class="mi">52</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span>
	<span class="mi">72</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">b43_calc_nrssi_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>


<span class="cp">#define bitrev4(tmp) (bitrev8(tmp) &gt;&gt; 4)</span>


<span class="cm">/* Get the freq, as it has to be written to the device. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">channel2freq_bg</span><span class="p">(</span><span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">14</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">b43_radio_channel_codes_bg</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">generate_rfatt_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">b43_rfatt_list</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="cm">/* APHY.rev &lt; 5 || GPHY.rev &lt; 6 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_rfatt</span> <span class="n">rfatt_0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
	<span class="p">};</span>
	<span class="cm">/* Radio.rev == 8 &amp;&amp; Radio.version == 0x2050 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_rfatt</span> <span class="n">rfatt_1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">14</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
	<span class="p">};</span>
	<span class="cm">/* Otherwise */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_rfatt</span> <span class="n">rfatt_2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_has_hardware_pctl</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Software pctl */</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">rfatt_0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rfatt_0</span><span class="p">);</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">min_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">max_val</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hardware pctl */</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">rfatt_1</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rfatt_1</span><span class="p">);</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">min_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">list</span><span class="o">-&gt;</span><span class="n">max_val</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Hardware pctl */</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">rfatt_2</span><span class="p">;</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rfatt_2</span><span class="p">);</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">min_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">max_val</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">generate_bbatt_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">b43_bbatt_list</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_bbatt</span> <span class="n">bbatt_0</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,},</span>
		<span class="p">{.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,},</span>
	<span class="p">};</span>

	<span class="n">list</span><span class="o">-&gt;</span><span class="n">list</span> <span class="o">=</span> <span class="n">bbatt_0</span><span class="p">;</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bbatt_0</span><span class="p">);</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">min_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">list</span><span class="o">-&gt;</span><span class="n">max_val</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_shm_clear_tssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x7F7F</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span> <span class="mh">0x7F7F</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span> <span class="mh">0x7F7F</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0072</span><span class="p">,</span> <span class="mh">0x7F7F</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Synthetic PU workaround */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_synth_pu_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We do not need the workaround. */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL</span><span class="p">,</span>
			    <span class="n">channel2freq_bg</span><span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL</span><span class="p">,</span> <span class="n">channel2freq_bg</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL</span><span class="p">,</span> <span class="n">channel2freq_bg</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Set the baseband attenuation value on chip. */</span>
<span class="kt">void</span> <span class="nf">b43_gphy_set_baseband_attenuation</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">baseband_attenuation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY0</span><span class="p">,</span> <span class="p">(</span><span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY0</span><span class="p">)</span>
						 <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">baseband_attenuation</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_DACCTL</span><span class="p">,</span> <span class="mh">0xFFC3</span><span class="p">,</span> <span class="p">(</span><span class="n">baseband_attenuation</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_DACCTL</span><span class="p">,</span> <span class="mh">0xFF87</span><span class="p">,</span> <span class="p">(</span><span class="n">baseband_attenuation</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Adjust the transmission power output (G-PHY) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_txpower_g</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_bbatt</span> <span class="o">*</span><span class="n">bbatt</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_rfatt</span> <span class="o">*</span><span class="n">rfatt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tx_control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_txpower_lo_control</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bb</span><span class="p">,</span> <span class="n">rf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_bias</span><span class="p">,</span> <span class="n">tx_magn</span><span class="p">;</span>

	<span class="n">bb</span> <span class="o">=</span> <span class="n">bbatt</span><span class="o">-&gt;</span><span class="n">att</span><span class="p">;</span>
	<span class="n">rf</span> <span class="o">=</span> <span class="n">rfatt</span><span class="o">-&gt;</span><span class="n">att</span><span class="p">;</span>
	<span class="n">tx_bias</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">tx_bias</span><span class="p">;</span>
	<span class="n">tx_magn</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">tx_magn</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_bias</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span>
		<span class="n">tx_bias</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Save the values for later. Use memmove, because it&#39;s valid</span>
<span class="cm">	 * to pass &amp;gphy-&gt;rfatt as rfatt pointer argument. Same for bbatt. */</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">=</span> <span class="n">tx_control</span><span class="p">;</span>
	<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">,</span> <span class="n">rfatt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rfatt</span><span class="p">));</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tx_control</span> <span class="o">&amp;</span> <span class="n">B43_TXCTL_TXMIX</span><span class="p">);</span>
	<span class="n">memmove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">,</span> <span class="n">bbatt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bbatt</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_XMITPOWER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Tuning TX-power to bbatt(%u), &quot;</span>
		       <span class="s">&quot;rfatt(%u), tx_control(0x%02X), &quot;</span>
		       <span class="s">&quot;tx_bias(0x%02X), tx_magn(0x%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bb</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">tx_control</span><span class="p">,</span> <span class="n">tx_bias</span><span class="p">,</span> <span class="n">tx_magn</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_gphy_set_baseband_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bb</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_RFATT</span><span class="p">,</span> <span class="n">rf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">rf</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tx_control</span> <span class="o">&amp;</span> <span class="mh">0x0070</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">,</span> <span class="p">(</span><span class="n">rf</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">));</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0070</span><span class="p">,</span> <span class="p">(</span><span class="n">tx_control</span> <span class="o">&amp;</span> <span class="mh">0x0070</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_tx_magnification</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="n">tx_magn</span> <span class="o">|</span> <span class="n">tx_bias</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">,</span> <span class="p">(</span><span class="n">tx_bias</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">b43_lo_g_adjust</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* GPHY_TSSI_Power_Lookup_Table_Init */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_tssi_power_lt_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_ofdmtab_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3C20</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_ofdmtab_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3C00</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">32</span><span class="p">,</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x380</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* GPHY_Gain_Lookup_Table_Init */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_gain_lt_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_txpower_lo_control</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">nr_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rf</span><span class="p">,</span> <span class="n">bb</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">rf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rf</span> <span class="o">&lt;</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">rfatt_list</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">rf</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">bb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bb</span> <span class="o">&lt;</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">bbatt_list</span><span class="p">.</span><span class="n">len</span><span class="p">;</span> <span class="n">bb</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nr_written</span> <span class="o">&gt;=</span> <span class="mh">0x40</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">bbatt_list</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">bb</span><span class="p">].</span><span class="n">att</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x50</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">rfatt_list</span><span class="p">.</span><span class="n">list</span><span class="p">[</span><span class="n">rf</span><span class="p">].</span><span class="n">att</span><span class="p">;</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3C0</span> <span class="o">+</span> <span class="n">nr_written</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">nr_written</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_all_gains</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">s16</span> <span class="n">first</span><span class="p">,</span> <span class="n">s16</span> <span class="n">second</span><span class="p">,</span> <span class="n">s16</span> <span class="n">third</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">start</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">table</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">B43_OFDMTAB_GAINX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">B43_OFDMTAB_GAINX_R1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_ofdmtab_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_ofdmtab_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">second</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">third</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">third</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">third</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span> <span class="mh">0xBFBF</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span> <span class="mh">0xBFBF</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span> <span class="mh">0xBFBF</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_dummy_transmission</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_original_gains</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">start</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="mh">0x0018</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">table</span> <span class="o">=</span> <span class="n">B43_OFDMTAB_GAINX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">table</span> <span class="o">=</span> <span class="n">B43_OFDMTAB_GAINX_R1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">b43_ofdmtab_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_ofdmtab_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span> <span class="mh">0xBFBF</span><span class="p">,</span> <span class="mh">0x4040</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span> <span class="mh">0xBFBF</span><span class="p">,</span> <span class="mh">0x4040</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span> <span class="mh">0xBFBF</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">b43_dummy_transmission</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nrssi_hw_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">s16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_NRSSILT_CTRL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_NRSSILT_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<span class="k">static</span> <span class="n">s16</span> <span class="nf">b43_nrssi_hw_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_NRSSILT_CTRL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_NRSSILT_DATA</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nrssi_hw_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_nrssi_hw_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">-=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
		<span class="n">b43_nrssi_hw_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_nrssi_mem_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">i</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x1F</span> <span class="o">-</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssislope</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">/=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="mh">0x3A</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">);</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_calc_nrssi_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">backup</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">s16</span> <span class="n">v47F</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">saved</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not in specs, but needed to prevent PPC machine check */</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">);</span>

	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0429</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x3FFF</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="mh">0xFFF3</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">);</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">);</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="n">v47F</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">((</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">v47F</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">==</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007B</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">v47F</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">((</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="n">v47F</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&lt;</span> <span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">saved</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
				<span class="n">saved</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saved</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="n">saved</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not in specs, but needed to prevent PPC machine check */</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">,</span> <span class="mh">0xFFFE</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0122</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not in specs, but needed to prevent PPC machine check */</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">,</span> <span class="mh">0xFFFB</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0xFF9F</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">);</span>
		<span class="n">b43_set_all_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="mh">0x00F0</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">v47F</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">((</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">v47F</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">==</span> <span class="o">-</span><span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007B</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
				<span class="n">v47F</span> <span class="o">=</span>
				    <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">((</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span>
					   <span class="mh">0x003F</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
					<span class="n">v47F</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">saved</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
					<span class="n">saved</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saved</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
				<span class="n">saved</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">saved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007B</span><span class="p">,</span> <span class="n">saved</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not in specs, but needed to prevent PPC machine check */</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0429</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">b43_set_original_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">18</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_calc_nrssi_slope</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">backup</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">nrssi0</span><span class="p">,</span> <span class="n">nrssi1</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_G</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">b43_calc_nrssi_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_CRS</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="mh">0xFFFC</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">,</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_LO_CONTROL</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_LO_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span> <span class="mh">0xFFBF</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">);</span>
	<span class="n">b43_set_all_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x00F7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="n">nrssi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">((</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">&gt;=</span> <span class="mh">0x0020</span><span class="p">)</span>
		<span class="n">nrssi0</span> <span class="o">-=</span> <span class="mh">0x0040</span><span class="p">;</span>

	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0xFF9F</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">,</span>
		    <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">)</span>
		    <span class="o">|</span> <span class="mh">0x2000</span><span class="p">);</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xF330</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_set_all_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="mh">0x001F</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF0F</span><span class="p">;</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x0060</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">;</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x0009</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="n">nrssi1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">((</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nrssi1</span> <span class="o">&gt;=</span> <span class="mh">0x0020</span><span class="p">)</span>
		<span class="n">nrssi1</span> <span class="o">-=</span> <span class="mh">0x0040</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">==</span> <span class="n">nrssi1</span><span class="p">)</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssislope</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssislope</span> <span class="o">=</span> <span class="mh">0x00400000</span> <span class="o">/</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">-</span> <span class="n">nrssi1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrssi1</span><span class="p">;</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrssi0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_LO_CONTROL</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">b43_synth_pu_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="p">(</span><span class="mh">0x0001</span> <span class="o">|</span> <span class="mh">0x0002</span><span class="p">));</span>
	<span class="n">b43_set_original_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_CRS</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">b43_nrssi_mem_update</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_calc_nrssi_threshold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_calc_nrssi_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">tmp16</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp_u16</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_G</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_RSSI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp16</span> <span class="o">=</span> <span class="n">b43_nrssi_hw_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp16</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">tmp16</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp16</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span> <span class="mh">0xF000</span><span class="p">,</span> <span class="mh">0x09EB</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span> <span class="mh">0xF000</span><span class="p">,</span> <span class="mh">0x0AED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">interfmode</span> <span class="o">==</span> <span class="n">B43_INTERFMODE_NONWLAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mh">0xA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span> <span class="o">&amp;&amp;</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_enable</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">a</span> <span class="o">+=</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">a</span> <span class="o">+=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">a</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">a</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

		<span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b</span> <span class="o">+=</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">b</span> <span class="o">+=</span> <span class="mi">31</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">b</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">b</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

		<span class="n">tmp_u16</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">;</span>
		<span class="n">tmp_u16</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x0000003F</span><span class="p">);</span>
		<span class="n">tmp_u16</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0000003F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span> <span class="n">tmp_u16</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Stack implementation to save/restore values from the</span>
<span class="cm"> * interference mitigation code.</span>
<span class="cm"> * It is save to restore values in random order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_stack_save</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">_stackptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">stackidx</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">stackptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">_stackptr</span><span class="p">[</span><span class="o">*</span><span class="n">stackidx</span><span class="p">]);</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">stackptr</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">stackptr</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="o">*</span><span class="n">stackptr</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">value</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stackidx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">*</span><span class="n">stackidx</span> <span class="o">&gt;=</span> <span class="n">B43_INTERFSTACK_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">_stack_restore</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">stackptr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xF0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">B43_INTERFSTACK_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">stackptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">stackptr</span> <span class="o">&amp;</span> <span class="mh">0x00000FFF</span><span class="p">)</span> <span class="o">!=</span> <span class="n">offset</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">stackptr</span> <span class="o">&amp;</span> <span class="mh">0x0000F000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="n">stackptr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define phy_stacksave(offset)					\</span>
<span class="cp">	do {							\</span>
<span class="cp">		_stack_save(stack, &amp;stackidx, 0x1, (offset),	\</span>
<span class="cp">			    b43_phy_read(dev, (offset)));	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define phy_stackrestore(offset)				\</span>
<span class="cp">	do {							\</span>
<span class="cp">		b43_phy_write(dev, (offset),		\</span>
<span class="cp">				  _stack_restore(stack, 0x1,	\</span>
<span class="cp">						 (offset)));	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define radio_stacksave(offset)						\</span>
<span class="cp">	do {								\</span>
<span class="cp">		_stack_save(stack, &amp;stackidx, 0x2, (offset),		\</span>
<span class="cp">			    b43_radio_read16(dev, (offset)));	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define radio_stackrestore(offset)					\</span>
<span class="cp">	do {								\</span>
<span class="cp">		b43_radio_write16(dev, (offset),			\</span>
<span class="cp">				      _stack_restore(stack, 0x2,	\</span>
<span class="cp">						     (offset)));	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define ofdmtab_stacksave(table, offset)			\</span>
<span class="cp">	do {							\</span>
<span class="cp">		_stack_save(stack, &amp;stackidx, 0x3, (offset)|(table),	\</span>
<span class="cp">			    b43_ofdmtab_read16(dev, (table), (offset)));	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define ofdmtab_stackrestore(table, offset)			\</span>
<span class="cp">	do {							\</span>
<span class="cp">		b43_ofdmtab_write16(dev, (table),	(offset),	\</span>
<span class="cp">				  _stack_restore(stack, 0x3,	\</span>
<span class="cp">						 (offset)|(table)));	\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">b43_radio_interference_mitigation_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">flipped</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">stackidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">stack</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">interfstack</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_INTERFMODE_NONWLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_CRS</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x4000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radio_stacksave</span><span class="p">(</span><span class="mh">0x0078</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x001E</span><span class="p">);</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">flipped</span> <span class="o">=</span> <span class="n">bitrev4</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flipped</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">flipped</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">flipped</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flipped</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">flipped</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">flipped</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitrev4</span><span class="p">(</span><span class="n">flipped</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0020</span><span class="p">;</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="n">flipped</span><span class="p">);</span>

		<span class="n">b43_calc_nrssi_threshold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0406</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0406</span><span class="p">,</span> <span class="mh">0x7E28</span><span class="p">);</span>

		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RADIO_BITFIELD</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>

		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A0</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span> <span class="mh">0xC0C0</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A1</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span> <span class="mh">0xC0C0</span><span class="p">,</span> <span class="mh">0x0605</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A2</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span> <span class="mh">0xC0C0</span><span class="p">,</span> <span class="mh">0x0204</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span> <span class="mh">0xC0C0</span><span class="p">,</span> <span class="mh">0x0803</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AB</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span> <span class="mh">0xC0C0</span><span class="p">,</span> <span class="mh">0x0605</span><span class="p">);</span>

		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A7</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A7</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A3</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A3</span><span class="p">,</span> <span class="mh">0x287A</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A9</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A9</span><span class="p">,</span> <span class="mh">0x2027</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0493</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0493</span><span class="p">,</span> <span class="mh">0x32F5</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AA</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AA</span><span class="p">,</span> <span class="mh">0x2027</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AC</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AC</span><span class="p">,</span> <span class="mh">0x32F5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_INTERFMODE_MANUALWLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">phy_stacksave</span><span class="p">(</span><span class="n">B43_PHY_RADIO_BITFIELD</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="n">B43_PHY_G_CRS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0406</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04C0</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04C1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0033</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A7</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A3</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A9</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AA</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AC</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0493</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A1</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A0</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A2</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x048A</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AD</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AD</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0415</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0416</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0417</span><span class="p">);</span>
			<span class="n">ofdmtab_stacksave</span><span class="p">(</span><span class="mh">0x1A00</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="n">ofdmtab_stacksave</span><span class="p">(</span><span class="mh">0x1A00</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x042B</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x048C</span><span class="p">);</span>

		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RADIO_BITFIELD</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_CRS</span><span class="p">,</span> <span class="mh">0xFFFC</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A3</span><span class="p">,</span> <span class="mh">0x2027</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A9</span><span class="p">,</span> <span class="mh">0x1CA8</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0493</span><span class="p">,</span> <span class="mh">0x287A</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AA</span><span class="p">,</span> <span class="mh">0x1CA8</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AC</span><span class="p">,</span> <span class="mh">0x287A</span><span class="p">);</span>

		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="mh">0x001A</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A7</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0406</span><span class="p">,</span> <span class="mh">0xFF0D</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04C0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04C1</span><span class="p">,</span> <span class="mh">0x00A9</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04C0</span><span class="p">,</span> <span class="mh">0x00C1</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04C1</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span> <span class="mh">0xC0FF</span><span class="p">,</span> <span class="mh">0x1800</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span> <span class="mh">0xCFFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0A00</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span> <span class="mh">0xCFFF</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">,</span> <span class="mh">0x000B</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0415</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x36D8</span><span class="p">);</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0416</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="mh">0x36D8</span><span class="p">);</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0417</span><span class="p">,</span> <span class="mh">0xFE00</span><span class="p">,</span> <span class="mh">0x016D</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span> <span class="mh">0x9FFF</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
			<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_HF_ACIW</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048C</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AE</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">);</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AD</span><span class="p">,</span> <span class="mh">0x00FF</span><span class="p">,</span> <span class="mh">0x1300</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_ofdmtab_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1A00</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">);</span>
			<span class="n">b43_ofdmtab_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1A00</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">);</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AD</span><span class="p">,</span> <span class="mh">0x00FF</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_calc_nrssi_slope</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">b43_radio_interference_mitigation_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">stack</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">interfstack</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_INTERFMODE_NONWLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0800</span><span class="p">);</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_CRS</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radio_stackrestore</span><span class="p">(</span><span class="mh">0x0078</span><span class="p">);</span>
		<span class="n">b43_calc_nrssi_threshold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0406</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0800</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bad_frames_preempt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RADIO_BITFIELD</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_CRS</span><span class="p">,</span> <span class="mh">0x4000</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A0</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A1</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A2</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AB</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A7</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A3</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A9</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0493</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AA</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_INTERFMODE_MANUALWLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="n">B43_PHY_RADIO_BITFIELD</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="n">B43_PHY_G_CRS</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0033</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A3</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A9</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0493</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AA</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AC</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A0</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04C0</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04C1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0406</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A1</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AB</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AD</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AD</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0415</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0416</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0417</span><span class="p">);</span>
			<span class="n">ofdmtab_stackrestore</span><span class="p">(</span><span class="mh">0x1A00</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="n">ofdmtab_stackrestore</span><span class="p">(</span><span class="mh">0x1A00</span><span class="p">,</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A2</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x048A</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x042B</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x048C</span><span class="p">);</span>
		<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_HF_ACIW</span><span class="p">);</span>
		<span class="n">b43_calc_nrssi_slope</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#undef phy_stacksave</span>
<span class="cp">#undef phy_stackrestore</span>
<span class="cp">#undef radio_stacksave</span>
<span class="cp">#undef radio_stackrestore</span>
<span class="cp">#undef ofdmtab_stacksave</span>
<span class="cp">#undef ofdmtab_stackrestore</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_radio_core_calibration_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rcc_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>
		<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>
		<span class="mh">0x0A</span><span class="p">,</span> <span class="mh">0x0B</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>
		<span class="mh">0x0E</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span> <span class="mh">0x0D</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x001E</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rcc_table</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="mh">0x0020</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LPD(L, P, D)	(((L) &lt;&lt; 2) | ((P) &lt;&lt; 1) | ((D) &lt;&lt; 0))</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">radio2050_rfover_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">phy_register</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">has_loopback_gain</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_lb_gain</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">max_lb_gain</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">extlna</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">max_lb_gain</span> <span class="o">+=</span> <span class="mh">0x3E</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">max_lb_gain</span> <span class="o">+=</span> <span class="mh">0x26</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_lb_gain</span> <span class="o">&gt;=</span> <span class="mh">0x46</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">extlna</span> <span class="o">=</span> <span class="mh">0x3000</span><span class="p">;</span>
			<span class="n">max_lb_gain</span> <span class="o">-=</span> <span class="mh">0x46</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_lb_gain</span> <span class="o">&gt;=</span> <span class="mh">0x3A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">extlna</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
			<span class="n">max_lb_gain</span> <span class="o">-=</span> <span class="mh">0x3A</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_lb_gain</span> <span class="o">&gt;=</span> <span class="mh">0x2E</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">extlna</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="n">max_lb_gain</span> <span class="o">-=</span> <span class="mh">0x2E</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">extlna</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">max_lb_gain</span> <span class="o">-=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_lb_gain</span> <span class="o">-=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max_lb_gain</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_EXTLNA</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_register</span> <span class="o">==</span> <span class="n">B43_PHY_RFOVER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mh">0x1B3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_register</span> <span class="o">==</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">extlna</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">lpd</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x0F92</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="p">(</span><span class="mh">0x0092</span> <span class="o">|</span> <span class="n">extlna</span><span class="p">);</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>:
					<span class="k">return</span> <span class="p">(</span><span class="mh">0x0093</span> <span class="o">|</span> <span class="n">extlna</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_register</span> <span class="o">==</span> <span class="n">B43_PHY_RFOVER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mh">0x9B3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_register</span> <span class="o">==</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">extlna</span><span class="p">)</span>
					<span class="n">extlna</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
				<span class="n">extlna</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">lpd</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x8F92</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="p">(</span><span class="mh">0x8092</span> <span class="o">|</span> <span class="n">extlna</span><span class="p">);</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="p">(</span><span class="mh">0x2092</span> <span class="o">|</span> <span class="n">extlna</span><span class="p">);</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>:
					<span class="k">return</span> <span class="p">(</span><span class="mh">0x2093</span> <span class="o">|</span> <span class="n">extlna</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_EXTLNA</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_register</span> <span class="o">==</span> <span class="n">B43_PHY_RFOVER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mh">0x1B3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_register</span> <span class="o">==</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">lpd</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x0FB2</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x00B2</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x30B2</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x30B3</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy_register</span> <span class="o">==</span> <span class="n">B43_PHY_RFOVER</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="mh">0x9B3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy_register</span> <span class="o">==</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">lpd</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x8FB2</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x80B2</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x20B2</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>:
					<span class="k">return</span> <span class="mh">0x20B3</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">init2050_saved_values</span> <span class="p">{</span>
	<span class="cm">/* Core registers */</span>
	<span class="n">u16</span> <span class="n">reg_3EC</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_3E6</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg_3F4</span><span class="p">;</span>
	<span class="cm">/* Radio registers */</span>
	<span class="n">u16</span> <span class="n">radio_43</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_51</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_52</span><span class="p">;</span>
	<span class="cm">/* PHY registers */</span>
	<span class="n">u16</span> <span class="n">phy_pgactl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_cck_5A</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_cck_59</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_cck_58</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_cck_30</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_rfover</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_rfoverval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_analogover</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_analogoverval</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_crs0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_classctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_lo_mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_lo_ctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_syncctl</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_radio_init2050</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">init2050_saved_values</span> <span class="n">sav</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rcc</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio78</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tmp2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sav</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sav</span><span class="p">));</span>	<span class="cm">/* get rid of &quot;may be used uninitialized...&quot; */</span>

	<span class="n">sav</span><span class="p">.</span><span class="n">radio_43</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">sav</span><span class="p">.</span><span class="n">radio_51</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">);</span>
	<span class="n">sav</span><span class="p">.</span><span class="n">radio_52</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">);</span>
	<span class="n">sav</span><span class="p">.</span><span class="n">phy_pgactl</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">);</span>
	<span class="n">sav</span><span class="p">.</span><span class="n">phy_cck_5A</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x5A</span><span class="p">));</span>
	<span class="n">sav</span><span class="p">.</span><span class="n">phy_cck_59</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x59</span><span class="p">));</span>
	<span class="n">sav</span><span class="p">.</span><span class="n">phy_cck_58</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sav</span><span class="p">.</span><span class="n">phy_cck_30</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x30</span><span class="p">));</span>
		<span class="n">sav</span><span class="p">.</span><span class="n">reg_3EC</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3EC</span><span class="p">);</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x30</span><span class="p">),</span> <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3EC</span><span class="p">,</span> <span class="mh">0x3F3F</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sav</span><span class="p">.</span><span class="n">phy_rfover</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">);</span>
		<span class="n">sav</span><span class="p">.</span><span class="n">phy_rfoverval</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">);</span>
		<span class="n">sav</span><span class="p">.</span><span class="n">phy_analogover</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">);</span>
		<span class="n">sav</span><span class="p">.</span><span class="n">phy_analogoverval</span> <span class="o">=</span>
		    <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">);</span>
		<span class="n">sav</span><span class="p">.</span><span class="n">phy_crs0</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CRS0</span><span class="p">);</span>
		<span class="n">sav</span><span class="p">.</span><span class="n">phy_classctl</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CLASSCTL</span><span class="p">);</span>

		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">,</span> <span class="mh">0xFFFC</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CRS0</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CLASSCTL</span><span class="p">,</span> <span class="mh">0xFFFC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_loopback_gain</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sav</span><span class="p">.</span><span class="n">phy_lo_mask</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">);</span>
			<span class="n">sav</span><span class="p">.</span><span class="n">phy_lo_ctl</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_CTL</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">,</span> <span class="mh">0xC020</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">,</span> <span class="mh">0x8020</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
			      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
						   <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span>
			      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3E2</span><span class="p">,</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3E2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>

	<span class="n">sav</span><span class="p">.</span><span class="n">phy_syncctl</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_SYNCCTL</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_SYNCCTL</span><span class="p">,</span> <span class="mh">0xFF7F</span><span class="p">);</span>
	<span class="n">sav</span><span class="p">.</span><span class="n">reg_3E6</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3E6</span><span class="p">);</span>
	<span class="n">sav</span><span class="p">.</span><span class="n">reg_3F4</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3F4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="mh">0x0122</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x03</span><span class="p">),</span> <span class="mh">0xFFBF</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2000</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">rcc</span> <span class="o">=</span> <span class="n">b43_radio_core_calibration_value</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_B</span><span class="p">)</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
			      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
						   <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xBFAF</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2B</span><span class="p">),</span> <span class="mh">0x1403</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
			      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
						   <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xBFA0</span><span class="p">);</span>
	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x5A</span><span class="p">),</span> <span class="mh">0x0480</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x59</span><span class="p">),</span> <span class="mh">0xC810</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="mh">0x000D</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
				      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
							   <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xAFB0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
				      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
							   <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xEFB0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
				      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
							   <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">tmp1</span> <span class="o">+=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_LEAKAGE</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
				      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							   <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
							   <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="p">}</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xAFB0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">tmp1</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">&gt;&gt;=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">radio78</span> <span class="o">=</span> <span class="p">(</span><span class="n">bitrev4</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0020</span><span class="p">;</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="n">radio78</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x5A</span><span class="p">),</span> <span class="mh">0x0D80</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x59</span><span class="p">),</span> <span class="mh">0xC810</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="mh">0x000D</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
					      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
								   <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								       <span class="mi">1</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xAFB0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
					      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
								   <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								       <span class="mi">1</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xEFB0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
					      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
								   <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								       <span class="mi">0</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">tmp2</span> <span class="o">+=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_LEAKAGE</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
					      <span class="n">radio2050_rfover_val</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								   <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
								   <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
								       <span class="mi">1</span><span class="p">)));</span>
			<span class="p">}</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xAFB0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tmp2</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tmp2</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">&lt;</span> <span class="n">tmp2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restore the registers */</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_pgactl</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">radio_51</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">radio_52</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">radio_43</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x5A</span><span class="p">),</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_cck_5A</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x59</span><span class="p">),</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_cck_59</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_cck_58</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3E6</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">reg_3E6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3F4</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">reg_3F4</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_SYNCCTL</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_syncctl</span><span class="p">);</span>
	<span class="n">b43_synth_pu_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x30</span><span class="p">),</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_cck_30</span><span class="p">);</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3EC</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">reg_3EC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_RADIO</span><span class="p">,</span>
			    <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_RADIO</span><span class="p">)</span>
			    <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_rfover</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_rfoverval</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_analogover</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">,</span>
			      <span class="n">sav</span><span class="p">.</span><span class="n">phy_analogoverval</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CRS0</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_crs0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CLASSCTL</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_classctl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">has_loopback_gain</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_lo_mask</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_CTL</span><span class="p">,</span> <span class="n">sav</span><span class="p">.</span><span class="n">phy_lo_ctl</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">radio78</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rcc</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_phy_initb5</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">old_channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">!=</span> <span class="n">SSB_BOARDVENDOR_BCM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">!=</span> <span class="n">SSB_BOARD_BU4306</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x2120</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x00A8</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mh">0x00C7</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="n">value</span> <span class="o">+=</span> <span class="mh">0x202</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="mh">0x0700</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">,</span> <span class="mh">0x0667</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
			<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_RADIO</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x001C</span><span class="p">,</span> <span class="mh">0x186A</span><span class="p">);</span>

		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">,</span> <span class="mh">0x00FF</span><span class="p">,</span> <span class="mh">0x1900</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005D</span><span class="p">,</span> <span class="mh">0xFF80</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bad_frames_preempt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RADIO_BITFIELD</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0xCE00</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="mh">0x3763</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="mh">0x1BC3</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x06F9</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0024</span><span class="p">,</span> <span class="mh">0x037E</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0xCC00</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x00C6</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03EC</span><span class="p">,</span> <span class="mh">0x3F22</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x3E1C</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x301C</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E4</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">);</span>

	<span class="n">old_channel</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="cm">/* Force to channel 7, even if not supported. */</span>
	<span class="n">b43_gphy_channel_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0075</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0079</span><span class="p">,</span> <span class="mh">0x0081</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005B</span><span class="p">,</span> <span class="mh">0x007B</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005C</span><span class="p">,</span> <span class="mh">0x00B0</span><span class="p">);</span>

	<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>

	<span class="n">b43_gphy_channel_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">old_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">,</span> <span class="mh">0x00CA</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002A</span><span class="p">,</span> <span class="mh">0x88A3</span><span class="p">);</span>

	<span class="n">b43_set_txpower_g</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">,</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tx_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005D</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E4</span><span class="p">,</span> <span class="p">(</span><span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0004</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_phy_initb6</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">old_channel</span><span class="p">;</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x003E</span><span class="p">,</span> <span class="mh">0x817A</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0058</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xB3</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x9B</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span>
			     <span class="o">|</span> <span class="n">B43_HF_TSSIRPSMW</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">7</span><span class="p">);</span>	<span class="cm">/* We had code for these revs here... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x51</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xB7</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x6B</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0x0F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_ALTIQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0xFA</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xD8</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0xF5</span><span class="p">);</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5E</span><span class="p">,</span> <span class="mh">0xB8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0073</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007D</span><span class="p">,</span> <span class="mh">0x00A8</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007C</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007E</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x1E1F</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x0088</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mh">0x0098</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="mh">0x0202</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x3E3F</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x0098</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mh">0x00A8</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="mh">0x0202</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0x2120</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mh">0x00A8</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mh">0x00C8</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x3F3F</span><span class="p">));</span>
		<span class="n">val</span> <span class="o">+=</span> <span class="mh">0x0202</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">b43_radio_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">old_channel</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_channel</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">b43_gphy_channel_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_gphy_channel_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">40</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="p">(</span><span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">)</span>
					      <span class="o">|</span> <span class="mh">0x0002</span><span class="p">));</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5A</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5B</span><span class="p">,</span> <span class="mh">0x7B</span><span class="p">);</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">,</span> <span class="mh">0xB0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="mh">0x00F8</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">);</span>

	<span class="n">b43_gphy_channel_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">old_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x88C2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x2A</span><span class="p">,</span> <span class="mh">0x8AC0</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0038</span><span class="p">,</span> <span class="mh">0x0668</span><span class="p">);</span>
	<span class="n">b43_set_txpower_g</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">,</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tx_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span> <span class="mh">0xFF80</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005D</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3E4</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_B</span><span class="p">)</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_G</span><span class="p">)</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_calc_loopback_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">backup_radio</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">backup_bband</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">loop_i_max</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">trsw_rx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">loop1_outer_done</span><span class="p">,</span> <span class="n">loop1_inner_done</span><span class="p">;</span>

	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CRS0</span><span class="p">);</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCKBBANDCFG</span><span class="p">);</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">);</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not in specs, but needed to prevent PPC machine check */</span>
		<span class="n">backup_phy</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">);</span>
		<span class="n">backup_phy</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x5A</span><span class="p">));</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x59</span><span class="p">));</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">));</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x0A</span><span class="p">));</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x03</span><span class="p">));</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">);</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_CTL</span><span class="p">);</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2B</span><span class="p">));</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">);</span>
	<span class="n">backup_phy</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_LEAKAGE</span><span class="p">);</span>
	<span class="n">backup_bband</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">.</span><span class="n">att</span><span class="p">;</span>
	<span class="n">backup_radio</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">);</span>
	<span class="n">backup_radio</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">);</span>
	<span class="n">backup_radio</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">);</span>

	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CRS0</span><span class="p">,</span> <span class="mh">0x3FFF</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCKBBANDCFG</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0xFFFD</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0xFFFE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not in specs, but needed to prevent PPC machine check */</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">,</span> <span class="mh">0xFFFE</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">,</span> <span class="mh">0xFFFD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0x000C</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0xFFCF</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x5A</span><span class="p">),</span> <span class="mh">0x0780</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x59</span><span class="p">),</span> <span class="mh">0xC810</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="mh">0x000D</span><span class="p">);</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x0A</span><span class="p">),</span> <span class="mh">0x2000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not in specs, but needed to prevent PPC machine check */</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">,</span> <span class="mh">0xFFFB</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x03</span><span class="p">),</span> <span class="mh">0xFF9F</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">,</span> <span class="mh">0x9</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_gphy_set_baseband_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">11</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">,</span> <span class="mh">0xC020</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">,</span> <span class="mh">0x8020</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2B</span><span class="p">),</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2B</span><span class="p">),</span> <span class="mh">0xC0FF</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">);</span>

	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0xCFFF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_EXTLNA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="mh">0x00F7</span><span class="p">);</span>

	<span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">loop_i_max</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="mi">15</span> <span class="o">:</span> <span class="mi">9</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">loop_i_max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="mh">0xA000</span><span class="p">);</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xF000</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_LEAKAGE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0xDFC</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_loop1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
      <span class="nl">exit_loop1:</span>
	<span class="n">loop1_outer_done</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">loop1_inner_done</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="n">trsw_rx</span> <span class="o">=</span> <span class="mh">0x1B</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="mh">0xF0FF</span><span class="p">,</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="mh">0xA000</span><span class="p">);</span>
			<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xF000</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">trsw_rx</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_LEAKAGE</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mh">0xDFC</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">exit_loop2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">trsw_rx</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
      <span class="nl">exit_loop2:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Not in specs, but needed to prevent PPC machine check */</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x5A</span><span class="p">),</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x59</span><span class="p">),</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x58</span><span class="p">),</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x0A</span><span class="p">),</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x03</span><span class="p">),</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_CTL</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2B</span><span class="p">),</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>

	<span class="n">b43_gphy_set_baseband_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">backup_bband</span><span class="p">);</span>

	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="n">backup_radio</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="n">backup_radio</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7A</span><span class="p">,</span> <span class="n">backup_radio</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CRS0</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCKBBANDCFG</span><span class="p">,</span> <span class="n">backup_phy</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">max_lb_gain</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">loop1_inner_done</span> <span class="o">*</span> <span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">loop1_outer_done</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="o">-</span> <span class="mi">11</span><span class="p">;</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">trsw_rx_gain</span> <span class="o">=</span> <span class="n">trsw_rx</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_hardware_pctl_early_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_has_hardware_pctl</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047A</span><span class="p">,</span> <span class="mh">0xC111</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0xFEFF</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="mh">0x0202</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047C</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047A</span><span class="p">,</span> <span class="mh">0xF000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047A</span><span class="p">,</span> <span class="mh">0xFF0F</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005D</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x004E</span><span class="p">,</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="mh">0xC07F</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0x0400</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005D</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x004F</span><span class="p">,</span> <span class="mh">0xFFFE</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x004E</span><span class="p">,</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="mh">0xC07F</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047A</span><span class="p">,</span> <span class="mh">0xFF0F</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Hardware power control for G-PHY */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_hardware_pctl_init_gphy</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_has_hardware_pctl</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No hardware power control */</span>
		<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_HF_HWPCTL</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="mh">0xFFC0</span><span class="p">,</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span> <span class="o">-</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">cur_idle_tssi</span><span class="p">));</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span> <span class="o">-</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">cur_idle_tssi</span><span class="p">));</span>
	<span class="n">b43_gphy_tssi_power_lt_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_gphy_gain_lt_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0xFFBF</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="mh">0xFEFF</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span> <span class="mh">0xFFBF</span><span class="p">);</span>

	<span class="n">b43_gphy_dc_lt_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Enable hardware pctl in firmware. */</span>
	<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_HF_HWPCTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialize B/G PHY power control */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_phy_init_pctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_rfatt</span> <span class="n">old_rfatt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_bbatt</span> <span class="n">old_bbatt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">old_tx_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_G</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span> <span class="n">SSB_BOARDVENDOR_BCM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">SSB_BOARD_BU4306</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0028</span><span class="p">,</span> <span class="mh">0x8018</span><span class="p">);</span>

	<span class="cm">/* This does something with the Analog... */</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY0</span><span class="p">,</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY0</span><span class="p">)</span>
		    <span class="o">&amp;</span> <span class="mh">0xFFDF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43_hardware_pctl_early_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">cur_idle_tssi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span> <span class="mh">0x00F7</span><span class="p">,</span> <span class="mh">0x0084</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">b43_rfatt</span> <span class="n">rfatt</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">b43_bbatt</span> <span class="n">bbatt</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_rfatt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">old_rfatt</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_bbatt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">old_bbatt</span><span class="p">));</span>
			<span class="n">old_tx_control</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tx_control</span><span class="p">;</span>

			<span class="n">bbatt</span><span class="p">.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rfatt</span><span class="p">.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
				<span class="n">rfatt</span><span class="p">.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rfatt</span><span class="p">.</span><span class="n">att</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
				<span class="n">rfatt</span><span class="p">.</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">b43_set_txpower_g</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbatt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfatt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43_dummy_transmission</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">cur_idle_tssi</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ITSSI</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">B43_DEBUG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Current-Idle-TSSI sanity check. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">cur_idle_tssi</span> <span class="o">-</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
				       <span class="s">&quot;!WARNING! Idle-TSSI phy-&gt;cur_idle_tssi &quot;</span>
				       <span class="s">&quot;measuring failed. (cur=%d, tgt=%d). Disabling TX power &quot;</span>
				       <span class="s">&quot;adjustment.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">cur_idle_tssi</span><span class="p">,</span>
				       <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span><span class="p">);</span>
				<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">cur_idle_tssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_radio_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0076</span><span class="p">,</span> <span class="mh">0xFF7B</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_set_txpower_g</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_bbatt</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">old_rfatt</span><span class="p">,</span> <span class="n">old_tx_control</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">b43_hardware_pctl_init_gphy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_shm_clear_tssi</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_phy_initg</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">b43_phy_initb5</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_initb6</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">b43_phy_inita</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANALOGOVERVAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_PGACTL</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_VERSION_OFDM</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="n">B43_PHYVER_VERSION</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_OFDM</span><span class="p">(</span><span class="mh">0xC2</span><span class="p">),</span> <span class="mh">0x1816</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_OFDM</span><span class="p">(</span><span class="mh">0xC3</span><span class="p">),</span> <span class="mh">0x8006</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_OFDM</span><span class="p">(</span><span class="mh">0xCC</span><span class="p">),</span> <span class="mh">0x00FF</span><span class="p">,</span> <span class="mh">0x1F00</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_OFDM</span><span class="p">(</span><span class="mh">0x7E</span><span class="p">),</span> <span class="mh">0x78</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_EXTG</span><span class="p">(</span><span class="mh">0x01</span><span class="p">),</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_OFDM</span><span class="p">(</span><span class="mh">0x3E</span><span class="p">),</span> <span class="mh">0x4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_loopback_gain</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span>
		<span class="n">b43_calc_loopback_gain</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">!=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">initval</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">initval</span> <span class="o">=</span> <span class="n">b43_radio_init2050</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">initval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_lo_g_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_tx_magnification</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">b43_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span>
				  <span class="o">|</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="o">-&gt;</span><span class="n">tx_bias</span> <span class="o">|</span> <span class="n">gphy</span><span class="o">-&gt;</span>
				  <span class="n">lo_control</span><span class="o">-&gt;</span><span class="n">tx_magn</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_radio_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">,</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="o">-&gt;</span><span class="n">tx_bias</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x36</span><span class="p">),</span> <span class="mh">0x0FFF</span><span class="p">,</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="o">-&gt;</span><span class="n">tx_bias</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_PACTRL</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2E</span><span class="p">),</span> <span class="mh">0x8075</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2E</span><span class="p">),</span> <span class="mh">0x807F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2F</span><span class="p">),</span> <span class="mh">0x101</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CCK</span><span class="p">(</span><span class="mh">0x2F</span><span class="p">),</span> <span class="mh">0x202</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_lo_g_adjust</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_LO_MASK</span><span class="p">,</span> <span class="mh">0x8078</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_RSSI</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The specs state to update the NRSSI LT with</span>
<span class="cm">		 * the value 0x7FFFFFFF here. I think that is some weird</span>
<span class="cm">		 * compiler optimization in the original driver.</span>
<span class="cm">		 * Essentially, what we do here is resetting all NRSSI LT</span>
<span class="cm">		 * entries to -32 (see the clamp_val() in nrssi_hw_update())</span>
<span class="cm">		 */</span>
		<span class="n">b43_nrssi_hw_update</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>	<span class="c1">//FIXME?</span>
		<span class="n">b43_calc_nrssi_threshold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">b43_calc_nrssi_slope</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">b43_calc_nrssi_threshold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_EXTG</span><span class="p">(</span><span class="mh">0x05</span><span class="p">),</span> <span class="mh">0x3230</span><span class="p">);</span>
	<span class="n">b43_phy_init_pctl</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* FIXME: The spec says in the following if, the 0 should be replaced</span>
<span class="cm">	   &#39;if OFDM may not be used in the current locale&#39;</span>
<span class="cm">	   but OFDM is legal everywhere */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4306</span>
	     <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_pkg</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_CRS0</span><span class="p">,</span> <span class="mh">0xBFFF</span><span class="p">);</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_OFDM</span><span class="p">(</span><span class="mh">0xC3</span><span class="p">),</span> <span class="mh">0x7FFF</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43_gphy_channel_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">synthetic_pu_workaround</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synthetic_pu_workaround</span><span class="p">)</span>
		<span class="n">b43_synth_pu_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL</span><span class="p">,</span> <span class="n">channel2freq_bg</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">country_code</span> <span class="o">==</span>
		    <span class="n">SSB_SPROM1CCODE_JAPAN</span><span class="p">)</span>
			<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_HF_ACPR</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_HF_ACPR</span><span class="p">);</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">,</span>
			    <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">)</span>
			    <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">,</span>
			    <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_CHANNEL_EXT</span><span class="p">)</span>
			    <span class="o">&amp;</span> <span class="mh">0xF7BF</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_baseband_attenuation</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">b43_bbatt</span> <span class="o">*</span><span class="n">bb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">bb</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bb</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">default_radio_attenuation</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">b43_rfatt</span> <span class="o">*</span><span class="n">rf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">bdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">rf</span><span class="o">-&gt;</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span> <span class="n">SSB_BOARDVENDOR_BCM</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">SSB_BOARD_BCM4309G</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_rev</span> <span class="o">&lt;</span> <span class="mh">0x43</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board_rev</span> <span class="o">&lt;</span> <span class="mh">0x51</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x2053</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2050</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_G</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span> <span class="n">SSB_BOARDVENDOR_BCM</span>
				    <span class="o">&amp;&amp;</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">SSB_BOARD_BCM4309G</span>
				    <span class="o">&amp;&amp;</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_rev</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span>
					 <span class="n">SSB_BOARDVENDOR_BCM</span>
					 <span class="o">&amp;&amp;</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span>
					 <span class="n">SSB_BOARD_BU4306</span><span class="p">)</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span> <span class="n">SSB_BOARDVENDOR_BCM</span>
				    <span class="o">&amp;&amp;</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">SSB_BOARD_BCM4309G</span>
				    <span class="o">&amp;&amp;</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_rev</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_G</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span> <span class="n">SSB_BOARDVENDOR_BCM</span>
				    <span class="o">&amp;&amp;</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">SSB_BOARD_BCM4309G</span>
				    <span class="o">&amp;&amp;</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_rev</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_vendor</span> <span class="o">==</span>
					 <span class="n">SSB_BOARDVENDOR_BCM</span>
					 <span class="o">&amp;&amp;</span> <span class="n">bdev</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span>
					 <span class="n">SSB_BOARD_BU4306</span><span class="p">)</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4320</span><span class="p">)</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mh">0xA</span><span class="p">;</span>
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">with_padmix</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:
		<span class="nl">default:</span>
			<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">rf</span><span class="o">-&gt;</span><span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">default_tx_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">B43_TXCTL_PA2DB</span> <span class="o">|</span> <span class="n">B43_TXCTL_TXMIX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">B43_TXCTL_PA2DB</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">B43_TXCTL_TXMIX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">b43_gphy_aci_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">saved</span><span class="p">,</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">saved</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">);</span>
	<span class="n">b43_switch_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="p">(</span><span class="n">saved</span> <span class="o">&amp;</span> <span class="mh">0xFFF8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_hw_rssi</span><span class="p">)</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">saved</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="cm">/* clamp temp to signed 5bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">rssi</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">rssi</span><span class="p">)</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="n">saved</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">b43_gphy_aci_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_G</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">b43_phy_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_radio_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="mh">0xFFFC</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_CRS</span><span class="p">,</span> <span class="mh">0x7FFF</span><span class="p">);</span>
	<span class="n">b43_set_all_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">channel</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">?</span> <span class="n">channel</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">13</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ret</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_gphy_aci_detect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_switch_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="mh">0xFFFC</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="mh">0xFFF8</span><span class="p">);</span>
	<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_G_CRS</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">b43_set_original_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">?</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ret</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_radio_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_phy_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">b43_tssi2dbm_ad</span><span class="p">(</span><span class="n">s32</span> <span class="n">num</span><span class="p">,</span> <span class="n">s32</span> <span class="n">den</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">num</span> <span class="o">+</span> <span class="n">den</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">den</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s8</span> <span class="nf">b43_tssi2dbm_entry</span><span class="p">(</span><span class="n">s8</span> <span class="n">entry</span><span class="p">[],</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			     <span class="n">s16</span> <span class="n">pab0</span><span class="p">,</span> <span class="n">s16</span> <span class="n">pab1</span><span class="p">,</span> <span class="n">s16</span> <span class="n">pab2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="mi">256</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">m1</span> <span class="o">=</span> <span class="n">b43_tssi2dbm_ad</span><span class="p">(</span><span class="mi">16</span> <span class="o">*</span> <span class="n">pab0</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">pab1</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">m2</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">b43_tssi2dbm_ad</span><span class="p">(</span><span class="mi">32768</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">pab2</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">q</span> <span class="o">=</span> <span class="n">b43_tssi2dbm_ad</span><span class="p">(</span><span class="n">f</span> <span class="o">*</span> <span class="mi">4096</span> <span class="o">-</span>
				    <span class="n">b43_tssi2dbm_ad</span><span class="p">(</span><span class="n">m2</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="mi">2048</span><span class="p">);</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">q</span> <span class="o">-</span> <span class="n">f</span><span class="p">);</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">q</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">delta</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">entry</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">b43_tssi2dbm_ad</span><span class="p">(</span><span class="n">m1</span> <span class="o">*</span> <span class="n">f</span><span class="p">,</span> <span class="mi">8192</span><span class="p">),</span> <span class="o">-</span><span class="mi">127</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="o">*</span><span class="nf">b43_generate_dyn_tssi2dbm_tab</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">s16</span> <span class="n">pab0</span><span class="p">,</span> <span class="n">s16</span> <span class="n">pab1</span><span class="p">,</span> <span class="n">s16</span> <span class="n">pab2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tab</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">tab</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tab</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Could not allocate memory &quot;</span>
		       <span class="s">&quot;for tssi2dbm table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_tssi2dbm_entry</span><span class="p">(</span><span class="n">tab</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pab0</span><span class="p">,</span> <span class="n">pab1</span><span class="p">,</span> <span class="n">pab2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Could not generate &quot;</span>
			       <span class="s">&quot;tssi2dBm table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tab</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">tab</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialise the TSSI-&gt;dBm lookup table */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_gphy_init_tssi2dbm_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">pab0</span><span class="p">,</span> <span class="n">pab1</span><span class="p">,</span> <span class="n">pab2</span><span class="p">;</span>

	<span class="n">pab0</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">pa0b0</span><span class="p">);</span>
	<span class="n">pab1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">pa0b1</span><span class="p">);</span>
	<span class="n">pab2</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">pa0b2</span><span class="p">);</span>

	<span class="n">B43_WARN_ON</span><span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4301</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">));</span> <span class="cm">/* Not supported anymore */</span>

	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">dyn_tssi_tbl</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pab0</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pab1</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pab2</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pab0</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pab1</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">pab2</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The pabX values are set in SPROM. Use them. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">s8</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">itssi_bg</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">itssi_bg</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">s8</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">itssi_bg</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span> <span class="o">=</span> <span class="mi">62</span><span class="p">;</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span> <span class="o">=</span> <span class="n">b43_generate_dyn_tssi2dbm_tab</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pab0</span><span class="p">,</span>
							       <span class="n">pab1</span><span class="p">,</span> <span class="n">pab2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">dyn_tssi_tbl</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* pabX values not set in SPROM. */</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span> <span class="o">=</span> <span class="mi">52</span><span class="p">;</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span> <span class="o">=</span> <span class="n">b43_tssi2dbm_g_table</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_gphy_op_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_txpower_lo_control</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">gphy</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gphy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">gphy</span><span class="p">;</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">lo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lo</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_gphy</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_gphy_init_tssi2dbm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_lo</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_lo:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lo</span><span class="p">);</span>
<span class="nl">err_free_gphy:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">gphy</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_prepare_structs</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tssi2dbm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tgt_idle_tssi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_txpower_lo_control</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* tssi2dbm table is constant, so it is initialized at alloc time.</span>
<span class="cm">	 * Save a copy of the pointer. */</span>
	<span class="n">tssi2dbm</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">;</span>
	<span class="n">tgt_idle_tssi</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span><span class="p">;</span>
	<span class="cm">/* Save the LO pointer. */</span>
	<span class="n">lo</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="p">;</span>

	<span class="cm">/* Zero out the whole PHY structure. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">gphy</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">gphy</span><span class="p">));</span>

	<span class="cm">/* Restore pointers. */</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span> <span class="o">=</span> <span class="n">tssi2dbm</span><span class="p">;</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span> <span class="o">=</span> <span class="n">tgt_idle_tssi</span><span class="p">;</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span> <span class="o">=</span> <span class="n">lo</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">minlowsig</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">minlowsig</span><span class="p">));</span>

	<span class="cm">/* NRSSI */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lofcal</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">initval</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">interfmode</span> <span class="o">=</span> <span class="n">B43_INTERFMODE_NONE</span><span class="p">;</span>

	<span class="cm">/* OFDM-table address caching. */</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">ofdmtab_addr_direction</span> <span class="o">=</span> <span class="n">B43_OFDMTAB_DIRECTION_UNKNOWN</span><span class="p">;</span>

	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">average_tssi</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="cm">/* Local Osciallator structure */</span>
	<span class="n">lo</span><span class="o">-&gt;</span><span class="n">tx_bias</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">calib_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">dyn_tssi_tbl</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">);</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">dyn_tssi_tbl</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">gphy</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">g</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_gphy_op_prepare_hardware</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_txpower_lo_control</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_G</span><span class="p">);</span>

	<span class="n">default_baseband_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">);</span>
	<span class="n">default_radio_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">);</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">default_tx_control</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">generate_rfatt_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">rfatt_list</span><span class="p">);</span>
	<span class="n">generate_bbatt_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="o">-&gt;</span><span class="n">bbatt_list</span><span class="p">);</span>

	<span class="cm">/* Commit previous writes */</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Workaround: Temporarly disable gmode through the early init</span>
<span class="cm">		 * phase, as the gmode stuff is not needed for phy rev 1 */</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">b43_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_phy_initg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">b43_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_gphy_op_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_phy_initg</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_lo_g_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_gphy_op_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_DATA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_gphy_op_radio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Register 1 is a 32-bit register. */</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* G-PHY needs 0x80 for read access. */</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_DATA_LOW</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_radio_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Register 1 is a 32-bit register. */</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_DATA_LOW</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">b43_gphy_op_supports_hwpctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_software_rfkill</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">bool</span> <span class="n">blocked</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blocked</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Turn radio ON */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_on</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xCC00</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">?</span> <span class="mh">0x00C0</span> <span class="o">:</span> <span class="mh">0x0000</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Restore the RFover values. */</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span>
				      <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">rfover</span><span class="p">);</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span>
				      <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">rfoverval</span><span class="p">);</span>
			<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">b43_gphy_channel_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_gphy_channel_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Turn radio OFF */</span>
		<span class="n">u16</span> <span class="n">rfover</span><span class="p">,</span> <span class="n">rfoverval</span><span class="p">;</span>

		<span class="n">rfover</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">);</span>
		<span class="n">rfoverval</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">);</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">rfover</span> <span class="o">=</span> <span class="n">rfover</span><span class="p">;</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">rfoverval</span> <span class="o">=</span> <span class="n">rfoverval</span><span class="p">;</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVER</span><span class="p">,</span> <span class="n">rfover</span> <span class="o">|</span> <span class="mh">0x008C</span><span class="p">);</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_RFOVERVAL</span><span class="p">,</span> <span class="n">rfoverval</span> <span class="o">&amp;</span> <span class="mh">0xFF73</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_gphy_op_switch_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_channel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">b43_gphy_channel_switch</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">new_channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">b43_gphy_op_get_default_chan</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Default to channel 1 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_set_rx_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">autodiv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">antenna</span> <span class="o">==</span> <span class="n">B43_ANTENNA_AUTO0</span> <span class="o">||</span> <span class="n">antenna</span> <span class="o">==</span> <span class="n">B43_ANTENNA_AUTO1</span><span class="p">)</span>
		<span class="n">autodiv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_HF_ANTDIVHELP</span><span class="p">);</span>

	<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_BBANDCFG</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_PHY_BBANDCFG_RXANT</span><span class="p">,</span>
			<span class="p">(</span><span class="n">autodiv</span> <span class="o">?</span> <span class="n">B43_ANTENNA_AUTO1</span> <span class="o">:</span> <span class="n">antenna</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">B43_PHY_BBANDCFG_RXANT_SHIFT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">autodiv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANTDWELL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">antenna</span> <span class="o">==</span> <span class="n">B43_ANTENNA_AUTO1</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_PHY_ANTDWELL_AUTODIV1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">B43_PHY_ANTDWELL_AUTODIV1</span><span class="p">;</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANTDWELL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANTWRSETT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autodiv</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">B43_PHY_ANTWRSETT_ARXDIV</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_PHY_ANTWRSETT_ARXDIV</span><span class="p">;</span>
	<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANTWRSETT</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">autodiv</span><span class="p">)</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANTWRSETT</span><span class="p">,</span> <span class="n">B43_PHY_ANTWRSETT_ARXDIV</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_phy_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ANTWRSETT</span><span class="p">,</span>
			     <span class="n">B43_PHY_ANTWRSETT_ARXDIV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_phy_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_OFDM61</span><span class="p">,</span> <span class="n">B43_PHY_OFDM61_10</span><span class="p">);</span>
		<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_DIVSRCHGAINBACK</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ADIVRELATED</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_phy_maskset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_ADIVRELATED</span><span class="p">,</span> <span class="mh">0xFF00</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">b43_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PHY_OFDM9B</span><span class="p">,</span> <span class="mh">0xDC</span><span class="p">);</span>

	<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_HF_ANTDIVHELP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_gphy_op_interf_mitigation</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">enum</span> <span class="n">b43_interference_mitigation</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">currentmode</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_G</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_INTERFMODE_AUTOWLAN</span>:
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_enable</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">B43_INTERFMODE_MANUALWLAN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">B43_INTERFMODE_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_INTERFMODE_NONE</span>:
	<span class="k">case</span> <span class="n">B43_INTERFMODE_NONWLAN</span>:
	<span class="k">case</span> <span class="n">B43_INTERFMODE_MANUALWLAN</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">currentmode</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">interfmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currentmode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currentmode</span> <span class="o">!=</span> <span class="n">B43_INTERFMODE_NONE</span><span class="p">)</span>
		<span class="n">b43_radio_interference_mitigation_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">currentmode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">B43_INTERFMODE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_hw_rssi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">b43_radio_interference_mitigation_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">interfmode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/EstimatePowerOut</span>
<span class="cm"> * This function converts a TSSI value to dBm in Q5.2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s8</span> <span class="nf">b43_gphy_estimate_power_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">s8</span> <span class="n">tssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">dbm</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tgt_idle_tssi</span> <span class="o">-</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">cur_idle_tssi</span> <span class="o">+</span> <span class="n">tssi</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">);</span>
	<span class="n">dbm</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">[</span><span class="n">tmp</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">dbm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_put_attenuation_into_ranges</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="o">*</span><span class="n">_bbatt</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">_rfatt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rfatt</span> <span class="o">=</span> <span class="o">*</span><span class="n">_rfatt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bbatt</span> <span class="o">=</span> <span class="o">*</span><span class="n">_bbatt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_txpower_lo_control</span> <span class="o">*</span><span class="n">lo</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">g</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="p">;</span>

	<span class="cm">/* Get baseband and radio attenuation values into their permitted ranges.</span>
<span class="cm">	 * Radio attenuation affects power level 4 times as much as baseband. */</span>

	<span class="cm">/* Range constants */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">rf_min</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">rfatt_list</span><span class="p">.</span><span class="n">min_val</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">rf_max</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">rfatt_list</span><span class="p">.</span><span class="n">max_val</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">bb_min</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">bbatt_list</span><span class="p">.</span><span class="n">min_val</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">bb_max</span> <span class="o">=</span> <span class="n">lo</span><span class="o">-&gt;</span><span class="n">bbatt_list</span><span class="p">.</span><span class="n">max_val</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfatt</span> <span class="o">&gt;</span> <span class="n">rf_max</span> <span class="o">&amp;&amp;</span> <span class="n">bbatt</span> <span class="o">&gt;</span> <span class="n">bb_max</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Can not get it into ranges */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfatt</span> <span class="o">&lt;</span> <span class="n">rf_min</span> <span class="o">&amp;&amp;</span> <span class="n">bbatt</span> <span class="o">&lt;</span> <span class="n">bb_min</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Can not get it into ranges */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bbatt</span> <span class="o">&gt;</span> <span class="n">bb_max</span> <span class="o">&amp;&amp;</span> <span class="n">rfatt</span> <span class="o">&gt;</span> <span class="n">rf_max</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Can not get it into ranges */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bbatt</span> <span class="o">&lt;</span> <span class="n">bb_min</span> <span class="o">&amp;&amp;</span> <span class="n">rfatt</span> <span class="o">&lt;</span> <span class="n">rf_min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Can not get it into ranges */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bbatt</span> <span class="o">&gt;</span> <span class="n">bb_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bbatt</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">rfatt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bbatt</span> <span class="o">&lt;</span> <span class="n">bb_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bbatt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">rfatt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfatt</span> <span class="o">&gt;</span> <span class="n">rf_max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfatt</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bbatt</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfatt</span> <span class="o">&lt;</span> <span class="n">rf_min</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rfatt</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">bbatt</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">_rfatt</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">rfatt</span><span class="p">,</span> <span class="n">rf_min</span><span class="p">,</span> <span class="n">rf_max</span><span class="p">);</span>
	<span class="o">*</span><span class="n">_bbatt</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">bbatt</span><span class="p">,</span> <span class="n">bb_min</span><span class="p">,</span> <span class="n">bb_max</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_adjust_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rfatt</span><span class="p">,</span> <span class="n">bbatt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_control</span><span class="p">;</span>

	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Calculate the new attenuation values. */</span>
	<span class="n">bbatt</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">.</span><span class="n">att</span><span class="p">;</span>
	<span class="n">bbatt</span> <span class="o">+=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt_delta</span><span class="p">;</span>
	<span class="n">rfatt</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">.</span><span class="n">att</span><span class="p">;</span>
	<span class="n">rfatt</span> <span class="o">+=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt_delta</span><span class="p">;</span>

	<span class="n">b43_put_attenuation_into_ranges</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbatt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfatt</span><span class="p">);</span>
	<span class="n">tx_control</span> <span class="o">=</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tx_control</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rfatt</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tx_control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tx_control</span> <span class="o">=</span>
				    <span class="n">B43_TXCTL_PA2DB</span> <span class="o">|</span>
				    <span class="n">B43_TXCTL_TXMIX</span><span class="p">;</span>
				<span class="n">rfatt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bbatt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span>
				   <span class="n">boardflags_lo</span> <span class="o">&amp;</span>
				   <span class="n">B43_BFL_PACTRL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bbatt</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">rfatt</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">rfatt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rfatt</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">tx_control</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bbatt</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rfatt</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="n">bbatt</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">rfatt</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="n">bbatt</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Save the control values */</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">=</span> <span class="n">tx_control</span><span class="p">;</span>
	<span class="n">b43_put_attenuation_into_ranges</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bbatt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rfatt</span><span class="p">);</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">.</span><span class="n">att</span> <span class="o">=</span> <span class="n">rfatt</span><span class="p">;</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">.</span><span class="n">att</span> <span class="o">=</span> <span class="n">bbatt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_XMITPOWER</span><span class="p">))</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Adjusting TX power</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Adjust the hardware */</span>
	<span class="n">b43_phy_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_radio_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_set_txpower_g</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">,</span>
			  <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">tx_control</span><span class="p">);</span>
	<span class="n">b43_radio_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_phy_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">b43_txpwr_result</span> <span class="nf">b43_gphy_op_recalc_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">bool</span> <span class="n">ignore_tssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">average_tssi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cck_result</span><span class="p">,</span> <span class="n">ofdm_result</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">estimated_pwr</span><span class="p">,</span> <span class="n">desired_pwr</span><span class="p">,</span> <span class="n">pwr_adjust</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rfatt_delta</span><span class="p">,</span> <span class="n">bbatt_delta</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_pwr</span><span class="p">;</span>

	<span class="cm">/* First get the average TSSI */</span>
	<span class="n">cck_result</span> <span class="o">=</span> <span class="n">b43_phy_shm_tssi_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SH_TSSI_CCK</span><span class="p">);</span>
	<span class="n">ofdm_result</span> <span class="o">=</span> <span class="n">b43_phy_shm_tssi_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SH_TSSI_OFDM_G</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cck_result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ofdm_result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No TSSI information available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignore_tssi</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">no_adjustment_needed</span><span class="p">;</span>
		<span class="n">cck_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ofdm_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cck_result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">average_tssi</span> <span class="o">=</span> <span class="n">ofdm_result</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ofdm_result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">average_tssi</span> <span class="o">=</span> <span class="n">cck_result</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">average_tssi</span> <span class="o">=</span> <span class="p">(</span><span class="n">cck_result</span> <span class="o">+</span> <span class="n">ofdm_result</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Merge the average with the stored value. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">average_tssi</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">))</span>
		<span class="n">average_tssi</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_tssi</span> <span class="o">+</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">average_tssi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">average_tssi</span> <span class="o">=</span> <span class="n">average_tssi</span><span class="p">;</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">average_tssi</span> <span class="o">&gt;=</span> <span class="n">B43_TSSI_MAX</span><span class="p">);</span>

	<span class="cm">/* Estimate the TX power emission based on the TSSI */</span>
	<span class="n">estimated_pwr</span> <span class="o">=</span> <span class="n">b43_gphy_estimate_power_out</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">average_tssi</span><span class="p">);</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_G</span><span class="p">);</span>
	<span class="n">max_pwr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">maxpwr_bg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_PACTRL</span><span class="p">)</span>
		<span class="n">max_pwr</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* minus 0.75 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">max_pwr</span> <span class="o">&gt;=</span> <span class="n">INT_TO_Q52</span><span class="p">(</span><span class="mi">30</span><span class="cm">/*dBm*/</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">b43warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
			<span class="s">&quot;Invalid max-TX-power value in SPROM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">max_pwr</span> <span class="o">=</span> <span class="n">INT_TO_Q52</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span> <span class="cm">/* fake it */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">maxpwr_bg</span> <span class="o">=</span> <span class="n">max_pwr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get desired power (in Q5.2) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">desired_txpower</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">desired_pwr</span> <span class="o">=</span> <span class="n">INT_TO_Q52</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">desired_pwr</span> <span class="o">=</span> <span class="n">INT_TO_Q52</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">desired_txpower</span><span class="p">);</span>
	<span class="cm">/* And limit it. max_pwr already is Q5.2 */</span>
	<span class="n">desired_pwr</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">desired_pwr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_pwr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_XMITPOWER</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
		       <span class="s">&quot;[TX power]  current = &quot;</span> <span class="n">Q52_FMT</span>
		       <span class="s">&quot; dBm,  desired = &quot;</span> <span class="n">Q52_FMT</span>
		       <span class="s">&quot; dBm,  max = &quot;</span> <span class="n">Q52_FMT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">Q52_ARG</span><span class="p">(</span><span class="n">estimated_pwr</span><span class="p">),</span>
		       <span class="n">Q52_ARG</span><span class="p">(</span><span class="n">desired_pwr</span><span class="p">),</span>
		       <span class="n">Q52_ARG</span><span class="p">(</span><span class="n">max_pwr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate the adjustment delta. */</span>
	<span class="n">pwr_adjust</span> <span class="o">=</span> <span class="n">desired_pwr</span> <span class="o">-</span> <span class="n">estimated_pwr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pwr_adjust</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_adjustment_needed</span><span class="p">;</span>

	<span class="cm">/* RF attenuation delta. */</span>
	<span class="n">rfatt_delta</span> <span class="o">=</span> <span class="p">((</span><span class="n">pwr_adjust</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* Lower attenuation =&gt; Bigger power output. Negate it. */</span>
	<span class="n">rfatt_delta</span> <span class="o">=</span> <span class="o">-</span><span class="n">rfatt_delta</span><span class="p">;</span>

	<span class="cm">/* Baseband attenuation delta. */</span>
	<span class="n">bbatt_delta</span> <span class="o">=</span> <span class="n">pwr_adjust</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Lower attenuation =&gt; Bigger power output. Negate it. */</span>
	<span class="n">bbatt_delta</span> <span class="o">=</span> <span class="o">-</span><span class="n">bbatt_delta</span><span class="p">;</span>
	<span class="cm">/* RF att affects power level 4 times as much as</span>
<span class="cm">	 * Baseband attennuation. Subtract it. */</span>
	<span class="n">bbatt_delta</span> <span class="o">-=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">rfatt_delta</span><span class="p">;</span>

<span class="cp">#if B43_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_XMITPOWER</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">dbm</span> <span class="o">=</span> <span class="n">pwr_adjust</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="n">pwr_adjust</span> <span class="o">:</span> <span class="n">pwr_adjust</span><span class="p">;</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
		       <span class="s">&quot;[TX power deltas]  %s&quot;</span> <span class="n">Q52_FMT</span> <span class="s">&quot; dBm   =&gt;   &quot;</span>
		       <span class="s">&quot;bbatt-delta = %d,  rfatt-delta = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">pwr_adjust</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;-&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="n">Q52_ARG</span><span class="p">(</span><span class="n">dbm</span><span class="p">),</span>
		       <span class="n">bbatt_delta</span><span class="p">,</span> <span class="n">rfatt_delta</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

	<span class="cm">/* So do we finally need to adjust something in hardware? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rfatt_delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bbatt_delta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">no_adjustment_needed</span><span class="p">;</span>

	<span class="cm">/* Save the deltas for later when we adjust the power. */</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">bbatt_delta</span> <span class="o">=</span> <span class="n">bbatt_delta</span><span class="p">;</span>
	<span class="n">gphy</span><span class="o">-&gt;</span><span class="n">rfatt_delta</span> <span class="o">=</span> <span class="n">rfatt_delta</span><span class="p">;</span>

	<span class="cm">/* We need to adjust the TX power on the device. */</span>
	<span class="k">return</span> <span class="n">B43_TXPWR_RES_NEED_ADJUST</span><span class="p">;</span>

<span class="nl">no_adjustment_needed:</span>
	<span class="k">return</span> <span class="n">B43_TXPWR_RES_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_pwork_15sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">gphy</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">g</span><span class="p">;</span>

	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>TODO: update<em>aci</em>moving_average</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">&amp;&amp;</span> <span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">&amp;&amp;</span> <span class="mi">1</span> <span class="cm">/*TODO: not scanning? */</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="cm">/*TODO: bunch of conditions */</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">interf_mitigation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B43_INTERFMODE_MANUALWLAN</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="cm">/*TODO*/</span><span class="p">)</span> <span class="p">{</span>
			   <span class="k">if</span> <span class="p">(</span><span class="cm">/*(aci_average &gt; 1000) &amp;&amp;*/</span> <span class="o">!</span><span class="n">b43_gphy_aci_scan</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">interf_mitigation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_INTERFMODE_NONE</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">gphy</span><span class="o">-&gt;</span><span class="n">interfmode</span> <span class="o">==</span> <span class="n">B43_INTERFMODE_NONWLAN</span> <span class="o">&amp;&amp;</span>
		   <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>TODO: implement rev1 workaround</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="n">b43_lo_g_maintanance_work</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gphy_op_pwork_60sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_RSSI</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_calc_nrssi_slope</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">old_chan</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

		<span class="cm">/* VCO Calibration */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_chan</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">b43_switch_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_switch_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">b43_switch_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">old_chan</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_phy_operations</span> <span class="n">b43_phyops_g</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">allocate</span>		<span class="o">=</span> <span class="n">b43_gphy_op_allocate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span>			<span class="o">=</span> <span class="n">b43_gphy_op_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_structs</span>	<span class="o">=</span> <span class="n">b43_gphy_op_prepare_structs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_hardware</span>	<span class="o">=</span> <span class="n">b43_gphy_op_prepare_hardware</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">b43_gphy_op_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">exit</span>			<span class="o">=</span> <span class="n">b43_gphy_op_exit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_read</span>		<span class="o">=</span> <span class="n">b43_gphy_op_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">phy_write</span>		<span class="o">=</span> <span class="n">b43_gphy_op_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">radio_read</span>		<span class="o">=</span> <span class="n">b43_gphy_op_radio_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">radio_write</span>		<span class="o">=</span> <span class="n">b43_gphy_op_radio_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">supports_hwpctl</span>	<span class="o">=</span> <span class="n">b43_gphy_op_supports_hwpctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">software_rfkill</span>	<span class="o">=</span> <span class="n">b43_gphy_op_software_rfkill</span><span class="p">,</span>
	<span class="p">.</span><span class="n">switch_analog</span>		<span class="o">=</span> <span class="n">b43_phyop_switch_analog_generic</span><span class="p">,</span>
	<span class="p">.</span><span class="n">switch_channel</span>		<span class="o">=</span> <span class="n">b43_gphy_op_switch_channel</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_default_chan</span>	<span class="o">=</span> <span class="n">b43_gphy_op_get_default_chan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rx_antenna</span>		<span class="o">=</span> <span class="n">b43_gphy_op_set_rx_antenna</span><span class="p">,</span>
	<span class="p">.</span><span class="n">interf_mitigation</span>	<span class="o">=</span> <span class="n">b43_gphy_op_interf_mitigation</span><span class="p">,</span>
	<span class="p">.</span><span class="n">recalc_txpower</span>		<span class="o">=</span> <span class="n">b43_gphy_op_recalc_txpower</span><span class="p">,</span>
	<span class="p">.</span><span class="n">adjust_txpower</span>		<span class="o">=</span> <span class="n">b43_gphy_op_adjust_txpower</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwork_15sec</span>		<span class="o">=</span> <span class="n">b43_gphy_op_pwork_15sec</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pwork_60sec</span>		<span class="o">=</span> <span class="n">b43_gphy_op_pwork_60sec</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
