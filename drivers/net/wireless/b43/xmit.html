<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › b43 › xmit.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>xmit.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#ifndef B43_XMIT_H_</span>
<span class="cp">#define B43_XMIT_H_</span>

<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>


<span class="cp">#define _b43_declare_plcp_hdr(size) \</span>
<span class="cp">	struct b43_plcp_hdr##size {		\</span>
<span class="cp">		union {				\</span>
<span class="cp">			__le32 data;		\</span>
<span class="cp">			__u8 raw[size];		\</span>
<span class="cp">		} __packed;	\</span>
<span class="cp">	} __packed</span>

<span class="cm">/* struct b43_plcp_hdr4 */</span>
<span class="n">_b43_declare_plcp_hdr</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
<span class="cm">/* struct b43_plcp_hdr6 */</span>
<span class="n">_b43_declare_plcp_hdr</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

<span class="cp">#undef _b43_declare_plcp_hdr</span>

<span class="cm">/* TX header for v4 firmware */</span>
<span class="k">struct</span> <span class="n">b43_txhdr</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">mac_ctl</span><span class="p">;</span>			<span class="cm">/* MAC TX control */</span>
	<span class="n">__le16</span> <span class="n">mac_frame_ctl</span><span class="p">;</span>		<span class="cm">/* Copy of the FrameControl field */</span>
	<span class="n">__le16</span> <span class="n">tx_fes_time_norm</span><span class="p">;</span>	<span class="cm">/* TX FES Time Normal */</span>
	<span class="n">__le16</span> <span class="n">phy_ctl</span><span class="p">;</span>			<span class="cm">/* PHY TX control */</span>
	<span class="n">__le16</span> <span class="n">phy_ctl1</span><span class="p">;</span>		<span class="cm">/* PHY TX control word 1 */</span>
	<span class="n">__le16</span> <span class="n">phy_ctl1_fb</span><span class="p">;</span>		<span class="cm">/* PHY TX control word 1 for fallback rates */</span>
	<span class="n">__le16</span> <span class="n">phy_ctl1_rts</span><span class="p">;</span>		<span class="cm">/* PHY TX control word 1 RTS */</span>
	<span class="n">__le16</span> <span class="n">phy_ctl1_rts_fb</span><span class="p">;</span>		<span class="cm">/* PHY TX control word 1 RTS for fallback rates */</span>
	<span class="n">__u8</span> <span class="n">phy_rate</span><span class="p">;</span>			<span class="cm">/* PHY rate */</span>
	<span class="n">__u8</span> <span class="n">phy_rate_rts</span><span class="p">;</span>		<span class="cm">/* PHY rate for RTS/CTS */</span>
	<span class="n">__u8</span> <span class="n">extra_ft</span><span class="p">;</span>			<span class="cm">/* Extra Frame Types */</span>
	<span class="n">__u8</span> <span class="n">chan_radio_code</span><span class="p">;</span>		<span class="cm">/* Channel Radio Code */</span>
	<span class="n">__u8</span> <span class="n">iv</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>			<span class="cm">/* Encryption IV */</span>
	<span class="n">__u8</span> <span class="n">tx_receiver</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>		<span class="cm">/* TX Frame Receiver address */</span>
	<span class="n">__le16</span> <span class="n">tx_fes_time_fb</span><span class="p">;</span>		<span class="cm">/* TX FES Time Fallback */</span>
	<span class="k">struct</span> <span class="n">b43_plcp_hdr6</span> <span class="n">rts_plcp_fb</span><span class="p">;</span> <span class="cm">/* RTS fallback PLCP header */</span>
	<span class="n">__le16</span> <span class="n">rts_dur_fb</span><span class="p">;</span>		<span class="cm">/* RTS fallback duration */</span>
	<span class="k">struct</span> <span class="n">b43_plcp_hdr6</span> <span class="n">plcp_fb</span><span class="p">;</span>	<span class="cm">/* Fallback PLCP header */</span>
	<span class="n">__le16</span> <span class="n">dur_fb</span><span class="p">;</span>			<span class="cm">/* Fallback duration */</span>
	<span class="n">__le16</span> <span class="n">mimo_modelen</span><span class="p">;</span>		<span class="cm">/* MIMO mode length */</span>
	<span class="n">__le16</span> <span class="n">mimo_ratelen_fb</span><span class="p">;</span>		<span class="cm">/* MIMO fallback rate length */</span>
	<span class="n">__le32</span> <span class="n">timeout</span><span class="p">;</span>			<span class="cm">/* Timeout */</span>

	<span class="k">union</span> <span class="p">{</span>
		<span class="cm">/* Tested with 598.314, 644.1001 and 666.2 */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le16</span> <span class="n">mimo_antenna</span><span class="p">;</span>            <span class="cm">/* MIMO antenna select */</span>
			<span class="n">__le16</span> <span class="n">preload_size</span><span class="p">;</span>            <span class="cm">/* Preload size */</span>
			<span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">__le16</span> <span class="n">cookie</span><span class="p">;</span>                  <span class="cm">/* TX frame cookie */</span>
			<span class="n">__le16</span> <span class="n">tx_status</span><span class="p">;</span>               <span class="cm">/* TX status */</span>
			<span class="n">__le16</span> <span class="n">max_n_mpdus</span><span class="p">;</span>
			<span class="n">__le16</span> <span class="n">max_a_bytes_mrt</span><span class="p">;</span>
			<span class="n">__le16</span> <span class="n">max_a_bytes_fbr</span><span class="p">;</span>
			<span class="n">__le16</span> <span class="n">min_m_bytes</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">b43_plcp_hdr6</span> <span class="n">rts_plcp</span><span class="p">;</span>  <span class="cm">/* RTS PLCP header */</span>
			<span class="n">__u8</span> <span class="n">rts_frame</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>             <span class="cm">/* The RTS frame (if used) */</span>
			<span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">b43_plcp_hdr6</span> <span class="n">plcp</span><span class="p">;</span>      <span class="cm">/* Main PLCP header */</span>
		<span class="p">}</span> <span class="n">format_598</span> <span class="n">__packed</span><span class="p">;</span>

		<span class="cm">/* Tested with 410.2160, 478.104 and 508.* */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le16</span> <span class="n">mimo_antenna</span><span class="p">;</span>		<span class="cm">/* MIMO antenna select */</span>
			<span class="n">__le16</span> <span class="n">preload_size</span><span class="p">;</span>		<span class="cm">/* Preload size */</span>
			<span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">__le16</span> <span class="n">cookie</span><span class="p">;</span>			<span class="cm">/* TX frame cookie */</span>
			<span class="n">__le16</span> <span class="n">tx_status</span><span class="p">;</span>		<span class="cm">/* TX status */</span>
			<span class="k">struct</span> <span class="n">b43_plcp_hdr6</span> <span class="n">rts_plcp</span><span class="p">;</span>	<span class="cm">/* RTS PLCP header */</span>
			<span class="n">__u8</span> <span class="n">rts_frame</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>		<span class="cm">/* The RTS frame (if used) */</span>
			<span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">b43_plcp_hdr6</span> <span class="n">plcp</span><span class="p">;</span>	<span class="cm">/* Main PLCP header */</span>
		<span class="p">}</span> <span class="n">format_410</span> <span class="n">__packed</span><span class="p">;</span>

		<span class="cm">/* Tested with 351.126 */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">__le16</span> <span class="n">cookie</span><span class="p">;</span>			<span class="cm">/* TX frame cookie */</span>
			<span class="n">__le16</span> <span class="n">tx_status</span><span class="p">;</span>		<span class="cm">/* TX status */</span>
			<span class="k">struct</span> <span class="n">b43_plcp_hdr6</span> <span class="n">rts_plcp</span><span class="p">;</span>	<span class="cm">/* RTS PLCP header */</span>
			<span class="n">__u8</span> <span class="n">rts_frame</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>		<span class="cm">/* The RTS frame (if used) */</span>
			<span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
			<span class="k">struct</span> <span class="n">b43_plcp_hdr6</span> <span class="n">plcp</span><span class="p">;</span>	<span class="cm">/* Main PLCP header */</span>
		<span class="p">}</span> <span class="n">format_351</span> <span class="n">__packed</span><span class="p">;</span>

	<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">b43_tx_legacy_rate_phy_ctl_entry</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">bitrate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">coding_rate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">modulation</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* MAC TX control */</span>
<span class="cp">#define B43_TXH_MAC_USEFBR		0x10000000 </span><span class="cm">/* Use fallback rate for this AMPDU */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_KEYIDX		0x0FF00000 </span><span class="cm">/* Security key index */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_KEYIDX_SHIFT	20</span>
<span class="cp">#define B43_TXH_MAC_KEYALG		0x00070000 </span><span class="cm">/* Security key algorithm */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_KEYALG_SHIFT	16</span>
<span class="cp">#define B43_TXH_MAC_AMIC		0x00008000 </span><span class="cm">/* AMIC */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_RIFS		0x00004000 </span><span class="cm">/* Use RIFS */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_LIFETIME		0x00002000 </span><span class="cm">/* Lifetime */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_FRAMEBURST		0x00001000 </span><span class="cm">/* Frameburst */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_SENDCTS		0x00000800 </span><span class="cm">/* Send CTS-to-self */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_AMPDU		0x00000600 </span><span class="cm">/* AMPDU status */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_MAC_AMPDU_MPDU		0x00000000 </span><span class="cm">/* Regular MPDU, not an AMPDU */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_MAC_AMPDU_FIRST	0x00000200 </span><span class="cm">/* First MPDU or AMPDU */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_MAC_AMPDU_INTER	0x00000400 </span><span class="cm">/* Intermediate MPDU or AMPDU */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_MAC_AMPDU_LAST		0x00000600 </span><span class="cm">/* Last (or only) MPDU of AMPDU */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_40MHZ		0x00000100 </span><span class="cm">/* Use 40 MHz bandwidth */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_5GHZ		0x00000080 </span><span class="cm">/* 5GHz band */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_DFCS		0x00000040 </span><span class="cm">/* DFCS */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_IGNPMQ		0x00000020 </span><span class="cm">/* Ignore PMQ */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_HWSEQ		0x00000010 </span><span class="cm">/* Use Hardware Sequence Number */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_STMSDU		0x00000008 </span><span class="cm">/* Start MSDU */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_SENDRTS		0x00000004 </span><span class="cm">/* Send RTS */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_LONGFRAME		0x00000002 </span><span class="cm">/* Long frame */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_MAC_ACK			0x00000001 </span><span class="cm">/* Immediate ACK */</span><span class="cp"></span>

<span class="cm">/* Extra Frame Types */</span>
<span class="cp">#define B43_TXH_EFT_FB			0x03 </span><span class="cm">/* Data frame fallback encoding */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_FB_CCK		0x00 </span><span class="cm">/* CCK */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_FB_OFDM		0x01 </span><span class="cm">/* OFDM */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_FB_EWC		0x02 </span><span class="cm">/* EWC */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_FB_N		0x03 </span><span class="cm">/* N */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_EFT_RTS			0x0C </span><span class="cm">/* RTS/CTS encoding */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_RTS_CCK		0x00 </span><span class="cm">/* CCK */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_RTS_OFDM		0x04 </span><span class="cm">/* OFDM */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_RTS_EWC		0x08 </span><span class="cm">/* EWC */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_RTS_N		0x0C </span><span class="cm">/* N */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_EFT_RTSFB		0x30 </span><span class="cm">/* RTS/CTS fallback encoding */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_RTSFB_CCK		0x00 </span><span class="cm">/* CCK */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_RTSFB_OFDM		0x10 </span><span class="cm">/* OFDM */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_RTSFB_EWC		0x20 </span><span class="cm">/* EWC */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_EFT_RTSFB_N		0x30 </span><span class="cm">/* N */</span><span class="cp"></span>

<span class="cm">/* PHY TX control word */</span>
<span class="cp">#define B43_TXH_PHY_ENC			0x0003 </span><span class="cm">/* Data frame encoding */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ENC_CCK		0x0000 </span><span class="cm">/* CCK */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ENC_OFDM		0x0001 </span><span class="cm">/* OFDM */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ENC_EWC		0x0002 </span><span class="cm">/* EWC */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ENC_N		0x0003 </span><span class="cm">/* N */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_PHY_SHORTPRMBL		0x0010 </span><span class="cm">/* Use short preamble */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_PHY_ANT			0x03C0 </span><span class="cm">/* Antenna selection */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ANT0		0x0000 </span><span class="cm">/* Use antenna 0 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ANT1		0x0040 </span><span class="cm">/* Use antenna 1 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ANT01AUTO		0x00C0 </span><span class="cm">/* Use antenna 0/1 auto */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ANT2		0x0100 </span><span class="cm">/* Use antenna 2 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY_ANT3		0x0200 </span><span class="cm">/* Use antenna 3 */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_PHY_TXPWR		0xFC00 </span><span class="cm">/* TX power */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_PHY_TXPWR_SHIFT		10</span>

<span class="cm">/* PHY TX control word 1 */</span>
<span class="cp">#define B43_TXH_PHY1_BW			0x0007 </span><span class="cm">/* Bandwidth */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_BW_10		0x0000 </span><span class="cm">/* 10 MHz */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_BW_10U		0x0001 </span><span class="cm">/* 10 MHz upper */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_BW_20		0x0002 </span><span class="cm">/* 20 MHz */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_BW_20U		0x0003 </span><span class="cm">/* 20 MHz upper */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_BW_40		0x0004 </span><span class="cm">/* 40 MHz */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_BW_40DUP		0x0005 </span><span class="cm">/* 50 MHz duplicate */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_PHY1_MODE		0x0038 </span><span class="cm">/* Mode */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODE_SISO		0x0000 </span><span class="cm">/* SISO */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODE_CDD		0x0008 </span><span class="cm">/* CDD */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODE_STBC		0x0010 </span><span class="cm">/* STBC */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODE_SDM		0x0018 </span><span class="cm">/* SDM */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_PHY1_CRATE		0x0700 </span><span class="cm">/* Coding rate */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_CRATE_1_2		0x0000 </span><span class="cm">/* 1/2 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_CRATE_2_3		0x0100 </span><span class="cm">/* 2/3 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_CRATE_3_4		0x0200 </span><span class="cm">/* 3/4 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_CRATE_4_5		0x0300 </span><span class="cm">/* 4/5 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_CRATE_5_6		0x0400 </span><span class="cm">/* 5/6 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_CRATE_7_8		0x0600 </span><span class="cm">/* 7/8 */</span><span class="cp"></span>
<span class="cp">#define B43_TXH_PHY1_MODUL		0x3800 </span><span class="cm">/* Modulation scheme */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODUL_BPSK	0x0000 </span><span class="cm">/* BPSK */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODUL_QPSK	0x0800 </span><span class="cm">/* QPSK */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODUL_QAM16	0x1000 </span><span class="cm">/* QAM16 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODUL_QAM64	0x1800 </span><span class="cm">/* QAM64 */</span><span class="cp"></span>
<span class="cp">#define  B43_TXH_PHY1_MODUL_QAM256	0x2000 </span><span class="cm">/* QAM256 */</span><span class="cp"></span>


<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">size_t</span> <span class="nf">b43_txhdr_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_FW_HDR_598</span>:
		<span class="k">return</span> <span class="mi">112</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_plcp_hdr6</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">B43_FW_HDR_410</span>:
		<span class="k">return</span> <span class="mi">104</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_plcp_hdr6</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">B43_FW_HDR_351</span>:
		<span class="k">return</span> <span class="mi">100</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_plcp_hdr6</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="n">b43_generate_txhdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="o">*</span> <span class="n">txhdr</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_frag</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txctl</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cookie</span><span class="p">);</span>

<span class="cm">/* Transmit Status */</span>
<span class="k">struct</span> <span class="n">b43_txstatus</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">cookie</span><span class="p">;</span>		<span class="cm">/* The cookie from the txhdr */</span>
	<span class="n">u16</span> <span class="n">seq</span><span class="p">;</span>		<span class="cm">/* Sequence number */</span>
	<span class="n">u8</span> <span class="n">phy_stat</span><span class="p">;</span>		<span class="cm">/* PHY TX status */</span>
	<span class="n">u8</span> <span class="n">frame_count</span><span class="p">;</span>		<span class="cm">/* Frame transmit count */</span>
	<span class="n">u8</span> <span class="n">rts_count</span><span class="p">;</span>		<span class="cm">/* RTS transmit count */</span>
	<span class="n">u8</span> <span class="n">supp_reason</span><span class="p">;</span>		<span class="cm">/* Suppression reason */</span>
	<span class="cm">/* flags */</span>
	<span class="n">u8</span> <span class="n">pm_indicated</span><span class="p">;</span>	<span class="cm">/* PM mode indicated to AP */</span>
	<span class="n">u8</span> <span class="n">intermediate</span><span class="p">;</span>	<span class="cm">/* Intermediate status notification (not final) */</span>
	<span class="n">u8</span> <span class="n">for_ampdu</span><span class="p">;</span>		<span class="cm">/* Status is for an AMPDU (afterburner) */</span>
	<span class="n">u8</span> <span class="n">acked</span><span class="p">;</span>		<span class="cm">/* Wireless ACK received */</span>
<span class="p">};</span>

<span class="cm">/* txstatus supp_reason values */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">B43_TXST_SUPP_NONE</span><span class="p">,</span>	<span class="cm">/* Not suppressed */</span>
	<span class="n">B43_TXST_SUPP_PMQ</span><span class="p">,</span>	<span class="cm">/* Suppressed due to PMQ entry */</span>
	<span class="n">B43_TXST_SUPP_FLUSH</span><span class="p">,</span>	<span class="cm">/* Suppressed due to flush request */</span>
	<span class="n">B43_TXST_SUPP_PREV</span><span class="p">,</span>	<span class="cm">/* Previous fragment failed */</span>
	<span class="n">B43_TXST_SUPP_CHAN</span><span class="p">,</span>	<span class="cm">/* Channel mismatch */</span>
	<span class="n">B43_TXST_SUPP_LIFE</span><span class="p">,</span>	<span class="cm">/* Lifetime expired */</span>
	<span class="n">B43_TXST_SUPP_UNDER</span><span class="p">,</span>	<span class="cm">/* Buffer underflow */</span>
	<span class="n">B43_TXST_SUPP_ABNACK</span><span class="p">,</span>	<span class="cm">/* Afterburner NACK */</span>
<span class="p">};</span>

<span class="cm">/* Receive header for v4 firmware. */</span>
<span class="k">struct</span> <span class="n">b43_rxhdr_fw4</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">frame_len</span><span class="p">;</span>	<span class="cm">/* Frame length */</span>
	 <span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="n">phy_status0</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 0 */</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="cm">/* RSSI for A/B/G-PHYs */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__u8</span> <span class="n">jssi</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 1: JSSI */</span>
			<span class="n">__u8</span> <span class="n">sig_qual</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 1: Signal Quality */</span>
		<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

		<span class="cm">/* RSSI for N-PHYs */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__s8</span> <span class="n">power0</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 1: Power 0 */</span>
			<span class="n">__s8</span> <span class="n">power1</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 1: Power 1 */</span>
		<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="cm">/* HT-PHY */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">__s8</span> <span class="n">phy_ht_power0</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

		<span class="cm">/* RSSI for N-PHYs */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__s8</span> <span class="n">power2</span><span class="p">;</span>
			<span class="n">PAD_BYTES</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

		<span class="n">__le16</span> <span class="n">phy_status2</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 2 */</span>
	<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="cm">/* HT-PHY */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__s8</span> <span class="n">phy_ht_power1</span><span class="p">;</span>
			<span class="n">__s8</span> <span class="n">phy_ht_power2</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

		<span class="n">__le16</span> <span class="n">phy_status3</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 3 */</span>
	<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="cm">/* Tested with 598.314, 644.1001 and 666.2 */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le16</span> <span class="n">phy_status4</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 4 */</span>
			<span class="n">__le16</span> <span class="n">phy_status5</span><span class="p">;</span>	<span class="cm">/* PHY RX Status 5 */</span>
			<span class="n">__le32</span> <span class="n">mac_status</span><span class="p">;</span>	<span class="cm">/* MAC RX status */</span>
			<span class="n">__le16</span> <span class="n">mac_time</span><span class="p">;</span>
			<span class="n">__le16</span> <span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">format_598</span> <span class="n">__packed</span><span class="p">;</span>

		<span class="cm">/* Tested with 351.126, 410.2160, 478.104 and 508.* */</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="n">__le32</span> <span class="n">mac_status</span><span class="p">;</span>	<span class="cm">/* MAC RX status */</span>
			<span class="n">__le16</span> <span class="n">mac_time</span><span class="p">;</span>
			<span class="n">__le16</span> <span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">format_351</span> <span class="n">__packed</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* PHY RX Status 0 */</span>
<span class="cp">#define B43_RX_PHYST0_GAINCTL		0x4000 </span><span class="cm">/* Gain Control */</span><span class="cp"></span>
<span class="cp">#define B43_RX_PHYST0_PLCPHCF		0x0200</span>
<span class="cp">#define B43_RX_PHYST0_PLCPFV		0x0100</span>
<span class="cp">#define B43_RX_PHYST0_SHORTPRMBL	0x0080 </span><span class="cm">/* Received with Short Preamble */</span><span class="cp"></span>
<span class="cp">#define B43_RX_PHYST0_LCRS		0x0040</span>
<span class="cp">#define B43_RX_PHYST0_ANT		0x0020 </span><span class="cm">/* Antenna */</span><span class="cp"></span>
<span class="cp">#define B43_RX_PHYST0_UNSRATE		0x0010</span>
<span class="cp">#define B43_RX_PHYST0_CLIP		0x000C</span>
<span class="cp">#define B43_RX_PHYST0_CLIP_SHIFT	2</span>
<span class="cp">#define B43_RX_PHYST0_FTYPE		0x0003 </span><span class="cm">/* Frame type */</span><span class="cp"></span>
<span class="cp">#define  B43_RX_PHYST0_CCK		0x0000 </span><span class="cm">/* Frame type: CCK */</span><span class="cp"></span>
<span class="cp">#define  B43_RX_PHYST0_OFDM		0x0001 </span><span class="cm">/* Frame type: OFDM */</span><span class="cp"></span>
<span class="cp">#define  B43_RX_PHYST0_PRE_N		0x0002 </span><span class="cm">/* Pre-standard N-PHY frame */</span><span class="cp"></span>
<span class="cp">#define  B43_RX_PHYST0_STD_N		0x0003 </span><span class="cm">/* Standard N-PHY frame */</span><span class="cp"></span>

<span class="cm">/* PHY RX Status 2 */</span>
<span class="cp">#define B43_RX_PHYST2_LNAG		0xC000 </span><span class="cm">/* LNA Gain */</span><span class="cp"></span>
<span class="cp">#define B43_RX_PHYST2_LNAG_SHIFT	14</span>
<span class="cp">#define B43_RX_PHYST2_PNAG		0x3C00 </span><span class="cm">/* PNA Gain */</span><span class="cp"></span>
<span class="cp">#define B43_RX_PHYST2_PNAG_SHIFT	10</span>
<span class="cp">#define B43_RX_PHYST2_FOFF		0x03FF </span><span class="cm">/* F offset */</span><span class="cp"></span>

<span class="cm">/* PHY RX Status 3 */</span>
<span class="cp">#define B43_RX_PHYST3_DIGG		0x1800 </span><span class="cm">/* DIG Gain */</span><span class="cp"></span>
<span class="cp">#define B43_RX_PHYST3_DIGG_SHIFT	11</span>
<span class="cp">#define B43_RX_PHYST3_TRSTATE		0x0400 </span><span class="cm">/* TR state */</span><span class="cp"></span>

<span class="cm">/* MAC RX Status */</span>
<span class="cp">#define B43_RX_MAC_RXST_VALID		0x01000000 </span><span class="cm">/* PHY RXST valid */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_TKIP_MICERR		0x00100000 </span><span class="cm">/* TKIP MIC error */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_TKIP_MICATT		0x00080000 </span><span class="cm">/* TKIP MIC attempted */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_AGGTYPE		0x00060000 </span><span class="cm">/* Aggregation type */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_AGGTYPE_SHIFT	17</span>
<span class="cp">#define B43_RX_MAC_AMSDU		0x00010000 </span><span class="cm">/* A-MSDU mask */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_BEACONSENT		0x00008000 </span><span class="cm">/* Beacon sent flag */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_KEYIDX		0x000007E0 </span><span class="cm">/* Key index */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_KEYIDX_SHIFT		5</span>
<span class="cp">#define B43_RX_MAC_DECERR		0x00000010 </span><span class="cm">/* Decrypt error */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_DEC			0x00000008 </span><span class="cm">/* Decryption attempted */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_PADDING		0x00000004 </span><span class="cm">/* Pad bytes present */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_RESP			0x00000002 </span><span class="cm">/* Response frame transmitted */</span><span class="cp"></span>
<span class="cp">#define B43_RX_MAC_FCSERR		0x00000001 </span><span class="cm">/* FCS error */</span><span class="cp"></span>

<span class="cm">/* RX channel */</span>
<span class="cp">#define B43_RX_CHAN_40MHZ		0x1000 </span><span class="cm">/* 40 Mhz channel width */</span><span class="cp"></span>
<span class="cp">#define B43_RX_CHAN_5GHZ		0x0800 </span><span class="cm">/* 5 Ghz band */</span><span class="cp"></span>
<span class="cp">#define B43_RX_CHAN_ID			0x07F8 </span><span class="cm">/* Channel ID */</span><span class="cp"></span>
<span class="cp">#define B43_RX_CHAN_ID_SHIFT		3</span>
<span class="cp">#define B43_RX_CHAN_PHYTYPE		0x0007 </span><span class="cm">/* PHY type */</span><span class="cp"></span>


<span class="n">u8</span> <span class="n">b43_plcp_get_ratecode_cck</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">bitrate</span><span class="p">);</span>
<span class="n">u8</span> <span class="n">b43_plcp_get_ratecode_ofdm</span><span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="n">bitrate</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">b43_generate_plcp_hdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_plcp_hdr4</span> <span class="o">*</span><span class="n">plcp</span><span class="p">,</span>
			   <span class="k">const</span> <span class="n">u16</span> <span class="n">octets</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bitrate</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">b43_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_rxhdr</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">b43_handle_txstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_txstatus</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>
<span class="n">bool</span> <span class="n">b43_fill_txstatus_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">report</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_txstatus</span> <span class="o">*</span><span class="n">status</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">b43_tx_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">b43_tx_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>


<span class="cm">/* Helper functions for converting the key-table index from &quot;firmware-format&quot;</span>
<span class="cm"> * to &quot;raw-format&quot; and back. The firmware API changed for this at some revision.</span>
<span class="cm"> * We need to account for that here. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">b43_new_kidx_api</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: Not sure the change was at rev 351 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">351</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">b43_kidx_to_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">raw_kidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">firmware_kidx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">firmware_kidx</span> <span class="o">=</span> <span class="n">raw_kidx</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">raw_kidx</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>	<span class="cm">/* Is per STA key? */</span>
			<span class="n">firmware_kidx</span> <span class="o">=</span> <span class="n">raw_kidx</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">firmware_kidx</span> <span class="o">=</span> <span class="n">raw_kidx</span><span class="p">;</span>	<span class="cm">/* TX default key */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">firmware_kidx</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">b43_kidx_to_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">firmware_kidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">raw_kidx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">raw_kidx</span> <span class="o">=</span> <span class="n">firmware_kidx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">raw_kidx</span> <span class="o">=</span> <span class="n">firmware_kidx</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>	<span class="cm">/* RX default keys or per STA keys */</span>
	<span class="k">return</span> <span class="n">raw_kidx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* struct b43_private_tx_info - TX info private to b43.</span>
<span class="cm"> * The structure is placed in (struct ieee80211_tx_info *)-&gt;rate_driver_data</span>
<span class="cm"> *</span>
<span class="cm"> * @bouncebuffer: DMA Bouncebuffer (if used)</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">b43_private_tx_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">bouncebuffer</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">b43_private_tx_info</span> <span class="o">*</span>
<span class="nf">b43_get_priv_tx_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_private_tx_info</span><span class="p">)</span> <span class="o">&gt;</span>
		     <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">));</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">b43_private_tx_info</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* B43_XMIT_H_ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
