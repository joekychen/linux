<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › b43 › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">  Broadcom B43 wireless driver</span>

<span class="cm">  Copyright (c) 2005 Martin Langer &lt;martin-langer@gmx.de&gt;</span>
<span class="cm">  Copyright (c) 2005 Stefano Brivio &lt;stefano.brivio@polimi.it&gt;</span>
<span class="cm">  Copyright (c) 2005-2009 Michael Buesch &lt;m@bues.ch&gt;</span>
<span class="cm">  Copyright (c) 2005 Danny van Dyk &lt;kugelfang@gentoo.org&gt;</span>
<span class="cm">  Copyright (c) 2005 Andreas Jaggi &lt;andreas.jaggi@waterwave.ch&gt;</span>
<span class="cm">  Copyright (c) 2010-2011 Rafał Miłecki &lt;zajec5@gmail.com&gt;</span>

<span class="cm">  SDIO support</span>
<span class="cm">  Copyright (c) 2009 Albert Herranz &lt;albert_herranz@yahoo.es&gt;</span>

<span class="cm">  Some parts of the code in this file are derived from the ipw2200</span>
<span class="cm">  driver  Copyright(c) 2003 - 2004 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm">  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,</span>
<span class="cm">  Boston, MA 02110-1301, USA.</span>

<span class="cm">*/</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;b43.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;phy_common.h&quot;</span>
<span class="cp">#include &quot;phy_g.h&quot;</span>
<span class="cp">#include &quot;phy_n.h&quot;</span>
<span class="cp">#include &quot;dma.h&quot;</span>
<span class="cp">#include &quot;pio.h&quot;</span>
<span class="cp">#include &quot;sysfs.h&quot;</span>
<span class="cp">#include &quot;xmit.h&quot;</span>
<span class="cp">#include &quot;lo.h&quot;</span>
<span class="cp">#include &quot;pcmcia.h&quot;</span>
<span class="cp">#include &quot;sdio.h&quot;</span>
<span class="cp">#include &lt;linux/mmc/sdio_func.h&gt;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Broadcom B43 wireless driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Martin Langer&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Stefano Brivio&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Michael Buesch&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Gábor Stefanik&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Rafał Miłecki&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43/ucode11.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43/ucode13.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43/ucode14.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43/ucode15.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43/ucode16_mimo.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43/ucode5.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43/ucode9.fw&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_bad_frames_preempt</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">bad_frames_preempt</span><span class="p">,</span> <span class="n">modparam_bad_frames_preempt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bad_frames_preempt</span><span class="p">,</span>
		 <span class="s">&quot;enable(1) / disable(0) Bad Frames Preemption&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">modparam_fwpostfix</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">fwpostfix</span><span class="p">,</span> <span class="n">modparam_fwpostfix</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fwpostfix</span><span class="p">,</span> <span class="s">&quot;Postfix for the .fw files to load.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_hwpctl</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">hwpctl</span><span class="p">,</span> <span class="n">modparam_hwpctl</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwpctl</span><span class="p">,</span> <span class="s">&quot;Enable hardware-side power control (default off)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_nohwcrypt</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">nohwcrypt</span><span class="p">,</span> <span class="n">modparam_nohwcrypt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nohwcrypt</span><span class="p">,</span> <span class="s">&quot;Disable hardware encryption.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_hwtkip</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">hwtkip</span><span class="p">,</span> <span class="n">modparam_hwtkip</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">hwtkip</span><span class="p">,</span> <span class="s">&quot;Enable hardware tkip.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_qos</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">qos</span><span class="p">,</span> <span class="n">modparam_qos</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">qos</span><span class="p">,</span> <span class="s">&quot;Enable QOS support (default on)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_btcoex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">btcoex</span><span class="p">,</span> <span class="n">modparam_btcoex</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">btcoex</span><span class="p">,</span> <span class="s">&quot;Enable Bluetooth coexistence (default on)&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">b43_modparam_verbose</span> <span class="o">=</span> <span class="n">B43_VERBOSITY_DEFAULT</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">b43_modparam_verbose</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="s">&quot;Log message verbosity: 0=error, 1=warn, 2=info(default), 3=debug&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">b43_modparam_pio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="n">b43_modparam_pio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="s">&quot;Use PIO accesses by default: 0=DMA, 1=PIO&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_B43_BCMA</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bcma_device_id</span> <span class="n">b43_bcma_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BCMA_CORE</span><span class="p">(</span><span class="n">BCMA_MANUF_BCM</span><span class="p">,</span> <span class="n">BCMA_CORE_80211</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="n">BCMA_ANY_CLASS</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_B43_BCMA_EXTRA</span>
	<span class="n">BCMA_CORE</span><span class="p">(</span><span class="n">BCMA_MANUF_BCM</span><span class="p">,</span> <span class="n">BCMA_CORE_80211</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">,</span> <span class="n">BCMA_ANY_CLASS</span><span class="p">),</span>
	<span class="n">BCMA_CORE</span><span class="p">(</span><span class="n">BCMA_MANUF_BCM</span><span class="p">,</span> <span class="n">BCMA_CORE_80211</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">BCMA_ANY_CLASS</span><span class="p">),</span>
<span class="cp">#endif</span>
	<span class="n">BCMA_CORE</span><span class="p">(</span><span class="n">BCMA_MANUF_BCM</span><span class="p">,</span> <span class="n">BCMA_CORE_80211</span><span class="p">,</span> <span class="mh">0x1D</span><span class="p">,</span> <span class="n">BCMA_ANY_CLASS</span><span class="p">),</span>
	<span class="n">BCMA_CORETABLE_END</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">bcma</span><span class="p">,</span> <span class="n">b43_bcma_tbl</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_B43_SSB</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="n">b43_ssb_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">9</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">12</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">13</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">16</span><span class="p">),</span>
	<span class="n">SSB_DEVTABLE_END</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ssb</span><span class="p">,</span> <span class="n">b43_ssb_tbl</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="cm">/* Channel and ratetables are shared for all devices.</span>
<span class="cm"> * They can&#39;t be const, because ieee80211 puts some precalculated</span>
<span class="cm"> * data in there. This data is the same for all devices, so we don&#39;t</span>
<span class="cm"> * get concurrency issues */</span>
<span class="cp">#define RATETAB_ENT(_rateid, _flags) \</span>
<span class="cp">	{								\</span>
<span class="cp">		.bitrate	= B43_RATE_TO_BASE100KBPS(_rateid),	\</span>
<span class="cp">		.hw_value	= (_rateid),				\</span>
<span class="cp">		.flags		= (_flags),				\</span>
<span class="cp">	}</span>

<span class="cm">/*</span>
<span class="cm"> * NOTE: When changing this, sync with xmit.c&#39;s</span>
<span class="cm"> *	 b43_plcp_get_bitrate_idx_* functions!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">__b43_ratetable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_CCK_RATE_1MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_CCK_RATE_2MB</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_CCK_RATE_5MB</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_CCK_RATE_11MB</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_OFDM_RATE_6MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_OFDM_RATE_9MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_OFDM_RATE_12MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_OFDM_RATE_18MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_OFDM_RATE_24MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_OFDM_RATE_36MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_OFDM_RATE_48MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43_OFDM_RATE_54MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define b43_a_ratetable		(__b43_ratetable + 4)</span>
<span class="cp">#define b43_a_ratetable_size	8</span>
<span class="cp">#define b43_b_ratetable		(__b43_ratetable + 0)</span>
<span class="cp">#define b43_b_ratetable_size	4</span>
<span class="cp">#define b43_g_ratetable		(__b43_ratetable + 0)</span>
<span class="cp">#define b43_g_ratetable_size	12</span>

<span class="cp">#define CHAN4G(_channel, _freq, _flags) {			\</span>
<span class="cp">	.band			= IEEE80211_BAND_2GHZ,		\</span>
<span class="cp">	.center_freq		= (_freq),			\</span>
<span class="cp">	.hw_value		= (_channel),			\</span>
<span class="cp">	.flags			= (_flags),			\</span>
<span class="cp">	.max_antenna_gain	= 0,				\</span>
<span class="cp">	.max_power		= 30,				\</span>
<span class="cp">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">b43_2ghz_chantable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2412</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2432</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2437</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN4G</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2484</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#undef CHAN4G</span>

<span class="cp">#define CHAN5G(_channel, _flags) {				\</span>
<span class="cp">	.band			= IEEE80211_BAND_5GHZ,		\</span>
<span class="cp">	.center_freq		= 5000 + (5 * (_channel)),	\</span>
<span class="cp">	.hw_value		= (_channel),			\</span>
<span class="cp">	.flags			= (_flags),			\</span>
<span class="cp">	.max_antenna_gain	= 0,				\</span>
<span class="cp">	.max_power		= 30,				\</span>
<span class="cp">}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">b43_5ghz_nphy_chantable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">54</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">62</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">68</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">72</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">76</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">78</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">82</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">84</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">86</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">88</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">92</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">94</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">98</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">102</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">104</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">106</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">108</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">114</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">116</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">118</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">122</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">126</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">130</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">134</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">136</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">138</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">142</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">144</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">145</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">146</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">147</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">148</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">149</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">151</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">152</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">154</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">155</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">156</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">157</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">158</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">159</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">160</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">162</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">163</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">164</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">165</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">166</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">168</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">172</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">174</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">176</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">178</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">182</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">184</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">186</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">188</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">190</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">194</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">196</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">198</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">202</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">206</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">208</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">210</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">214</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">216</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">218</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">222</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">226</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">228</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">b43_5ghz_aphy_chantable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">34</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">104</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">108</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">116</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">124</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">136</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">149</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">157</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">165</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">184</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">188</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">192</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">196</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">204</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">208</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>		<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">212</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN5G</span><span class="p">(</span><span class="mi">216</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#undef CHAN5G</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">b43_band_5GHz_nphy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band</span>		<span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span>	<span class="o">=</span> <span class="n">b43_5ghz_nphy_chantable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b43_5ghz_nphy_chantable</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span>	<span class="o">=</span> <span class="n">b43_a_ratetable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span>	<span class="o">=</span> <span class="n">b43_a_ratetable_size</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">b43_band_5GHz_aphy</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band</span>		<span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span>	<span class="o">=</span> <span class="n">b43_5ghz_aphy_chantable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b43_5ghz_aphy_chantable</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span>	<span class="o">=</span> <span class="n">b43_a_ratetable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span>	<span class="o">=</span> <span class="n">b43_a_ratetable_size</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">b43_band_2GHz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band</span>		<span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span>	<span class="o">=</span> <span class="n">b43_2ghz_chantable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b43_2ghz_chantable</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span>	<span class="o">=</span> <span class="n">b43_g_ratetable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span>	<span class="o">=</span> <span class="n">b43_g_ratetable_size</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">b43_wireless_core_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">b43_wireless_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span> <span class="n">b43_wireless_core_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">b43_wireless_core_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">b43_op_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">changed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_ratelimit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span> <span class="o">||</span> <span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* We are up and running.</span>
<span class="cm">	 * Ratelimit the messages to avoid DoS over the net. */</span>
	<span class="k">return</span> <span class="n">net_ratelimit</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43info</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_modparam_verbose</span> <span class="o">&lt;</span> <span class="n">B43_VERBOSITY_INFO</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_ratelimit</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;b43-%s: %pV&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">wl</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43err</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_modparam_verbose</span> <span class="o">&lt;</span> <span class="n">B43_VERBOSITY_ERROR</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_ratelimit</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;b43-%s ERROR: %pV&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">wl</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43warn</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_modparam_verbose</span> <span class="o">&lt;</span> <span class="n">B43_VERBOSITY_WARN</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_ratelimit</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;b43-%s warning: %pV&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">wl</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43dbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_modparam_verbose</span> <span class="o">&lt;</span> <span class="n">B43_VERBOSITY_DEBUG</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;b43-%s debug: %pV&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">wl</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_ram_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macctl</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macctl</span> <span class="o">&amp;</span> <span class="n">B43_MACCTL_BE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RAM_CONTROL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RAM_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">b43_shm_control_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="cm">/* &quot;offset&quot; is the WORD offset. */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">routing</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_CONTROL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">b43_shm_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">routing</span> <span class="o">==</span> <span class="n">B43_SHM_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unaligned access */</span>
			<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA_UNALIGNED</span><span class="p">);</span>
			<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">b43_shm_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">routing</span> <span class="o">==</span> <span class="n">B43_SHM_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unaligned access */</span>
			<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA_UNALIGNED</span><span class="p">);</span>

			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43_shm_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">routing</span> <span class="o">==</span> <span class="n">B43_SHM_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unaligned access */</span>
			<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA_UNALIGNED</span><span class="p">,</span>
				    <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43_shm_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">routing</span> <span class="o">==</span> <span class="n">B43_SHM_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unaligned access */</span>
			<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA_UNALIGNED</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read HostFlags */</span>
<span class="n">u64</span> <span class="nf">b43_hf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_HOSTFHI</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_HOSTFMI</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_HOSTFLO</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write HostFlags */</span>
<span class="kt">void</span> <span class="nf">b43_hf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">lo</span><span class="p">,</span> <span class="n">mi</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x00000000FFFFULL</span><span class="p">);</span>
	<span class="n">mi</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF0000ULL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFFFF00000000ULL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_HOSTFLO</span><span class="p">,</span> <span class="n">lo</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_HOSTFMI</span><span class="p">,</span> <span class="n">mi</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_HOSTFHI</span><span class="p">,</span> <span class="n">hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read the firmware capabilities bitmask (Opensource firmware only) */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_fwcapa_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">opensource</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_FWCAPA</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43_tsf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="cm">/* The hardware guarantees us an atomic read, if we</span>
<span class="cm">	 * read the low register first. */</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_REV3PLUS_TSF_LOW</span><span class="p">);</span>
	<span class="n">high</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_REV3PLUS_TSF_HIGH</span><span class="p">);</span>

	<span class="o">*</span><span class="n">tsf</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tsf</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="o">*</span><span class="n">tsf</span> <span class="o">|=</span> <span class="n">low</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_time_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">B43_MACCTL_TBTTHOLD</span><span class="p">);</span>
	<span class="cm">/* Commit the write */</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_time_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_TBTTHOLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Commit the write */</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_tsf_write_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">low</span> <span class="o">=</span> <span class="n">tsf</span><span class="p">;</span>
	<span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">);</span>
	<span class="cm">/* The hardware guarantees us an atomic write, if we</span>
<span class="cm">	 * write the low register first. */</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_REV3PLUS_TSF_LOW</span><span class="p">,</span> <span class="n">low</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_REV3PLUS_TSF_HIGH</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43_tsf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_time_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_tsf_write_locked</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>
	<span class="n">b43_time_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="nf">b43_macfilter_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">zero_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="p">)</span>
		<span class="n">mac</span> <span class="o">=</span> <span class="n">zero_addr</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">|=</span> <span class="mh">0x0020</span><span class="p">;</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACFILTER_CONTROL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACFILTER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACFILTER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACFILTER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_write_mac_bssid_templates</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">bssid</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">;</span>
	<span class="n">mac</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">;</span>

	<span class="n">b43_macfilter_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MACFILTER_BSSID</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_bssid</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_bssid</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Write our MAC address and BSSID to template ram */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mac_bssid</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_bssid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_bssid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_bssid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">mac_bssid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">b43_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_upload_card_macaddress</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_write_mac_bssid_templates</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_macfilter_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MACFILTER_SELF</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_slot_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">slot_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* slot_time is in usec. */</span>
	<span class="cm">/* This test used to exit for all but a G PHY. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_IFSSLOT</span><span class="p">,</span> <span class="mi">510</span> <span class="o">+</span> <span class="n">slot_time</span><span class="p">);</span>
	<span class="cm">/* Shared memory location 0x0010 is the slot time and should be</span>
<span class="cm">	 * set to slot_time; however, this register is initially 0 and changing</span>
<span class="cm">	 * the value adversely affects the transmit rate for BCM4311</span>
<span class="cm">	 * devices. Until this behavior is unterstood, delete this step</span>
<span class="cm">	 *</span>
<span class="cm">	 * b43_shm_write16(dev, B43_SHM_SHARED, 0x0010, slot_time);</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_short_slot_timing_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_set_slot_time</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_short_slot_timing_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_set_slot_time</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DummyTransmission function, as documented on</span>
<span class="cm"> * http://bcm-v4.sipsolutions.net/802.11/DummyTransmission</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">b43_dummy_transmission</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">ofdm</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pa_on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">max_loop</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00000000</span><span class="p">,</span>
		<span class="mh">0x00D40000</span><span class="p">,</span>
		<span class="mh">0x00000000</span><span class="p">,</span>
		<span class="mh">0x01000000</span><span class="p">,</span>
		<span class="mh">0x00000000</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ofdm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">max_loop</span> <span class="o">=</span> <span class="mh">0x1E</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x000201CC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">max_loop</span> <span class="o">=</span> <span class="mh">0xFA</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x000B846E</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_XMTSEL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_WEPCTL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_WEPCTL</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">ofdm</span> <span class="o">?</span> <span class="mh">0x41</span> <span class="o">:</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_PHYCTL</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_N</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_LP</span> <span class="o">||</span>
	    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_LCN</span><span class="p">)</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_PHYCTL1</span><span class="p">,</span> <span class="mh">0x1A02</span><span class="p">);</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_WM_0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_WM_1</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_XMTTPLATETXPTR</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_XMTTXCNT</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_XMTSEL</span><span class="p">,</span> <span class="mh">0x0826</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_CTL</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pa_on</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_N</span><span class="p">)</span>
		<span class="p">;</span> <span class="cm">/*b43_nphy_pa_override(dev, false) */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_N</span>:
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LCN</span>:
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_AUX</span><span class="p">,</span> <span class="mh">0x00D0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LP</span>:
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_AUX</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_AUX</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_AUX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;=</span> <span class="mh">0x5</span><span class="p">)</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_loop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TXE0_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x19</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_IFSSTAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;=</span> <span class="mh">0x5</span><span class="p">)</span>
		<span class="n">b43_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">key_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">algorithm</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">kidx</span><span class="p">;</span>

	<span class="cm">/* Key index/algo block */</span>
	<span class="n">kidx</span> <span class="o">=</span> <span class="n">b43_kidx_to_fw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">kidx</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">algorithm</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
			<span class="n">B43_SHM_SH_KEYIDXBLOCK</span> <span class="o">+</span> <span class="p">(</span><span class="n">kidx</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span> <span class="n">value</span><span class="p">);</span>

	<span class="cm">/* Write the key to the Key Table Pointer offset */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ktp</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">B43_SEC_KEYSIZE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">B43_SEC_KEYSIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">keymac_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">addrtmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">pairwise_keys_start</span><span class="p">);</span>
	<span class="cm">/* We have four default TX keys and possibly four default RX keys.</span>
<span class="cm">	 * Physical mac 0 is mapped to physical key 4 or 8, depending</span>
<span class="cm">	 * on the firmware version.</span>
<span class="cm">	 * So we must adjust the index here.</span>
<span class="cm">	 */</span>
	<span class="n">index</span> <span class="o">-=</span> <span class="n">pairwise_keys_start</span><span class="p">;</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">B43_NR_PAIRWISE_KEYS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addrtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">addrtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">addrtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">addrtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">addrtmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">addrtmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Receive match transmitter address (RCMTA) mechanism */</span>
	<span class="n">b43_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_RCMTA</span><span class="p">,</span>
			<span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addrtmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_RCMTA</span><span class="p">,</span>
			<span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">addrtmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* The ucode will use phase1 key with TEK key to decrypt rx packets.</span>
<span class="cm"> * When a packet is received, the iv32 is checked.</span>
<span class="cm"> * - if it doesn&#39;t the packet is returned without modification (and software</span>
<span class="cm"> *   decryption can be done). That&#39;s what happen when iv16 wrap.</span>
<span class="cm"> * - if it does, the rc4 key is computed, and decryption is tried.</span>
<span class="cm"> *   Either it will success and B43_RX_MAC_DEC is returned,</span>
<span class="cm"> *   either it fails and B43_RX_MAC_DEC|B43_RX_MAC_DECERR is returned</span>
<span class="cm"> *   and the packet is not usable (it got modified by the ucode).</span>
<span class="cm"> * So in order to never have B43_RX_MAC_DECERR, we should provide</span>
<span class="cm"> * a iv32 and phase1key that match. Because we drop packets in case of</span>
<span class="cm"> * B43_RX_MAC_DECERR, if we have a correct iv32 but a wrong phase1key, all</span>
<span class="cm"> * packets will be lost without higher layer knowing (ie no resync possible</span>
<span class="cm"> * until next wrap).</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE : this should support 50 key like RCMTA because</span>
<span class="cm"> * (B43_SHM_SH_KEYIDXBLOCK - B43_SHM_SH_TKIPTSCTTAK)/14 = 50</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_tkip_phase1_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iv32</span><span class="p">,</span>
		<span class="n">u16</span> <span class="o">*</span><span class="n">phase1key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modparam_hwtkip</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">pairwise_keys_start</span><span class="p">);</span>
	<span class="cm">/* We have four default TX keys and possibly four default RX keys.</span>
<span class="cm">	 * Physical mac 0 is mapped to physical key 4 or 8, depending</span>
<span class="cm">	 * on the firmware version.</span>
<span class="cm">	 * So we must adjust the index here.</span>
<span class="cm">	 */</span>
	<span class="n">index</span> <span class="o">-=</span> <span class="n">pairwise_keys_start</span><span class="p">;</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">B43_NR_PAIRWISE_KEYS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_KEYS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;rx_tkip_phase1_write : idx 0x%x, iv32 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">index</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Write the key to the  RX tkip shared mem */</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">B43_SHM_SH_TKIPTSCTTAK</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				<span class="n">phase1key</span> <span class="o">?</span> <span class="n">phase1key</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">iv32</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">iv32</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_update_tkip_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">iv32</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">phase1key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">modparam_hwtkip</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* This is only called from the RX path through mac80211, where</span>
<span class="cm">	 * our mutex is already locked. */</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">));</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">);</span>

	<span class="n">keymac_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>	<span class="cm">/* First zero out mac to avoid race */</span>

	<span class="n">rx_tkip_phase1_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">iv32</span><span class="p">,</span> <span class="n">phase1key</span><span class="p">);</span>
	<span class="cm">/* only pairwise TKIP keys are supported right now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">keymac_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_key_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">algorithm</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="n">B43_SEC_KEYSIZE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="n">u8</span> <span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">B43_SEC_KEYSIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">pairwise_keys_start</span><span class="p">)</span>
		<span class="n">keymac_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>	<span class="cm">/* First zero out mac. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">algorithm</span> <span class="o">==</span> <span class="n">B43_SEC_ALGO_TKIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We should provide an initial iv32, phase1key pair.</span>
<span class="cm">		 * We could start with iv32=0 and compute the corresponding</span>
<span class="cm">		 * phase1key, but this means calling ieee80211_get_tkip_key</span>
<span class="cm">		 * with a fake skb (or export other tkip function).</span>
<span class="cm">		 * Because we are lazy we hope iv32 won&#39;t start with</span>
<span class="cm">		 * 0xffffffff and let&#39;s b43_op_update_tkip_key provide a</span>
<span class="cm">		 * correct pair.</span>
<span class="cm">		 */</span>
		<span class="n">rx_tkip_phase1_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">pairwise_keys_start</span><span class="p">)</span> <span class="cm">/* clear it */</span>
		<span class="n">rx_tkip_phase1_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="n">key_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">pairwise_keys_start</span><span class="p">)</span>
		<span class="n">keymac_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">algorithm</span> <span class="o">=</span> <span class="n">algorithm</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_key_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">algorithm</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">key_len</span><span class="p">,</span>
			 <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pairwise_keys_start</span><span class="p">;</span>

	<span class="cm">/* For ALG_TKIP the key is encoded as a 256-bit (32 byte) data block:</span>
<span class="cm">	 * 	- Temporal Encryption Key (128 bits)</span>
<span class="cm">	 * 	- Temporal Authenticator Tx MIC Key (64 bits)</span>
<span class="cm">	 * 	- Temporal Authenticator Rx MIC Key (64 bits)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 	Hardware only store TEK</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">algorithm</span> <span class="o">==</span> <span class="n">B43_SEC_ALGO_TKIP</span> <span class="o">&amp;&amp;</span> <span class="n">key_len</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">key_len</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">B43_SEC_KEYSIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check that we don&#39;t already have this key. */</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keyconf</span> <span class="o">==</span> <span class="n">keyconf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Pairwise key. Get an empty slot for the key. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">pairwise_keys_start</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pairwise_keys_start</span> <span class="o">+</span> <span class="n">B43_NR_PAIRWISE_KEYS</span><span class="p">;</span>
		     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">keyconf</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* found empty */</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Out of hardware key memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">do_key_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Default RX key */</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">mac_addr</span><span class="p">);</span>
		<span class="n">do_key_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">keyconf</span> <span class="o">=</span> <span class="n">keyconf</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_key_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">B43_WARN_ON</span><span class="p">((</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">do_key_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">B43_SEC_ALGO_NONE</span><span class="p">,</span>
		     <span class="nb">NULL</span><span class="p">,</span> <span class="n">B43_SEC_KEYSIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">do_key_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">B43_SEC_ALGO_NONE</span><span class="p">,</span>
			     <span class="nb">NULL</span><span class="p">,</span> <span class="n">B43_SEC_KEYSIZE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">keyconf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_clear_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">+</span> <span class="n">B43_NR_PAIRWISE_KEYS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">B43_NR_PAIRWISE_KEYS</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_key_clear</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_dump_keymemory</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">pairwise_keys_start</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">algo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rcmta0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rcmta1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_KEYS</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hf</span> <span class="o">=</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Hardware key memory dump:  USEDEFKEYS=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="o">!!</span><span class="p">(</span><span class="n">hf</span> <span class="o">&amp;</span> <span class="n">B43_HF_USEDEFKEYS</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_new_kidx_api</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">+</span> <span class="n">B43_NR_PAIRWISE_KEYS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pairwise_keys_start</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">B43_NR_GROUP_KEYS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">B43_NR_PAIRWISE_KEYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">index</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">key</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">index</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Key slot %02u: %s&quot;</span><span class="p">,</span>
		       <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyconf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; &quot;</span> <span class="o">:</span> <span class="s">&quot;*&quot;</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ktp</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="n">B43_SEC_KEYSIZE</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">B43_SEC_KEYSIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02X%02X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="n">algo</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
				      <span class="n">B43_SHM_SH_KEYIDXBLOCK</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   Algo: %04X/%02X&quot;</span><span class="p">,</span> <span class="n">algo</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">algorithm</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">pairwise_keys_start</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">algorithm</span> <span class="o">==</span> <span class="n">B43_SEC_ALGO_TKIP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   TKIP: &quot;</span><span class="p">);</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">B43_SHM_SH_TKIPTSCTTAK</span> <span class="o">+</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%02X%02X&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">));</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">rcmta0</span> <span class="o">=</span> <span class="n">b43_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_RCMTA</span><span class="p">,</span>
						<span class="p">((</span><span class="n">index</span> <span class="o">-</span> <span class="n">pairwise_keys_start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rcmta1</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_RCMTA</span><span class="p">,</span>
						<span class="p">((</span><span class="n">index</span> <span class="o">-</span> <span class="n">pairwise_keys_start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="o">*</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rcmta0</span><span class="p">);</span>
			<span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rcmta1</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   MAC: %pM&quot;</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;   DEFAULT KEY&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43_power_saving_ctl_bits</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ps_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ucstat</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">hwps</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">awake</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">((</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">B43_PS_ENABLED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">B43_PS_DISABLED</span><span class="p">));</span>
	<span class="n">B43_WARN_ON</span><span class="p">((</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">B43_PS_AWAKE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">B43_PS_ASLEEP</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">B43_PS_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwps</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">B43_PS_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwps</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>TODO: If powersave is not off and FIXME is not set and we are not in adhoc
     and thus is not an AP and we are associated, set bit 25</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">B43_PS_AWAKE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">awake</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ps_flags</span> <span class="o">&amp;</span> <span class="n">B43_PS_ASLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">awake</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>TODO: If the device is awake or this is an AP, or we are scanning, or FIXME,
     or we are associated, or FIXME, or the latest PS-Poll packet sent was
     successful, set bit26</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span>

<span class="cm">/* FIXME: For now we force awake-on and hwps-off */</span>
	<span class="n">hwps</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">awake</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hwps</span><span class="p">)</span>
		<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_HWPS</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">macctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_HWPS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">awake</span><span class="p">)</span>
		<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_AWAKE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">macctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_AWAKE</span><span class="p">;</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>
	<span class="cm">/* Commit write */</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">awake</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wait for the microcode to wake up. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ucstat</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
						<span class="n">B43_SHM_SH_UCODESTAT</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ucstat</span> <span class="o">!=</span> <span class="n">B43_SHM_SH_UCODESTAT_SLEEP</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_B43_BCMA</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_bcma_phy_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Put PHY into reset */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">bcma_aread32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">B43_BCMA_IOCTL_PHY_RESET</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">B43_BCMA_IOCTL_PHY_BW_20MHZ</span><span class="p">;</span> <span class="cm">/* Make 20 MHz def */</span>
	<span class="n">bcma_awrite32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Take PHY out of reset */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">bcma_aread32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_BCMA_IOCTL_PHY_RESET</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">BCMA_IOCTL_FGC</span><span class="p">;</span>
	<span class="n">bcma_awrite32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Do not force clock anymore */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">bcma_aread32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">);</span>
	<span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BCMA_IOCTL_FGC</span><span class="p">;</span>
	<span class="n">bcma_awrite32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_bcma_wireless_core_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">gmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_device_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_BCMA_IOCTL_PHY_CLKEN</span><span class="p">);</span>
	<span class="n">bcma_core_set_clockmode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_CLKMODE_FAST</span><span class="p">);</span>
	<span class="n">b43_bcma_phy_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">bcma_core_pll_ctl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x3000000</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_ssb_wireless_core_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">gmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmslow</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">B43_TMSLOW_GMODE</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">B43_TMSLOW_PHYCLKEN</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">B43_TMSLOW_PHYRESET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_N</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">B43_TMSLOW_PHY_BANDWIDTH_20MHZ</span><span class="p">;</span> <span class="cm">/* Make 20 MHz def */</span>
	<span class="n">b43_device_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>		<span class="cm">/* Wait for the PLL to turn on. */</span>

	<span class="cm">/* Now take the PHY out of Reset again */</span>
	<span class="n">tmslow</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
	<span class="n">tmslow</span> <span class="o">|=</span> <span class="n">SSB_TMSLOW_FGC</span><span class="p">;</span>
	<span class="n">tmslow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_TMSLOW_PHYRESET</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmslow</span><span class="p">);</span>
	<span class="n">ssb_read32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">tmslow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_TMSLOW_FGC</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmslow</span><span class="p">);</span>
	<span class="n">ssb_read32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>	<span class="cm">/* flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43_wireless_core_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">gmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">macctl</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="n">b43_bcma_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gmode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="n">b43_ssb_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">gmode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="cm">/* Turn Analog ON, but only if we already know the PHY-type.</span>
<span class="cm">	 * This protects against very early setup where we don&#39;t know the</span>
<span class="cm">	 * PHY-type, yet. wireless_core_reset will be called once again later,</span>
<span class="cm">	 * when we know the PHY-type. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">switch_analog</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">macctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_GMODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_GMODE</span><span class="p">;</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_IHR_ENABLED</span><span class="p">;</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_transmit_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_txstatus</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v0</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_XMITSTAT_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_XMITSTAT_1</span><span class="p">);</span>

		<span class="n">stat</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">phy_stat</span> <span class="o">=</span> <span class="p">((</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">frame_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">rts_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0F00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">supp_reason</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x001C</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">pm_indicated</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">intermediate</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">for_ampdu</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">acked</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">);</span>

		<span class="n">b43_handle_txstatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drain_txstatus_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Read all entries from the microcode TXstatus FIFO</span>
<span class="cm">	 * and throw them away.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_XMITSTAT_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dummy</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_XMITSTAT_1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">b43_jssi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x08A</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x088</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_jssi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">jssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x088</span><span class="p">,</span> <span class="p">(</span><span class="n">jssi</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">));</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x08A</span><span class="p">,</span> <span class="p">(</span><span class="n">jssi</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_generate_noise_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_jssi_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7F7F7F7F</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">,</span>
		    <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_MACCMD_BGNOISE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_calculate_link_quality</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Top half of Link Quality calculation. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_G</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">calculation_running</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">calculation_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">b43_generate_noise_sample</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_noise</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy_g</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">g</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">noise</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">average</span><span class="p">;</span>

	<span class="cm">/* Bottom half of Link Quality calculation. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_G</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Possible race condition: It might be possible that the user</span>
<span class="cm">	 * changed to a different channel in the meantime since we</span>
<span class="cm">	 * started the calculation. We ignore that fact, since it&#39;s</span>
<span class="cm">	 * not really that much of a problem. The background noise is</span>
<span class="cm">	 * an estimation only anyway. Slightly wrong results will get damped</span>
<span class="cm">	 * by the averaging of the 8 sample rounds. Additionally the</span>
<span class="cm">	 * value is shortlived. So it will be replaced by the next noise</span>
<span class="cm">	 * calculation round soon. */</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">calculation_running</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">noise</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">b43_jssi_read</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7F</span> <span class="o">||</span> <span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7F</span> <span class="o">||</span>
	    <span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7F</span> <span class="o">||</span> <span class="n">noise</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7F</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">generate_new</span><span class="p">;</span>

	<span class="cm">/* Get the noise samples. */</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span><span class="p">;</span>
	<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">noise</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">]];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="mi">3</span><span class="p">]];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Calculate the Link Quality by the noise samples. */</span>
		<span class="n">average</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">average</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">average</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">average</span> <span class="o">*=</span> <span class="mi">125</span><span class="p">;</span>
		<span class="n">average</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">average</span> <span class="o">/=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x40C</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">/</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">average</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">average</span> <span class="o">-=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">average</span> <span class="o">-=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">average</span> <span class="o">-=</span> <span class="mi">48</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_noise</span> <span class="o">=</span> <span class="n">average</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">calculation_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">generate_new:</span>
	<span class="n">b43_generate_noise_sample</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_tbtt_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>/TODO: PS TBTT</p></td><td class="code"><div class="highlight"><pre>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="cm">/*FIXME: the last PSpoll frame was sent successfully */</span> <span class="p">)</span>
			<span class="n">b43_power_saving_ctl_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dfq_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_atim_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dfq_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">,</span>
			    <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">)</span>
			    <span class="o">|</span> <span class="n">B43_MACCMD_DFQ_VALID</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dfq_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_pmq</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>TODO: AP mode.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PS_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x00000008</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* 16bit write is odd, but correct. */</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PS_STATUS</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_write_template_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">ram_offset</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">shm_size_offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_plcp_hdr4</span> <span class="n">plcp</span><span class="p">;</span>

	<span class="n">plcp</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b43_generate_plcp_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plcp</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">b43_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ram_offset</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">plcp</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
	<span class="n">ram_offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="cm">/* The PLCP is 6 bytes long, but we only wrote 4 bytes, yet.</span>
<span class="cm">	 * So leave the first two bytes of the next write blank.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">b43_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ram_offset</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">ram_offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">b43_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ram_offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">shm_size_offset</span><span class="p">,</span>
			<span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_plcp_hdr6</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Check if the use of the antenna that ieee80211 told us to</span>
<span class="cm"> * use is possible. This will fall back to DEFAULT.</span>
<span class="cm"> * &quot;antenna_nr&quot; is the antenna identifier we got from ieee80211. */</span>
<span class="n">u8</span> <span class="nf">b43_ieee80211_antenna_sanitize</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">antenna_nr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">antenna_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">antenna_nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Zero means &quot;use default antenna&quot;. That&#39;s always OK. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the mask of available antennas. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">antenna_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">ant_available_bg</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">antenna_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">ant_available_a</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">antenna_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">antenna_nr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/* This antenna is not available. Fall back to default. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">antenna_nr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert a b43 antenna number value to the PHY TX control value. */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43_antenna_to_phyctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">antenna</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_ANTENNA0</span>:
		<span class="k">return</span> <span class="n">B43_TXH_PHY_ANT0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_ANTENNA1</span>:
		<span class="k">return</span> <span class="n">B43_TXH_PHY_ANT1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_ANTENNA2</span>:
		<span class="k">return</span> <span class="n">B43_TXH_PHY_ANT2</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_ANTENNA3</span>:
		<span class="k">return</span> <span class="n">B43_TXH_PHY_ANT3</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_ANTENNA_AUTO0</span>:
	<span class="k">case</span> <span class="n">B43_ANTENNA_AUTO1</span>:
		<span class="k">return</span> <span class="n">B43_TXH_PHY_ANT01AUTO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_write_beacon_template</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">ram_offset</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">shm_size_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">variable_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">bcn</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tim_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">);</span>

	<span class="n">bcn</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		  <span class="mh">0x200</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_plcp_hdr6</span><span class="p">));</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

	<span class="n">b43_write_template_common</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bcn</span><span class="p">,</span>
				  <span class="n">len</span><span class="p">,</span> <span class="n">ram_offset</span><span class="p">,</span> <span class="n">shm_size_offset</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="cm">/* Write the PHY TX control parameters. */</span>
	<span class="n">antenna</span> <span class="o">=</span> <span class="n">B43_ANTENNA_DEFAULT</span><span class="p">;</span>
	<span class="n">antenna</span> <span class="o">=</span> <span class="n">b43_antenna_to_phyctl</span><span class="p">(</span><span class="n">antenna</span><span class="p">);</span>
	<span class="n">ctl</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_BEACPHYCTL</span><span class="p">);</span>
	<span class="cm">/* We can&#39;t send beacons with short preamble. Would get PHY errors. */</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_TXH_PHY_SHORTPRMBL</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_TXH_PHY_ANT</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_TXH_PHY_ENC</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">|=</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_is_cck_rate</span><span class="p">(</span><span class="n">rate</span><span class="p">))</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_TXH_PHY_ENC_CCK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_TXH_PHY_ENC_OFDM</span><span class="p">;</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_BEACPHYCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>

	<span class="cm">/* Find the position of the TIM and the DTIM_period value</span>
<span class="cm">	 * and write them to SHM. */</span>
	<span class="n">ie</span> <span class="o">=</span> <span class="n">bcn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
	<span class="n">variable_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">variable_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">ie_id</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">;</span>

		<span class="n">ie_id</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie_id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">tim_position</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">dtim_period</span><span class="p">;</span>
			<span class="cm">/* This is the TIM Information Element */</span>

			<span class="cm">/* Check whether the ie_len is in the beacon data range. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">variable_len</span> <span class="o">&lt;</span> <span class="n">ie_len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* A valid TIM is at least 4 bytes long. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">tim_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">tim_position</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_plcp_hdr6</span><span class="p">);</span>
			<span class="n">tim_position</span> <span class="o">+=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>
			<span class="n">tim_position</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">dtim_period</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

			<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
					<span class="n">B43_SHM_SH_TIMBPOS</span><span class="p">,</span> <span class="n">tim_position</span><span class="p">);</span>
			<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
					<span class="n">B43_SHM_SH_DTIMPER</span><span class="p">,</span> <span class="n">dtim_period</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">ie_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tim_found</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If ucode wants to modify TIM do it behind the beacon, this</span>
<span class="cm">		 * will happen, for example, when doing mesh networking.</span>
<span class="cm">		 */</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
				<span class="n">B43_SHM_SH_TIMBPOS</span><span class="p">,</span>
				<span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_plcp_hdr6</span><span class="p">));</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
				<span class="n">B43_SHM_SH_DTIMPER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Updated beacon template at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ram_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_upload_beacon0</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon0_uploaded</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43_write_beacon_template</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon0_uploaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_upload_beacon1</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon1_uploaded</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43_write_beacon_template</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x468</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon1_uploaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">beacon0_valid</span><span class="p">,</span> <span class="n">beacon1_valid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* This is the bottom half of the asynchronous beacon update. */</span>

	<span class="cm">/* Ignore interrupt in the future. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_IRQ_BEACON</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">);</span>
	<span class="n">beacon0_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">B43_MACCMD_BEACON0_VALID</span><span class="p">);</span>
	<span class="n">beacon1_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">B43_MACCMD_BEACON1_VALID</span><span class="p">);</span>

	<span class="cm">/* Schedule interrupt manually, if busy. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon0_valid</span> <span class="o">&amp;&amp;</span> <span class="n">beacon1_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">,</span> <span class="n">B43_IRQ_BEACON</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">|=</span> <span class="n">B43_IRQ_BEACON</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_templates_virgin</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We never uploaded a beacon before.</span>
<span class="cm">		 * Upload both templates now, but only mark one valid. */</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_templates_virgin</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">b43_upload_beacon0</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">b43_upload_beacon1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">B43_MACCMD_BEACON0_VALID</span><span class="p">;</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon0_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_upload_beacon0</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">B43_MACCMD_BEACON0_VALID</span><span class="p">;</span>
			<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon1_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_upload_beacon1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">B43_MACCMD_BEACON1_VALID</span><span class="p">;</span>
			<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_do_beacon_update_trigger_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">old_irq_mask</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">;</span>

	<span class="cm">/* update beacon right away or defer to irq */</span>
	<span class="n">handle_irq_beacon</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_irq_mask</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The handler updated the IRQ mask. */</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Device interrupts are currently disabled. That means</span>
<span class="cm">			 * we just ran the hardirq handler and scheduled the</span>
<span class="cm">			 * IRQ thread. The thread will write the IRQ mask when</span>
<span class="cm">			 * it finished, so there&#39;s nothing to do here. Writing</span>
<span class="cm">			 * the mask _here_ would incorrectly re-enable IRQs. */</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_beacon_update_trigger_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43_wl</span><span class="p">,</span>
					 <span class="n">beacon_update_trigger</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_bus_host_is_sdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* wl-&gt;mutex is enough. */</span>
			<span class="n">b43_do_beacon_update_trigger_work</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">mmiowb</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hardirq_lock</span><span class="p">);</span>
			<span class="n">b43_do_beacon_update_trigger_work</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">mmiowb</span><span class="p">();</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hardirq_lock</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Asynchronously update the packet templates in template RAM.</span>
<span class="cm"> * Locking: Requires wl-&gt;mutex to be locked. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_update_templates</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">;</span>

	<span class="cm">/* This is the top half of the ansynchronous beacon update.</span>
<span class="cm">	 * The bottom half is the beacon IRQ.</span>
<span class="cm">	 * Beacon update must be asynchronous to avoid sending an</span>
<span class="cm">	 * invalid beacon. This can happen for example, if the firmware</span>
<span class="cm">	 * transmits a beacon while we are updating it. */</span>

	<span class="cm">/* We could modify the existing beacon and set the aid bit in</span>
<span class="cm">	 * the TIM field, but that would probably require resizing and</span>
<span class="cm">	 * moving of data within the beacon template.</span>
<span class="cm">	 * Simply request a new beacon and let mac80211 do the hard work. */</span>
	<span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">beacon</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span> <span class="o">=</span> <span class="n">beacon</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon0_uploaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon1_uploaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_update_trigger</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_beacon_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">beacon_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_time_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CFP_REP</span><span class="p">,</span> <span class="p">(</span><span class="n">beacon_int</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CFP_START</span><span class="p">,</span> <span class="p">(</span><span class="n">beacon_int</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x606</span><span class="p">,</span> <span class="p">(</span><span class="n">beacon_int</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x610</span><span class="p">,</span> <span class="n">beacon_int</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_time_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Set beacon interval to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">beacon_int</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_handle_firmware_panic</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reason</span><span class="p">;</span>

	<span class="cm">/* Read the register that contains the reason code for the panic. */</span>
	<span class="n">reason</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">B43_FWPANIC_REASON_REG</span><span class="p">);</span>
	<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Whoopsy, firmware panic! Reason: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;The panic reason is unknown.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">B43_FWPANIC_DIE</span>:
		<span class="cm">/* Do not restart the controller or firmware.</span>
<span class="cm">		 * The device is nonfunctional from now on.</span>
<span class="cm">		 * Restarting would result in this panic to trigger again,</span>
<span class="cm">		 * so we avoid that recursion. */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_FWPANIC_RESTART</span>:
		<span class="n">b43_controller_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Microcode panic&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_ucode_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason</span><span class="p">,</span> <span class="n">marker_id</span><span class="p">,</span> <span class="n">marker_line</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* The proprietary firmware doesn&#39;t have this IRQ. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">opensource</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Read the register that contains the reason code for this IRQ. */</span>
	<span class="n">reason</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">B43_DEBUGIRQ_REASON_REG</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reason</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_DEBUGIRQ_PANIC</span>:
		<span class="n">b43_handle_firmware_panic</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_DEBUGIRQ_DUMP_SHM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">B43_DEBUG</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Only with driver debugging enabled. */</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">4096</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;SHM-dump: Failed to allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Shared memory dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
			       <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4096</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_DEBUGIRQ_DUMP_REGS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">B43_DEBUG</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Only with driver debugging enabled. */</span>
		<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Microcode register dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;r%02u: 0x%04X  &quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_DEBUGIRQ_MARKER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">B43_DEBUG</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* Only with driver debugging enabled. */</span>
		<span class="n">marker_id</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span>
					   <span class="n">B43_MARKER_ID_REG</span><span class="p">);</span>
		<span class="n">marker_line</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span>
					     <span class="n">B43_MARKER_LINE_REG</span><span class="p">);</span>
		<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;The firmware just executed the MARKER(%u) &quot;</span>
			<span class="s">&quot;at line number %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">marker_id</span><span class="p">,</span> <span class="n">marker_line</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Debug-IRQ triggered for unknown reason: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">reason</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="cm">/* Acknowledge the debug-IRQ, so the firmware can continue. */</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span>
			<span class="n">B43_DEBUGIRQ_REASON_REG</span><span class="p">,</span> <span class="n">B43_DEBUGIRQ_ACK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_do_interrupt_thread</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_reason</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">)];</span>
	<span class="n">u32</span> <span class="n">merged_dma_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43_STAT_STARTED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_reason</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_reason</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">merged_dma_reason</span> <span class="o">|=</span> <span class="n">dma_reason</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_MAC_TXERR</span><span class="p">))</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;MAC transmission error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_PHY_TXERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;PHY transmission error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">txerr_cnt</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">txerr_cnt</span><span class="p">,</span>
				   <span class="n">B43_PHY_TX_BADNESS_LIMIT</span><span class="p">);</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Too many PHY TX errors, &quot;</span>
					<span class="s">&quot;restarting the controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">b43_controller_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY TX errors&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">merged_dma_reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B43_DMAIRQ_FATALMASK</span> <span class="o">|</span>
					  <span class="n">B43_DMAIRQ_NONFATALMASK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">merged_dma_reason</span> <span class="o">&amp;</span> <span class="n">B43_DMAIRQ_FATALMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Fatal DMA error: &quot;</span>
			       <span class="s">&quot;0x%08X, 0x%08X, 0x%08X, &quot;</span>
			       <span class="s">&quot;0x%08X, 0x%08X, 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;This device does not support DMA &quot;</span>
			       <span class="s">&quot;on your system. It will now be switched to PIO.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Fall back to PIO transfers if we get fatal DMA errors! */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">use_pio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">b43_controller_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA error&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">merged_dma_reason</span> <span class="o">&amp;</span> <span class="n">B43_DMAIRQ_NONFATALMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;DMA error: &quot;</span>
			       <span class="s">&quot;0x%08X, 0x%08X, 0x%08X, &quot;</span>
			       <span class="s">&quot;0x%08X, 0x%08X, 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_UCODE_DEBUG</span><span class="p">))</span>
		<span class="n">handle_irq_ucode_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_TBTT_INDI</span><span class="p">)</span>
		<span class="n">handle_irq_tbtt_indication</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_ATIM_END</span><span class="p">)</span>
		<span class="n">handle_irq_atim_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_BEACON</span><span class="p">)</span>
		<span class="n">handle_irq_beacon</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_PMQ</span><span class="p">)</span>
		<span class="n">handle_irq_pmq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_TXFIFO_FLUSH_OK</span><span class="p">)</span>
		<span class="p">;</span><span class="cm">/* TODO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_NOISESAMPLE_OK</span><span class="p">)</span>
		<span class="n">handle_irq_noise</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Check the DMA reason registers for received data. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43_DMAIRQ_RX_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_using_pio_transfers</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">b43_pio_rx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pio</span><span class="p">.</span><span class="n">rx_queue</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_dma_rx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">rx_ring</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43_DMAIRQ_RX_DONE</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43_DMAIRQ_RX_DONE</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43_DMAIRQ_RX_DONE</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43_DMAIRQ_RX_DONE</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43_DMAIRQ_RX_DONE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_TX_OK</span><span class="p">)</span>
		<span class="n">handle_irq_transmit_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Re-enable interrupts on the device by restoring the current interrupt mask. */</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>

<span class="cp">#if B43_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_VERBOSESTATS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_bit_count</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_bit_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* Interrupt thread handler. Handles device interrupts in thread context. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">b43_interrupt_thread_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">b43_do_interrupt_thread</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">b43_do_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reason</span><span class="p">;</span>

	<span class="cm">/* This code runs under wl-&gt;hardirq_lock, but _only_ on non-SDIO busses.</span>
<span class="cm">	 * On SDIO, this runs under wl-&gt;mutex. */</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span>	<span class="cm">/* shared IRQ */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="n">reason</span> <span class="o">&amp;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reason</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA0_REASON</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="mh">0x0001DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA1_REASON</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="mh">0x0000DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA2_REASON</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="mh">0x0000DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA3_REASON</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="mh">0x0001DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA4_REASON</span><span class="p">)</span>
	    <span class="o">&amp;</span> <span class="mh">0x0000DC00</span><span class="p">;</span>
<span class="cm">/* Unused ring</span>
<span class="cm">	dev-&gt;dma_reason[5] = b43_read32(dev, B43_MMIO_DMA5_REASON)</span>
<span class="cm">	    &amp; 0x0000DC00;</span>
<span class="cm">*/</span>

	<span class="cm">/* ACK the interrupt. */</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA0_REASON</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA1_REASON</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA2_REASON</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA3_REASON</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA4_REASON</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="cm">/* Unused ring</span>
<span class="cm">	b43_write32(dev, B43_MMIO_DMA5_REASON, dev-&gt;dma_reason[5]);</span>
<span class="cm">*/</span>

	<span class="cm">/* Disable IRQs on the device. The IRQ thread handler will re-enable them. */</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Save the reason bitmasks for the IRQ thread handler. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">IRQ_WAKE_THREAD</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler top-half. This runs with interrupts disabled. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">b43_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_STARTED</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hardirq_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43_do_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hardirq_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SDIO interrupt handler. This runs in process context. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_sdio_interrupt_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43_do_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">IRQ_WAKE_THREAD</span><span class="p">)</span>
		<span class="n">b43_do_interrupt_thread</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43_do_release_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_firmware_file</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_release_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_do_release_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">ucode</span><span class="p">);</span>
	<span class="n">b43_do_release_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">b43_do_release_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">initvals</span><span class="p">);</span>
	<span class="n">b43_do_release_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">initvals_band</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_print_fw_helptext</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">text</span><span class="p">[]</span> <span class="o">=</span>
		<span class="s">&quot;You must go to &quot;</span> \
		<span class="s">&quot;http://wireless.kernel.org/en/users/Drivers/b43#devicefirmware &quot;</span> \
		<span class="s">&quot;and download the correct firmware for this driver version. &quot;</span> \
		<span class="s">&quot;Please carefully read all instructions on this website.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43warn</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">text</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">b43_do_request_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_request_fw_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">b43_firmware_file</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">blob</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_fw_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t fetch anything. Free possibly cached firmware. */</span>
		<span class="cm">/* FIXME: We should probably keep it anyway, to save some headache</span>
<span class="cm">		 * on suspend/resume with multiband devices. */</span>
		<span class="n">b43_do_release_fw</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">filename</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Already have this fw. */</span>
		<span class="cm">/* Free the cached firmware first. */</span>
		<span class="cm">/* FIXME: We should probably do this later after we successfully</span>
<span class="cm">		 * got the new fw. This could reduce headache with multiband devices.</span>
<span class="cm">		 * We could also redesign this to cache the firmware for all possible</span>
<span class="cm">		 * bands all the time. */</span>
		<span class="n">b43_do_release_fw</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_FWTYPE_PROPRIETARY</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">),</span>
			 <span class="s">&quot;b43%s/%s.fw&quot;</span><span class="p">,</span>
			 <span class="n">modparam_fwpostfix</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_FWTYPE_OPENSOURCE</span>:
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">),</span>
			 <span class="s">&quot;b43-open%s/%s.fw&quot;</span><span class="p">,</span>
			 <span class="n">modparam_fwpostfix</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">blob</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">],</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">]),</span>
			 <span class="s">&quot;Firmware file </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">],</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">]),</span>
			 <span class="s">&quot;Firmware file </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> request failed (err=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_fw_header</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">b43_fw_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">blob</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_FW_TYPE_UCODE</span>:
	<span class="k">case</span> <span class="n">B43_FW_TYPE_PCM</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">blob</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_fw_header</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">B43_FW_TYPE_IV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ver</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">blob</span><span class="p">;</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">filename</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_format:</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">],</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">[</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span><span class="p">]),</span>
		 <span class="s">&quot;Firmware file </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> format error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">blob</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_try_request_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_request_fw_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmshigh</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Files for HT and LCN were found by trying one by one */</span>

	<span class="cm">/* Get microcode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode5&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode11&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode13&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode14&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">15</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode15&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">B43_PHYTYPE_N</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode16_mimo&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">err_no_ucode</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">B43_PHYTYPE_HT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode29_mimo&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">err_no_ucode</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">B43_PHYTYPE_LCN</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode24_mimo&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">err_no_ucode</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">err_no_ucode</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_do_request_fw</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ucode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_load</span><span class="p">;</span>

	<span class="cm">/* Get PCM code */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;pcm5&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
		<span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">err_no_pcm</span><span class="p">;</span>
	<span class="n">fw</span><span class="o">-&gt;</span><span class="n">pcm_request_failed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_do_request_fw</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We did not find a PCM file? Not fatal, but</span>
<span class="cm">		 * core rev &lt;= 10 must do without hwcrypto then. */</span>
		<span class="n">fw</span><span class="o">-&gt;</span><span class="n">pcm_request_failed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_load</span><span class="p">;</span>

	<span class="cm">/* Get initvals */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_A</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmshigh</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSHIGH</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmshigh</span> <span class="o">&amp;</span> <span class="n">B43_TMSHIGH_HAVE_2GHZ_PHY</span><span class="p">)</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;a0g1initvals5&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;a0g0initvals5&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_G</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;b0g0initvals5&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">13</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;b0g0initvals13&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_N</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;n0initvals16&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">))</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;n0initvals11&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;lp0initvals13&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;lp0initvals14&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;lp0initvals15&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_HT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ht0initvals29&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LCN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;lcn0initvals24&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_do_request_fw</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_load</span><span class="p">;</span>

	<span class="cm">/* Get bandswitch initvals */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_A</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmshigh</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSHIGH</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmshigh</span> <span class="o">&amp;</span> <span class="n">B43_TMSHIGH_HAVE_2GHZ_PHY</span><span class="p">)</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;a0g1bsinitvals5&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;a0g0bsinitvals5&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_G</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;b0g0bsinitvals5&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_N</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;n0bsinitvals16&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">12</span><span class="p">))</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;n0bsinitvals11&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;lp0bsinitvals13&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;lp0bsinitvals14&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;lp0bsinitvals15&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_HT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">29</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ht0bsinitvals29&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LCN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;lcn0bsinitvals24&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_do_request_fw</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_load</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_no_ucode:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fatal_failure</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;The driver does not know which firmware (ucode) &quot;</span>
	       <span class="s">&quot;is required for your device (wl-core rev %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">err_no_pcm:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fatal_failure</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;The driver does not know which firmware (PCM) &quot;</span>
	       <span class="s">&quot;is required for your device (wl-core rev %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">err_no_initvals:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fatal_failure</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;The driver does not know which firmware (initvals) &quot;</span>
	       <span class="s">&quot;is required for your device (wl-core rev %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">err_load:</span>
	<span class="cm">/* We failed to load this firmware image. The error message</span>
<span class="cm">	 * already is in ctx-&gt;errors. Return and let our caller decide</span>
<span class="cm">	 * what to do. */</span>
	<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">b43_release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">b43_one_core_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">b43_one_core_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">b43_wl</span><span class="p">,</span> <span class="n">firmware_load</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_request_fw_context</span> <span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errmsg</span><span class="p">;</span>

	<span class="n">ctx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctx</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span> <span class="o">=</span> <span class="n">B43_FWTYPE_PROPRIETARY</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_try_request_fw</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">start_ieee80211</span><span class="p">;</span> <span class="cm">/* Successfully loaded it. */</span>
	<span class="cm">/* Was fw version known? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fatal_failure</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* proprietary fw not found, try open source */</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">req_type</span> <span class="o">=</span> <span class="n">B43_FWTYPE_OPENSOURCE</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_try_request_fw</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">start_ieee80211</span><span class="p">;</span> <span class="cm">/* Successfully loaded it. */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fatal_failure</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Could not find a usable firmware. Print the errors. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">B43_NR_FWTYPES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">errmsg</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">errmsg</span><span class="p">))</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">start_ieee80211:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_one_core_detach</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_registred</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">b43_leds_register</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">err_one_core_detach:</span>
	<span class="n">b43_one_core_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_upload_microcode</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_fw_header</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fwrev</span><span class="p">,</span> <span class="n">fwpatch</span><span class="p">,</span> <span class="n">fwdate</span><span class="p">,</span> <span class="n">fwtime</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">macctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Jump the microcode PSM to offset 0 */</span>
	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">macctl</span> <span class="o">&amp;</span> <span class="n">B43_MACCTL_PSM_RUN</span><span class="p">);</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_PSM_JMP0</span><span class="p">;</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>
	<span class="cm">/* Zero out all microcode PSM registers and shared memory. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Upload Microcode. */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">ucode</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">ucode</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
	<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_UCODE</span> <span class="o">|</span> <span class="n">B43_SHM_AUTOINC_W</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Upload PCM data. */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
		<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_HW</span><span class="p">,</span> <span class="mh">0x01EA</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">,</span> <span class="mh">0x00004000</span><span class="p">);</span>
		<span class="cm">/* No need for autoinc bit in SHM_HW */</span>
		<span class="n">b43_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_HW</span><span class="p">,</span> <span class="mh">0x01EB</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_SHM_DATA</span><span class="p">,</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">,</span> <span class="n">B43_IRQ_ALL</span><span class="p">);</span>

	<span class="cm">/* Start the microcode PSM */</span>
	<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_PSM_JMP0</span><span class="p">,</span>
		      <span class="n">B43_MACCTL_PSM_RUN</span><span class="p">);</span>

	<span class="cm">/* Wait for the microcode to load and respond */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">B43_IRQ_MAC_SUSPENDED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Microcode not responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">b43_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>	<span class="cm">/* dummy read */</span>

	<span class="cm">/* Get and check the revisions. */</span>
	<span class="n">fwrev</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_UCODEREV</span><span class="p">);</span>
	<span class="n">fwpatch</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_UCODEPATCH</span><span class="p">);</span>
	<span class="n">fwdate</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_UCODEDATE</span><span class="p">);</span>
	<span class="n">fwtime</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_UCODETIME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwrev</span> <span class="o">&lt;=</span> <span class="mh">0x128</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;YOUR FIRMWARE IS TOO OLD. Firmware from &quot;</span>
		       <span class="s">&quot;binary drivers older than version 4.x is unsupported. &quot;</span>
		       <span class="s">&quot;You must upgrade your firmware files.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">b43_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">fwrev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">fwpatch</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">598</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_format</span> <span class="o">=</span> <span class="n">B43_FW_HDR_598</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">410</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_format</span> <span class="o">=</span> <span class="n">B43_FW_HDR_410</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_format</span> <span class="o">=</span> <span class="n">B43_FW_HDR_351</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">opensource</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwdate</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">);</span>

	<span class="cm">/* Default to use-all-queues. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_initially_registered_queues</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">qos_enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="n">modparam_qos</span><span class="p">;</span>
	<span class="cm">/* Default to firmware/hardware crypto acceleration. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwcrypto_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">opensource</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">fwcapa</span><span class="p">;</span>

		<span class="cm">/* Patchlevel info is encoded in the &quot;time&quot; field. */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">fwtime</span><span class="p">;</span>
		<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Loading OpenSource firmware version %u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">patch</span><span class="p">);</span>

		<span class="n">fwcapa</span> <span class="o">=</span> <span class="n">b43_fwcapa_read</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fwcapa</span> <span class="o">&amp;</span> <span class="n">B43_FWCAPA_HWCRYPTO</span><span class="p">)</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm_request_failed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Hardware crypto acceleration not supported by firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Disable hardware crypto and fall back to software crypto. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwcrypto_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fwcapa</span> <span class="o">&amp;</span> <span class="n">B43_FWCAPA_QOS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;QoS not supported by firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Disable QoS. Tweak hw-&gt;queues to 1. It will be restored before</span>
<span class="cm">			 * ieee80211_unregister to make sure the networking core can</span>
<span class="cm">			 * properly free possible resources. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">qos_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Loading firmware version %u.%u &quot;</span>
			<span class="s">&quot;(20%.2i-%.2i-%.2i %.2i:%.2i:%.2i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fwrev</span><span class="p">,</span> <span class="n">fwpatch</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fwdate</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="p">(</span><span class="n">fwdate</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="n">fwdate</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fwtime</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="p">(</span><span class="n">fwtime</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">,</span> <span class="n">fwtime</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm_request_failed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;No </span><span class="se">\&quot;</span><span class="s">pcm5.fw</span><span class="se">\&quot;</span><span class="s"> firmware file found. &quot;</span>
				<span class="s">&quot;Hardware accelerated cryptography is disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">b43_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span> <span class="s">&quot;%u.%u&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">patch</span><span class="p">);</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">hw_version</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_format</span> <span class="o">==</span> <span class="n">B43_FW_HDR_351</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We&#39;re over the deadline, but we keep support for old fw</span>
<span class="cm">		 * until it turns out to be in major conflict with something new. */</span>
		<span class="n">b43warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;You are using an old firmware image. &quot;</span>
			<span class="s">&quot;Support for old firmware will be removed soon &quot;</span>
			<span class="s">&quot;(official deadline was July 2008).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">b43_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="cm">/* Stop the microcode PSM. */</span>
	<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_PSM_RUN</span><span class="p">,</span>
		      <span class="n">B43_MACCTL_PSM_JMP0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_write_initvals</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">b43_iv</span> <span class="o">*</span><span class="n">ivals</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">array_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_iv</span> <span class="o">*</span><span class="n">iv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bit32</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_iv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">iv</span> <span class="o">=</span> <span class="n">ivals</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">offset_size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
		<span class="n">array_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">offset_size</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">offset_size</span><span class="p">);</span>
		<span class="n">bit32</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">B43_IV_32BIT</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">&amp;=</span> <span class="n">B43_IV_OFFSET_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mh">0x1000</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bit32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d32</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
			<span class="n">array_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d32</span><span class="p">);</span>

			<span class="n">value</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d32</span><span class="p">);</span>
			<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43_iv</span> <span class="o">*</span><span class="p">)((</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iv</span> <span class="o">+</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">)</span> <span class="o">+</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d16</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
			<span class="n">array_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d16</span><span class="p">);</span>

			<span class="n">value</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d16</span><span class="p">);</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43_iv</span> <span class="o">*</span><span class="p">)((</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iv</span> <span class="o">+</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">)</span> <span class="o">+</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_format:</span>
	<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Initial Values Firmware file-format error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">b43_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_upload_initvals</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_fw_header</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_fw_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_iv</span> <span class="o">*</span><span class="n">ivals</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43_fw_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">ivals</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43_iv</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_write_initvals</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ivals</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
				 <span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="p">.</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43_fw_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ivals</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43_iv</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_write_initvals</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ivals</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
					 <span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="p">.</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the GPIOs</span>
<span class="cm"> * http://bcm-specs.sipsolutions.net/GPIO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="nf">b43_ssb_gpio_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SSB_DRIVER_PCICORE</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span> <span class="o">?</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span> <span class="o">:</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_gpio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">gpiodev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_GPOUTSMSK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_maskset16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GPIO_MASK</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0xF</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0000001F</span><span class="p">;</span>
	<span class="n">set</span> <span class="o">=</span> <span class="mh">0x0000000F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4301</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x0060</span><span class="p">;</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="mh">0x0060</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x5354</span><span class="p">)</span>
		<span class="n">set</span> <span class="o">&amp;=</span> <span class="mh">0xff02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="cm">/* FIXME: conditional unknown */</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GPIO_MASK</span><span class="p">,</span>
			    <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GPIO_MASK</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x0180</span><span class="p">;</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="mh">0x0180</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_PACTRL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GPIO_MASK</span><span class="p">,</span>
			    <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GPIO_MASK</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x0200</span><span class="p">;</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="mh">0x0200</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x0010</span><span class="p">;</span>	<span class="cm">/* FIXME: This is redundant. */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="n">bcma_cc_write32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_cc</span><span class="p">,</span> <span class="n">BCMA_CC_GPIOCTL</span><span class="p">,</span>
				<span class="p">(</span><span class="n">bcma_cc_read32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_cc</span><span class="p">,</span>
					<span class="n">BCMA_CC_GPIOCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">set</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="n">gpiodev</span> <span class="o">=</span> <span class="n">b43_ssb_gpio_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpiodev</span><span class="p">)</span>
			<span class="n">ssb_write32</span><span class="p">(</span><span class="n">gpiodev</span><span class="p">,</span> <span class="n">B43_GPIO_CONTROL</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">ssb_read32</span><span class="p">(</span><span class="n">gpiodev</span><span class="p">,</span> <span class="n">B43_GPIO_CONTROL</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">set</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Turn off all GPIO stuff. Call this on module unload, for example. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_gpio_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">gpiodev</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="n">bcma_cc_write32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_cc</span><span class="p">,</span> <span class="n">BCMA_CC_GPIOCTL</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="n">gpiodev</span> <span class="o">=</span> <span class="n">b43_ssb_gpio_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpiodev</span><span class="p">)</span>
			<span class="n">ssb_write32</span><span class="p">(</span><span class="n">gpiodev</span><span class="p">,</span> <span class="n">B43_GPIO_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/EnableMac */</span>
<span class="kt">void</span> <span class="nf">b43_mac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_FIRMWARE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">fwstate</span><span class="p">;</span>

		<span class="n">fwstate</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
					 <span class="n">B43_SHM_SH_UCODESTAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fwstate</span> <span class="o">!=</span> <span class="n">B43_SHM_SH_UCODESTAT_SUSP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">fwstate</span> <span class="o">!=</span> <span class="n">B43_SHM_SH_UCODESTAT_SLEEP</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;b43_mac_enable(): The firmware &quot;</span>
			       <span class="s">&quot;should be suspended, but current state is %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fwstate</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span><span class="o">--</span><span class="p">;</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">B43_MACCTL_ENABLED</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">,</span>
			    <span class="n">B43_IRQ_MAC_SUSPENDED</span><span class="p">);</span>
		<span class="cm">/* Commit writes */</span>
		<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
		<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
		<span class="n">b43_power_saving_ctl_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/SuspendMAC */</span>
<span class="kt">void</span> <span class="nf">b43_mac_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_power_saving_ctl_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_PS_AWAKE</span><span class="p">);</span>
		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_ENABLED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* force pci to flush the write */</span>
		<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">35</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_MAC_SUSPENDED</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Hm, it seems this will take some time. Use msleep(). */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_IRQ_MAC_SUSPENDED</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;MAC suspend failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-v4.sipsolutions.net/802.11/PHY/N/MacPhyClkSet */</span>
<span class="kt">void</span> <span class="nf">b43_mac_phy_clock_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">bcma_aread32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">B43_BCMA_IOCTL_MACPHYCLKEN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_BCMA_IOCTL_MACPHYCLKEN</span><span class="p">;</span>
		<span class="n">bcma_awrite32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">B43_TMSLOW_MACPHYCLKEN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_TMSLOW_MACPHYCLKEN</span><span class="p">;</span>
		<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_adjust_opmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cfp_pretbtt</span><span class="p">;</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
	<span class="cm">/* Reset status to STA infrastructure mode. */</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_AP</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_KEEP_CTL</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_KEEP_BADPLCP</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_KEEP_BAD</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_PROMISC</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_BEACPROMISC</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_INFRA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">))</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_AP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_MACCTL_INFRA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_KEEP_CTL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_KEEP_BAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PLCPFAIL</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_KEEP_BADPLCP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_PROMISC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_BEACPROMISC</span><span class="p">;</span>

	<span class="cm">/* Workaround: On old hardware the HW-MAC-address-filter</span>
<span class="cm">	 * doesn&#39;t work properly, so always run promisc in filter</span>
<span class="cm">	 * it in software. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_PROMISC</span><span class="p">;</span>

	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>

	<span class="n">cfp_pretbtt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">B43_MACCTL_INFRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">B43_MACCTL_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4306</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">cfp_pretbtt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfp_pretbtt</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x612</span><span class="p">,</span> <span class="n">cfp_pretbtt</span><span class="p">);</span>

	<span class="cm">/* FIXME: We don&#39;t currently implement the PMQ mechanism,</span>
<span class="cm">	 *        so always disable it. If we want to implement PMQ,</span>
<span class="cm">	 *        we need to enable it here (clear DISCPMQ) in AP mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span>  <span class="cm">/* ctl &amp; B43_MACCTL_AP */</span><span class="p">)</span>
		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_DISCPMQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">B43_MACCTL_DISCPMQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_rate_memory_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rate</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_ofdm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x480</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">b43_plcp_get_ratecode_ofdm</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x4C0</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">b43_plcp_get_ratecode_cck</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span>
			<span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_rate_memory_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_A</span>:
	<span class="k">case</span> <span class="n">B43_PHYTYPE_G</span>:
	<span class="k">case</span> <span class="n">B43_PHYTYPE_N</span>:
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LP</span>:
	<span class="k">case</span> <span class="n">B43_PHYTYPE_HT</span>:
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LCN</span>:
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_OFDM_RATE_6MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_OFDM_RATE_12MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_OFDM_RATE_18MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_OFDM_RATE_24MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_OFDM_RATE_36MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_OFDM_RATE_48MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_OFDM_RATE_54MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_A</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_B</span>:
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_CCK_RATE_1MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_CCK_RATE_2MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_CCK_RATE_5MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_CCK_RATE_11MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Set the default values for the PHY TX Control Words. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_phytxctl_defaults</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_TXH_PHY_ENC_CCK</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_TXH_PHY_ANT01AUTO</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43_TXH_PHY_TXPWR</span><span class="p">;</span>

	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_BEACPHYCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_ACKCTSPHYCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_PRPHYCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the TX-Antenna for management frames sent by firmware. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_mgmtframe_txantenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ant</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">ant</span> <span class="o">=</span> <span class="n">b43_antenna_to_phyctl</span><span class="p">(</span><span class="n">antenna</span><span class="p">);</span>

	<span class="cm">/* For ACK/CTS */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_ACKCTSPHYCTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_TXH_PHY_ANT</span><span class="p">)</span> <span class="o">|</span> <span class="n">ant</span><span class="p">;</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_ACKCTSPHYCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* For Probe Resposes */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_PRPHYCTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_TXH_PHY_ANT</span><span class="p">)</span> <span class="o">|</span> <span class="n">ant</span><span class="p">;</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_PRPHYCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This is the opposite of b43_chip_init() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_chip_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43_phy_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_gpio_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* firmware is released later */</span>
<span class="p">}</span>

<span class="cm">/* Initialize the chip</span>
<span class="cm"> * http://bcm-specs.sipsolutions.net/ChipInit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value16</span><span class="p">;</span>

	<span class="cm">/* Initialize the MAC control */</span>
	<span class="n">macctl</span> <span class="o">=</span> <span class="n">B43_MACCTL_IHR_ENABLED</span> <span class="o">|</span> <span class="n">B43_MACCTL_SHM_ENABLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_GMODE</span><span class="p">;</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43_MACCTL_INFRA</span><span class="p">;</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_upload_microcode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>	<span class="cm">/* firmware is released later */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_gpio_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>	<span class="cm">/* firmware is released later */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_upload_initvals</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_gpio_clean</span><span class="p">;</span>

	<span class="cm">/* Turn the Analog on and initialize the PHY. */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">switch_analog</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_phy_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_gpio_clean</span><span class="p">;</span>

	<span class="cm">/* Disable Interference Mitigation. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">interf_mitigation</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">interf_mitigation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_INTERFMODE_NONE</span><span class="p">);</span>

	<span class="cm">/* Select the antennae */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rx_antenna</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rx_antenna</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_ANTENNA_DEFAULT</span><span class="p">);</span>
	<span class="n">b43_mgmtframe_txantenna</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_ANTENNA_DEFAULT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value16</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005E</span><span class="p">);</span>
		<span class="n">value16</span> <span class="o">|=</span> <span class="mh">0x0004</span><span class="p">;</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005E</span><span class="p">,</span> <span class="n">value16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x01000000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x010C</span><span class="p">,</span> <span class="mh">0x01000000</span><span class="p">);</span>

	<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_INFRA</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">B43_MACCTL_INFRA</span><span class="p">);</span>

	<span class="cm">/* Probe Response Timeout value */</span>
	<span class="cm">/* FIXME: Default to 0, has to be set by ioctl probably... :-/ */</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0074</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Initially set the wireless operation mode. */</span>
	<span class="n">b43_adjust_opmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x060E</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0610</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0604</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0606</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0188</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x018C</span><span class="p">,</span> <span class="mh">0x02000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_REASON</span><span class="p">,</span> <span class="mh">0x00004000</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA0_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0001DC00</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA1_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0000DC00</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA2_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0000DC00</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA3_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0001DC00</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA4_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0000DC00</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_DMA5_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0000DC00</span><span class="p">);</span>

	<span class="n">b43_mac_phy_clock_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="cm">/* FIXME: 0xE74 is quite common, but should be read from CC */</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_POWERUP_DELAY</span><span class="p">,</span> <span class="mh">0xE74</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_POWERUP_DELAY</span><span class="p">,</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">fast_pwrup_delay</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Chip initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_gpio_clean:</span>
	<span class="n">b43_gpio_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_periodic_every60sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43_phy_operations</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pwork_60sec</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">pwork_60sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Force check the TX power emission now. */</span>
	<span class="n">b43_phy_txpower_check</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_TXPWR_IGNORE_TIME</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_periodic_every30sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Update device statistics. */</span>
	<span class="n">b43_calculate_link_quality</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_periodic_every15sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">wdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">opensource</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Check if the firmware is still alive.</span>
<span class="cm">		 * It will reset the watchdog counter to 0 in its idle loop. */</span>
		<span class="n">wdr</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">B43_WATCHDOG_REG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Firmware watchdog: The firmware died!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">b43_controller_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Firmware watchdog&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span>
					<span class="n">B43_WATCHDOG_REG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pwork_15sec</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">pwork_15sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">txerr_cnt</span><span class="p">,</span> <span class="n">B43_PHY_TX_BADNESS_LIMIT</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>

<span class="cp">#if B43_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_VERBOSESTATS</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Stats: %7u IRQs/sec, %7u TX/sec, %7u RX/sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_count</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">/</span> <span class="mi">15</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_bit_count</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_bit_count</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Stats: %7u IRQ-%02u/sec (0x%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_bit_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="mi">15</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">));</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_bit_count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_periodic_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43_periodic_every60sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43_periodic_every30sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_periodic_every15sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Periodic work locking policy:</span>
<span class="cm"> * 	The whole periodic work handler is protected by</span>
<span class="cm"> * 	wl-&gt;mutex. If another lock is needed somewhere in the</span>
<span class="cm"> * 	pwork callchain, it&#39;s acquired in-place, where it&#39;s needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_periodic_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43_wldev</span><span class="p">,</span>
					     <span class="n">periodic_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43_STAT_STARTED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_PWORK_STOP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_requeue</span><span class="p">;</span>

	<span class="n">do_periodic_work</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_state</span><span class="o">++</span><span class="p">;</span>
<span class="nl">out_requeue:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DBG_PWORK_FAST</span><span class="p">))</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_periodic_tasks_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">work</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_work</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">b43_periodic_work_handler</span><span class="p">);</span>
	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Check if communication with the device works correctly. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_validate_chipaccess</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">,</span> <span class="n">backup0</span><span class="p">,</span> <span class="n">backup4</span><span class="p">;</span>

	<span class="n">backup0</span> <span class="o">=</span> <span class="n">b43_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">backup4</span> <span class="o">=</span> <span class="n">b43_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Check for read/write and endianness problems. */</span>
	<span class="n">b43_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x55AAAA55</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55AAAA55</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">b43_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xAA5555AA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAA5555AA</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Check if unaligned 32bit SHM_SHARED access works properly.</span>
<span class="cm">	 * However, don&#39;t bail out on failure, because it&#39;s noncritical. */</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x1122</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x3344</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x5566</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mh">0x7788</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x55663344</span><span class="p">)</span>
		<span class="n">b43warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Unaligned 32bit SHM read access is broken</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">b43_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0xAABBCCDD</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x1122</span> <span class="o">||</span>
	    <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xCCDD</span> <span class="o">||</span>
	    <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xAABB</span> <span class="o">||</span>
	    <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x7788</span><span class="p">)</span>
		<span class="n">b43warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Unaligned 32bit SHM write access is broken</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">b43_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">backup0</span><span class="p">);</span>
	<span class="n">b43_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">backup4</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* The 32bit register shadows the two 16bit registers</span>
<span class="cm">		 * with update sideeffects. Validate this. */</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CFP_START</span><span class="p">,</span> <span class="mh">0xAAAA</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CFP_START</span><span class="p">,</span> <span class="mh">0xCCCCBBBB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CFP_START_LOW</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xBBBB</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CFP_START_HIGH</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xCCCC</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CFP_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">|=</span> <span class="n">B43_MACCTL_GMODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">!=</span> <span class="p">(</span><span class="n">B43_MACCTL_GMODE</span> <span class="o">|</span> <span class="n">B43_MACCTL_IHR_ENABLED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Failed to validate the chipaccess</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_security_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ktp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_KTP</span><span class="p">);</span>
	<span class="cm">/* KTP is a word address, but we address SHM bytewise.</span>
<span class="cm">	 * So multiply by two.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ktp</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Number of RCMTA address slots */</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RCMTA_COUNT</span><span class="p">,</span> <span class="n">B43_NR_PAIRWISE_KEYS</span><span class="p">);</span>
	<span class="cm">/* Clear the key memory. */</span>
	<span class="n">b43_clear_keys</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_B43_HWRNG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_rng_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwrng</span> <span class="o">*</span><span class="n">rng</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="p">)</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RNG</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_B43_HWRNG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_rng_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_HWRNG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_initialized</span><span class="p">)</span>
		<span class="n">hwrng_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_B43_HWRNG */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_rng_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_B43_HWRNG</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_name</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_name</span><span class="p">),</span>
		 <span class="s">&quot;%s_%s&quot;</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">));</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_name</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">data_read</span> <span class="o">=</span> <span class="n">b43_rng_read</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_initialized</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hwrng_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_initialized</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Failed to register the random &quot;</span>
		       <span class="s">&quot;number generator (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_B43_HWRNG */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_tx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43_wl</span><span class="p">,</span> <span class="n">tx_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_STARTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">queue_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue_num</span> <span class="o">&lt;</span> <span class="n">B43_QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">queue_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b43_using_pio_transfers</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">b43_pio_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">b43_dma_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue_num</span><span class="p">);</span>
				<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span> <span class="cm">/* Drop it */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#if B43_DEBUG</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too short, this can&#39;t be a valid frame. */</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_qos_params_upload</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				  <span class="n">u16</span> <span class="n">shm_offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">params</span><span class="p">[</span><span class="n">B43_NR_QOSPARAMS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">bslots</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qos_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bslots</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RNG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">params</span><span class="p">));</span>

	<span class="n">params</span><span class="p">[</span><span class="n">B43_QOSPARAM_TXOP</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">txop</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="n">B43_QOSPARAM_CWMIN</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="n">B43_QOSPARAM_CWMAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="n">B43_QOSPARAM_CWCUR</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="n">B43_QOSPARAM_AIFS</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="n">B43_QOSPARAM_BSLOTS</span><span class="p">]</span> <span class="o">=</span> <span class="n">bslots</span><span class="p">;</span>
	<span class="n">params</span><span class="p">[</span><span class="n">B43_QOSPARAM_REGGAP</span><span class="p">]</span> <span class="o">=</span> <span class="n">bslots</span> <span class="o">+</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">B43_QOSPARAM_STATUS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
					     <span class="n">shm_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">));</span>
			<span class="cm">/* Mark the parameters as updated. */</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x100</span><span class="p">;</span>
			<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
					<span class="n">shm_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
					<span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
					<span class="n">shm_offset</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
					<span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Mapping of mac80211 queue numbers to b43 QoS SHM offsets. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">b43_qos_shm_offsets</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* [mac80211-queue-nr] = SHM_OFFSET, */</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">B43_QOS_VOICE</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">B43_QOS_VIDEO</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">B43_QOS_BESTEFFORT</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">B43_QOS_BACKGROUND</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Update all QOS parameters in hardware. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_qos_upload_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_qos_params</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qos_enabled</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b43_qos_shm_offsets</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">));</span>

	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">b43_qos_params_upload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">),</span>
				      <span class="n">b43_qos_shm_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_qos_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_qos_params</span> <span class="o">*</span><span class="n">params</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Initialize QoS parameters to sane defaults. */</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b43_qos_shm_offsets</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">params</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">b43_qos_shm_offsets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">B43_QOS_VOICE</span>:
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">B43_QOS_VIDEO</span>:
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">B43_QOS_BESTEFFORT</span>:
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="mh">0x03FF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">B43_QOS_BACKGROUND</span>:
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">aifs</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cw_min</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">params</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">cw_max</span> <span class="o">=</span> <span class="mh">0x03FF</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Initialize the core&#39;s QOS capabilities */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_qos_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">qos_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable QOS support. */</span>
		<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_HF_EDCF</span><span class="p">);</span>
		<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_IFSCTL</span><span class="p">,</span>
			    <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_IFSCTL</span><span class="p">)</span>
			    <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_MMIO_IFSCTL_USE_EDCF</span><span class="p">);</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;QoS disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Upload the current QOS parameters. */</span>
	<span class="n">b43_qos_upload_all</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enable QOS support. */</span>
	<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_HF_EDCF</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_IFSCTL</span><span class="p">,</span>
		    <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_IFSCTL</span><span class="p">)</span>
		    <span class="o">|</span> <span class="n">B43_MMIO_IFSCTL_USE_EDCF</span><span class="p">);</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;QoS enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_op_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">_queue</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">queue</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">_queue</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">queue</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Queue not available or don&#39;t support setting</span>
<span class="cm">		 * params on this queue. Return success to not</span>
<span class="cm">		 * confuse mac80211. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b43_qos_shm_offsets</span><span class="p">)</span> <span class="o">!=</span>
		     <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">p</span><span class="p">),</span> <span class="n">params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">));</span>
	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_qos_params_upload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">p</span><span class="p">),</span>
			      <span class="n">b43_qos_shm_offsets</span><span class="p">[</span><span class="n">queue</span><span class="p">]);</span>
	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_op_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">b43_op_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">tsf</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">))</span>
		<span class="n">b43_tsf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tsf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tsf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tsf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_set_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">))</span>
		<span class="n">b43_tsf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_put_phy_into_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span>
		       <span class="s">&quot;Putting PHY into reset not supported on BCMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_TMSLOW_GMODE</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">B43_TMSLOW_PHYRESET</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">SSB_TMSLOW_FGC</span><span class="p">;</span>
		<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_TMSLOW_FGC</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">B43_TMSLOW_PHYRESET</span><span class="p">;</span>
		<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">band_to_string</span><span class="p">(</span><span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="k">return</span> <span class="s">&quot;5&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="k">return</span> <span class="s">&quot;2.4&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Expects wl-&gt;mutex locked */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_switch_band</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">up_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">down_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">gmode</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">prev_status</span><span class="p">;</span>

	<span class="cm">/* Find a device and PHY which supports the band. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">supports_5ghz</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">up_dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
				<span class="n">gmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">supports_2ghz</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">up_dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
				<span class="n">gmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up_dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">up_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Could not find a device for %s-GHz band operation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">band_to_string</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">up_dev</span> <span class="o">==</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">==</span> <span class="o">!!</span><span class="n">gmode</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* This device is already running. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Switching to %s-GHz band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">band_to_string</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">));</span>
	<span class="n">down_dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="n">prev_status</span> <span class="o">=</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">down_dev</span><span class="p">);</span>
	<span class="cm">/* Shutdown the currently running core. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span>
		<span class="n">down_dev</span> <span class="o">=</span> <span class="n">b43_wireless_core_stop</span><span class="p">(</span><span class="n">down_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="n">b43_wireless_core_exit</span><span class="p">(</span><span class="n">down_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_dev</span> <span class="o">!=</span> <span class="n">up_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We switch to a different core, so we put PHY into</span>
<span class="cm">		 * RESET on the old core. */</span>
		<span class="n">b43_put_phy_into_reset</span><span class="p">(</span><span class="n">down_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Now start the new core. */</span>
	<span class="n">up_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">=</span> <span class="n">gmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_wireless_core_init</span><span class="p">(</span><span class="n">up_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Fatal: Could not initialize device for &quot;</span>
			       <span class="s">&quot;selected %s-GHz band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">band_to_string</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">init_failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_wireless_core_start</span><span class="p">(</span><span class="n">up_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Fatal: Could not start device for &quot;</span>
			       <span class="s">&quot;selected %s-GHz band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">band_to_string</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">));</span>
			<span class="n">b43_wireless_core_exit</span><span class="p">(</span><span class="n">up_dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">init_failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">up_dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_status</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">=</span> <span class="n">up_dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">init_failure:</span>
	<span class="cm">/* Whoops, failed to init the new core. No core is operating now. */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write the short and long frame retry limit values. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_retry_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">short_retry</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">long_retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The retry limit is a 4-bit counter. Enforce this to avoid overflowing</span>
<span class="cm">	 * the chip-internal counter. */</span>
	<span class="n">short_retry</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">short_retry</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mh">0xF</span><span class="p">);</span>
	<span class="n">long_retry</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">long_retry</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mh">0xF</span><span class="p">);</span>

	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">B43_SHM_SC_SRLIMIT</span><span class="p">,</span>
			<span class="n">short_retry</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">B43_SHM_SC_LRLIMIT</span><span class="p">,</span>
			<span class="n">long_retry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_op_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">reload_bss</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="cm">/* Switch the band (if necessary). This might change the active core. */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_switch_band</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock_mutex</span><span class="p">;</span>

	<span class="cm">/* Need to reload all settings if the core changed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">reload_bss</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">is_40mhz</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">conf_is_ht40_minus</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">||</span> <span class="n">conf_is_ht40_plus</span><span class="p">(</span><span class="n">conf</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">)</span>
		<span class="n">b43_set_retry_limits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">short_frame_max_tx_count</span><span class="p">,</span>
					  <span class="n">conf</span><span class="o">-&gt;</span><span class="n">long_frame_max_tx_count</span><span class="p">);</span>
	<span class="n">changed</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">changed</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mac_enable</span><span class="p">;</span>

	<span class="cm">/* Switch to the requested channel.</span>
<span class="cm">	 * The firmware takes care of races with the TX handler. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">b43_switch_channel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">radiotap_enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_MONITOR</span><span class="p">);</span>

	<span class="cm">/* Adjust the desired TX power level. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">desired_txpower</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">desired_txpower</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
			<span class="n">b43_phy_txpower_check</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_TXPWR_IGNORE_TIME</span> <span class="o">|</span>
						   <span class="n">B43_TXPWR_IGNORE_TSSI</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Antennas for RX and management frame TX. */</span>
	<span class="n">antenna</span> <span class="o">=</span> <span class="n">B43_ANTENNA_DEFAULT</span><span class="p">;</span>
	<span class="n">b43_mgmtframe_txantenna</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">antenna</span><span class="p">);</span>
	<span class="n">antenna</span> <span class="o">=</span> <span class="n">B43_ANTENNA_DEFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rx_antenna</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rx_antenna</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">antenna</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">radio_enabled</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">radio_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_software_rfkill</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
			<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Radio turned on by software</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_hw_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;The hardware RF-kill button &quot;</span>
					<span class="s">&quot;still turns the radio physically off. &quot;</span>
					<span class="s">&quot;Press the button to turn it on.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_software_rfkill</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
			<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Radio turned off by software</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out_mac_enable:</span>
	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out_unlock_mutex:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">&amp;&amp;</span> <span class="n">reload_bss</span><span class="p">)</span>
		<span class="n">b43_op_bss_info_changed</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_update_basic_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">brates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span> <span class="o">=</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">b43_current_band</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">basic</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">basic_offset</span><span class="p">,</span> <span class="n">rateptr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b43_is_cck_rate</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">direct</span> <span class="o">=</span> <span class="n">B43_SHM_SH_CCKDIRECT</span><span class="p">;</span>
			<span class="n">basic</span> <span class="o">=</span> <span class="n">B43_SHM_SH_CCKBASIC</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">b43_plcp_get_ratecode_cck</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">direct</span> <span class="o">=</span> <span class="n">B43_SHM_SH_OFDMDIRECT</span><span class="p">;</span>
			<span class="n">basic</span> <span class="o">=</span> <span class="n">B43_SHM_SH_OFDMBASIC</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">b43_plcp_get_ratecode_ofdm</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="n">ieee80211_get_response_rate</span><span class="p">(</span><span class="n">sband</span><span class="p">,</span> <span class="n">brates</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b43_is_cck_rate</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">basic_offset</span> <span class="o">=</span> <span class="n">b43_plcp_get_ratecode_cck</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="n">basic_offset</span> <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">basic_offset</span> <span class="o">=</span> <span class="n">b43_plcp_get_ratecode_ofdm</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="n">basic_offset</span> <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Get the pointer that we need to point to</span>
<span class="cm">		 * from the direct map</span>
<span class="cm">		 */</span>
		<span class="n">rateptr</span> <span class="o">=</span> <span class="n">b43_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
					 <span class="n">direct</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">basic_offset</span><span class="p">);</span>
		<span class="cm">/* and write it to the basic map */</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">basic</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">rateptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock_mutex</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">!=</span> <span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)))</span>
			<span class="n">b43_update_templates</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span>
			<span class="n">b43_write_mac_bssid_templates</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Update templates for AP/mesh mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">b43_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">)</span>
		<span class="n">b43_set_beacon_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BASIC_RATES</span><span class="p">)</span>
		<span class="n">b43_update_basic_rates</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">b43_short_slot_timing_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43_short_slot_timing_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out_unlock_mutex:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_op_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">algorithm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bcast_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modparam_nohwcrypt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span> <span class="cm">/* User disabled HW-crypto */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">||</span>
	     <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span> <span class="o">||</span>
	     <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For now, disable hw crypto for the RSN IBSS group keys. This</span>
<span class="cm">		 * could be optimized in the future, but until that gets</span>
<span class="cm">		 * implemented, use of software crypto for group addressed</span>
<span class="cm">		 * frames is a acceptable to allow RSN IBSS to be used.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm_request_failed</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwcrypto_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We don&#39;t have firmware for the crypto engine.</span>
<span class="cm">		 * Must use software-crypto. */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="n">algorithm</span> <span class="o">=</span> <span class="n">B43_SEC_ALGO_WEP40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">algorithm</span> <span class="o">=</span> <span class="n">B43_SEC_ALGO_WEP104</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">algorithm</span> <span class="o">=</span> <span class="n">B43_SEC_ALGO_TKIP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">algorithm</span> <span class="o">=</span> <span class="n">B43_SEC_ALGO_AES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">algorithm</span> <span class="o">==</span> <span class="n">B43_SEC_ALGO_TKIP</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">modparam_hwtkip</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* We support only pairwise key */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Pairwise key with an assigned MAC address. */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">b43_key_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span>
					    <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span>
					    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Group key */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">b43_key_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span>
					    <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">algorithm</span> <span class="o">==</span> <span class="n">B43_SEC_ALGO_WEP40</span> <span class="o">||</span>
		    <span class="n">algorithm</span> <span class="o">==</span> <span class="n">B43_SEC_ALGO_WEP104</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_HF_USEDEFKEYS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_HF_USEDEFKEYS</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">algorithm</span> <span class="o">==</span> <span class="n">B43_SEC_ALGO_TKIP</span><span class="p">)</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_MMIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>: <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_key_clear</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out_unlock:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43dbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;%s hardware based encryption for keyidx: %d, &quot;</span>
		       <span class="s">&quot;mac: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">cmd</span> <span class="o">==</span> <span class="n">SET_KEY</span> <span class="o">?</span> <span class="s">&quot;Using&quot;</span> <span class="o">:</span> <span class="s">&quot;Disabling&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span>
		       <span class="n">sta</span> <span class="o">?</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">:</span> <span class="n">bcast_addr</span><span class="p">);</span>
		<span class="n">b43_dump_keymemory</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">fflags</span><span class="p">,</span>
				    <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">fflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">fflags</span> <span class="o">&amp;=</span> <span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span>
		  <span class="n">FIF_ALLMULTI</span> <span class="o">|</span>
		  <span class="n">FIF_FCSFAIL</span> <span class="o">|</span>
		  <span class="n">FIF_PLCPFAIL</span> <span class="o">|</span>
		  <span class="n">FIF_CONTROL</span> <span class="o">|</span>
		  <span class="n">FIF_OTHER_BSS</span> <span class="o">|</span>
		  <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">;</span>

	<span class="n">changed</span> <span class="o">&amp;=</span> <span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span>
		   <span class="n">FIF_ALLMULTI</span> <span class="o">|</span>
		   <span class="n">FIF_FCSFAIL</span> <span class="o">|</span>
		   <span class="n">FIF_PLCPFAIL</span> <span class="o">|</span>
		   <span class="n">FIF_CONTROL</span> <span class="o">|</span>
		   <span class="n">FIF_OTHER_BSS</span> <span class="o">|</span>
		   <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">fflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="n">b43_adjust_opmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Locking: wl-&gt;mutex</span>
<span class="cm"> * Returns the current dev. This might be different from the passed in dev,</span>
<span class="cm"> * because the core might be gone away while we unlocked the mutex. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span> <span class="nf">b43_wireless_core_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">orig_dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
<span class="nl">redo:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Cancel work. Unlock to avoid deadlocks. */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">firmware_load</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Whoops, aliens ate up the device while we were unlocked. */</span>
		<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Disable interrupts on the device. */</span>
	<span class="n">b43_set_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_bus_host_is_sdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* wl-&gt;mutex is locked. That is enough. */</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* Flush */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hardirq_lock</span><span class="p">);</span>
		<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">);</span>	<span class="cm">/* Flush */</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hardirq_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Synchronize and free the interrupt handlers. Unlock to avoid deadlocks. */</span>
	<span class="n">orig_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_bus_host_is_sdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43_sdio_free_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="n">orig_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">redo</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">b43_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mh">0xFFFFFFFF</span> <span class="o">&amp;&amp;</span> <span class="n">mask</span><span class="p">);</span>

	<span class="cm">/* Drain all TX queues. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">queue_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue_num</span> <span class="o">&lt;</span> <span class="n">B43_QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">queue_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]))</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="n">b43_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_leds_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Wireless interface stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Locking: wl-&gt;mutex */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_wireless_core_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">);</span>

	<span class="n">drain_txstatus_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_bus_host_is_sdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_sdio_request_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_sdio_interrupt_handler</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Cannot request SDIO IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">b43_interrupt_handler</span><span class="p">,</span>
					   <span class="n">b43_interrupt_thread_handler</span><span class="p">,</span>
					   <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Cannot request IRQ-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We are ready to run. */</span>
	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">b43_set_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_STAT_STARTED</span><span class="p">);</span>

	<span class="cm">/* Start data flow (TX/RX). */</span>
	<span class="n">b43_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>

	<span class="cm">/* Start maintenance work */</span>
	<span class="n">b43_periodic_tasks_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43_leds_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Wireless interface started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get PHY and RADIO versioning numbers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_phy_versioning</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">analog_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_rev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_manuf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_ver</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_rev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unsupported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get PHY versioning */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_PHY_VER</span><span class="p">);</span>
	<span class="n">analog_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_PHYVER_ANALOG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">B43_PHYVER_ANALOG_SHIFT</span><span class="p">;</span>
	<span class="n">phy_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_PHYVER_TYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">B43_PHYVER_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">phy_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_PHYVER_VERSION</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">phy_rev</span> <span class="o">!=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">phy_rev</span> <span class="o">!=</span> <span class="mi">6</span>
		    <span class="o">&amp;&amp;</span> <span class="n">phy_rev</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_B43_PHY_N</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_N</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_PHY_LP</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_PHY_HT</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_HT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_PHY_LCN</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LCN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="nl">default:</span>
		<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unsupported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;FOUND UNSUPPORTED PHY &quot;</span>
		       <span class="s">&quot;(Analog %u, Type %u, Revision %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">analog_type</span><span class="p">,</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">phy_rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Found PHY: Analog %u, Type %u, Revision %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">analog_type</span><span class="p">,</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">phy_rev</span><span class="p">);</span>

	<span class="cm">/* Get RADIO versioning */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">radio24</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">tmp</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO24_CONTROL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">radio24</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO24_DATA</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Broadcom uses &quot;id&quot; for our &quot;ver&quot; and has separated &quot;ver&quot; */</span>
		<span class="cm">/* radio_ver = (radio24[0] &amp; 0xF0) &gt;&gt; 4; */</span>

		<span class="n">radio_manuf</span> <span class="o">=</span> <span class="mh">0x17F</span><span class="p">;</span>
		<span class="n">radio_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">radio24</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">radio24</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">radio_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">radio24</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4317</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x3205017F</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x4205017F</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x5205017F</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_CONTROL</span><span class="p">,</span>
				    <span class="n">B43_RADIOCTL_ID</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_DATA_LOW</span><span class="p">);</span>
			<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_CONTROL</span><span class="p">,</span>
				    <span class="n">B43_RADIOCTL_ID</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">b43_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_RADIO_DATA_HIGH</span><span class="p">)</span>
				<span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radio_manuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x00000FFF</span><span class="p">);</span>
		<span class="n">radio_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0FFFF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">radio_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xF0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">radio_manuf</span> <span class="o">!=</span> <span class="mh">0x17F</span> <span class="cm">/* Broadcom */</span><span class="p">)</span>
		<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_A</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2060</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_manuf</span> <span class="o">!=</span> <span class="mh">0x17F</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_B</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">radio_ver</span> <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_N</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2055</span> <span class="o">&amp;&amp;</span> <span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2056</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2062</span> <span class="o">&amp;&amp;</span> <span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2063</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_HT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2059</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43_PHYTYPE_LCN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2064</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unsupported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;FOUND UNSUPPORTED RADIO &quot;</span>
		       <span class="s">&quot;(Manuf 0x%X, Version 0x%X, Revision %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">radio_manuf</span><span class="p">,</span> <span class="n">radio_ver</span><span class="p">,</span> <span class="n">radio_rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Found Radio: Manuf 0x%X, Version 0x%X, Revision %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">radio_manuf</span><span class="p">,</span> <span class="n">radio_ver</span><span class="p">,</span> <span class="n">radio_rev</span><span class="p">);</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_manuf</span> <span class="o">=</span> <span class="n">radio_manuf</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">=</span> <span class="n">radio_ver</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">=</span> <span class="n">radio_rev</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">=</span> <span class="n">analog_type</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">phy_type</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">phy_rev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_struct_phy_for_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">hardware_power_control</span> <span class="o">=</span> <span class="o">!!</span><span class="n">modparam_hwpctl</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">next_txpwr_check_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="cm">/* PHY TX errors counter. */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">txerr_cnt</span><span class="p">,</span> <span class="n">B43_PHY_TX_BADNESS_LIMIT</span><span class="p">);</span>

<span class="cp">#if B43_DEBUG</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_locked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_locked</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_struct_wldev_for_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dfq_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Assume the radio is enabled. If it&#39;s not enabled, the state will</span>
<span class="cm">	 * immediately get fixed on the first periodic work run. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_hw_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* Stats */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>

	<span class="n">setup_struct_phy_for_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* IRQ related flags */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">B43_IRQ_MASKTEMPLATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_modparam_verbose</span> <span class="o">&lt;</span> <span class="n">B43_VERBOSITY_DEBUG</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_IRQ_PHY_TXERR</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Noise calculation context */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_bluetooth_coext_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modparam_btcoex</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_BTCOEXIST</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_B</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hf</span> <span class="o">=</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_BTCMOD</span><span class="p">)</span>
		<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_BTCOEXALT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_BTCOEX</span><span class="p">;</span>
	<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_bluetooth_coext_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">modparam_btcoex</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>TODO</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_imcfglo_timeouts_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">B43_BUS_SSB</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4311</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4312</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_IMCFGLO</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_IMCFGLO_REQTO</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_IMCFGLO_SERTO</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="mh">0x3</span><span class="p">;</span>
		<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_IMCFGLO</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">ssb_commit_settings</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_synth_pu_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">idle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pu_delay</span><span class="p">;</span>

	<span class="cm">/* The time value is in microseconds. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_A</span><span class="p">)</span>
		<span class="n">pu_delay</span> <span class="o">=</span> <span class="mi">3700</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pu_delay</span> <span class="o">=</span> <span class="mi">1050</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">||</span> <span class="n">idle</span><span class="p">)</span>
		<span class="n">pu_delay</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">pu_delay</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">pu_delay</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="mi">2400</span><span class="p">);</span>

	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_SPUWKUP</span><span class="p">,</span> <span class="n">pu_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the TSF CFP pre-TargetBeaconTransmissionTime. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_set_pretbtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pretbtt</span><span class="p">;</span>

	<span class="cm">/* The time value is in microseconds. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_is_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pretbtt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_A</span><span class="p">)</span>
			<span class="n">pretbtt</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pretbtt</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_PRETBTT</span><span class="p">,</span> <span class="n">pretbtt</span><span class="p">);</span>
	<span class="n">b43_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_TSF_CFP_PRETBTT</span><span class="p">,</span> <span class="n">pretbtt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Shutdown a wireless core */</span>
<span class="cm">/* Locking: wl-&gt;mutex */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_wireless_core_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Unregister HW RNG driver */</span>
	<span class="n">b43_rng_exit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">b43_set_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_STAT_UNINIT</span><span class="p">);</span>

	<span class="cm">/* Stop the microcode PSM. */</span>
	<span class="n">b43_maskset32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_MMIO_MACCTL</span><span class="p">,</span> <span class="o">~</span><span class="n">B43_MACCTL_PSM_RUN</span><span class="p">,</span>
		      <span class="n">B43_MACCTL_PSM_JMP0</span><span class="p">);</span>

	<span class="n">b43_dma_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_pio_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_chip_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">switch_analog</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b43_device_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_bus_may_powerdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialize a wireless core */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_wireless_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">hf</span><span class="p">;</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43_STAT_UNINIT</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_bus_powerup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43_device_is_enabled</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">b43_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">);</span>

	<span class="cm">/* Reset all data structures. */</span>
	<span class="n">setup_struct_wldev_for_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare_structs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enable IRQ routing to this device. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="n">bcma_core_pci_irq_ctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">drv_pci</span><span class="p">,</span>
				      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="n">ssb_pcicore_dev_irqvecs_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">b43_imcfglo_timeouts_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_bluetooth_coext_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare_hardware</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">prepare_hardware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_busdown</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_chip_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_busdown</span><span class="p">;</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span>
			<span class="n">B43_SHM_SH_WLCOREREV</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span><span class="p">);</span>
	<span class="n">hf</span> <span class="o">=</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_SYMW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_GDCW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_PACTRL</span><span class="p">)</span>
			<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_OFDMPABOOST</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_4318TSSI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
			<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_VCORECALC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_XTAL_NOSLOW</span><span class="p">)</span>
		<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_DSCRQ</span><span class="p">;</span> <span class="cm">/* Disable slowclock requests from ucode. */</span>
<span class="cp">#ifdef CONFIG_SSB_DRIVER_PCICORE</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">B43_BUS_SSB</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCI</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">.</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43_HF_PCISCW</span><span class="p">;</span> <span class="cm">/* PCI slow clock workaround. */</span>
<span class="cp">#endif</span>
	<span class="n">hf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_HF_SKCFPUP</span><span class="p">;</span>
	<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hf</span><span class="p">);</span>

	<span class="n">b43_set_retry_limits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_DEFAULT_SHORT_RETRY_LIMIT</span><span class="p">,</span>
			     <span class="n">B43_DEFAULT_LONG_RETRY_LIMIT</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_SFFBLIM</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_LFFBLIM</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Disable sending probe responses from firmware.</span>
<span class="cm">	 * Setting the MaxTime to one usec will always trigger</span>
<span class="cm">	 * a timeout, so we never send any probe resp.</span>
<span class="cm">	 * A timeout of zero is infinite. */</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SHARED</span><span class="p">,</span> <span class="n">B43_SHM_SH_PRMAXTIME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">b43_rate_memory_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_set_phytxctl_defaults</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Minimum Contention Window */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_B</span><span class="p">)</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">B43_SHM_SC_MINCONT</span><span class="p">,</span> <span class="mh">0x1F</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">B43_SHM_SC_MINCONT</span><span class="p">,</span> <span class="mh">0xF</span><span class="p">);</span>
	<span class="cm">/* Maximum Contention Window */</span>
	<span class="n">b43_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_SHM_SCRATCH</span><span class="p">,</span> <span class="n">B43_SHM_SC_MAXCONT</span><span class="p">,</span> <span class="mh">0x3FF</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_bus_host_is_pcmcia</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">b43_bus_host_is_sdio</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">__using_pio_transfers</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_pio_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">use_pio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43warn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Forced PIO by use_pio module parameter. &quot;</span>
			<span class="s">&quot;This should not be needed and will result in lower &quot;</span>
			<span class="s">&quot;performance.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">__using_pio_transfers</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_pio_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">__using_pio_transfers</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_dma_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_chip_exit</span><span class="p">;</span>
	<span class="n">b43_qos_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_set_synth_pu_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">b43_bluetooth_coext_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43_bus_powerup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">!</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43_BFL_XTAL_NOSLOW</span><span class="p">));</span>
	<span class="n">b43_upload_card_macaddress</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_security_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">b43_set_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">);</span>

	<span class="cm">/* Register HW RNG driver */</span>
	<span class="n">b43_rng_init</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_chip_exit:</span>
	<span class="n">b43_chip_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_busdown:</span>
	<span class="n">b43_bus_may_powerdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43_STAT_UNINIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_op_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* TODO: allow WDS/AP devices to coexist */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_WDS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">operating</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mutex_unlock</span><span class="p">;</span>

	<span class="n">b43dbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Adding Interface type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">operating</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">if_type</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">b43_adjust_opmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_set_pretbtt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_set_synth_pu_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_upload_card_macaddress</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_mutex_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43_op_bss_info_changed</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="n">b43dbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Removing Interface type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">operating</span><span class="p">);</span>
	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">!=</span> <span class="n">vif</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">operating</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">b43_adjust_opmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">b43_upload_card_macaddress</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_op_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">did_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Kill all old instance specific information to make sure</span>
<span class="cm">	 * the card won&#39;t use it in the short timeframe between start</span>
<span class="cm">	 * and mac80211 reconfiguring it. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">radiotap_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">b43_qos_clear</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon0_uploaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon1_uploaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_templates_virgin</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">radio_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_wireless_core_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_mutex_unlock</span><span class="p">;</span>
		<span class="n">did_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_wireless_core_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">did_init</span><span class="p">)</span>
				<span class="n">b43_wireless_core_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_mutex_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* XXX: only do if device doesn&#39;t support rfkill irq */</span>
	<span class="n">wiphy_rfkill_start_polling</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

 <span class="nl">out_mutex_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Configuration may have been overwritten during initialization.</span>
<span class="cm">	 * Reload the configuration, but only if initialization was</span>
<span class="cm">	 * successful. Reloading the configuration after a failed init</span>
<span class="cm">	 * may hang the system.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">b43_op_config</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_update_trigger</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">b43_wireless_core_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43_wireless_core_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">radio_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">txpower_adjust_work</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_op_beacon_set_tim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* FIXME: add locking */</span>
	<span class="n">b43_update_templates</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_sta_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">sta_notify_cmd</span> <span class="n">notify_cmd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">vif</span> <span class="o">||</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">!=</span> <span class="n">vif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_sw_scan_start_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Disable CFP update during scan on other channels. */</span>
		<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">|</span> <span class="n">B43_HF_SKCFPUP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_op_sw_scan_complete_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Re-enable CFP update. */</span>
		<span class="n">b43_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">b43_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43_HF_SKCFPUP</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_op_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_noise</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">b43_hw_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span>			<span class="o">=</span> <span class="n">b43_op_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span>		<span class="o">=</span> <span class="n">b43_op_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span>		<span class="o">=</span> <span class="n">b43_op_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span>	<span class="o">=</span> <span class="n">b43_op_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span>			<span class="o">=</span> <span class="n">b43_op_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span>	<span class="o">=</span> <span class="n">b43_op_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>	<span class="o">=</span> <span class="n">b43_op_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span>		<span class="o">=</span> <span class="n">b43_op_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_tkip_key</span>	<span class="o">=</span> <span class="n">b43_op_update_tkip_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>		<span class="o">=</span> <span class="n">b43_op_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tsf</span>		<span class="o">=</span> <span class="n">b43_op_get_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tsf</span>		<span class="o">=</span> <span class="n">b43_op_set_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>			<span class="o">=</span> <span class="n">b43_op_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>			<span class="o">=</span> <span class="n">b43_op_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tim</span>		<span class="o">=</span> <span class="n">b43_op_beacon_set_tim</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_notify</span>		<span class="o">=</span> <span class="n">b43_op_sta_notify</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_start</span>		<span class="o">=</span> <span class="n">b43_op_sw_scan_start_notifier</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_complete</span>	<span class="o">=</span> <span class="n">b43_op_sw_scan_complete_notifier</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_survey</span>		<span class="o">=</span> <span class="n">b43_op_get_survey</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rfkill_poll</span>		<span class="o">=</span> <span class="n">b43_rfkill_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Hard-reset the chip. Do not call this directly.</span>
<span class="cm"> * Use b43_controller_restart()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43_wldev</span><span class="p">,</span> <span class="n">restart_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev_status</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">prev_status</span> <span class="o">=</span> <span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Bring the device down... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">b43_wireless_core_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="n">b43_wireless_core_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* ...and up again. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_wireless_core_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43_wireless_core_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43_wireless_core_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Failed to init the dev. */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Controller restart FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* reload configuration */</span>
	<span class="n">b43_op_config</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span>
		<span class="n">b43_op_bss_info_changed</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">b43info</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Controller restarted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_setup_bands</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">have_2ghz_phy</span><span class="p">,</span> <span class="n">bool</span> <span class="n">have_5ghz_phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">have_2ghz_phy</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b43_band_2GHz</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_N</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">have_5ghz_phy</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b43_band_5GHz_nphy</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">have_5ghz_phy</span><span class="p">)</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">b43_band_5GHz_aphy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">supports_2ghz</span> <span class="o">=</span> <span class="n">have_2ghz_phy</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">supports_5ghz</span> <span class="o">=</span> <span class="n">have_5ghz_phy</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_wireless_core_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We release firmware that late to not be required to re-request</span>
<span class="cm">	 * is all the time when we reinit the core. */</span>
	<span class="n">b43_release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43_phy_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_wireless_core_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">have_2ghz_phy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="n">have_5ghz_phy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Do NOT do any device initialization here.</span>
<span class="cm">	 * Do it in wireless_core_init() instead.</span>
<span class="cm">	 * This function is for gathering basic information about the HW, only.</span>
<span class="cm">	 * Also some structs may be set up here. But most likely you want to have</span>
<span class="cm">	 * that in core_init(), too.</span>
<span class="cm">	 */</span>

<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">B43_BUS_SSB</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCI</span><span class="p">)</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_bus_powerup</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Bus powerup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get the PHY type. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="k">case</span> <span class="n">B43_BUS_BCMA</span>:
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">bcma_aread32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bdev</span><span class="p">,</span> <span class="n">BCMA_IOST</span><span class="p">);</span>
		<span class="n">have_2ghz_phy</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_BCMA_IOST_2G_PHY</span><span class="p">);</span>
		<span class="n">have_5ghz_phy</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_BCMA_IOST_5G_PHY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="k">case</span> <span class="n">B43_BUS_SSB</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSHIGH</span><span class="p">);</span>
			<span class="n">have_2ghz_phy</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_TMSHIGH_HAVE_2GHZ_PHY</span><span class="p">);</span>
			<span class="n">have_5ghz_phy</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43_TMSHIGH_HAVE_5GHZ_PHY</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">=</span> <span class="n">have_2ghz_phy</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">radio_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">b43_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_phy_versioning</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_powerdown</span><span class="p">;</span>
	<span class="cm">/* Check if this device supports multiband. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x4312</span> <span class="o">&amp;&amp;</span>
	     <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x4319</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x4324</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No multiband support. */</span>
		<span class="n">have_2ghz_phy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">have_5ghz_phy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">B43_PHYTYPE_A</span>:
			<span class="n">have_5ghz_phy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">B43_PHYTYPE_LP</span>: <span class="c1">//FIXME not always!</span>
<span class="cp">#if 0</span><span class="c"> //FIXME enabling 5GHz causes a NULL pointer dereference</span>
<span class="c">			have_5ghz_phy = 1;</span>
<span class="cp">#endif</span>
		<span class="k">case</span> <span class="n">B43_PHYTYPE_G</span>:
		<span class="k">case</span> <span class="n">B43_PHYTYPE_N</span>:
		<span class="k">case</span> <span class="n">B43_PHYTYPE_HT</span>:
		<span class="k">case</span> <span class="n">B43_PHYTYPE_LCN</span>:
			<span class="n">have_2ghz_phy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43_PHYTYPE_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME */</span>
		<span class="n">b43err</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11a devices are unsupported</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_powerdown</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="cm">/* disable A-PHY */</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME: For now we disable the A-PHY on multi-PHY devices. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_N</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43_PHYTYPE_LP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">have_2ghz_phy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">have_5ghz_phy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_phy_allocate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_powerdown</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">=</span> <span class="n">have_2ghz_phy</span><span class="p">;</span>
	<span class="n">b43_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_validate_chipaccess</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_phy_free</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_setup_bands</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">have_2ghz_phy</span><span class="p">,</span> <span class="n">have_5ghz_phy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_phy_free</span><span class="p">;</span>

	<span class="cm">/* Now set some default &quot;current_dev&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">,</span> <span class="n">b43_chip_reset</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">switch_analog</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_device_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43_bus_may_powerdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_phy_free:</span>
	<span class="n">b43_phy_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_powerdown:</span>
	<span class="n">b43_bus_may_powerdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_one_core_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">wldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>

	<span class="cm">/* Do not cancel ieee80211-workqueue based work here.</span>
<span class="cm">	 * See comment in b43_remove(). */</span>

	<span class="n">wldev</span> <span class="o">=</span> <span class="n">b43_bus_get_wldev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">wldev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">b43_debugfs_remove_device</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="n">b43_wireless_core_detach</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nr_devs</span><span class="o">--</span><span class="p">;</span>
	<span class="n">b43_bus_set_wldev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_one_core_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">wldev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">wldev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wldev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wldev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">use_pio</span> <span class="o">=</span> <span class="n">b43_modparam_pio</span><span class="p">;</span>
	<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">;</span>
	<span class="n">b43_set_status</span><span class="p">(</span><span class="n">wldev</span><span class="p">,</span> <span class="n">B43_STAT_UNINIT</span><span class="p">);</span>
	<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">bad_frames_preempt</span> <span class="o">=</span> <span class="n">modparam_bad_frames_preempt</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_wireless_core_attach</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_kfree_wldev</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nr_devs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">b43_bus_set_wldev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wldev</span><span class="p">);</span>
	<span class="n">b43_debugfs_add_device</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

      <span class="nl">err_kfree_wldev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IS_PDEV(pdev, _vendor, _device, _subvendor, _subdevice)		( \</span>
<span class="cp">	(pdev-&gt;vendor == PCI_VENDOR_ID_##_vendor) &amp;&amp;			\</span>
<span class="cp">	(pdev-&gt;device == _device) &amp;&amp;					\</span>
<span class="cp">	(pdev-&gt;subsystem_vendor == PCI_VENDOR_ID_##_subvendor) &amp;&amp;	\</span>
<span class="cp">	(pdev-&gt;subsystem_device == _subdevice)				)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_sprom_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

	<span class="cm">/* boardflags workarounds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">SSB_BOARDVENDOR_DELL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4301</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">board_rev</span> <span class="o">==</span> <span class="mh">0x74</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span> <span class="o">|=</span> <span class="n">B43_BFL_BTCOEXIST</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0x4E</span> <span class="o">&amp;&amp;</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">board_rev</span> <span class="o">&gt;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span> <span class="o">|=</span> <span class="n">B43_BFL_PACTRL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_PDEV</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BROADCOM</span><span class="p">,</span> <span class="mh">0x4318</span><span class="p">,</span> <span class="n">ASUSTEK</span><span class="p">,</span> <span class="mh">0x100F</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_PDEV</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BROADCOM</span><span class="p">,</span> <span class="mh">0x4320</span><span class="p">,</span>    <span class="n">DELL</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_PDEV</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BROADCOM</span><span class="p">,</span> <span class="mh">0x4320</span><span class="p">,</span>      <span class="n">HP</span><span class="p">,</span> <span class="mh">0x12f8</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_PDEV</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BROADCOM</span><span class="p">,</span> <span class="mh">0x4320</span><span class="p">,</span> <span class="n">LINKSYS</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_PDEV</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BROADCOM</span><span class="p">,</span> <span class="mh">0x4320</span><span class="p">,</span> <span class="n">LINKSYS</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_PDEV</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BROADCOM</span><span class="p">,</span> <span class="mh">0x4320</span><span class="p">,</span> <span class="n">LINKSYS</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">IS_PDEV</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">BROADCOM</span><span class="p">,</span> <span class="mh">0x4320</span><span class="p">,</span> <span class="n">MOTOROLA</span><span class="p">,</span> <span class="mh">0x7010</span><span class="p">))</span>
			<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43_BFL_BTCOEXIST</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_wireless_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ssb_set_devtypedata</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="nf">b43_wireless_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_sprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">chip_name</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">queue_num</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">b43_hw_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43err</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Could not allocate ieee80211 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* fill hw info */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span> <span class="o">|</span>
		    <span class="n">IEEE80211_HW_SIGNAL_DBM</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIPHY_FLAG_IBSS_RSN</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">modparam_qos</span> <span class="o">?</span> <span class="n">B43_QOS_QUEUE_NUM</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_initially_registered_queues</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_registred</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">et1mac</span><span class="p">))</span>
		<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">et1mac</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">il0mac</span><span class="p">);</span>

	<span class="cm">/* Initialize struct b43_wl */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hardirq_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_update_trigger</span><span class="p">,</span> <span class="n">b43_beacon_update_trigger_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">txpower_adjust_work</span><span class="p">,</span> <span class="n">b43_phy_txpower_adjust_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">b43_tx_work</span><span class="p">);</span>

	<span class="cm">/* Initialize queues and flags. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">queue_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue_num</span> <span class="o">&lt;</span> <span class="n">B43_QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">queue_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">chip_name</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip_name</span><span class="p">),</span>
		 <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">&gt;</span> <span class="mh">0x9999</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;%d&quot;</span> <span class="o">:</span> <span class="s">&quot;%04X&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
	<span class="n">b43info</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Broadcom %s WLAN found (core revision %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip_name</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">core_rev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_B43_BCMA</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43_bcma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">b43_bus_dev_bcma_init</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">b43_wireless_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">bcma_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_one_core_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">bcma_err_wireless_exit</span><span class="p">;</span>

	<span class="cm">/* setup and start work to load firmware */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">firmware_load</span><span class="p">,</span> <span class="n">b43_request_firmware</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">firmware_load</span><span class="p">);</span>

<span class="nl">bcma_out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">bcma_err_wireless_exit:</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_bcma_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">core</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">wldev</span> <span class="o">=</span> <span class="n">bcma_get_drvdata</span><span class="p">(</span><span class="n">core</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wldev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>

	<span class="cm">/* We must cancel any work here before unregistering from ieee80211,</span>
<span class="cm">	 * as the ieee80211 unreg will destroy the workqueue. */</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">==</span> <span class="n">wldev</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_registred</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Restore the queues count before unregistering, because firmware detect</span>
<span class="cm">		 * might have modified it. Restoring is important, so the networking</span>
<span class="cm">		 * stack can properly free resources. */</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_initially_registered_queues</span><span class="p">;</span>
		<span class="n">b43_leds_stop</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_one_core_detach</span><span class="p">(</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43_leds_unregister</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bcma_driver</span> <span class="n">b43_bcma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">b43_bcma_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">b43_bcma_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">b43_bcma_remove</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_B43_SSB</span>
<span class="k">static</span>
<span class="kt">int</span> <span class="nf">b43_ssb_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">b43_bus_dev_ssb_init</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">ssb_get_devtypedata</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Probing the first core. Must setup common struct b43_wl */</span>
		<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">b43_sprom_fixup</span><span class="p">(</span><span class="n">sdev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
		<span class="n">wl</span> <span class="o">=</span> <span class="n">b43_wireless_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ssb_set_devtypedata</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
		<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="n">ssb_get_devtypedata</span><span class="p">(</span><span class="n">sdev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_one_core_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_wireless_exit</span><span class="p">;</span>

	<span class="cm">/* setup and start work to load firmware */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">firmware_load</span><span class="p">,</span> <span class="n">b43_request_firmware</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">firmware_load</span><span class="p">);</span>

      <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

      <span class="nl">err_wireless_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
		<span class="n">b43_wireless_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_ssb_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">ssb_get_devtypedata</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">wldev</span> <span class="o">=</span> <span class="n">ssb_get_drvdata</span><span class="p">(</span><span class="n">sdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43_bus_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wldev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* We must cancel any work here before unregistering from ieee80211,</span>
<span class="cm">	 * as the ieee80211 unreg will destroy the workqueue. */</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>

	<span class="n">B43_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">==</span> <span class="n">wldev</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw_registred</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Restore the queues count before unregistering, because firmware detect</span>
<span class="cm">		 * might have modified it. Restoring is important, so the networking</span>
<span class="cm">		 * stack can properly free resources. */</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_initially_registered_queues</span><span class="p">;</span>
		<span class="n">b43_leds_stop</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43_one_core_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43_leds_unregister</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="cm">/* Last core on the chip unregistered.</span>
<span class="cm">		 * We can destroy common struct b43_wl.</span>
<span class="cm">		 */</span>
		<span class="n">b43_wireless_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ssb_driver</span> <span class="n">b43_ssb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">b43_ssb_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">b43_ssb_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">b43_ssb_remove</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_B43_SSB */</span><span class="cp"></span>

<span class="cm">/* Perform a hardware reset. This can be called from any context. */</span>
<span class="kt">void</span> <span class="nf">b43_controller_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Must avoid requeueing, if we are in shutdown. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Controller RESET (%s) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43_print_driverinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">feat_pci</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">feat_pcmcia</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">feat_nphy</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="o">*</span><span class="n">feat_leds</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">feat_sdio</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_B43_PCI_AUTOSELECT</span>
	<span class="n">feat_pci</span> <span class="o">=</span> <span class="s">&quot;P&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_PCMCIA</span>
	<span class="n">feat_pcmcia</span> <span class="o">=</span> <span class="s">&quot;M&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_PHY_N</span>
	<span class="n">feat_nphy</span> <span class="o">=</span> <span class="s">&quot;N&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_LEDS</span>
	<span class="n">feat_leds</span> <span class="o">=</span> <span class="s">&quot;L&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SDIO</span>
	<span class="n">feat_sdio</span> <span class="o">=</span> <span class="s">&quot;S&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Broadcom 43xx driver loaded &quot;</span>
	       <span class="s">&quot;[ Features: %s%s%s%s%s ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">feat_pci</span><span class="p">,</span> <span class="n">feat_pcmcia</span><span class="p">,</span> <span class="n">feat_nphy</span><span class="p">,</span>
	       <span class="n">feat_leds</span><span class="p">,</span> <span class="n">feat_sdio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">b43_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">b43_debugfs_init</span><span class="p">();</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_pcmcia_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dfs_exit</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43_sdio_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pcmcia_exit</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bcma_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b43_bcma_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_sdio_exit</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b43_ssb_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_bcma_driver_exit</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">b43_print_driverinfo</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_B43_SSB</span>
<span class="nl">err_bcma_driver_exit:</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="n">bcma_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b43_bcma_driver</span><span class="p">);</span>
<span class="nl">err_sdio_exit:</span>
<span class="cp">#endif</span>
	<span class="n">b43_sdio_exit</span><span class="p">();</span>
<span class="nl">err_pcmcia_exit:</span>
	<span class="n">b43_pcmcia_exit</span><span class="p">();</span>
<span class="nl">err_dfs_exit:</span>
	<span class="n">b43_debugfs_exit</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">b43_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43_SSB</span>
	<span class="n">ssb_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b43_ssb_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43_BCMA</span>
	<span class="n">bcma_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b43_bcma_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">b43_sdio_exit</span><span class="p">();</span>
	<span class="n">b43_pcmcia_exit</span><span class="p">();</span>
	<span class="n">b43_debugfs_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">b43_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">b43_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
