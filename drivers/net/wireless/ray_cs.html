<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ray_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ray_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*=============================================================================</span>
<span class="cm"> *</span>
<span class="cm"> * A  PCMCIA client driver for the Raylink wireless LAN card.</span>
<span class="cm"> * The starting point for this module was the skeleton.c in the</span>
<span class="cm"> * PCMCIA 2.9.12 package written by David Hinds, dahinds@users.sourceforge.net</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1998  Corey Thomas (corey@world.std.com)</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of version 2 only of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * It is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA</span>
<span class="cm"> *</span>
<span class="cm"> * Changes:</span>
<span class="cm"> * Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt; - 08/08/2000</span>
<span class="cm"> * - reorganize kmallocs in ray_attach, checking all for failure</span>
<span class="cm"> *   and releasing the previous allocations if one fails</span>
<span class="cm"> *</span>
<span class="cm"> * Daniele Bellucci &lt;bellucda@tiscali.it&gt; - 07/10/2003</span>
<span class="cm"> * - Audit copy_to_user in ioctl(SIOCGIWESSID)</span>
<span class="cm"> *</span>
<span class="cm">=============================================================================*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/cisreg.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>

<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cm">/* Warning : these stuff will slow down the driver... */</span>
<span class="cp">#define WIRELESS_SPY		</span><span class="cm">/* Enable spying addresses */</span><span class="cp"></span>
<span class="cm">/* Definitions we need for spy */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="n">iw_stats</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">u_char</span> <span class="n">mac_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>	<span class="cm">/* Hardware address */</span>

<span class="cp">#include &quot;rayctl.h&quot;</span>
<span class="cp">#include &quot;ray_cs.h&quot;</span>


<span class="cm">/** Prototypes based on PCMCIA skeleton driver *******************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ray_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ray_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ray_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">);</span>

<span class="cm">/***** Prototypes indicated by device structure ******************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ray_dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ray_dev_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmap</span> <span class="o">*</span><span class="n">map</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">ray_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ray_dev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ray_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">ray_dev_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ray_update_multi_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">all</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">translate_frame</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_msg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptx</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ray_build_header</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_msg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptx</span><span class="p">,</span>
			     <span class="n">UCHAR</span> <span class="n">msg_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">untranslate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="n">iw_stats</span> <span class="o">*</span><span class="n">ray_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">ray_handler_def</span><span class="p">;</span>

<span class="cm">/***** Prototypes for raylink functions **************************************/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">authenticate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">build_auth_frame</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">auth_type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">authenticate_timeout</span><span class="p">(</span><span class="n">u_long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_free_ccs</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_free_tx_ccs</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_startup_params</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">parse_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">in_str</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="n">out</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ray_hw_xmit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="n">type</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ray_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ccs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ray_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ray_update_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="n">objid</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">verify_dl_startup</span><span class="p">(</span><span class="n">u_long</span><span class="p">);</span>

<span class="cm">/* Prototypes for interrpt time functions **********************************/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">ray_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">clear_interrupt</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_deauthenticate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">copy_from_rx_buff</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">ray_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">release_frag_chain</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_authenticate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">associate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>

<span class="cm">/* Card command functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dl_startup_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">join_net</span><span class="p">(</span><span class="n">u_long</span> <span class="n">local</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">start_net</span><span class="p">(</span><span class="n">u_long</span> <span class="n">local</span><span class="p">);</span>
<span class="cm">/* void start_net(ray_dev_t *local); */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cm">/* Parameters that can be set with &#39;insmod&#39; */</span>

<span class="cm">/* ADHOC=0, Infrastructure=1 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">net_type</span> <span class="o">=</span> <span class="n">ADHOC</span><span class="p">;</span>

<span class="cm">/* Hop dwell time in Kus (1024 us units defined by 802.11) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hop_dwell</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>

<span class="cm">/* Beacon period in Kus */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">beacon_period</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>

<span class="cm">/* power save mode (0 = off, 1 = save power) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">psm</span><span class="p">;</span>

<span class="cm">/* String for network&#39;s Extended Service Set ID. 32 Characters max */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">essid</span><span class="p">;</span>

<span class="cm">/* Default to encapsulation unless translation requested */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">translate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">country</span> <span class="o">=</span> <span class="n">USA</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sniffer</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">bc</span><span class="p">;</span>

<span class="cm">/* 48 bit physical card address if overriding card&#39;s real physical</span>
<span class="cm"> * address is required.  Since IEEE 802.11 addresses are 48 bits</span>
<span class="cm"> * like ethernet, an int can&#39;t be used, so a string is used. To</span>
<span class="cm"> * allow use of addresses starting with a decimal digit, the first</span>
<span class="cm"> * character must be a letter and will be ignored. This letter is</span>
<span class="cm"> * followed by up to 12 hex digits which are the address.  If less</span>
<span class="cm"> * than 12 digits are used, the address will be left filled with 0&#39;s.</span>
<span class="cm"> * Note that bit 0 of the first byte is the broadcast bit, and evil</span>
<span class="cm"> * things will happen if it is not 0 in a card address.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">phy_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ray_mem_speed</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>

<span class="cm">/* WARNING: THIS DRIVER IS NOT CAPABLE OF HANDLING MULTIPLE DEVICES! */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">this_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Corey Thomas &lt;corey@world.std.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Raylink/WebGear wireless LAN driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">net_type</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">hop_dwell</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">beacon_period</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">psm</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">translate</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">sniffer</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ray_mem_speed</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">UCHAR</span> <span class="n">b5_default_startup_parms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* Adhoc station */</span>
	<span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* 32 char ESSID */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* Active scan, CA Mode */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* No default MAC addr  */</span>
	<span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* Frag threshold */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>		<span class="cm">/* Hop time 128 Kus */</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="cm">/* Beacon period 256 Kus */</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span>	<span class="cm">/* DTIM, retries, ack timeout */</span>
	<span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span>	<span class="cm">/* SIFS, DIFS, PIFS */</span>
	<span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* RTS threshold */</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0xA4</span><span class="p">,</span>	<span class="cm">/* scan_dwell, max_scan_dwell */</span>
	<span class="mh">0x05</span><span class="p">,</span>			<span class="cm">/* assoc resp timeout thresh */</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>	<span class="cm">/* adhoc, infra, super cycle max */</span>
	<span class="mi">0</span><span class="p">,</span>			<span class="cm">/* Promiscuous mode */</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0bd</span><span class="p">,</span>		<span class="cm">/* Unique word */</span>
	<span class="mh">0x32</span><span class="p">,</span>			<span class="cm">/* Slot time */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* roam-low snr, low snr count */</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* Infra, adhoc missed bcn thresh */</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x4f</span><span class="p">,</span>	<span class="cm">/* USA, hop pattern, hop pat length */</span>
<span class="cm">/* b4 - b5 differences start here */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span>		<span class="cm">/* CW max */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>		<span class="cm">/* CW min */</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>		<span class="cm">/* Noise gain, limit offset */</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>		<span class="cm">/* det rssi, med busy offsets */</span>
	<span class="mi">7</span><span class="p">,</span>			<span class="cm">/* det sync thresh */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>		<span class="cm">/* test mode, min, max */</span>
	<span class="mi">0</span><span class="p">,</span>			<span class="cm">/* allow broadcast SSID probe resp */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* privacy must start, can join */</span>
	<span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>	<span class="cm">/* basic rate set */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">UCHAR</span> <span class="n">b4_default_startup_parms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* Adhoc station */</span>
	<span class="sc">&#39;L&#39;</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;U&#39;</span><span class="p">,</span> <span class="sc">&#39;X&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* 32 char ESSID */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>			<span class="cm">/* Active scan, CA Mode */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* No default MAC addr  */</span>
	<span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* Frag threshold */</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="cm">/* Hop time */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>		<span class="cm">/* Beacon period */</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0xa3</span><span class="p">,</span>	<span class="cm">/* DTIM, retries, ack timeout */</span>
	<span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xce</span><span class="p">,</span>	<span class="cm">/* SIFS, DIFS, PIFS */</span>
	<span class="mh">0x7f</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* RTS threshold */</span>
	<span class="mh">0xfb</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xc7</span><span class="p">,</span> <span class="mh">0x5c</span><span class="p">,</span>	<span class="cm">/* scan_dwell, max_scan_dwell */</span>
	<span class="mh">0x05</span><span class="p">,</span>			<span class="cm">/* assoc resp timeout thresh */</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">,</span>	<span class="cm">/* adhoc, infra, super cycle max */</span>
	<span class="mi">0</span><span class="p">,</span>			<span class="cm">/* Promiscuous mode */</span>
	<span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0bd</span><span class="p">,</span>		<span class="cm">/* Unique word */</span>
	<span class="mh">0x4e</span><span class="p">,</span>			<span class="cm">/* Slot time (TBD seems wrong) */</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* roam-low snr, low snr count */</span>
	<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>		<span class="cm">/* Infra, adhoc missed bcn thresh */</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x4e</span><span class="p">,</span>	<span class="cm">/* USA, hop pattern, hop pat length */</span>
<span class="cm">/* b4 - b5 differences start here */</span>
	<span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span>		<span class="cm">/* CW max, min */</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>		<span class="cm">/* Noise gain, limit offset */</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>		<span class="cm">/* det rssi, med busy offsets */</span>
	<span class="mi">7</span><span class="p">,</span>			<span class="cm">/* det sync thresh */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>			<span class="cm">/* test mode, min, max */</span>
<span class="p">};</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">eth2_llc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">hop_pattern_length</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">USA_HOP_MOD</span><span class="p">,</span> <span class="n">EUROPE_HOP_MOD</span><span class="p">,</span>
	<span class="n">JAPAN_HOP_MOD</span><span class="p">,</span> <span class="n">KOREA_HOP_MOD</span><span class="p">,</span>
	<span class="n">SPAIN_HOP_MOD</span><span class="p">,</span> <span class="n">FRANCE_HOP_MOD</span><span class="p">,</span>
	<span class="n">ISRAEL_HOP_MOD</span><span class="p">,</span> <span class="n">AUSTRALIA_HOP_MOD</span><span class="p">,</span>
	<span class="n">JAPAN_TEST_HOP_MOD</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">rcsid</span><span class="p">[]</span> <span class="o">=</span>
    <span class="s">&quot;Raylink/WebGear wireless LAN - Corey &lt;Thomas corey@world.std.com&gt;&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">ray_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_init</span> 		<span class="o">=</span> <span class="n">ray_dev_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">ray_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> 		<span class="o">=</span> <span class="n">ray_dev_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">ray_dev_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_config</span>		<span class="o">=</span> <span class="n">ray_dev_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">ray_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_attach()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Allocate space for private device-specific data */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ray_dev_t</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_alloc_dev</span><span class="p">;</span>

	<span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span> <span class="o">=</span> <span class="n">p_dev</span><span class="p">;</span>

	<span class="cm">/* The io structure describes IO port mapping. None used here */</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IO_DATA_PATH_WIDTH_8</span><span class="p">;</span>

	<span class="cm">/* General socket configuration */</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_flags</span> <span class="o">|=</span> <span class="n">CONF_ENABLE_IRQ</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span> <span class="o">=</span> <span class="n">p_dev</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_INSERTED</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">=</span> <span class="n">UNAUTHENTICATED</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">num_multi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_attach p_dev = %p,  dev = %p,  local = %p, intr = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">p_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ray_interrupt</span><span class="p">);</span>

	<span class="cm">/* Raylink entries in the device structure */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ray_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ray_handler_def</span><span class="p">;</span>
<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">.</span><span class="n">spy_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* WIRELESS_SPY */</span><span class="cp"></span>


	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs ray_attach calling ether_setup.)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">this_device</span> <span class="o">=</span> <span class="n">p_dev</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ray_config</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>

<span class="nl">fail_alloc_dev:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ray_attach */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ray_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_detach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">this_device</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">ray_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs ray_detach ending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* ray_detach */</span>

<span class="cp">#define MAX_TUPLE_SIZE 128</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_config</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Determine card type and firmware version */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ray_cs Detected: %s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">,</span>
	       <span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">,</span>
	       <span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">,</span>
	       <span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">?</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot; &quot;</span><span class="p">);</span>

	<span class="cm">/* Now allocate an interrupt line.  Note that this does not</span>
<span class="cm">	   actually assign a handler to the interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_irq</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">ray_interrupt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

<span class="cm">/*** Set up 32k window for shared memory (transmit and control) ************/</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WIN_DATA_WIDTH_8</span> <span class="o">|</span> <span class="n">WIN_MEMORY_TYPE_CM</span> <span class="o">|</span> <span class="n">WIN_ENABLE</span> <span class="o">|</span> <span class="n">WIN_USE_WAIT</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x8000</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_window</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ray_mem_speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_map_mem_page</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>

<span class="cm">/*** Set up 16k window for shared memory (receive buffer) ***************/</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
	    <span class="n">WIN_DATA_WIDTH_8</span> <span class="o">|</span> <span class="n">WIN_MEMORY_TYPE_CM</span> <span class="o">|</span> <span class="n">WIN_ENABLE</span> <span class="o">|</span> <span class="n">WIN_USE_WAIT</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_window</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ray_mem_speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_map_mem_page</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">rmem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>

<span class="cm">/*** Set up window for attribute memory ***********************************/</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
	    <span class="n">WIN_DATA_WIDTH_8</span> <span class="o">|</span> <span class="n">WIN_MEMORY_TYPE_AM</span> <span class="o">|</span> <span class="n">WIN_ENABLE</span> <span class="o">|</span> <span class="n">WIN_USE_WAIT</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_window</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ray_mem_speed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_map_mem_page</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">amem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
			<span class="n">resource_size</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">]));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_config sram=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_config rmem=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">rmem</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_config amem=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">amem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ray_init</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ray_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ray_config register_netdev() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ray_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: RayLink, irq %d, hw_addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">ray_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ray_config */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">ccs_base</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">CCS_BASE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="nf">rcs_base</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This looks nonsensical, since there is a separate</span>
<span class="cm">	 * RCS_BASE. But the difference between a &quot;struct rcs&quot;</span>
<span class="cm">	 * and a &quot;struct ccs&quot; ends up being in the _index_ off</span>
<span class="cm">	 * the base, so the base pointer is the same for both</span>
<span class="cm">	 * ccs/rcs.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">CCS_BASE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_init(0x%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_init - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">=</span> <span class="n">net_type</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_type</span> <span class="o">=</span> <span class="n">TYPE_STA</span><span class="p">;</span>

	<span class="cm">/* Copy the startup results to local memory */</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">startup_res</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">ECF_TO_HOST_BASE</span><span class="p">,</span>
		      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">startup_res_6</span><span class="p">));</span>

	<span class="cm">/* Check Power up test status and get mac address from card */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">startup_res</span><span class="p">.</span><span class="n">startup_word</span> <span class="o">!=</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ray_init ERROR card status = %2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">startup_res</span><span class="p">.</span><span class="n">startup_word</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_INIT_ERROR</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">startup_res</span><span class="p">.</span><span class="n">firmware_version</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_bld</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">startup_res</span><span class="p">.</span><span class="n">firmware_version</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">startup_res</span><span class="p">.</span><span class="n">firmware_version</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_init firmware version %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span>
	      <span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_bld</span><span class="p">);</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">tib_length</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_bld</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">))</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">tib_length</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">startup_res</span><span class="p">.</span><span class="n">tib_length</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_init tib_length = 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tib_length</span><span class="p">);</span>
	<span class="cm">/* Initialize CCS&#39;s to buffer free state */</span>
	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMBER_OF_CCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">init_startup_params</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="cm">/* copy mac address to startup parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parse_addr</span><span class="p">(</span><span class="n">phy_addr</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_mac_addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_mac_addr</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_mac_addr</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">startup_res</span><span class="p">.</span><span class="n">station_addr</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_mac_addr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_interrupt</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>	<span class="cm">/* Clear any interrupt from the card */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_AWAITING_PARAM</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_init ending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ray_init */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cm">/* Download startup parameters to the card and command it to read them       */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dl_startup_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dl_startup_params entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs dl_startup_params - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy parameters to host to ECF area */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">HOST_TO_ECF_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b4_startup_params</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">HOST_TO_ECF_BASE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b5_startup_params</span><span class="p">));</span>

	<span class="cm">/* Fill in the CCS fields for the ECF */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ccsindex</span> <span class="o">=</span> <span class="n">get_free_ccs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_param_ccs</span> <span class="o">=</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_DOWNLOAD_STARTUP_PARAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;dl_startup_params start ccsindex = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_param_ccs</span><span class="p">);</span>
	<span class="cm">/* Interrupt the firmware to process the command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ccsindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ray dl_startup_params failed - &quot;</span>
		       <span class="s">&quot;ECF not ready for intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_DL_PARAM_ERROR</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_DL_PARAM</span><span class="p">;</span>
	<span class="cm">/* Start kernel timer to wait for dl startup to complete. */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">verify_dl_startup</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	      <span class="s">&quot;ray_cs dl_startup_params started timer for verify_dl_startup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* dl_startup_params */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_startup_params</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">country</span> <span class="o">&gt;</span> <span class="n">JAPAN_TEST</span><span class="p">)</span>
		<span class="n">country</span> <span class="o">=</span> <span class="n">USA</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">country</span> <span class="o">&lt;</span> <span class="n">USA</span><span class="p">)</span>
		<span class="n">country</span> <span class="o">=</span> <span class="n">USA</span><span class="p">;</span>
	<span class="cm">/* structure for hop time and beacon period is defined here using</span>
<span class="cm">	 * New 802.11D6.1 format.  Card firmware is still using old format</span>
<span class="cm">	 * until version 6.</span>
<span class="cm">	 *    Before                    After</span>
<span class="cm">	 *    a_hop_time ms byte        a_hop_time ms byte</span>
<span class="cm">	 *    a_hop_time 2s byte        a_hop_time ls byte</span>
<span class="cm">	 *    a_hop_time ls byte        a_beacon_period ms byte</span>
<span class="cm">	 *    a_beacon_period           a_beacon_period ls byte</span>
<span class="cm">	 *</span>
<span class="cm">	 *    a_hop_time = uS           a_hop_time = KuS</span>
<span class="cm">	 *    a_beacon_period = hops    a_beacon_period = KuS</span>
<span class="cm">	 *//* 64ms = 010000 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">UCHAR</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">,</span> <span class="n">b4_default_startup_parms</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b4_startup_params</span><span class="p">));</span>
		<span class="cm">/* Translate sane kus input values to old build 4/5 format */</span>
		<span class="cm">/* i = hop time in uS truncated to 3 bytes */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">hop_dwell</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_hop_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_hop_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_beacon_period</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_beacon_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">beacon_period</span> <span class="o">/</span> <span class="n">hop_dwell</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_curr_country_code</span> <span class="o">=</span> <span class="n">country</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_hop_pattern_length</span> <span class="o">=</span>
		    <span class="n">hop_pattern_length</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">country</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_ack_timeout</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_sifs</span> <span class="o">=</span> <span class="mh">0x3f</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Version 5 uses real kus values */</span>
		<span class="n">memcpy</span><span class="p">((</span><span class="n">UCHAR</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">,</span> <span class="n">b5_default_startup_parms</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b5_startup_params</span><span class="p">));</span>

		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_hop_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">hop_dwell</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_hop_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">hop_dwell</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_beacon_period</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">beacon_period</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_beacon_period</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">beacon_period</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psm</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_power_mgt_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_curr_country_code</span> <span class="o">=</span> <span class="n">country</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_hop_pattern_length</span> <span class="o">=</span>
		    <span class="n">hop_pattern_length</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">country</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_network_type</span> <span class="o">=</span> <span class="n">net_type</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_acting_as_ap_status</span> <span class="o">=</span> <span class="n">TYPE_STA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">essid</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="n">ESSID_SIZE</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* init_startup_params */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">verify_dl_startup</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_param_ccs</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs verify_dl_startup - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{</span>
<span class="c">		int i;</span>
<span class="c">		printk(KERN_DEBUG</span>
<span class="c">		       &quot;verify_dl_startup parameters sent via ccs %d:\n&quot;,</span>
<span class="c">		       local-&gt;dl_param_ccs);</span>
<span class="c">		for (i = 0; i &lt; sizeof(struct b5_startup_params); i++) {</span>
<span class="c">			printk(&quot; %2x&quot;,</span>
<span class="c">			       (unsigned int)readb(local-&gt;sram +</span>
<span class="c">						   HOST_TO_ECF_BASE + i));</span>
<span class="c">		}</span>
<span class="c">		printk(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CCS_BUFFER_FREE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		       <span class="s">&quot;Download startup params failed.  Status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">status</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_DL_PARAM_ERROR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_network_type</span> <span class="o">==</span> <span class="n">ADHOC</span><span class="p">)</span>
		<span class="n">start_net</span><span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">join_net</span><span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* end verify_dl_startup */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cm">/* Command card to start a network */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">start_net</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs start_net - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fill in the CCS fields for the ECF */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ccsindex</span> <span class="o">=</span> <span class="n">get_free_ccs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_START_NETWORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">start_network</span><span class="p">.</span><span class="n">update_param</span><span class="p">);</span>
	<span class="cm">/* Interrupt the firmware to process the command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ccsindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray start net failed - card not ready for intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_DOING_ACQ</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end start_net */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cm">/* Command card to join a network */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">join_net</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs join_net - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fill in the CCS fields for the ECF */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ccsindex</span> <span class="o">=</span> <span class="n">get_free_ccs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_JOIN_NETWORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">join_network</span><span class="p">.</span><span class="n">update_param</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">join_network</span><span class="p">.</span><span class="n">net_initiated</span><span class="p">);</span>
	<span class="cm">/* Interrupt the firmware to process the command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ccsindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray join net failed - card not ready for intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_DOING_ACQ</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ray_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rmem</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">amem</span><span class="p">);</span>
	<span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_release ending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ray_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_dev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef RAY_IMMEDIATE_INIT</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* RAY_IMMEDIATE_INIT */</span><span class="cp"></span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_dev_init(dev=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_dev_init - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef RAY_IMMEDIATE_INIT</span>
	<span class="cm">/* Download startup parameters */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">dl_startup_params</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ray_dev_init dl_startup_params failed - &quot;</span>
		       <span class="s">&quot;returns 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else </span><span class="cm">/* RAY_IMMEDIATE_INIT */</span><span class="cp"></span>
	<span class="cm">/* Postpone the card init so that we can still configure the card,</span>
<span class="cm">	 * for example using the Wireless Extensions. The init will happen</span>
<span class="cm">	 * in ray_open() - Jean II */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
	      <span class="s">&quot;ray_dev_init: postponing card init to ray_open() ; Status = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* RAY_IMMEDIATE_INIT */</span><span class="cp"></span>

	<span class="cm">/* copy mac and broadcast addresses to linux device */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_mac_addr</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_dev_init ending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_dev_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmap</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="cm">/* Dummy routine to satisfy device structure */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_dev_config(dev=%p,ifmap=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_dev_config - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">ray_dev_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">length</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_dev_start_xmit - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_dev_start_xmit(skb=%p, dev=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">==</span> <span class="n">NEED_TO_AUTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs Sending authentication request.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">build_auth_frame</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_id</span><span class="p">,</span> <span class="n">OPEN_AUTH_REQUEST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">=</span> <span class="n">AUTHENTICATED</span><span class="p">;</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ETH_ZLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb_padto</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ZLEN</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ray_hw_xmit</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">DATA_TYPE</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XMIT_NO_CCS</span>:
	<span class="k">case</span> <span class="n">XMIT_NEED_AUTH</span>:
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">XMIT_NO_INTR</span>:
	<span class="k">case</span> <span class="n">XMIT_MSG_BAD</span>:
	<span class="k">case</span> <span class="n">XMIT_OK</span>:
	<span class="nl">default:</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ray_dev_start_xmit */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_hw_xmit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="n">UCHAR</span> <span class="n">msg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_msg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptx</span><span class="p">;</span>	<span class="cm">/* Address of xmit buffer in PC space */</span>
	<span class="kt">short</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>		<span class="cm">/* Address of xmit buffer in card space */</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_hw_xmit(data=%p, len=%d, dev=%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">TX_HEADER_LENGTH</span> <span class="o">&gt;</span> <span class="n">TX_BUF_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ray_hw_xmit packet too large: %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XMIT_MSG_BAD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ccsindex</span> <span class="o">=</span> <span class="n">get_free_tx_ccs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ECCSBUSY</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_hw_xmit tx_ccs table busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ECCSFULL</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_hw_xmit No free tx ccs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">ECARDGONE</span>:
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XMIT_NO_CCS</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">TX_BUF_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ccsindex</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg_type</span> <span class="o">==</span> <span class="n">DATA_TYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptx</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">ray_build_header</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ptx</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">translate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">translate_frame</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ptx</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Encapsulate frame */</span>
		<span class="cm">/* TBD TIB length will move address of ptx-&gt;var */</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill in the CCS */</span>
	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="n">TX_HEADER_LENGTH</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_TX_REQUEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_data_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tib_length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_data_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_data_length</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_data_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cm">/* TBD still need psm_cam? */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PSM_CAM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">pow_sav_mode</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">net_default_tx_rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_rate</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">antenna</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_hw_xmit default_tx_rate = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">local</span><span class="o">-&gt;</span><span class="n">net_default_tx_rate</span><span class="p">);</span>

	<span class="cm">/* Interrupt the firmware to process the command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ccsindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_hw_xmit failed - ECF not ready for intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cm">/* TBD very inefficient to copy packet to buffer, and then not</span>
<span class="cm">   send it, but the alternative is to queue the messages and that</span>
<span class="cm">   won&#39;t be done for a while.  Maybe set tbusy until a CCS is free?</span>
<span class="cm">*/</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">XMIT_NO_INTR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">XMIT_OK</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ray_hw_xmit */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">translate_frame</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_msg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptx</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be16</span> <span class="n">proto</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_proto</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">proto</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1536</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* DIX II ethernet frame */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs translate_frame DIX II</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Copy LLC header to card buffer */</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">eth2_llc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eth2_llc</span><span class="p">));</span>
		<span class="n">memcpy_toio</span><span class="p">(((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">eth2_llc</span><span class="p">),</span>
			    <span class="p">(</span><span class="n">UCHAR</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">proto</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_AARP</span><span class="p">)</span> <span class="o">||</span> <span class="n">proto</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_IPX</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* This is the selective translation table, only 2 entries */</span>
			<span class="n">writeb</span><span class="p">(</span><span class="mh">0xf8</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">snaphdr_t</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">org</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="cm">/* Copy body of ethernet packet without ethernet header */</span>
		<span class="n">memcpy_toio</span><span class="p">((</span><span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snaphdr_t</span><span class="p">),</span> <span class="n">data</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span>
			    <span class="n">len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snaphdr_t</span><span class="p">)</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* already  802 type, and proto is length */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs translate_frame 802</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="n">htons</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span> <span class="cm">/* evil netware IPX 802.3 without LLC */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs translate_frame evil IPX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">ETH_HLEN</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* TBD do other frame types */</span>
<span class="p">}</span> <span class="cm">/* end translate_frame */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ray_build_header</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_msg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptx</span><span class="p">,</span>
			     <span class="n">UCHAR</span> <span class="n">msg_type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PROTOCOL_VER</span> <span class="o">|</span> <span class="n">msg_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">frame_ctl_1</span><span class="p">);</span>
<span class="cm">/*** IEEE 802.11 Address field assignments *************</span>
<span class="cm">		TODS	FROMDS	addr_1		addr_2		addr_3	addr_4</span>
<span class="cm">Adhoc		0	0	dest		src (terminal)	BSSID	N/A</span>
<span class="cm">AP to Terminal	0	1	dest		AP(BSSID)	source	N/A</span>
<span class="cm">Terminal to AP	1	0	AP(BSSID)	src (terminal)	dest	N/A</span>
<span class="cm">AP to AP	1	1	dest AP		src AP		dest	source</span>
<span class="cm">*******************************************************/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">frame_ctl_2</span><span class="p">);</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_1</span><span class="p">,</span> <span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span>
			    <span class="mi">2</span> <span class="o">*</span> <span class="n">ADDRLEN</span><span class="p">);</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_3</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* infrastructure */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_acting_as_ap_status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">FC2_FROM_DS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">frame_ctl_2</span><span class="p">);</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_1</span><span class="p">,</span>
				    <span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_2</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_3</span><span class="p">,</span>
				    <span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Terminal */</span>

			<span class="n">writeb</span><span class="p">(</span><span class="n">FC2_TO_DS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">frame_ctl_2</span><span class="p">);</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_1</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_2</span><span class="p">,</span>
				    <span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_3</span><span class="p">,</span>
				    <span class="p">((</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* end encapsulate_frame */</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get protocol name</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11-FH&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>	<span class="cm">/* Call commit handler */</span>

	<span class="cm">/* Reject if card is already initialised */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">!=</span> <span class="n">CARD_AWAITING_PARAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Setting by channel number */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">&gt;</span> <span class="n">USA_HOP_MOD</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_hop_pattern</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_hop_pattern</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set ESSID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Reject if card is already initialised */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">!=</span> <span class="n">CARD_AWAITING_PARAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Check if we asked for `any&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* Corey : can you do that ? */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* Check the size of the string */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="cm">/* Set the ESSID in the card */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>	<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get ESSID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Get the essid that was set */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>

	<span class="cm">/* Push it out ! */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">extra</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* active */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get AP address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Bit-Rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Reject if card is already initialised */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">!=</span> <span class="n">CARD_AWAITING_PARAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Check if rate is in range */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">1000000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">2000000</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Hack for 1.5 Mb/s instead of 2 Mb/s */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span> <span class="o">&amp;&amp;</span>	<span class="cm">/* Please check */</span>
	    <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">2000000</span><span class="p">))</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">net_default_tx_rate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">net_default_tx_rate</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">/</span> <span class="mi">500000</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Bit-Rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">net_default_tx_rate</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2000000</span><span class="p">;</span>	<span class="cm">/* Hum... */</span>
	<span class="k">else</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">net_default_tx_rate</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* We are in auto mode */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set RTS threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rthr</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="cm">/* Reject if card is already initialised */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">!=</span> <span class="n">CARD_AWAITING_PARAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* if(wrq-&gt;u.rts.fixed == 0) we should complain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">rthr</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rthr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rthr</span> <span class="o">&gt;</span> <span class="mi">2347</span><span class="p">))</span>   <span class="cm">/* What&#39;s the max packet size ??? */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_rts_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">rthr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_rts_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">rthr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>	<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get RTS threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_rts_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
	    <span class="o">+</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_rts_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">32767</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Fragmentation threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">fthr</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>

	<span class="cm">/* Reject if card is already initialised */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">!=</span> <span class="n">CARD_AWAITING_PARAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* if(wrq-&gt;u.frag.fixed == 0) should complain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">fthr</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">fthr</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fthr</span> <span class="o">&gt;</span> <span class="mi">2347</span><span class="p">))</span>	<span class="cm">/* To check out ! */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_frag_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fthr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_frag_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">fthr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>	<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Fragmentation threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_frag_threshold</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
	    <span class="o">+</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_frag_threshold</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">32767</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Mode of Operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>	<span class="cm">/* Call commit handler */</span>
	<span class="kt">char</span> <span class="n">card_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Reject if card is already initialised */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">!=</span> <span class="n">CARD_AWAITING_PARAM</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">card_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_network_type</span> <span class="o">=</span> <span class="n">card_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Mode of Operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_network_type</span><span class="p">)</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get range info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">));</span>

	<span class="cm">/* Set the length (very important for backward compatibility) */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">);</span>

	<span class="cm">/* Set the Wireless Extension versions */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="cm">/* Set information in the range struct */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>	<span class="cm">/* Put the right number here */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">hop_pattern_length</span><span class="p">[(</span><span class="kt">int</span><span class="p">)</span><span class="n">country</span><span class="p">];</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>	<span class="cm">/* What&#39;s the correct value ? */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>	<span class="cm">/* Idem */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>	<span class="cm">/* 1 Mb/s */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2000000</span><span class="p">;</span>	<span class="cm">/* 2 Mb/s */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Private Handler : set framing mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_set_framing</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">translate</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">extra</span><span class="p">);</span>	<span class="cm">/* Set framing mode */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Private Handler : get framing mode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_framing</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="o">=</span> <span class="n">translate</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Private Handler : get country</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_get_country</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="o">=</span> <span class="n">country</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Commit handler : called after a bunch of SET operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		      <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Stats handler : return Wireless Stats</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">iw_stats</span> <span class="o">*</span><span class="nf">ray_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">status</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">STATUS_BASE</span><span class="p">;</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span><span class="p">;</span>
<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_network_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Get it from the first node in spy list */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">qual</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">level</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">noise</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_stat</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">updated</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* WIRELESS_SPY */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rxnoise</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">|=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ray_get_wireless_stats */</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Structures to export the Wireless Handlers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">ray_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWCOMMIT</span><span class="p">,</span> <span class="n">ray_commit</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNAME</span><span class="p">,</span> <span class="n">ray_get_name</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFREQ</span><span class="p">,</span> <span class="n">ray_set_freq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFREQ</span><span class="p">,</span> <span class="n">ray_get_freq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMODE</span><span class="p">,</span> <span class="n">ray_set_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWMODE</span><span class="p">,</span> <span class="n">ray_get_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRANGE</span><span class="p">,</span> <span class="n">ray_get_range</span><span class="p">),</span>
<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSPY</span><span class="p">,</span> <span class="n">iw_handler_set_spy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSPY</span><span class="p">,</span> <span class="n">iw_handler_get_spy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWTHRSPY</span><span class="p">,</span> <span class="n">iw_handler_set_thrspy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">,</span> <span class="n">iw_handler_get_thrspy</span><span class="p">),</span>
<span class="cp">#endif </span><span class="cm">/* WIRELESS_SPY */</span><span class="cp"></span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="n">ray_get_wap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWESSID</span><span class="p">,</span> <span class="n">ray_set_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWESSID</span><span class="p">,</span> <span class="n">ray_get_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRATE</span><span class="p">,</span> <span class="n">ray_set_rate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRATE</span><span class="p">,</span> <span class="n">ray_get_rate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWRTS</span><span class="p">,</span> <span class="n">ray_set_rts</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRTS</span><span class="p">,</span> <span class="n">ray_get_rts</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFRAG</span><span class="p">,</span> <span class="n">ray_set_frag</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFRAG</span><span class="p">,</span> <span class="n">ray_get_frag</span><span class="p">),</span>
<span class="p">};</span>

<span class="cp">#define SIOCSIPFRAMING	SIOCIWFIRSTPRIV	</span><span class="cm">/* Set framing mode */</span><span class="cp"></span>
<span class="cp">#define SIOCGIPFRAMING	SIOCIWFIRSTPRIV + 1	</span><span class="cm">/* Get framing mode */</span><span class="cp"></span>
<span class="cp">#define SIOCGIPCOUNTRY	SIOCIWFIRSTPRIV + 3	</span><span class="cm">/* Get country code */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">ray_private_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray_set_framing</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray_get_framing</span><span class="p">,</span>
	<span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ray_get_country</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">ray_private_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/* cmd,		set_args,	get_args,	name */</span>
	<span class="p">{</span><span class="n">SIOCSIPFRAMING</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;set_framing&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SIOCGIPFRAMING</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="s">&quot;get_framing&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">SIOCGIPCOUNTRY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="s">&quot;get_country&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">ray_handler_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_standard</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ray_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ray_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ray_private_args</span><span class="p">),</span>
	<span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="n">ray_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="n">ray_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span> <span class="o">=</span> <span class="n">ray_private_args</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">ray_get_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_open(&#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">num_multi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* If the card is not started, time to start it ! - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">==</span> <span class="n">CARD_AWAITING_PARAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_open: doing init now !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Download startup parameters */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">dl_startup_params</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
			       <span class="s">&quot;ray_dev_init dl_startup_params failed - &quot;</span>
			       <span class="s">&quot;returns 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sniffer</span><span class="p">)</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_open ending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ray_open */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_dev_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_dev_close(&#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">--</span><span class="p">;</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* In here, we should stop the hardware (stop card from beeing active)</span>
<span class="cm">	 * and set local-&gt;card_status to CARD_AWAITING_PARAM, so that while the</span>
<span class="cm">	 * card is closed we can chage its configuration.</span>
<span class="cm">	 * Probably also need a COR reset to get sane state - Jean II */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end ray_dev_close */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ray_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_reset entered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cm">/* Cause a firmware interrupt if it is ready for one                         */</span>
<span class="cm">/* Return nonzero if not ready                                               */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">interrupt_ecf</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ccs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt_ecf - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;interrupt_ecf(local=%p, ccs = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">ccs</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">amem</span> <span class="o">+</span> <span class="n">CIS_OFFSET</span> <span class="o">+</span> <span class="n">ECF_INTR_OFFSET</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">ECF_INTR_SET</span><span class="p">))</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt_ecf card not ready for interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Fill the mailbox, then kick the card */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">ccs</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">SCB_BASE</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">ECF_INTR_SET</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">amem</span> <span class="o">+</span> <span class="n">CIS_OFFSET</span> <span class="o">+</span> <span class="n">ECF_INTR_OFFSET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* interrupt_ecf */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cm">/* Get next free transmit CCS                                                */</span>
<span class="cm">/* Return - index of current tx ccs                                          */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_free_tx_ccs</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs get_free_tx_ccs - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ECARDGONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_ccs_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs tx_ccs_lock busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ECCSBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMBER_OF_TX_CCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">)</span> <span class="o">==</span> <span class="n">CCS_BUFFER_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_END_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_ccs_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_ccs_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs ERROR no free tx CCS for raylink card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ECCSFULL</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* get_free_tx_ccs */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cm">/* Get next free CCS                                                         */</span>
<span class="cm">/* Return - index of current ccs                                             */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_free_ccs</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs get_free_ccs - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ECARDGONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ccs_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs ccs_lock busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ECCSBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">NUMBER_OF_TX_CCS</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUMBER_OF_CCS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">)</span> <span class="o">==</span> <span class="n">CCS_BUFFER_FREE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_BUSY</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
			<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_END_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ccs_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">ccs_lock</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs ERROR no free CCS for raylink card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ECCSFULL</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* get_free_ccs */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">authenticate_timeout</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ray_cs Authentication with access point failed&quot;</span>
	       <span class="s">&quot; - timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">join_net</span><span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">parse_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">in_str</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_str</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">in_str</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">in_str</span><span class="p">[</span><span class="n">j</span><span class="o">--</span><span class="p">]))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">in_str</span><span class="p">[</span><span class="n">j</span><span class="o">--</span><span class="p">]))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">out</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">k</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">ray_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">status</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">STATUS_BASE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs net_device_stats - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mrx_overflow_for_host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span> <span class="o">+=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mrx_overflow</span><span class="p">));</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mrx_overflow</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mrx_overflow_for_host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mrx_checksum_error_for_host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">+=</span>
		    <span class="n">swab16</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mrx_checksum_error</span><span class="p">));</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mrx_checksum_error</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">mrx_checksum_error_for_host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_hec_error_for_host</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">+=</span> <span class="n">swab16</span><span class="p">(</span><span class="n">readw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_hec_error</span><span class="p">));</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_hec_error</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">rx_hec_error_for_host</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ray_update_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="n">objid</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_update_parm - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ccsindex</span> <span class="o">=</span> <span class="n">get_free_ccs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_update_parm - No free ccs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_UPDATE_PARAMS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">objid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">update_param</span><span class="p">.</span><span class="n">object_id</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">update_param</span><span class="p">.</span><span class="n">number_objects</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">update_param</span><span class="p">.</span><span class="n">failure_cause</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">HOST_TO_ECF_BASE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Interrupt the firmware to process the command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ccsindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs associate failed - ECF not ready for intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ray_update_multi_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">all</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">HOST_TO_ECF_BASE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_update_multi_list - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_update_multi_list(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ccsindex</span> <span class="o">=</span> <span class="n">get_free_ccs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_update_multi - No free ccs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_UPDATE_MULTICAST_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">all</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="mh">0xff</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">num_multi</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Copy the kernel&#39;s list of MC addresses to card */</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_update_multi add addr %pm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
			<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">256</span> <span class="o">/</span> <span class="n">ADDRLEN</span><span class="p">)</span>
			<span class="n">i</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">/</span> <span class="n">ADDRLEN</span><span class="p">;</span>
		<span class="n">writeb</span><span class="p">((</span><span class="n">UCHAR</span><span class="p">)</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs update_multi %d addresses in list</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="cm">/* Interrupt the firmware to process the command */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">num_multi</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ccsindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		      <span class="s">&quot;ray_cs update_multi failed - ECF not ready for intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* end ray_update_multi_list */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">UCHAR</span> <span class="n">promisc</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs set_multicast_list(%p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_promiscuous_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs set_multicast_list promisc on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_promiscuous_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">promisc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ray_update_parm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OBJID_promiscuous_mode</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">promisc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">promisc</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_promiscuous_mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs set_multicast_list promisc off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_promiscuous_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">promisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ray_update_parm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">OBJID_promiscuous_mode</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">promisc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">promisc</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span>
		<span class="n">ray_update_multi_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">num_multi</span> <span class="o">!=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ray_update_multi_list</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span> <span class="cm">/* end set_multicast_list */</span>

<span class="cm">/*=============================================================================</span>
<span class="cm"> * All routines below here are run at interrupt time.</span>
<span class="cm">=============================================================================*/</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ray_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">rcsindex</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>	<span class="cm">/* Note that we want interrupts with dev-&gt;start == 0 */</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs: interrupt for *dev=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">link</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="p">)</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span>
			<span class="s">&quot;ray_cs interrupt from device not present or suspended.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rcsindex</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">scb</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">rcs_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rcsindex</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">NUMBER_OF_CCS</span> <span class="o">+</span> <span class="n">NUMBER_OF_RCS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt bad rcsindex = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcsindex</span><span class="p">);</span>
		<span class="n">clear_interrupt</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcsindex</span> <span class="o">&lt;</span> <span class="n">NUMBER_OF_CCS</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* If it&#39;s a returned CCS */</span>
		<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">rcsindex</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CCS_DOWNLOAD_STARTUP_PARAMS</span>:	<span class="cm">/* Happens in firmware someday */</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CCS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="s">&quot;ray_cs interrupt download_startup_parameters OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="s">&quot;ray_cs interrupt download_startup_parameters fail</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_UPDATE_PARAMS</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt update params done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CCS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmp</span> <span class="o">=</span>
				    <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">update_param</span><span class="p">.</span>
					  <span class="n">failure_cause</span><span class="p">);</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="s">&quot;ray_cs interrupt update params failed - reason %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">tmp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_REPORT_PARAMS</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt report params done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_UPDATE_MULTICAST_LIST</span>:	<span class="cm">/* Note that this CCS isn&#39;t returned */</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;ray_cs interrupt CCS Update Multicast List done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_UPDATE_POWER_SAVINGS_MODE</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;ray_cs interrupt update power save mode done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_START_NETWORK</span>:
		<span class="k">case</span> <span class="n">CCS_JOIN_NETWORK</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CCS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">readb</span>
				    <span class="p">(</span><span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">start_network</span><span class="p">.</span><span class="n">net_initiated</span><span class="p">)</span> <span class="o">==</span>
				    <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="s">&quot;ray_cs interrupt network </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="s">&quot;ray_cs interrupt network </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> joined</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span>
					      <span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">start_network</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
					      <span class="n">ADDRLEN</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">net_default_tx_rate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">net_default_tx_rate</span> <span class="o">=</span>
					    <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">start_network</span><span class="p">.</span>
						  <span class="n">net_default_tx_rate</span><span class="p">);</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">encryption</span> <span class="o">=</span>
				    <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">start_network</span><span class="p">.</span><span class="n">encryption</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sniffer</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">INFRA</span><span class="p">)</span>
				    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_acting_as_ap_status</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">authenticate</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_ACQ_COMPLETE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_ACQ_FAILED</span><span class="p">;</span>

				<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CCS_START_NETWORK</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="s">&quot;ray_cs interrupt network </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> start failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">);</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">start_net</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="s">&quot;ray_cs interrupt network </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> join failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">);</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">join_net</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_START_ASSOCIATION</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CCS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_ASSOC_COMPLETE</span><span class="p">;</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs association successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs association failed,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_ASSOC_FAILED</span><span class="p">;</span>
				<span class="n">join_net</span><span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_TX_REQUEST</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CCS_COMMAND_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="s">&quot;ray_cs interrupt tx request complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				      <span class="s">&quot;ray_cs interrupt tx request failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sniffer</span><span class="p">)</span>
				<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_TEST_MEMORY</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt mem test done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_SHUTDOWN</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;ray_cs interrupt Unexpected CCS returned - Shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_DUMP_MEMORY</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt dump memory done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CCS_START_TIMER</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;ray_cs interrupt DING - raylink timer expired</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;ray_cs interrupt Unexpected CCS 0x%x returned 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">rcsindex</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* It&#39;s an RCS */</span>

		<span class="n">prcs</span> <span class="o">=</span> <span class="n">rcs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">rcsindex</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">interrupt_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PROCESS_RX_PACKET</span>:
			<span class="n">ray_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">prcs</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">REJOIN_NET_COMPLETE</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt rejoin net complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_ACQ_COMPLETE</span><span class="p">;</span>
			<span class="cm">/* do we need to clear tx buffers CCS&#39;s? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_network_type</span> <span class="o">==</span> <span class="n">ADHOC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sniffer</span><span class="p">)</span>
					<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span>
					      <span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rejoin_net_complete</span><span class="p">.</span>
					      <span class="n">bssid</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs new BSSID = %pm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sniffer</span><span class="p">)</span>
					<span class="n">authenticate</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ROAMING_INITIATED</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt roaming initiated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_DOING_ACQ</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">JAPAN_CALL_SIGN_RXD</span>:
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs interrupt japan call sign rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			      <span class="s">&quot;ray_cs Unexpected interrupt for RCS 0x%x cmd = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">rcsindex</span><span class="p">,</span>
			      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">interrupt_id</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clear_interrupt</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* ray_interrupt */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ray_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rx_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pmsg</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_rx process rx packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Calculate address of packet within Rx buffer */</span>
	<span class="n">pkt_addr</span> <span class="o">=</span> <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		    <span class="o">+</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="o">&amp;</span> <span class="n">RX_BUFF_END</span><span class="p">;</span>
	<span class="cm">/* Length of first packet fragment */</span>
	<span class="n">rx_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_length</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
	    <span class="o">+</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">last_rsl</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_sig_lev</span><span class="p">);</span>
	<span class="n">pmsg</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">rmem</span> <span class="o">+</span> <span class="n">pkt_addr</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="n">pmsg</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DATA_TYPE</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_rx data type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rx_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prcs</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AUTHENTIC_TYPE</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_rx authentic type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sniffer</span><span class="p">)</span>
			<span class="n">rx_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prcs</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rx_authenticate</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">prcs</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DEAUTHENTIC_TYPE</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_rx deauth type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sniffer</span><span class="p">)</span>
			<span class="n">rx_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prcs</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rx_deauthenticate</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">prcs</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NULL_MSG_TYPE</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs rx NULL msg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BEACON_TYPE</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_rx beacon type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sniffer</span><span class="p">)</span>
			<span class="n">rx_data</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prcs</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>

		<span class="n">copy_from_rx_buff</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="p">(</span><span class="n">UCHAR</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">last_bcn</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span>
				  <span class="n">rx_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">beacon_rx</span><span class="p">)</span> <span class="o">?</span>
				  <span class="n">rx_len</span> <span class="o">:</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">beacon_rx</span><span class="p">));</span>

		<span class="n">local</span><span class="o">-&gt;</span><span class="n">beacon_rxed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* Get the statistics so the card counters never overflow */</span>
		<span class="n">ray_get_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs unknown pkt type %2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">readb</span><span class="p">(</span><span class="n">pmsg</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span> <span class="cm">/* end ray_rx */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcslink</span> <span class="o">=</span> <span class="n">prcs</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">UCHAR</span> <span class="o">*</span><span class="n">rx_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="kt">int</span> <span class="n">siglev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_rsl</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">linksrcaddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>	<span class="cm">/* Other end of the wireless link */</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sniffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">translate</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/* TBD length needs fixing for translated header */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">RX_MAC_HEADER_LENGTH</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">rx_len</span> <span class="o">&gt;</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">RX_MAC_HEADER_LENGTH</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span>
			     <span class="n">FCS_LEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span>
				      <span class="s">&quot;ray_cs invalid packet length %d received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">rx_len</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* encapsulated ethernet */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rx_len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">RX_MAC_HEADER_LENGTH</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">rx_len</span> <span class="o">&gt;</span>
			    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span> <span class="n">RX_MAC_HEADER_LENGTH</span> <span class="o">+</span> <span class="n">ETH_HLEN</span> <span class="o">+</span>
			     <span class="n">FCS_LEN</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span>
				      <span class="s">&quot;ray_cs invalid packet length %d received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">rx_len</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs rx_data packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* If fragmented packet, verify sizes of fragments add up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">next_frag_rcs_index</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs rx&#39;ed fragment</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">totalpacketlength</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
		    <span class="o">+</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">totalpacketlength</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">total_len</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">prcslink</span> <span class="o">=</span> <span class="n">prcs</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">-=</span>
			    <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_length</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			     <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			    <span class="o">+</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">next_frag_rcs_index</span><span class="p">)</span>
			    <span class="o">==</span> <span class="mh">0xFF</span> <span class="o">||</span> <span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">prcslink</span> <span class="o">=</span> <span class="n">rcs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
			    <span class="o">+</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">link_field</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span>
			      <span class="s">&quot;ray_cs rx_data fragment lengths don&#39;t add up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">release_frag_chain</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">prcs</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Single unfragmented packet */</span>
		<span class="n">total_len</span> <span class="o">=</span> <span class="n">rx_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">total_len</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs rx_data could not allocate skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">next_frag_rcs_index</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="n">release_frag_chain</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">prcs</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>	<span class="cm">/* Align IP on 16 byte (TBD check this) */</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs rx_data total_len = %x, rx_len = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">total_len</span><span class="p">,</span>
	      <span class="n">rx_len</span><span class="p">);</span>

<span class="cm">/************************/</span>
	<span class="cm">/* Reserve enough room for the whole damn packet. */</span>
	<span class="n">rx_ptr</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">total_len</span><span class="p">);</span>
	<span class="cm">/* Copy the whole packet to sk_buff */</span>
	<span class="n">rx_ptr</span> <span class="o">+=</span>
	    <span class="n">copy_from_rx_buff</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">rx_ptr</span><span class="p">,</span> <span class="n">pkt_addr</span> <span class="o">&amp;</span> <span class="n">RX_BUFF_END</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>
	<span class="cm">/* Get source address */</span>
<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
					 <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mac_header</span><span class="p">,</span> <span class="n">addr_2</span><span class="p">),</span>
					 <span class="n">linksrcaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Now, deal with encapsulation/translation/sniffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sniffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">translate</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Encapsulated ethernet, so just lop off 802.11 MAC header */</span>
<span class="cm">/* TBD reserve            skb_reserve( skb, RX_MAC_HEADER_LENGTH); */</span>
			<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">RX_MAC_HEADER_LENGTH</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Do translation */</span>
			<span class="n">untranslate</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">total_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* sniffer mode, so just pass whole packet */</span>
	<span class="p">};</span>

<span class="cm">/************************/</span>
	<span class="cm">/* Now pick up the rest of the fragments if any */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">next_frag_rcs_index</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prcslink</span> <span class="o">=</span> <span class="n">prcs</span><span class="p">;</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs rx_data in fragment loop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">prcslink</span> <span class="o">=</span> <span class="n">rcs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
			    <span class="o">+</span>
			    <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">next_frag_rcs_index</span><span class="p">);</span>
			<span class="n">rx_len</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_length</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			      <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
			     <span class="o">+</span>
			     <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_length</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			    <span class="o">&amp;</span> <span class="n">RX_BUFF_END</span><span class="p">;</span>
			<span class="n">pkt_addr</span> <span class="o">=</span>
			    <span class="p">((</span><span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span>
			      <span class="mi">8</span><span class="p">)</span>
			     <span class="o">+</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">rx_data_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			    <span class="o">&amp;</span> <span class="n">RX_BUFF_END</span><span class="p">;</span>

			<span class="n">rx_ptr</span> <span class="o">+=</span>
			    <span class="n">copy_from_rx_buff</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">rx_ptr</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">rx_len</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">--</span> <span class="o">&amp;&amp;</span>
			 <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">next_frag_rcs_index</span><span class="p">)</span> <span class="o">!=</span>
			 <span class="mh">0xFF</span><span class="p">);</span>
		<span class="n">release_frag_chain</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">prcs</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">total_len</span><span class="p">;</span>

	<span class="cm">/* Gather signal strength per address */</span>
<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="cm">/* For the Access Point or the node having started the ad-hoc net</span>
<span class="cm">	 * note : ad-hoc work only in some specific configurations, but we</span>
<span class="cm">	 * kludge in ray_get_wireless_stats... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">linksrcaddr</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Update statistics */</span>
		<span class="cm">/*local-&gt;wstats.qual.qual = none ? */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">siglev</span><span class="p">;</span>
		<span class="cm">/*local-&gt;wstats.qual.noise = none ? */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Now, update the spy stuff */</span>
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">wstats</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">siglev</span><span class="p">;</span>
		<span class="cm">/* wstats.noise = none ? */</span>
		<span class="cm">/* wstats.qual = none ? */</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
		<span class="cm">/* Update spy records */</span>
		<span class="n">wireless_spy_update</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">linksrcaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wstats</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* WIRELESS_SPY */</span><span class="cp"></span>
<span class="p">}</span> <span class="cm">/* end rx_data */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">untranslate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snaphdr_t</span> <span class="o">*</span><span class="n">psnap</span> <span class="o">=</span> <span class="p">(</span><span class="n">snaphdr_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">RX_MAC_HEADER_LENGTH</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">pmac</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">__be16</span> <span class="n">type</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span> <span class="n">psnap</span><span class="o">-&gt;</span><span class="n">ethertype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="n">peth</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">srcaddr</span><span class="p">[</span><span class="n">ADDRLEN</span><span class="p">];</span>
	<span class="n">UCHAR</span> <span class="n">destaddr</span><span class="p">[</span><span class="n">ADDRLEN</span><span class="p">];</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">UCHAR</span> <span class="n">org_bridge</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">UCHAR</span> <span class="n">org_1042</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">destaddr</span><span class="p">,</span> <span class="n">ieee80211_get_DA</span><span class="p">(</span><span class="n">pmac</span><span class="p">),</span> <span class="n">ADDRLEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">srcaddr</span><span class="p">,</span> <span class="n">ieee80211_get_SA</span><span class="p">(</span><span class="n">pmac</span><span class="p">),</span> <span class="n">ADDRLEN</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	if {</span>
<span class="c">		print_hex_dump(KERN_DEBUG, &quot;skb-&gt;data before untranslate: &quot;,</span>
<span class="c">			       DUMP_PREFIX_NONE, 16, 1,</span>
<span class="c">			       skb-&gt;data, 64, true);</span>
<span class="c">		printk(KERN_DEBUG</span>
<span class="c">		       &quot;type = %08x, xsap = %02x%02x%02x, org = %02x02x02x\n&quot;,</span>
<span class="c">		       ntohs(type), psnap-&gt;dsap, psnap-&gt;ssap, psnap-&gt;ctrl,</span>
<span class="c">		       psnap-&gt;org[0], psnap-&gt;org[1], psnap-&gt;org[2]);</span>
<span class="c">		printk(KERN_DEBUG &quot;untranslate skb-&gt;data = %p\n&quot;, skb-&gt;data);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">psnap</span><span class="o">-&gt;</span><span class="n">dsap</span> <span class="o">!=</span> <span class="mh">0xaa</span> <span class="o">||</span> <span class="n">psnap</span><span class="o">-&gt;</span><span class="n">ssap</span> <span class="o">!=</span> <span class="mh">0xaa</span> <span class="o">||</span> <span class="n">psnap</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* not a snap type so leave it alone */</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs untranslate NOT SNAP %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">psnap</span><span class="o">-&gt;</span><span class="n">dsap</span><span class="p">,</span> <span class="n">psnap</span><span class="o">-&gt;</span><span class="n">ssap</span><span class="p">,</span> <span class="n">psnap</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>

		<span class="n">delta</span> <span class="o">=</span> <span class="n">RX_MAC_HEADER_LENGTH</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
		<span class="n">peth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">delta</span><span class="p">);</span>
		<span class="n">peth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">RX_MAC_HEADER_LENGTH</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Its a SNAP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">psnap</span><span class="o">-&gt;</span><span class="n">org</span><span class="p">,</span> <span class="n">org_bridge</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* EtherII and nuke the LLC */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs untranslate Bridge encap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">RX_MAC_HEADER_LENGTH</span>
			    <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snaphdr_t</span><span class="p">)</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
			<span class="n">peth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">delta</span><span class="p">);</span>
			<span class="n">peth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">psnap</span><span class="o">-&gt;</span><span class="n">org</span><span class="p">,</span> <span class="n">org_1042</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ETH_P_IPX</span>:
			<span class="k">case</span> <span class="n">ETH_P_AARP</span>:
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs untranslate RFC IPX/AARP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">delta</span> <span class="o">=</span> <span class="n">RX_MAC_HEADER_LENGTH</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
				<span class="n">peth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">delta</span><span class="p">);</span>
				<span class="n">peth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span>
				    <span class="n">htons</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">RX_MAC_HEADER_LENGTH</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs untranslate RFC default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">delta</span> <span class="o">=</span> <span class="n">RX_MAC_HEADER_LENGTH</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">snaphdr_t</span><span class="p">)</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
				<span class="n">peth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">delta</span><span class="p">);</span>
				<span class="n">peth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ray_cs untranslate very confused by packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">delta</span> <span class="o">=</span> <span class="n">RX_MAC_HEADER_LENGTH</span> <span class="o">-</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
			<span class="n">peth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ethhdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">delta</span><span class="p">);</span>
			<span class="n">peth</span><span class="o">-&gt;</span><span class="n">h_proto</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cm">/* TBD reserve  skb_reserve(skb, delta); */</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">delta</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;untranslate after skb_pull(%d), skb-&gt;data = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">delta</span><span class="p">,</span>
	      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">peth</span><span class="o">-&gt;</span><span class="n">h_dest</span><span class="p">,</span> <span class="n">destaddr</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">peth</span><span class="o">-&gt;</span><span class="n">h_source</span><span class="p">,</span> <span class="n">srcaddr</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	{</span>
<span class="c">		int i;</span>
<span class="c">		printk(KERN_DEBUG &quot;skb-&gt;data after untranslate:&quot;);</span>
<span class="c">		for (i = 0; i &lt; 64; i++)</span>
<span class="c">			printk(&quot;%02x &quot;, skb-&gt;data[i]);</span>
<span class="c">		printk(&quot;\n&quot;);</span>
<span class="c">	}</span>
<span class="cp">#endif</span>
<span class="p">}</span> <span class="cm">/* end untranslate */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cm">/* Copy data from circular receive buffer to PC memory.</span>
<span class="cm"> * dest     = destination address in PC memory</span>
<span class="cm"> * pkt_addr = source address in receive buffer</span>
<span class="cm"> * len      = length of packet to copy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">copy_from_rx_buff</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">wrap_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">pkt_addr</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">RX_BUFF_END</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrap_bytes</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">rmem</span> <span class="o">+</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Packet wrapped in circular buffer */</span>

		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">rmem</span> <span class="o">+</span> <span class="n">pkt_addr</span><span class="p">,</span>
			      <span class="n">length</span> <span class="o">-</span> <span class="n">wrap_bytes</span><span class="p">);</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">dest</span> <span class="o">+</span> <span class="n">length</span> <span class="o">-</span> <span class="n">wrap_bytes</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">rmem</span><span class="p">,</span>
			      <span class="n">wrap_bytes</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_frag_chain</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcslink</span> <span class="o">=</span> <span class="n">prcs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">rcsindex</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">next_frag_rcs_index</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rcsindex</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">NUMBER_OF_CCS</span> <span class="o">+</span> <span class="n">NUMBER_OF_RCS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs interrupt bad rcsindex = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">rcsindex</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">prcslink</span> <span class="o">=</span> <span class="n">rcs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">rcsindex</span><span class="p">;</span>
		<span class="n">rcsindex</span> <span class="o">=</span> <span class="n">readb</span><span class="p">(</span><span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">rx_packet</span><span class="p">.</span><span class="n">next_frag_rcs_index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prcslink</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">authenticate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs Starting authentication.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs authenticate - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">build_auth_frame</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span> <span class="n">OPEN_AUTH_REQUEST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">join_net</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">authenticate_timeout</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">=</span> <span class="n">AWAITING_RESPONSE</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* end authenticate */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_authenticate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">UCHAR</span> <span class="n">buff</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ray_rx_msg</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ray_rx_msg</span> <span class="o">*</span><span class="p">)</span> <span class="n">buff</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">copy_from_rx_buff</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="n">rx_len</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* if we are trying to get authenticated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_network_type</span> <span class="o">==</span> <span class="n">ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs rx_auth var= %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		      <span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs Sending authentication response.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">build_auth_frame</span>
			    <span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_2</span><span class="p">,</span> <span class="n">OPEN_AUTH_RESPONSE</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">=</span> <span class="n">NEED_TO_AUTH</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_id</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_2</span><span class="p">,</span>
				       <span class="n">ADDRLEN</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* Infrastructure network */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">==</span> <span class="n">AWAITING_RESPONSE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Verify authentication sequence #2 and success */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Authentication successful</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_AUTH_COMPLETE</span><span class="p">;</span>
					<span class="n">associate</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">=</span>
					    <span class="n">AUTHENTICATED</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Authentication refused</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_AUTH_REFUSED</span><span class="p">;</span>
					<span class="n">join_net</span><span class="p">((</span><span class="n">u_long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">=</span>
					    <span class="n">UNAUTHENTICATED</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span> <span class="cm">/* end rx_authenticate */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">associate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">finder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs associate - device not present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If no tx buffers available, return */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ccsindex</span> <span class="o">=</span> <span class="n">get_free_ccs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cm">/* TBD should never be here but... what if we are? */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs associate - No free ccs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs Starting association with access point</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">ccsindex</span><span class="p">;</span>
	<span class="cm">/* fill in the CCS */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_START_ASSOCIATION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="cm">/* Interrupt the firmware to process the command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ccsindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ray_cs associate failed - ECF not ready for intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>

		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">local</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">join_net</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span> <span class="o">=</span> <span class="n">CARD_ASSOC_FAILED</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sniffer</span><span class="p">)</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="p">}</span> <span class="cm">/* end associate */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_deauthenticate</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rcs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">prcs</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pkt_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rx_len</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*  UCHAR buff[256];</span>
<span class="cm">    struct ray_rx_msg *msg = (struct ray_rx_msg *) buff;</span>
<span class="cm">*/</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Deauthentication frame received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">authentication_state</span> <span class="o">=</span> <span class="n">UNAUTHENTICATED</span><span class="p">;</span>
	<span class="cm">/* Need to reauthenticate or rejoin depending on reason code */</span>
<span class="cm">/*  copy_from_rx_buff(local, buff, pkt_addr, rx_len &amp; 0xff);</span>
<span class="cm"> */</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_interrupt</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">amem</span> <span class="o">+</span> <span class="n">CIS_OFFSET</span> <span class="o">+</span> <span class="n">HCS_INTR_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cp">#define MAXDATA (PAGE_SIZE - 80)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">card_status</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Card inserted - uninitialized&quot;</span><span class="p">,</span>	<span class="cm">/* 0 */</span>
	<span class="s">&quot;Card not downloaded&quot;</span><span class="p">,</span>			<span class="cm">/* 1 */</span>
	<span class="s">&quot;Waiting for download parameters&quot;</span><span class="p">,</span>	<span class="cm">/* 2 */</span>
	<span class="s">&quot;Card doing acquisition&quot;</span><span class="p">,</span>		<span class="cm">/* 3 */</span>
	<span class="s">&quot;Acquisition complete&quot;</span><span class="p">,</span>			<span class="cm">/* 4 */</span>
	<span class="s">&quot;Authentication complete&quot;</span><span class="p">,</span>		<span class="cm">/* 5 */</span>
	<span class="s">&quot;Association complete&quot;</span><span class="p">,</span>			<span class="cm">/* 6 */</span>
	<span class="s">&quot;???&quot;</span><span class="p">,</span> <span class="s">&quot;???&quot;</span><span class="p">,</span> <span class="s">&quot;???&quot;</span><span class="p">,</span> <span class="s">&quot;???&quot;</span><span class="p">,</span>		<span class="cm">/* 7 8 9 10 undefined */</span>
	<span class="s">&quot;Card init error&quot;</span><span class="p">,</span>			<span class="cm">/* 11 */</span>
	<span class="s">&quot;Download parameters error&quot;</span><span class="p">,</span>		<span class="cm">/* 12 */</span>
	<span class="s">&quot;???&quot;</span><span class="p">,</span>					<span class="cm">/* 13 */</span>
	<span class="s">&quot;Acquisition failed&quot;</span><span class="p">,</span>			<span class="cm">/* 14 */</span>
	<span class="s">&quot;Authentication refused&quot;</span><span class="p">,</span>		<span class="cm">/* 15 */</span>
	<span class="s">&quot;Association failed&quot;</span>			<span class="cm">/* 16 */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nettype</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Adhoc&quot;</span><span class="p">,</span> <span class="s">&quot;Infra &quot;</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">framing</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;Encapsulation&quot;</span><span class="p">,</span> <span class="s">&quot;Translation&quot;</span> <span class="p">}</span>

<span class="p">;</span>
<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_cs_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/* Print current values which are not available via other means</span>
<span class="cm"> * eg ifconfig</span>
<span class="cm"> */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">freq_hop_element</span> <span class="o">*</span><span class="n">pfh</span><span class="p">;</span>
	<span class="n">UCHAR</span> <span class="n">c</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>

	<span class="n">link</span> <span class="o">=</span> <span class="n">this_device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Raylink Wireless LAN driver status</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcsid</span><span class="p">);</span>
	<span class="cm">/* build 4 does not report version, and field is 0x55 after memtest */</span>
	<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Firmware version     = &quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span> <span class="o">==</span> <span class="mh">0x55</span><span class="p">)</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;4 - Use dump_cis for more details</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%2d.%02d.%02d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_bld</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_var</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">c</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_current_ess_id</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">c</span><span class="p">[</span><span class="mi">32</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s network ESSID = </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">nettype</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_network_type</span><span class="p">],</span> <span class="n">c</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;BSSID                = %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Country code         = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b5</span><span class="p">.</span><span class="n">a_curr_country_code</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">card_status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Card status          = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card_status</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Framing mode         = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">framing</span><span class="p">[</span><span class="n">translate</span><span class="p">]);</span>

	<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Last pkt signal lvl  = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_rsl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">beacon_rxed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Pull some fields out of last beacon received */</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Beacon Interval      = %d Kus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_bcn</span><span class="p">.</span><span class="n">beacon_intvl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
			   <span class="o">+</span> <span class="mi">256</span> <span class="o">*</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_bcn</span><span class="p">.</span><span class="n">beacon_intvl</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_bcn</span><span class="p">.</span><span class="n">elements</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">C_ESSID_ELEMENT_ID</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
				   <span class="s">&quot;Parse beacon failed at essid element id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">C_SUPPORTED_RATES_ELEMENT_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Supported rate codes = &quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;0x%02x &quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">seq_putc</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="sc">&#39;\n&#39;</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Parse beacon failed at rates element</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">C_FH_PARAM_SET_ELEMENT_ID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pfh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">freq_hop_element</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Hop dwell            = %d Kus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pfh</span><span class="o">-&gt;</span><span class="n">dwell_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span>
				   <span class="mi">256</span> <span class="o">*</span> <span class="n">pfh</span><span class="o">-&gt;</span><span class="n">dwell_time</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Hop set              = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pfh</span><span class="o">-&gt;</span><span class="n">hop_set</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Hop pattern          = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pfh</span><span class="o">-&gt;</span><span class="n">hop_pattern</span><span class="p">);</span>
			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;Hop index            = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">pfh</span><span class="o">-&gt;</span><span class="n">hop_index</span><span class="p">);</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span>
				 <span class="s">&quot;Parse beacon failed at FH param element</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">seq_puts</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;No beacons received</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ray_cs_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">ray_cs_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ray_cs_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ray_cs_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>
<span class="cm">/*===========================================================================*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_auth_frame</span><span class="p">(</span><span class="n">ray_dev_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="n">UCHAR</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="kt">int</span> <span class="n">auth_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ccs</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pccs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_msg</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ptx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ccsindex</span><span class="p">;</span>

	<span class="cm">/* If no tx buffers available, return */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ccsindex</span> <span class="o">=</span> <span class="n">get_free_tx_ccs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs send authenticate - No free tx ccs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pccs</span> <span class="o">=</span> <span class="n">ccs_base</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">+</span> <span class="n">ccsindex</span><span class="p">;</span>

	<span class="cm">/* Address in card space */</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">TX_BUF_BASE</span> <span class="o">+</span> <span class="p">(</span><span class="n">ccsindex</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="cm">/* fill in the CCS */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_TX_REQUEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_data_ptr</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_data_ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">TX_AUTHENTICATE_LENGTH_MSB</span><span class="p">,</span> <span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_data_length</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">TX_AUTHENTICATE_LENGTH_LSB</span><span class="p">,</span>
	       <span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">tx_data_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccs</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">tx_request</span><span class="p">.</span><span class="n">pow_sav_mode</span><span class="p">);</span>

	<span class="n">ptx</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sram</span> <span class="o">+</span> <span class="n">addr</span><span class="p">;</span>
	<span class="cm">/* fill in the mac header */</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">PROTOCOL_VER</span> <span class="o">|</span> <span class="n">AUTHENTIC_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">frame_ctl_1</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">frame_ctl_2</span><span class="p">);</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_1</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_2</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sparm</span><span class="p">.</span><span class="n">b4</span><span class="p">.</span><span class="n">a_mac_addr</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>
	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">.</span><span class="n">addr_3</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_id</span><span class="p">,</span> <span class="n">ADDRLEN</span><span class="p">);</span>

	<span class="cm">/* Fill in msg body with protocol 00 00, sequence 01 00 ,status 00 00 */</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">writeb</span><span class="p">(</span><span class="n">auth_type</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ptx</span><span class="o">-&gt;</span><span class="n">var</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Interrupt the firmware to process the command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">interrupt_ecf</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">ccsindex</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span>
		      <span class="s">&quot;ray_cs send authentication request failed - ECF not ready for intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">writeb</span><span class="p">(</span><span class="n">CCS_BUFFER_FREE</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pccs</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">buffer_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* End build_auth_frame */</span>

<span class="cm">/*===========================================================================*/</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ray_cs_essid_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">proc_essid</span><span class="p">[</span><span class="mi">33</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">proc_essid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">proc_essid</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">essid</span> <span class="o">=</span> <span class="n">proc_essid</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">ray_cs_essid_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">ray_cs_essid_proc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">int_proc_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">proc_number</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">proc_number</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">proc_number</span><span class="p">;</span>
	<span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">nr</span> <span class="o">=</span> <span class="n">nr</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">len</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">PDE</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_path</span><span class="p">.</span><span class="n">dentry</span><span class="o">-&gt;</span><span class="n">d_inode</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">nr</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">int_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">int_proc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">noop_llseek</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="n">ray_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCMCIA_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mh">0x01a6</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">,</span> <span class="n">ray_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="n">ray_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ray_cs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">ray_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">ray_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ray_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">ray_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">ray_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_ray_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rcsid</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcmcia_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ray_driver</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;raylink init_module register_pcmcia_driver returns 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">rc</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">proc_mkdir</span><span class="p">(</span><span class="s">&quot;driver/ray_cs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;driver/ray_cs/ray_cs&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ray_cs_proc_fops</span><span class="p">);</span>
	<span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;driver/ray_cs/essid&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ray_cs_essid_proc_fops</span><span class="p">);</span>
	<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;driver/ray_cs/net_type&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">int_proc_fops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">net_type</span><span class="p">);</span>
	<span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;driver/ray_cs/translate&quot;</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">int_proc_fops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">translate</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">translate</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">translate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* init_ray_cs */</span>

<span class="cm">/*===========================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_ray_cs</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;ray_cs: cleanup_module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/ray_cs/ray_cs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/ray_cs/essid&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/ray_cs/net_type&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/ray_cs/translate&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/ray_cs&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">pcmcia_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ray_driver</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* exit_ray_cs */</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_ray_cs</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_ray_cs</span><span class="p">);</span>

<span class="cm">/*===========================================================================*/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
