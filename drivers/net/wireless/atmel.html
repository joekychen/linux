<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › atmel.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>atmel.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*** -*- linux-c -*- **********************************************************</span>

<span class="cm">     Driver for Atmel at76c502 at76c504 and at76c506 wireless cards.</span>

<span class="cm">	Copyright 2000-2001 ATMEL Corporation.</span>
<span class="cm">	Copyright 2003-2004 Simon Kelley.</span>

<span class="cm">    This code was developed from version 2.1.1 of the Atmel drivers,</span>
<span class="cm">    released by Atmel corp. under the GPL in December 2002. It also</span>
<span class="cm">    includes code from the Linux aironet drivers (C) Benjamin Reed,</span>
<span class="cm">    and the Linux PCMCIA package, (C) David Hinds and the Linux wireless</span>
<span class="cm">    extensions, (C) Jean Tourrilhes.</span>

<span class="cm">    The firmware module for reading the MAC address of the card comes from</span>
<span class="cm">    net.russotto.AtmelMACFW, written by Matthew T. Russotto and copyright</span>
<span class="cm">    by him. net.russotto.AtmelMACFW is used under the GPL license version 2.</span>
<span class="cm">    This file contains the module in binary form and, under the terms</span>
<span class="cm">    of the GPL, in source form. The source is located at the end of the file.</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This software is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with Atmel wireless lan drivers; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm">    For all queries about this code, please contact the current author,</span>
<span class="cm">    Simon Kelley &lt;simon@thekelleys.org.uk&gt; and not Atmel Corporation.</span>

<span class="cm">    Credit is due to HP UK and Cambridge Online Systems Ltd for supplying</span>
<span class="cm">    hardware used during development of this driver.</span>

<span class="cm">******************************************************************************/</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &quot;atmel.h&quot;</span>

<span class="cp">#define DRIVER_MAJOR 0</span>
<span class="cp">#define DRIVER_MINOR 98</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Simon Kelley&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Support for Atmel at76c50x 802.11 wireless ethernet cards.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;Atmel at76c50x wireless cards&quot;</span><span class="p">);</span>

<span class="cm">/* The name of the firmware file to be loaded</span>
<span class="cm">   over-rides any automatic selection */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">firmware</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/* table of firmware file names */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">AtmelFWType</span> <span class="n">fw_type</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_file</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_file_ext</span><span class="p">;</span>
<span class="p">}</span> <span class="n">fw_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_502</span><span class="p">,</span>		<span class="s">&quot;atmel_at76c502&quot;</span><span class="p">,</span>	<span class="s">&quot;bin&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_502D</span><span class="p">,</span>		<span class="s">&quot;atmel_at76c502d&quot;</span><span class="p">,</span>	<span class="s">&quot;bin&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_502E</span><span class="p">,</span>		<span class="s">&quot;atmel_at76c502e&quot;</span><span class="p">,</span>	<span class="s">&quot;bin&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_502_3COM</span><span class="p">,</span>	<span class="s">&quot;atmel_at76c502_3com&quot;</span><span class="p">,</span>	<span class="s">&quot;bin&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_504</span><span class="p">,</span>		<span class="s">&quot;atmel_at76c504&quot;</span><span class="p">,</span>	<span class="s">&quot;bin&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_504_2958</span><span class="p">,</span>	<span class="s">&quot;atmel_at76c504_2958&quot;</span><span class="p">,</span>	<span class="s">&quot;bin&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_504A_2958</span><span class="p">,</span>	<span class="s">&quot;atmel_at76c504a_2958&quot;</span><span class="p">,</span>	<span class="s">&quot;bin&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_506</span><span class="p">,</span>		<span class="s">&quot;atmel_at76c506&quot;</span><span class="p">,</span>	<span class="s">&quot;bin&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ATMEL_FW_TYPE_NONE</span><span class="p">,</span>		<span class="nb">NULL</span><span class="p">,</span>			<span class="nb">NULL</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c502-wpa.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c502.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c502d-wpa.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c502d.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c502e-wpa.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c502e.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c502_3com-wpa.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c502_3com.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c504-wpa.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c504.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c504_2958-wpa.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c504_2958.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c504a_2958-wpa.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c504a_2958.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c506-wpa.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c506.bin&quot;</span><span class="p">);</span>

<span class="cp">#define MAX_SSID_LENGTH 32</span>
<span class="cp">#define MGMT_JIFFIES (256 * HZ / 100)</span>

<span class="cp">#define MAX_BSS_ENTRIES	64</span>

<span class="cm">/* registers */</span>
<span class="cp">#define GCR  0x00    </span><span class="cm">/* (SIR0)  General Configuration Register */</span><span class="cp"></span>
<span class="cp">#define BSR  0x02    </span><span class="cm">/* (SIR1)  Bank Switching Select Register */</span><span class="cp"></span>
<span class="cp">#define AR   0x04</span>
<span class="cp">#define DR   0x08</span>
<span class="cp">#define MR1  0x12    </span><span class="cm">/* Mirror Register 1 */</span><span class="cp"></span>
<span class="cp">#define MR2  0x14    </span><span class="cm">/* Mirror Register 2 */</span><span class="cp"></span>
<span class="cp">#define MR3  0x16    </span><span class="cm">/* Mirror Register 3 */</span><span class="cp"></span>
<span class="cp">#define MR4  0x18    </span><span class="cm">/* Mirror Register 4 */</span><span class="cp"></span>

<span class="cp">#define GPR1                            0x0c</span>
<span class="cp">#define GPR2                            0x0e</span>
<span class="cp">#define GPR3                            0x10</span>
<span class="cm">/*</span>
<span class="cm"> * Constants for the GCR register.</span>
<span class="cm"> */</span>
<span class="cp">#define GCR_REMAP     0x0400          </span><span class="cm">/* Remap internal SRAM to 0 */</span><span class="cp"></span>
<span class="cp">#define GCR_SWRES     0x0080          </span><span class="cm">/* BIU reset (ARM and PAI are NOT reset) */</span><span class="cp"></span>
<span class="cp">#define GCR_CORES     0x0060          </span><span class="cm">/* Core Reset (ARM and PAI are reset) */</span><span class="cp"></span>
<span class="cp">#define GCR_ENINT     0x0002          </span><span class="cm">/* Enable Interrupts */</span><span class="cp"></span>
<span class="cp">#define GCR_ACKINT    0x0008          </span><span class="cm">/* Acknowledge Interrupts */</span><span class="cp"></span>

<span class="cp">#define BSS_SRAM      0x0200          </span><span class="cm">/* AMBA module selection --&gt; SRAM */</span><span class="cp"></span>
<span class="cp">#define BSS_IRAM      0x0100          </span><span class="cm">/* AMBA module selection --&gt; IRAM */</span><span class="cp"></span>
<span class="cm">/*</span>
<span class="cm"> *Constants for the MR registers.</span>
<span class="cm"> */</span>
<span class="cp">#define MAC_INIT_COMPLETE       0x0001        </span><span class="cm">/* MAC init has been completed */</span><span class="cp"></span>
<span class="cp">#define MAC_BOOT_COMPLETE       0x0010        </span><span class="cm">/* MAC boot has been completed */</span><span class="cp"></span>
<span class="cp">#define MAC_INIT_OK             0x0002        </span><span class="cm">/* MAC boot has been completed */</span><span class="cp"></span>

<span class="cp">#define MIB_MAX_DATA_BYTES    212</span>
<span class="cp">#define MIB_HEADER_SIZE       4    </span><span class="cm">/* first four fields */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">get_set_mib</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="n">MIB_MAX_DATA_BYTES</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rx_desc</span> <span class="p">{</span>
	<span class="n">u32</span>          <span class="n">Next</span><span class="p">;</span>
	<span class="n">u16</span>          <span class="n">MsduPos</span><span class="p">;</span>
	<span class="n">u16</span>          <span class="n">MsduSize</span><span class="p">;</span>

	<span class="n">u8</span>           <span class="n">State</span><span class="p">;</span>
	<span class="n">u8</span>           <span class="n">Status</span><span class="p">;</span>
	<span class="n">u8</span>           <span class="n">Rate</span><span class="p">;</span>
	<span class="n">u8</span>           <span class="n">Rssi</span><span class="p">;</span>
	<span class="n">u8</span>           <span class="n">LinkQuality</span><span class="p">;</span>
	<span class="n">u8</span>           <span class="n">PreambleType</span><span class="p">;</span>
	<span class="n">u16</span>          <span class="n">Duration</span><span class="p">;</span>
	<span class="n">u32</span>          <span class="n">RxTime</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define RX_DESC_FLAG_VALID       0x80</span>
<span class="cp">#define RX_DESC_FLAG_CONSUMED    0x40</span>
<span class="cp">#define RX_DESC_FLAG_IDLE        0x00</span>

<span class="cp">#define RX_STATUS_SUCCESS        0x00</span>

<span class="cp">#define RX_DESC_MSDU_POS_OFFSET      4</span>
<span class="cp">#define RX_DESC_MSDU_SIZE_OFFSET     6</span>
<span class="cp">#define RX_DESC_FLAGS_OFFSET         8</span>
<span class="cp">#define RX_DESC_STATUS_OFFSET        9</span>
<span class="cp">#define RX_DESC_RSSI_OFFSET          11</span>
<span class="cp">#define RX_DESC_LINK_QUALITY_OFFSET  12</span>
<span class="cp">#define RX_DESC_PREAMBLE_TYPE_OFFSET 13</span>
<span class="cp">#define RX_DESC_DURATION_OFFSET      14</span>
<span class="cp">#define RX_DESC_RX_TIME_OFFSET       16</span>

<span class="k">struct</span> <span class="n">tx_desc</span> <span class="p">{</span>
	<span class="n">u32</span>       <span class="n">NextDescriptor</span><span class="p">;</span>
	<span class="n">u16</span>       <span class="n">TxStartOfFrame</span><span class="p">;</span>
	<span class="n">u16</span>       <span class="n">TxLength</span><span class="p">;</span>

	<span class="n">u8</span>        <span class="n">TxState</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="n">TxStatus</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="n">RetryCount</span><span class="p">;</span>

	<span class="n">u8</span>        <span class="n">TxRate</span><span class="p">;</span>

	<span class="n">u8</span>        <span class="n">KeyIndex</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="n">ChiperType</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="n">ChipreLength</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="n">Reserved1</span><span class="p">;</span>

	<span class="n">u8</span>        <span class="n">Reserved</span><span class="p">;</span>
	<span class="n">u8</span>        <span class="n">PacketType</span><span class="p">;</span>
	<span class="n">u16</span>       <span class="n">HostTxLength</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define TX_DESC_NEXT_OFFSET          0</span>
<span class="cp">#define TX_DESC_POS_OFFSET           4</span>
<span class="cp">#define TX_DESC_SIZE_OFFSET          6</span>
<span class="cp">#define TX_DESC_FLAGS_OFFSET         8</span>
<span class="cp">#define TX_DESC_STATUS_OFFSET        9</span>
<span class="cp">#define TX_DESC_RETRY_OFFSET         10</span>
<span class="cp">#define TX_DESC_RATE_OFFSET          11</span>
<span class="cp">#define TX_DESC_KEY_INDEX_OFFSET     12</span>
<span class="cp">#define TX_DESC_CIPHER_TYPE_OFFSET   13</span>
<span class="cp">#define TX_DESC_CIPHER_LENGTH_OFFSET 14</span>
<span class="cp">#define TX_DESC_PACKET_TYPE_OFFSET   17</span>
<span class="cp">#define TX_DESC_HOST_LENGTH_OFFSET   18</span>

<span class="cm">/*</span>
<span class="cm"> * Host-MAC interface</span>
<span class="cm"> */</span>

<span class="cp">#define TX_STATUS_SUCCESS       0x00</span>

<span class="cp">#define TX_FIRM_OWN             0x80</span>
<span class="cp">#define TX_DONE                 0x40</span>

<span class="cp">#define TX_ERROR                0x01</span>

<span class="cp">#define TX_PACKET_TYPE_DATA     0x01</span>
<span class="cp">#define TX_PACKET_TYPE_MGMT     0x02</span>

<span class="cp">#define ISR_EMPTY               0x00        </span><span class="cm">/* no bits set in ISR */</span><span class="cp"></span>
<span class="cp">#define ISR_TxCOMPLETE          0x01        </span><span class="cm">/* packet transmitted */</span><span class="cp"></span>
<span class="cp">#define ISR_RxCOMPLETE          0x02        </span><span class="cm">/* packet received */</span><span class="cp"></span>
<span class="cp">#define ISR_RxFRAMELOST         0x04        </span><span class="cm">/* Rx Frame lost */</span><span class="cp"></span>
<span class="cp">#define ISR_FATAL_ERROR         0x08        </span><span class="cm">/* Fatal error */</span><span class="cp"></span>
<span class="cp">#define ISR_COMMAND_COMPLETE    0x10        </span><span class="cm">/* command completed */</span><span class="cp"></span>
<span class="cp">#define ISR_OUT_OF_RANGE        0x20        </span><span class="cm">/* command completed */</span><span class="cp"></span>
<span class="cp">#define ISR_IBSS_MERGE          0x40        </span><span class="cm">/* (4.1.2.30): IBSS merge */</span><span class="cp"></span>
<span class="cp">#define ISR_GENERIC_IRQ         0x80</span>

<span class="cp">#define Local_Mib_Type          0x01</span>
<span class="cp">#define Mac_Address_Mib_Type    0x02</span>
<span class="cp">#define Mac_Mib_Type            0x03</span>
<span class="cp">#define Statistics_Mib_Type     0x04</span>
<span class="cp">#define Mac_Mgmt_Mib_Type       0x05</span>
<span class="cp">#define Mac_Wep_Mib_Type        0x06</span>
<span class="cp">#define Phy_Mib_Type            0x07</span>
<span class="cp">#define Multi_Domain_MIB        0x08</span>

<span class="cp">#define MAC_MGMT_MIB_CUR_BSSID_POS            14</span>
<span class="cp">#define MAC_MIB_FRAG_THRESHOLD_POS            8</span>
<span class="cp">#define MAC_MIB_RTS_THRESHOLD_POS             10</span>
<span class="cp">#define MAC_MIB_SHORT_RETRY_POS               16</span>
<span class="cp">#define MAC_MIB_LONG_RETRY_POS                17</span>
<span class="cp">#define MAC_MIB_SHORT_RETRY_LIMIT_POS         16</span>
<span class="cp">#define MAC_MGMT_MIB_BEACON_PER_POS           0</span>
<span class="cp">#define MAC_MGMT_MIB_STATION_ID_POS           6</span>
<span class="cp">#define MAC_MGMT_MIB_CUR_PRIVACY_POS          11</span>
<span class="cp">#define MAC_MGMT_MIB_CUR_BSSID_POS            14</span>
<span class="cp">#define MAC_MGMT_MIB_PS_MODE_POS              53</span>
<span class="cp">#define MAC_MGMT_MIB_LISTEN_INTERVAL_POS      54</span>
<span class="cp">#define MAC_MGMT_MIB_MULTI_DOMAIN_IMPLEMENTED 56</span>
<span class="cp">#define MAC_MGMT_MIB_MULTI_DOMAIN_ENABLED     57</span>
<span class="cp">#define PHY_MIB_CHANNEL_POS                   14</span>
<span class="cp">#define PHY_MIB_RATE_SET_POS                  20</span>
<span class="cp">#define PHY_MIB_REG_DOMAIN_POS                26</span>
<span class="cp">#define LOCAL_MIB_AUTO_TX_RATE_POS            3</span>
<span class="cp">#define LOCAL_MIB_SSID_SIZE                   5</span>
<span class="cp">#define LOCAL_MIB_TX_PROMISCUOUS_POS          6</span>
<span class="cp">#define LOCAL_MIB_TX_MGMT_RATE_POS            7</span>
<span class="cp">#define LOCAL_MIB_TX_CONTROL_RATE_POS         8</span>
<span class="cp">#define LOCAL_MIB_PREAMBLE_TYPE               9</span>
<span class="cp">#define MAC_ADDR_MIB_MAC_ADDR_POS             0</span>

<span class="cp">#define         CMD_Set_MIB_Vars              0x01</span>
<span class="cp">#define         CMD_Get_MIB_Vars              0x02</span>
<span class="cp">#define         CMD_Scan                      0x03</span>
<span class="cp">#define         CMD_Join                      0x04</span>
<span class="cp">#define         CMD_Start                     0x05</span>
<span class="cp">#define         CMD_EnableRadio               0x06</span>
<span class="cp">#define         CMD_DisableRadio              0x07</span>
<span class="cp">#define         CMD_SiteSurvey                0x0B</span>

<span class="cp">#define         CMD_STATUS_IDLE                   0x00</span>
<span class="cp">#define         CMD_STATUS_COMPLETE               0x01</span>
<span class="cp">#define         CMD_STATUS_UNKNOWN                0x02</span>
<span class="cp">#define         CMD_STATUS_INVALID_PARAMETER      0x03</span>
<span class="cp">#define         CMD_STATUS_FUNCTION_NOT_SUPPORTED 0x04</span>
<span class="cp">#define         CMD_STATUS_TIME_OUT               0x07</span>
<span class="cp">#define         CMD_STATUS_IN_PROGRESS            0x08</span>
<span class="cp">#define         CMD_STATUS_REJECTED_RADIO_OFF     0x09</span>
<span class="cp">#define         CMD_STATUS_HOST_ERROR             0xFF</span>
<span class="cp">#define         CMD_STATUS_BUSY                   0xFE</span>

<span class="cp">#define CMD_BLOCK_COMMAND_OFFSET        0</span>
<span class="cp">#define CMD_BLOCK_STATUS_OFFSET         1</span>
<span class="cp">#define CMD_BLOCK_PARAMETERS_OFFSET     4</span>

<span class="cp">#define SCAN_OPTIONS_SITE_SURVEY        0x80</span>

<span class="cp">#define MGMT_FRAME_BODY_OFFSET		24</span>
<span class="cp">#define MAX_AUTHENTICATION_RETRIES	3</span>
<span class="cp">#define MAX_ASSOCIATION_RETRIES		3</span>

<span class="cp">#define AUTHENTICATION_RESPONSE_TIME_OUT  1000</span>

<span class="cp">#define MAX_WIRELESS_BODY  2316 </span><span class="cm">/* mtu is 2312, CRC is 4 */</span><span class="cp"></span>
<span class="cp">#define LOOP_RETRY_LIMIT   500000</span>

<span class="cp">#define ACTIVE_MODE	1</span>
<span class="cp">#define PS_MODE		2</span>

<span class="cp">#define MAX_ENCRYPTION_KEYS 4</span>
<span class="cp">#define MAX_ENCRYPTION_KEY_SIZE 40</span>

<span class="cm">/*</span>
<span class="cm"> * 802.11 related definitions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Regulatory Domains</span>
<span class="cm"> */</span>

<span class="cp">#define REG_DOMAIN_FCC		0x10	</span><span class="cm">/* Channels	1-11	USA				*/</span><span class="cp"></span>
<span class="cp">#define REG_DOMAIN_DOC		0x20	</span><span class="cm">/* Channel	1-11	Canada				*/</span><span class="cp"></span>
<span class="cp">#define REG_DOMAIN_ETSI		0x30	</span><span class="cm">/* Channel	1-13	Europe (ex Spain/France)	*/</span><span class="cp"></span>
<span class="cp">#define REG_DOMAIN_SPAIN	0x31	</span><span class="cm">/* Channel	10-11	Spain				*/</span><span class="cp"></span>
<span class="cp">#define REG_DOMAIN_FRANCE	0x32	</span><span class="cm">/* Channel	10-13	France				*/</span><span class="cp"></span>
<span class="cp">#define REG_DOMAIN_MKK		0x40	</span><span class="cm">/* Channel	14	Japan				*/</span><span class="cp"></span>
<span class="cp">#define REG_DOMAIN_MKK1		0x41	</span><span class="cm">/* Channel	1-14	Japan(MKK1)			*/</span><span class="cp"></span>
<span class="cp">#define REG_DOMAIN_ISRAEL	0x50	</span><span class="cm">/* Channel	3-9	ISRAEL				*/</span><span class="cp"></span>

<span class="cp">#define BSS_TYPE_AD_HOC		1</span>
<span class="cp">#define BSS_TYPE_INFRASTRUCTURE 2</span>

<span class="cp">#define SCAN_TYPE_ACTIVE	0</span>
<span class="cp">#define SCAN_TYPE_PASSIVE	1</span>

<span class="cp">#define LONG_PREAMBLE		0</span>
<span class="cp">#define SHORT_PREAMBLE		1</span>
<span class="cp">#define AUTO_PREAMBLE		2</span>

<span class="cp">#define DATA_FRAME_WS_HEADER_SIZE   30</span>

<span class="cm">/* promiscuous mode control */</span>
<span class="cp">#define PROM_MODE_OFF			0x0</span>
<span class="cp">#define PROM_MODE_UNKNOWN		0x1</span>
<span class="cp">#define PROM_MODE_CRC_FAILED		0x2</span>
<span class="cp">#define PROM_MODE_DUPLICATED		0x4</span>
<span class="cp">#define PROM_MODE_MGMT			0x8</span>
<span class="cp">#define PROM_MODE_CTRL			0x10</span>
<span class="cp">#define PROM_MODE_BAD_PROTOCOL		0x20</span>

<span class="cp">#define IFACE_INT_STATUS_OFFSET		0</span>
<span class="cp">#define IFACE_INT_MASK_OFFSET		1</span>
<span class="cp">#define IFACE_LOCKOUT_HOST_OFFSET	2</span>
<span class="cp">#define IFACE_LOCKOUT_MAC_OFFSET	3</span>
<span class="cp">#define IFACE_FUNC_CTRL_OFFSET		28</span>
<span class="cp">#define IFACE_MAC_STAT_OFFSET		30</span>
<span class="cp">#define IFACE_GENERIC_INT_TYPE_OFFSET	32</span>

<span class="cp">#define CIPHER_SUITE_NONE     0</span>
<span class="cp">#define CIPHER_SUITE_WEP_64   1</span>
<span class="cp">#define CIPHER_SUITE_TKIP     2</span>
<span class="cp">#define CIPHER_SUITE_AES      3</span>
<span class="cp">#define CIPHER_SUITE_CCX      4</span>
<span class="cp">#define CIPHER_SUITE_WEP_128  5</span>

<span class="cm">/*</span>
<span class="cm"> * IFACE MACROS &amp; definitions</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * FuncCtrl field:</span>
<span class="cm"> */</span>
<span class="cp">#define FUNC_CTRL_TxENABLE		0x10</span>
<span class="cp">#define FUNC_CTRL_RxENABLE		0x20</span>
<span class="cp">#define FUNC_CTRL_INIT_COMPLETE		0x01</span>

<span class="cm">/* A stub firmware image which reads the MAC address from NVRAM on the card.</span>
<span class="cm">   For copyright information and source see the end of this file. */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">mac_reader</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span>
	<span class="mh">0xd3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
	<span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">,</span> <span class="mh">0xdc</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>
	<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x4c</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0xbc</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xb8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span>
	<span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xea</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x54</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span>
	<span class="mh">0xd8</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>
	<span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>
	<span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0xe9</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x9f</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xd5</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span>
	<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span>
	<span class="mh">0xfc</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe3</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>
	<span class="mh">0x70</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">atmel_private</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span> <span class="cm">/* Bus dependent structure varies for PCcard */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">present_callback</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span> <span class="cm">/* And callback which uses it */</span>
	<span class="kt">char</span> <span class="n">firmware_id</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">AtmelFWType</span> <span class="n">firmware_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">firmware</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">firmware_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">management_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">sys_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="n">wstats</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">irqlock</span><span class="p">,</span> <span class="n">timerlock</span><span class="p">;</span>	<span class="cm">/* spinlocks */</span>
	<span class="k">enum</span> <span class="p">{</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">,</span> <span class="n">BUS_TYPE_PCI</span> <span class="p">}</span> <span class="n">bus_type</span><span class="p">;</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">CARD_TYPE_PARALLEL_FLASH</span><span class="p">,</span>
		<span class="n">CARD_TYPE_SPI_FLASH</span><span class="p">,</span>
		<span class="n">CARD_TYPE_EEPROM</span>
	<span class="p">}</span> <span class="n">card_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_rx_crc</span><span class="p">;</span> <span class="cm">/* If we need to CRC incoming packets */</span>
	<span class="kt">int</span> <span class="n">probe_crc</span><span class="p">;</span> <span class="cm">/* set if we don&#39;t yet know */</span>
	<span class="kt">int</span> <span class="n">crc_ok_cnt</span><span class="p">,</span> <span class="n">crc_ko_cnt</span><span class="p">;</span> <span class="cm">/* counters for probing */</span>
	<span class="n">u16</span> <span class="n">rx_desc_head</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_desc_free</span><span class="p">,</span> <span class="n">tx_desc_head</span><span class="p">,</span> <span class="n">tx_desc_tail</span><span class="p">,</span> <span class="n">tx_desc_previous</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_free_mem</span><span class="p">,</span> <span class="n">tx_buff_head</span><span class="p">,</span> <span class="n">tx_buff_tail</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">frag_seq</span><span class="p">,</span> <span class="n">frag_len</span><span class="p">,</span> <span class="n">frag_no</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frag_source</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">u8</span> <span class="n">wep_is_on</span><span class="p">,</span> <span class="n">default_key</span><span class="p">,</span> <span class="n">exclude_unencrypted</span><span class="p">,</span> <span class="n">encryption_level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">group_cipher_suite</span><span class="p">,</span> <span class="n">pairwise_cipher_suite</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wep_keys</span><span class="p">[</span><span class="n">MAX_ENCRYPTION_KEYS</span><span class="p">][</span><span class="n">MAX_ENCRYPTION_KEY_SIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">wep_key_len</span><span class="p">[</span><span class="n">MAX_ENCRYPTION_KEYS</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">use_wpa</span><span class="p">,</span> <span class="n">radio_on_broken</span><span class="p">;</span> <span class="cm">/* firmware dependent stuff. */</span>

	<span class="n">u16</span> <span class="n">host_info_base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">host_info_struct</span> <span class="p">{</span>
		<span class="cm">/* NB this is matched to the hardware, don&#39;t change. */</span>
		<span class="n">u8</span> <span class="k">volatile</span> <span class="n">int_status</span><span class="p">;</span>
		<span class="n">u8</span> <span class="k">volatile</span> <span class="n">int_mask</span><span class="p">;</span>
		<span class="n">u8</span> <span class="k">volatile</span> <span class="n">lockout_host</span><span class="p">;</span>
		<span class="n">u8</span> <span class="k">volatile</span> <span class="n">lockout_mac</span><span class="p">;</span>

		<span class="n">u16</span> <span class="n">tx_buff_pos</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">tx_buff_size</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">tx_desc_pos</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">tx_desc_count</span><span class="p">;</span>

		<span class="n">u16</span> <span class="n">rx_buff_pos</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rx_buff_size</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rx_desc_pos</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rx_desc_count</span><span class="p">;</span>

		<span class="n">u16</span> <span class="n">build_version</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">command_pos</span><span class="p">;</span>

		<span class="n">u16</span> <span class="n">major_version</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">minor_version</span><span class="p">;</span>

		<span class="n">u16</span> <span class="n">func_ctrl</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">mac_status</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">generic_IRQ_type</span><span class="p">;</span>
		<span class="n">u8</span>  <span class="n">reserved</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">host_info</span><span class="p">;</span>

	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">STATION_STATE_SCANNING</span><span class="p">,</span>
		<span class="n">STATION_STATE_JOINNING</span><span class="p">,</span>
		<span class="n">STATION_STATE_AUTHENTICATING</span><span class="p">,</span>
		<span class="n">STATION_STATE_ASSOCIATING</span><span class="p">,</span>
		<span class="n">STATION_STATE_READY</span><span class="p">,</span>
		<span class="n">STATION_STATE_REASSOCIATING</span><span class="p">,</span>
		<span class="n">STATION_STATE_DOWN</span><span class="p">,</span>
		<span class="n">STATION_STATE_MGMT_ERROR</span>
	<span class="p">}</span> <span class="n">station_state</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">operating_mode</span><span class="p">,</span> <span class="n">power_mode</span><span class="p">;</span>
	<span class="kt">time_t</span> <span class="n">last_qual</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">beacons_this_sec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg_domain</span><span class="p">,</span> <span class="n">config_reg_domain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">auto_tx_rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rts_threshold</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frag_threshold</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">long_retry</span><span class="p">,</span> <span class="n">short_retry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">preamble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">default_beacon_period</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">,</span> <span class="n">listen_interval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">CurrentAuthentTransactionSeqNum</span><span class="p">,</span> <span class="n">ExpectedAuthentTransactionSeqNum</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">AuthenticationRequestRetryCnt</span><span class="p">,</span> <span class="n">AssociationRequestRetryCnt</span><span class="p">,</span> <span class="n">ReAssociationRequestRetryCnt</span><span class="p">;</span>
	<span class="k">enum</span> <span class="p">{</span>
		<span class="n">SITE_SURVEY_IDLE</span><span class="p">,</span>
		<span class="n">SITE_SURVEY_IN_PROGRESS</span><span class="p">,</span>
		<span class="n">SITE_SURVEY_COMPLETED</span>
	<span class="p">}</span> <span class="n">site_survey_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_survey</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">station_was_associated</span><span class="p">,</span> <span class="n">station_is_associated</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fast_scan</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">bss_info</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">SSIDsize</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">RSSI</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">UsingWEP</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">preamble</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">beacon_period</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">BSStype</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">BSSID</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">SSID</span><span class="p">[</span><span class="n">MAX_SSID_LENGTH</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">BSSinfo</span><span class="p">[</span><span class="n">MAX_BSS_ENTRIES</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">BSS_list_entries</span><span class="p">,</span> <span class="n">current_BSS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">connect_to_any_BSS</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">SSID_size</span><span class="p">,</span> <span class="n">new_SSID_size</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">CurrentBSSID</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">BSSID</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">SSID</span><span class="p">[</span><span class="n">MAX_SSID_LENGTH</span><span class="p">],</span> <span class="n">new_SSID</span><span class="p">[</span><span class="n">MAX_SSID_LENGTH</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">last_beacon_timestamp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_buf</span><span class="p">[</span><span class="n">MAX_WIRELESS_BODY</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">atmel_basic_rates</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg_domain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span> <span class="n">channel_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">{</span> <span class="n">REG_DOMAIN_FCC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&quot;USA&quot;</span> <span class="p">},</span>
		      <span class="p">{</span> <span class="n">REG_DOMAIN_DOC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&quot;Canada&quot;</span> <span class="p">},</span>
		      <span class="p">{</span> <span class="n">REG_DOMAIN_ETSI</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="s">&quot;Europe&quot;</span> <span class="p">},</span>
		      <span class="p">{</span> <span class="n">REG_DOMAIN_SPAIN</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="s">&quot;Spain&quot;</span> <span class="p">},</span>
		      <span class="p">{</span> <span class="n">REG_DOMAIN_FRANCE</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="s">&quot;France&quot;</span> <span class="p">},</span>
		      <span class="p">{</span> <span class="n">REG_DOMAIN_MKK</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="s">&quot;MKK&quot;</span> <span class="p">},</span>
		      <span class="p">{</span> <span class="n">REG_DOMAIN_MKK1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="s">&quot;MKK1&quot;</span> <span class="p">},</span>
		      <span class="p">{</span> <span class="n">REG_DOMAIN_ISRAEL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="s">&quot;Israel&quot;</span><span class="p">}</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">build_wpa_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atmel_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dest</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">src</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_set_gcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_clear_gcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atmel_lock_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_wmem32</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_command_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atmel_validate_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_management_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rssi</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_management_timer</span><span class="p">(</span><span class="n">u_long</span> <span class="n">a</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">atmel_send_command_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_size</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_transmit_management_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span> <span class="kt">int</span> <span class="n">body_len</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">atmel_get_mib8</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_set_mib8</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_set_mib16</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_set_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_get_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">specific_ssid</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_join_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bss_index</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_smooth_qual</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_writeAR</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">probe_atmel_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reset_atmel_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">atmel_enter_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_state</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">atmel_open</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">atmel_hi</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info_base</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">atmel_co</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">command_pos</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">atmel_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">rx_desc_pos</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">desc</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">atmel_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_desc_pos</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_desc</span><span class="p">)</span> <span class="o">*</span> <span class="n">desc</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">atmel_read8</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inb</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atmel_write8</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">atmel_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atmel_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">atmel_rmem8</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmel_writeAR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">atmel_read8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atmel_wmem8</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmel_writeAR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">atmel_write8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">atmel_rmem16</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmel_writeAR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">atmel_read16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">atmel_wmem16</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmel_writeAR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">atmel_handler_def</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_done_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_FLAGS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span><span class="p">))</span> <span class="o">==</span> <span class="n">TX_DONE</span> <span class="o">&amp;&amp;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_desc_count</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_STATUS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span><span class="p">));</span>
		<span class="n">u16</span> <span class="n">msdu_size</span> <span class="o">=</span> <span class="n">atmel_rmem16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_SIZE_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span><span class="p">));</span>
		<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_PACKET_TYPE_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span><span class="p">));</span>

		<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_FLAGS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_mem</span> <span class="o">+=</span> <span class="n">msdu_size</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_free</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_head</span> <span class="o">+</span> <span class="n">msdu_size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_buff_pos</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_buff_size</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_head</span> <span class="o">+=</span> <span class="n">msdu_size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_desc_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span><span class="o">++</span> <span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">TX_PACKET_TYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TX_STATUS_SUCCESS</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">find_tx_buff</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">bottom_free</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_buff_size</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_tail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_free</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_mem</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bottom_free</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_buff_pos</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_tail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_mem</span> <span class="o">-</span> <span class="n">bottom_free</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_buff_pos</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tx_update_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_bcast</span><span class="p">,</span>
				 <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">buff</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmel_wmem16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_POS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span> <span class="n">buff</span><span class="p">);</span>
	<span class="n">atmel_wmem16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_SIZE_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span><span class="p">)</span>
		<span class="n">atmel_wmem16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_HOST_LENGTH_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_PACKET_TYPE_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span> <span class="n">type</span><span class="p">);</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_RATE_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">);</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_RETRY_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">cipher_type</span><span class="p">,</span> <span class="n">cipher_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_bcast</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cipher_type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">group_cipher_suite</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cipher_type</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_WEP_64</span> <span class="o">||</span>
			    <span class="n">cipher_type</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_WEP_128</span><span class="p">)</span>
				<span class="n">cipher_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cipher_type</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_TKIP</span><span class="p">)</span>
				<span class="n">cipher_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_WEP_64</span> <span class="o">||</span>
				 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_WEP_128</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cipher_type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span><span class="p">;</span>
				<span class="n">cipher_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cipher_type</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_NONE</span><span class="p">;</span>
				<span class="n">cipher_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cipher_type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cipher_type</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_WEP_64</span> <span class="o">||</span>
			    <span class="n">cipher_type</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_WEP_128</span><span class="p">)</span>
				<span class="n">cipher_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cipher_type</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_TKIP</span><span class="p">)</span>
				<span class="n">cipher_length</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">group_cipher_suite</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_WEP_64</span> <span class="o">||</span>
				 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">group_cipher_suite</span> <span class="o">==</span> <span class="n">CIPHER_SUITE_WEP_128</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cipher_type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">group_cipher_suite</span><span class="p">;</span>
				<span class="n">cipher_length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cipher_type</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_NONE</span><span class="p">;</span>
				<span class="n">cipher_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_CIPHER_TYPE_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span>
			    <span class="n">cipher_type</span><span class="p">);</span>
		<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_CIPHER_LENGTH_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span>
			    <span class="n">cipher_length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">atmel_wmem32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_NEXT_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span> <span class="mh">0x80000000L</span><span class="p">);</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_FLAGS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">),</span> <span class="n">TX_FIRM_OWN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_previous</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">)</span>
		<span class="n">atmel_wmem32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_NEXT_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_previous</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_previous</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_desc_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_free</span><span class="o">--</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_mem</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">start_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">SNAP_RFC1024</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="n">header</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">buff</span><span class="p">,</span> <span class="n">frame_ctl</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">ETH_ZLEN</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">present_callback</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">present_callback</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">!=</span> <span class="n">STATION_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* first ensure the timer func cannot run */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timerlock</span><span class="p">);</span>
	<span class="cm">/* then stop the hardware ISR */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* nb doing the above in the opposite order will deadlock */</span>

	<span class="cm">/* The Wireless Header is 30 bytes. In the Ethernet packet we &quot;cut&quot; the</span>
<span class="cm">	   12 first bytes (containing DA/SA) and put them in the appropriate</span>
<span class="cm">	   fields of the Wireless Header. Thus the packet length is then the</span>
<span class="cm">	   initial + 18 (+30-12) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buff</span> <span class="o">=</span> <span class="n">find_tx_buff</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">18</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timerlock</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">IEEE80211_FTYPE_DATA</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">header</span><span class="p">.</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span>
		<span class="n">frame_ctl</span> <span class="o">|=</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">frame_ctl</span> <span class="o">|=</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">header</span><span class="p">.</span><span class="n">addr4</span><span class="p">,</span> <span class="n">SNAP_RFC1024</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">header</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">frame_ctl</span><span class="p">);</span>
	<span class="cm">/* Copy the wireless header into the card */</span>
	<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">DATA_FRAME_WS_HEADER_SIZE</span><span class="p">);</span>
	<span class="cm">/* Copy the packet sans its 802.3 header addresses which have been replaced */</span>
	<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buff</span> <span class="o">+</span> <span class="n">DATA_FRAME_WS_HEADER_SIZE</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_tail</span> <span class="o">+=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">DATA_FRAME_WS_HEADER_SIZE</span><span class="p">;</span>

	<span class="cm">/* low bit of first byte of destination tells us if broadcast */</span>
	<span class="n">tx_update_descriptor</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">18</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">TX_PACKET_TYPE_DATA</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timerlock</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_transmit_management_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
					    <span class="n">u8</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span> <span class="kt">int</span> <span class="n">body_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">MGMT_FRAME_BODY_OFFSET</span> <span class="o">+</span> <span class="n">body_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buff</span> <span class="o">=</span> <span class="n">find_tx_buff</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">len</span><span class="p">)))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span> <span class="n">MGMT_FRAME_BODY_OFFSET</span><span class="p">);</span>
	<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">buff</span> <span class="o">+</span> <span class="n">MGMT_FRAME_BODY_OFFSET</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">body_len</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_tail</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">tx_update_descriptor</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">TX_PACKET_TYPE_MGMT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fast_rx_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">msdu_size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">crc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* fast path: unfragmented packet copy directly into skbuf */</span>
	<span class="n">u8</span> <span class="n">mac4</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	<span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">skbp</span><span class="p">;</span>

	<span class="cm">/* get the final, mac 4 header field, this tells us encapsulation */</span>
	<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mac4</span><span class="p">,</span> <span class="n">rx_packet_loc</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">msdu_size</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">mac4</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">msdu_size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">msdu_size</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">skbp</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">msdu_size</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skbp</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">rx_packet_loc</span> <span class="o">+</span> <span class="mi">30</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">netcrc</span><span class="p">;</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">skbp</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">);</span>
		<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">netcrc</span><span class="p">,</span> <span class="n">rx_packet_loc</span> <span class="o">+</span> <span class="mi">30</span> <span class="o">+</span> <span class="n">msdu_size</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">crc</span> <span class="o">^</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">netcrc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skbp</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* destination address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skbp</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skbp</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span> <span class="cm">/* source address */</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">msdu_size</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Test to see if the packet in card memory at packet_loc has a valid CRC</span>
<span class="cm">   It doesn&#39;t matter that this is slow: it is only used to proble the first few</span>
<span class="cm">   packets. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">probe_crc</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">packet_loc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">msdu_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">msdu_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">netcrc</span><span class="p">,</span> <span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msdu_size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">netcrc</span><span class="p">,</span> <span class="n">packet_loc</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">atmel_writeAR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">packet_loc</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">octet</span> <span class="o">=</span> <span class="n">atmel_read8</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">octet</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">crc</span> <span class="o">^</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">==</span> <span class="n">netcrc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">frag_rx_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">msdu_size</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">crc</span><span class="p">,</span> <span class="n">u16</span> <span class="n">seq_no</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">frag_no</span><span class="p">,</span> <span class="kt">int</span> <span class="n">more_frags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac4</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">source</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">rx_packet_loc</span> <span class="o">+=</span> <span class="mi">24</span><span class="p">;</span> <span class="cm">/* skip header */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span><span class="p">)</span>
		<span class="n">msdu_size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frag_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* first fragment */</span>
		<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">mac4</span><span class="p">,</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">msdu_size</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">rx_packet_loc</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span><span class="p">)</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">mac4</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_seq</span> <span class="o">=</span> <span class="n">seq_no</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_no</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">=</span> <span class="n">msdu_size</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_source</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">source</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

		<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">netcrc</span><span class="p">;</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">msdu_size</span><span class="p">);</span>
			<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">netcrc</span><span class="p">,</span> <span class="n">rx_packet_loc</span> <span class="o">+</span> <span class="n">msdu_size</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">crc</span> <span class="o">^</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">netcrc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_source</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_no</span> <span class="o">==</span> <span class="n">frag_no</span> <span class="o">&amp;&amp;</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_seq</span> <span class="o">==</span> <span class="n">seq_no</span> <span class="o">&amp;&amp;</span>
		   <span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_source</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">],</span>
				   <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">netcrc</span><span class="p">;</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_len</span><span class="p">],</span>
				       <span class="n">msdu_size</span><span class="p">);</span>
			<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">netcrc</span><span class="p">,</span> <span class="n">rx_packet_loc</span> <span class="o">+</span> <span class="n">msdu_size</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">crc</span> <span class="o">^</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">!=</span> <span class="n">netcrc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_source</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
				<span class="n">more_frags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* don&#39;t send broken assembly */</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">+=</span> <span class="n">msdu_size</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_no</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">more_frags</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* last one */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_source</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">+</span> <span class="mi">14</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span>
				       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
				<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">fragment</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rx_done_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="n">header</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	     <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RX_DESC_FLAGS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span><span class="p">))</span> <span class="o">==</span> <span class="n">RX_DESC_FLAG_VALID</span> <span class="o">&amp;&amp;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">rx_desc_count</span><span class="p">;</span>
	     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">u16</span> <span class="n">msdu_size</span><span class="p">,</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="n">frame_ctl</span><span class="p">,</span> <span class="n">seq_control</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RX_DESC_STATUS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span><span class="p">));</span>
		<span class="n">u32</span> <span class="n">crc</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">RX_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="cm">/* determined by experiment */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">nwid</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msdu_size</span> <span class="o">=</span> <span class="n">atmel_rmem16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RX_DESC_MSDU_SIZE_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span><span class="p">));</span>
		<span class="n">rx_packet_loc</span> <span class="o">=</span> <span class="n">atmel_rmem16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RX_DESC_MSDU_POS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msdu_size</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Get header as far as end of seq_ctrl */</span>
		<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">frame_ctl</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">frame_control</span><span class="p">);</span>
		<span class="n">seq_control</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">seq_ctrl</span><span class="p">);</span>

		<span class="cm">/* probe for CRC use here if needed  once five packets have</span>
<span class="cm">		   arrived with the same crc status, we assume we know what&#39;s</span>
<span class="cm">		   happening and stop probing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">probe_crc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">frame_ctl</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span> <span class="o">=</span> <span class="n">probe_crc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span> <span class="o">=</span> <span class="n">probe_crc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_packet_loc</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="n">msdu_size</span> <span class="o">-</span> <span class="mi">24</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">crc_ok_cnt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">probe_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">crc_ko_cnt</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">probe_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* don&#39;t CRC header when WEP in use */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">frame_ctl</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="mi">24</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">msdu_size</span> <span class="o">-=</span> <span class="mi">24</span><span class="p">;</span> <span class="cm">/* header */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">frame_ctl</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">more_fragments</span> <span class="o">=</span> <span class="n">frame_ctl</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">packet_fragment_no</span> <span class="o">=</span> <span class="n">seq_control</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">packet_sequence_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">seq_control</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">more_fragments</span> <span class="o">&amp;&amp;</span> <span class="n">packet_fragment_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fast_rx_path</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">,</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="n">crc</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">frag_rx_path</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">,</span> <span class="n">rx_packet_loc</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span>
					     <span class="n">packet_sequence_no</span><span class="p">,</span> <span class="n">packet_fragment_no</span><span class="p">,</span> <span class="n">more_fragments</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">frame_ctl</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_MGMT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy rest of packet into buffer */</span>
			<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">rx_packet_loc</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">);</span>

			<span class="cm">/* we use the same buffer for frag reassembly and control packets */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_source</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* last 4 octets is crc */</span>
				<span class="n">msdu_size</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">crc</span> <span class="o">=</span> <span class="n">crc32_le</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">crc</span> <span class="o">^</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">[</span><span class="n">msdu_size</span><span class="p">])))</span> <span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">next</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">atmel_management_frame</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="n">msdu_size</span><span class="p">,</span>
					       <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RX_DESC_RSSI_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span><span class="p">)));</span>
		<span class="p">}</span>

<span class="nl">next:</span>
		<span class="cm">/* release descriptor */</span>
		<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_rx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">RX_DESC_FLAGS_OFFSET</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span><span class="p">),</span> <span class="n">RX_DESC_FLAG_CONSUMED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">rx_desc_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">service_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">isr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">irq_order</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">ISR_OUT_OF_RANGE</span><span class="p">,</span>
		<span class="n">ISR_RxCOMPLETE</span><span class="p">,</span>
		<span class="n">ISR_TxCOMPLETE</span><span class="p">,</span>
		<span class="n">ISR_RxFRAMELOST</span><span class="p">,</span>
		<span class="n">ISR_FATAL_ERROR</span><span class="p">,</span>
		<span class="n">ISR_COMMAND_COMPLETE</span><span class="p">,</span>
		<span class="n">ISR_IBSS_MERGE</span><span class="p">,</span>
		<span class="n">ISR_GENERIC_IRQ</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">present_callback</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">present_callback</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="cm">/* In this state upper-level code assumes it can mess with</span>
<span class="cm">	   the card unhampered by interrupts which may change register state.</span>
<span class="cm">	   Note that even though the card shouldn&#39;t generate interrupts</span>
<span class="cm">	   the inturrupt line may be shared. This allows card setup</span>
<span class="cm">	   to go on without disabling interrupts for a long time. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_DOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">atmel_clear_gcr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR_ENINT</span><span class="p">);</span> <span class="cm">/* disable interrupts */</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atmel_lock_mac</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* failed to contact card */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: failed to contact MAC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">isr</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_INT_STATUS_OFFSET</span><span class="p">));</span>
		<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_LOCKOUT_MAC_OFFSET</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_set_gcr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR_ENINT</span><span class="p">);</span> <span class="cm">/* enable interrupts */</span>
			<span class="k">return</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">?</span> <span class="n">IRQ_NONE</span> <span class="o">:</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">atmel_set_gcr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR_ACKINT</span><span class="p">);</span> <span class="cm">/* acknowledge interrupt */</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">irq_order</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">isr</span> <span class="o">&amp;</span> <span class="n">irq_order</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atmel_lock_mac</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* failed to contact card */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: failed to contact MAC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">isr</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_INT_STATUS_OFFSET</span><span class="p">));</span>
		<span class="n">isr</span> <span class="o">^=</span> <span class="n">irq_order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_INT_STATUS_OFFSET</span><span class="p">),</span> <span class="n">isr</span><span class="p">);</span>
		<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_LOCKOUT_MAC_OFFSET</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">irq_order</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">ISR_OUT_OF_RANGE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISR_RxFRAMELOST</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">ISR_RxCOMPLETE</span>:
			<span class="n">rx_done_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISR_TxCOMPLETE</span>:
			<span class="n">tx_done_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISR_FATAL_ERROR</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: *** FATAL error interrupt ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_MGMT_ERROR</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISR_COMMAND_COMPLETE</span>:
			<span class="n">atmel_command_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISR_IBSS_MERGE</span>:
			<span class="n">atmel_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MGMT_MIB_CUR_BSSID_POS</span><span class="p">,</span>
				      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="cm">/* The WPA stuff cares about the current AP address */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span><span class="p">)</span>
				<span class="n">build_wpa_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ISR_GENERIC_IRQ</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Generic_irq received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">atmel_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* update the link quality here in case we are seeing no beacons</span>
<span class="cm">	   at all to drive the process */</span>
	<span class="n">atmel_smooth_qual</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">!=</span> <span class="n">STATION_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="p">(</span><span class="n">IW_QUAL_QUAL_INVALID</span>
					<span class="o">|</span> <span class="n">IW_QUAL_LEVEL_INVALID</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">|=</span> <span class="n">IW_QUAL_NOISE_INVALID</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Quality levels cannot be determined in ad-hoc mode,</span>
<span class="cm">		   because we can &#39;hear&#39; more that one remote station. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_QUAL_INVALID</span>
					<span class="o">|</span> <span class="n">IW_QUAL_LEVEL_INVALID</span>
					<span class="o">|</span> <span class="n">IW_QUAL_NOISE_INVALID</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">miss</span><span class="p">.</span><span class="n">beacon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="mi">2312</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">memcpy</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">atmel_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">atmel_open</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">atmel_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* any scheduled timer is no longer needed and might screw things up.. */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">);</span>

	<span class="cm">/* Interrupts will not touch the card once in this state... */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">=</span> <span class="n">STATION_STATE_DOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AuthenticationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AssociationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReAssociationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ExpectedAuthentTransactionSeqNum</span> <span class="o">=</span> <span class="mh">0x0002</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">site_survey_state</span> <span class="o">=</span> <span class="n">SITE_SURVEY_IDLE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">reset_atmel_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">config_reg_domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">config_reg_domain</span><span class="p">;</span>
		<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Phy_Mib_Type</span><span class="p">,</span> <span class="n">PHY_MIB_REG_DOMAIN_POS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">atmel_get_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Phy_Mib_Type</span><span class="p">,</span> <span class="n">PHY_MIB_REG_DOMAIN_POS</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">==</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_domain</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_table</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">REG_DOMAIN_MKK1</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: failed to get regulatory domain: assuming MKK1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">channel</span> <span class="o">=</span> <span class="n">atmel_validate_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* this moves station_state on.... */</span>
	<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">atmel_set_gcr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR_ENINT</span><span class="p">);</span> <span class="cm">/* enable interrupts */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Send event to userspace that we are disassociating */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_DOWN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
	<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_validate_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check that channel is OK, if so return zero,</span>
<span class="cm">	   else return suitable default channel */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">==</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_domain</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min</span> <span class="o">&amp;&amp;</span>
			    <span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_proc_output</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Driver version:</span><span class="se">\t\t</span><span class="s">%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">DRIVER_MAJOR</span><span class="p">,</span> <span class="n">DRIVER_MINOR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">!=</span> <span class="n">STATION_STATE_DOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Firmware version:</span><span class="se">\t</span><span class="s">%d.%d build %d</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;Firmware location:</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">major_version</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">minor_version</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">build_version</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">!=</span> <span class="n">CARD_TYPE_EEPROM</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;on card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s loaded by host</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s loaded by hotplug</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CARD_TYPE_PARALLEL_FLASH</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="s">&quot;Parallel flash&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CARD_TYPE_SPI_FLASH</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="s">&quot;SPI flash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CARD_TYPE_EEPROM</span>:
			<span class="n">c</span> <span class="o">=</span> <span class="s">&quot;EEPROM&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">c</span> <span class="o">=</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">==</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_domain</span><span class="p">)</span>
				<span class="n">r</span> <span class="o">=</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;MAC memory type:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Regulatory domain:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Host CRC checking:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span> <span class="o">?</span> <span class="s">&quot;On&quot;</span> <span class="o">:</span> <span class="s">&quot;Off&quot;</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;WPA-capable firmware:</span><span class="se">\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span> <span class="o">?</span> <span class="s">&quot;Yes&quot;</span> <span class="o">:</span> <span class="s">&quot;No&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STATION_STATE_SCANNING</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Scanning&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATION_STATE_JOINNING</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Joining&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATION_STATE_AUTHENTICATING</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Authenticating&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATION_STATE_ASSOCIATING</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Associating&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATION_STATE_READY</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Ready&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATION_STATE_REASSOCIATING</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Reassociating&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATION_STATE_MGMT_ERROR</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Management error&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STATION_STATE_DOWN</span>:
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;Down&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Current state:</span><span class="se">\t\t</span><span class="s">%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_read_proc</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">atmel_proc_output</span> <span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">off</span><span class="o">+</span><span class="n">count</span><span class="p">)</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">off</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">atmel_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">atmel_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">atmel_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> 	<span class="o">=</span> <span class="n">atmel_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">atmel_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> 	<span class="o">=</span> <span class="n">start_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span> 		<span class="o">=</span> <span class="n">atmel_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">init_atmel_card</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">port</span><span class="p">,</span>
				   <span class="k">const</span> <span class="n">AtmelFWType</span> <span class="n">fw_type</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">sys_dev</span><span class="p">,</span>
				   <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">card_present</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="kt">void</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">ent</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Create the network device object. */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;atmel: Couldn&#39;t get name!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_dev</span> <span class="o">=</span> <span class="n">sys_dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">present_callback</span> <span class="o">=</span> <span class="n">card_present</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">=</span> <span class="n">fw_type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">firmware</span><span class="p">)</span> <span class="cm">/* module parameter */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">,</span> <span class="n">firmware</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">card_present</span> <span class="o">?</span> <span class="n">BUS_TYPE_PCCARD</span> <span class="o">:</span> <span class="n">BUS_TYPE_PCI</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">=</span> <span class="n">STATION_STATE_DOWN</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">do_rx_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* For PCMCIA cards, some chips need CRC, some don&#39;t</span>
<span class="cm">	   so we have to probe. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">probe_crc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">crc_ok_cnt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">crc_ko_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">probe_crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_qual</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_beacon_timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_source</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_source</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span> <span class="cm">/* Initialize to something invalid.... */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_was_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_survey</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">LONG_PREAMBLE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_to_any_BSS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config_reg_domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_tx_rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="mi">2346</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="mi">2347</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">group_cipher_suite</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_NONE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_beacon_period</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">timerlock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">atmel_management_timer</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">atmel_handler_def</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sys_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">service_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: register interrupt %d failed, rc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span> <span class="o">?</span>  <span class="s">&quot;atmel_cs&quot;</span> <span class="o">:</span> <span class="s">&quot;atmel_pci&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">err_out_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_atmel_card</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ent</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span> <span class="p">(</span><span class="s">&quot;driver/atmel&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">atmel_read_proc</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ent</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;atmel: unable to create /proc entry.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Atmel at76c50x. Version %d.%d. MAC %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRIVER_MAJOR</span><span class="p">,</span> <span class="n">DRIVER_MINOR</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">err_out_res:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
<span class="nl">err_out_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_free:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">init_atmel_card</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">stop_atmel_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* put a brick on it... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
	<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">);</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/atmel&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stop_atmel_card</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Check if we asked for `any&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_to_any_BSS</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_to_any_BSS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check the size of the string */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_SSID_LENGTH</span><span class="p">)</span>
			 <span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span> <span class="o">=</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Get the current SSID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span><span class="p">);</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">new_SSID_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">);</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_to_any_BSS</span><span class="p">;</span> <span class="cm">/* active */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Basic checking: do we have a key to set ?</span>
<span class="cm">	 * Note : with the new API, it&#39;s impossible to get a NULL pointer.</span>
<span class="cm">	 * Therefore, we need to check a key size == 0 instead.</span>
<span class="cm">	 * New version of iwconfig properly set the IW_ENCODE_NOKEY flag</span>
<span class="cm">	 * when no key is present (only change flags), but older versions</span>
<span class="cm">	 * don&#39;t do it. - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">current_index</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">;</span>
		<span class="cm">/* Check the size of the key */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check the index (none -&gt; use current) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">current_index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="cm">/* Set the length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="cm">/* Disable the key */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Check if the key is not marked as invalid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Cleanup */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
			<span class="cm">/* Copy the key in the driver */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">extra</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* WE specify that if a valid key is set, encryption</span>
<span class="cm">		 * should be enabled (user may turn it off later)</span>
<span class="cm">		 * This is also how &quot;iwconfig ethX key on&quot; works */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">current_index</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_WEP_128</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_WEP_64</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Do we want to just set the transmit key index ? */</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="cm">/* Don&#39;t complain if only change the mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_MODE</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Read the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_WEP_128</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_WEP_64</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span><span class="p">)</span>
			<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>
	<span class="p">}</span>
		<span class="cm">/* Which key do we want ? -1 -&gt; tx index */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">;</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Copy the key to the user buffer */</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="n">alg</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">,</span> <span class="n">set_key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Determine and validate the key index */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span>
	    <span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">set_key</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the requested key first */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_NONE</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_NONE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_WEP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_WEP_128</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span> <span class="o">=</span> <span class="n">CIPHER_SUITE_WEP_64</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">13</span><span class="p">);</span>
			<span class="n">key_len</span> <span class="o">=</span> <span class="n">min</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_key_len</span><span class="p">;</span>

	<span class="n">max_key_len</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">;</span>

	<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_WEP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="cm">/*</span>
<span class="cm">		 * atmel does not use these parameters</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>: <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="cm">/* Silently accept disable of WPA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">cwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cwrq</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11-DS&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_tx_rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_tx_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Which type of value ? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Setting by rate index */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Setting by frequency value */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span>  <span class="mi">1000000</span>:
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span>  <span class="mi">2000000</span>:
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span>  <span class="mi">5500000</span>:
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">11000000</span>:
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="n">__u32</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">uwrq</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">uwrq</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="n">__u32</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_tx_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">11000000</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span>  <span class="mi">1000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span>  <span class="mi">2000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span>  <span class="mi">5500000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">11000000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_ON</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_SHORT</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* No modifier : set both */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* Can&#39;t be disabled */</span>

	<span class="cm">/* Note : by default, display the short retry number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LONG</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry</span><span class="p">)</span>
			<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_RETRY_SHORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rthr</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">rthr</span> <span class="o">=</span> <span class="mi">2347</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rthr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rthr</span> <span class="o">&gt;</span> <span class="mi">2347</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">rthr</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">;</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2347</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">fthr</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">fthr</span> <span class="o">=</span> <span class="mi">2346</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fthr</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fthr</span> <span class="o">&gt;</span> <span class="mi">2346</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fthr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* Get an even value - is it really needed ??? */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">fthr</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">;</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2346</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>

	<span class="cm">/* If setting by frequency, convert to a channel */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>

		<span class="cm">/* Hack to fall through... */</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_freq_to_dsss_chan</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Setting by channel number */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atmel_validate_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Note : you may have realised that, as this is a SET operation,</span>
<span class="cm">	 * this is privileged and therefore a normal user can&#39;t</span>
<span class="cm">	 * perform scanning.</span>
<span class="cm">	 * This is not an error, while the device perform scanning,</span>
<span class="cm">	 * traffic doesn&#39;t flow, so it&#39;s a perfect DoS...</span>
<span class="cm">	 * Jean II */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_DOWN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* Timeout old surveys. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_survey</span> <span class="o">+</span> <span class="mi">20</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">site_survey_state</span> <span class="o">=</span> <span class="n">SITE_SURVEY_IDLE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_survey</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Initiate a scan command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">site_survey_state</span> <span class="o">==</span> <span class="n">SITE_SURVEY_IN_PROGRESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">site_survey_state</span> <span class="o">=</span> <span class="n">SITE_SURVEY_IN_PROGRESS</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fast_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_event</span>	<span class="n">iwe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">site_survey_state</span> <span class="o">!=</span> <span class="n">SITE_SURVEY_COMPLETED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span>

		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span>  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SSIDsize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SSID</span><span class="p">);</span>

		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSStype</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">);</span>

		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>

		<span class="cm">/* Add quality statistics */</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVQUAL</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RSSI</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span>  <span class="o">=</span> <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
		<span class="cm">/* iwe.u.qual.noise  = SOMETHING */</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">);</span>


		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">UsingWEP</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Length of data */</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_ev</span> <span class="o">-</span> <span class="n">extra</span><span class="p">);</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">));</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_nwid</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_nwid</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_table</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">==</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">reg_domain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">max</span> <span class="o">-</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">min</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="cm">/* List index */</span>

			<span class="cm">/* Values in MHz -&gt; * 10^5 * 10 */</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">ieee80211_dsss_chan_to_freq</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">*</span>
					    <span class="mi">100000</span><span class="p">);</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_NOISE_INVALID</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_NOISE_INVALID</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">1000000</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">2000000</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">5500000</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11000000</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_rts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_rts</span> <span class="o">=</span> <span class="mi">2347</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_frag</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_frag</span> <span class="o">=</span> <span class="mi">2346</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmp_flags</span> <span class="o">=</span> <span class="n">IW_POWER_ON</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmt_flags</span> <span class="o">=</span> <span class="n">IW_POWER_ON</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pm_capa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_capa</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">r_time_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_retry</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">any</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">off</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">any</span><span class="p">,</span> <span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">UsingWEP</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span>  <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">UsingWEP</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">);</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">atmel_join_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_config_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>	<span class="cm">/* NULL */</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">zwrq</span><span class="p">,</span>			<span class="cm">/* NULL */</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>			<span class="cm">/* NULL */</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">atmel_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">atmel_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_config_commit</span><span class="p">,</span>	<span class="cm">/* SIOCSIWCOMMIT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_name</span><span class="p">,</span>		<span class="cm">/* SIOCGIWNAME */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWNWID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWNWID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_freq</span><span class="p">,</span>		<span class="cm">/* SIOCSIWFREQ */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_freq</span><span class="p">,</span>		<span class="cm">/* SIOCGIWFREQ */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_mode</span><span class="p">,</span>		<span class="cm">/* SIOCSIWMODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_mode</span><span class="p">,</span>		<span class="cm">/* SIOCGIWMODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWSENS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWSENS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWRANGE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_range</span><span class="p">,</span>           <span class="cm">/* SIOCGIWRANGE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWPRIV */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWPRIV */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWSTATS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWSTATS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWSPY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWSPY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_wap</span><span class="p">,</span>		<span class="cm">/* SIOCSIWAP */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_wap</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAP */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWAPLIST */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_scan</span><span class="p">,</span>		<span class="cm">/* SIOCSIWSCAN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_scan</span><span class="p">,</span>		<span class="cm">/* SIOCGIWSCAN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_essid</span><span class="p">,</span>		<span class="cm">/* SIOCSIWESSID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_essid</span><span class="p">,</span>		<span class="cm">/* SIOCGIWESSID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWNICKN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWNICKN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_rate</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRATE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_rate</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRATE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_rts</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRTS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_rts</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRTS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_frag</span><span class="p">,</span>		<span class="cm">/* SIOCSIWFRAG */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_frag</span><span class="p">,</span>		<span class="cm">/* SIOCGIWFRAG */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWTXPOW */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWTXPOW */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_retry</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRETRY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_retry</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRETRY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_encode</span><span class="p">,</span>		<span class="cm">/* SIOCSIWENCODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_encode</span><span class="p">,</span>		<span class="cm">/* SIOCGIWENCODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_power</span><span class="p">,</span>		<span class="cm">/* SIOCSIWPOWER */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_power</span><span class="p">,</span>		<span class="cm">/* SIOCGIWPOWER */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWGENIE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWGENIE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_auth</span><span class="p">,</span>		<span class="cm">/* SIOCSIWAUTH */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_auth</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAUTH */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_set_encodeext</span><span class="p">,</span>	<span class="cm">/* SIOCSIWENCODEEXT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">atmel_get_encodeext</span><span class="p">,</span>	<span class="cm">/* SIOCGIWENCODEEXT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWPMKSA */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">atmel_private_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCIWFIRSTPRIV */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">atmel_priv_ioctl</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">id</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span> <span class="n">atmel_priv_ioctl</span><span class="p">;</span>

<span class="cp">#define ATMELFWL	SIOCIWFIRSTPRIV</span>
<span class="cp">#define ATMELIDIFC	ATMELFWL + 1</span>
<span class="cp">#define ATMELRD		ATMELFWL + 2</span>
<span class="cp">#define ATMELMAGIC 0x51807</span>
<span class="cp">#define REGDOMAINSZ 20</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">atmel_private_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ATMELFWL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_BYTE</span>
				<span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span>
				<span class="o">|</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">atmel_priv_ioctl</span><span class="p">),</span>
		<span class="p">.</span><span class="n">get_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;atmelfwl&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ATMELIDIFC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;atmelidifc&quot;</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">ATMELRD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">REGDOMAINSZ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_args</span> <span class="o">=</span> <span class="n">IW_PRIV_TYPE_NONE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;regdomain&quot;</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">atmel_handler_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_standard</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">atmel_private_args</span><span class="p">),</span>
	<span class="p">.</span><span class="n">standard</span>	<span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmel_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private</span>	<span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmel_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="o">*</span><span class="p">)</span> <span class="n">atmel_private_args</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">atmel_get_wireless_stats</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">atmel_priv_ioctl</span> <span class="n">com</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">wrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span> <span class="n">rq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">new_firmware</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">domain</span><span class="p">[</span><span class="n">REGDOMAINSZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATMELIDIFC</span>:
		<span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ATMELMAGIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATMELFWL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">com</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">com</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">new_firmware</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">new_firmware</span><span class="p">,</span> <span class="n">com</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">com</span><span class="p">.</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_firmware</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">);</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware</span> <span class="o">=</span> <span class="n">new_firmware</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_length</span> <span class="o">=</span> <span class="n">com</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">,</span> <span class="n">com</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ATMELRD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">REGDOMAINSZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">domain</span><span class="p">[</span><span class="n">REGDOMAINSZ</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* strcasecmp doesn&#39;t exist in the library */</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="n">domain</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">char</span> <span class="n">c1</span> <span class="o">=</span> <span class="o">*</span><span class="n">a</span><span class="o">++</span><span class="p">;</span>
				<span class="kt">char</span> <span class="n">c2</span> <span class="o">=</span> <span class="o">*</span><span class="n">b</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tolower</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">c2</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">a</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">config_reg_domain</span> <span class="o">=</span> <span class="n">channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_domain</span><span class="p">;</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">!=</span> <span class="n">STATION_STATE_DOWN</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">atmel_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">auth_body</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">alg</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">trans_seq</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">el_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chall_text_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">chall_text</span><span class="p">[</span><span class="mi">253</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_enter_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">old_state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">=</span> <span class="n">new_state</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_state</span> <span class="o">==</span> <span class="n">STATION_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">STATION_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_beacon_timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">specific_ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">BSSID</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">SSID</span><span class="p">[</span><span class="n">MAX_SSID_LENGTH</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">scan_type</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">BSS_type</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">min_channel_time</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">max_channel_time</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">options</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">SSID_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">BSSID</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fast_scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">SSID_size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">min_channel_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">max_channel_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">SSID_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">min_channel_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">max_channel_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">120</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">specific_ssid</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">options</span> <span class="o">|=</span> <span class="n">SCAN_OPTIONS_SITE_SURVEY</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">SCAN_TYPE_ACTIVE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">BSS_type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">?</span>
		<span class="n">BSS_TYPE_AD_HOC</span> <span class="o">:</span> <span class="n">BSS_TYPE_INFRASTRUCTURE</span><span class="p">);</span>

	<span class="n">atmel_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_Scan</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* This must come after all hardware access to avoid being messed up</span>
<span class="cm">	   by stuff happening in interrupt context after we leave STATE_DOWN */</span>
	<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_SCANNING</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">join</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">BSSID</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">SSID</span><span class="p">[</span><span class="n">MAX_SSID_LENGTH</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">BSS_type</span><span class="p">;</span> <span class="cm">/* this is a short in a scan command - weird */</span>
		<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">timeout</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">SSID_size</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">SSID_size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">BSS_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

	<span class="n">atmel_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_Join</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">start</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">BSSID</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">SSID</span><span class="p">[</span><span class="n">MAX_SSID_LENGTH</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">BSS_type</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">SSID_size</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">SSID_size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">BSS_type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>

	<span class="n">atmel_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_Start</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_beacon_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">capability</span><span class="p">,</span>
				<span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rejoin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new</span> <span class="o">=</span> <span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span> <span class="o">?</span>
		<span class="n">SHORT_PREAMBLE</span> <span class="o">:</span> <span class="n">LONG_PREAMBLE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">!=</span> <span class="n">new</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
		<span class="n">rejoin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Local_Mib_Type</span><span class="p">,</span> <span class="n">LOCAL_MIB_PREAMBLE_TYPE</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">rejoin</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Phy_Mib_Type</span><span class="p">,</span> <span class="n">PHY_MIB_CHANNEL_POS</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rejoin</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_JOINNING</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
			<span class="n">join</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BSS_TYPE_INFRASTRUCTURE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">join</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BSS_TYPE_AD_HOC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_authentication_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">system</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">challenge</span><span class="p">,</span> <span class="kt">int</span> <span class="n">challenge_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">auth_body</span> <span class="n">auth</span><span class="p">;</span>

	<span class="n">header</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_AUTH</span><span class="p">);</span>
	<span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">header</span><span class="p">.</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="cm">/* no WEP for authentication frames with TrSeqNo 1 */</span>
		<span class="n">header</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">|=</span>  <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">);</span>

	<span class="n">auth</span><span class="p">.</span><span class="n">alg</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">system</span><span class="p">);</span>

	<span class="n">auth</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">auth</span><span class="p">.</span><span class="n">trans_seq</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ExpectedAuthentTransactionSeqNum</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">challenge_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>	<span class="p">{</span>
		<span class="n">auth</span><span class="p">.</span><span class="n">el_id</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span> <span class="cm">/* challenge_text */</span>
		<span class="n">auth</span><span class="p">.</span><span class="n">chall_text_len</span> <span class="o">=</span> <span class="n">challenge_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">auth</span><span class="p">.</span><span class="n">chall_text</span><span class="p">,</span> <span class="n">challenge</span><span class="p">,</span> <span class="n">challenge_len</span><span class="p">);</span>
		<span class="n">atmel_transmit_management_frame</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">auth</span><span class="p">,</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">challenge_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">atmel_transmit_management_frame</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">auth</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_association_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_reassoc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid_el_p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bodysize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ass_req_format</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">capability</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">listen_interval</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">ap</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span> <span class="cm">/* nothing after here directly accessible */</span>
		<span class="n">u8</span> <span class="n">ssid_el_id</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">ssid_len</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">ssid</span><span class="p">[</span><span class="n">MAX_SSID_LENGTH</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">sup_rates_el_id</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">sup_rates_len</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">body</span><span class="p">;</span>

	<span class="n">header</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">is_reassoc</span> <span class="o">?</span> <span class="n">IEEE80211_STYPE_REASSOC_REQ</span> <span class="o">:</span> <span class="n">IEEE80211_STYPE_ASSOC_REQ</span><span class="p">));</span>
	<span class="n">header</span><span class="p">.</span><span class="n">duration_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">header</span><span class="p">.</span><span class="n">seq_ctrl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">header</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">body</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_ESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span>
		<span class="n">body</span><span class="p">.</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">==</span> <span class="n">SHORT_PREAMBLE</span><span class="p">)</span>
		<span class="n">body</span><span class="p">.</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">);</span>

	<span class="n">body</span><span class="p">.</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>

	<span class="cm">/* current AP address - only in reassoc frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_reassoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">ap</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">ssid_el_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">body</span><span class="p">.</span><span class="n">ssid_el_id</span><span class="p">;</span>
		<span class="n">bodysize</span> <span class="o">=</span> <span class="mi">18</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ssid_el_p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">body</span><span class="p">.</span><span class="n">ap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">bodysize</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ssid_el_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
	<span class="n">ssid_el_p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid_el_p</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">);</span>
	<span class="n">ssid_el_p</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
	<span class="n">ssid_el_p</span><span class="p">[</span><span class="mi">3</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* len of suported rates */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid_el_p</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">,</span> <span class="n">atmel_basic_rates</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">atmel_transmit_management_frame</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">header</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">body</span><span class="p">,</span> <span class="n">bodysize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_frame_from_current_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">retrieve_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_rssi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">128</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_to_any_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Select a BSS with the max-RSSI but of the same type and of</span>
<span class="cm">		   the same WEP mode and that it is not marked as &#39;bad&#39; (i.e.</span>
<span class="cm">		   we had previously failed to connect to this BSS with the</span>
<span class="cm">		   settings that we currently use) */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_BSS</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSStype</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">UsingWEP</span><span class="p">)</span> <span class="o">||</span>
			     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">UsingWEP</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">max_rssi</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RSSI</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_BSS</span> <span class="o">=</span> <span class="n">max_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">max_index</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SSIDsize</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSStype</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atmel_validate_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RSSI</span> <span class="o">&gt;=</span> <span class="n">max_rssi</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">max_rssi</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">RSSI</span><span class="p">;</span>
				<span class="n">max_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">max_index</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">store_bss_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="n">u16</span> <span class="n">capability</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">beacon_period</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ssid_len</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_beacon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span> <span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_ESS</span> <span class="o">?</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr2</span> <span class="o">:</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bss</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* If we process a probe and an entry from this BSS exists</span>
<span class="cm">	   we will update the BSS entry with the info from this BSS.</span>
<span class="cm">	   If we process a beacon we will only update RSSI */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span> <span class="o">==</span> <span class="n">MAX_BSS_ENTRIES</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSS_list_entries</span><span class="o">++</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">BSSID</span><span class="p">,</span> <span class="n">bss</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">RSSI</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">RSSI</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">RSSI</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_beacon</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">beacon_period</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">UsingWEP</span> <span class="o">=</span> <span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">SSID</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">SSIDsize</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">BSStype</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">BSStype</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span> <span class="o">?</span>
		<span class="n">SHORT_PREAMBLE</span> <span class="o">:</span> <span class="n">LONG_PREAMBLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">authenticate</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">frame_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">auth_body</span> <span class="o">*</span><span class="n">auth</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">auth_body</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">trans_seq_no</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">trans_seq</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">system</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">auth</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WLAN_STATUS_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no WEP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_was_associated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_REASSOCIATING</span><span class="p">);</span>
			<span class="n">send_association_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_ASSOCIATING</span><span class="p">);</span>
			<span class="n">send_association_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WLAN_STATUS_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">should_associate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* WEP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">trans_seq_no</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ExpectedAuthentTransactionSeqNum</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">system</span> <span class="o">==</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">trans_seq_no</span> <span class="o">==</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">should_associate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">system</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">trans_seq_no</span> <span class="o">==</span> <span class="mh">0x0002</span> <span class="o">&amp;&amp;</span>
			    <span class="n">auth</span><span class="o">-&gt;</span><span class="n">el_id</span> <span class="o">==</span> <span class="n">WLAN_EID_CHALLENGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">send_authentication_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">system</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">chall_text</span><span class="p">,</span> <span class="n">auth</span><span class="o">-&gt;</span><span class="n">chall_text_len</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">trans_seq_no</span> <span class="o">==</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">should_associate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">should_associate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_was_associated</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_REASSOCIATING</span><span class="p">);</span>
				<span class="n">send_association_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_ASSOCIATING</span><span class="p">);</span>
				<span class="n">send_association_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WLAN_STATUS_NOT_SUPPORTED_AUTH_ALG</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Flip back and forth between WEP auth modes until the max</span>
<span class="cm">		 * authentication tries has been exceeded.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">system</span> <span class="o">==</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span> <span class="o">=</span> <span class="mh">0x001</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">send_authentication_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">system</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span>
			   <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span> <span class="o">=</span> <span class="mh">0x001</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">send_authentication_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_to_any_BSS</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bss_index</span><span class="p">;</span>

			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[(</span><span class="kt">int</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_BSS</span><span class="p">)].</span><span class="n">channel</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">bss_index</span>  <span class="o">=</span> <span class="n">retrieve_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmel_join_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_index</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AuthenticationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>  <span class="n">STATION_STATE_MGMT_ERROR</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">subtype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ass_resp_format</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">capability</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">ass_id</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">el_id</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">ass_resp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ass_resp_format</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ass_resp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">ass_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ass_resp</span><span class="o">-&gt;</span><span class="n">ass_id</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">rates_len</span> <span class="o">=</span> <span class="n">ass_resp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="n">ass_resp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_len</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">rates_len</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WLAN_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subtype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_ASSOC_RESP</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AssociationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReAssociationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">atmel_set_mib16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span>
				<span class="n">MAC_MGMT_MIB_STATION_ID_POS</span><span class="p">,</span> <span class="n">ass_id</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">);</span>
		<span class="n">atmel_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Phy_Mib_Type</span><span class="p">,</span>
			      <span class="n">PHY_MIB_RATE_SET_POS</span><span class="p">,</span> <span class="n">ass_resp</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">rates_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span>
				       <span class="n">MAC_MGMT_MIB_PS_MODE_POS</span><span class="p">,</span> <span class="n">ACTIVE_MODE</span><span class="p">);</span>
			<span class="n">atmel_set_mib16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span>
					<span class="n">MAC_MGMT_MIB_LISTEN_INTERVAL_POS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span>
				       <span class="n">MAC_MGMT_MIB_PS_MODE_POS</span><span class="p">,</span>  <span class="n">PS_MODE</span><span class="p">);</span>
			<span class="n">atmel_set_mib16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span>
					<span class="n">MAC_MGMT_MIB_LISTEN_INTERVAL_POS</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_was_associated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_READY</span><span class="p">);</span>

		<span class="cm">/* Send association event to userspace */</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subtype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_ASSOC_RESP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">status</span> <span class="o">!=</span> <span class="n">WLAN_STATUS_ASSOC_DENIED_RATES</span> <span class="o">&amp;&amp;</span>
	    <span class="n">status</span> <span class="o">!=</span> <span class="n">WLAN_STATUS_CAPS_UNSUPPORTED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AssociationRequestRetryCnt</span> <span class="o">&lt;</span> <span class="n">MAX_ASSOCIATION_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MGMT_JIFFIES</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AssociationRequestRetryCnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">send_association_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subtype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_REASSOC_RESP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">status</span> <span class="o">!=</span> <span class="n">WLAN_STATUS_ASSOC_DENIED_RATES</span> <span class="o">&amp;&amp;</span>
	    <span class="n">status</span> <span class="o">!=</span> <span class="n">WLAN_STATUS_CAPS_UNSUPPORTED</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">AssociationRequestRetryCnt</span> <span class="o">&lt;</span> <span class="n">MAX_ASSOCIATION_RETRIES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MGMT_JIFFIES</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReAssociationRequestRetryCnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">send_association_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>  <span class="n">STATION_STATE_MGMT_ERROR</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_to_any_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bss_index</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[(</span><span class="kt">int</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_BSS</span><span class="p">)].</span><span class="n">channel</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">bss_index</span> <span class="o">=</span> <span class="n">retrieve_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">atmel_join_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_join_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bss_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bss_info</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span>  <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[</span><span class="n">bss_index</span><span class="p">];</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">BSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">SSIDsize</span><span class="p">);</span>

	<span class="cm">/* The WPA stuff cares about the current AP address */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span><span class="p">)</span>
		<span class="n">build_wpa_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="cm">/* When switching to AdHoc turn OFF Power Save if needed */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">BSStype</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span>
			       <span class="n">MAC_MGMT_MIB_PS_MODE_POS</span><span class="p">,</span>  <span class="n">ACTIVE_MODE</span><span class="p">);</span>
		<span class="n">atmel_set_mib16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span>
				<span class="n">MAC_MGMT_MIB_LISTEN_INTERVAL_POS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">BSStype</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">!=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">;</span>
		<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Local_Mib_Type</span><span class="p">,</span>
			       <span class="n">LOCAL_MIB_PREAMBLE_TYPE</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">UsingWEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_MGMT_ERROR</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">UsingWEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_MGMT_ERROR</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_JOINNING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
		<span class="n">join</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BSS_TYPE_INFRASTRUCTURE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">join</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BSS_TYPE_AD_HOC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">restart_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bss_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connect_to_any_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">BSSinfo</span><span class="p">[(</span><span class="kt">int</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_BSS</span><span class="p">)].</span><span class="n">channel</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">bss_index</span> <span class="o">=</span> <span class="n">retrieve_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">atmel_join_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_index</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smooth_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">old</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_rssi</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span> <span class="cm">/* 502-rmfd-revd max by experiment, default for now */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ATMEL_FW_TYPE_502E</span>:
		<span class="n">max_rssi</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span> <span class="cm">/* 502-rmfd-reve max by experiment */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">max_rssi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">+</span> <span class="n">old</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">+</span> <span class="n">old</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">+</span> <span class="n">old</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">|=</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IW_QUAL_LEVEL_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_smooth_qual</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">time_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_qual</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_diff</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_qual</span> <span class="o">+=</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">+=</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacons_this_sec</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">*</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">+</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4000</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacons_this_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">|=</span> <span class="n">IW_QUAL_QUAL_UPDATED</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IW_QUAL_QUAL_INVALID</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* deals with incoming management frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_management_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">subtype</span><span class="p">;</span>

	<span class="n">subtype</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_STYPE</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">subtype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_BEACON</span>:
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_PROBE_RESP</span>:

		<span class="cm">/* beacon frame has multiple variable-length fields -</span>
<span class="cm">		   never let an engineer loose with a data structure design. */</span>
		<span class="p">{</span>
			<span class="k">struct</span> <span class="n">beacon_format</span> <span class="p">{</span>
				<span class="n">__le64</span> <span class="n">timestamp</span><span class="p">;</span>
				<span class="n">__le16</span> <span class="n">interval</span><span class="p">;</span>
				<span class="n">__le16</span> <span class="n">capability</span><span class="p">;</span>
				<span class="n">u8</span> <span class="n">ssid_el_id</span><span class="p">;</span>
				<span class="n">u8</span> <span class="n">ssid_length</span><span class="p">;</span>
				<span class="cm">/* ssid here */</span>
				<span class="n">u8</span> <span class="n">rates_el_id</span><span class="p">;</span>
				<span class="n">u8</span> <span class="n">rates_length</span><span class="p">;</span>
				<span class="cm">/* rates here */</span>
				<span class="n">u8</span> <span class="n">ds_el_id</span><span class="p">;</span>
				<span class="n">u8</span> <span class="n">ds_length</span><span class="p">;</span>
				<span class="cm">/* ds here */</span>
			<span class="p">}</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">beacon_format</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>

			<span class="n">u8</span> <span class="n">channel</span><span class="p">,</span> <span class="n">rates_length</span><span class="p">,</span> <span class="n">ssid_length</span><span class="p">;</span>
			<span class="n">u64</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
			<span class="n">u16</span> <span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">);</span>
			<span class="n">u16</span> <span class="n">capability</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">beaconp</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_buf</span><span class="p">;</span>
			<span class="n">ssid_length</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_length</span><span class="p">;</span>
			<span class="cm">/* this blows chunks. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_len</span> <span class="o">&lt;</span> <span class="mi">14</span> <span class="o">||</span> <span class="n">frame_len</span> <span class="o">&lt;</span> <span class="n">ssid_length</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">rates_length</span> <span class="o">=</span> <span class="n">beaconp</span><span class="p">[</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ssid_length</span> <span class="o">+</span> <span class="mi">15</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame_len</span> <span class="o">&lt;</span> <span class="n">ssid_length</span> <span class="o">+</span> <span class="n">rates_length</span> <span class="o">+</span> <span class="mi">18</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssid_length</span> <span class="o">&gt;</span>  <span class="n">MAX_SSID_LENGTH</span><span class="p">)</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="n">channel</span> <span class="o">=</span> <span class="n">beaconp</span><span class="p">[</span><span class="n">ssid_length</span> <span class="o">+</span> <span class="n">rates_length</span> <span class="o">+</span> <span class="mi">18</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">smooth_rssi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rssi</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_frame_from_current_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">header</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacons_this_sec</span><span class="o">++</span><span class="p">;</span>
					<span class="n">atmel_smooth_qual</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_beacon_timestamp</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* Note truncate this to 32 bits - kernel can&#39;t divide a long long */</span>
						<span class="n">u32</span> <span class="n">beacon_delay</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_beacon_timestamp</span><span class="p">;</span>
						<span class="kt">int</span> <span class="n">beacons</span> <span class="o">=</span> <span class="n">beacon_delay</span> <span class="o">/</span> <span class="p">(</span><span class="n">beacon_interval</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">beacons</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
							<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">miss</span><span class="p">.</span><span class="n">beacon</span> <span class="o">+=</span> <span class="n">beacons</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_beacon_timestamp</span> <span class="o">=</span> <span class="n">timestamp</span><span class="p">;</span>
					<span class="n">handle_beacon_probe</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">capability</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_SCANNING</span><span class="p">)</span>
				<span class="n">store_bss_info</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">capability</span><span class="p">,</span>
					       <span class="n">beacon_interval</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">rssi</span><span class="p">,</span>
					       <span class="n">ssid_length</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">rates_el_id</span><span class="p">,</span>
					       <span class="n">subtype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE80211_STYPE_AUTH</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_AUTHENTICATING</span><span class="p">)</span>
			<span class="n">authenticate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE80211_STYPE_ASSOC_RESP</span>:
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_REASSOC_RESP</span>:

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_ASSOCIATING</span> <span class="o">||</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span> <span class="o">==</span> <span class="n">STATION_STATE_REASSOCIATING</span><span class="p">)</span>
			<span class="n">associate</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">subtype</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE80211_STYPE_DISASSOC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
		    <span class="n">is_frame_from_current_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">header</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_was_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_JOINNING</span><span class="p">);</span>
			<span class="n">join</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BSS_TYPE_INFRASTRUCTURE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE80211_STYPE_DEAUTH</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
		    <span class="n">is_frame_from_current_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">header</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_was_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_JOINNING</span><span class="p">);</span>
			<span class="n">join</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BSS_TYPE_INFRASTRUCTURE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* run when timer expires */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_management_timer</span><span class="p">(</span><span class="n">u_long</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Check if the card has been yanked. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">present_callback</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">present_callback</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">STATION_STATE_AUTHENTICATING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AuthenticationRequestRetryCnt</span> <span class="o">&gt;=</span> <span class="n">MAX_AUTHENTICATION_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_MGMT_ERROR</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AuthenticationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">restart_search</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">auth</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AuthenticationRequestRetryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MGMT_JIFFIES</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span><span class="p">)</span>
				<span class="n">auth</span> <span class="o">=</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">;</span>
			<span class="n">send_authentication_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	  <span class="p">}</span>
	  <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATION_STATE_ASSOCIATING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">AssociationRequestRetryCnt</span> <span class="o">==</span> <span class="n">MAX_ASSOCIATION_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_MGMT_ERROR</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AssociationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">restart_search</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AssociationRequestRetryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MGMT_JIFFIES</span><span class="p">);</span>
			<span class="n">send_association_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	  <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">STATION_STATE_REASSOCIATING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReAssociationRequestRetryCnt</span> <span class="o">==</span> <span class="n">MAX_ASSOCIATION_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_MGMT_ERROR</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReAssociationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">restart_search</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ReAssociationRequestRetryCnt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MGMT_JIFFIES</span><span class="p">);</span>
			<span class="n">send_association_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_command_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_co</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_BLOCK_STATUS_OFFSET</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">command</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_co</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_BLOCK_COMMAND_OFFSET</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">fast_scan</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CMD_STATUS_IDLE</span> <span class="o">||</span>
	    <span class="n">status</span> <span class="o">==</span> <span class="n">CMD_STATUS_IN_PROGRESS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CMD_Start</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CMD_STATUS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_was_associated</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span><span class="p">;</span>
			<span class="n">atmel_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MGMT_MIB_CUR_BSSID_POS</span><span class="p">,</span>
				      <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_READY</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_Scan</span>:
		<span class="n">fast_scan</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fast_scan</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fast_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">bss_index</span> <span class="o">=</span> <span class="n">retrieve_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">notify_scan_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bss_index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atmel_join_bss</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss_index</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
				   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">SSID_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">start</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">BSS_TYPE_AD_HOC</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fast_scan</span> <span class="o">=</span> <span class="o">!</span><span class="n">fast_scan</span><span class="p">;</span>
				<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
				<span class="n">notify_scan_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">site_survey_state</span> <span class="o">=</span> <span class="n">SITE_SURVEY_COMPLETED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">notify_scan_complete</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_SiteSurvey</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fast_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_COMPLETE</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">site_survey_state</span> <span class="o">=</span> <span class="n">SITE_SURVEY_COMPLETED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_READY</span><span class="p">);</span>
			<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_Join</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">CMD_STATUS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">operating_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_was_associated</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_is_associated</span><span class="p">;</span>
				<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_READY</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">auth</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">AuthenticationRequestRetryCnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">atmel_enter_state</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">STATION_STATE_AUTHENTICATING</span><span class="p">);</span>

				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">management_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">MGMT_JIFFIES</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentAuthentTransactionSeqNum</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span><span class="p">)</span>
					<span class="n">auth</span> <span class="o">=</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">;</span>
				<span class="n">send_authentication_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">atmel_scan</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_wakeup_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">host_info_struct</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mr1</span><span class="p">,</span> <span class="n">mr3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">CARD_TYPE_SPI_FLASH</span><span class="p">)</span>
		<span class="n">atmel_set_gcr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR_REMAP</span><span class="p">);</span>

	<span class="cm">/* wake up on-board processor */</span>
	<span class="n">atmel_clear_gcr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
	<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSR</span><span class="p">,</span> <span class="n">BSS_SRAM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">CARD_TYPE_SPI_FLASH</span><span class="p">)</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="cm">/* and wait for it */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">LOOP_RETRY_LIMIT</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mr1</span> <span class="o">=</span> <span class="n">atmel_read16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR1</span><span class="p">);</span>
		<span class="n">mr3</span> <span class="o">=</span> <span class="n">atmel_read16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mr3</span> <span class="o">&amp;</span> <span class="n">MAC_BOOT_COMPLETE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mr1</span> <span class="o">&amp;</span> <span class="n">MAC_BOOT_COMPLETE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: MAC failed to boot.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info_base</span> <span class="o">=</span> <span class="n">atmel_read16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR2</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: card missing.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* now check for completion of MAC initialization through</span>
<span class="cm">	   the FunCtrl field of the IFACE, poll MR1 to detect completion of</span>
<span class="cm">	   MAC initialization, check completion status, set interrupt mask,</span>
<span class="cm">	   enables interrupts and calls Tx and Rx initialization functions */</span>

	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_FUNC_CTRL_OFFSET</span><span class="p">),</span> <span class="n">FUNC_CTRL_INIT_COMPLETE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">LOOP_RETRY_LIMIT</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mr1</span> <span class="o">=</span> <span class="n">atmel_read16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR1</span><span class="p">);</span>
		<span class="n">mr3</span> <span class="o">=</span> <span class="n">atmel_read16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR3</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mr3</span> <span class="o">&amp;</span> <span class="n">MAC_INIT_COMPLETE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mr1</span> <span class="o">&amp;</span> <span class="n">MAC_INIT_COMPLETE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: MAC failed to initialise.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check for MAC_INIT_OK only on the register that the MAC_INIT_OK was set */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mr3</span> <span class="o">&amp;</span> <span class="n">MAC_INIT_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">atmel_read16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_INIT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: MAC failed MR3 self-test.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mr1</span> <span class="o">&amp;</span> <span class="n">MAC_INIT_COMPLETE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">atmel_read16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_INIT_OK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: MAC failed MR1 self-test.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">iface</span><span class="p">,</span>
			   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info_base</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iface</span><span class="p">));</span>

	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">tx_buff_pos</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">tx_buff_pos</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">tx_buff_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">tx_buff_size</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">tx_desc_pos</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">tx_desc_pos</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">tx_desc_count</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rx_buff_pos</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">rx_buff_pos</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rx_buff_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">rx_buff_size</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rx_desc_pos</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">rx_desc_pos</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">rx_desc_count</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">build_version</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">build_version</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">command_pos</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">command_pos</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">major_version</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">major_version</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">minor_version</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">minor_version</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">func_ctrl</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">func_ctrl</span><span class="p">);</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">mac_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">mac_status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* determine type of memory and MAC address */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">probe_atmel_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* reset pccard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>

	<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atmel_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No stored firmware so load a small stub which just</span>
<span class="cm">		   tells us the MAC address */</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">CARD_TYPE_EEPROM</span><span class="p">;</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSR</span><span class="p">,</span> <span class="n">BSS_IRAM</span><span class="p">);</span>
		<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mac_reader</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mac_reader</span><span class="p">));</span>
		<span class="n">atmel_set_gcr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR_REMAP</span><span class="p">);</span>
		<span class="n">atmel_clear_gcr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSR</span><span class="p">,</span> <span class="n">BSS_SRAM</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">LOOP_RETRY_LIMIT</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">atmel_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAC_BOOT_COMPLETE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: MAC failed to boot MAC address reader.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">atmel_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR2</span><span class="p">),</span> <span class="mi">6</span><span class="p">);</span>
			<span class="cm">/* got address, now squash it again until the network</span>
<span class="cm">			   interface is opened */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span>
				<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
			<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atmel_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">MR4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mac address easy in this case. */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">CARD_TYPE_PARALLEL_FLASH</span><span class="p">;</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="n">BSR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mh">0xc000</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>  <span class="n">BSR</span><span class="p">,</span> <span class="mh">0x200</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Standard firmware in flash, boot it up and ask</span>
<span class="cm">		   for the Mac Address */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">=</span> <span class="n">CARD_TYPE_SPI_FLASH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atmel_wakeup_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Address_Mib_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

			<span class="cm">/* got address, now squash it again until the network</span>
<span class="cm">			   interface is opened */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span>
				<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
			<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">default_mac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
			<span class="p">};</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: *** Invalid MAC address. UPGRADE Firmware ****</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">default_mac</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Move the encyption information on the MIB structure.</span>
<span class="cm">   This routine is for the pre-WPA firmware: later firmware has</span>
<span class="cm">   a different format MIB and a different routine. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_wep_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span> <span class="cm">/* NB this is matched to the hardware, don&#39;t change. */</span>
		<span class="n">u8</span> <span class="n">wep_is_on</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">default_key</span><span class="p">;</span> <span class="cm">/* 0..3 */</span>
		<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">exclude_unencrypted</span><span class="p">;</span>

		<span class="n">u32</span> <span class="n">WEPICV_error_count</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">WEP_excluded_count</span><span class="p">;</span>

		<span class="n">u8</span> <span class="n">wep_keys</span><span class="p">[</span><span class="n">MAX_ENCRYPTION_KEYS</span><span class="p">][</span><span class="mi">13</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">encryption_level</span><span class="p">;</span> <span class="cm">/* 0, 1, 2 */</span>
		<span class="n">u8</span> <span class="n">reserved2</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">mib</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mib</span><span class="p">.</span><span class="n">wep_is_on</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">mib</span><span class="p">.</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mib</span><span class="p">.</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mib</span><span class="p">.</span><span class="n">encryption_level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mib</span><span class="p">.</span><span class="n">default_key</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">;</span>
	<span class="n">mib</span><span class="p">.</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ENCRYPTION_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">13</span><span class="p">);</span>

	<span class="n">atmel_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Wep_Mib_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mib</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mib</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_wpa_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is for the later (WPA enabled) firmware. */</span>

	<span class="k">struct</span> <span class="p">{</span> <span class="cm">/* NB this is matched to the hardware, don&#39;t change. */</span>
		<span class="n">u8</span> <span class="n">cipher_default_key_value</span><span class="p">[</span><span class="n">MAX_ENCRYPTION_KEYS</span><span class="p">][</span><span class="n">MAX_ENCRYPTION_KEY_SIZE</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">receiver_address</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">wep_is_on</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">default_key</span><span class="p">;</span> <span class="cm">/* 0..3 */</span>
		<span class="n">u8</span> <span class="n">group_key</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">exclude_unencrypted</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">encryption_type</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">reserved</span><span class="p">;</span>

		<span class="n">u32</span> <span class="n">WEPICV_error_count</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">WEP_excluded_count</span><span class="p">;</span>

		<span class="n">u8</span> <span class="n">key_RSC</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">mib</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mib</span><span class="p">.</span><span class="n">wep_is_on</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">;</span>
	<span class="n">mib</span><span class="p">.</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">receiver_address</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">CurrentBSSID</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* zero all the keys before adding in valid ones. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">cipher_default_key_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">cipher_default_key_value</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* There&#39;s a comment in the Atmel code to the effect that this</span>
<span class="cm">		   is only valid when still using WEP, it may need to be set to</span>
<span class="cm">		   something to use WPA */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">key_RSC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">key_RSC</span><span class="p">));</span>

		<span class="n">mib</span><span class="p">.</span><span class="n">default_key</span> <span class="o">=</span> <span class="n">mib</span><span class="p">.</span><span class="n">group_key</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ENCRYPTION_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">cipher_default_key_value</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">MAX_ENCRYPTION_KEY_SIZE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_key</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">mib</span><span class="p">.</span><span class="n">default_key</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">mib</span><span class="p">.</span><span class="n">cipher_default_key_value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">MAX_ENCRYPTION_KEY_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
					<span class="n">mib</span><span class="p">.</span><span class="n">cipher_default_key_value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">MAX_ENCRYPTION_KEY_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">mib</span><span class="p">.</span><span class="n">group_key</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">group_cipher_suite</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pairwise_cipher_suite</span><span class="p">;</span>
					<span class="n">mib</span><span class="p">.</span><span class="n">cipher_default_key_value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">MAX_ENCRYPTION_KEY_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">mib</span><span class="p">.</span><span class="n">cipher_default_key_value</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">MAX_ENCRYPTION_KEY_SIZE</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">group_cipher_suite</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">default_key</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>
			<span class="n">mib</span><span class="p">.</span><span class="n">default_key</span> <span class="o">=</span> <span class="n">mib</span><span class="p">.</span><span class="n">group_key</span> <span class="o">!=</span> <span class="mi">255</span> <span class="o">?</span> <span class="n">mib</span><span class="p">.</span><span class="n">group_key</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mib</span><span class="p">.</span><span class="n">group_key</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>
			<span class="n">mib</span><span class="p">.</span><span class="n">group_key</span> <span class="o">=</span> <span class="n">mib</span><span class="p">.</span><span class="n">default_key</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">atmel_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Wep_Mib_Type</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mib</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mib</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_atmel_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* do everything necessary to wake up the hardware, including</span>
<span class="cm">	   waiting for the lightning strike and throwing the knife switch....</span>

<span class="cm">	   set all the Mib values which matter in the card to match</span>
<span class="cm">	   their settings in the atmel_private structure. Some of these</span>
<span class="cm">	   can be altered on the fly, but many (WEP, infrastucture or ad-hoc)</span>
<span class="cm">	   can only be changed by tearing down the world and coming back through</span>
<span class="cm">	   here.</span>

<span class="cm">	   This routine is also responsible for initialising some</span>
<span class="cm">	   hardware-specific fields in the atmel_private structure,</span>
<span class="cm">	   including a copy of the firmware&#39;s hostinfo structure</span>
<span class="cm">	   which is the route into the rest of the firmware datastructures. */</span>

	<span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">configuration</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_state</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">station_state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* data to add to the firmware names, in priority order</span>
<span class="cm">	   this implemenents firmware versioning */</span>

	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">firmware_modifier</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;-wpa&quot;</span><span class="p">,</span>
		<span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>

	<span class="cm">/* reset pccard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">BUS_TYPE_PCCARD</span><span class="p">)</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>

	<span class="cm">/* stop card , disable interrupts */</span>
	<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_type</span> <span class="o">==</span> <span class="n">CARD_TYPE_EEPROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* copy in firmware if needed */</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span> <span class="o">==</span> <span class="n">ATMEL_FW_TYPE_NONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;%s: card type is unknown: assuming at76c502 firmware is OK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
					       <span class="s">&quot;%s: if not, use the firmware= module parameter.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">strcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">,</span> <span class="s">&quot;atmel_at76c502.bin&quot;</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
					       <span class="s">&quot;%s: firmware %s is missing, cannot continue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">fw_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* get firmware filename entry based on firmware type ID */</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">fw_table</span><span class="p">[</span><span class="n">fw_index</span><span class="p">].</span><span class="n">fw_type</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_type</span>
						<span class="o">&amp;&amp;</span> <span class="n">fw_table</span><span class="p">[</span><span class="n">fw_index</span><span class="p">].</span><span class="n">fw_type</span> <span class="o">!=</span> <span class="n">ATMEL_FW_TYPE_NONE</span><span class="p">)</span>
					<span class="n">fw_index</span><span class="o">++</span><span class="p">;</span>

				<span class="cm">/* construct the actual firmware file name */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">fw_table</span><span class="p">[</span><span class="n">fw_index</span><span class="p">].</span><span class="n">fw_type</span> <span class="o">!=</span> <span class="n">ATMEL_FW_TYPE_NONE</span><span class="p">)</span> <span class="p">{</span>
					<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">firmware_modifier</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">snprintf</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="s">&quot;%s%s.%s&quot;</span><span class="p">,</span> <span class="n">fw_table</span><span class="p">[</span><span class="n">fw_index</span><span class="p">].</span><span class="n">fw_file</span><span class="p">,</span>
							<span class="n">firmware_modifier</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fw_table</span><span class="p">[</span><span class="n">fw_index</span><span class="p">].</span><span class="n">fw_file_ext</span><span class="p">);</span>
						<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">[</span><span class="mi">31</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">sys_dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
							<span class="k">break</span><span class="p">;</span>
						<span class="p">}</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span>
					       <span class="s">&quot;%s: firmware %s is missing, cannot start.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">);</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">firmware_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">fw</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mh">0x6000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSR</span><span class="p">,</span> <span class="n">BSS_IRAM</span><span class="p">);</span>
			<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">atmel_set_gcr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR_REMAP</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Remap */</span>
			<span class="n">atmel_set_gcr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GCR_REMAP</span><span class="p">);</span>
			<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSR</span><span class="p">,</span> <span class="n">BSS_IRAM</span><span class="p">);</span>
			<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fw</span><span class="p">,</span> <span class="mh">0x6000</span><span class="p">);</span>
			<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">BSR</span><span class="p">,</span> <span class="mh">0x2ff</span><span class="p">);</span>
			<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="p">[</span><span class="mh">0x6000</span><span class="p">],</span> <span class="n">len</span> <span class="o">-</span> <span class="mh">0x6000</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">atmel_wakeup_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* Check the version and set the correct flag for wpa stuff,</span>
<span class="cm">	   old and new firmware is incompatible.</span>
<span class="cm">	   The pre-wpa 3com firmware reports major version 5,</span>
<span class="cm">	   the wpa 3com firmware is major version 4 and doesn&#39;t need</span>
<span class="cm">	   the 3com broken-ness filter. */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">major_version</span> <span class="o">==</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on_broken</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">major_version</span> <span class="o">==</span> <span class="mi">5</span><span class="p">);</span>

	<span class="cm">/* unmask all irq sources */</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_INT_MASK_OFFSET</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="cm">/* int Tx system and enable Tx */</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_FLAGS_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atmel_wmem32</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_NEXT_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x80000000L</span><span class="p">);</span>
	<span class="n">atmel_wmem16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_POS_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atmel_wmem16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">TX_DESC_SIZE_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_free</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_desc_count</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_desc_previous</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_free_mem</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">host_info</span><span class="p">.</span><span class="n">tx_buff_size</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_buff_tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">configuration</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_FUNC_CTRL_OFFSET</span><span class="p">));</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_FUNC_CTRL_OFFSET</span><span class="p">),</span>
				   <span class="n">configuration</span> <span class="o">|</span> <span class="n">FUNC_CTRL_TxENABLE</span><span class="p">);</span>

	<span class="cm">/* init Rx system and enable */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_desc_head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">configuration</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_FUNC_CTRL_OFFSET</span><span class="p">));</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_FUNC_CTRL_OFFSET</span><span class="p">),</span>
				   <span class="n">configuration</span> <span class="o">|</span> <span class="n">FUNC_CTRL_RxENABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on_broken</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atmel_send_command_wait</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_EnableRadio</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">CMD_STATUS_REJECTED_RADIO_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: cannot turn the radio on.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* set up enough MIB values to run. */</span>
	<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Local_Mib_Type</span><span class="p">,</span> <span class="n">LOCAL_MIB_AUTO_TX_RATE_POS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">auto_tx_rate</span><span class="p">);</span>
	<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Local_Mib_Type</span><span class="p">,</span>  <span class="n">LOCAL_MIB_TX_PROMISCUOUS_POS</span><span class="p">,</span>  <span class="n">PROM_MODE_OFF</span><span class="p">);</span>
	<span class="n">atmel_set_mib16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MIB_RTS_THRESHOLD_POS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
	<span class="n">atmel_set_mib16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MIB_FRAG_THRESHOLD_POS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">);</span>
	<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MIB_SHORT_RETRY_POS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry</span><span class="p">);</span>
	<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MIB_LONG_RETRY_POS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">long_retry</span><span class="p">);</span>
	<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Local_Mib_Type</span><span class="p">,</span> <span class="n">LOCAL_MIB_PREAMBLE_TYPE</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">);</span>
	<span class="n">atmel_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Address_Mib_Type</span><span class="p">,</span> <span class="n">MAC_ADDR_MIB_MAC_ADDR_POS</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MGMT_MIB_PS_MODE_POS</span><span class="p">,</span> <span class="n">ACTIVE_MODE</span><span class="p">);</span>
	<span class="n">atmel_set_mib16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MGMT_MIB_LISTEN_INTERVAL_POS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atmel_set_mib16</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MGMT_MIB_BEACON_PER_POS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">default_beacon_period</span><span class="p">);</span>
	<span class="n">atmel_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Phy_Mib_Type</span><span class="p">,</span> <span class="n">PHY_MIB_RATE_SET_POS</span><span class="p">,</span> <span class="n">atmel_basic_rates</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">atmel_set_mib8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">Mac_Mgmt_Mib_Type</span><span class="p">,</span> <span class="n">MAC_MGMT_MIB_CUR_PRIVACY_POS</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_is_on</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_wpa</span><span class="p">)</span>
		<span class="n">build_wpa_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">build_wep_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_state</span> <span class="o">==</span> <span class="n">STATION_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_send_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
			       <span class="kt">void</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
		<span class="n">atmel_copy_to_card</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">atmel_co</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_BLOCK_PARAMETERS_OFFSET</span><span class="p">),</span>
				   <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_size</span><span class="p">);</span>

	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_co</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_BLOCK_COMMAND_OFFSET</span><span class="p">),</span> <span class="n">command</span><span class="p">);</span>
	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_co</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_BLOCK_STATUS_OFFSET</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_send_command_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span>
				   <span class="kt">void</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">atmel_send_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmd_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_co</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_BLOCK_STATUS_OFFSET</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_IDLE</span> <span class="o">&amp;&amp;</span>
		    <span class="n">status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_IN_PROGRESS</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: failed to contact MAC.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span>  <span class="n">CMD_STATUS_HOST_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">command</span> <span class="o">!=</span> <span class="n">CMD_EnableRadio</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">CMD_STATUS_COMPLETE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">atmel_get_mib8</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">get_set_mib</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">atmel_send_command_wait</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_Get_MIB_Vars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="n">MIB_HEADER_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_co</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_BLOCK_PARAMETERS_OFFSET</span> <span class="o">+</span> <span class="n">MIB_HEADER_SIZE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_set_mib8</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">get_set_mib</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">atmel_send_command_wait</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_Set_MIB_Vars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="n">MIB_HEADER_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_set_mib16</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">get_set_mib</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">atmel_send_command_wait</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_Set_MIB_Vars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="n">MIB_HEADER_SIZE</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_set_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">get_set_mib</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">MIB_MAX_DATA_BYTES</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: MIB buffer too small.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">atmel_send_command_wait</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_Set_MIB_Vars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="n">MIB_HEADER_SIZE</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_get_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">data_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">get_set_mib</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">data_len</span><span class="p">;</span>
	<span class="n">m</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_len</span> <span class="o">&gt;</span> <span class="n">MIB_MAX_DATA_BYTES</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ALERT</span> <span class="s">&quot;%s: MIB buffer too small.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">atmel_send_command_wait</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_Get_MIB_Vars</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m</span><span class="p">,</span> <span class="n">MIB_HEADER_SIZE</span> <span class="o">+</span> <span class="n">data_len</span><span class="p">);</span>
	<span class="n">atmel_copy_to_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
			   <span class="n">atmel_co</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_BLOCK_PARAMETERS_OFFSET</span> <span class="o">+</span> <span class="n">MIB_HEADER_SIZE</span><span class="p">),</span> <span class="n">data_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_writeAR</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">AR</span><span class="p">);</span>
	<span class="cm">/* Address register appears to need some convincing..... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data</span> <span class="o">!=</span> <span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">AR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">outw</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">AR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_copy_to_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dest</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">atmel_writeAR</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dest</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atmel_write8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>
		<span class="n">src</span><span class="o">++</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">lb</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">hb</span> <span class="o">=</span> <span class="o">*</span><span class="n">src</span><span class="o">++</span><span class="p">;</span>
		<span class="n">atmel_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">lb</span> <span class="o">|</span> <span class="p">(</span><span class="n">hb</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">atmel_write8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="o">*</span><span class="n">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_copy_to_host</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">src</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">atmel_writeAR</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">src</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">atmel_read8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
		<span class="n">dest</span><span class="o">++</span><span class="p">;</span> <span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">hw</span> <span class="o">=</span> <span class="n">atmel_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
		<span class="o">*</span><span class="n">dest</span><span class="o">++</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dest</span><span class="o">++</span> <span class="o">=</span> <span class="n">hw</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="o">*</span><span class="n">dest</span> <span class="o">=</span> <span class="n">atmel_read8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_set_gcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">GCR</span><span class="p">)</span> <span class="o">|</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">GCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_clear_gcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outw</span><span class="p">(</span><span class="n">inw</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">GCR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">GCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">atmel_lock_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
 <span class="nl">retry:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_LOCKOUT_HOST_OFFSET</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* timed out */</span>

	<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_LOCKOUT_MAC_OFFSET</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atmel_rmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_LOCKOUT_HOST_OFFSET</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">atmel_wmem8</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">atmel_hi</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IFACE_LOCKOUT_MAC_OFFSET</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">j</span><span class="o">--</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* timed out */</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">atmel_wmem32</span><span class="p">(</span><span class="k">struct</span> <span class="n">atmel_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">pos</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atmel_writeAR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">pos</span><span class="p">);</span>
	<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span> <span class="cm">/* card is little-endian */</span>
	<span class="n">atmel_write16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">DR</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************/</span>
<span class="cm">/* There follows the source form of the MAC address reading firmware       */</span>
<span class="cm">/***************************************************************************/</span>
<span class="cp">#if 0</span><span class="c"></span>

<span class="c">/* Copyright 2003 Matthew T. Russotto                                      */</span>
<span class="c">/* But derived from the Atmel 76C502 firmware written by Atmel and         */</span>
<span class="c">/* included in &quot;atmel wireless lan drivers&quot; package                        */</span>
<span class="c">/**</span>
<span class="c">    This file is part of net.russotto.AtmelMACFW, hereto referred to</span>
<span class="c">    as AtmelMACFW</span>

<span class="c">    AtmelMACFW is free software; you can redistribute it and/or modify</span>
<span class="c">    it under the terms of the GNU General Public License version 2</span>
<span class="c">    as published by the Free Software Foundation.</span>

<span class="c">    AtmelMACFW is distributed in the hope that it will be useful,</span>
<span class="c">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c">    GNU General Public License for more details.</span>

<span class="c">    You should have received a copy of the GNU General Public License</span>
<span class="c">    along with AtmelMACFW; if not, write to the Free Software</span>
<span class="c">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="c">****************************************************************************/</span>
<span class="c">/* This firmware should work on the 76C502 RFMD, RFMD_D, and RFMD_E        */</span>
<span class="c">/* It will probably work on the 76C504 and 76C502 RFMD_3COM                */</span>
<span class="c">/* It only works on SPI EEPROM versions of the card.                       */</span>

<span class="c">/* This firmware initializes the SPI controller and clock, reads the MAC   */</span>
<span class="c">/* address from the EEPROM into SRAM, and puts the SRAM offset of the MAC  */</span>
<span class="c">/* address in MR2, and sets MR3 to 0x10 to indicate it is done             */</span>
<span class="c">/* It also puts a complete copy of the EEPROM in SRAM with the offset in   */</span>
<span class="c">/* MR4, for investigational purposes (maybe we can determine chip type     */</span>
<span class="c">/* from that?)                                                             */</span>

<span class="c">	.org 0</span>
<span class="c">    .set MRBASE, 0x8000000</span>
<span class="c">	.set CPSR_INITIAL, 0xD3 /* IRQ/FIQ disabled, ARM mode, Supervisor state */</span>
<span class="c">	.set CPSR_USER, 0xD1 /* IRQ/FIQ disabled, ARM mode, USER state */</span>
<span class="c">	.set SRAM_BASE,  0x02000000</span>
<span class="c">	.set SP_BASE,    0x0F300000</span>
<span class="c">	.set UNK_BASE,   0x0F000000 /* Some internal device, but which one? */</span>
<span class="c">	.set SPI_CGEN_BASE,  0x0E000000 /* Some internal device, but which one? */</span>
<span class="c">	.set UNK3_BASE,  0x02014000 /* Some internal device, but which one? */</span>
<span class="c">	.set STACK_BASE, 0x5600</span>
<span class="c">	.set SP_SR, 0x10</span>
<span class="c">	.set SP_TDRE, 2 /* status register bit -- TDR empty */</span>
<span class="c">	.set SP_RDRF, 1 /* status register bit -- RDR full */</span>
<span class="c">	.set SP_SWRST, 0x80</span>
<span class="c">	.set SP_SPIEN, 0x1</span>
<span class="c">	.set SP_CR, 0   /* control register */</span>
<span class="c">	.set SP_MR, 4   /* mode register */</span>
<span class="c">	.set SP_RDR, 0x08 /* Read Data Register */</span>
<span class="c">	.set SP_TDR, 0x0C /* Transmit Data Register */</span>
<span class="c">	.set SP_CSR0, 0x30 /* chip select registers */</span>
<span class="c">	.set SP_CSR1, 0x34</span>
<span class="c">	.set SP_CSR2, 0x38</span>
<span class="c">	.set SP_CSR3, 0x3C</span>
<span class="c">	.set NVRAM_CMD_RDSR, 5 /* read status register */</span>
<span class="c">	.set NVRAM_CMD_READ, 3 /* read data */</span>
<span class="c">	.set NVRAM_SR_RDY, 1 /* RDY bit.  This bit is inverted */</span>
<span class="c">	.set SPI_8CLOCKS, 0xFF /* Writing this to the TDR doesn&#39;t do anything to the</span>
<span class="c">				  serial output, since SO is normally high.  But it</span>
<span class="c">				  does cause 8 clock cycles and thus 8 bits to be</span>
<span class="c">				  clocked in to the chip.  See Atmel&#39;s SPI</span>
<span class="c">				  controller (e.g. AT91M55800) timing and 4K</span>
<span class="c">				  SPI EEPROM manuals */</span>

<span class="c">	.set NVRAM_SCRATCH, 0x02000100  /* arbitrary area for scratchpad memory */</span>
<span class="c">	.set NVRAM_IMAGE, 0x02000200</span>
<span class="c">	.set NVRAM_LENGTH, 0x0200</span>
<span class="c">	.set MAC_ADDRESS_MIB, SRAM_BASE</span>
<span class="c">	.set MAC_ADDRESS_LENGTH, 6</span>
<span class="c">	.set MAC_BOOT_FLAG, 0x10</span>
<span class="c">	.set MR1, 0</span>
<span class="c">	.set MR2, 4</span>
<span class="c">	.set MR3, 8</span>
<span class="c">	.set MR4, 0xC</span>
<span class="c">RESET_VECTOR:</span>
<span class="c">	b RESET_HANDLER</span>
<span class="c">UNDEF_VECTOR:</span>
<span class="c">	b HALT1</span>
<span class="c">SWI_VECTOR:</span>
<span class="c">	b HALT1</span>
<span class="c">IABORT_VECTOR:</span>
<span class="c">	b HALT1</span>
<span class="c">DABORT_VECTOR:</span>
<span class="c">RESERVED_VECTOR:</span>
<span class="c">	b HALT1</span>
<span class="c">IRQ_VECTOR:</span>
<span class="c">	b HALT1</span>
<span class="c">FIQ_VECTOR:</span>
<span class="c">	b HALT1</span>
<span class="c">HALT1:	b HALT1</span>
<span class="c">RESET_HANDLER:</span>
<span class="c">	mov     r0, #CPSR_INITIAL</span>
<span class="c">	msr	CPSR_c, r0	/* This is probably unnecessary */</span>

<span class="c">/* I&#39;m guessing this is initializing clock generator electronics for SPI */</span>
<span class="c">	ldr	r0, =SPI_CGEN_BASE</span>
<span class="c">	mov	r1, #0</span>
<span class="c">	mov	r1, r1, lsl #3</span>
<span class="c">	orr	r1, r1, #0</span>
<span class="c">	str	r1, [r0]</span>
<span class="c">	ldr	r1, [r0, #28]</span>
<span class="c">	bic	r1, r1, #16</span>
<span class="c">	str	r1, [r0, #28]</span>
<span class="c">	mov	r1, #1</span>
<span class="c">	str	r1, [r0, #8]</span>

<span class="c">	ldr	r0, =MRBASE</span>
<span class="c">	mov	r1, #0</span>
<span class="c">	strh	r1, [r0, #MR1]</span>
<span class="c">	strh	r1, [r0, #MR2]</span>
<span class="c">	strh	r1, [r0, #MR3]</span>
<span class="c">	strh	r1, [r0, #MR4]</span>

<span class="c">	mov	sp, #STACK_BASE</span>
<span class="c">	bl	SP_INIT</span>
<span class="c">	mov	r0, #10</span>
<span class="c">	bl	DELAY9</span>
<span class="c">	bl	GET_MAC_ADDR</span>
<span class="c">	bl	GET_WHOLE_NVRAM</span>
<span class="c">	ldr	r0, =MRBASE</span>
<span class="c">	ldr	r1, =MAC_ADDRESS_MIB</span>
<span class="c">	strh	r1, [r0, #MR2]</span>
<span class="c">	ldr	r1, =NVRAM_IMAGE</span>
<span class="c">	strh	r1, [r0, #MR4]</span>
<span class="c">	mov	r1, #MAC_BOOT_FLAG</span>
<span class="c">	strh	r1, [r0, #MR3]</span>
<span class="c">HALT2:	b HALT2</span>
<span class="c">.func Get_Whole_NVRAM, GET_WHOLE_NVRAM</span>
<span class="c">GET_WHOLE_NVRAM:</span>
<span class="c">	stmdb	sp!, {lr}</span>
<span class="c">	mov	r2, #0 /* 0th bytes of NVRAM */</span>
<span class="c">	mov	r3, #NVRAM_LENGTH</span>
<span class="c">	mov	r1, #0		/* not used in routine */</span>
<span class="c">	ldr	r0, =NVRAM_IMAGE</span>
<span class="c">	bl	NVRAM_XFER</span>
<span class="c">	ldmia	sp!, {lr}</span>
<span class="c">	bx	lr</span>
<span class="c">.endfunc</span>

<span class="c">.func Get_MAC_Addr, GET_MAC_ADDR</span>
<span class="c">GET_MAC_ADDR:</span>
<span class="c">	stmdb	sp!, {lr}</span>
<span class="c">	mov	r2, #0x120	/* address of MAC Address within NVRAM */</span>
<span class="c">	mov	r3, #MAC_ADDRESS_LENGTH</span>
<span class="c">	mov	r1, #0		/* not used in routine */</span>
<span class="c">	ldr	r0, =MAC_ADDRESS_MIB</span>
<span class="c">	bl	NVRAM_XFER</span>
<span class="c">	ldmia	sp!, {lr}</span>
<span class="c">	bx	lr</span>
<span class="c">.endfunc</span>
<span class="c">.ltorg</span>
<span class="c">.func Delay9, DELAY9</span>
<span class="c">DELAY9:</span>
<span class="c">	adds	r0, r0, r0, LSL #3   /* r0 = r0 * 9 */</span>
<span class="c">DELAYLOOP:</span>
<span class="c">	beq	DELAY9_done</span>
<span class="c">	subs	r0, r0, #1</span>
<span class="c">	b	DELAYLOOP</span>
<span class="c">DELAY9_done:</span>
<span class="c">	bx	lr</span>
<span class="c">.endfunc</span>

<span class="c">.func SP_Init, SP_INIT</span>
<span class="c">SP_INIT:</span>
<span class="c">	mov	r1, #SP_SWRST</span>
<span class="c">	ldr	r0, =SP_BASE</span>
<span class="c">	str	r1, [r0, #SP_CR] /* reset the SPI */</span>
<span class="c">	mov	r1, #0</span>
<span class="c">	str	r1, [r0, #SP_CR] /* release SPI from reset state */</span>
<span class="c">	mov	r1, #SP_SPIEN</span>
<span class="c">	str	r1, [r0, #SP_MR] /* set the SPI to MASTER mode*/</span>
<span class="c">	str	r1, [r0, #SP_CR] /* enable the SPI */</span>

<span class="c">/*  My guess would be this turns on the SPI clock */</span>
<span class="c">	ldr	r3, =SPI_CGEN_BASE</span>
<span class="c">	ldr	r1, [r3, #28]</span>
<span class="c">	orr	r1, r1, #0x2000</span>
<span class="c">	str	r1, [r3, #28]</span>

<span class="c">	ldr	r1, =0x2000c01</span>
<span class="c">	str	r1, [r0, #SP_CSR0]</span>
<span class="c">	ldr	r1, =0x2000201</span>
<span class="c">	str	r1, [r0, #SP_CSR1]</span>
<span class="c">	str	r1, [r0, #SP_CSR2]</span>
<span class="c">	str	r1, [r0, #SP_CSR3]</span>
<span class="c">	ldr	r1, [r0, #SP_SR]</span>
<span class="c">	ldr	r0, [r0, #SP_RDR]</span>
<span class="c">	bx	lr</span>
<span class="c">.endfunc</span>
<span class="c">.func NVRAM_Init, NVRAM_INIT</span>
<span class="c">NVRAM_INIT:</span>
<span class="c">	ldr	r1, =SP_BASE</span>
<span class="c">	ldr	r0, [r1, #SP_RDR]</span>
<span class="c">	mov	r0, #NVRAM_CMD_RDSR</span>
<span class="c">	str	r0, [r1, #SP_TDR]</span>
<span class="c">SP_loop1:</span>
<span class="c">	ldr	r0, [r1, #SP_SR]</span>
<span class="c">	tst	r0, #SP_TDRE</span>
<span class="c">	beq	SP_loop1</span>

<span class="c">	mov	r0, #SPI_8CLOCKS</span>
<span class="c">	str	r0, [r1, #SP_TDR]</span>
<span class="c">SP_loop2:</span>
<span class="c">	ldr	r0, [r1, #SP_SR]</span>
<span class="c">	tst	r0, #SP_TDRE</span>
<span class="c">	beq	SP_loop2</span>

<span class="c">	ldr	r0, [r1, #SP_RDR]</span>
<span class="c">SP_loop3:</span>
<span class="c">	ldr	r0, [r1, #SP_SR]</span>
<span class="c">	tst	r0, #SP_RDRF</span>
<span class="c">	beq	SP_loop3</span>

<span class="c">	ldr	r0, [r1, #SP_RDR]</span>
<span class="c">	and	r0, r0, #255</span>
<span class="c">	bx	lr</span>
<span class="c">.endfunc</span>

<span class="c">.func NVRAM_Xfer, NVRAM_XFER</span>
<span class="c">	/* r0 = dest address */</span>
<span class="c">	/* r1 = not used */</span>
<span class="c">	/* r2 = src address within NVRAM */</span>
<span class="c">	/* r3 = length */</span>
<span class="c">NVRAM_XFER:</span>
<span class="c">	stmdb	sp!, {r4, r5, lr}</span>
<span class="c">	mov	r5, r0		/* save r0 (dest address) */</span>
<span class="c">	mov	r4, r3		/* save r3 (length) */</span>
<span class="c">	mov	r0, r2, LSR #5 /*  SPI memories put A8 in the command field */</span>
<span class="c">	and	r0, r0, #8</span>
<span class="c">	add	r0, r0, #NVRAM_CMD_READ</span>
<span class="c">	ldr	r1, =NVRAM_SCRATCH</span>
<span class="c">	strb	r0, [r1, #0]	/* save command in NVRAM_SCRATCH[0] */</span>
<span class="c">	strb	r2, [r1, #1]    /* save low byte of source address in NVRAM_SCRATCH[1] */</span>
<span class="c">_local1:</span>
<span class="c">	bl	NVRAM_INIT</span>
<span class="c">	tst	r0, #NVRAM_SR_RDY</span>
<span class="c">	bne	_local1</span>
<span class="c">	mov	r0, #20</span>
<span class="c">	bl	DELAY9</span>
<span class="c">	mov	r2, r4		/* length */</span>
<span class="c">	mov	r1, r5		/* dest address */</span>
<span class="c">	mov	r0, #2		/* bytes to transfer in command */</span>
<span class="c">	bl	NVRAM_XFER2</span>
<span class="c">	ldmia	sp!, {r4, r5, lr}</span>
<span class="c">	bx	lr</span>
<span class="c">.endfunc</span>

<span class="c">.func NVRAM_Xfer2, NVRAM_XFER2</span>
<span class="c">NVRAM_XFER2:</span>
<span class="c">	stmdb	sp!, {r4, r5, r6, lr}</span>
<span class="c">	ldr	r4, =SP_BASE</span>
<span class="c">	mov	r3, #0</span>
<span class="c">	cmp	r0, #0</span>
<span class="c">	bls	_local2</span>
<span class="c">	ldr	r5, =NVRAM_SCRATCH</span>
<span class="c">_local4:</span>
<span class="c">	ldrb	r6, [r5, r3]</span>
<span class="c">	str	r6, [r4, #SP_TDR]</span>
<span class="c">_local3:</span>
<span class="c">	ldr	r6, [r4, #SP_SR]</span>
<span class="c">	tst	r6, #SP_TDRE</span>
<span class="c">	beq	_local3</span>
<span class="c">	add	r3, r3, #1</span>
<span class="c">	cmp	r3, r0 /* r0 is # of bytes to send out (command+addr) */</span>
<span class="c">	blo	_local4</span>
<span class="c">_local2:</span>
<span class="c">	mov	r3, #SPI_8CLOCKS</span>
<span class="c">	str	r3, [r4, #SP_TDR]</span>
<span class="c">	ldr	r0, [r4, #SP_RDR]</span>
<span class="c">_local5:</span>
<span class="c">	ldr	r0, [r4, #SP_SR]</span>
<span class="c">	tst	r0, #SP_RDRF</span>
<span class="c">	beq	_local5</span>
<span class="c">	ldr	r0, [r4, #SP_RDR] /* what&#39;s this byte?  It&#39;s the byte read while writing the TDR -- nonsense, because the NVRAM doesn&#39;t read and write at the same time */</span>
<span class="c">	mov	r0, #0</span>
<span class="c">	cmp	r2, #0  /* r2 is # of bytes to copy in */</span>
<span class="c">	bls	_local6</span>
<span class="c">_local7:</span>
<span class="c">	ldr	r5, [r4, #SP_SR]</span>
<span class="c">	tst	r5, #SP_TDRE</span>
<span class="c">	beq	_local7</span>
<span class="c">	str	r3, [r4, #SP_TDR]  /* r3 has SPI_8CLOCKS */</span>
<span class="c">_local8:</span>
<span class="c">	ldr	r5, [r4, #SP_SR]</span>
<span class="c">	tst	r5, #SP_RDRF</span>
<span class="c">	beq	_local8</span>
<span class="c">	ldr	r5, [r4, #SP_RDR] /* but didn&#39;t we read this byte above? */</span>
<span class="c">	strb	r5, [r1], #1 /* postindexed */</span>
<span class="c">	add	r0, r0, #1</span>
<span class="c">	cmp	r0, r2</span>
<span class="c">	blo	_local7 /* since we don&#39;t send another address, the NVRAM must be capable of sequential reads */</span>
<span class="c">_local6:</span>
<span class="c">	mov	r0, #200</span>
<span class="c">	bl	DELAY9</span>
<span class="c">	ldmia	sp!, {r4, r5, r6, lr}</span>
<span class="c">	bx	lr</span>
<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
