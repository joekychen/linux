<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › at76c50x-usb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>at76c50x-usb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * at76c503/at76c505 USB driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2002 - 2003 Oliver Kurth</span>
<span class="cm"> * Copyright (c) 2004 Joerg Albert &lt;joerg.albert@gmx.de&gt;</span>
<span class="cm"> * Copyright (c) 2004 Nick Jones</span>
<span class="cm"> * Copyright (c) 2004 Balint Seeber &lt;n0_5p4m_p13453@hotmail.com&gt;</span>
<span class="cm"> * Copyright (c) 2007 Guido Guenther &lt;agx@sigxcpu.org&gt;</span>
<span class="cm"> * Copyright (c) 2007 Kalle Valo &lt;kalle.valo@iki.fi&gt;</span>
<span class="cm"> * Copyright (c) 2010 Sebastian Smolorz &lt;sesmo@gmx.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation; either version 2 of</span>
<span class="cm"> * the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is part of the Berlios driver for WLAN USB devices based on the</span>
<span class="cm"> * Atmel AT76C503A/505/505A.</span>
<span class="cm"> *</span>
<span class="cm"> * Some iw_handler code was taken from airo.c, (C) 1999 Benjamin Reed</span>
<span class="cm"> *</span>
<span class="cm"> * TODO list is at the wiki:</span>
<span class="cm"> *</span>
<span class="cm"> * http://wireless.kernel.org/en/users/Drivers/at76c50x-usb#TODO</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>
<span class="cp">#include &lt;net/ieee80211_radiotap.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/leds.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &quot;at76c50x-usb.h&quot;</span>

<span class="cm">/* Version information */</span>
<span class="cp">#define DRIVER_NAME &quot;at76c50x-usb&quot;</span>
<span class="cp">#define DRIVER_VERSION	&quot;0.17&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;Atmel at76x USB Wireless LAN Driver&quot;</span>

<span class="cm">/* at76_debug bits */</span>
<span class="cp">#define DBG_PROGRESS		0x00000001	</span><span class="cm">/* authentication/accociation */</span><span class="cp"></span>
<span class="cp">#define DBG_BSS_TABLE		0x00000002	</span><span class="cm">/* show BSS table after scans */</span><span class="cp"></span>
<span class="cp">#define DBG_IOCTL		0x00000004	</span><span class="cm">/* ioctl calls / settings */</span><span class="cp"></span>
<span class="cp">#define DBG_MAC_STATE		0x00000008	</span><span class="cm">/* MAC state transitions */</span><span class="cp"></span>
<span class="cp">#define DBG_TX_DATA		0x00000010	</span><span class="cm">/* tx header */</span><span class="cp"></span>
<span class="cp">#define DBG_TX_DATA_CONTENT	0x00000020	</span><span class="cm">/* tx content */</span><span class="cp"></span>
<span class="cp">#define DBG_TX_MGMT		0x00000040	</span><span class="cm">/* tx management */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_DATA		0x00000080	</span><span class="cm">/* rx data header */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_DATA_CONTENT	0x00000100	</span><span class="cm">/* rx data content */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_MGMT		0x00000200	</span><span class="cm">/* rx mgmt frame headers */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_BEACON		0x00000400	</span><span class="cm">/* rx beacon */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_CTRL		0x00000800	</span><span class="cm">/* rx control */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_MGMT_CONTENT	0x00001000	</span><span class="cm">/* rx mgmt content */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_FRAGS		0x00002000	</span><span class="cm">/* rx data fragment handling */</span><span class="cp"></span>
<span class="cp">#define DBG_DEVSTART		0x00004000	</span><span class="cm">/* fw download, device start */</span><span class="cp"></span>
<span class="cp">#define DBG_URB			0x00008000	</span><span class="cm">/* rx urb status, ... */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_ATMEL_HDR	0x00010000	</span><span class="cm">/* Atmel-specific Rx headers */</span><span class="cp"></span>
<span class="cp">#define DBG_PROC_ENTRY		0x00020000	</span><span class="cm">/* procedure entries/exits */</span><span class="cp"></span>
<span class="cp">#define DBG_PM			0x00040000	</span><span class="cm">/* power management settings */</span><span class="cp"></span>
<span class="cp">#define DBG_BSS_MATCH		0x00080000	</span><span class="cm">/* BSS match failures */</span><span class="cp"></span>
<span class="cp">#define DBG_PARAMS		0x00100000	</span><span class="cm">/* show configured parameters */</span><span class="cp"></span>
<span class="cp">#define DBG_WAIT_COMPLETE	0x00200000	</span><span class="cm">/* command completion */</span><span class="cp"></span>
<span class="cp">#define DBG_RX_FRAGS_SKB	0x00400000	</span><span class="cm">/* skb header of Rx fragments */</span><span class="cp"></span>
<span class="cp">#define DBG_BSS_TABLE_RM	0x00800000	</span><span class="cm">/* purging bss table entries */</span><span class="cp"></span>
<span class="cp">#define DBG_MONITOR_MODE	0x01000000	</span><span class="cm">/* monitor mode */</span><span class="cp"></span>
<span class="cp">#define DBG_MIB			0x02000000	</span><span class="cm">/* dump all MIBs on startup */</span><span class="cp"></span>
<span class="cp">#define DBG_MGMT_TIMER		0x04000000	</span><span class="cm">/* dump mgmt_timer ops */</span><span class="cp"></span>
<span class="cp">#define DBG_WE_EVENTS		0x08000000	</span><span class="cm">/* dump wireless events */</span><span class="cp"></span>
<span class="cp">#define DBG_FW			0x10000000	</span><span class="cm">/* firmware download */</span><span class="cp"></span>
<span class="cp">#define DBG_DFU			0x20000000	</span><span class="cm">/* device firmware upgrade */</span><span class="cp"></span>
<span class="cp">#define DBG_CMD			0x40000000</span>
<span class="cp">#define DBG_MAC80211		0x80000000</span>

<span class="cp">#define DBG_DEFAULTS		0</span>

<span class="cm">/* Use our own dbg macro */</span>
<span class="cp">#define at76_dbg(bits, format, arg...)					\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (at76_debug &amp; (bits))					\</span>
<span class="cp">		printk(KERN_DEBUG DRIVER_NAME &quot;: &quot; format &quot;\n&quot;, ##arg);	\</span>
<span class="cp">} while (0)</span>

<span class="cp">#define at76_dbg_dump(bits, buf, len, format, arg...)			\</span>
<span class="cp">do {									\</span>
<span class="cp">	if (at76_debug &amp; (bits)) {					\</span>
<span class="cp">		printk(KERN_DEBUG DRIVER_NAME &quot;: &quot; format &quot;\n&quot;, ##arg);	\</span>
<span class="cp">		print_hex_dump_bytes(&quot;&quot;, DUMP_PREFIX_OFFSET, buf, len);	\</span>
<span class="cp">	}								\</span>
<span class="cp">} while (0)</span>

<span class="k">static</span> <span class="n">uint</span> <span class="n">at76_debug</span> <span class="o">=</span> <span class="n">DBG_DEFAULTS</span><span class="p">;</span>

<span class="cm">/* Protect against concurrent firmware loading and parsing */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">mutex</span> <span class="n">fw_mutex</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fwentry</span> <span class="n">firmwares</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">BOARD_503_ISL3861</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;atmel_at76c503-i3861.bin&quot;</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">BOARD_503_ISL3863</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;atmel_at76c503-i3863.bin&quot;</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">BOARD_503</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;atmel_at76c503-rfmd.bin&quot;</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">BOARD_503_ACC</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;atmel_at76c503-rfmd-acc.bin&quot;</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">BOARD_505</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;atmel_at76c505-rfmd.bin&quot;</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">BOARD_505_2958</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;atmel_at76c505-rfmd2958.bin&quot;</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">BOARD_505A</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;atmel_at76c505a-rfmd2958.bin&quot;</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">BOARD_505AMX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;atmel_at76c505amx-rfmd.bin&quot;</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c503-i3861.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c503-i3863.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c503-rfmd.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c503-rfmd-acc.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c505-rfmd.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c505-rfmd2958.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c505a-rfmd2958.bin&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;atmel_at76c505amx-rfmd.bin&quot;</span><span class="p">);</span>

<span class="cp">#define USB_DEVICE_DATA(__ops)	.driver_info = (kernel_ulong_t)(__ops)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">dev_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * at76c503-i3861</span>
<span class="cm">	 */</span>
	<span class="cm">/* Generic AT76C503/3861 device */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x7603</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Linksys WUSB11 v2.1/v2.6 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x066b</span><span class="p">,</span> <span class="mh">0x2211</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Netgear MA101 rev. A */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0864</span><span class="p">,</span> <span class="mh">0x4100</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Tekram U300C / Allnet ALL0193 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0b3b</span><span class="p">,</span> <span class="mh">0x1612</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* HP HN210W J7801A */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03f0</span><span class="p">,</span> <span class="mh">0x011c</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Sitecom/Z-Com/Zyxel M4Y-750 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0cde</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Dynalink/Askey WLL013 (intersil) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x069a</span><span class="p">,</span> <span class="mh">0x0320</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* EZ connect 11Mpbs Wireless USB Adapter SMC2662W v1 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0d5c</span><span class="p">,</span> <span class="mh">0xa001</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* BenQ AWL300 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x04a5</span><span class="p">,</span> <span class="mh">0x9000</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Addtron AWU-120, Compex WLU11 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05dd</span><span class="p">,</span> <span class="mh">0xff31</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Intel AP310 AnyPoint II USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x8086</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Dynalink L11U */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0d8e</span><span class="p">,</span> <span class="mh">0x7100</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Arescom WL-210, FCC id 07J-GL2411USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0d8e</span><span class="p">,</span> <span class="mh">0x7110</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* I-O DATA WN-B11/USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x04bb</span><span class="p">,</span> <span class="mh">0x0919</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* BT Voyager 1010 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x069a</span><span class="p">,</span> <span class="mh">0x0821</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3861</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * at76c503-i3863</span>
<span class="cm">	 */</span>
	<span class="cm">/* Generic AT76C503/3863 device */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x7604</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3863</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Samsung SWL-2100U */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x055d</span><span class="p">,</span> <span class="mh">0xa000</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ISL3863</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * at76c503-rfmd</span>
<span class="cm">	 */</span>
	<span class="cm">/* Generic AT76C503/RFMD device */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x7605</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Dynalink/Askey WLL013 (rfmd) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x069a</span><span class="p">,</span> <span class="mh">0x0321</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Linksys WUSB11 v2.6 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x077b</span><span class="p">,</span> <span class="mh">0x2219</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Network Everywhere NWU11B */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x077b</span><span class="p">,</span> <span class="mh">0x2227</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Netgear MA101 rev. B */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0864</span><span class="p">,</span> <span class="mh">0x4102</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* D-Link DWL-120 rev. E */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x2001</span><span class="p">,</span> <span class="mh">0x3200</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Actiontec 802UAT1, HWU01150-01UK */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1668</span><span class="p">,</span> <span class="mh">0x7605</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* AirVast W-Buddie WN210 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x4102</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Dick Smith Electronics XH1153 802.11b USB adapter */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1371</span><span class="p">,</span> <span class="mh">0x5743</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* CNet CNUSB611 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1371</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* FiberLine FL-WL200U */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1371</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* BenQ AWL400 USB stick */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x04a5</span><span class="p">,</span> <span class="mh">0x9001</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* 3Com 3CRSHEW696 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0506</span><span class="p">,</span> <span class="mh">0x0a01</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Siemens Santis ADSL WLAN USB adapter WLL 013 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0681</span><span class="p">,</span> <span class="mh">0x001b</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Belkin F5D6050, version 2 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x050d</span><span class="p">,</span> <span class="mh">0x0050</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* iBlitzz, BWU613 (not *B or *SB) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x07b8</span><span class="p">,</span> <span class="mh">0xb000</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Gigabyte GN-WLBM101 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1044</span><span class="p">,</span> <span class="mh">0x8003</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Planex GW-US11S */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x2019</span><span class="p">,</span> <span class="mh">0x3220</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Internal WLAN adapter in h5[4,5]xx series iPAQs */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x049f</span><span class="p">,</span> <span class="mh">0x0032</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Corega Wireless LAN USB-11 mini */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x07aa</span><span class="p">,</span> <span class="mh">0x0011</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Corega Wireless LAN USB-11 mini2 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x07aa</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Uniden PCW100 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x05dd</span><span class="p">,</span> <span class="mh">0xff35</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * at76c503-rfmd-acc</span>
<span class="cm">	 */</span>
	<span class="cm">/* SMC2664W */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x083a</span><span class="p">,</span> <span class="mh">0x3501</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ACC</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Belkin F5D6050, SMC2662W v2, SMC2662W-AR */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0d5c</span><span class="p">,</span> <span class="mh">0xa002</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_503_ACC</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * at76c505-rfmd</span>
<span class="cm">	 */</span>
	<span class="cm">/* Generic AT76C505/RFMD */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x7606</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * at76c505-rfmd2958</span>
<span class="cm">	 */</span>
	<span class="cm">/* Generic AT76C505/RFMD, OvisLink WL-1130USB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x7613</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505_2958</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Fiberline FL-WL240U */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1371</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505_2958</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* CNet CNUSB-611G */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1371</span><span class="p">,</span> <span class="mh">0x0013</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505_2958</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Linksys WUSB11 v2.8 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1915</span><span class="p">,</span> <span class="mh">0x2233</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505_2958</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Xterasys XN-2122B, IBlitzz BWU613B/BWU613SB */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x12fd</span><span class="p">,</span> <span class="mh">0x1001</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505_2958</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Corega WLAN USB Stick 11 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x07aa</span><span class="p">,</span> <span class="mh">0x7613</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505_2958</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Microstar MSI Box MS6978 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0db0</span><span class="p">,</span> <span class="mh">0x1020</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505_2958</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * at76c505a-rfmd2958</span>
<span class="cm">	 */</span>
	<span class="cm">/* Generic AT76C505A device */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x7614</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505A</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Generic AT76C505AS device */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x7617</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505A</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* Siemens Gigaset USB WLAN Adapter 11 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1690</span><span class="p">,</span> <span class="mh">0x0701</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505A</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/* OQO Model 01+ Internal Wi-Fi */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1557</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505A</span><span class="p">)</span> <span class="p">},</span>
	<span class="cm">/*</span>
<span class="cm">	 * at76c505amx-rfmd</span>
<span class="cm">	 */</span>
	<span class="cm">/* Generic AT76C505AMX device */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x03eb</span><span class="p">,</span> <span class="mh">0x7615</span><span class="p">),</span> <span class="n">USB_DEVICE_DATA</span><span class="p">(</span><span class="n">BOARD_505AMX</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">dev_table</span><span class="p">);</span>

<span class="cm">/* Supported rates of this hardware, bit 7 marks basic rates */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">hw_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x16</span> <span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">preambles</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;long&quot;</span><span class="p">,</span> <span class="s">&quot;short&quot;</span><span class="p">,</span> <span class="s">&quot;auto&quot;</span> <span class="p">};</span>

<span class="cm">/* Firmware download */</span>
<span class="cm">/* DFU states */</span>
<span class="cp">#define STATE_IDLE			0x00</span>
<span class="cp">#define STATE_DETACH			0x01</span>
<span class="cp">#define STATE_DFU_IDLE			0x02</span>
<span class="cp">#define STATE_DFU_DOWNLOAD_SYNC		0x03</span>
<span class="cp">#define STATE_DFU_DOWNLOAD_BUSY		0x04</span>
<span class="cp">#define STATE_DFU_DOWNLOAD_IDLE		0x05</span>
<span class="cp">#define STATE_DFU_MANIFEST_SYNC		0x06</span>
<span class="cp">#define STATE_DFU_MANIFEST		0x07</span>
<span class="cp">#define STATE_DFU_MANIFEST_WAIT_RESET	0x08</span>
<span class="cp">#define STATE_DFU_UPLOAD_IDLE		0x09</span>
<span class="cp">#define STATE_DFU_ERROR			0x0a</span>

<span class="cm">/* DFU commands */</span>
<span class="cp">#define DFU_DETACH			0</span>
<span class="cp">#define DFU_DNLOAD			1</span>
<span class="cp">#define DFU_UPLOAD			2</span>
<span class="cp">#define DFU_GETSTATUS			3</span>
<span class="cp">#define DFU_CLRSTATUS			4</span>
<span class="cp">#define DFU_GETSTATE			5</span>
<span class="cp">#define DFU_ABORT			6</span>

<span class="cp">#define FW_BLOCK_SIZE 1024</span>

<span class="k">struct</span> <span class="n">dfu_status</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">poll_timeout</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">string</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_is_intersil</span><span class="p">(</span><span class="k">enum</span> <span class="n">board_type</span> <span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="n">BOARD_503_ISL3861</span> <span class="o">||</span> <span class="n">board</span> <span class="o">==</span> <span class="n">BOARD_503_ISL3863</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_is_503rfmd</span><span class="p">(</span><span class="k">enum</span> <span class="n">board_type</span> <span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="n">BOARD_503</span> <span class="o">||</span> <span class="n">board</span> <span class="o">==</span> <span class="n">BOARD_503_ACC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_is_505a</span><span class="p">(</span><span class="k">enum</span> <span class="n">board_type</span> <span class="n">board</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">board</span> <span class="o">==</span> <span class="n">BOARD_505A</span> <span class="o">||</span> <span class="n">board</span> <span class="o">==</span> <span class="n">BOARD_505AMX</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Load a block of the first (internal) part of the firmware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_load_int_fw_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blockno</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">DFU_DNLOAD</span><span class="p">,</span>
			       <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span>
			       <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span> <span class="n">blockno</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			       <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_dfu_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">dfu_status</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">DFU_GETSTATUS</span><span class="p">,</span>
			      <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dfu_status</span><span class="p">),</span>
			      <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">at76_dfu_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">DFU_GETSTATE</span><span class="p">,</span>
			      <span class="n">USB_TYPE_CLASS</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert timeout from the DFU status to jiffies */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">at76_get_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">dfu_status</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">msecs_to_jiffies</span><span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">poll_timeout</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">poll_timeout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				<span class="o">|</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">poll_timeout</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/* Load internal firmware from the buffer.  If manifest_sync_timeout &gt; 0, use</span>
<span class="cm"> * its value in jiffies in the MANIFEST_SYNC state.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_usbdfu_download</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">size</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">manifest_sync_timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dfu_status</span> <span class="n">dfu_stat_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_dfu_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dfu_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dfu_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blockno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;%s( %p, %u, %d)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
		 <span class="n">manifest_sync_timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;FW buffer length invalid!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">FW_BLOCK_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_dfu_state</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_dfu_get_state</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dfu_state</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;cannot get DFU state: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">need_dfu_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">dfu_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STATE_DFU_DOWNLOAD_SYNC</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;STATE_DFU_DOWNLOAD_SYNC&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_dfu_get_status</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dfu_stat_buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dfu_state</span> <span class="o">=</span> <span class="n">dfu_stat_buf</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
				<span class="n">dfu_timeout</span> <span class="o">=</span> <span class="n">at76_get_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dfu_stat_buf</span><span class="p">);</span>
				<span class="n">need_dfu_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;at76_dfu_get_status returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">ret</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DFU_DOWNLOAD_BUSY</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;STATE_DFU_DOWNLOAD_BUSY&quot;</span><span class="p">);</span>
			<span class="n">need_dfu_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;DFU: Resetting device&quot;</span><span class="p">);</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">dfu_timeout</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DFU_DOWNLOAD_IDLE</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;DOWNLOAD...&quot;</span><span class="p">);</span>
			<span class="cm">/* fall through */</span>
		<span class="k">case</span> <span class="n">STATE_DFU_IDLE</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;DFU IDLE&quot;</span><span class="p">);</span>

			<span class="n">bsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">FW_BLOCK_SIZE</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;int fw, size left = %5d, &quot;</span>
				 <span class="s">&quot;bsize = %4d, blockno = %2d&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">bsize</span><span class="p">,</span>
				 <span class="n">blockno</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">at76_load_int_fw_block</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">blockno</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">bsize</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">bsize</span><span class="p">;</span>
			<span class="n">blockno</span><span class="o">++</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">bsize</span><span class="p">)</span>
				<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;at76_load_int_fw_block &quot;</span>
					   <span class="s">&quot;returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">need_dfu_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DFU_MANIFEST_SYNC</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;STATE_DFU_MANIFEST_SYNC&quot;</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_dfu_get_status</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dfu_stat_buf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">dfu_state</span> <span class="o">=</span> <span class="n">dfu_stat_buf</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
			<span class="n">dfu_timeout</span> <span class="o">=</span> <span class="n">at76_get_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dfu_stat_buf</span><span class="p">);</span>
			<span class="n">need_dfu_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* override the timeout from the status response,</span>
<span class="cm">			   needed for AT76C505A */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">manifest_sync_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">dfu_timeout</span> <span class="o">=</span> <span class="n">manifest_sync_timeout</span><span class="p">;</span>

			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;DFU: Waiting for manifest phase&quot;</span><span class="p">);</span>
			<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">dfu_timeout</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DFU_MANIFEST</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;STATE_DFU_MANIFEST&quot;</span><span class="p">);</span>
			<span class="n">is_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DFU_MANIFEST_WAIT_RESET</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;STATE_DFU_MANIFEST_WAIT_RESET&quot;</span><span class="p">);</span>
			<span class="n">is_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DFU_UPLOAD_IDLE</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;STATE_DFU_UPLOAD_IDLE&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">STATE_DFU_ERROR</span>:
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;STATE_DFU_ERROR&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DFU</span><span class="p">,</span> <span class="s">&quot;DFU UNKNOWN STATE (%d)&quot;</span><span class="p">,</span> <span class="n">dfu_state</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">is_done</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">));</span>

<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define HEX2STR_BUFFERS 4</span>
<span class="cp">#define HEX2STR_MAX_LEN 64</span>

<span class="cm">/* Convert binary data into hex string */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">hex2str</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">atomic_t</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ATOMIC_INIT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">bufs</span><span class="p">[</span><span class="n">HEX2STR_BUFFERS</span><span class="p">][</span><span class="mi">3</span> <span class="o">*</span> <span class="n">HEX2STR_MAX_LEN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="n">bufs</span><span class="p">[</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HEX2STR_BUFFERS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">obuf</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ibuf</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">HEX2STR_MAX_LEN</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">HEX2STR_MAX_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obuf</span> <span class="o">=</span> <span class="n">hex_byte_pack</span><span class="p">(</span><span class="n">obuf</span><span class="p">,</span> <span class="o">*</span><span class="n">ibuf</span><span class="o">++</span><span class="p">);</span>
		<span class="o">*</span><span class="n">obuf</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">obuf</span><span class="o">--</span><span class="p">;</span>

<span class="nl">exit:</span>
	<span class="o">*</span><span class="n">obuf</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* LED trigger */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_activity</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">at76_ledtrig_tx_timerfunc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">ledtrig_tx_timer</span><span class="p">,</span> <span class="n">at76_ledtrig_tx_timerfunc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">DEFINE_LED_TRIGGER</span><span class="p">(</span><span class="n">ledtrig_tx</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_ledtrig_tx_timerfunc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">tx_lastactivity</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_lastactivity</span> <span class="o">!=</span> <span class="n">tx_activity</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_lastactivity</span> <span class="o">=</span> <span class="n">tx_activity</span><span class="p">;</span>
		<span class="n">led_trigger_event</span><span class="p">(</span><span class="n">ledtrig_tx</span><span class="p">,</span> <span class="n">LED_FULL</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledtrig_tx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">led_trigger_event</span><span class="p">(</span><span class="n">ledtrig_tx</span><span class="p">,</span> <span class="n">LED_OFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_ledtrig_tx_activity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">tx_activity</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledtrig_tx_timer</span><span class="p">))</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledtrig_tx_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_remap</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x0a</span><span class="p">,</span>
			      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span>
			      <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_get_op_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">saved</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">op_mode</span><span class="p">;</span>

	<span class="n">op_mode</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">op_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x33</span><span class="p">,</span>
			      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span>
			      <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">op_mode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="n">saved</span> <span class="o">=</span> <span class="o">*</span><span class="n">op_mode</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">op_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">saved</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Load a block of the second (&quot;external&quot;) part of the firmware */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_load_ext_fw_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">blockno</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="o">*</span><span class="n">block</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x0e</span><span class="p">,</span>
			       <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			       <span class="mh">0x0802</span><span class="p">,</span> <span class="n">blockno</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
			       <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_get_hw_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
				  <span class="k">union</span> <span class="n">at76_hwcfg</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x33</span><span class="p">,</span>
			       <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span>
			       <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span> <span class="mh">0x0a02</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Intersil boards use a different &quot;value&quot; for GetHWConfig requests */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_get_hw_cfg_intersil</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
					   <span class="k">union</span> <span class="n">at76_hwcfg</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x33</span><span class="p">,</span>
			       <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span>
			       <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span> <span class="mh">0x0902</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get the hardware configuration for the adapter and put it to the appropriate</span>
<span class="cm"> * fields of &#39;priv&#39; (the GetHWConfig request and interpretation of the result</span>
<span class="cm"> * depends on the board type) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_get_hw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">at76_hwcfg</span> <span class="o">*</span><span class="n">hwcfg</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hwcfg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hwcfg</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">at76_is_intersil</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_hw_cfg_intersil</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">hwcfg</span><span class="p">,</span>
					       <span class="k">sizeof</span><span class="p">(</span><span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regulatory_domain</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">.</span><span class="n">regulatory_domain</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">at76_is_503rfmd</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_hw_cfg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">hwcfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">r3</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">r3</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regulatory_domain</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">r3</span><span class="p">.</span><span class="n">regulatory_domain</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_hw_cfg</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">hwcfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">r5</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">r5</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regulatory_domain</span> <span class="o">=</span> <span class="n">hwcfg</span><span class="o">-&gt;</span><span class="n">r5</span><span class="p">.</span><span class="n">regulatory_domain</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hwcfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;cannot get HW Config (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">reg_domain</span> <span class="k">const</span> <span class="o">*</span><span class="nf">at76_get_reg_domain</span><span class="p">(</span><span class="n">u16</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">reg_domain</span> <span class="k">const</span> <span class="n">fd_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="s">&quot;FCC (USA)&quot;</span><span class="p">,</span> <span class="mh">0x7ff</span> <span class="p">},</span>	<span class="cm">/* ch 1-11 */</span>
		<span class="p">{</span> <span class="mh">0x20</span><span class="p">,</span> <span class="s">&quot;IC (Canada)&quot;</span><span class="p">,</span> <span class="mh">0x7ff</span> <span class="p">},</span>	<span class="cm">/* ch 1-11 */</span>
		<span class="p">{</span> <span class="mh">0x30</span><span class="p">,</span> <span class="s">&quot;ETSI (most of Europe)&quot;</span><span class="p">,</span> <span class="mh">0x1fff</span> <span class="p">},</span>	<span class="cm">/* ch 1-13 */</span>
		<span class="p">{</span> <span class="mh">0x31</span><span class="p">,</span> <span class="s">&quot;Spain&quot;</span><span class="p">,</span> <span class="mh">0x600</span> <span class="p">},</span>	<span class="cm">/* ch 10-11 */</span>
		<span class="p">{</span> <span class="mh">0x32</span><span class="p">,</span> <span class="s">&quot;France&quot;</span><span class="p">,</span> <span class="mh">0x1e00</span> <span class="p">},</span>	<span class="cm">/* ch 10-13 */</span>
		<span class="p">{</span> <span class="mh">0x40</span><span class="p">,</span> <span class="s">&quot;MKK (Japan)&quot;</span><span class="p">,</span> <span class="mh">0x2000</span> <span class="p">},</span>	<span class="cm">/* ch 14 */</span>
		<span class="p">{</span> <span class="mh">0x41</span><span class="p">,</span> <span class="s">&quot;MKK1 (Japan)&quot;</span><span class="p">,</span> <span class="mh">0x3fff</span> <span class="p">},</span>	<span class="cm">/* ch 1-14 */</span>
		<span class="p">{</span> <span class="mh">0x50</span><span class="p">,</span> <span class="s">&quot;Israel&quot;</span><span class="p">,</span> <span class="mh">0x3fc</span> <span class="p">},</span>	<span class="cm">/* ch 3-9 */</span>
		<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">,</span> <span class="mh">0xffffffff</span> <span class="p">}</span>	<span class="cm">/* ch 1-32 */</span>
	<span class="p">};</span>

	<span class="cm">/* Last entry is fallback for unknown domain code */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fd_tab</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">fd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">fd_tab</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_get_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mib</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x33</span><span class="p">,</span>
			      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span>
			      <span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span> <span class="n">mib</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span>
			      <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="n">buf_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return positive number for status, negative for an error */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_get_cmd_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">stat_buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">stat_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">GFP_NOIO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x22</span><span class="p">,</span>
			<span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span>
			<span class="n">USB_RECIP_INTERFACE</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">stat_buf</span><span class="p">,</span>
			<span class="mi">40</span><span class="p">,</span> <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">stat_buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">stat_buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAKE_CMD_CASE(c) case (c): return #c</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">at76_get_cmd_string</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MAKE_CMD_CASE</span><span class="p">(</span><span class="n">CMD_SET_MIB</span><span class="p">);</span>
		<span class="n">MAKE_CMD_CASE</span><span class="p">(</span><span class="n">CMD_GET_MIB</span><span class="p">);</span>
		<span class="n">MAKE_CMD_CASE</span><span class="p">(</span><span class="n">CMD_SCAN</span><span class="p">);</span>
		<span class="n">MAKE_CMD_CASE</span><span class="p">(</span><span class="n">CMD_JOIN</span><span class="p">);</span>
		<span class="n">MAKE_CMD_CASE</span><span class="p">(</span><span class="n">CMD_START_IBSS</span><span class="p">);</span>
		<span class="n">MAKE_CMD_CASE</span><span class="p">(</span><span class="n">CMD_RADIO_ON</span><span class="p">);</span>
		<span class="n">MAKE_CMD_CASE</span><span class="p">(</span><span class="n">CMD_RADIO_OFF</span><span class="p">);</span>
		<span class="n">MAKE_CMD_CASE</span><span class="p">(</span><span class="n">CMD_STARTUP</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_card_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at76_command</span> <span class="o">*</span><span class="n">cmd_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_command</span><span class="p">)</span> <span class="o">+</span>
					       <span class="n">buf_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd_buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">buf_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">);</span>

	<span class="n">at76_dbg_dump</span><span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="n">cmd_buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_command</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf_size</span><span class="p">,</span>
		      <span class="s">&quot;issuing command %s (0x%02x)&quot;</span><span class="p">,</span>
		      <span class="n">at76_get_cmd_string</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x0e</span><span class="p">,</span>
			      <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_RECIP_DEVICE</span><span class="p">,</span>
			      <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cmd_buf</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_command</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf_size</span><span class="p">,</span>
			      <span class="n">USB_CTRL_GET_TIMEOUT</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd_buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define MAKE_CMD_STATUS_CASE(c)	case (c): return #c</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">at76_get_cmd_status_string</span><span class="p">(</span><span class="n">u8</span> <span class="n">cmd_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_IDLE</span><span class="p">);</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_COMPLETE</span><span class="p">);</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_UNKNOWN</span><span class="p">);</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_INVALID_PARAMETER</span><span class="p">);</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_FUNCTION_NOT_SUPPORTED</span><span class="p">);</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_TIME_OUT</span><span class="p">);</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_IN_PROGRESS</span><span class="p">);</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_HOST_FAILURE</span><span class="p">);</span>
		<span class="n">MAKE_CMD_STATUS_CASE</span><span class="p">(</span><span class="n">CMD_STATUS_SCAN_FAILED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Wait until the command is completed */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_wait_completion</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">CMD_COMPLETION_TIMEOUT</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">at76_get_cmd_status</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="s">&quot;at76_get_cmd_status failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_WAIT_COMPLETE</span><span class="p">,</span>
			 <span class="s">&quot;%s: Waiting on cmd %d, status = %d (%s)&quot;</span><span class="p">,</span>
			 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
			 <span class="n">at76_get_cmd_status_string</span><span class="p">(</span><span class="n">status</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_IN_PROGRESS</span>
		    <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_IDLE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">);</span>	<span class="cm">/* 100 ms */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="s">&quot;completion timeout for command %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_mib</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">set_mib_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_card_command</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">CMD_SET_MIB</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">set_mib_buffer</span><span class="p">,</span>
					     <span class="n">data</span><span class="p">)</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_wait_completion</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_SET_MIB</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">CMD_STATUS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			   <span class="s">&quot;set_mib: at76_wait_completion failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return &lt; 0 on error, == 0 if no command sent, == 1 if cmd sent */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">CMD_RADIO_ON</span> <span class="o">:</span> <span class="n">CMD_RADIO_OFF</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_card_command</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;at76_set_card_command(%d) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set current power save mode (AT76_PM_OFF/AT76_PM_ON/AT76_PM_SMART) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_pm_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MIB_MAC_MGMT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac_mgmt</span><span class="p">,</span> <span class="n">power_mgmt_mode</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">byte</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_mode</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;set_mib (pm_mode) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MIB_LOCAL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_local</span><span class="p">,</span> <span class="n">preamble_type</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">byte</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;set_mib (preamble) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MIB_MAC</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac</span><span class="p">,</span> <span class="n">frag_threshold</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;set_mib (frag threshold) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MIB_MAC</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac</span><span class="p">,</span> <span class="n">rts_threshold</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">word</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;set_mib (rts) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_autorate_fallback</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MIB_LOCAL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_local</span><span class="p">,</span> <span class="n">txautorate_fallback</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">byte</span> <span class="o">=</span> <span class="n">onoff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;set_mib (autorate fallback) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_dump_mib_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_mac_addr</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac_addr</span><span class="p">),</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_MAC_ADDR</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac_addr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;at76_get_mib (MAC_ADDR) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB MAC_ADDR: mac_addr %pM res 0x%x 0x%x&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">group_addr</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB MAC_ADDR: group addr %d: %pM, &quot;</span>
			 <span class="s">&quot;status %d&quot;</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
			 <span class="n">m</span><span class="o">-&gt;</span><span class="n">group_addr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">group_addr_status</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_dump_mib_mac_wep</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">key_len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_mac_wep</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac_wep</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_MAC_WEP</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac_wep</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;at76_get_mib (MAC_WEP) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB MAC_WEP: priv_invoked %u def_key_id %u &quot;</span>
		 <span class="s">&quot;key_len %u excl_unencr %u wep_icv_err %u wep_excluded %u &quot;</span>
		 <span class="s">&quot;encr_level %u key %d&quot;</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">wep_default_key_id</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">wep_key_mapping_len</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span><span class="p">,</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">wep_icv_error_count</span><span class="p">),</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">wep_excluded_count</span><span class="p">),</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">encryption_level</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">wep_default_key_id</span><span class="p">);</span>

	<span class="n">key_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">encryption_level</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
	    <span class="n">WEP_SMALL_KEY_LEN</span> <span class="o">:</span> <span class="n">WEP_LARGE_KEY_LEN</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WEP_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB MAC_WEP: key %d: %s&quot;</span><span class="p">,</span>
			 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span>
			 <span class="n">hex2str</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">wep_default_keyvalue</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">key_len</span><span class="p">));</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_dump_mib_mac_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_mac_mgmt</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac_mgmt</span><span class="p">),</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_MAC_MGMT</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac_mgmt</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;at76_get_mib (MAC_MGMT) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB MAC_MGMT: beacon_period %d CFP_max_duration &quot;</span>
		 <span class="s">&quot;%d medium_occupancy_limit %d station_id 0x%x ATIM_window %d &quot;</span>
		 <span class="s">&quot;CFP_mode %d privacy_opt_impl %d DTIM_period %d CFP_period %d &quot;</span>
		 <span class="s">&quot;current_bssid %pM current_essid %s current_bss_type %d &quot;</span>
		 <span class="s">&quot;pm_mode %d ibss_change %d res %d &quot;</span>
		 <span class="s">&quot;multi_domain_capability_implemented %d &quot;</span>
		 <span class="s">&quot;international_roaming %d country_string %.3s&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">CFP_max_duration</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">medium_occupancy_limit</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">station_id</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">ATIM_window</span><span class="p">),</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">CFP_mode</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">privacy_option_implemented</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">DTIM_period</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">CFP_period</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_bssid</span><span class="p">,</span>
		 <span class="n">hex2str</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">current_essid</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">),</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_bss_type</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">power_mgmt_mode</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ibss_change</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">multi_domain_capability_implemented</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">multi_domain_capability_enabled</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">country_string</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_dump_mib_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_mac</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_MAC</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mac</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;at76_get_mib (MAC) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB MAC: max_tx_msdu_lifetime %d &quot;</span>
		 <span class="s">&quot;max_rx_lifetime %d frag_threshold %d rts_threshold %d &quot;</span>
		 <span class="s">&quot;cwmin %d cwmax %d short_retry_time %d long_retry_time %d &quot;</span>
		 <span class="s">&quot;scan_type %d scan_channel %d probe_delay %u &quot;</span>
		 <span class="s">&quot;min_channel_time %d max_channel_time %d listen_int %d &quot;</span>
		 <span class="s">&quot;desired_ssid %s desired_bssid %pM desired_bsstype %d&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">max_tx_msdu_lifetime</span><span class="p">),</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">max_rx_lifetime</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">cwmin</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">cwmax</span><span class="p">),</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">short_retry_time</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">long_retry_time</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">scan_type</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">scan_channel</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">probe_delay</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">min_channel_time</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">max_channel_time</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">),</span>
		 <span class="n">hex2str</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">desired_ssid</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">),</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">desired_bssid</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">desired_bsstype</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_dump_mib_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_phy</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_phy</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_PHY</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_phy</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;at76_get_mib (PHY) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB PHY: ed_threshold %d slot_time %d &quot;</span>
		 <span class="s">&quot;sifs_time %d preamble_length %d plcp_header_length %d &quot;</span>
		 <span class="s">&quot;mpdu_max_length %d cca_mode_supported %d operation_rate_set &quot;</span>
		 <span class="s">&quot;0x%x 0x%x 0x%x 0x%x channel_id %d current_cca_mode %d &quot;</span>
		 <span class="s">&quot;phy_type %d current_reg_domain %d&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">ed_threshold</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">slot_time</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">sifs_time</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">preamble_length</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">plcp_header_length</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">mpdu_max_length</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">cca_mode_supported</span><span class="p">),</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">operation_rate_set</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">operation_rate_set</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">operation_rate_set</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">operation_rate_set</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">channel_id</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_cca_mode</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">phy_type</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">current_reg_domain</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_dump_mib_local</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_local</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_LOCAL</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">m</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;at76_get_mib (LOCAL) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB LOCAL: beacon_enable %d &quot;</span>
		 <span class="s">&quot;txautorate_fallback %d ssid_size %d promiscuous_mode %d &quot;</span>
		 <span class="s">&quot;preamble_type %d&quot;</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">beacon_enable</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">txautorate_fallback</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">ssid_size</span><span class="p">,</span> <span class="n">m</span><span class="o">-&gt;</span><span class="n">promiscuous_mode</span><span class="p">,</span>
		 <span class="n">m</span><span class="o">-&gt;</span><span class="n">preamble_type</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_dump_mib_mdomain</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_mdomain</span> <span class="o">*</span><span class="n">m</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mdomain</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_MDOMAIN</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_mdomain</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;at76_get_mib (MDOMAIN) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB MDOMAIN: channel_list %s&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
		 <span class="n">hex2str</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">channel_list</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">channel_list</span><span class="p">)));</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MIB</span><span class="p">,</span> <span class="s">&quot;%s: MIB MDOMAIN: tx_powerlevel %s&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
		 <span class="n">hex2str</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">tx_powerlevel</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="o">-&gt;</span><span class="n">tx_powerlevel</span><span class="p">)));</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enable monitor mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_start_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_req_scan</span> <span class="n">scan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_req_scan</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scan</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">scan</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">SCAN_TYPE_PASSIVE</span><span class="p">;</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">international_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">min_channel_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_min_time</span><span class="p">);</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">max_channel_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_max_time</span><span class="p">);</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">probe_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_card_command</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">CMD_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_cmd_status</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">CMD_SCAN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Calculate padding from txbuf-&gt;wlength (which excludes the USB TX header),</span>
<span class="cm">   likely to compensate a flaw in the AT76C503A USB part ... */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">at76_calc_padding</span><span class="p">(</span><span class="kt">int</span> <span class="n">wlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* add the USB TX header */</span>
	<span class="n">wlen</span> <span class="o">+=</span> <span class="n">AT76_TX_HDRLEN</span><span class="p">;</span>

	<span class="n">wlen</span> <span class="o">=</span> <span class="n">wlen</span> <span class="o">%</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlen</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">wlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlen</span> <span class="o">&gt;=</span> <span class="mi">61</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">64</span> <span class="o">+</span> <span class="mi">50</span> <span class="o">-</span> <span class="n">wlen</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_rx_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">urb</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_submit_rx_urb</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: priv-&gt;rx_urb is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_rx_buffer</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="s">&quot;cannot allocate rx skbuff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pipe</span><span class="p">,</span>
			  <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">size</span><span class="p">),</span> <span class="n">size</span><span class="p">,</span> <span class="n">at76_rx_callback</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span>
				 <span class="s">&quot;usb_submit_urb returned -ENODEV&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="s">&quot;rx, usb_submit_urb failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;cannot submit rx urb - please unload the driver and/or power cycle the device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Download external firmware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_load_external_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fwentry</span> <span class="o">*</span><span class="n">fwe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blockno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bsize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">extfw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">extfw_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span> <span class="o">||</span> <span class="o">!</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">op_mode</span> <span class="o">=</span> <span class="n">at76_get_op_mode</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;opmode %d&quot;</span><span class="p">,</span> <span class="n">op_mode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">OPMODE_NORMAL_NIC_WITHOUT_FLASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unexpected opmode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">op_mode</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">block</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">FW_BLOCK_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">block</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;downloading external firmware&quot;</span><span class="p">);</span>

	<span class="cm">/* for fw &gt;= 0.100, the device needs an extra empty block */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">bsize</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">FW_BLOCK_SIZE</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>
		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span>
			 <span class="s">&quot;ext fw, size left = %5d, bsize = %4d, blockno = %2d&quot;</span><span class="p">,</span>
			 <span class="n">size</span><span class="p">,</span> <span class="n">bsize</span><span class="p">,</span> <span class="n">blockno</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_load_ext_fw_block</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">blockno</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">bsize</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">bsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;loading %dth firmware block failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">blockno</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">bsize</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">bsize</span><span class="p">;</span>
		<span class="n">blockno</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bsize</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">at76_is_505a</span><span class="p">(</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;200 ms delay for 505a&quot;</span><span class="p">);</span>
		<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">HZ</span> <span class="o">/</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">block</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;downloading external firmware failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Download internal firmware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_load_internal_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fwentry</span> <span class="o">*</span><span class="n">fwe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_remap</span> <span class="o">=</span> <span class="o">!</span><span class="n">at76_is_505a</span><span class="p">(</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_usbdfu_download</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">intfw</span><span class="p">,</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">intfw_size</span><span class="p">,</span>
				   <span class="n">need_remap</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;downloading internal fw failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;sending REMAP&quot;</span><span class="p">);</span>

	<span class="cm">/* no REMAP for 505A (see SF driver) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_remap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_remap</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;sending REMAP failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;sleeping for 2 seconds&quot;</span><span class="p">);</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">usb_reset_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_startup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_card_config</span> <span class="o">*</span><span class="n">ccfg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PARAMS</span><span class="p">,</span>
		 <span class="s">&quot;%s param: ssid %.*s (%s) mode %s ch %d wep %s key %d &quot;</span>
		 <span class="s">&quot;keylen %d&quot;</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_size</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">hex2str</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">),</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">?</span> <span class="s">&quot;adhoc&quot;</span> <span class="o">:</span> <span class="s">&quot;infra&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_enabled</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys_len</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_id</span><span class="p">]);</span>
	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PARAMS</span><span class="p">,</span>
		 <span class="s">&quot;%s param: preamble %s rts %d retry %d frag %d &quot;</span>
		 <span class="s">&quot;txrate %s auth_mode %d&quot;</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
		 <span class="n">preambles</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble_type</span><span class="p">],</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">==</span> <span class="n">TX_RATE_1MBIT</span> <span class="o">?</span> <span class="s">&quot;1MBit&quot;</span> <span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">==</span>
		 <span class="n">TX_RATE_2MBIT</span> <span class="o">?</span> <span class="s">&quot;2MBit&quot;</span> <span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">==</span>
		 <span class="n">TX_RATE_5_5MBIT</span> <span class="o">?</span> <span class="s">&quot;5.5MBit&quot;</span> <span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">==</span>
		 <span class="n">TX_RATE_11MBIT</span> <span class="o">?</span> <span class="s">&quot;11MBit&quot;</span> <span class="o">:</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">==</span>
		 <span class="n">TX_RATE_AUTO</span> <span class="o">?</span> <span class="s">&quot;auto&quot;</span> <span class="o">:</span> <span class="s">&quot;&lt;invalid&gt;&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">auth_mode</span><span class="p">);</span>
	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PARAMS</span><span class="p">,</span>
		 <span class="s">&quot;%s param: pm_mode %d pm_period %d auth_mode %s &quot;</span>
		 <span class="s">&quot;scan_times %d %d scan_mode %s&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_mode</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_period</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">==</span> <span class="n">WLAN_AUTH_OPEN</span> <span class="o">?</span> <span class="s">&quot;open&quot;</span> <span class="o">:</span> <span class="s">&quot;shared_secret&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_min_time</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_max_time</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">==</span> <span class="n">SCAN_TYPE_ACTIVE</span> <span class="o">?</span> <span class="s">&quot;active&quot;</span> <span class="o">:</span> <span class="s">&quot;passive&quot;</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ccfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_card_config</span><span class="p">));</span>
	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">promiscuous_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys_len</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_id</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">WEP_SMALL_KEY_LEN</span><span class="p">)</span>
			<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">encryption_type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">encryption_type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* jal: always exclude unencrypted if WEP is active */</span>
		<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">exclude_unencrypted</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">encryption_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">fragmentation_threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">,</span> <span class="n">hw_rates</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* jal: really needed, we do a set_mib for autorate later ??? */</span>
	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">auto_rate_fallback</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">==</span> <span class="n">TX_RATE_AUTO</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_enabled</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">current_ssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_size</span><span class="p">;</span>

	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">wep_default_key_id</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_id</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">wep_default_key_value</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">));</span>

	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">short_preamble</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble_type</span><span class="p">;</span>
	<span class="n">ccfg</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_card_command</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">CMD_STARTUP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">card_config</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_card_config</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;at76_set_card_command failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_wait_completion</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_STARTUP</span><span class="p">);</span>

	<span class="cm">/* remove BSSID from previous run */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">at76_set_radio</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">at76_wait_completion</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_RADIO_ON</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_preamble</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_frag</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_rts</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_autorate_fallback</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
					 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">==</span> <span class="n">TX_RATE_AUTO</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_pm_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">at76_debug</span> <span class="o">&amp;</span> <span class="n">DBG_MIB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at76_dump_mib_mac</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">at76_dump_mib_mac_addr</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">at76_dump_mib_mac_mgmt</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">at76_dump_mib_mac_wep</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">at76_dump_mib_mdomain</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">at76_dump_mib_phy</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">at76_dump_mib_local</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enable or disable promiscuous mode */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_work_set_promisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at76_priv</span><span class="p">,</span>
					      <span class="n">work_set_promisc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MIB_LOCAL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_local</span><span class="p">,</span> <span class="n">promiscuous_mode</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">byte</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_mib</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;set_mib (promiscuous_mode) failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Submit Rx urb back to the device */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_work_submit_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at76_priv</span><span class="p">,</span>
					      <span class="n">work_submit_rx</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">at76_submit_rx_urb</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_rx_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="p">)</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at76_rx_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">rx_status</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;device unplugged&quot;</span><span class="p">);</span>
		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;urb status %d&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">at76_rx_buffer</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">&amp;&amp;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">)</span>
			<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_URB</span><span class="p">,</span>
				 <span class="s">&quot;%s %s: - nonzero Rx bulk status received: %d&quot;</span><span class="p">,</span>
				 <span class="n">__func__</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span>
				 <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_RX_ATMEL_HDR</span><span class="p">,</span>
		 <span class="s">&quot;%s: rx frame: rate %d rssi %d noise %d link %d&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rx_rate</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span>
		 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">noise_level</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">link_quality</span><span class="p">);</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">AT76_RX_HDRLEN</span><span class="p">);</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">wlength</span><span class="p">));</span>
	<span class="n">at76_dbg_dump</span><span class="p">(</span><span class="n">DBG_RX_DATA</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="s">&quot;RX: len=%d&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">rx_status</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_IV_STRIPPED</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;calling ieee80211_rx_irqsafe(): %d/%d&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_status</span><span class="p">));</span>
	<span class="n">ieee80211_rx_irqsafe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>

	<span class="cm">/* Use a new skb for the next receive */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">at76_submit_rx_urb</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Load firmware into kernel memory and parse it */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">fwentry</span> <span class="o">*</span><span class="nf">at76_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">,</span>
					  <span class="k">enum</span> <span class="n">board_type</span> <span class="n">board_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at76_fw_header</span> <span class="o">*</span><span class="n">fwh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fwentry</span> <span class="o">*</span><span class="n">fwe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">firmwares</span><span class="p">[</span><span class="n">board_type</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">loaded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_FW</span><span class="p">,</span> <span class="s">&quot;re-using previously loaded fw&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_FW</span><span class="p">,</span> <span class="s">&quot;downloading firmware %s&quot;</span><span class="p">,</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware %s not found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">);</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;you may need to download the firmware from &quot;</span>
			   <span class="s">&quot;http://developer.berlios.de/projects/at76c503a/</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_FW</span><span class="p">,</span> <span class="s">&quot;got it.&quot;</span><span class="p">);</span>
	<span class="n">fwh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">at76_fw_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fwh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;firmware is too short (0x%zx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* CRC currently not checked */</span>
	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">!=</span> <span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;board type mismatch, requested %u, got %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">board_type</span><span class="p">,</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">major</span> <span class="o">=</span> <span class="n">fwh</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">;</span>
	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">minor</span> <span class="o">=</span> <span class="n">fwh</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">;</span>
	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">fwh</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">;</span>
	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">build</span> <span class="o">=</span> <span class="n">fwh</span><span class="o">-&gt;</span><span class="n">build</span><span class="p">;</span>

	<span class="n">str</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fwh</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">str_offset</span><span class="p">);</span>
	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">intfw</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fwh</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">int_fw_offset</span><span class="p">);</span>
	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">intfw_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">int_fw_len</span><span class="p">);</span>
	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">extfw</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fwh</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">ext_fw_offset</span><span class="p">);</span>
	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">extfw_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">ext_fw_len</span><span class="p">);</span>

	<span class="n">fwe</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;using firmware %s (version %d.%d.%d-%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fwname</span><span class="p">,</span> <span class="n">fwh</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">,</span> <span class="n">fwh</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">,</span> <span class="n">fwh</span><span class="o">-&gt;</span><span class="n">patch</span><span class="p">,</span> <span class="n">fwh</span><span class="o">-&gt;</span><span class="n">build</span><span class="p">);</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;board %u, int %d:%d, ext %d:%d&quot;</span><span class="p">,</span> <span class="n">board_type</span><span class="p">,</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">int_fw_offset</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">int_fw_len</span><span class="p">),</span>
		 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">ext_fw_offset</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">fwh</span><span class="o">-&gt;</span><span class="n">ext_fw_len</span><span class="p">));</span>
	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;firmware id %s&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">loaded</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fwe</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_req_join</span> <span class="n">join</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">join</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_req_join</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">join</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_size</span><span class="p">);</span>
	<span class="n">join</span><span class="p">.</span><span class="n">essid_size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">essid_size</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">join</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">join</span><span class="p">.</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">INFRASTRUCTURE_MODE</span><span class="p">;</span>
	<span class="n">join</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">join</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2000</span><span class="p">);</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s: sending CMD_JOIN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_card_command</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">CMD_JOIN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">join</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_req_join</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;at76_set_card_command failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_wait_completion</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_JOIN</span><span class="p">);</span>
	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s: CMD_JOIN returned: 0x%02x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">CMD_STATUS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;at76_wait_completion failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_set_pm_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_work_join_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at76_priv</span><span class="p">,</span>
					      <span class="n">work_join_bssid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
		<span class="n">at76_join</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_mac80211_tx_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s()&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* success */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="o">-</span><span class="n">ENOENT</span>:
	<span class="k">case</span> <span class="o">-</span><span class="n">ECONNRESET</span>:
		<span class="cm">/* fail, urb has been unlinked */</span>
		<span class="cm">/* FIXME: add error message */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_URB</span><span class="p">,</span> <span class="s">&quot;%s - nonzero tx status received: %d&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_mac80211_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at76_tx_buffer</span> <span class="o">*</span><span class="n">tx_buffer</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">padding</span><span class="p">,</span> <span class="n">submit_len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s()&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;%s called while tx urb is pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The following code lines are important when the device is going to</span>
<span class="cm">	 * authenticate with a new bssid. The driver must send CMD_JOIN before</span>
<span class="cm">	 * an authentication frame is transmitted. For this to succeed, the</span>
<span class="cm">	 * correct bssid of the AP must be known. As mac80211 does not inform</span>
<span class="cm">	 * drivers about the bssid prior to the authentication process the</span>
<span class="cm">	 * following workaround is necessary. If the TX frame is an</span>
<span class="cm">	 * authentication frame extract the bssid and send the CMD_JOIN. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_STYPE_AUTH</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_join_bssid</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">at76_ledtrig_tx_activity</span><span class="p">();</span>	<span class="cm">/* tell ledtrigger we send a packet */</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">padding</span> <span class="o">=</span> <span class="n">at76_calc_padding</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">submit_len</span> <span class="o">=</span> <span class="n">AT76_TX_HDRLEN</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">padding</span><span class="p">;</span>

	<span class="cm">/* setup &#39;Atmel&#39; header */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_buffer</span><span class="p">));</span>
	<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">padding</span> <span class="o">=</span> <span class="n">padding</span><span class="p">;</span>
	<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">wlength</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">packet</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_TX_DATA</span><span class="p">,</span> <span class="s">&quot;%s tx: wlen 0x%x pad 0x%x rate %d hdr&quot;</span><span class="p">,</span>
		 <span class="n">wiphy_name</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">wlength</span><span class="p">),</span>
		 <span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">padding</span><span class="p">,</span> <span class="n">tx_buffer</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">);</span>

	<span class="cm">/* send stuff */</span>
	<span class="n">at76_dbg_dump</span><span class="p">(</span><span class="n">DBG_TX_DATA_CONTENT</span><span class="p">,</span> <span class="n">tx_buffer</span><span class="p">,</span> <span class="n">submit_len</span><span class="p">,</span>
		      <span class="s">&quot;%s(): tx_buffer %d bytes:&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">submit_len</span><span class="p">);</span>
	<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pipe</span><span class="p">,</span> <span class="n">tx_buffer</span><span class="p">,</span>
			  <span class="n">submit_len</span><span class="p">,</span> <span class="n">at76_mac80211_tx_callback</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;error in tx submit urb: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="s">&quot;-EINVAL: tx urb %p hcpriv %p complete %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">,</span>
				  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="o">-&gt;</span><span class="n">hcpriv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_mac80211_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s()&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_submit_rx_urb</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;open: submit_rx_urb failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_startup_device</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">at76_start_monitor</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_mac80211_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s()&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dwork_hw_scan</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_join_bssid</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_set_promisc</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We are called by &quot;ifconfig ethX down&quot;, not because the</span>
<span class="cm">		 * device is not available anymore. */</span>
		<span class="n">at76_set_radio</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* We unlink rx_urb because at76_open() re-submits it.</span>
<span class="cm">		 * If unplugged, at76_delete_device() takes care of it. */</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s()&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s()&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_dwork_hw_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">at76_priv</span><span class="p">,</span>
					      <span class="n">dwork_hw_scan</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_cmd_status</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">CMD_SCAN</span><span class="p">);</span>
	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s: CMD_SCAN status 0x%02x&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* FIXME: add maximum time for scan to complete */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">CMD_STATUS_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dwork_hw_scan</span><span class="p">,</span>
					     <span class="n">SCAN_POLL_INTERVAL</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
		<span class="n">at76_join</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">ieee80211_scan_completed</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_hw_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at76_req_scan</span> <span class="n">scan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s():&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_req_scan</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scan</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">scan</span><span class="p">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">SCAN_TYPE_ACTIVE</span><span class="p">;</span>
		<span class="n">ssid</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">scan</span><span class="p">.</span><span class="n">scan_type</span> <span class="o">=</span> <span class="n">SCAN_TYPE_PASSIVE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scan</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">scan</span><span class="p">.</span><span class="n">essid_size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">scan</span><span class="p">.</span><span class="n">min_channel_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_min_time</span><span class="p">);</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">max_channel_time</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_max_time</span><span class="p">);</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">probe_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_min_time</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="n">scan</span><span class="p">.</span><span class="n">international_scan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s: sending CMD_SCAN&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_set_card_command</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">CMD_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;CMD_SCAN failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dwork_hw_scan</span><span class="p">,</span>
				     <span class="n">SCAN_POLL_INTERVAL</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s(): channel %d&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
	<span class="n">at76_dbg_dump</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="s">&quot;bssid:&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
		<span class="n">at76_join</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">at76_start_monitor</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
				  <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s():&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">at76_dbg_dump</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="s">&quot;bssid:&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
		<span class="cm">/* mac80211 is joining a bss */</span>
		<span class="n">at76_join</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* must be atomic */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span> <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s(): changed_flags=0x%08x &quot;</span>
		 <span class="s">&quot;total_flags=0x%08x&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">changed_flags</span><span class="p">,</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">);</span>

	<span class="n">flags</span> <span class="o">=</span> <span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">AT76_SUPPORTED_FILTERS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">=</span> <span class="n">AT76_SUPPORTED_FILTERS</span><span class="p">;</span>

	<span class="cm">/* Bail out after updating flags to prevent a WARN_ON in mac80211. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* FIXME: access to priv-&gt;promisc should be protected with</span>
<span class="cm">	 * priv-&gt;mtx, but it&#39;s impossible because this function needs to be</span>
<span class="cm">	 * atomic */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* mac80211 wants us to enable promiscuous mode */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we need to disable promiscuous mode */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">promisc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_set_promisc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_MAC80211</span><span class="p">,</span> <span class="s">&quot;%s(): cmd %d key-&gt;cipher %d key-&gt;keyidx %d &quot;</span>
		 <span class="s">&quot;key-&gt;keylen %d&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">!=</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">],</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys_len</span><span class="p">[</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>

		<span class="cm">/* FIXME: find out how to do this properly */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_key_id</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
	<span class="nl">default:</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys_len</span><span class="p">[</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WEP_KEYS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_keys_len</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wep_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_startup_device</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">at76_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">at76_mac80211_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span> <span class="o">=</span> <span class="n">at76_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span> <span class="o">=</span> <span class="n">at76_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">at76_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span> <span class="o">=</span> <span class="n">at76_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span> <span class="o">=</span> <span class="n">at76_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">at76_mac80211_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">at76_mac80211_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_scan</span> <span class="o">=</span> <span class="n">at76_hw_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span> <span class="o">=</span> <span class="n">at76_set_key</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Allocate network device and initialize private data */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="nf">at76_alloc_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">at76_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;: could not register&quot;</span>
		       <span class="s">&quot; ieee80211_hw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mtx</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_set_promisc</span><span class="p">,</span> <span class="n">at76_work_set_promisc</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_submit_rx</span><span class="p">,</span> <span class="n">at76_work_submit_rx</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_join_bssid</span><span class="p">,</span> <span class="n">at76_work_join_bssid</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dwork_hw_scan</span><span class="p">,</span> <span class="n">at76_dwork_hw_scan</span><span class="p">);</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">,</span> <span class="n">at76_rx_tasklet</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_mode</span> <span class="o">=</span> <span class="n">AT76_PM_OFF</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pm_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* unit us */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_alloc_urbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">,</span> <span class="o">*</span><span class="n">ep_in</span><span class="p">,</span> <span class="o">*</span><span class="n">ep_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buffer_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">iface_desc</span><span class="p">;</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PROC_ENTRY</span><span class="p">,</span> <span class="s">&quot;%s: ENTER&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_URB</span><span class="p">,</span> <span class="s">&quot;%s: NumEndpoints %d &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		 <span class="n">interface</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">);</span>

	<span class="n">ep_in</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ep_out</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">iface_desc</span> <span class="o">=</span> <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">iface_desc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>

		<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_URB</span><span class="p">,</span> <span class="s">&quot;%s: %d. endpoint: addr 0x%x attr 0x%x&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">,</span>
			 <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_in</span> <span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_is_bulk_in</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>
			<span class="n">ep_in</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_out</span> <span class="o">&amp;&amp;</span> <span class="n">usb_endpoint_is_bulk_out</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span>
			<span class="n">ep_out</span> <span class="o">=</span> <span class="n">endpoint</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ep_in</span> <span class="o">||</span> <span class="o">!</span><span class="n">ep_out</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;bulk endpoints missing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_pipe</span> <span class="o">=</span> <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep_in</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pipe</span> <span class="o">=</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="n">ep_out</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot allocate URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_tx_buffer</span><span class="p">)</span> <span class="o">+</span> <span class="n">MAX_PADDING_SIZE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buffer_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;cannot allocate output buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PROC_ENTRY</span><span class="p">,</span> <span class="s">&quot;%s: EXIT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">at76_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">TX_RATE_1MBIT</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">TX_RATE_2MBIT</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">TX_RATE_5_5MBIT</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">TX_RATE_11MBIT</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">at76_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2412</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2417</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2422</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2427</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2432</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2437</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2442</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2447</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2452</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2457</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2462</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2467</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2472</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2484</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">14</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">at76_supported_band</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">at76_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">at76_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">at76_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">at76_rates</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/* Register network device and initialize the hardware */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_init_new_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* set up the endpoint information */</span>
	<span class="cm">/* check out the endpoints */</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;USB interface: %d endpoints&quot;</span><span class="p">,</span>
		 <span class="n">interface</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_alloc_urbs</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

	<span class="cm">/* MAC address */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_hw_config</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;cannot get MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">=</span> <span class="n">at76_get_reg_domain</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regulatory_domain</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">DEF_CHANNEL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">DEF_RTS_THRESHOLD</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">DEF_FRAG_THRESHOLD</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">DEF_SHORT_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">txrate</span> <span class="o">=</span> <span class="n">TX_RATE_AUTO</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble_type</span> <span class="o">=</span> <span class="n">PREAMBLE_TYPE_LONG</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">auth_mode</span> <span class="o">=</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_min_time</span> <span class="o">=</span> <span class="n">DEF_SCAN_MIN_TIME</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_max_time</span> <span class="o">=</span> <span class="n">DEF_SCAN_MAX_TIME</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_mode</span> <span class="o">=</span> <span class="n">SCAN_TYPE_ACTIVE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* mac80211 initialisation */</span>
	<span class="n">wiphy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">at76_supported_band</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span> <span class="o">|</span>
			  <span class="n">IEEE80211_HW_SIGNAL_UNSPEC</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_signal</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="s">&quot;%d.%d.%d-%d&quot;</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span>
		 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">patch</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">build</span><span class="p">);</span>

	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">hw_version</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cannot register mac80211 hw (status %d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;USB %s, MAC %pM, firmware %d.%d.%d-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">major</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">minor</span><span class="p">,</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">patch</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">build</span><span class="p">);</span>
	<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;regulatory domain 0x%02x: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regulatory_domain</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">domain</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_delete_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PROC_ENTRY</span><span class="p">,</span> <span class="s">&quot;%s: ENTER&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* The device is gone, don&#39;t bother turning it off */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_unplugged</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_urb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_urb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PROC_ENTRY</span><span class="p">,</span> <span class="s">&quot;%s: unlinked urbs&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bulk_out_buffer</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ledtrig_tx_timer</span><span class="p">);</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>

	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PROC_ENTRY</span><span class="p">,</span> <span class="s">&quot;%s: before freeing priv/ieee80211_hw&quot;</span><span class="p">,</span>
		 <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_PROC_ENTRY</span><span class="p">,</span> <span class="s">&quot;%s: EXIT&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">at76_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fwentry</span> <span class="o">*</span><span class="n">fwe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">op_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_ext_fw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mib_fw_version</span> <span class="n">fwv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">board_type</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>

	<span class="n">udev</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">interface</span><span class="p">));</span>

	<span class="cm">/* Load firmware into kernel memory */</span>
	<span class="n">fwe</span> <span class="o">=</span> <span class="n">at76_load_firmware</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">board_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fwe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">op_mode</span> <span class="o">=</span> <span class="n">at76_get_op_mode</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>

	<span class="n">at76_dbg</span><span class="p">(</span><span class="n">DBG_DEVSTART</span><span class="p">,</span> <span class="s">&quot;opmode %d&quot;</span><span class="p">,</span> <span class="n">op_mode</span><span class="p">);</span>

	<span class="cm">/* we get OPMODE_NONE with 2.4.23, SMC2662W-AR ???</span>
<span class="cm">	   we get 204 with 2.4.23, Fiberline FL-WL240u (505A+RFMD2958) ??? */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">OPMODE_HW_CONFIG_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;cannot handle a device in HW_CONFIG_MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">op_mode</span> <span class="o">!=</span> <span class="n">OPMODE_NORMAL_NIC_WITH_FLASH</span>
	    <span class="o">&amp;&amp;</span> <span class="n">op_mode</span> <span class="o">!=</span> <span class="n">OPMODE_NORMAL_NIC_WITHOUT_FLASH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* download internal firmware part */</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;downloading internal firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_load_internal_fw</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">fwe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;error %d downloading internal firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Internal firmware already inside the device.  Get firmware</span>
<span class="cm">	 * version to test if external firmware is loaded.</span>
<span class="cm">	 * This works only for newer firmware, e.g. the Intersil 0.90.x</span>
<span class="cm">	 * says &quot;control timeout on ep0in&quot; and subsequent</span>
<span class="cm">	 * at76_get_op_mode() fail too :-( */</span>

	<span class="cm">/* if version &gt;= 0.100.x.y or device with built-in flash we can</span>
<span class="cm">	 * query the device for the fw version */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">major</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">fwe</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">.</span><span class="n">minor</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">op_mode</span> <span class="o">==</span> <span class="n">OPMODE_NORMAL_NIC_WITH_FLASH</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_FW_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fwv</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">fwv</span><span class="p">.</span><span class="n">major</span> <span class="o">|</span> <span class="n">fwv</span><span class="p">.</span><span class="n">minor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">need_ext_fw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* No way to check firmware version, reload to be sure */</span>
		<span class="n">need_ext_fw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_ext_fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;downloading external firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_load_external_fw</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">fwe</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* Re-check firmware version */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_get_mib</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">MIB_FW_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fwv</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;error %d getting firmware version</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">at76_alloc_new_device</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwv</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mib_fw_version</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">board_type</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">at76_init_new_device</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">at76_delete_device</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">at76_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">at76_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">);</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">interface</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Disconnect after loading internal firmware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;disconnecting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">at76_delete_device</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;disconnected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Structure for registering this driver with the USB subsystem */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">at76_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">at76_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">at76_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">dev_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">at76_mod_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_DESC</span> <span class="s">&quot; &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot; loading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_mutex</span><span class="p">);</span>

	<span class="cm">/* register this driver with the USB subsystem */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at76_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span>
		       <span class="s">&quot;: usb_register failed (status %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>

	<span class="n">led_trigger_register_simple</span><span class="p">(</span><span class="s">&quot;at76_usb-tx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ledtrig_tx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">at76_mod_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_DESC</span> <span class="s">&quot; &quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot; unloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">at76_driver</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">firmwares</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">firmwares</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">led_trigger_unregister_simple</span><span class="p">(</span><span class="n">ledtrig_tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">at76_debug</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="mo">0600</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debugging level&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">at76_mod_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">at76_mod_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Oliver Kurth &lt;oku@masqmail.cx&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Joerg Albert &lt;joerg.albert@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Alex &lt;alex@foogod.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Nick Jones&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Balint Seeber &lt;n0_5p4m_p13453@hotmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pavel Roskin &lt;proski@gnu.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guido Guenther &lt;agx@sigxcpu.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kalle Valo &lt;kalle.valo@iki.fi&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sebastian Smolorz &lt;sesmo@gmx.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
