<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › hostap › hostap_ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hostap_ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* ioctl() (mostly Linux Wireless Extensions) routines for Host AP driver */</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;net/lib80211.h&gt;</span>

<span class="cp">#include &quot;hostap_wlan.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;hostap_ap.h&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">hostap_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">wstats</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* Why are we doing that ? Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">HOSTAP_INTERFACE_MAIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">wstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>

	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">comm_tallies</span><span class="p">.</span><span class="n">rx_discards_wep_undecryptable</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">comm_tallies</span><span class="p">.</span><span class="n">rx_fcs_errors</span> <span class="o">+</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">comm_tallies</span><span class="p">.</span><span class="n">rx_discards_no_buffer</span> <span class="o">+</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">comm_tallies</span><span class="p">.</span><span class="n">tx_discards_wrong_sa</span><span class="p">;</span>

	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">comm_tallies</span><span class="p">.</span><span class="n">tx_retry_limit_exceeded</span><span class="p">;</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">fragment</span> <span class="o">=</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">comm_tallies</span><span class="p">.</span><span class="n">rx_message_in_bad_msg_fragments</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_REPEAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef in_atomic</span>
		<span class="cm">/* RID reading might sleep and it must not be called in</span>
<span class="cm">		 * interrupt context or while atomic. However, this</span>
<span class="cm">		 * function seems to be called while atomic (at least in Linux</span>
<span class="cm">		 * 2.5.59). Update signal quality values only if in suitable</span>
<span class="cm">		 * context. Otherwise, previous values read from tick timer</span>
<span class="cm">		 * will be used. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_atomic</span><span class="p">())</span>
			<span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* in_atomic */</span><span class="cp"></span>

		<span class="k">if</span> <span class="p">(</span><span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">prism2_update_comms_qual</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_UPDATED</span> <span class="o">|</span>
				<span class="n">IW_QUAL_DBM</span><span class="p">;</span>

		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">comms_qual</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">avg_signal</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">avg_noise</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_INVALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_get_datarates</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_SUPPORTEDDATARATES</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">);</span> <span class="cm">/* string length */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">val</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">over2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">prism2_get_datarates</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rates</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0b</span> <span class="o">||</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">over2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">over2</span> <span class="o">?</span> <span class="s">&quot;IEEE 802.11b&quot;</span> <span class="o">:</span> <span class="s">&quot;IEEE 802.11-DS&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwencode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">keybuf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">**</span><span class="n">crypt</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span>
			<span class="n">lib80211_crypt_delayed_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* changing to use WEP; deinit previously used algorithm */</span>
		<span class="n">lib80211_crypt_delayed_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">new_crypt</span><span class="p">;</span>

		<span class="cm">/* take WEP into use */</span>
		<span class="n">new_crypt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lib80211_crypt_data</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="s">&quot;WEP&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;lib80211_crypt_wep&quot;</span><span class="p">);</span>
			<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="s">&quot;WEP&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">try_module_get</span><span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
			<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">||</span> <span class="o">!</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_crypt</span><span class="p">);</span>
			<span class="n">new_crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: could not initialize WEP: &quot;</span>
			       <span class="s">&quot;load module hostap_crypt_wep.o</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">new_crypt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="mi">5</span> <span class="o">?</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">13</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">keybuf</span> <span class="o">+</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span><span class="p">(</span><span class="n">keybuf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">WEP_KEYS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* No key data - just set the default TX key index */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: set_encryption failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do not reset port0 if card is in Managed mode since resetting will</span>
<span class="cm">	 * generate new IEEE 802.11 authentication which may end up in looping</span>
<span class="cm">	 * with IEEE 802.1X. Prism2 documentation seem to require port reset</span>
<span class="cm">	 * after WEP configuration. However, keys are apparently changed at</span>
<span class="cm">	 * least in Managed mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: reset_port failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwencode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">crypt</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* only WEP is supported with wireless extensions, so just</span>
<span class="cm">		 * report that encryption is used */</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reads from HFA384X_RID_CNFDEFAULTKEY* return bogus values, so show</span>
<span class="cm">	 * the keys from driver buffer */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">WEP_KEY_LEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFWEPFLAGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;CNFWEPFLAGS reading failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HFA384X_WEPFLAGS_PRIVACYINVOKED</span><span class="p">)</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">HFA384X_WEPFLAGS_EXCLUDEUNENCRYPTED</span><span class="p">)</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hostap_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">basic_rates</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">basic_rates</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">basic_rates</span> <span class="o">||</span> <span class="n">basic_rates</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: updating basic rate set automatically &quot;</span>
		       <span class="s">&quot;to match with the new supported rate set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">basic_rates</span><span class="p">)</span>
			<span class="n">basic_rates</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">;</span>

		<span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="n">basic_rates</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFBASICRATES</span><span class="p">,</span>
				    <span class="n">basic_rates</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: failed to set &quot;</span>
			       <span class="s">&quot;cnfBasicRates</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_TXRATECONTROL</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFSUPPORTEDRATES</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: TXRateControl/cnfSupportedRates &quot;</span>
		       <span class="s">&quot;setting to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update TX rate configuration for all STAs based on new operational</span>
<span class="cm">	 * rate set. */</span>
	<span class="n">hostap_update_rates</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">11000000</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_11MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5500000</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_5MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2000000</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_2MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1000000</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span> <span class="o">|</span>
				<span class="n">HFA384X_RATES_2MBPS</span> <span class="o">|</span> <span class="n">HFA384X_RATES_5MBPS</span> <span class="o">|</span>
				<span class="n">HFA384X_RATES_11MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">11000000</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span> <span class="o">|</span>
				<span class="n">HFA384X_RATES_2MBPS</span> <span class="o">|</span> <span class="n">HFA384X_RATES_5MBPS</span> <span class="o">|</span>
				<span class="n">HFA384X_RATES_11MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">5500000</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span> <span class="o">|</span>
				<span class="n">HFA384X_RATES_2MBPS</span> <span class="o">|</span> <span class="n">HFA384X_RATES_5MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2000000</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span> <span class="o">|</span>
				<span class="n">HFA384X_RATES_2MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1000000</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span> <span class="o">|</span>
				<span class="n">HFA384X_RATES_2MBPS</span> <span class="o">|</span> <span class="n">HFA384X_RATES_5MBPS</span> <span class="o">|</span>
				<span class="n">HFA384X_RATES_11MBPS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hostap_set_rate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwrate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_TXRATECONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_tx_rate_control</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HFA384X_RID_CURRENTTXRATE seems to always be 2 Mbps in</span>
<span class="cm">		 * Host AP mode, so use the recorded TX rate of the last sent</span>
<span class="cm">		 * frame */</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_tx_rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_tx_rate</span> <span class="o">*</span> <span class="mi">100000</span> <span class="o">:</span> <span class="mi">11000000</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CURRENTTXRATE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HFA384X_RATES_1MBPS</span>:
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384X_RATES_2MBPS</span>:
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384X_RATES_5MBPS</span>:
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">5500000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HFA384X_RATES_11MBPS</span>:
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">11000000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* should not happen */</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">11000000</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwsens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">sens</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* Set the desired AP density */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sens</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">sens</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFSYSTEMSCALE</span><span class="p">,</span> <span class="n">sens</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwsens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">sens</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* Get the current AP density */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFSYSTEMSCALE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sens</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">sens</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Deprecated in new wireless extension API */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwaplist</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_quality</span> <span class="o">*</span><span class="n">qual</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SIOCGIWAPLIST is currently only supported &quot;</span>
		       <span class="s">&quot;in Host AP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">*</span> <span class="n">IW_MAX_AP</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">qual</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">)</span> <span class="o">*</span> <span class="n">IW_MAX_AP</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">qual</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">qual</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">prism2_ap_get_sta_qual</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span> <span class="n">IW_MAX_AP</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* has quality information */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qual</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">)</span> <span class="o">*</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">qual</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwrts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rts</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2347</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">2347</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_RTSTHRESHOLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwrts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rts</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_RTSTHRESHOLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">2347</span><span class="p">);</span>
	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwfrag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rts</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2346</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="o">||</span> <span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">2346</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">);</span> <span class="cm">/* even numbers only */</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">fragm_threshold</span> <span class="o">=</span> <span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_FRAGMENTATIONTHRESHOLD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span>
				 <span class="mi">2</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwfrag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rts</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_FRAGMENTATIONTHRESHOLD</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>
	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">rts</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">2346</span><span class="p">);</span>
	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hostap_join_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_join_request</span> <span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_hostscan_result</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">preferred_ap</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">req</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_results_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_results</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_results</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">preferred_ap</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_JOINREQUEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: JoinRequest %pM failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">preferred_ap</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Trying to join BSSID %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">preferred_ap</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">ap_addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PRISM2_NO_STATION_MODES</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">preferred_ap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_roaming</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hfa384x_scan_request</span> <span class="n">scan_req</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_req</span><span class="p">));</span>
		<span class="n">scan_req</span><span class="p">.</span><span class="n">channel_list</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x3fff</span><span class="p">);</span>
		<span class="n">scan_req</span><span class="p">.</span><span class="n">txrate</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HFA384X_RATES_1MBPS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_SCANREQUEST</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">scan_req</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_req</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: ScanResults request failed - &quot;</span>
			       <span class="s">&quot;preferred AP delayed to next unsolicited &quot;</span>
			       <span class="s">&quot;scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_roaming</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
		   <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_join_ap</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Preferred AP (SIOCSIWAP) is used only &quot;</span>
		       <span class="s">&quot;in Managed mode when host_roaming is enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">ap_addr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HOSTAP_INTERFACE_AP</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HOSTAP_INTERFACE_STA</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">assoc_ap_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HOSTAP_INTERFACE_WDS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wds</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CURRENTBSSID</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

		<span class="cm">/* local-&gt;bssid is also updated in LinkStatus handler when in</span>
<span class="cm">		 * station mode */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap_addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwnickn</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nickname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">nickname</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">name_set</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNNAME</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwnickn</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nickname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">MAX_NAME_LEN</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNNAME</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">MAX_NAME_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_NAME_LEN</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">MAX_NAME_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">name</span><span class="p">[</span><span class="n">val</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">nickname</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">freq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* freq =&gt; chan. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span> <span class="o">&gt;=</span> <span class="n">freq_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
	    <span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span> <span class="o">&lt;=</span> <span class="n">freq_list</span><span class="p">[</span><span class="n">FREQ_COUNT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">FREQ_COUNT</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fr</span> <span class="o">==</span> <span class="n">freq_list</span><span class="p">[</span><span class="n">ch</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">freq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">ch</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;</span> <span class="n">FREQ_COUNT</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span> <span class="cm">/* channel is used in prism2_setup_rids() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNCHANNEL</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwfreq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">freq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CURRENTCHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span>
	    <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">le16_to_cpus</span><span class="p">(</span><span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">FREQ_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">freq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">freq_list</span><span class="p">[</span><span class="n">val</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="n">freq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_monitor_set_type</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">==</span> <span class="n">PRISM2_MONITOR_PRISM</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">==</span> <span class="n">PRISM2_MONITOR_CAPHDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211_PRISM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">==</span> <span class="n">PRISM2_MONITOR_RADIOTAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211_RADIOTAP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwessid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HOSTAP_INTERFACE_WDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span> <span class="cm">/* ANY */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="n">ssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Setting SSID to empty string seems to kill the card in</span>
<span class="cm">		 * Host AP mode */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Host AP mode does not support &quot;</span>
		       <span class="s">&quot;&#39;Any&#39; essid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">[</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ap</span> <span class="o">&amp;&amp;</span>
	     <span class="n">hostap_set_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFDESIREDSSID</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">))</span>
	    <span class="o">||</span> <span class="n">hostap_set_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNSSID</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwessid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">essid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HOSTAP_INTERFACE_WDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">ssid</span><span class="p">[</span><span class="n">MAX_SSID_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CURRENTSSID</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">MAX_SSID_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">ssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_SSID_LEN</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">MAX_SSID_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="n">ssid</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwrange</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">over2</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">));</span>

	<span class="cm">/* TODO: could fill num_txpower and txpower array with</span>
<span class="cm">	 * something; however, there are 128 different values.. */</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower_capa</span> <span class="o">=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_pmp</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_pmp</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_pmt</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_pmt</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmp_flags</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmt_flags</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">pm_capa</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span> <span class="o">|</span> <span class="n">IW_POWER_TIMEOUT</span> <span class="o">|</span>
			<span class="n">IW_POWER_UNICAST_R</span> <span class="o">|</span> <span class="n">IW_POWER_ALL_R</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_capa</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_retry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_retry</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">FREQ_COUNT</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FREQ_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">freq_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">val</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">val</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">IW_MAX_FREQUENCIES</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">70</span><span class="p">;</span> <span class="cm">/* what is correct max? This was not</span>
<span class="cm">					    * documented exactly. At least</span>
<span class="cm">					    * 69 has been observed. */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* dB */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* dB */</span>

		<span class="cm">/* What would be suitable values for &quot;average/typical&quot; qual? */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">60</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="o">-</span><span class="mi">95</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">92</span><span class="p">;</span> <span class="cm">/* 0 .. 92 */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">154</span><span class="p">;</span> <span class="cm">/* 27 .. 154 */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">154</span><span class="p">;</span> <span class="cm">/* 27 .. 154 */</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span> <span class="n">WEP_KEYS</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>

	<span class="n">over2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">prism2_get_datarates</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rates</span><span class="p">);</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">&lt;</span> <span class="n">IW_MAX_BITRATES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x0b</span> <span class="o">||</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x16</span><span class="p">)</span>
			<span class="n">over2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* estimated maximum TCP throughput values (bps) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="n">over2</span> <span class="o">?</span> <span class="mi">5500000</span> <span class="o">:</span> <span class="mi">1500000</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_rts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_rts</span> <span class="o">=</span> <span class="mi">2347</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_frag</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_frag</span> <span class="o">=</span> <span class="mi">2346</span><span class="p">;</span>

	<span class="cm">/* Event capability (kernel + driver) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">IW_EVENT_CAPA_K_0</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">));</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_EVENT_CAPA_K_1</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">IWEVTXDROP</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">IWEVCUSTOM</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">IWEVREGISTERED</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">IWEVEXPIRED</span><span class="p">));</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">=</span> <span class="n">IW_ENC_CAPA_WPA</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_WPA2</span> <span class="o">|</span>
		<span class="n">IW_ENC_CAPA_CIPHER_TKIP</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_CIPHER_CCMP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">scan_capa</span> <span class="o">=</span> <span class="n">IW_SCAN_CAPA_ESSID</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hostap_monitor_mode_enable</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Enabling monitor mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">hostap_monitor_set_type</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPORTTYPE</span><span class="p">,</span>
			    <span class="n">HFA384X_PORTTYPE_PSEUDO_IBSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Port type setting for monitor mode &quot;</span>
		       <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Host decrypt is needed to get the IV and ICV fields;</span>
<span class="cm">	 * however, monitor mode seems to remove WEP flag from frame</span>
<span class="cm">	 * control field */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFWEPFLAGS</span><span class="p">,</span>
			    <span class="n">HFA384X_WEPFLAGS_HOSTENCRYPT</span> <span class="o">|</span>
			    <span class="n">HFA384X_WEPFLAGS_HOSTDECRYPT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;WEP flags setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_TEST</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">HFA384X_TEST_MONITOR</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Setting monitor mode failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hostap_monitor_mode_disable</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Disabling monitor mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_TEST</span> <span class="o">|</span>
			     <span class="p">(</span><span class="n">HFA384X_TEST_STOP</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="n">__u32</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">double_reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
	    <span class="o">*</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">IW_MODE_REPEAT</span> <span class="o">&amp;&amp;</span>
	    <span class="o">*</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

<span class="cp">#ifdef PRISM2_NO_STATION_MODES</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">||</span> <span class="o">*</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span> <span class="o">==</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: empty SSID not allowed in Master &quot;</span>
		       <span class="s">&quot;mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">hostap_monitor_mode_disable</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">||</span>
	     <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* There seems to be a firmware bug in at least STA f/w v1.5.6</span>
<span class="cm">		 * that leaves beacon frames to use IBSS type when moving from</span>
<span class="cm">		 * IBSS to Host AP mode. Doing double Port0 reset seems to be</span>
<span class="cm">		 * enough to workaround this. */</span>
		<span class="n">double_reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;prism2: %s: operating mode changed &quot;</span>
	       <span class="s">&quot;%d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">,</span> <span class="o">*</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="o">*</span><span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">hostap_monitor_mode_enable</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span>
		 <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_encrypt_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: defaulting to host-based encryption as &quot;</span>
		       <span class="s">&quot;a workaround for firmware bug in Host AP mode WEP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPORTTYPE</span><span class="p">,</span>
			    <span class="n">hostap_get_porttype</span><span class="p">(</span><span class="n">local</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">double_reset</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* netif_carrier is used only in client modes for now, so make</span>
<span class="cm">		 * sure carrier is on when moving to non-client modes. */</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="n">__u32</span> <span class="o">*</span><span class="n">mode</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">HOSTAP_INTERFACE_STA</span>:
		<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">HOSTAP_INTERFACE_WDS</span>:
		<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_REPEAT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">mode</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">wrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PRISM2_NO_STATION_MODES</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPMENABLED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_MODE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_POWER_UNICAST_R</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFMULTICASTRECEIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPMENABLED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_POWER_ALL_R</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFMULTICASTRECEIVE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPMENABLED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_POWER_ON</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPMENABLED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPMHOLDOVERDURATION</span><span class="p">,</span>
				      <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_PERIOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPMENABLED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFMAXSLEEPDURATION</span><span class="p">,</span>
				      <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PRISM2_NO_STATION_MODES</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">enable</span><span class="p">,</span> <span class="n">mcast</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPMENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">enable</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
	    <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">enable</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">timeout</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">HFA384X_RID_CNFPMHOLDOVERDURATION</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">timeout</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">period</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFMAXSLEEPDURATION</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">period</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">period</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFMULTICASTRECEIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mcast</span><span class="p">,</span>
				 <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mcast</span><span class="p">))</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_ALL_R</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_UNICAST_R</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwretry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* setting retry limits is not supported with the current station</span>
<span class="cm">	 * firmware code; simulate this with alternative retry count for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* disable manual retry count setting and use firmware</span>
<span class="cm">			 * defaults */</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">manual_retry_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">HFA384X_TX_CTRL_ALT_RTRY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFALTRETRYCOUNT</span><span class="p">,</span>
					    <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Alternate retry count &quot;</span>
				       <span class="s">&quot;setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">local</span><span class="o">-&gt;</span><span class="n">manual_retry_count</span> <span class="o">=</span> <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">HFA384X_TX_CTRL_ALT_RTRY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* what could be done, if firmware would support this.. */</span>

<span class="c">	if (rrq-&gt;flags &amp; IW_RETRY_LIMIT) {</span>
<span class="c">		if (rrq-&gt;flags &amp; IW_RETRY_LONG)</span>
<span class="c">			HFA384X_RID_LONGRETRYLIMIT = rrq-&gt;value;</span>
<span class="c">		else if (rrq-&gt;flags &amp; IW_RETRY_SHORT)</span>
<span class="c">			HFA384X_RID_SHORTRETRYLIMIT = rrq-&gt;value;</span>
<span class="c">		else {</span>
<span class="c">			HFA384X_RID_LONGRETRYLIMIT = rrq-&gt;value;</span>
<span class="c">			HFA384X_RID_SHORTRETRYLIMIT = rrq-&gt;value;</span>
<span class="c">		}</span>

<span class="c">	}</span>

<span class="c">	if (rrq-&gt;flags &amp; IW_RETRY_LIFETIME) {</span>
<span class="c">		HFA384X_RID_MAXTRANSMITLIFETIME = rrq-&gt;value / 1024;</span>
<span class="c">	}</span>

<span class="c">	return 0;</span>
<span class="cp">#endif /* 0 */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwretry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">shortretry</span><span class="p">,</span> <span class="n">longretry</span><span class="p">,</span> <span class="n">lifetime</span><span class="p">,</span> <span class="n">altretry</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_SHORTRETRYLIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">shortretry</span><span class="p">,</span>
				 <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_LONGRETRYLIMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">longretry</span><span class="p">,</span>
				 <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_MAXTRANSMITLIFETIME</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">lifetime</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lifetime</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">manual_retry_count</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						 <span class="n">HFA384X_RID_CNFALTRETRYCOUNT</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">altretry</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">altretry</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">manual_retry_count</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LONG</span><span class="p">;</span>
			<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">longretry</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
			<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">shortretry</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">shortretry</span> <span class="o">!=</span> <span class="n">longretry</span><span class="p">)</span>
				<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_RETRY_SHORT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Note! This TX power controlling is experimental and should not be used in</span>
<span class="cm"> * production use. It just sets raw power register and does not use any kind of</span>
<span class="cm"> * feedback information from the measured TX power (CR58). This is now</span>
<span class="cm"> * commented out to make sure that it is not used by accident. TX power</span>
<span class="cm"> * configuration will be enabled again after proper algorithm using feedback</span>
<span class="cm"> * has been implemented. */</span>

<span class="cp">#ifdef RAW_TXPOWER_SETTING</span>
<span class="cm">/* Map HFA386x&#39;s CR31 to and from dBm with some sort of ad hoc mapping..</span>
<span class="cm"> * This version assumes following mapping:</span>
<span class="cm"> * CR31 is 7-bit value with -64 to +63 range.</span>
<span class="cm"> * -64 is mapped into +20dBm and +63 into -43dBm.</span>
<span class="cm"> * This is certainly not an exact mapping for every card, but at least</span>
<span class="cm"> * increasing dBm value should correspond to increasing TX power.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_txpower_hfa386x_to_dBm</span><span class="p">(</span><span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">12</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">prism2_txpower_dBm_to_hfa386x</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">signed</span> <span class="kt">char</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">43</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">127</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">12</span> <span class="o">-</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* RAW_TXPOWER_SETTING */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwtxpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
<span class="cp">#ifdef RAW_TXPOWER_SETTING</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">!=</span> <span class="n">PRISM2_TXPOWER_OFF</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* use all standby and sleep modes */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_WRITEMIF</span><span class="p">,</span>
					       <span class="n">HFA386X_CR_A_D_TEST_MODES2</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Turning radio off: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">=</span> <span class="n">PRISM2_TXPOWER_OFF</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">==</span> <span class="n">PRISM2_TXPOWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* disable all standby and sleep modes */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_WRITEMIF</span><span class="p">,</span>
				       <span class="n">HFA386X_CR_A_D_TEST_MODES2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Turning radio on: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;OK&quot;</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">=</span> <span class="n">PRISM2_TXPOWER_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef RAW_TXPOWER_SETTING</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">!=</span> <span class="n">PRISM2_TXPOWER_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Setting ALC on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">HFA384X_TEST_CFG_BIT_ALC</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_TEST</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">HFA384X_TEST_CFG_BITS</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">=</span> <span class="n">PRISM2_TXPOWER_AUTO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">!=</span> <span class="n">PRISM2_TXPOWER_FIXED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Setting ALC off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">HFA384X_TEST_CFG_BIT_ALC</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_TEST</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">HFA384X_TEST_CFG_BITS</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">=</span> <span class="n">PRISM2_TXPOWER_FIXED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">IW_TXPOW_DBM</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;dBm&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="n">IW_TXPOW_MWATT</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;mW&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Setting TX power to %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SIOCSIWTXPOW with mW is not supported; use dBm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower</span> <span class="o">=</span> <span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">prism2_txpower_dBm_to_hfa386x</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_WRITEMIF</span><span class="p">,</span>
			     <span class="n">HFA386X_CR_MANUAL_TX_POWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* RAW_TXPOWER_SETTING */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* RAW_TXPOWER_SETTING */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwtxpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">rrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef RAW_TXPOWER_SETTING</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">resp0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">;</span>
	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">==</span> <span class="n">PRISM2_TXPOWER_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_READMIF</span><span class="p">,</span>
				     <span class="n">HFA386X_CR_MANUAL_TX_POWER</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resp0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">prism2_txpower_hfa386x_to_dBm</span><span class="p">(</span><span class="n">resp0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Could not get real txpower; guess 15 dBm */</span>
			<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">==</span> <span class="n">PRISM2_TXPOWER_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span> <span class="o">==</span> <span class="n">PRISM2_TXPOWER_FIXED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">;</span>
		<span class="n">rrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SIOCGIWTXPOW - unknown txpower_type=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">txpower_type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* RAW_TXPOWER_SETTING */</span><span class="cp"></span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* RAW_TXPOWER_SETTING */</span><span class="cp"></span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>

<span class="cm">/* HostScan request works with and without host_roaming mode. In addition, it</span>
<span class="cm"> * does not break current association. However, it requires newer station</span>
<span class="cm"> * firmware version (&gt;= 1.3.1) than scan request. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_request_hostscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ssid_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_hostscan_request</span> <span class="n">scan_req</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_req</span><span class="p">));</span>
	<span class="n">scan_req</span><span class="p">.</span><span class="n">channel_list</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">&amp;</span>
					    <span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_channel_mask</span><span class="p">);</span>
	<span class="n">scan_req</span><span class="p">.</span><span class="n">txrate</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HFA384X_RATES_1MBPS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">scan_req</span><span class="p">.</span><span class="n">target_ssid_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">scan_req</span><span class="p">.</span><span class="n">target_ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_HOSTSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_req</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_req</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: HOSTSCAN failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_request_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_scan_request</span> <span class="n">scan_req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_req</span><span class="p">));</span>
	<span class="n">scan_req</span><span class="p">.</span><span class="n">channel_list</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">&amp;</span>
					    <span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_channel_mask</span><span class="p">);</span>
	<span class="n">scan_req</span><span class="p">.</span><span class="n">txrate</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">HFA384X_RATES_1MBPS</span><span class="p">);</span>

	<span class="cm">/* FIX:</span>
<span class="cm">	 * It seems to be enough to set roaming mode for a short moment to</span>
<span class="cm">	 * host-based and then setup scanrequest data and return the mode to</span>
<span class="cm">	 * firmware-based.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Master mode would need to drop to Managed mode for a short while</span>
<span class="cm">	 * to make scanning work.. Or sweep through the different channels and</span>
<span class="cm">	 * use passive scan based on beacons. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_roaming</span><span class="p">)</span>
		<span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFROAMINGMODE</span><span class="p">,</span>
				<span class="n">HFA384X_ROAMING_HOST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_SCANREQUEST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_req</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_req</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;SCANREQUEST failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_roaming</span><span class="p">)</span>
		<span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFROAMINGMODE</span><span class="p">,</span>
				<span class="n">HFA384X_ROAMING_FIRMWARE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !PRISM2_NO_STATION_MODES */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">prism2_request_hostscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ssid_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">prism2_request_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* !PRISM2_NO_STATION_MODES */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_scan_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_scan_req</span><span class="p">))</span>
		<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In master mode, we just return the results of our local</span>
<span class="cm">		 * tables, so we don&#39;t need to start anything...</span>
<span class="cm">		 * Jean II */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_SCAN_THIS_ESSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssid</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">;</span>
		<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">essid_len</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
		      <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&lt;</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_request_hostscan</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_request_scan</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Could inquire F101, F103 or wait for SIOCGIWSCAN and read RID */</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">__prism2_translate_scan</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">hfa384x_hostscan_result</span> <span class="o">*</span><span class="n">scan</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end_buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_event</span> <span class="n">iwe</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">capabilities</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssid</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">;</span>
		<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
		<span class="n">bssid</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ssid</span> <span class="o">=</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">;</span>
		<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">bssid</span> <span class="o">=</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="cm">/* First entry *MUST* be the AP MAC address */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
					  <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span>

	<span class="cm">/* Other entries will be displayed in the order we give them */</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">ssid</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">capabilities</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">capab_info</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">capabilities</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WLAN_CAPABILITY_ESS</span> <span class="o">|</span>
			    <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">chid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">freq_list</span><span class="p">[</span><span class="n">chan</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVQUAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_type</span> <span class="o">==</span> <span class="n">PRISM2_HOSTSCAN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">sl</span><span class="p">);</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">anl</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span>
				<span class="n">HFA384X_LEVEL_TO_dBm</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">sl</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span>
				<span class="n">HFA384X_LEVEL_TO_dBm</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">anl</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span>
			<span class="o">|</span> <span class="n">IW_QUAL_NOISE_UPDATED</span>
			<span class="o">|</span> <span class="n">IW_QUAL_QUAL_INVALID</span>
			<span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/* TODO: add SuppRates into BSS table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWRATE</span><span class="p">;</span>
		<span class="n">current_val</span> <span class="o">=</span> <span class="n">current_ev</span> <span class="o">+</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">sup_rates</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">sup_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* Bit rate given in 500 kb/s units (+ 0x80) */</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">);</span>
			<span class="n">current_val</span> <span class="o">=</span> <span class="n">iwe_stream_add_value</span><span class="p">(</span>
				<span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">current_val</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
				<span class="n">IW_EV_PARAM_LEN</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Check if we added any event */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">current_val</span> <span class="o">-</span> <span class="n">current_ev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="n">current_ev</span> <span class="o">=</span> <span class="n">current_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: add BeaconInt,resp_rate,atim into BSS table */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">MAX_WPA_IE_LEN</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">30</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVCUSTOM</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;bcn_int=%d&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVCUSTOM</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;resp_rate=%d&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_type</span> <span class="o">==</span> <span class="n">PRISM2_HOSTSCAN</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVCUSTOM</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;atim=%d&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">atim</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
							  <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">&amp;&amp;</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">&lt;=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">&amp;&amp;</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">&lt;=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">current_ev</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Translate scan data returned from the card to a card independent</span>
<span class="cm"> * format that the Wireless Tools will understand - Jean II */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">prism2_translate_scan</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfa384x_hostscan_result</span> <span class="o">*</span><span class="n">scan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">,</span> <span class="n">hostscan</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end_buf</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_bss_info</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">included</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hostscan</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_type</span> <span class="o">==</span> <span class="n">PRISM2_HOSTSCAN</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_results_count</span><span class="p">;</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_results</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

		<span class="cm">/* Report every SSID if the AP is using multiple SSIDs. If no</span>
<span class="cm">		 * BSS record is found (e.g., when WPA mode is disabled),</span>
<span class="cm">		 * report the AP once. */</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
			<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_bss_info</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bss</span><span class="o">-&gt;</span><span class="n">included</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">current_ev</span> <span class="o">=</span> <span class="n">__prism2_translate_scan</span><span class="p">(</span>
					<span class="n">local</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="n">bss</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
					<span class="n">end_buf</span><span class="p">);</span>
				<span class="n">found</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">current_ev</span> <span class="o">=</span> <span class="n">__prism2_translate_scan</span><span class="p">(</span>
				<span class="n">local</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Check if there is space for one more entry */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">end_buf</span> <span class="o">-</span> <span class="n">current_ev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ask user space to try again with a bigger buffer */</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Prism2 firmware has limits (32 at least in some versions) for number</span>
<span class="cm">	 * of BSSes in scan results. Extend this limit by using local BSS list.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_bss_info</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">included</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">__prism2_translate_scan</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">bss</span><span class="p">,</span>
						     <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">);</span>
		<span class="cm">/* Check if there is space for one more entry */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">end_buf</span> <span class="o">-</span> <span class="n">current_ev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ask user space to try again with a bigger buffer */</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">current_ev</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwscan_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef PRISM2_NO_STATION_MODES</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* Wait until the scan is finished. We can probably do better</span>
<span class="cm">	 * than that - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_timestamp</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_timestamp</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Important note : we don&#39;t want to block the caller</span>
<span class="cm">		 * until results are ready for various reasons.</span>
<span class="cm">		 * First, managing wait queues is complex and racy</span>
<span class="cm">		 * (there may be multiple simultaneous callers).</span>
<span class="cm">		 * Second, we grab some rtnetlink lock before coming</span>
<span class="cm">		 * here (in dev_ioctl()).</span>
<span class="cm">		 * Third, the caller can wait on the Wireless Event</span>
<span class="cm">		 * - Jean II */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">prism2_translate_scan</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwscan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In MASTER mode, it doesn&#39;t make sense to go around</span>
<span class="cm">		 * scanning the frequencies and make the stations we serve</span>
<span class="cm">		 * wait when what the user is really interested about is the</span>
<span class="cm">		 * list of stations and access points we are talking to.</span>
<span class="cm">		 * So, just extract results from our cache...</span>
<span class="cm">		 * Jean II */</span>

		<span class="cm">/* Translate to WE format */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">prism2_ap_translate_scan</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Scan result translation succeeded &quot;</span>
			       <span class="s">&quot;(length=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
			       <span class="s">&quot;Scan result translation failed (res=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">res</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Station mode */</span>
		<span class="k">return</span> <span class="n">prism2_ioctl_giwscan_sta</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">prism2_priv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_MONITOR</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;monitor&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_READMIF</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;readmif&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_WRITEMIF</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;writemif&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_RESET</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_INQUIRE</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;inquire&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_SET_RID_WORD</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;set_rid_word&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_MACCMD</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;maccmd&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_WDS_ADD</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wds_add&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_WDS_DEL</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wds_del&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_ADDMAC</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;addmac&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_DELMAC</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;delmac&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_KICKMAC</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;kickmac&quot;</span> <span class="p">},</span>
	<span class="cm">/* --- raw access to sub-ioctls --- */</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_PRISM2_PARAM</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;prism2_param&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_GET_PRISM2_PARAM</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getprism2_param&quot;</span> <span class="p">},</span>
	<span class="cm">/* --- sub-ioctls handlers --- */</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_PRISM2_PARAM</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_IOCTL_GET_PRISM2_PARAM</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
	<span class="cm">/* --- sub-ioctls definitions --- */</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_TXRATECTRL</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;txratectrl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_TXRATECTRL</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gettxratectrl&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_BEACON_INT</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;beacon_int&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_BEACON_INT</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getbeacon_int&quot;</span> <span class="p">},</span>
<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_PSEUDO_IBSS</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pseudo_ibss&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_PSEUDO_IBSS</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getpseudo_ibss&quot;</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_ALC</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;alc&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_ALC</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getalc&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_DUMP</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dump&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_DUMP</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getdump&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_OTHER_AP_POLICY</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;other_ap_policy&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_OTHER_AP_POLICY</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getother_ap_pol&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_MAX_INACTIVITY</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;max_inactivity&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_MAX_INACTIVITY</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getmax_inactivi&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_BRIDGE_PACKETS</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;bridge_packets&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_BRIDGE_PACKETS</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getbridge_packe&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_DTIM_PERIOD</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dtim_period&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_DTIM_PERIOD</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getdtim_period&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_NULLFUNC_ACK</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;nullfunc_ack&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_NULLFUNC_ACK</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getnullfunc_ack&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_MAX_WDS</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;max_wds&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_MAX_WDS</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getmax_wds&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_AUTOM_AP_WDS</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;autom_ap_wds&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_AUTOM_AP_WDS</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getautom_ap_wds&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_AUTH_ALGS</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ap_auth_algs&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_AUTH_ALGS</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getap_auth_algs&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_MONITOR_ALLOW_FCSERR</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;allow_fcserr&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_MONITOR_ALLOW_FCSERR</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getallow_fcserr&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOST_ENCRYPT</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;host_encrypt&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOST_ENCRYPT</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gethost_encrypt&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOST_DECRYPT</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;host_decrypt&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOST_DECRYPT</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gethost_decrypt&quot;</span> <span class="p">},</span>
<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOST_ROAMING</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;host_roaming&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOST_ROAMING</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gethost_roaming&quot;</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_BCRX_STA_KEY</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;bcrx_sta_key&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_BCRX_STA_KEY</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getbcrx_sta_key&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_IEEE_802_1X</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ieee_802_1x&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_IEEE_802_1X</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getieee_802_1x&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_ANTSEL_TX</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;antsel_tx&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_ANTSEL_TX</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getantsel_tx&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_ANTSEL_RX</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;antsel_rx&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_ANTSEL_RX</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getantsel_rx&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_MONITOR_TYPE</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;monitor_type&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_MONITOR_TYPE</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getmonitor_type&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_WDS_TYPE</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wds_type&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_WDS_TYPE</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getwds_type&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOSTSCAN</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;hostscan&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOSTSCAN</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gethostscan&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_SCAN</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ap_scan&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_AP_SCAN</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getap_scan&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_ENH_SEC</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;enh_sec&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_ENH_SEC</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getenh_sec&quot;</span> <span class="p">},</span>
<span class="cp">#ifdef PRISM2_IO_DEBUG</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_IO_DEBUG</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;io_debug&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_IO_DEBUG</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getio_debug&quot;</span> <span class="p">},</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_IO_DEBUG */</span><span class="cp"></span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_BASIC_RATES</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;basic_rates&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_BASIC_RATES</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getbasic_rates&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_OPER_RATES</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;oper_rates&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_OPER_RATES</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getoper_rates&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOSTAPD</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;hostapd&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOSTAPD</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gethostapd&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOSTAPD_STA</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;hostapd_sta&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_HOSTAPD_STA</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gethostapd_sta&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_WPA</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wpa&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_WPA</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getwpa&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_PRIVACY_INVOKED</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;privacy_invoked&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_PRIVACY_INVOKED</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getprivacy_invo&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_TKIP_COUNTERMEASURES</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;tkip_countermea&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_TKIP_COUNTERMEASURES</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;gettkip_counter&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_DROP_UNENCRYPTED</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;drop_unencrypte&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_DROP_UNENCRYPTED</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getdrop_unencry&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_SCAN_CHANNEL_MASK</span><span class="p">,</span>
	  <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;scan_channels&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">PRISM2_PARAM_SCAN_CHANNEL_MASK</span><span class="p">,</span>
	  <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;getscan_channel&quot;</span> <span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_inquire</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_INQUIRE</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_prism2_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					  <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">param</span> <span class="o">=</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRISM2_PARAM_TXRATECTRL</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_tx_rate_control</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_BEACON_INT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFBEACONINT</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>
	<span class="k">case</span> <span class="n">PRISM2_PARAM_PSEUDO_IBSS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">pseudo_adhoc</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">value</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;prism2: %s: pseudo IBSS change %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">pseudo_adhoc</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">pseudo_adhoc</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPORTTYPE</span><span class="p">,</span>
				    <span class="n">hostap_get_porttype</span><span class="p">(</span><span class="n">local</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_ALC</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s ALC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;Disabling&quot;</span> <span class="o">:</span> <span class="s">&quot;Enabling&quot;</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">HFA384X_TEST_CFG_BIT_ALC</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_TEST</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">HFA384X_TEST_CFG_BITS</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				 <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_DUMP</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">frame_dump</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_OTHER_AP_POLICY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ap_policy</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_MAX_INACTIVITY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_BRIDGE_PACKETS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridge_packets</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_DTIM_PERIOD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNDTIMPERIOD</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
		    <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_NULLFUNC_ACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nullfunc_ack</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_MAX_WDS</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wds_max_connections</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_AUTOM_AP_WDS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">autom_ap_wds</span> <span class="o">&amp;&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* add WDS link to all APs in STA table */</span>
				<span class="n">hostap_add_wds_links</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">autom_ap_wds</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_AUTH_ALGS</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_algs</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_auth_algs</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_MONITOR_ALLOW_FCSERR</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_allow_fcserr</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOST_ENCRYPT</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOST_DECRYPT</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>
	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOST_ROAMING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_roaming</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_roaming</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_BCRX_STA_KEY</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">bcrx_sta_key</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_IEEE_802_1X</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">ieee_802_1x</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_ANTSEL_TX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">HOSTAP_ANTSEL_HIGH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">antsel_tx</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">hostap_set_antsel</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_ANTSEL_RX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">HOSTAP_ANTSEL_HIGH</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">antsel_rx</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="n">hostap_set_antsel</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_MONITOR_TYPE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="n">PRISM2_MONITOR_80211</span> <span class="o">&amp;&amp;</span>
		    <span class="n">value</span> <span class="o">!=</span> <span class="n">PRISM2_MONITOR_CAPHDR</span> <span class="o">&amp;&amp;</span>
		    <span class="n">value</span> <span class="o">!=</span> <span class="n">PRISM2_MONITOR_PRISM</span> <span class="o">&amp;&amp;</span>
		    <span class="n">value</span> <span class="o">!=</span> <span class="n">PRISM2_MONITOR_RADIOTAP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
			<span class="n">hostap_monitor_set_type</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_WDS_TYPE</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wds_type</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOSTSCAN</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">hfa384x_hostscan_request</span> <span class="n">scan_req</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rate</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">scan_req</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_req</span><span class="p">));</span>
		<span class="n">scan_req</span><span class="p">.</span><span class="n">channel_list</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x3fff</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">rate</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">rate</span> <span class="o">=</span> <span class="n">HFA384X_RATES_2MBPS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="n">rate</span> <span class="o">=</span> <span class="n">HFA384X_RATES_5MBPS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="n">rate</span> <span class="o">=</span> <span class="n">HFA384X_RATES_11MBPS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">scan_req</span><span class="p">.</span><span class="n">txrate</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rate</span><span class="p">);</span>
		<span class="cm">/* leave SSID empty to accept all SSIDs */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPORTTYPE</span><span class="p">,</span>
					    <span class="n">HFA384X_PORTTYPE_BSS</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Leaving Host AP mode &quot;</span>
				       <span class="s">&quot;for HostScan failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_HOSTSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scan_req</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_req</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;HOSTSCAN failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wait_queue_t</span> <span class="n">__wait</span><span class="p">;</span>
			<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">__wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostscan_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__wait</span><span class="p">);</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">HZ</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
			<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostscan_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">__wait</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPORTTYPE</span><span class="p">,</span>
					    <span class="n">HFA384X_PORTTYPE_HOSTAP</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Returning to Host AP mode &quot;</span>
				       <span class="s">&quot;after HostScan failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_SCAN</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_interval</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">))</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_interval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_ENH_SEC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">enh_sec</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFENHSECURITY</span><span class="p">,</span>
				    <span class="n">local</span><span class="o">-&gt;</span><span class="n">enh_sec</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: cnfEnhSecurity requires STA f/w &quot;</span>
			       <span class="s">&quot;1.6.3 or newer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef PRISM2_IO_DEBUG</span>
	<span class="k">case</span> <span class="n">PRISM2_PARAM_IO_DEBUG</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">io_debug_enabled</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_IO_DEBUG */</span><span class="cp"></span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_BASIC_RATES</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">)</span> <span class="o">!=</span> <span class="n">value</span> <span class="o">||</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: invalid basic rate set - basic &quot;</span>
			       <span class="s">&quot;rates must be in supported rate set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFBASICRATES</span><span class="p">,</span>
				    <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_OPER_RATES</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_rate</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOSTAPD</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_hostapd</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOSTAPD_STA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_hostapd_sta</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_WPA</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wpa</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&lt;</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_SSNHANDLINGMODE</span><span class="p">,</span>
					 <span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_PRIVACY_INVOKED</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_TKIP_COUNTERMEASURES</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_DROP_UNENCRYPTED</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_SCAN_CHANNEL_MASK</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_channel_mask</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_param: unknown param %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_get_prism2_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					      <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRISM2_PARAM_TXRATECTRL</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_tx_rate_control</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_BEACON_INT</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_PSEUDO_IBSS</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">pseudo_adhoc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_ALC</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span> <span class="cm">/* FIX */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_DUMP</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">frame_dump</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_OTHER_AP_POLICY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ap_policy</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_MAX_INACTIVITY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_BRIDGE_PACKETS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridge_packets</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_DTIM_PERIOD</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_NULLFUNC_ACK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nullfunc_ack</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_MAX_WDS</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">wds_max_connections</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_AUTOM_AP_WDS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">autom_ap_wds</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_AUTH_ALGS</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_algs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_MONITOR_ALLOW_FCSERR</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_allow_fcserr</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOST_ENCRYPT</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">host_encrypt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOST_DECRYPT</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOST_ROAMING</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">host_roaming</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_BCRX_STA_KEY</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bcrx_sta_key</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_IEEE_802_1X</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ieee_802_1x</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_ANTSEL_TX</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">antsel_tx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_ANTSEL_RX</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">antsel_rx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_MONITOR_TYPE</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_WDS_TYPE</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">wds_type</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOSTSCAN</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_AP_SCAN</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_interval</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_ENH_SEC</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">enh_sec</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef PRISM2_IO_DEBUG</span>
	<span class="k">case</span> <span class="n">PRISM2_PARAM_IO_DEBUG</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">io_debug_enabled</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_IO_DEBUG */</span><span class="cp"></span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_BASIC_RATES</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_OPER_RATES</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOSTAPD</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_HOSTAPD_STA</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd_sta</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_WPA</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&lt;</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_PRIVACY_INVOKED</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_TKIP_COUNTERMEASURES</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_DROP_UNENCRYPTED</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_PARAM_SCAN_CHANNEL_MASK</span>:
		<span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_channel_mask</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: get_prism2_param: unknown param %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_readmif</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">resp0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_READMIF</span><span class="p">,</span> <span class="o">*</span><span class="n">extra</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">resp0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">extra</span> <span class="o">=</span> <span class="n">resp0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_writemif</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				      <span class="kt">void</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cr</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">cr</span> <span class="o">=</span> <span class="o">*</span><span class="n">extra</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">extra</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_WRITEMIF</span><span class="p">,</span> <span class="n">cr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_monitor</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: process %d (%s) used deprecated iwpriv monitor &quot;</span>
	       <span class="s">&quot;- update software to use iwconfig mode monitor</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">task_pid_nr</span><span class="p">(</span><span class="n">current</span><span class="p">),</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">comm</span><span class="p">);</span>

	<span class="cm">/* Backward compatibility code - this can be removed at some point */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable monitor mode - old mode was not saved, so go to</span>
<span class="cm">		 * Master mode */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_siwmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* netlink socket mode is not supported anymore since it did</span>
<span class="cm">		 * not separate different devices from each other and was not</span>
<span class="cm">		 * best method for delivering large amount of packets to</span>
<span class="cm">		 * user space */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="o">*</span><span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">=</span> <span class="n">PRISM2_MONITOR_80211</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">=</span> <span class="n">PRISM2_MONITOR_PRISM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_siwmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">hostap_monitor_mode_enable</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: manual reset request(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* Disable and enable card */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">hw_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">hw_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* COR sreset */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">hw_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* Disable and enable port 0 */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">prism2_sta_deauth</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">WLAN_REASON_DEAUTH_LEAVING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				     <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Unknown reset request %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_set_rid_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rid</span> <span class="o">=</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Set RID[0x%X] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_mac_cmd_ioctl</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">AP_MAC_CMD_POLICY_OPEN</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">MAC_POLICY_OPEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_MAC_CMD_POLICY_ALLOW</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">MAC_POLICY_ALLOW</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_MAC_CMD_POLICY_DENY</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">policy</span> <span class="o">=</span> <span class="n">MAC_POLICY_DENY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_MAC_CMD_FLUSH</span>:
		<span class="n">ap_control_flush_macs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AP_MAC_CMD_KICKALL</span>:
		<span class="n">ap_control_kickall</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
		<span class="n">hostap_deauth_all_stas</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_download</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prism2_download_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prism2_download_param</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prism2_download_param</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">num_areas</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prism2_download_area</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">download</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_set_genericelement</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">elem</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Add 16-bit length in the beginning of the buffer because Prism2 RID</span>
<span class="cm">	 * includes it.</span>
<span class="cm">	 */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">buf</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">elem</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_GENERICELEMENT</span><span class="p">,</span>
				    <span class="n">buf</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwauth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Host AP driver does not use these parameters and allows</span>
<span class="cm">		 * wpa_supplicant to control them internally.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_algs</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&lt;</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">prism2_set_genericelement</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_roaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_SSNHANDLINGMODE</span><span class="p">,</span>
					    <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">hostap_set_roaming</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&lt;</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_roaming</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wpa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_SSNHANDLINGMODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">hostap_set_roaming</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">ieee_802_1x</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">privacy_invoked</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwauth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * Host AP driver does not use these parameters and allows</span>
<span class="cm">		 * wpa_supplicant to control them internally.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_TKIP_COUNTERMEASURES</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_algs</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ieee_802_1x</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwencodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypto_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">**</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sta_ptr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alg</span><span class="p">,</span> <span class="o">*</span><span class="n">module</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">sta_ptr</span> <span class="o">=</span> <span class="n">ap_crypt_get_ptrs</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * TODO: add STA entry for the current AP so</span>
<span class="cm">				 * that unicast key can be used. For now, this</span>
<span class="cm">				 * is emulated by using default key idx 0.</span>
<span class="cm">				 */</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">==</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span>
			<span class="n">lib80211_crypt_delayed_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_ENCODE_ALG_WEP</span>:
		<span class="n">alg</span> <span class="o">=</span> <span class="s">&quot;WEP&quot;</span><span class="p">;</span>
		<span class="n">module</span> <span class="o">=</span> <span class="s">&quot;lib80211_crypt_wep&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_ENCODE_ALG_TKIP</span>:
		<span class="n">alg</span> <span class="o">=</span> <span class="s">&quot;TKIP&quot;</span><span class="p">;</span>
		<span class="n">module</span> <span class="o">=</span> <span class="s">&quot;lib80211_crypt_tkip&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_ENCODE_ALG_CCMP</span>:
		<span class="n">alg</span> <span class="o">=</span> <span class="s">&quot;CCMP&quot;</span><span class="p">;</span>
		<span class="n">module</span> <span class="o">=</span> <span class="s">&quot;lib80211_crypt_ccmp&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unsupported algorithm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="n">module</span><span class="p">);</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">alg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown crypto alg &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">alg</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span> <span class="o">||</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">!=</span> <span class="n">IW_ENCODE_ALG_WEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Per station encryption and other than WEP algorithms</span>
<span class="cm">		 * require host-based encryption, so force them on</span>
<span class="cm">		 * automatically.</span>
<span class="cm">		 */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">new_crypt</span><span class="p">;</span>

		<span class="n">lib80211_crypt_delayed_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>

		<span class="n">new_crypt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lib80211_crypt_data</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">try_module_get</span><span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span>
			<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_crypt</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">new_crypt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: if ext_flags does not have IW_ENCODE_EXT_RX_SEQ_VALID, the</span>
<span class="cm">	 * existing seq# should not be changed.</span>
<span class="cm">	 * TODO: if ext_flags has IW_ENCODE_EXT_TX_SEQ_VALID, next TX seq#</span>
<span class="cm">	 * should be changed to something else than zero.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">)</span> <span class="o">||</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">rx_seq</span><span class="p">,</span>
				   <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: key setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta_ptr</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">WEP_KEYS</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">!=</span> <span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span><span class="p">)</span>
		<span class="n">hostap_handle_sta_release</span><span class="p">(</span><span class="n">sta_ptr</span><span class="p">);</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">open_wep</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Do not reset port0 if card is in Managed mode since resetting will</span>
<span class="cm">	 * generate new IEEE 802.11 authentication which may end up in looping</span>
<span class="cm">	 * with IEEE 802.1X. Prism2 documentation seem to require port reset</span>
<span class="cm">	 * after WEP configuration. However, keys are apparently changed at</span>
<span class="cm">	 * least in Managed mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
	      <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwencodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">erq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">**</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sta_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_key_len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>

	<span class="n">max_key_len</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">i</span><span class="o">--</span><span class="p">;</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sta_ptr</span> <span class="o">=</span> <span class="n">ap_crypt_get_ptrs</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">erq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_WEP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_TKIP</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">((</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_CCMP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span>
				<span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_key</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
						       <span class="n">max_key_len</span><span class="p">,</span>
						       <span class="n">ext</span><span class="o">-&gt;</span><span class="n">tx_seq</span><span class="p">,</span>
						       <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">==</span> <span class="n">IW_ENCODE_ALG_TKIP</span> <span class="o">||</span>
			     <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">==</span> <span class="n">IW_ENCODE_ALG_CCMP</span><span class="p">))</span>
				<span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_EXT_TX_SEQ_VALID</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span><span class="p">)</span>
		<span class="n">hostap_handle_sta_release</span><span class="p">(</span><span class="n">sta_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_set_encryption</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypto_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">**</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sta_ptr</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">[</span><span class="n">HOSTAP_CRYPT_ALG_NAME_LEN</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param_len</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">sta_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">sta_ptr</span> <span class="o">=</span> <span class="n">ap_crypt_get_ptrs</span><span class="p">(</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">,</span>
			<span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HOSTAP_CRYPT_FLAG_PERMANENT</span><span class="p">),</span>
			<span class="o">&amp;</span><span class="n">crypt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">HOSTAP_CRYPT_ERR_UNKNOWN_ADDR</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span><span class="p">)</span>
			<span class="n">lib80211_crypt_delayed_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;WEP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;lib80211_crypt_wep&quot;</span><span class="p">);</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;lib80211_crypt_tkip&quot;</span><span class="p">);</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;CCMP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;lib80211_crypt_ccmp&quot;</span><span class="p">);</span>
		<span class="n">ops</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown crypto alg &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">HOSTAP_CRYPT_ERR_UNKNOWN_ALG</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* station based encryption and other than WEP algorithms require</span>
<span class="cm">	 * host-based encryption, so force them on automatically */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">new_crypt</span><span class="p">;</span>

		<span class="n">lib80211_crypt_delayed_deinit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">crypt</span><span class="p">);</span>

		<span class="n">new_crypt</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lib80211_crypt_data</span><span class="p">),</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
		<span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_crypt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_crypt</span><span class="p">);</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span>
				<span class="n">HOSTAP_CRYPT_ERR_CRYPT_INIT_FAILED</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">new_crypt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HOSTAP_CRYPT_FLAG_SET_TX_KEY</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_key</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
				   <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span>
				   <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: key setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">HOSTAP_CRYPT_ERR_KEY_SET_FAILED</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HOSTAP_CRYPT_FLAG_SET_TX_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta_ptr</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TX key idx setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span>
				<span class="n">HOSTAP_CRYPT_ERR_TX_KEY_SET_FAILED</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span><span class="p">)</span>
		<span class="n">hostap_handle_sta_release</span><span class="p">(</span><span class="n">sta_ptr</span><span class="p">);</span>

	<span class="cm">/* Do not reset port0 if card is in Managed mode since resetting will</span>
<span class="cm">	 * generate new IEEE 802.11 authentication which may end up in looping</span>
<span class="cm">	 * with IEEE 802.1X. Prism2 documentation seem to require port reset</span>
<span class="cm">	 * after WEP configuration. However, keys are apparently changed at</span>
<span class="cm">	 * least in Managed mode. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
	      <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">HOSTAP_CRYPT_ERR_CARD_CONF_FAILED</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_get_encryption</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				       <span class="kt">int</span> <span class="n">param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">**</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sta_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_key_len</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">max_key_len</span> <span class="o">=</span> <span class="n">param_len</span> <span class="o">-</span>
		<span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span> <span class="o">-</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">WEP_KEYS</span><span class="p">)</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">tx_keyidx</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sta_ptr</span> <span class="o">=</span> <span class="n">ap_crypt_get_ptrs</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">crypt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">HOSTAP_CRYPT_ERR_UNKNOWN_ADDR</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="s">&quot;none&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">alg</span><span class="p">,</span> <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">HOSTAP_CRYPT_ALG_NAME_LEN</span><span class="p">);</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_key</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key_len</span> <span class="o">=</span>
				<span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_key</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">key</span><span class="p">,</span>
						       <span class="n">max_key_len</span><span class="p">,</span>
						       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">crypt</span><span class="p">.</span><span class="n">seq</span><span class="p">,</span>
						       <span class="p">(</span><span class="o">*</span><span class="n">crypt</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_ptr</span><span class="p">)</span>
		<span class="n">hostap_handle_sta_release</span><span class="p">(</span><span class="n">sta_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_get_rid</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">max_len</span> <span class="o">=</span> <span class="n">param_len</span> <span class="o">-</span> <span class="n">PRISM2_HOSTAPD_RID_HDR_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rid</span><span class="p">.</span><span class="n">rid</span><span class="p">,</span>
				   <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rid</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rid</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_set_rid</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_len</span><span class="p">;</span>

	<span class="n">max_len</span> <span class="o">=</span> <span class="n">param_len</span> <span class="o">-</span> <span class="n">PRISM2_HOSTAPD_RID_HDR_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">max_len</span> <span class="o">&lt;</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rid</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rid</span><span class="p">.</span><span class="n">rid</span><span class="p">,</span>
				    <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rid</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">rid</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_set_assoc_ap_addr</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%ssta: associated as client with AP %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">assoc_ap_addr</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwgenie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">prism2_set_genericelement</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_giwgenie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_set_generic_element</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">param_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">generic_elem</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">max_len</span> <span class="o">=</span> <span class="n">param_len</span> <span class="o">-</span> <span class="n">PRISM2_HOSTAPD_GENERIC_ELEMENT_HDR_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">max_len</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">prism2_set_genericelement</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					 <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">generic_elem</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_siwmlme</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_mlme</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">reason_code</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MLME_DEAUTH</span>:
		<span class="k">return</span> <span class="n">prism2_sta_send_mgmt</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span>
					    <span class="n">IEEE80211_STYPE_DEAUTH</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">reason</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">IW_MLME_DISASSOC</span>:
		<span class="k">return</span> <span class="n">prism2_sta_send_mgmt</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span>
					    <span class="n">IEEE80211_STYPE_DISASSOC</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">reason</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_mlme</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mlme</span><span class="p">.</span><span class="n">reason_code</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">mlme</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MLME_STA_DEAUTH</span>:
		<span class="k">return</span> <span class="n">prism2_sta_send_mgmt</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">,</span>
					    <span class="n">IEEE80211_STYPE_DEAUTH</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">reason</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">MLME_STA_DISASSOC</span>:
		<span class="k">return</span> <span class="n">prism2_sta_send_mgmt</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">,</span>
					    <span class="n">IEEE80211_STYPE_DISASSOC</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">reason</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_scan_req</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
	     <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&lt;</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">prism2_request_hostscan</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scan_req</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
				       <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">scan_req</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">);</span>
<span class="cp">#else </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_STATION_MODES */</span><span class="cp"></span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ioctl_priv_hostapd</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ap_ioctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">prism2_hostapd_param</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">PRISM2_HOSTAPD_MAX_BUF_SIZE</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRISM2_SET_ENCRYPTION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_GET_ENCRYPTION</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_get_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_GET_RID</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_get_rid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_SET_RID</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_set_rid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_SET_ASSOC_AP_ADDR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_set_assoc_ap_addr</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_SET_GENERIC_ELEMENT</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_set_generic_element</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span>
						       <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_MLME</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_mlme</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_SCAN_REQ</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_scan_req</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_hostapd</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
		<span class="n">ap_ioctl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="o">!</span><span class="n">ap_ioctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">pointer</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ap_ioctl</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;hostap&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
		 <span class="s">&quot;%d.%d.%d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		 <span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">prism2_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_drvinfo</span> <span class="o">=</span> <span class="n">prism2_get_drvinfo</span>
<span class="p">};</span>


<span class="cm">/* Structures to export the Wireless Handlers */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">prism2_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCSIWCOMMIT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_get_name</span><span class="p">,</span>			<span class="cm">/* SIOCGIWNAME */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCSIWNWID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCGIWNWID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwfreq</span><span class="p">,</span>		<span class="cm">/* SIOCSIWFREQ */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwfreq</span><span class="p">,</span>		<span class="cm">/* SIOCGIWFREQ */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwmode</span><span class="p">,</span>		<span class="cm">/* SIOCSIWMODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwmode</span><span class="p">,</span>		<span class="cm">/* SIOCGIWMODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwsens</span><span class="p">,</span>		<span class="cm">/* SIOCSIWSENS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwsens</span><span class="p">,</span>		<span class="cm">/* SIOCGIWSENS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span> <span class="cm">/* not used */</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRANGE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwrange</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRANGE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span> <span class="cm">/* not used */</span><span class="p">,</span>		<span class="cm">/* SIOCSIWPRIV */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span> <span class="cm">/* kernel code */</span><span class="p">,</span>		<span class="cm">/* SIOCGIWPRIV */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span> <span class="cm">/* not used */</span><span class="p">,</span>		<span class="cm">/* SIOCSIWSTATS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span> <span class="cm">/* kernel code */</span><span class="p">,</span>		<span class="cm">/* SIOCGIWSTATS */</span>
	<span class="n">iw_handler_set_spy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWSPY */</span>
	<span class="n">iw_handler_get_spy</span><span class="p">,</span>				<span class="cm">/* SIOCGIWSPY */</span>
	<span class="n">iw_handler_set_thrspy</span><span class="p">,</span>				<span class="cm">/* SIOCSIWTHRSPY */</span>
	<span class="n">iw_handler_get_thrspy</span><span class="p">,</span>				<span class="cm">/* SIOCGIWTHRSPY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwap</span><span class="p">,</span>		<span class="cm">/* SIOCSIWAP */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwap</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAP */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwmlme</span><span class="p">,</span>		<span class="cm">/* SIOCSIWMLME */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwaplist</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAPLIST */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwscan</span><span class="p">,</span>		<span class="cm">/* SIOCSIWSCAN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwscan</span><span class="p">,</span>		<span class="cm">/* SIOCGIWSCAN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwessid</span><span class="p">,</span>		<span class="cm">/* SIOCSIWESSID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwessid</span><span class="p">,</span>		<span class="cm">/* SIOCGIWESSID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwnickn</span><span class="p">,</span>		<span class="cm">/* SIOCSIWNICKN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwnickn</span><span class="p">,</span>		<span class="cm">/* SIOCGIWNICKN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwrate</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRATE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwrate</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRATE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwrts</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRTS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwrts</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRTS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwfrag</span><span class="p">,</span>		<span class="cm">/* SIOCSIWFRAG */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwfrag</span><span class="p">,</span>		<span class="cm">/* SIOCGIWFRAG */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwtxpow</span><span class="p">,</span>		<span class="cm">/* SIOCSIWTXPOW */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwtxpow</span><span class="p">,</span>		<span class="cm">/* SIOCGIWTXPOW */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwretry</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRETRY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwretry</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRETRY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwencode</span><span class="p">,</span>		<span class="cm">/* SIOCSIWENCODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwencode</span><span class="p">,</span>		<span class="cm">/* SIOCGIWENCODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwpower</span><span class="p">,</span>		<span class="cm">/* SIOCSIWPOWER */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwpower</span><span class="p">,</span>		<span class="cm">/* SIOCGIWPOWER */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwgenie</span><span class="p">,</span>		<span class="cm">/* SIOCSIWGENIE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwgenie</span><span class="p">,</span>		<span class="cm">/* SIOCGIWGENIE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwauth</span><span class="p">,</span>		<span class="cm">/* SIOCSIWAUTH */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwauth</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAUTH */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_siwencodeext</span><span class="p">,</span>		<span class="cm">/* SIOCSIWENCODEEXT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_giwencodeext</span><span class="p">,</span>		<span class="cm">/* SIOCGIWENCODEEXT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCSIWPMKSA */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* -- hole -- */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">prism2_private_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>							<span class="cm">/* SIOCIWFIRSTPRIV + */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_priv_prism2_param</span><span class="p">,</span>	<span class="cm">/* 0 */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_priv_get_prism2_param</span><span class="p">,</span> <span class="cm">/* 1 */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_priv_writemif</span><span class="p">,</span>	<span class="cm">/* 2 */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism2_ioctl_priv_readmif</span><span class="p">,</span>		<span class="cm">/* 3 */</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">hostap_iw_handler_def</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">num_standard</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">prism2_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">prism2_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">prism2_priv</span><span class="p">),</span>
	<span class="p">.</span><span class="n">standard</span>	<span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span> <span class="n">prism2_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private</span>	<span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span> <span class="n">prism2_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span>	<span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="o">*</span><span class="p">)</span> <span class="n">prism2_priv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">hostap_get_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>


<span class="kt">int</span> <span class="nf">hostap_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="n">wrq</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iwreq</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Private ioctls (iwpriv) that have not yet been converted</span>
<span class="cm">		 * into new wireless extensions API */</span>

	<span class="k">case</span> <span class="n">PRISM2_IOCTL_INQUIRE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_priv_inquire</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_IOCTL_MONITOR</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_priv_monitor</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_IOCTL_RESET</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_priv_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_IOCTL_WDS_ADD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_wds_add</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_IOCTL_WDS_DEL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_wds_del</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_IOCTL_SET_RID_WORD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_priv_set_rid_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
							  <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="k">case</span> <span class="n">PRISM2_IOCTL_MACCMD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ap_mac_cmd_ioctl</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PRISM2_IOCTL_ADDMAC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ap_control_add_mac</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">,</span>
					      <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_IOCTL_DELMAC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ap_control_del_mac</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">,</span>
					      <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_IOCTL_KICKMAC</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ap_control_kick_mac</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


		<span class="cm">/* Private ioctls that are not used with iwpriv;</span>
<span class="cm">		 * in SIOCDEVPRIVATE range */</span>

<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
	<span class="k">case</span> <span class="n">PRISM2_IOCTL_DOWNLOAD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_priv_download</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>

	<span class="k">case</span> <span class="n">PRISM2_IOCTL_HOSTAPD</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">else</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">prism2_ioctl_priv_hostapd</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrq</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
