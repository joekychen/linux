<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › hostap › hostap_hw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hostap_hw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Host AP (software wireless LAN access point) driver for</span>
<span class="cm"> * Intersil Prism2/2.5/3.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2001-2002, SSH Communications Security Corp and Jouni Malinen</span>
<span class="cm"> * &lt;j@w1.fi&gt;</span>
<span class="cm"> * Copyright (c) 2002-2005, Jouni Malinen &lt;j@w1.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation. See README and COPYING for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * FIX:</span>
<span class="cm"> * - there is currently no way of associating TX packets to correct wds device</span>
<span class="cm"> *   when TX Exc/OK event occurs, so all tx_packets and some</span>
<span class="cm"> *   tx_errors/tx_dropped are added to the main netdevice; using sw_support</span>
<span class="cm"> *   field in txdesc might be used to fix this (using Alloc event to increment</span>
<span class="cm"> *   tx_packets would need some further info in txfid table)</span>
<span class="cm"> *</span>
<span class="cm"> * Buffer Access Path (BAP) usage:</span>
<span class="cm"> *   Prism2 cards have two separate BAPs for accessing the card memory. These</span>
<span class="cm"> *   should allow concurrent access to two different frames and the driver</span>
<span class="cm"> *   previously used BAP0 for sending data and BAP1 for receiving data.</span>
<span class="cm"> *   However, there seems to be number of issues with concurrent access and at</span>
<span class="cm"> *   least one know hardware bug in using BAP0 and BAP1 concurrently with PCI</span>
<span class="cm"> *   Prism2.5. Therefore, the driver now only uses BAP0 for moving data between</span>
<span class="cm"> *   host and card memories. BAP0 accesses are protected with local-&gt;baplock</span>
<span class="cm"> *   (spin_lock_bh) to prevent concurrent use.</span>
<span class="cm"> */</span>



<span class="cp">#include &lt;asm/delay.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>
<span class="cp">#include &lt;net/lib80211.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &quot;hostap_80211.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;hostap_ap.h&quot;</span>


<span class="cm">/* #define final_version */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mtu</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">mtu</span><span class="p">,</span> <span class="s">&quot;Maximum transfer unit&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">[</span><span class="n">MAX_PARM_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="n">DEF_INTS</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="s">&quot;Initial channel&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">essid</span><span class="p">[</span><span class="mi">33</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;test&quot;</span><span class="p">;</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">essid</span><span class="p">),</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">essid</span><span class="p">,</span> <span class="s">&quot;Host AP&#39;s ESSID&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">iw_mode</span><span class="p">[</span><span class="n">MAX_PARM_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">IW_MODE_MASTER</span><span class="p">,</span> <span class="n">DEF_INTS</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">iw_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">iw_mode</span><span class="p">,</span> <span class="s">&quot;Initial operation mode&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">beacon_int</span><span class="p">[</span><span class="n">MAX_PARM_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">100</span><span class="p">,</span> <span class="n">DEF_INTS</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">beacon_int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">beacon_int</span><span class="p">,</span> <span class="s">&quot;Beacon interval (1 = 1024 usec)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">dtim_period</span><span class="p">[</span><span class="n">MAX_PARM_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEF_INTS</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">dtim_period</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dtim_period</span><span class="p">,</span> <span class="s">&quot;DTIM period&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">dev_template</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;wlan%d&quot;</span><span class="p">;</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">dev_template</span><span class="p">,</span> <span class="n">dev_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev_template</span><span class="p">),</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dev_template</span><span class="p">,</span> <span class="s">&quot;Prefix for network device name (default: &quot;</span>
		 <span class="s">&quot;wlan%d)&quot;</span><span class="p">);</span>

<span class="cp">#ifdef final_version</span>
<span class="cp">#define EXTRA_EVENTS_WTERR 0</span>
<span class="cp">#else</span>
<span class="cm">/* check WTERR events (Wait Time-out) in development versions */</span>
<span class="cp">#define EXTRA_EVENTS_WTERR HFA384X_EV_WTERR</span>
<span class="cp">#endif</span>

<span class="cm">/* Events that will be using BAP0 */</span>
<span class="cp">#define HFA384X_BAP0_EVENTS \</span>
<span class="cp">	(HFA384X_EV_TXEXC | HFA384X_EV_RX | HFA384X_EV_INFO | HFA384X_EV_TX)</span>

<span class="cm">/* event mask, i.e., events that will result in an interrupt */</span>
<span class="cp">#define HFA384X_EVENT_MASK \</span>
<span class="cp">	(HFA384X_BAP0_EVENTS | HFA384X_EV_ALLOC | HFA384X_EV_INFDROP | \</span>
<span class="cp">	HFA384X_EV_CMD | HFA384X_EV_TICK | \</span>
<span class="cp">	EXTRA_EVENTS_WTERR)</span>

<span class="cm">/* Default TX control flags: use 802.11 headers and request interrupt for</span>
<span class="cm"> * failed transmits. Frames that request ACK callback, will add</span>
<span class="cm"> * _TX_OK flag and _ALT_RTRY flag may be used to select different retry policy.</span>
<span class="cm"> */</span>
<span class="cp">#define HFA384X_TX_CTRL_FLAGS \</span>
<span class="cp">	(HFA384X_TX_CTRL_802_11 | HFA384X_TX_CTRL_TX_EX)</span>


<span class="cm">/* ca. 1 usec */</span>
<span class="cp">#define HFA384X_CMD_BUSY_TIMEOUT 5000</span>
<span class="cp">#define HFA384X_BAP_BUSY_TIMEOUT 50000</span>

<span class="cm">/* ca. 10 usec */</span>
<span class="cp">#define HFA384X_CMD_COMPL_TIMEOUT 20000</span>
<span class="cp">#define HFA384X_DL_COMPL_TIMEOUT 1000000</span>

<span class="cm">/* Wait times for initialization; yield to other processes to avoid busy</span>
<span class="cm"> * waiting for long time. */</span>
<span class="cp">#define HFA384X_INIT_TIMEOUT (HZ / 2) </span><span class="cm">/* 500 ms */</span><span class="cp"></span>
<span class="cp">#define HFA384X_ALLOC_COMPL_TIMEOUT (HZ / 20) </span><span class="cm">/* 50 ms */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2_check_sta_fw_version</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>

<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
<span class="cm">/* hostap_download.c */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2_download_aux_dump</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">prism2_read_pda</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2_download</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">prism2_download_param</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2_download_free_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">prism2_download_data</span> <span class="o">*</span><span class="n">dl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2_download_volatile</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">prism2_download_data</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2_download_genesis</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">prism2_download_data</span> <span class="o">*</span><span class="n">param</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism2_get_ram_size</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>




<span class="cp">#ifndef final_version</span>
<span class="cm">/* magic value written to SWSUPPORT0 reg. for detecting whether card is still</span>
<span class="cm"> * present */</span>
<span class="cp">#define HFA384X_MAGIC 0x8A32</span>
<span class="cp">#endif</span>


<span class="k">static</span> <span class="n">u16</span> <span class="nf">hfa384x_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfa384x_read_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">hfa384x_regs</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_CMD_OFF</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">evstat</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">offset0</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_OFFSET0_OFF</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">offset1</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_OFFSET1_OFF</span><span class="p">);</span>
	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">swsupport0</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_SWSUPPORT0_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * __hostap_cmd_queue_free - Free Prism2 command queue entry (private)</span>
<span class="cm"> * @local: pointer to private Host AP driver data</span>
<span class="cm"> * @entry: Prism2 command queue entry to be freed</span>
<span class="cm"> * @del_req: request the entry to be removed</span>
<span class="cm"> *</span>
<span class="cm"> * Internal helper function for freeing Prism2 command queue entries.</span>
<span class="cm"> * Caller must have acquired local-&gt;cmdlock before calling this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">__hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">hostap_cmd_queue</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">del_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">del_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">del_req</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">del_req</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * hostap_cmd_queue_free - Free Prism2 command queue entry</span>
<span class="cm"> * @local: pointer to private Host AP driver data</span>
<span class="cm"> * @entry: Prism2 command queue entry to be freed</span>
<span class="cm"> * @del_req: request the entry to be removed</span>
<span class="cm"> *</span>
<span class="cm"> * Free a Prism2 command queue entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">hostap_cmd_queue</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span>
					 <span class="kt">int</span> <span class="n">del_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">del_req</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * prism2_clear_cmd_queue - Free all pending Prism2 command queue entries</span>
<span class="cm"> * @local: pointer to private Host AP driver data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_clear_cmd_queue</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_cmd_queue</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_cmd_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: removed pending cmd_queue entry &quot;</span>
		       <span class="s">&quot;(type=%d, cmd=0x%04x, param0=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span>
		       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">param0</span><span class="p">);</span>
		<span class="n">__hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This should not happen; print debug message and clear</span>
<span class="cm">		 * queue length. */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cmd_queue_len (%d) not zero after &quot;</span>
		       <span class="s">&quot;flush</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * hfa384x_cmd_issue - Issue a Prism2 command to the hardware</span>
<span class="cm"> * @dev: pointer to net_device</span>
<span class="cm"> * @entry: Prism2 command queue entry to be issued</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hfa384x_cmd_issue</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">hostap_cmd_queue</span> <span class="o">*</span><span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tries</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">issued</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: driver bug - re-issuing command @%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wait until busy bit is clear; this should always be clear since the</span>
<span class="cm">	 * commands are serialized */</span>
	<span class="n">tries</span> <span class="o">=</span> <span class="n">HFA384X_CMD_BUSY_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_CMD_OFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_CMD_BUSY</span> <span class="o">&amp;&amp;</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tries</span><span class="o">--</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifndef final_version</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">!=</span> <span class="n">HFA384X_CMD_BUSY_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prism2_io_debug_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd_issue: cmd reg was busy &quot;</span>
		       <span class="s">&quot;for %d usec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">HFA384X_CMD_BUSY_TIMEOUT</span> <span class="o">-</span> <span class="n">tries</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_CMD_OFF</span><span class="p">);</span>
		<span class="n">prism2_io_debug_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd_issue - timeout - &quot;</span>
		       <span class="s">&quot;reg=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write command */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">param0</span><span class="p">,</span> <span class="n">HFA384X_PARAM0_OFF</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">param1</span><span class="p">,</span> <span class="n">HFA384X_PARAM1_OFF</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">HFA384X_CMD_OFF</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">issued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * hfa384x_cmd - Issue a Prism2 command and wait (sleep) for completion</span>
<span class="cm"> * @dev: pointer to net_device</span>
<span class="cm"> * @cmd: Prism2 command code (HFA384X_CMD_CODE_*)</span>
<span class="cm"> * @param0: value for Param0 register</span>
<span class="cm"> * @param1: value for Param1 register (pointer; %NULL if not used)</span>
<span class="cm"> * @resp0: pointer for Resp0 data or %NULL if Resp0 is not needed</span>
<span class="cm"> *</span>
<span class="cm"> * Issue given command (possibly after waiting in command queue) and sleep</span>
<span class="cm"> * until the command is completed (or timed out or interrupted). This can be</span>
<span class="cm"> * called only from user process context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hfa384x_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param0</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="o">*</span><span class="n">param1</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">resp0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">issue</span><span class="p">,</span> <span class="n">issued</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_cmd_queue</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd called from interrupt &quot;</span>
		       <span class="s">&quot;context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span> <span class="o">&gt;=</span> <span class="n">HOSTAP_CMD_QUEUE_MAX_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd: cmd_queue full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CMD_SLEEP</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">param0</span> <span class="o">=</span> <span class="n">param0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param1</span><span class="p">)</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">param1</span> <span class="o">=</span> <span class="o">*</span><span class="n">param1</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">);</span>

	<span class="cm">/* prepare to wait for command completion event, but do not sleep yet</span>
<span class="cm">	 */</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">issue</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue</span><span class="p">)</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">issuing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">issue</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">wait_completion</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_cmd_issue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">issued</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">wait_completion:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CMD_COMPLETED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* sleep until command is completed or timed out */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">schedule_timeout</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">issued</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the command was issued, so a CmdCompl event should occur</span>
<span class="cm">		 * soon; however, there&#39;s a pending signal and</span>
<span class="cm">		 * schedule_timeout() would be interrupted; wait a short period</span>
<span class="cm">		 * of time to avoid removing entry from the list before</span>
<span class="cm">		 * CmdCompl event */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* If entry-&gt;list is still in the list, it must be removed</span>
<span class="cm">	 * first and in this case prism2_cmd_ev() does not yet have</span>
<span class="cm">	 * local reference to it, and the data can be kfree()&#39;d</span>
<span class="cm">	 * here. If the command completion event is still generated,</span>
<span class="cm">	 * it will be assigned to next (possibly) pending command, but</span>
<span class="cm">	 * the driver will reset the card anyway due to timeout</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the entry is not in the list prism2_cmd_ev() has a local</span>
<span class="cm">	 * reference to it, but keeps cmdlock as long as the data is</span>
<span class="cm">	 * needed, so the data can be kfree()&#39;d here. */</span>

	<span class="cm">/* FIX: if the entry-&gt;list is in the list, it has not been completed</span>
<span class="cm">	 * yet, so removing it here is somewhat wrong.. this could cause</span>
<span class="cm">	 * references to freed memory and next list_del() causing NULL pointer</span>
<span class="cm">	 * dereference.. it would probably be better to leave the entry in the</span>
<span class="cm">	 * list and the list should be emptied during hw reset */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd: entry still in list? &quot;</span>
		       <span class="s">&quot;(entry=%p, type=%d, res=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span>
		       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd: interrupted; err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CMD_COMPLETED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd: command was not &quot;</span>
		       <span class="s">&quot;completed (res=%d, entry=%p, type=%d, cmd=0x%04x, &quot;</span>
		       <span class="s">&quot;param0=0x%04x, EVSTAT=%04x INTEN=%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">res</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">param0</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
		       <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_INTEN_OFF</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_CMD</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Command completion event is pending, but the</span>
<span class="cm">			 * interrupt was not delivered - probably an issue</span>
<span class="cm">			 * with pcmcia-cs configuration. */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: interrupt delivery does not &quot;</span>
			       <span class="s">&quot;seem to work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">prism2_io_debug_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp0</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">resp0</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">resp0</span><span class="p">;</span>
<span class="cp">#ifndef final_version</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: CMD=0x%04x =&gt; res=0x%02x, &quot;</span>
		       <span class="s">&quot;resp0=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">resp0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* final_version */</span><span class="cp"></span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">;</span>
 <span class="nl">done:</span>
	<span class="n">hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * hfa384x_cmd_callback - Issue a Prism2 command; callback when completed</span>
<span class="cm"> * @dev: pointer to net_device</span>
<span class="cm"> * @cmd: Prism2 command code (HFA384X_CMD_CODE_*)</span>
<span class="cm"> * @param0: value for Param0 register</span>
<span class="cm"> * @callback: command completion callback function (%NULL = no callback)</span>
<span class="cm"> * @context: context data to be given to the callback function</span>
<span class="cm"> *</span>
<span class="cm"> * Issue given command (possibly after waiting in command queue) and use</span>
<span class="cm"> * callback function to indicate command completion. This can be called both</span>
<span class="cm"> * from user and interrupt context. The callback function will be called in</span>
<span class="cm"> * hardware IRQ context. It can be %NULL, when no function is called when</span>
<span class="cm"> * command is completed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hfa384x_cmd_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param0</span><span class="p">,</span>
				<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						 <span class="kt">long</span> <span class="n">context</span><span class="p">,</span> <span class="n">u16</span> <span class="n">resp0</span><span class="p">,</span>
						 <span class="n">u16</span> <span class="n">status</span><span class="p">),</span>
				<span class="kt">long</span> <span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">issue</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_cmd_queue</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span> <span class="o">&gt;=</span> <span class="n">HOSTAP_CMD_QUEUE_MAX_LEN</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd: cmd_queue full</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CMD_CALLBACK</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">param0</span> <span class="o">=</span> <span class="n">param0</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">issue</span> <span class="o">=</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issue</span><span class="p">)</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">issuing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">issue</span> <span class="o">&amp;&amp;</span> <span class="n">hfa384x_cmd_issue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * __hfa384x_cmd_no_wait - Issue a Prism2 command (private)</span>
<span class="cm"> * @dev: pointer to net_device</span>
<span class="cm"> * @cmd: Prism2 command code (HFA384X_CMD_CODE_*)</span>
<span class="cm"> * @param0: value for Param0 register</span>
<span class="cm"> * @io_debug_num: I/O debug error number</span>
<span class="cm"> *</span>
<span class="cm"> * Shared helper function for hfa384x_cmd_wait() and hfa384x_cmd_no_wait().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__hfa384x_cmd_no_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param0</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">io_debug_num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* wait until busy bit is clear; this should always be clear since the</span>
<span class="cm">	 * commands are serialized */</span>
	<span class="n">tries</span> <span class="o">=</span> <span class="n">HFA384X_CMD_BUSY_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_CMD_OFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_CMD_BUSY</span> <span class="o">&amp;&amp;</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tries</span><span class="o">--</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_CMD_OFF</span><span class="p">);</span>
		<span class="n">prism2_io_debug_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">io_debug_num</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: __hfa384x_cmd_no_wait(%d) - timeout - &quot;</span>
		       <span class="s">&quot;reg=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">io_debug_num</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* write command */</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">param0</span><span class="p">,</span> <span class="n">HFA384X_PARAM0_OFF</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">HFA384X_CMD_OFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * hfa384x_cmd_wait - Issue a Prism2 command and busy wait for completion</span>
<span class="cm"> * @dev: pointer to net_device</span>
<span class="cm"> * @cmd: Prism2 command code (HFA384X_CMD_CODE_*)</span>
<span class="cm"> * @param0: value for Param0 register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hfa384x_cmd_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">param0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">tries</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">__hfa384x_cmd_no_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">param0</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

        <span class="cm">/* wait for command completion */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">HFA384X_CMDCODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">HFA384X_CMDCODE_DOWNLOAD</span><span class="p">)</span>
		<span class="n">tries</span> <span class="o">=</span> <span class="n">HFA384X_DL_COMPL_TIMEOUT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tries</span> <span class="o">=</span> <span class="n">HFA384X_CMD_COMPL_TIMEOUT</span><span class="p">;</span>

        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
               <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">tries</span><span class="o">--</span><span class="p">;</span>
                <span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">tries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">reg</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">);</span>
		<span class="n">prism2_io_debug_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
                <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_cmd_wait - timeout2 - &quot;</span>
		       <span class="s">&quot;reg=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_STATUS_OFF</span><span class="p">)</span> <span class="o">&amp;</span>
               <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span>
                <span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
<span class="cp">#ifndef final_version</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: CMD=0x%04x =&gt; res=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_CMD</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * hfa384x_cmd_no_wait - Issue a Prism2 command; do not wait for completion</span>
<span class="cm"> * @dev: pointer to net_device</span>
<span class="cm"> * @cmd: Prism2 command code (HFA384X_CMD_CODE_*)</span>
<span class="cm"> * @param0: value for Param0 register</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">hfa384x_cmd_no_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cmd</span><span class="p">,</span>
				      <span class="n">u16</span> <span class="n">param0</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__hfa384x_cmd_no_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">param0</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * prism2_cmd_ev - Prism2 command completion event handler</span>
<span class="cm"> * @dev: pointer to net_device</span>
<span class="cm"> *</span>
<span class="cm"> * Interrupt handler for command completion events. Called by the main</span>
<span class="cm"> * interrupt handler in hardware IRQ context. Read Resp0 and status registers</span>
<span class="cm"> * from the hardware and ACK the event. Depending on the issued command type</span>
<span class="cm"> * either wake up the sleeping process that is waiting for command completion</span>
<span class="cm"> * or call the callback function. Issue the next command, if one is pending.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_cmd_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_cmd_queue</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hostap_cmd_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">);</span>
		<span class="n">list_del_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue_len</span><span class="o">--</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">issued</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Command completion event, but &quot;</span>
			       <span class="s">&quot;cmd not issued</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">__hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_CMD</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Command completion event, but no &quot;</span>
		       <span class="s">&quot;pending commands</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">resp0</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_RESP0_OFF</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_STATUS_OFF</span><span class="p">)</span> <span class="o">&amp;</span>
		      <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">BIT</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_CMD</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>

	<span class="cm">/* TODO: rest of the CmdEv handling could be moved to tasklet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMD_SLEEP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">CMD_COMPLETED</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">compl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CMD_CALLBACK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">resp0</span><span class="p">,</span>
					<span class="n">entry</span><span class="o">-&gt;</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Invalid command completion type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* issue next command, if pending */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">hostap_cmd_queue</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">issuing</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* hfa384x_cmd() has already started issuing this</span>
<span class="cm">			 * command, so do not start here */</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">usecnt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* issue next command; if command issuing fails, remove the</span>
<span class="cm">		 * entry from cmd_queue */</span>
		<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_cmd_issue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
		<span class="n">__hostap_cmd_queue_free</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hfa384x_wait_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">o_off</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="n">HFA384X_BAP_BUSY_TIMEOUT</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">o_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_OFFSET_BUSY</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tries</span><span class="o">--</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">o_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_OFFSET_BUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Offset must be even */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hfa384x_setup_bap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">bap</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">o_off</span><span class="p">,</span> <span class="n">s_off</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">bap</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bap</span> <span class="o">==</span> <span class="n">BAP1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">o_off</span> <span class="o">=</span> <span class="n">HFA384X_OFFSET1_OFF</span><span class="p">;</span>
		<span class="n">s_off</span> <span class="o">=</span> <span class="n">HFA384X_SELECT1_OFF</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">o_off</span> <span class="o">=</span> <span class="n">HFA384X_OFFSET0_OFF</span><span class="p">;</span>
		<span class="n">s_off</span> <span class="o">=</span> <span class="n">HFA384X_SELECT0_OFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_wait_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">o_off</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prism2_io_debug_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_setup_bap - timeout before</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">s_off</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">o_off</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_wait_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">o_off</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">prism2_io_debug_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_setup_bap - timeout after</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifndef final_version</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">o_off</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_OFFSET_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prism2_io_debug_error</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_setup_bap - offset error &quot;</span>
		       <span class="s">&quot;(%d,0x04%x,%d); reg=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bap</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">o_off</span><span class="p">));</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hfa384x_get_rid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">exact_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">rlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_rid_hdr</span> <span class="n">rec</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">no_pri</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cannot get RID %04x (len=%d) - no PRI &quot;</span>
		       <span class="s">&quot;f/w</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span> <span class="cm">/* Well.. not really correct, but return</span>
<span class="cm">				 * something unique enough.. */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_downloading</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rid_bap_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_ACCESS</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_get_rid: CMDCODE_ACCESS failed &quot;</span>
		       <span class="s">&quot;(res=%d, rid=%04x, len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rid_bap_mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_setup_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_from_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* RID not available */</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="n">exact_len</span> <span class="o">&amp;&amp;</span> <span class="n">rlen</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_get_rid - RID len mismatch: &quot;</span>
		       <span class="s">&quot;rid=0x%04x, len=%d (expected %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">rlen</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_from_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rid_bap_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_get_rid (rid=%04x, &quot;</span>
			       <span class="s">&quot;len=%d) - failed - res=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span>
			       <span class="n">len</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
			<span class="n">prism2_hw_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rlen</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hfa384x_set_rid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_rid_hdr</span> <span class="n">rec</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">no_pri</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cannot set RID %04x (len=%d) - no PRI &quot;</span>
		       <span class="s">&quot;f/w</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span> <span class="cm">/* Well.. not really correct, but return</span>
<span class="cm">				 * something unique enough.. */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_downloading</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">rec</span><span class="p">.</span><span class="n">rid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rid</span><span class="p">);</span>
	<span class="cm">/* RID len in words and +1 for rec.rid */</span>
	<span class="n">rec</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">len</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rid_bap_mtx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_setup_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_to_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rec</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rec</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_to_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_set_rid (rid=%04x, len=%d) - &quot;</span>
		       <span class="s">&quot;failed - res=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rid_bap_mtx</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_ACCESS_WRITE</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rid_bap_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hfa384x_set_rid: CMDCODE_ACCESS_WRITE &quot;</span>
		       <span class="s">&quot;failed (res=%d, rid=%04x, len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
			<span class="n">prism2_hw_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfa384x_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* disable interrupts and clear event status */</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">HFA384X_INTEN_OFF</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfa384x_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ack pending events and enable interrupts from selected events */</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EVENT_MASK</span><span class="p">,</span> <span class="n">HFA384X_INTEN_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfa384x_events_no_bap0</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EVENT_MASK</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HFA384X_BAP0_EVENTS</span><span class="p">,</span>
		     <span class="n">HFA384X_INTEN_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfa384x_events_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EVENT_MASK</span><span class="p">,</span> <span class="n">HFA384X_INTEN_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hfa384x_events_only_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_CMD</span><span class="p">,</span> <span class="n">HFA384X_INTEN_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u16</span> <span class="nf">hfa384x_allocate_fid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="cm">/* FIX: this could be replace with hfa384x_cmd() if the Alloc event</span>
<span class="cm">	 * below would be handled like CmdCompl event (sleep here, wake up from</span>
<span class="cm">	 * interrupt handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_cmd_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_ALLOC</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: cannot allocate fid, len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">delay</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HFA384X_ALLOC_COMPL_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_ALLOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">delay</span><span class="p">))</span>
		<span class="n">yield</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_ALLOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: fid allocate, len=%d - timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fid</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_ALLOCFID_OFF</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_ALLOC</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fid</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_reset_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: reset port failed to disable port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				  <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: reset port failed to enable &quot;</span>
			       <span class="s">&quot;port</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* It looks like at least some STA firmware versions reset</span>
<span class="cm">	 * fragmentation threshold back to 2346 after enable command. Restore</span>
<span class="cm">	 * the configured value, if it differs from this default. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fragm_threshold</span> <span class="o">!=</span> <span class="mi">2346</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_FRAGMENTATIONTHRESHOLD</span><span class="p">,</span>
			    <span class="n">local</span><span class="o">-&gt;</span><span class="n">fragm_threshold</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: failed to restore fragmentation &quot;</span>
		       <span class="s">&quot;threshold (%d) after Port0 enable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">fragm_threshold</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Some firmwares lose antenna selection settings on reset */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">hostap_set_antsel</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_get_version_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">txt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfa384x_comp_ident</span> <span class="n">comp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">no_pri</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PRI f/w not yet available - cannot read RIDs */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Could not get RID for component %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s: id=0x%02x v%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span>
	       <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">id</span><span class="p">),</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">major</span><span class="p">),</span>
	       <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">minor</span><span class="p">),</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">variant</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_setup_rids</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_TICKTIME</span><span class="p">,</span> <span class="mi">2000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">tmp1</span> <span class="o">=</span> <span class="n">hostap_get_porttype</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFPORTTYPE</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Port type setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Setting SSID to empty string seems to kill the card in Host AP mode</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNSSID</span><span class="p">,</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: AP own SSID setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFMAXDATALEN</span><span class="p">,</span>
			      <span class="n">PRISM2_DATA_MAXLEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: MAC data length setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">PRISM2_DATA_MAXLEN</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CHANNELLIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Channel list read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Channel setting out of range &quot;</span>
		       <span class="s">&quot;(%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNCHANNEL</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Channel setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFBEACONINT</span><span class="p">,</span>
			      <span class="n">local</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Beacon interval setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
		<span class="cm">/* this may fail with Symbol/Lucent firmware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNDTIMPERIOD</span><span class="p">,</span>
			      <span class="n">local</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: DTIM period setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>
		<span class="cm">/* this may fail with Symbol/Lucent firmware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_PROMISCUOUSMODE</span><span class="p">,</span>
			      <span class="n">local</span><span class="o">-&gt;</span><span class="n">is_promisc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Setting promiscuous mode (%d) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">is_promisc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFDESIREDSSID</span><span class="p">,</span>
					<span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Desired SSID setting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Setup TXRateControl, defaults to allow use of 1, 2, 5.5, and</span>
<span class="cm">	 * 11 Mbps in automatic TX rate fallback and 1 and 2 Mbps as basic</span>
<span class="cm">	 * rates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">=</span>
			<span class="n">HFA384X_RATES_1MBPS</span> <span class="o">|</span>
			<span class="n">HFA384X_RATES_2MBPS</span> <span class="o">|</span>
			<span class="n">HFA384X_RATES_5MBPS</span> <span class="o">|</span>
			<span class="n">HFA384X_RATES_11MBPS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="n">HFA384X_RATES_1MBPS</span> <span class="o">|</span> <span class="n">HFA384X_RATES_2MBPS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_TXRATECONTROL</span><span class="p">,</span>
				      <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: TXRateControl setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFSUPPORTEDRATES</span><span class="p">,</span>
				      <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: cnfSupportedRates setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFBASICRATES</span><span class="p">,</span>
				      <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: cnfBasicRates setting to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CREATEIBSS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Create IBSS setting to 1 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">name_set</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">hostap_set_string</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNNAME</span><span class="p">,</span>
					 <span class="n">local</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_encryption</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: could not configure encryption</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">hostap_set_antsel</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_roaming</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: could not set host roaming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFENHSECURITY</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">enh_sec</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: cnfEnhSecurity setting to 0x%x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">enh_sec</span><span class="p">);</span>

	<span class="cm">/* 32-bit tallies were added in STA f/w 0.8.0, but they were apparently</span>
<span class="cm">	 * not working correctly (last seven counters report bogus values).</span>
<span class="cm">	 * This has been fixed in 0.8.2, so enable 32-bit tallies only</span>
<span class="cm">	 * beginning with that firmware version. Another bug fix for 32-bit</span>
<span class="cm">	 * tallies in 1.4.0; should 16-bit tallies be used for some other</span>
<span class="cm">	 * versions, too? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFTHIRTY2TALLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: cnfThirty2Tally setting &quot;</span>
			       <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tallies32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">tallies32</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">tallies32</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hostap_set_auth_algs</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_FRAGMENTATIONTHRESHOLD</span><span class="p">,</span>
			    <span class="n">local</span><span class="o">-&gt;</span><span class="n">fragm_threshold</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: setting FragmentationThreshold to %d &quot;</span>
		       <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">fragm_threshold</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_RTSTHRESHOLD</span><span class="p">,</span>
			    <span class="n">local</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: setting RTSThreshold to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">manual_retry_count</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFALTRETRYCOUNT</span><span class="p">,</span>
			    <span class="n">local</span><span class="o">-&gt;</span><span class="n">manual_retry_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: setting cnfAltRetryCount to %d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">manual_retry_count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hfa384x_get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFDBMADJUST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi_to_dBm</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">wpa</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hostap_set_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_SSNHANDLINGMODE</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: setting ssnHandlingMode to 1 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hfa384x_set_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_GENERICELEMENT</span><span class="p">,</span>
			    <span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: setting genericElement failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">fail:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">delay</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_FLOW</span><span class="p">,</span> <span class="s">&quot;prism2_hw_init()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_TRANSMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">);</span>

 <span class="nl">init:</span>
	<span class="cm">/* initialize HFA 384x */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">hfa384x_cmd_no_wait</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_INIT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: first command failed - assuming card &quot;</span>
		       <span class="s">&quot;does not have primary firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_CMD</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* EvStat has Cmd bit set in some cases, so retry once if no</span>
<span class="cm">		 * wait was needed */</span>
		<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_CMD</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: init command completed too quickly - &quot;</span>
		       <span class="s">&quot;retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">delay</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HFA384X_INIT_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_CMD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">delay</span><span class="p">))</span>
		<span class="n">yield</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_CMD</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: assuming no Primary image in &quot;</span>
		       <span class="s">&quot;flash - card initialization not completed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_info</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">no_pri</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sram_type</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">sram_type</span> <span class="o">=</span> <span class="n">prism2_get_ram_size</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">no_pri</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;prism2_hw_init: initialized in %lu ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_CMD</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hw_init2</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pda</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">no_pri</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">pda</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">pda</span> <span class="o">=</span> <span class="n">prism2_read_pda</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>

	<span class="n">hfa384x_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifndef final_version</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_MAGIC</span><span class="p">,</span> <span class="n">HFA384X_SWSUPPORT0_OFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_SWSUPPORT0_OFF</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HFA384X_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;SWSUPPORT0 write/read failed: %04X != %04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_SWSUPPORT0_OFF</span><span class="p">),</span> <span class="n">HFA384X_MAGIC</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initial</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">pri_only</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hfa384x_events_only_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* get card version information */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prism2_get_version_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_NICID</span><span class="p">,</span> <span class="s">&quot;NIC&quot;</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">prism2_get_version_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_PRIID</span><span class="p">,</span> <span class="s">&quot;PRI&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hfa384x_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">prism2_get_version_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_STAID</span><span class="p">,</span> <span class="s">&quot;STA&quot;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Failed to read STA f/w version &quot;</span>
			       <span class="s">&quot;- only Primary f/w present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">pri_only</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">pri_only</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hfa384x_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIX: could convert allocate_fid to use sleeping CmdCompl wait and</span>
<span class="cm">	 * enable interrupts before this. This would also require some sort of</span>
<span class="cm">	 * sleeping AllocEv waiting */</span>

	<span class="cm">/* allocate TX FIDs */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid_len</span> <span class="o">=</span> <span class="n">PRISM2_TXFID_LEN</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PRISM2_TXFID_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hfa384x_allocate_fid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid_len</span> <span class="o">&gt;</span> <span class="mi">1600</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hfa384x_allocate_fid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1600</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Using shorter TX FID &quot;</span>
				       <span class="s">&quot;(1600 bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid_len</span> <span class="o">=</span> <span class="mi">1600</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRISM2_TXFID_EMPTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hfa384x_events_only_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">initial</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">prism2_check_sta_fw_version</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_get_rid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFOWNMACADDR</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: could not get own MAC address</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostap_interfaces</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iface</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_interface</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ap</span><span class="p">)</span>
		<span class="n">prism2_check_sta_fw_version</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="n">prism2_setup_rids</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* MAC is now configured, but port 0 is not yet enabled */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">failed:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">no_pri</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hw_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">was_resetting</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">was_resetting</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_resetting</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_ENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: MAC port 0 enabling failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_reset_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_resetting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hfa384x_enable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* at least D-Link DWL-650 seems to require additional port reset</span>
<span class="cm">	 * before it starts acting as an AP, so reset port automatically</span>
<span class="cm">	 * here just in case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">initial</span> <span class="o">&amp;&amp;</span> <span class="n">prism2_reset_port</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: MAC port 0 resetting failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_resetting</span> <span class="o">&amp;&amp;</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* If hw_reset() was called during pending transmit, netif</span>
<span class="cm">		 * queue was stopped. Wake it up now since the wlan card has</span>
<span class="cm">		 * been resetted. */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hw_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">initial</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_downloading</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prism2_hw_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">initial</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">no_pri</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prism2_hw_init2</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">initial</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Enable firmware if secondary image is loaded and at least one of the</span>
<span class="cm">	 * netdevices is up. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pri_only</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">initial</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">initial</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">num_dev_open</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span><span class="p">)</span>
			<span class="n">prism2_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">PRISM2_CALLBACK_ENABLE</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">prism2_hw_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">initial</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_hw_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">no_disable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* Allow only command completion events during disable */</span>
	<span class="n">hfa384x_events_only_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span><span class="p">)</span>
		<span class="n">prism2_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">PRISM2_CALLBACK_DISABLE</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: card already removed or not configured &quot;</span>
		       <span class="s">&quot;during shutdown</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">no_disable</span> <span class="o">&amp;</span> <span class="n">HOSTAP_HW_NO_DISABLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hfa384x_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_DISABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Shutdown failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">);</span>

	<span class="n">hfa384x_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_disable</span> <span class="o">&amp;</span> <span class="n">HOSTAP_HW_ENABLE_CMDCOMPL</span><span class="p">)</span>
		<span class="n">hfa384x_events_only_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">prism2_clear_cmd_queue</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	static long last_reset = 0;</span>

<span class="c">	/* do not reset card more than once per second to avoid ending up in a</span>
<span class="c">	 * busy loop resetting the card */</span>
<span class="c">	if (time_before_eq(jiffies, last_reset + HZ))</span>
<span class="c">		return;</span>
<span class="c">	last_reset = jiffies;</span>
<span class="cp">#endif</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: driver bug - prism2_hw_reset() called &quot;</span>
		       <span class="s">&quot;in interrupt context</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_downloading</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_resetting</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s: already resetting card - &quot;</span>
		       <span class="s">&quot;ignoring reset request</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_reset_tries</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_reset_tries</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: too many reset tries, skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: %s: resetting card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">hfa384x_disable_interrupts</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_resetting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cor_sreset</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Host system seems to hang in some cases with high traffic</span>
<span class="cm">		 * load or shared interrupts during COR sreset. Disable shared</span>
<span class="cm">		 * interrupts during reset to avoid these crashes. COS sreset</span>
<span class="cm">		 * takes quite a long time, so it is unfortunate that this</span>
<span class="cm">		 * seems to be needed. Anyway, I do not know of any better way</span>
<span class="cm">		 * of avoiding the crash. */</span>
		<span class="n">disable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cor_sreset</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">prism2_hw_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">prism2_hw_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_resetting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_pri</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: persistent download of primary &quot;</span>
		       <span class="s">&quot;firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prism2_download_genesis</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_pri</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: download (PRI) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_sec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: persistent download of secondary &quot;</span>
		       <span class="s">&quot;firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">prism2_download_volatile</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_sec</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: download (SEC) failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>

	<span class="cm">/* TODO: restore beacon TIM bits for STAs that have buffered frames */</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_schedule_reset</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as scheduled task after noticing card timeout in interrupt</span>
<span class="cm"> * context */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_reset_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">local_info_t</span><span class="p">,</span> <span class="n">reset_queue</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: scheduled card reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">prism2_hw_reset</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PRISM2_TXFID_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">PRISM2_TXFID_EMPTY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;prism2_tx_timeout: &quot;</span>
				       <span class="s">&quot;wake up queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_get_txfid_idx</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">next_txfid</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">PRISM2_TXFID_EMPTY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRISM2_TXFID_RESERVED</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">PRISM2_TXFID_COUNT</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">end</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA2</span><span class="p">,</span> <span class="s">&quot;prism2_get_txfid_idx: no room in txfid buf: &quot;</span>
	       <span class="s">&quot;packet dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only from hardware IRQ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_transmit_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">long</span> <span class="n">context</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">resp0</span><span class="p">,</span> <span class="n">u16</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">context</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_transmit_cb - res=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">PRISM2_TXFID_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_transmit_cb called with invalid &quot;</span>
		       <span class="s">&quot;idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_TRANSMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: driver bug: prism2_transmit_cb called &quot;</span>
		       <span class="s">&quot;with no pending transmit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* ready for next TX, so wake up queue that was stopped in</span>
<span class="cm">		 * prism2_transmit() */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">);</span>

	<span class="cm">/* With reclaim, Resp0 contains new txfid for transmit; the old txfid</span>
<span class="cm">	 * will be automatically allocated for the next TX frame */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">resp0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_FID</span><span class="p">,</span> <span class="s">&quot;%s: prism2_transmit_cb: txfid[%d]=0x%04x, &quot;</span>
	       <span class="s">&quot;resp0=0x%04x, transmit_txfid=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
	       <span class="n">resp0</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">next_txfid</span><span class="p">]);</span>

	<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">PRISM2_TXFID_COUNT</span><span class="p">)</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">next_txfid</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* check if all TX buffers are occupied */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">PRISM2_TXFID_EMPTY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">PRISM2_TXFID_COUNT</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">next_txfid</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">);</span>

	<span class="cm">/* no empty TX buffers, stop queue */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only from software IRQ if PCI bus master is not used (with bus master</span>
<span class="cm"> * this can be called both from software and hardware IRQ) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* The driver tries to stop netif queue so that there would not be</span>
<span class="cm">	 * more than one attempt to transmit frames going on; check that this</span>
<span class="cm">	 * is really the case */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_TRANSMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: driver bug - prism2_transmit() called &quot;</span>
		       <span class="s">&quot;when previous TX was pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* stop the queue for the time that transmit is pending */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* transmit packet */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_cmd_callback</span><span class="p">(</span>
		<span class="n">dev</span><span class="p">,</span>
		<span class="n">HFA384X_CMDCODE_TRANSMIT</span> <span class="o">|</span> <span class="n">HFA384X_CMD_TX_RECLAIM</span><span class="p">,</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
		<span class="n">prism2_transmit_cb</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span> <span class="n">idx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_transmit: CMDCODE_TRANSMIT &quot;</span>
		       <span class="s">&quot;failed (res=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Since we did not wait for command completion, the card continues</span>
<span class="cm">	 * to process on the background and we will finish handling when</span>
<span class="cm">	 * command completion event is handled (prism2_cmd_ev() function) */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Send IEEE 802.11 frame (convert the header into Prism2 TX descriptor and</span>
<span class="cm"> * send the payload with this descriptor) */</span>
<span class="cm">/* Called only from software IRQ */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_tx_80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_tx_frame</span> <span class="n">txdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="n">meta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">data_len</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tx_control</span><span class="p">,</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">prism2_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">PRISM2_CALLBACK_TX_START</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_downloading</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">pri_only</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_tx_80211: hw not ready -&quot;</span>
			       <span class="s">&quot; skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txdesc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txdesc</span><span class="p">));</span>

	<span class="cm">/* skb-&gt;data starts with txdesc-&gt;frame_control */</span>
	<span class="n">hdr_len</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>
 	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Addr4 */</span>
		<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">txdesc</span><span class="p">.</span><span class="n">addr4</span><span class="p">,</span>
						 <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">hdr_len</span> <span class="o">+=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_control</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_control</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">tx_cb_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_control</span> <span class="o">|=</span> <span class="n">HFA384X_TX_CTRL_TX_OK</span><span class="p">;</span>
		<span class="n">txdesc</span><span class="p">.</span><span class="n">sw_support</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">tx_cb_idx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">txdesc</span><span class="p">.</span><span class="n">tx_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx_control</span><span class="p">);</span>
	<span class="n">txdesc</span><span class="p">.</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>

	<span class="n">data_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">txdesc</span><span class="p">.</span><span class="n">data_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">txdesc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">data_len</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">prism2_get_txfid_idx</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frame_dump</span> <span class="o">&amp;</span> <span class="n">PRISM2_DUMP_TX_HDR</span><span class="p">)</span>
		<span class="n">hostap_dump_tx_header</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_setup_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_to_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txdesc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_to_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span>
				     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">prism2_transmit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_tx_80211 - to BAP0 failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRISM2_TXFID_EMPTY</span><span class="p">;</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">prism2_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">PRISM2_CALLBACK_TX_END</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Some SMP systems have reported number of odd errors with hostap_pci. fid</span>
<span class="cm"> * register has changed values between consecutive reads for an unknown reason.</span>
<span class="cm"> * This should really not happen, so more debugging is needed. This test</span>
<span class="cm"> * version is a bit slower, but it will detect most of such register changes</span>
<span class="cm"> * and will try to get the correct fid eventually. */</span>
<span class="cp">#define EXTRA_FID_READ_TESTS</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">prism2_read_fid_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef EXTRA_FID_READ_TESTS</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val3</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">val2</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
		<span class="n">val3</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">val2</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">==</span> <span class="n">val3</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: detected fid change (try=%d, reg=%04x):&quot;</span>
		       <span class="s">&quot; %04x %04x %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="n">val2</span> <span class="o">||</span> <span class="n">val</span> <span class="o">==</span> <span class="n">val3</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">val</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val2</span> <span class="o">==</span> <span class="n">val3</span> <span class="o">&amp;&amp;</span> <span class="n">val2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">val2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Uhhuh.. could not read good fid from reg &quot;</span>
	       <span class="s">&quot;%04x (%04x %04x %04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val3</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="cp">#else </span><span class="cm">/* EXTRA_FID_READ_TESTS */</span><span class="cp"></span>
	<span class="k">return</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* EXTRA_FID_READ_TESTS */</span><span class="cp"></span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_rx</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">rx_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">rxfid</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">macport</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_rx_frame</span> <span class="n">rxdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">prism2_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">PRISM2_CALLBACK_RX_START</span><span class="p">);</span>

	<span class="n">rxfid</span> <span class="o">=</span> <span class="n">prism2_read_fid_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RXFID_OFF</span><span class="p">);</span>
<span class="cp">#ifndef final_version</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxfid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxfid</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_RXFID_OFF</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;prism2_rx: rxfid=0 (next 0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rxfid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxfid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* try to continue with the new rxfid value */</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_setup_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">rxfid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_from_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxdesc</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: copy from BAP0 failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">res</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxdesc</span><span class="p">.</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxdesc</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxdesc</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="n">macport</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">;</span>

	<span class="cm">/* Drop frames with too large reported payload length. Monitor mode</span>
<span class="cm">	 * seems to sometimes pass frames (e.g., ctrl::ack) with signed and</span>
<span class="cm">	 * negative value, so allow also values 65522 .. 65534 (-14 .. -2) for</span>
<span class="cm">	 * macport 7 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PRISM2_DATA_MAXLEN</span> <span class="o">+</span> <span class="mi">8</span> <span class="cm">/* WEP */</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">macport</span> <span class="o">==</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">-</span><span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdr_len</span> <span class="o">-=</span> <span class="mi">65535</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>
				<span class="n">hdr_len</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Received frame with invalid &quot;</span>
			       <span class="s">&quot;length 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">hostap_dump_rx_header</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX failed to allocate skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rxdesc</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_from_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX failed to read &quot;</span>
		       <span class="s">&quot;frame data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">);</span>

 <span class="nl">rx_exit:</span>
	<span class="n">prism2_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">PRISM2_CALLBACK_RX_END</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_RX</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>

 <span class="nl">rx_dropped:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_rx_skb</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfa384x_rx_frame</span> <span class="o">*</span><span class="n">rxdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">rx_hdrlen</span><span class="p">;</span>

	<span class="n">rx_hdrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxdesc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxdesc</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Allow monitor mode to receive shorter frames */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span> <span class="o">&amp;&amp;</span>
		    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxdesc</span><span class="p">)</span> <span class="o">-</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rx_hdrlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rxdesc</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hfa384x_rx_frame</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frame_dump</span> <span class="o">&amp;</span> <span class="n">PRISM2_DUMP_RX_HDR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxdesc</span><span class="p">))</span>
		<span class="n">hostap_dump_rx_header</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rxdesc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">HFA384X_RX_STATUS_FCSERR</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_allow_fcserr</span> <span class="o">||</span>
	     <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">PRISM2_DATA_MAXLEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX: len(%d) &gt; MAX(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PRISM2_DATA_MAXLEN</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">stats</span><span class="p">.</span><span class="n">mac_time</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">time</span><span class="p">);</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">-</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi_to_dBm</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">silence</span> <span class="o">-</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi_to_dBm</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* Convert Prism2 RX structure into IEEE 802.11 header */</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">&gt;</span> <span class="n">rx_hdrlen</span><span class="p">)</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">rx_hdrlen</span><span class="p">;</span>

	<span class="n">memmove</span><span class="p">(</span><span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">rx_hdrlen</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">rxdesc</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>

	<span class="n">hostap_80211_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">drop:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_rx_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hostap_rx_skb</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only from hardware IRQ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_alloc_ev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fid</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">fid</span> <span class="o">=</span> <span class="n">prism2_read_fid_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_ALLOCFID_OFF</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_FID</span><span class="p">,</span> <span class="s">&quot;FID: interrupt: ALLOC - fid=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">next_alloc</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">fid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_FID</span><span class="p">,</span> <span class="s">&quot;FID: found matching txfid[%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">idx</span><span class="p">);</span>

<span class="cp">#ifndef final_version</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">PRISM2_TXFID_EMPTY</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Already released txfid found at idx &quot;</span>
				       <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">PRISM2_TXFID_RESERVED</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Already reserved txfid found at idx &quot;</span>
				       <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">PRISM2_TXFID_EMPTY</span><span class="p">;</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">next_alloc</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">PRISM2_TXFID_COUNT</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
				<span class="n">idx</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_TRANSMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">PRISM2_TXFID_COUNT</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">next_alloc</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: could not find matching txfid (0x%04x, new &quot;</span>
	       <span class="s">&quot;read 0x%04x) for alloc event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span>
	       <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_ALLOCFID_OFF</span><span class="p">));</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;TXFIDs:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">PRISM2_TXFID_COUNT</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %04x[%04x]&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">txfid</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">intransmitfid</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">);</span>

	<span class="cm">/* FIX: should probably schedule reset; reference to one txfid was lost</span>
<span class="cm">	 * completely.. Bad things will happen if we run out of txfids</span>
<span class="cm">	 * Actually, this will cause netdev watchdog to notice TX timeout and</span>
<span class="cm">	 * then card reset after all txfids have been leaked. */</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_tx_callback</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">hfa384x_tx_frame</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ok</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sw_support</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_tx_callback_info</span> <span class="o">*</span><span class="n">cb</span><span class="p">;</span>

	<span class="cm">/* Make sure that frame was from us. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TX callback - foreign frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sw_support</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">sw_support</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">cb</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_callback</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">cb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">!=</span> <span class="n">sw_support</span><span class="p">)</span>
		<span class="n">cb</span> <span class="o">=</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: could not find TX callback (idx %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sw_support</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hostap_tx_callback failed to allocate &quot;</span>
		       <span class="s">&quot;skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">payload</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">cb</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ok</span><span class="p">,</span> <span class="n">cb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">hostap_tx_compl_read</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">hfa384x_tx_frame</span> <span class="o">*</span><span class="n">txdesc</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">**</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fid</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">fid</span> <span class="o">=</span> <span class="n">prism2_read_fid_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_TXCOMPLFID_OFF</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_FID</span><span class="p">,</span> <span class="s">&quot;interrupt: TX (err=%d) - fid=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_setup_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_from_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">txdesc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txdesc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;%s: TX (err=%d) - fid=0x%04x - could not &quot;</span>
		       <span class="s">&quot;read txdesc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">fid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">sw_support</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">data_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">PRISM2_DATA_MAXLEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">payload</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">hfa384x_from_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;%s: could not read TX &quot;</span>
				       <span class="s">&quot;frame payload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">kfree</span><span class="p">(</span><span class="o">*</span><span class="n">payload</span><span class="p">);</span>
				<span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">fail:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_tx_ev</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_tx_frame</span> <span class="n">txdesc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_tx_compl_read</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frame_dump</span> <span class="o">&amp;</span> <span class="n">PRISM2_DUMP_TX_HDR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;%s: TX - status=0x%04x &quot;</span>
		       <span class="s">&quot;retry_count=%d tx_rate=%d seq_ctrl=%d &quot;</span>
		       <span class="s">&quot;duration_id=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">status</span><span class="p">),</span>
		       <span class="n">txdesc</span><span class="p">.</span><span class="n">retry_count</span><span class="p">,</span> <span class="n">txdesc</span><span class="p">.</span><span class="n">tx_rate</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">seq_ctrl</span><span class="p">),</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">duration_id</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">sw_support</span><span class="p">)</span>
		<span class="n">hostap_tx_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>

 <span class="nl">fail:</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_TX</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_sta_tx_exc_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_tx_exc_list</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hfa384x_tx_frame</span> <span class="o">*</span><span class="n">txdesc</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">hfa384x_tx_frame</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txdesc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Convert Prism2 RX structure into IEEE 802.11 header</span>
<span class="cm">			 */</span>
			<span class="kt">int</span> <span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
			<span class="n">memmove</span><span class="p">(</span><span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txdesc</span><span class="p">)</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">txdesc</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>

			<span class="n">hostap_handle_sta_tx_exc</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_txexc</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="n">fc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">show_dump</span><span class="p">,</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_tx_frame</span> <span class="n">txdesc</span><span class="p">;</span>

	<span class="n">show_dump</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">frame_dump</span> <span class="o">&amp;</span> <span class="n">PRISM2_DUMP_TXEXC_HDR</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">hostap_tx_compl_read</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payload</span><span class="p">);</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_TXEXC</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* We produce a TXDROP event only for retry or lifetime</span>
<span class="cm">	 * exceeded, because that&#39;s the only status that really mean</span>
<span class="cm">	 * that this particular node went away.</span>
<span class="cm">	 * Other errors means that *we* screwed up. - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">HFA384X_TX_STATUS_RETRYERR</span> <span class="o">|</span> <span class="n">HFA384X_TX_STATUS_AGEDERR</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

		<span class="cm">/* Copy 802.11 dest address. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">txdesc</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVTXDROP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">show_dump</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_REPEAT</span> <span class="o">||</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">wds_type</span> <span class="o">&amp;</span> <span class="n">HOSTAP_WDS_AP_CLIENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">txdesc</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txdesc</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">txdesc</span><span class="p">));</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_tx_exc_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_tx_exc_tasklet</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">sw_support</span><span class="p">)</span>
		<span class="n">hostap_tx_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txdesc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">payload</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">show_dump</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;%s: TXEXC - status=0x%04x (%s%s%s%s)&quot;</span>
	       <span class="s">&quot; tx_control=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span>
	       <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HFA384X_TX_STATUS_RETRYERR</span> <span class="o">?</span> <span class="s">&quot;[RetryErr]&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HFA384X_TX_STATUS_AGEDERR</span> <span class="o">?</span> <span class="s">&quot;[AgedErr]&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HFA384X_TX_STATUS_DISCON</span> <span class="o">?</span> <span class="s">&quot;[Discon]&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">status</span> <span class="o">&amp;</span> <span class="n">HFA384X_TX_STATUS_FORMERR</span> <span class="o">?</span> <span class="s">&quot;[FormErr]&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">tx_control</span><span class="p">));</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;   retry_count=%d tx_rate=%d fc=0x%04x &quot;</span>
	       <span class="s">&quot;(%s%s%s::%d%s%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">txdesc</span><span class="p">.</span><span class="n">retry_count</span><span class="p">,</span> <span class="n">txdesc</span><span class="p">.</span><span class="n">tx_rate</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span>
	       <span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Mgmt&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Ctrl&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Data&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_STYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
	       <span class="n">ieee80211_has_tods</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; ToDS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">ieee80211_has_fromds</span><span class="p">(</span><span class="n">txdesc</span><span class="p">.</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; FromDS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;   A1=%pM A2=%pM A3=%pM A4=%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">txdesc</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">txdesc</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span>
	       <span class="n">txdesc</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">txdesc</span><span class="p">.</span><span class="n">addr4</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_info_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">info_list</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hostap_info_process</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_info</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hfa384x_info_frame</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">fid</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_INFOFID_OFF</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_setup_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">hfa384x_from_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Could not get info frame (fid=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">len</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x8000</span><span class="p">)</span> <span class="o">||</span> <span class="n">info</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="mi">2060</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* data register seems to give 0x8000 in some error cases even</span>
<span class="cm">		 * though busy bit is not set in offset register;</span>
<span class="cm">		 * in addition, length must be at least 1 due to type field */</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Received info frame with invalid &quot;</span>
		       <span class="s">&quot;length 0x%04x (type 0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">len</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">+</span> <span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Could not allocate skb for info &quot;</span>
		       <span class="s">&quot;frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">)),</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">hfa384x_from_bap</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">left</span><span class="p">),</span> <span class="n">left</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Info frame read failed (fid=0x%04x, &quot;</span>
		       <span class="s">&quot;len=0x%04x, type=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">len</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">));</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">info_list</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">info_tasklet</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_INFO</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_bap_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frames</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_BAP_TASKLET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">);</span>

	<span class="cm">/* Process all pending BAP events without generating new interrupts</span>
<span class="cm">	 * for them */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">frames</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">==</span> <span class="mh">0xffff</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_BAP0_EVENTS</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_RX</span><span class="p">)</span>
			<span class="n">prism2_rx</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_INFO</span><span class="p">)</span>
			<span class="n">prism2_info</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_TX</span><span class="p">)</span>
			<span class="n">prism2_tx_ev</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_TXEXC</span><span class="p">)</span>
			<span class="n">prism2_txexc</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_BAP_TASKLET2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_BAP_TASKLET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">);</span>

	<span class="cm">/* Enable interrupts for new BAP events */</span>
	<span class="n">hfa384x_events_all</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_BAP_TASKLET2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only from hardware IRQ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_infdrop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_inquire</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;%s: INFDROP event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* some firmware versions seem to get stuck with</span>
<span class="cm">	 * full CommTallies in high traffic load cases; every</span>
<span class="cm">	 * packet will then cause INFDROP event and CommTallies</span>
<span class="cm">	 * info frame will not be sent automatically. Try to</span>
<span class="cm">	 * get out of this state by inquiring CommTallies. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">last_inquire</span> <span class="o">||</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">last_inquire</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hfa384x_cmd_callback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_INQUIRE</span><span class="p">,</span>
				     <span class="n">HFA384X_INFO_COMMTALLIES</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">last_inquire</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only from hardware IRQ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_ev_tick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">evstat</span><span class="p">,</span> <span class="n">inten</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">prev_stuck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_tick_timer</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_tick_timer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">evstat</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">);</span>
		<span class="n">inten</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_INTEN_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">prev_stuck</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: SW TICK stuck? &quot;</span>
			       <span class="s">&quot;bits=0x%lx EvStat=%04x IntEn=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">,</span> <span class="n">evstat</span><span class="p">,</span> <span class="n">inten</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">sw_tick_stuck</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">evstat</span> <span class="o">&amp;</span> <span class="n">HFA384X_BAP0_EVENTS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">inten</span> <span class="o">&amp;</span> <span class="n">HFA384X_BAP0_EVENTS</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: trying to recover from IRQ &quot;</span>
			       <span class="s">&quot;hang</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hfa384x_events_no_bap0</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">prev_stuck</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">prev_stuck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only from hardware IRQ */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_check_magic</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* at least PCI Prism2.5 with bus mastering seems to sometimes</span>
<span class="cm">	 * return 0x0000 in SWSUPPORT0 for unknown reason, but re-reading the</span>
<span class="cm">	 * register once or twice seems to get the correct value.. PCI cards</span>
<span class="cm">	 * cannot anyway be removed during normal operation, so there is not</span>
<span class="cm">	 * really any need for this verification with them. */</span>

<span class="cp">#ifndef PRISM2_PCI</span>
<span class="cp">#ifndef final_version</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_magic_err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_SWSUPPORT0_OFF</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HFA384X_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_ready</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">last_magic_err</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Interrupt, but SWSUPPORT0 does not match: &quot;</span>
			       <span class="s">&quot;%04X != %04X - card removed?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_SWSUPPORT0_OFF</span><span class="p">),</span>
			       <span class="n">HFA384X_MAGIC</span><span class="p">);</span>
			<span class="n">last_magic_err</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: interrupt - SWSUPPORT0=%04x &quot;</span>
			       <span class="s">&quot;MAGIC=%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_SWSUPPORT0_OFF</span><span class="p">),</span>
			       <span class="n">HFA384X_MAGIC</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_SWSUPPORT0_OFF</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* final_version */</span><span class="cp"></span>
<span class="cp">#endif </span><span class="cm">/* !PRISM2_PCI */</span><span class="cp"></span>
<span class="p">}</span>


<span class="cm">/* Called only from hardware IRQ */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">prism2_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ev</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* Detect early interrupt before driver is fully configured */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">irq_init_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Interrupt, but dev not configured</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">irq_init_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">irq_init_lock</span><span class="p">);</span>

	<span class="n">prism2_io_debug_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PRISM2_IO_DEBUG_CMD_INTERRUPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">card_present</span><span class="p">(</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Interrupt, but dev not OK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prism2_check_magic</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">ev</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_interrupt: ev=0xffff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ev</span> <span class="o">&amp;=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_INTEN_OFF</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_CMD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prism2_cmd_ev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Above events are needed even before hw is ready, but other</span>
<span class="cm">		 * events should be skipped during initialization. This may</span>
<span class="cm">		 * change for AllocEv if allocate_fid is implemented without</span>
<span class="cm">		 * busy waiting. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_resetting</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ev</span> <span class="o">=</span> <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_CMD</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">next_event</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EVENT_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">HFA384X_EV_TICK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_interrupt: hw &quot;</span>
				       <span class="s">&quot;not ready; skipping events 0x%04x &quot;</span>
				       <span class="s">&quot;(IntEn=0x%04x)%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ev</span><span class="p">,</span>
				       <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_INTEN_OFF</span><span class="p">),</span>
				       <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">?</span> <span class="s">&quot; (!hw_ready)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				       <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_resetting</span> <span class="o">?</span>
				       <span class="s">&quot; (hw_resetting)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				       <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span> <span class="o">?</span>
				       <span class="s">&quot; (!dev_enabled)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_TICK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prism2_ev_tick</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_TICK</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_ALLOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prism2_alloc_ev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_ALLOC</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Reading data from the card is quite time consuming, so do it</span>
<span class="cm">		 * in tasklets. TX, TXEXC, RX, and INFO events will be ACKed</span>
<span class="cm">		 * and unmasked after needed data has been read completely. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_BAP0_EVENTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hfa384x_events_no_bap0</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bap_tasklet</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cp">#ifndef final_version</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_WTERR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;%s: WTERR event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_WTERR</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* final_version */</span><span class="cp"></span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ev</span> <span class="o">&amp;</span> <span class="n">HFA384X_EV_INFDROP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prism2_infdrop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">HFA384X_OUTW</span><span class="p">(</span><span class="n">HFA384X_EV_INFDROP</span><span class="p">,</span> <span class="n">HFA384X_EVACK_OFF</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="nl">next_event:</span>
		<span class="n">events</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&gt;=</span> <span class="n">PRISM2_MAX_INTERRUPT_EVENTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;prism2_interrupt: &gt;%d events &quot;</span>
			       <span class="s">&quot;(EvStat=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">PRISM2_MAX_INTERRUPT_EVENTS</span><span class="p">,</span>
			       <span class="n">HFA384X_INW</span><span class="p">(</span><span class="n">HFA384X_EVSTAT_OFF</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">prism2_io_debug_add</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PRISM2_IO_DEBUG_CMD_INTERRUPT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">events</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_check_sta_fw_version</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hfa384x_comp_ident</span> <span class="n">comp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">variant</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_get_rid</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_STAID</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">comp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">comp</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">HFA384X_COMP_ID_STA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">HFA384X_COMP_ID_FW_AP</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_ap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">major</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">major</span><span class="p">);</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">variant</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="n">comp</span><span class="p">.</span><span class="n">variant</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">variant</span><span class="p">);</span>

	<span class="cm">/* Station firmware versions before 1.4.x seem to have a bug in</span>
<span class="cm">	 * firmware-based WEP encryption when using Host AP mode, so use</span>
<span class="cm">	 * host_encrypt as a default for them. Firmware version 1.4.9 is the</span>
<span class="cm">	 * first one that has been seen to produce correct encryption, but the</span>
<span class="cm">	 * bug might be fixed before that (although, at least 1.4.2 is broken).</span>
<span class="cm">	 */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_encrypt_ok</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">9</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_encrypt_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: defaulting to host-based encryption as &quot;</span>
		       <span class="s">&quot;a workaround for firmware bug in Host AP mode WEP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">host_encrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* IEEE 802.11 standard compliant WDS frames (4 addresses) were broken</span>
<span class="cm">	 * in station firmware versions before 1.5.x. With these versions, the</span>
<span class="cm">	 * driver uses a workaround with bogus frame format (4th address after</span>
<span class="cm">	 * the payload). This is not compatible with other AP devices. Since</span>
<span class="cm">	 * the firmware bug is fixed in the latest station firmware versions,</span>
<span class="cm">	 * automatically enable standard compliant mode for cards using station</span>
<span class="cm">	 * firmware version 1.5.0 or newer. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wds_type</span> <span class="o">|=</span> <span class="n">HOSTAP_WDS_STANDARD_FRAME</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: defaulting to bogus WDS frame as a &quot;</span>
		       <span class="s">&quot;workaround for firmware bug in Host AP mode WDS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hostap_check_sta_fw_version</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_fw_ver</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_passive_scan</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_interval</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_state</span> <span class="o">==</span> <span class="n">PASSIVE_SCAN_LISTEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

		<span class="cm">/* Even though host system does not really know when the WLAN</span>
<span class="cm">		 * MAC is sending frames, try to avoid changing channels for</span>
<span class="cm">		 * passive scanning when a host-generated frame is being</span>
<span class="cm">		 * transmitted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">HOSTAP_BITS_TRANSMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bits</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: passive scan detected pending &quot;</span>
			       <span class="s">&quot;TX - delaying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_channel</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">)</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">max_tries</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel_mask</span> <span class="o">&amp;</span>
			   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">&amp;&amp;</span>
			 <span class="n">max_tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">max_tries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: no allowed passive scan channels&quot;</span>
			       <span class="s">&quot; found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: passive scan channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_channel</span><span class="p">);</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_channel</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_state</span> <span class="o">=</span> <span class="n">PASSIVE_SCAN_WAIT</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_state</span> <span class="o">=</span> <span class="n">PASSIVE_SCAN_LISTEN</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_interval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hfa384x_cmd_callback</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_TEST</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">HFA384X_TEST_CHANGE_CHANNEL</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">),</span>
				 <span class="n">chan</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: passive scan channel set %d &quot;</span>
		       <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>

	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task when communications quality values should</span>
<span class="cm"> * be updated. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_comms_qual_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">local_info_t</span><span class="p">,</span> <span class="n">comms_qual_update</span><span class="p">);</span>
	<span class="n">prism2_update_comms_qual</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Software watchdog - called as a timer. Hardware interrupt (Tick event) is</span>
<span class="cm"> * used to monitor that local-&gt;last_tick_timer is being updated. If not,</span>
<span class="cm"> * interrupt busy-loop is assumed and driver tries to recover by masking out</span>
<span class="cm"> * some events. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_tick_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_inquire</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">last_tick_timer</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="cm">/* Inquire CommTallies every 10 seconds to keep the statistics updated</span>
<span class="cm">	 * more often during low load and when using 32-bit tallies. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">last_inquire</span> <span class="o">||</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">last_inquire</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_downloading</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_resetting</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hfa384x_cmd_callback</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_CMDCODE_INQUIRE</span><span class="p">,</span>
				     <span class="n">HFA384X_INFO_COMMTALLIES</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">last_inquire</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">last_comms_qual_update</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	     <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">last_comms_qual_update</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span>
	     <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">comms_qual_update</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_PROCFS_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_registers_proc_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#define SHOW_REG(n) \</span>
<span class="cp">p += sprintf(p, #n &quot;=%04x\n&quot;, hfa384x_read_reg(local-&gt;dev, HFA384X_##n##_OFF))</span>

	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">CMD</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PARAM0</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PARAM1</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PARAM2</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">STATUS</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">RESP0</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">RESP1</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">RESP2</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">INFOFID</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">CONTROL</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">SELECT0</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">SELECT1</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">OFFSET0</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">OFFSET1</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">RXFID</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">ALLOCFID</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">TXCOMPLFID</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">SWSUPPORT0</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">SWSUPPORT1</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">SWSUPPORT2</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">EVSTAT</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">INTEN</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">EVACK</span><span class="p">);</span>
	<span class="cm">/* Do not read data registers, because they change the state of the</span>
<span class="cm">	 * MAC (offset += 2) */</span>
	<span class="cm">/* SHOW_REG(DATA0); */</span>
	<span class="cm">/* SHOW_REG(DATA1); */</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">AUXPAGE</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">AUXOFFSET</span><span class="p">);</span>
	<span class="cm">/* SHOW_REG(AUXDATA); */</span>
<span class="cp">#ifdef PRISM2_PCI</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCICOR</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCIHCR</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_M0_ADDRH</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_M0_ADDRL</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_M0_LEN</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_M0_CTL</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_STATUS</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_M1_ADDRH</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_M1_ADDRL</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_M1_LEN</span><span class="p">);</span>
	<span class="n">SHOW_REG</span><span class="p">(</span><span class="n">PCI_M1_CTL</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_PCI */</span><span class="cp"></span>

	<span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_PROCFS_DEBUG */</span><span class="cp"></span>


<span class="k">struct</span> <span class="n">set_tim_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">aid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_set_tim</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">set_tim_data</span> <span class="o">*</span><span class="n">new_entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">new_entry</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">aid</span><span class="p">;</span>
	<span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">set_tim_data</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">set_tim_data</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">==</span> <span class="n">aid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span> <span class="s">&quot;%s: prism2_set_tim: aid=%d &quot;</span>
			       <span class="s">&quot;set=%d ==&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">set</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_entry</span><span class="p">);</span>
			<span class="n">new_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_list</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_lock</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_queue</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_set_tim_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">local_info_t</span><span class="p">,</span> <span class="n">set_tim_queue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">set_tim_data</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">set_tim_data</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span> <span class="s">&quot;%s: handle_set_tim_queue: aid=%d set=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">);</span>

		<span class="n">val</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_set_word</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">HFA384X_RID_CNFTIMCTRL</span><span class="p">,</span> <span class="n">val</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: set_tim failed (aid=%d &quot;</span>
			       <span class="s">&quot;set=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_clear_set_tim_queue</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">set_tim_data</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">set_tim_data</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * HostAP uses two layers of net devices, where the inner</span>
<span class="cm"> * layer gets called all the time from the outer layer.</span>
<span class="cm"> * This is a natural nesting, which needs a split lock type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">hostap_netdev_xmit_lock_key</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">lock_class_key</span> <span class="n">hostap_netdev_addr_lock_key</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_set_lockdep_class_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">netdev_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
					 <span class="kt">void</span> <span class="o">*</span><span class="n">_unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_set_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">_xmit_lock</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">hostap_netdev_xmit_lock_key</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_set_lockdep_class</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_set_class</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_list_lock</span><span class="p">,</span>
			  <span class="o">&amp;</span><span class="n">hostap_netdev_addr_lock_key</span><span class="p">);</span>
	<span class="n">netdev_for_each_tx_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">prism2_set_lockdep_class_one</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span>
<span class="nf">prism2_init_local_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">prism2_helper_functions</span> <span class="o">*</span><span class="n">funcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card_idx</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">sdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">local_info</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">funcs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">dev_template</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">IFNAMSIZ</span> <span class="o">||</span> <span class="n">strstr</span><span class="p">(</span><span class="n">dev_template</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hostap: Invalid dev_template=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_template</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hostap_interface</span><span class="p">)</span> <span class="o">+</span>
		<span class="mi">3</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">local_info</span><span class="p">)</span> <span class="o">+</span>
		<span class="mi">3</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">local_info</span> <span class="o">*</span><span class="p">)</span> <span class="p">((((</span><span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">iface</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="p">)</span> <span class="p">((((</span><span class="kt">long</span><span class="p">)</span> <span class="p">(</span><span class="n">local</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">HOSTAP_INTERFACE_MASTER</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostap_interfaces</span><span class="p">);</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">hw_module</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>

<span class="cp">#ifdef PRISM2_IO_DEBUG</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">io_debug_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_IO_DEBUG */</span><span class="cp"></span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">funcs</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">hfa384x_cmd</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">read_regs</span> <span class="o">=</span> <span class="n">hfa384x_read_regs</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">get_rid</span> <span class="o">=</span> <span class="n">hfa384x_get_rid</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_rid</span> <span class="o">=</span> <span class="n">hfa384x_set_rid</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">hw_enable</span> <span class="o">=</span> <span class="n">prism2_hw_enable</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">hw_config</span> <span class="o">=</span> <span class="n">prism2_hw_config</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">hw_reset</span> <span class="o">=</span> <span class="n">prism2_hw_reset</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">hw_shutdown</span> <span class="o">=</span> <span class="n">prism2_hw_shutdown</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">reset_port</span> <span class="o">=</span> <span class="n">prism2_reset_port</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">schedule_reset</span> <span class="o">=</span> <span class="n">prism2_schedule_reset</span><span class="p">;</span>
<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">read_aux</span> <span class="o">=</span> <span class="n">prism2_download_aux_dump</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">download</span> <span class="o">=</span> <span class="n">prism2_download</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">=</span> <span class="n">prism2_tx_80211</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_tim</span> <span class="o">=</span> <span class="n">prism2_set_tim</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">need_tx_headroom</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* no need to add txdesc in</span>
<span class="cm">					    * skb-&gt;data (FIX: maybe for DMA bus</span>
<span class="cm">					    * mastering? */</span>

	<span class="n">local</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">mtu</span><span class="p">;</span>

	<span class="n">rwlock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iface_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">txfidlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmdlock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">baplock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">irq_init_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rid_bap_mtx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">card_idx</span> <span class="o">&gt;=</span> <span class="n">MAX_PARM_DEVICES</span><span class="p">)</span>
		<span class="n">card_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">card_idx</span> <span class="o">=</span> <span class="n">card_idx</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">essid</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">essid</span><span class="p">,</span>
	       <span class="n">len</span> <span class="o">&gt;</span> <span class="n">MAX_SSID_LEN</span> <span class="o">?</span> <span class="n">MAX_SSID_LEN</span> <span class="o">:</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">[</span><span class="n">MAX_SSID_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">GET_INT_PARM</span><span class="p">(</span><span class="n">iw_mode</span><span class="p">,</span> <span class="n">card_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">IW_MODE_REPEAT</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">i</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;prism2: Unknown iw_mode %d; using &quot;</span>
		       <span class="s">&quot;IW_MODE_MASTER</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">GET_INT_PARM</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="n">card_idx</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">GET_INT_PARM</span><span class="p">(</span><span class="n">beacon_int</span><span class="p">,</span> <span class="n">card_idx</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">GET_INT_PARM</span><span class="p">(</span><span class="n">dtim_period</span><span class="p">,</span> <span class="n">card_idx</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wds_max_connections</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">=</span> <span class="n">HFA384X_TX_CTRL_FLAGS</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">manual_retry_count</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">rts_threshold</span> <span class="o">=</span> <span class="mi">2347</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">fragm_threshold</span> <span class="o">=</span> <span class="mi">2346</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi_to_dBm</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> <span class="cm">/* default; to be overriden by</span>
<span class="cm">				   * cnfDbmAdjust, if available */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_algs</span> <span class="o">=</span> <span class="n">PRISM2_AUTH_OPEN</span> <span class="o">|</span> <span class="n">PRISM2_AUTH_SHARED_KEY</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">sram_type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">scan_channel_mask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">=</span> <span class="n">PRISM2_MONITOR_RADIOTAP</span><span class="p">;</span>

	<span class="cm">/* Initialize task queue structures */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">,</span> <span class="n">handle_reset_queue</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_multicast_list_queue</span><span class="p">,</span>
		  <span class="n">hostap_set_multicast_list_queue</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_queue</span><span class="p">,</span> <span class="n">handle_set_tim_queue</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_list</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_lock</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">comms_qual_update</span><span class="p">,</span> <span class="n">handle_comms_qual_update</span><span class="p">);</span>

	<span class="cm">/* Initialize tasklets for handling hardware IRQ related operations</span>
<span class="cm">	 * outside hw IRQ handler */</span>
<span class="cp">#define HOSTAP_TASKLET_INIT(q, f, d) \</span>
<span class="cp">do { memset((q), 0, sizeof(*(q))); (q)-&gt;func = (f); (q)-&gt;data = (d); } \</span>
<span class="cp">while (0)</span>
	<span class="n">HOSTAP_TASKLET_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bap_tasklet</span><span class="p">,</span> <span class="n">hostap_bap_tasklet</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>

	<span class="n">HOSTAP_TASKLET_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">info_tasklet</span><span class="p">,</span> <span class="n">hostap_info_tasklet</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>
	<span class="n">hostap_info_init</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="n">HOSTAP_TASKLET_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_tasklet</span><span class="p">,</span>
			    <span class="n">hostap_rx_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">);</span>

	<span class="n">HOSTAP_TASKLET_INIT</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_tx_exc_tasklet</span><span class="p">,</span>
			    <span class="n">hostap_sta_tx_exc_tasklet</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">local</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_tx_exc_list</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostscan_wq</span><span class="p">);</span>

	<span class="n">lib80211_crypt_info_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">hostap_passive_scan</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">local</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">hostap_tick_timer</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">);</span>

	<span class="n">hostap_setup_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">local</span><span class="p">,</span> <span class="n">HOSTAP_INTERFACE_MASTER</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_IEEE80211</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hostap_80211_ops</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">dev_alloc_name</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;wifi%d&quot;</span><span class="p">);</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">register_netdevice</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">prism2_set_lockdep_class</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: register netdevice failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev_info</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Registered netdevice %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_info</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hostap_init_data</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hostap_hw_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">local_info</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">ddev</span> <span class="o">=</span> <span class="n">hostap_add_interface</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">HOSTAP_INTERFACE_MAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">dev_template</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hostap_init_proc</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
<span class="cp">#ifndef PRISM2_NO_PROCFS_DEBUG</span>
		<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span>
				       <span class="n">prism2_registers_proc_read</span><span class="p">,</span> <span class="n">local</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_PROCFS_DEBUG */</span><span class="cp"></span>
		<span class="n">hostap_init_ap_proc</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_free_local_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_tx_callback_info</span> <span class="o">*</span><span class="n">tx_cb</span><span class="p">,</span> <span class="o">*</span><span class="n">tx_cb_prev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">local_info</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* Unregister all netdevs before freeing local data. */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostap_interfaces</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iface</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_interface</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HOSTAP_INTERFACE_MASTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* special handling for this interface below */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hostap_remove_interface</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">reset_queue</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_multicast_list_queue</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">set_tim_queue</span><span class="p">);</span>
<span class="cp">#ifndef PRISM2_NO_STATION_MODES</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">info_queue</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">comms_qual_update</span><span class="p">);</span>

	<span class="n">lib80211_crypt_info_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">passive_scan_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tick_timer</span><span class="p">);</span>

	<span class="n">prism2_clear_cmd_queue</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">info_list</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rx_list</span><span class="p">);</span>
	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sta_tx_exc_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev_enabled</span><span class="p">)</span>
		<span class="n">prism2_callback</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">PRISM2_CALLBACK_DISABLE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hostap_free_data</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>

<span class="cp">#ifndef PRISM2_NO_PROCFS_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;registers&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_PROCFS_DEBUG */</span><span class="cp"></span>
	<span class="n">hostap_remove_proc</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="n">tx_cb</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_callback</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tx_cb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_cb_prev</span> <span class="o">=</span> <span class="n">tx_cb</span><span class="p">;</span>
		<span class="n">tx_cb</span> <span class="o">=</span> <span class="n">tx_cb</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tx_cb_prev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">hostap_set_hostapd</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hostap_set_hostapd_sta</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PRISM2_FRAG_CACHE_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frag_cache</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frag_cache</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
	<span class="n">prism2_download_free_data</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_pri</span><span class="p">);</span>
	<span class="n">prism2_download_free_data</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dl_sec</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>

	<span class="n">prism2_clear_set_tim_queue</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span>
			<span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_bss_info</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">pda</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">last_scan_results</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">generic_elem</span><span class="p">);</span>

	<span class="n">free_netdev</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#if (defined(PRISM2_PCI) &amp;&amp; defined(CONFIG_PM)) || defined(PRISM2_PCCARD)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">local_info</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="cm">/* Send disconnect event, e.g., to trigger reassociation after resume</span>
<span class="cm">	 * if wpa_supplicant is used. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Disable hardware and firmware */</span>
	<span class="n">prism2_hw_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* (PRISM2_PCI &amp;&amp; CONFIG_PM) || PRISM2_PCCARD */</span><span class="cp"></span>


<span class="cm">/* These might at some point be compiled separately and used as separate</span>
<span class="cm"> * kernel modules or linked into one */</span>
<span class="cp">#ifdef PRISM2_DOWNLOAD_SUPPORT</span>
<span class="cp">#include &quot;hostap_download.c&quot;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_DOWNLOAD_SUPPORT */</span><span class="cp"></span>

<span class="cp">#ifdef PRISM2_CALLBACK</span>
<span class="cm">/* External hostap_callback.c file can be used to, e.g., blink activity led.</span>
<span class="cm"> * This can use platform specific code and must define prism2_callback()</span>
<span class="cm"> * function (if PRISM2_CALLBACK is not defined, these function calls are not</span>
<span class="cm"> * used. */</span>
<span class="cp">#include &quot;hostap_callback.c&quot;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_CALLBACK */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
