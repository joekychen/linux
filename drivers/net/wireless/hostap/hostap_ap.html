<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › hostap › hostap_ap.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hostap_ap.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intersil Prism2 driver with Host AP (software access point) support</span>
<span class="cm"> * Copyright (c) 2001-2002, SSH Communications Security Corp and Jouni Malinen</span>
<span class="cm"> * &lt;j@w1.fi&gt;</span>
<span class="cm"> * Copyright (c) 2002-2005, Jouni Malinen &lt;j@w1.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is to be included into hostap.c when S/W AP functionality is</span>
<span class="cm"> * compiled.</span>
<span class="cm"> *</span>
<span class="cm"> * AP:  FIX:</span>
<span class="cm"> * - if unicast Class 2 (assoc,reassoc,disassoc) frame received from</span>
<span class="cm"> *   unauthenticated STA, send deauth. frame (8802.11: 5.5)</span>
<span class="cm"> * - if unicast Class 3 (data with to/from DS,deauth,pspoll) frame received</span>
<span class="cm"> *   from authenticated, but unassoc STA, send disassoc frame (8802.11: 5.5)</span>
<span class="cm"> * - if unicast Class 3 received from unauthenticated STA, send deauth. frame</span>
<span class="cm"> *   (8802.11: 5.5)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/random.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>

<span class="cp">#include &quot;hostap_wlan.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;hostap_ap.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">other_ap_policy</span><span class="p">[</span><span class="n">MAX_PARM_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AP_OTHER_AP_SKIP_ALL</span><span class="p">,</span>
						 <span class="n">DEF_INTS</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">other_ap_policy</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">other_ap_policy</span><span class="p">,</span> <span class="s">&quot;Other AP beacon monitoring policy (0-3)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_max_inactivity</span><span class="p">[</span><span class="n">MAX_PARM_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">AP_MAX_INACTIVITY_SEC</span><span class="p">,</span>
						   <span class="n">DEF_INTS</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">ap_max_inactivity</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ap_max_inactivity</span><span class="p">,</span> <span class="s">&quot;AP timeout (in seconds) for station &quot;</span>
		 <span class="s">&quot;inactivity&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ap_bridge_packets</span><span class="p">[</span><span class="n">MAX_PARM_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="n">DEF_INTS</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">ap_bridge_packets</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ap_bridge_packets</span><span class="p">,</span> <span class="s">&quot;Bridge packets directly between &quot;</span>
		 <span class="s">&quot;stations&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">autom_ap_wds</span><span class="p">[</span><span class="n">MAX_PARM_DEVICES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">DEF_INTS</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">autom_ap_wds</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">autom_ap_wds</span><span class="p">,</span> <span class="s">&quot;Add WDS connections to other APs &quot;</span>
		 <span class="s">&quot;automatically&quot;</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">sta_info</span><span class="o">*</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sta</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_add_proc_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">handle_wds_oper_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">type_subtype</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">body_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_cb_idx</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


<span class="cp">#ifndef PRISM2_NO_PROCFS_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_debug_proc_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;BridgedUnicastFrames=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridged_unicast</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;BridgedMulticastFrames=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridged_multicast</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;max_inactivity=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;bridge_packets=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridge_packets</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;nullfunc_ack=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">nullfunc_ack</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;autom_ap_wds=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">autom_ap_wds</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;auth_algs=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_algs</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;tx_drop_nonassoc=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_drop_nonassoc</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_PROCFS_DEBUG */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_sta_hash_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">hnext</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_hash</span><span class="p">[</span><span class="n">STA_HASH</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)];</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_hash</span><span class="p">[</span><span class="n">STA_HASH</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_sta_hash_del</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_hash</span><span class="p">[</span><span class="n">STA_HASH</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_hash</span><span class="p">[</span><span class="n">STA_HASH</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)]</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">hnext</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hnext</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hnext</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span>
	       <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">hnext</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hnext</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">hnext</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">hnext</span><span class="o">-&gt;</span><span class="n">hnext</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;AP: could not remove STA %pM from hash table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_free_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">)</span>
		<span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%pM&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">deinit</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_purge</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">num_sta</span><span class="o">--</span><span class="p">;</span>
<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_aid</span><span class="p">[</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_set_tim</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="kt">int</span> <span class="n">aid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_tim</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">set_tim</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_event_new_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVREGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_event_expired_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVEXPIRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_handle_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">was_assoc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;ap_handle_timer() called with NULL data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">ap</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="n">was_assoc</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PERM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_AUTH</span><span class="p">))</span>
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* station activity detected; reset timeout state */</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">=</span> <span class="n">STA_NULLFUNC</span><span class="p">;</span>
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">==</span> <span class="n">STA_DISASSOC</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PENDING_POLL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* STA ACKed data nullfunc frame poll */</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">=</span> <span class="n">STA_NULLFUNC</span><span class="p">;</span>
		<span class="n">next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">next_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">next_time</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">=</span> <span class="n">STA_DEAUTH</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">==</span> <span class="n">STA_DEAUTH</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PERM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
		<span class="n">ap_sta_hash_del</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WLAN_STA_AUTH</span> <span class="o">|</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">==</span> <span class="n">STA_DISASSOC</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_STA_ASSOC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">was_assoc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
		<span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">==</span> <span class="n">STA_DEAUTH</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hostap_set_tim</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_STA_TIM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">autom_ap_wds</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: removing automatic WDS &quot;</span>
			       <span class="s">&quot;connection to AP %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">hostap_wds_link_oper</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">WDS_DEL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">==</span> <span class="n">STA_NULLFUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send data frame to poll STA and check whether this frame</span>
<span class="cm">		 * is ACKed */</span>
		<span class="cm">/* FIX: IEEE80211_STYPE_NULLFUNC would be more appropriate, but</span>
<span class="cm">		 * it is apparently not retried so TX Exc events are not</span>
<span class="cm">		 * received for it */</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_PENDING_POLL</span><span class="p">;</span>
		<span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span>
				 <span class="n">IEEE80211_STYPE_DATA</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_poll</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">deauth</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">==</span> <span class="n">STA_DEAUTH</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">resp</span><span class="p">;</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: sending %s info to STA %pM&quot;</span>
		       <span class="s">&quot;(last=%lu, jiffies=%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">deauth</span> <span class="o">?</span> <span class="s">&quot;deauthentication&quot;</span> <span class="o">:</span> <span class="s">&quot;disassociation&quot;</span><span class="p">,</span>
		       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

		<span class="n">resp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">deauth</span> <span class="o">?</span> <span class="n">WLAN_REASON_PREV_AUTH_NOT_VALID</span> <span class="o">:</span>
				   <span class="n">WLAN_REASON_DISASSOC_DUE_TO_INACTIVITY</span><span class="p">);</span>
		<span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
				 <span class="p">(</span><span class="n">deauth</span> <span class="o">?</span> <span class="n">IEEE80211_STYPE_DEAUTH</span> <span class="o">:</span>
				  <span class="n">IEEE80211_STYPE_DISASSOC</span><span class="p">),</span>
				 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">==</span> <span class="n">STA_DEAUTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PERM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: STA %pM&quot;</span>
			       <span class="s">&quot; would have been removed, &quot;</span>
			       <span class="s">&quot;but it has &#39;perm&#39; flag</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ap_free_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">==</span> <span class="n">STA_NULLFUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">=</span> <span class="n">STA_DISASSOC</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">AP_DISASSOC_DELAY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timeout_next</span> <span class="o">=</span> <span class="n">STA_DEAUTH</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">AP_DEAUTH_DELAY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">hostap_deauth_all_stas</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">resend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: Deauthenticate all stations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_PREV_AUTH_NOT_VALID</span><span class="p">);</span>

	<span class="cm">/* deauth message sent; try to resend it few times; the message is</span>
<span class="cm">	 * broadcast, so it may be delayed until next DTIM; there is not much</span>
<span class="cm">	 * else we can do at this point since the driver is going to be shut</span>
<span class="cm">	 * down */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
				 <span class="n">IEEE80211_STYPE_DEAUTH</span><span class="p">,</span>
				 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resend</span> <span class="o">||</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">num_sta</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_control_proc_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">policy_txt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">policy</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MAC_POLICY_OPEN</span>:
		<span class="n">policy_txt</span> <span class="o">=</span> <span class="s">&quot;open&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAC_POLICY_ALLOW</span>:
		<span class="n">policy_txt</span> <span class="o">=</span> <span class="s">&quot;allow&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MAC_POLICY_DENY</span>:
		<span class="n">policy_txt</span> <span class="o">=</span> <span class="s">&quot;deny&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">policy_txt</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;MAC policy: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">policy_txt</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;MAC entries: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">entries</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;MAC list:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">mac_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">page</span> <span class="o">&gt;</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">80</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;All entries did not fit one page.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">ap_control_add_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">mac_restrictions</span> <span class="o">*</span><span class="n">mac_restrictions</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">mac_entry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">);</span>
	<span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">entries</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">ap_control_del_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">mac_restrictions</span> <span class="o">*</span><span class="n">mac_restrictions</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mac_entry</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">entries</span><span class="o">--</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_control_mac_deny</span><span class="p">(</span><span class="k">struct</span> <span class="n">mac_restrictions</span> <span class="o">*</span><span class="n">mac_restrictions</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">==</span> <span class="n">MAC_POLICY_OPEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">==</span> <span class="n">MAC_POLICY_ALLOW</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">!</span><span class="n">found</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">found</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">ap_control_flush_macs</span><span class="p">(</span><span class="k">struct</span> <span class="n">mac_restrictions</span> <span class="o">*</span><span class="n">mac_restrictions</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mac_entry</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac_restrictions</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">ap_control_kick_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">resp</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap_sta_hash_del</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_PREV_AUTH_NOT_VALID</span><span class="p">);</span>
	<span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_DEAUTH</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">resp</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
		<span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="n">ap_free_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


<span class="kt">void</span> <span class="nf">ap_control_kickall</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">=</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">ap_sta_hash_del</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">)</span>
			<span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">ap_free_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>

<span class="cp">#define PROC_LIMIT (PAGE_SIZE - 80)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_ap_proc_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">PROC_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;# BSSID CHAN SIGNAL NOISE RATE SSID FLAGS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%pM %d %d %d %d &#39;&quot;</span><span class="p">,</span>
			     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span><span class="p">,</span>
			     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span>
					  <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">)</span> <span class="o">?</span>
					 <span class="s">&quot;%c&quot;</span> <span class="o">:</span> <span class="s">&quot;&lt;%02x&gt;&quot;</span><span class="p">),</span>
				     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_ESS</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot; [ESS]&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot; [IBSS]&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot; [WEP]&quot;</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">PROC_LIMIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hostap: ap proc did not fit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">page</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">page</span> <span class="o">-</span> <span class="n">off</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


<span class="kt">void</span> <span class="nf">hostap_check_sta_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_fw_ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_fw_ver</span> <span class="o">==</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;Using data::nullfunc ACK workaround - &quot;</span>
		       <span class="s">&quot;firmware upgrade recommended</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">nullfunc_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">nullfunc_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_fw_ver</span> <span class="o">==</span> <span class="n">PRISM2_FW_VER</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Warning: secondary station firmware &quot;</span>
		       <span class="s">&quot;version 1.4.2 does not seem to work in Host AP mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_ap_tx_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ok</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span> <span class="o">||</span> <span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pass the TX callback frame to the hostapd; use 802.11 header version</span>
<span class="cm">	 * 1 to indicate failure (no ACK) and 2 success (frame ACKed) */</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">IEEE80211_FCTL_VERS</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ok</span> <span class="o">?</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">));</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_ap_tx_cb_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ok</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">auth_alg</span><span class="p">,</span> <span class="n">auth_transaction</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">txt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_auth</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hostap_ap_tx_cb_auth received invalid &quot;</span>
		       <span class="s">&quot;frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">);</span>
	<span class="n">auth_alg</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">);</span>
	<span class="n">auth_transaction</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;frame was not ACKed&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;STA not found&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WLAN_STATUS_SUCCESS</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">auth_alg</span> <span class="o">==</span> <span class="n">WLAN_AUTH_OPEN</span> <span class="o">&amp;&amp;</span> <span class="n">auth_transaction</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">auth_alg</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span> <span class="o">&amp;&amp;</span> <span class="n">auth_transaction</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;STA authenticated&quot;</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_AUTH</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_auth</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">WLAN_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;authentication failed&quot;</span><span class="p">;</span>

 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: %pM auth_cb - alg=%d &quot;</span>
		       <span class="s">&quot;trans#=%d status=%d - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span>
		       <span class="n">auth_alg</span><span class="p">,</span> <span class="n">auth_transaction</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">txt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_ap_tx_cb_assoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ok</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">txt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">ieee80211_is_assoc_resp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">ieee80211_is_reassoc_resp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hostap_ap_tx_cb_assoc received invalid &quot;</span>
		       <span class="s">&quot;frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;frame was not ACKed&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;STA not found&quot;</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="o">++</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">WLAN_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">))</span>
			<span class="n">hostap_event_new_sta</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;STA associated&quot;</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_assoc</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;association failed&quot;</span><span class="p">;</span>

 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: %pM assoc_cb - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">txt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called only as a tasklet (software IRQ); TX callback for poll frames used</span>
<span class="cm"> * in verifying whether the STA is still present. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_ap_tx_cb_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ok</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_STA_PENDING_POLL</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span>
		       <span class="s">&quot;%s: STA %pM did not ACK activity poll frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">fail:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


<span class="kt">void</span> <span class="nf">hostap_init_data</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;hostap_init_data: ap == NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span><span class="p">));</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="n">local</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">ap_policy</span> <span class="o">=</span> <span class="n">GET_INT_PARM</span><span class="p">(</span><span class="n">other_ap_policy</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">card_idx</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridge_packets</span> <span class="o">=</span> <span class="n">GET_INT_PARM</span><span class="p">(</span><span class="n">ap_bridge_packets</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">card_idx</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span> <span class="o">=</span>
		<span class="n">GET_INT_PARM</span><span class="p">(</span><span class="n">ap_max_inactivity</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">card_idx</span><span class="p">)</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">autom_ap_wds</span> <span class="o">=</span> <span class="n">GET_INT_PARM</span><span class="p">(</span><span class="n">autom_ap_wds</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">card_idx</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">);</span>

	<span class="cm">/* Initialize task queue structure for AP management */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">add_sta_proc_queue</span><span class="p">,</span> <span class="n">handle_add_proc_queue</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_idx</span> <span class="o">=</span>
		<span class="n">hostap_tx_callback_register</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hostap_ap_tx_cb</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: failed to register TX callback for &quot;</span>
		       <span class="s">&quot;AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wds_oper_queue</span><span class="p">,</span> <span class="n">handle_wds_oper_queue</span><span class="p">);</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_auth</span> <span class="o">=</span>
		<span class="n">hostap_tx_callback_register</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hostap_ap_tx_cb_auth</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_assoc</span> <span class="o">=</span>
		<span class="n">hostap_tx_callback_register</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hostap_ap_tx_cb_assoc</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_poll</span> <span class="o">=</span>
		<span class="n">hostap_tx_callback_register</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hostap_ap_tx_cb_poll</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_auth</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_assoc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_poll</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: failed to register TX callback for &quot;</span>
		       <span class="s">&quot;AP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">.</span><span class="n">mac_list</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">hostap_init_ap_proc</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#ifndef PRISM2_NO_PROCFS_DEBUG</span>
	<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;ap_debug&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span>
			       <span class="n">ap_debug_proc_read</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_PROCFS_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;ap_control&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span>
			       <span class="n">ap_control_proc_read</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
	<span class="n">create_proc_read_entry</span><span class="p">(</span><span class="s">&quot;ap&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span>
			       <span class="n">prism2_ap_proc_read</span><span class="p">,</span> <span class="n">ap</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">hostap_free_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;hostap_free_data: ap has not yet been &quot;</span>
		       <span class="s">&quot;initialized - skip resource freeing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">add_sta_proc_queue</span><span class="p">);</span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wds_oper_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">)</span>
		<span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">deinit</span><span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt_priv</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap_sta_hash_del</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">)</span>
			<span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">ap_free_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifndef PRISM2_NO_PROCFS_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;ap_debug&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_PROCFS_DEBUG */</span><span class="cp"></span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	  <span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;ap&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;ap_control&quot;</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ap_control_flush_macs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* caller should have mutex for AP STA list handling */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sta_info</span><span class="o">*</span> <span class="nf">ap_get_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_hash</span><span class="p">[</span><span class="n">STA_HASH</span><span class="p">(</span><span class="n">sta</span><span class="p">)];</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">s</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">hnext</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>

<span class="cm">/* Called from timer handler and from scheduled AP queue handlers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_send_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">type_subtype</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">body</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">body_len</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_cb_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="n">meta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span> <span class="cm">/* always use master radio device */</span>
	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: prism2_send_mgmt - device is not UP - &quot;</span>
		       <span class="s">&quot;cannot send frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">body_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: prism2_send_mgmt failed to allocate &quot;</span>
		       <span class="s">&quot;skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">type_subtype</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">type_subtype</span><span class="p">));</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">body</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">body_len</span><span class="p">),</span> <span class="n">body</span><span class="p">,</span> <span class="n">body_len</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>

	<span class="cm">/* FIX: ctrl::ack sending used special HFA384X_TX_CTRL_802_11</span>
<span class="cm">	 * tx_control instead of using local-&gt;tx_control */</span>


	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span> <span class="cm">/* DA / RA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span> <span class="cm">/* BSSID */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span> <span class="cm">/* SA */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* control:ACK does not have addr2 or addr3 */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span> <span class="cm">/* SA */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span> <span class="cm">/* BSSID */</span>
	<span class="p">}</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">meta</span><span class="p">));</span>
	<span class="n">meta</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">HOSTAP_SKB_TX_DATA_MAGIC</span><span class="p">;</span>
	<span class="n">meta</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">=</span> <span class="n">iface</span><span class="p">;</span>
	<span class="n">meta</span><span class="o">-&gt;</span><span class="n">tx_cb_idx</span> <span class="o">=</span> <span class="n">tx_cb_idx</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_sta_proc_read</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">page</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">start</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">off</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">eof</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* FIX: possible race condition.. the STA data could have just expired,</span>
<span class="cm">	 * but proc entry was still here so that the read could have started;</span>
<span class="cm">	 * some locking should be done here.. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">eof</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%s=%pM</span><span class="se">\n</span><span class="s">users=%d</span><span class="se">\n</span><span class="s">aid=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;flags=0x%04x%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;capability=0x%02x</span><span class="se">\n</span><span class="s">listen_interval=%d</span><span class="se">\n</span><span class="s">supported_rates=&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">?</span> <span class="s">&quot;AP&quot;</span> <span class="o">:</span> <span class="s">&quot;STA&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">),</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_AUTH</span> <span class="o">?</span> <span class="s">&quot; AUTH&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span> <span class="o">?</span> <span class="s">&quot; ASSOC&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PS</span> <span class="o">?</span> <span class="s">&quot; PS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_TIM</span> <span class="o">?</span> <span class="s">&quot; TIM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PERM</span> <span class="o">?</span> <span class="s">&quot; PERM&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_AUTHORIZED</span> <span class="o">?</span> <span class="s">&quot; AUTHORIZED&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PENDING_POLL</span> <span class="o">?</span> <span class="s">&quot; POLL&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">);</span>
	<span class="cm">/* supported_rates: 500 kbit/s units with msb ignored */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%d%sMbps &quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
				     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;.5&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">jiffies=%lu</span><span class="se">\n</span><span class="s">last_auth=%lu</span><span class="se">\n</span><span class="s">last_assoc=%lu</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;last_rx=%lu</span><span class="se">\n</span><span class="s">last_tx=%lu</span><span class="se">\n</span><span class="s">rx_packets=%lu</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;tx_packets=%lu</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;rx_bytes=%lu</span><span class="se">\n</span><span class="s">tx_bytes=%lu</span><span class="se">\n</span><span class="s">buffer_count=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;last_rx: silence=%d dBm signal=%d dBm rate=%d%s Mbps</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;tx_rate=%d</span><span class="se">\n</span><span class="s">tx[1M]=%d</span><span class="se">\n</span><span class="s">tx[2M]=%d</span><span class="se">\n</span><span class="s">tx[5.5M]=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;tx[11M]=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;rx[1M]=%d</span><span class="se">\n</span><span class="s">rx[2M]=%d</span><span class="se">\n</span><span class="s">rx[5.5M]=%d</span><span class="se">\n</span><span class="s">rx[11M]=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">jiffies</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_auth</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_assoc</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_tx</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_bytes</span><span class="p">,</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">),</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate</span> <span class="o">/</span> <span class="mi">10</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">?</span> <span class="s">&quot;.5&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>  <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">print_stats</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">print_stats</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;ssid=&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">32</span> <span class="o">&amp;&amp;</span>
					  <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">127</span><span class="p">)</span> <span class="o">?</span>
					 <span class="s">&quot;%c&quot;</span> <span class="o">:</span> <span class="s">&quot;&lt;%02x&gt;&quot;</span><span class="p">),</span>
				     <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

	<span class="k">return</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">page</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_add_proc_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ap_data</span><span class="p">,</span>
					  <span class="n">add_sta_proc_queue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">add_sta_proc_data</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">add_sta_proc_entries</span><span class="p">;</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">add_sta_proc_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%pM&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">proc</span> <span class="o">=</span> <span class="n">create_proc_read_entry</span><span class="p">(</span>
				<span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">,</span>
				<span class="n">prism2_sta_proc_read</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">prev</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span> <span class="nf">ap_add_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;AP: kmalloc failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize STA info data */</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">);</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">num_sta</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ap_sta_hash_add</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">proc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">add_sta_proc_data</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
		<span class="cm">/* schedule a non-interrupt context process to add a procfs</span>
<span class="cm">		 * entry for the STA since procfs code use GFP_KERNEL */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">add_sta_proc_entries</span><span class="p">;</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">add_sta_proc_entries</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
			<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">add_sta_proc_queue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Failed to add STA proc data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">max_inactivity</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sta</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">ap_handle_timer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span><span class="p">)</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

	<span class="k">return</span> <span class="n">sta</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_tx_rate_ok</span><span class="p">(</span><span class="kt">int</span> <span class="n">rateidx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			 <span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rateidx</span> <span class="o">&gt;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rateidx</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rateidx</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">prism2_check_tx_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">|=</span> <span class="n">WLAN_RATE_1M</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">|=</span> <span class="n">WLAN_RATE_2M</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">|=</span> <span class="n">WLAN_RATE_5M5</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">22</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">|=</span> <span class="n">WLAN_RATE_11M</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_1M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_tx_rate_ok</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_2M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_tx_rate_ok</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_5M5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_tx_rate_ok</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_11M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap_tx_rate_ok</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_crypt_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">lib80211_get_crypto_ops</span><span class="p">(</span><span class="s">&quot;WEP&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt_priv</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt_priv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="n">WEP_KEY_LEN</span><span class="p">];</span>
				<span class="n">get_random_bytes</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">WEP_KEY_LEN</span><span class="p">);</span>
				<span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">set_key</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">WEP_KEY_LEN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						   <span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt_priv</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;AP could not initialize WEP: load module &quot;</span>
		       <span class="s">&quot;lib80211_crypt_wep.ko</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Generate challenge data for shared key authentication. IEEE 802.11 specifies</span>
<span class="cm"> * that WEP algorithm is used for generating challenge. This should be unique,</span>
<span class="cm"> * but otherwise there is not really need for randomness etc. Initialize WEP</span>
<span class="cm"> * with pseudo random key and then use increasing IV to get unique challenge</span>
<span class="cm"> * streams.</span>
<span class="cm"> *</span>
<span class="cm"> * Called only as a scheduled task for pending AP frames.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span> <span class="nf">ap_auth_make_challenge</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">tmpbuf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap_crypt_init</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tmpbuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tmpbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;AP: kmalloc failed for challenge</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">WLAN_AUTH_CHALLENGE_LEN</span> <span class="o">+</span>
			    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">extra_mpdu_prefix_len</span> <span class="o">+</span>
			    <span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">extra_mpdu_postfix_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">extra_mpdu_prefix_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">encrypt_mpdu</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt_priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">tmpbuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">extra_mpdu_prefix_len</span><span class="p">,</span>
					 <span class="n">tmpbuf</span><span class="p">,</span> <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tmpbuf</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_authen</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">body</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">],</span> <span class="o">*</span><span class="n">challenge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">olen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">auth_alg</span><span class="p">,</span> <span class="n">auth_transaction</span><span class="p">,</span> <span class="n">status_code</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">;</span>

	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: handle_authen - too short payload &quot;</span>
		       <span class="s">&quot;(len=%d) from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">)</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">);</span>
	<span class="n">auth_alg</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="n">auth_transaction</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="n">status_code</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">ap_control_mac_deny</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">mac_restrictions</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;authentication denied&quot;</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_algs</span> <span class="o">&amp;</span> <span class="n">PRISM2_AUTH_OPEN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">auth_alg</span> <span class="o">==</span> <span class="n">WLAN_AUTH_OPEN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">auth_algs</span> <span class="o">&amp;</span> <span class="n">PRISM2_AUTH_SHARED_KEY</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">auth_alg</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span><span class="p">))</span> <span class="p">{</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;unsupported algorithm&quot;</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_NOT_SUPPORTED_AUTH_ALG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">u</span> <span class="o">==</span> <span class="n">WLAN_EID_CHALLENGE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;invalid challenge len&quot;</span><span class="p">;</span>
				<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_CHALLENGE_FAIL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;challenge underflow&quot;</span><span class="p">;</span>
				<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_CHALLENGE_FAIL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">challenge</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">u</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">last_beacon</span> <span class="o">+</span>
			       <span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: no beacons received for a while,&quot;</span>
			       <span class="s">&quot; assuming AP %pM is now STA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;AP trying to authenticate?&quot;</span><span class="p">;</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">auth_alg</span> <span class="o">==</span> <span class="n">WLAN_AUTH_OPEN</span> <span class="o">&amp;&amp;</span> <span class="n">auth_transaction</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">auth_alg</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">auth_transaction</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span>
	      <span class="p">(</span><span class="n">auth_transaction</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))))</span> <span class="p">{</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;unknown authentication transaction number&quot;</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNKNOWN_AUTH_TRANSACTION</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;new STA&quot;</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">num_sta</span> <span class="o">&gt;=</span> <span class="n">MAX_STA_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FIX: might try to remove some old STAs first? */</span>
			<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;no more room for new STAs&quot;</span><span class="p">;</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_add_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;ap_add_sta failed&quot;</span><span class="p">;</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">auth_alg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_AUTH_OPEN</span>:
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;authOK&quot;</span><span class="p">;</span>
		<span class="cm">/* IEEE 802.11 standard is not completely clear about</span>
<span class="cm">		 * whether STA is considered authenticated after</span>
<span class="cm">		 * authentication OK frame has been send or after it</span>
<span class="cm">		 * has been ACKed. In order to reduce interoperability</span>
<span class="cm">		 * issues, mark the STA authenticated before ACK. */</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_AUTH</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_AUTH_SHARED_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">auth_transaction</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span> <span class="o">=</span>
					<span class="n">ap_auth_make_challenge</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">challenge</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			    <span class="n">memcmp</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span><span class="p">,</span> <span class="n">challenge</span><span class="p">,</span>
				   <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">ieee80211_has_protected</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;challenge response incorrect&quot;</span><span class="p">;</span>
				<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_CHALLENGE_FAIL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;challenge OK - authOK&quot;</span><span class="p">;</span>
			<span class="cm">/* IEEE 802.11 standard is not completely clear about</span>
<span class="cm">			 * whether STA is considered authenticated after</span>
<span class="cm">			 * authentication OK frame has been send or after it</span>
<span class="cm">			 * has been ACKed. In order to reduce interoperability</span>
<span class="cm">			 * issues, mark the STA authenticated before ACK. */</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_AUTH</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span><span class="p">);</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">fail:</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">body</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">auth_alg</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">auth_transaction</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span> <span class="cm">/* status_code */</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="n">olen</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span> <span class="o">==</span> <span class="n">WLAN_STATUS_SUCCESS</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">auth_alg</span> <span class="o">==</span> <span class="n">WLAN_AUTH_SHARED_KEY</span> <span class="o">&amp;&amp;</span> <span class="n">auth_transaction</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_CHALLENGE</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tmp</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">;</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">challenge</span><span class="p">,</span> <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">);</span>
		<span class="n">olen</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">WLAN_AUTH_CHALLENGE_LEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_AUTH</span><span class="p">,</span>
			 <span class="n">body</span><span class="p">,</span> <span class="n">olen</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_auth</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: %pM auth (alg=%d &quot;</span>
		       <span class="s">&quot;trans#=%d stat=%d len=%d fc=%04x) ==&gt; %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
		       <span class="n">auth_alg</span><span class="p">,</span> <span class="n">auth_transaction</span><span class="p">,</span> <span class="n">status_code</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">),</span> <span class="n">resp</span><span class="p">,</span> <span class="n">txt</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_assoc</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reassoc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">body</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">lpos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_SUCCESS</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">send_deauth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">prev_ap</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">reassoc</span> <span class="o">?</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: handle_assoc - too short payload &quot;</span>
		       <span class="s">&quot;(len=%d, reassoc=%d) from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">reassoc</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_AUTH</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;trying to associate before authentication&quot;</span><span class="p">;</span>
		<span class="n">send_deauth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* do not decrement sta-&gt;users */</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">);</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">__le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reassoc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">prev_ap</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">;</span> <span class="n">pos</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span> <span class="o">-=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">prev_ap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ileft</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">u</span> <span class="o">==</span> <span class="n">WLAN_EID_SSID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ileft</span> <span class="o">=</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ileft</span> <span class="o">&gt;</span> <span class="n">left</span> <span class="o">||</span> <span class="n">ileft</span> <span class="o">&gt;</span> <span class="n">MAX_SSID_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;SSID overflow&quot;</span><span class="p">;</span>
				<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ileft</span> <span class="o">!=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">memcmp</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ileft</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;not our SSID&quot;</span><span class="p">;</span>
				<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_ASSOC_DENIED_UNSPEC</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">u</span> <span class="o">+=</span> <span class="n">ileft</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">ileft</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">u</span> <span class="o">==</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ileft</span> <span class="o">=</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ileft</span> <span class="o">&gt;</span> <span class="n">left</span> <span class="o">||</span> <span class="n">ileft</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">ileft</span> <span class="o">&gt;</span> <span class="n">WLAN_SUPP_RATES_MAX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;SUPP_RATES len error&quot;</span><span class="p">;</span>
				<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">memset</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ileft</span><span class="p">);</span>
			<span class="n">prism2_check_tx_rates</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

			<span class="n">u</span> <span class="o">+=</span> <span class="n">ileft</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">ileft</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: assoc from %pM&quot;</span>
			       <span class="s">&quot; with extra data (%d bytes) [&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">left</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PDEBUG2</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;&lt;%02x&gt;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">u</span><span class="p">);</span>
				<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">PDEBUG2</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;frame underflow&quot;</span><span class="p">;</span>
		<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_UNSPECIFIED_FAILURE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get a unique AID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;OK, old AID&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">&lt;=</span> <span class="n">MAX_AID_TABLE_SIZE</span><span class="p">;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_aid</span><span class="p">[</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">&gt;</span> <span class="n">MAX_AID_TABLE_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="n">WLAN_STATUS_AP_UNABLE_TO_HANDLE_NEW_STA</span><span class="p">;</span>
			<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;no room for more AIDs&quot;</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_aid</span><span class="p">[</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>
			<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
			<span class="n">txt</span> <span class="o">=</span> <span class="s">&quot;OK, new AID&quot;</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">fail:</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">body</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_deauth</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_STA_REQ_ASSOC_WITHOUT_AUTH</span><span class="p">);</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* FIX: CF-Pollable and CF-PollReq should be set to match the</span>
<span class="cm">		 * values in beacons/probe responses */</span>
		<span class="cm">/* FIX: how about privacy and WEP? */</span>
		<span class="cm">/* capability */</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_CAPABILITY_ESS</span><span class="p">);</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* status_code */</span>
		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">resp</span><span class="p">);</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>

		<span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
				     <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">));</span> <span class="cm">/* AID */</span>
		<span class="n">pos</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Supported rates (Information element) */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">;</span>
		<span class="n">lpos</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
		<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* len */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_1M</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_1M</span> <span class="o">?</span> <span class="mh">0x82</span> <span class="o">:</span> <span class="mh">0x02</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">lpos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_2M</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_2M</span> <span class="o">?</span> <span class="mh">0x84</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">lpos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_5M5</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_5M5</span> <span class="o">?</span>
				<span class="mh">0x8b</span> <span class="o">:</span> <span class="mh">0x0b</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">lpos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tx_rate_control</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_11M</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_11M</span> <span class="o">?</span>
				<span class="mh">0x96</span> <span class="o">:</span> <span class="mh">0x16</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">lpos</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
			 <span class="p">(</span><span class="n">send_deauth</span> <span class="o">?</span> <span class="n">IEEE80211_STYPE_DEAUTH</span> <span class="o">:</span>
			  <span class="p">(</span><span class="n">reassoc</span> <span class="o">?</span> <span class="n">IEEE80211_STYPE_REASSOC_RESP</span> <span class="o">:</span>
			   <span class="n">IEEE80211_STYPE_ASSOC_RESP</span><span class="p">)),</span>
			 <span class="n">body</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span> <span class="o">-</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">body</span><span class="p">,</span>
			 <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
			 <span class="n">send_deauth</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_callback_assoc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">resp</span> <span class="o">==</span> <span class="n">WLAN_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="cm">/* STA will be marked associated from TX callback, if</span>
<span class="cm">			 * AssocResp is ACKed */</span>
		<span class="p">}</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	PDEBUG(DEBUG_AP, &quot;%s: %pM %sassoc (len=%d &quot;</span>
<span class="c">	       &quot;prev_ap=%pM) =&gt; %d(%d) (%s)\n&quot;,</span>
<span class="c">	       dev-&gt;name,</span>
<span class="c">	       hdr-&gt;addr2,</span>
<span class="c">	       reassoc ? &quot;re&quot; : &quot;&quot;, len,</span>
<span class="c">	       prev_ap,</span>
<span class="c">	       resp, send_deauth, txt);</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_deauth</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;handle_deauth - too short payload (len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">body</span><span class="p">;</span>
	<span class="n">reason_code</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: deauthentication: %pM len=%d, &quot;</span>
	       <span class="s">&quot;reason_code=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
	       <span class="n">len</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
			<span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">WLAN_STA_AUTH</span> <span class="o">|</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: deauthentication from %pM, &quot;</span>
	       <span class="s">&quot;reason_code=%d, but STA not authenticated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_disassoc</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reason_code</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;handle_disassoc - too short payload (len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">body</span><span class="p">;</span>
	<span class="n">reason_code</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: disassociation: %pM len=%d, &quot;</span>
	       <span class="s">&quot;reason_code=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
	       <span class="n">len</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
			<span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_STA_ASSOC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: disassociation from %pM, &quot;</span>
		       <span class="s">&quot;reason_code=%d, but STA not authenticated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_handle_data_nullfunc</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* some STA f/w&#39;s seem to require control::ACK frame for</span>
<span class="cm">	 * data::nullfunc, but at least Prism2 station f/w version 0.8.0 does</span>
<span class="cm">	 * not send this..</span>
<span class="cm">	 * send control::ACK for the data::nullfunc */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Sending control::ACK for data::nullfunc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_ACK</span><span class="p">,</span>
			 <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ap_handle_dropped_data</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;ap_handle_dropped_data: STA is now okay?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_CLASS3_FRAME_FROM_NONASSOC_STA</span><span class="p">);</span>
	<span class="n">prism2_send_mgmt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
			 <span class="p">((</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">))</span> <span class="o">?</span>
			  <span class="n">IEEE80211_STYPE_DEAUTH</span> <span class="o">:</span> <span class="n">IEEE80211_STYPE_DISASSOC</span><span class="p">),</span>
			 <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">reason</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reason</span><span class="p">),</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pspoll_send_buffered</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="n">meta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PS</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Station has moved to non-PS mode, so send all buffered</span>
<span class="cm">		 * frames using normal device queue. */</span>
		<span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add a flag for hostap_handle_sta_tx() to know that this skb should</span>
<span class="cm">	 * be passed through even though STA is using PS */</span>
	<span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">meta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HOSTAP_TX_FLAGS_BUFFERED_FRAME</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* indicate to STA that more frames follow */</span>
		<span class="n">meta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">HOSTAP_TX_FLAGS_ADD_MOREDATA</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_pspoll</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span> <span class="s">&quot;handle_pspoll: BSSID=%pM, TA=%pM PWRMGT=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="o">!!</span><span class="n">ieee80211_has_pm</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span>
		       <span class="s">&quot;handle_pspoll - addr1(BSSID)=%pM not own MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">aid</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">duration_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">aid</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">)))</span> <span class="o">!=</span> <span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS</span><span class="p">,</span> <span class="s">&quot;   PSPOLL and AID[15:14] not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">aid</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">aid</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">aid</span> <span class="o">&gt;</span> <span class="n">MAX_AID_TABLE_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS</span><span class="p">,</span> <span class="s">&quot;   invalid aid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span> <span class="s">&quot;   aid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aid</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS</span><span class="p">,</span> <span class="s">&quot;   STA not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">!=</span> <span class="n">aid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS</span><span class="p">,</span> <span class="s">&quot;   received aid=%i does not match with &quot;</span>
		       <span class="s">&quot;assoc.aid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIX: todo:</span>
<span class="cm">	 * - add timeout for buffering (clear aid in TIM vector if buffer timed</span>
<span class="cm">	 *   out (expiry time must be longer than ListenInterval for</span>
<span class="cm">	 *   the corresponding STA; &quot;8802-11: 11.2.1.9 AP aging function&quot;</span>
<span class="cm">	 * - what to do, if buffered, pspolled, and sent frame is not ACKed by</span>
<span class="cm">	 *   sta; store buffer for later use and leave TIM aid bit set? use</span>
<span class="cm">	 *   TX event to check whether frame was ACKed?</span>
<span class="cm">	 */</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send buffered frame .. */</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span> <span class="s">&quot;Sending buffered frame to STA after PS POLL&quot;</span>
		       <span class="s">&quot; (buffer_count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">));</span>

		<span class="n">pspoll_send_buffered</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* send only one buffered packet per PS Poll */</span>
			<span class="cm">/* FIX: should ignore further PS Polls until the</span>
<span class="cm">			 * buffered packet that was just sent is acknowledged</span>
<span class="cm">			 * (Tx or TxExc event) */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* try to clear aid from TIM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_TIM</span><span class="p">))</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span>  <span class="s">&quot;Re-unsetting TIM for aid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">aid</span><span class="p">);</span>
		<span class="n">hostap_set_tim</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">aid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_STA_TIM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_wds_oper_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ap_data</span><span class="p">,</span>
					  <span class="n">wds_oper_queue</span><span class="p">);</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wds_oper_data</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wds_oper_entries</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wds_oper_entries</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: %s automatic WDS connection &quot;</span>
		       <span class="s">&quot;to AP %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">WDS_ADD</span> <span class="o">?</span> <span class="s">&quot;adding&quot;</span> <span class="o">:</span> <span class="s">&quot;removing&quot;</span><span class="p">,</span>
		       <span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">WDS_ADD</span><span class="p">)</span>
			<span class="n">prism2_wds_add</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">WDS_DEL</span><span class="p">)</span>
			<span class="n">prism2_wds_del</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">prev</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">prev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a scheduled task for pending AP frames. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_beacon</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">body</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">beacon_int</span><span class="p">,</span> <span class="n">capability</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">supp_rates</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">supp_rates_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_sta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;handle_beacon - too short payload &quot;</span>
		       <span class="s">&quot;(len=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">body</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Timestamp (8 octets) */</span>
	<span class="n">pos</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">left</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="cm">/* Beacon interval (2 octets) */</span>
	<span class="n">beacon_int</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="cm">/* Capability information (2 octets) */</span>
	<span class="n">capability</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">);</span>
	<span class="n">pos</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ap_policy</span> <span class="o">!=</span> <span class="n">AP_OTHER_AP_EVEN_IBSS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ileft</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">pos</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">u</span> <span class="o">==</span> <span class="n">WLAN_EID_SSID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ileft</span> <span class="o">=</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ileft</span> <span class="o">&gt;</span> <span class="n">left</span> <span class="o">||</span> <span class="n">ileft</span> <span class="o">&gt;</span> <span class="n">MAX_SSID_LEN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;SSID: overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ap_policy</span> <span class="o">==</span> <span class="n">AP_OTHER_AP_SAME_SSID</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">ileft</span> <span class="o">!=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">)</span> <span class="o">||</span>
			     <span class="n">memcmp</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">ileft</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* not our SSID */</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ssid</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
			<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ileft</span><span class="p">;</span>

			<span class="n">u</span> <span class="o">+=</span> <span class="n">ileft</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">ileft</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">u</span> <span class="o">==</span> <span class="n">WLAN_EID_SUPP_RATES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ileft</span> <span class="o">=</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ileft</span> <span class="o">&gt;</span> <span class="n">left</span> <span class="o">||</span> <span class="n">ileft</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ileft</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot; - SUPP_RATES len error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">supp_rates</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
			<span class="n">supp_rates_len</span> <span class="o">=</span> <span class="n">ileft</span><span class="p">;</span>

			<span class="n">u</span> <span class="o">+=</span> <span class="n">ileft</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">ileft</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">u</span> <span class="o">==</span> <span class="n">WLAN_EID_DS_PARAMS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>
			<span class="n">ileft</span> <span class="o">=</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>
			<span class="n">u</span><span class="o">++</span><span class="p">;</span> <span class="n">left</span><span class="o">--</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ileft</span> <span class="o">&gt;</span> <span class="n">left</span> <span class="o">||</span> <span class="n">ileft</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot; - DS_PARAMS len error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">channel</span> <span class="o">=</span> <span class="o">*</span><span class="n">u</span><span class="p">;</span>

			<span class="n">u</span> <span class="o">+=</span> <span class="n">ileft</span><span class="p">;</span>
			<span class="n">left</span> <span class="o">-=</span> <span class="n">ileft</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* add new AP */</span>
		<span class="n">new_sta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_add_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;prism2: kmalloc failed for AP &quot;</span>
			       <span class="s">&quot;data structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hostap_event_new_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

		<span class="cm">/* mark APs authentication and associated for pseudo ad-hoc</span>
<span class="cm">		 * style communication */</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">WLAN_STA_AUTH</span> <span class="o">|</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">autom_ap_wds</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hostap_wds_link_oper</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">WDS_ADD</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">[</span><span class="n">ssid_len</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">last_beacon</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">capability</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">beacon_int</span><span class="p">;</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="n">supp_rates</span><span class="p">,</span> <span class="n">supp_rates_len</span><span class="p">);</span>
		<span class="n">prism2_check_tx_rates</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>


<span class="cm">/* Called only as a tasklet. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ap_item</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="cm">/* FIX: should give skb-&gt;len to handler functions and check that the</span>
<span class="cm">	 * buffer is long enough */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">;</span>
	<span class="n">stype</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_STYPE</span><span class="p">;</span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;handle_ap_item - data frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* no ToDS nullfunc seems to be used to check</span>
<span class="cm">				 * AP association; so send reject message to</span>
<span class="cm">				 * speed up re-association */</span>
				<span class="n">ap_handle_dropped_data</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;   not ToDS frame (fc=0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fc</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;handle_ap_item - addr1(BSSID)=%pM&quot;</span>
			       <span class="s">&quot; not own MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nullfunc_ack</span> <span class="o">&amp;&amp;</span>
		    <span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span><span class="p">)</span>
			<span class="n">ap_handle_data_nullfunc</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ap_handle_dropped_data</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">&amp;&amp;</span> <span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle_beacon</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">&amp;&amp;</span> <span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_PSPOLL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handle_pspoll</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;Unknown frame in AP queue: type=0x%02x &quot;</span>
		       <span class="s">&quot;subtype=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">IEEE80211_FTYPE_MGMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;handle_ap_item - not a management frame?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;handle_ap_item - addr1(DA)=%pM&quot;</span>
		       <span class="s">&quot; not own MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;handle_ap_item - addr3(BSSID)=%pM&quot;</span>
		       <span class="s">&quot; not own MAC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">stype</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_ASSOC_REQ</span>:
		<span class="n">handle_assoc</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_ASSOC_RESP</span>:
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;==&gt; ASSOC RESP (ignored)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_REASSOC_REQ</span>:
		<span class="n">handle_assoc</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_REASSOC_RESP</span>:
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;==&gt; REASSOC RESP (ignored)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_ATIM</span>:
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;==&gt; ATIM (ignored)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_DISASSOC</span>:
		<span class="n">handle_disassoc</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_AUTH</span>:
		<span class="n">handle_authen</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_STYPE_DEAUTH</span>:
		<span class="n">handle_deauth</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;Unknown mgmt frame subtype 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">stype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

 <span class="nl">done:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="kt">void</span> <span class="nf">hostap_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">ap_policy</span> <span class="o">==</span> <span class="n">AP_OTHER_AP_SKIP_ALL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_HOSTAP</span><span class="p">);</span>
	<span class="n">handle_ap_item</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">drop:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">schedule_packet_send</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="n">rx_stats</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: schedule_packet_send: skb alloc &quot;</span>
		       <span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Generate a fake pspoll frame to start packet delivery */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
		<span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">|</span> <span class="n">IEEE80211_STYPE_PSPOLL</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">14</span><span class="p">));</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span>
	       <span class="s">&quot;%s: Scheduling buffered packet delivery for STA %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rx_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rx_stats</span><span class="p">));</span>
	<span class="n">hostap_rx</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rx_stats</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">prism2_ap_get_sta_qual</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">addr</span><span class="p">[],</span>
			   <span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">qual</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">buf_size</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">aplist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ptr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">aplist</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">addr</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">qual</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span> <span class="o">&lt;</span> <span class="mi">27</span> <span class="o">?</span>
				<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span> <span class="o">-</span> <span class="mi">27</span><span class="p">)</span> <span class="o">*</span> <span class="mi">92</span> <span class="o">/</span> <span class="mi">127</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">qual</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span> <span class="o">-</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span> <span class="o">-</span> <span class="mi">35</span><span class="p">;</span>
		<span class="n">qual</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">level</span> <span class="o">=</span> <span class="n">HFA384X_LEVEL_TO_dBm</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span><span class="p">);</span>
		<span class="n">qual</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">noise</span> <span class="o">=</span> <span class="n">HFA384X_LEVEL_TO_dBm</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span><span class="p">);</span>
		<span class="n">qual</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">updated</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_updated</span><span class="p">;</span>

		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_updated</span> <span class="o">=</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>

		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">buf_size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Translate our list of Access Points &amp; Stations to a card independent</span>
<span class="cm"> * format that the Wireless Tools will understand - Jean II */</span>
<span class="kt">int</span> <span class="nf">prism2_ap_translate_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_event</span> <span class="n">iwe</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end_buf</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">;</span>
<span class="cp">#if !defined(PRISM2_NO_KERNEL_IEEE80211_MGMT)</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="cp">#endif</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">ap</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">.</span><span class="n">next</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">ptr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>

		<span class="cm">/* First entry *MUST* be the AP MAC address */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span>

		<span class="cm">/* Use the mode to indicate if it&#39;s a station or</span>
<span class="cm">		 * an Access Point */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">);</span>

		<span class="cm">/* Some quality */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVQUAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span> <span class="o">&lt;</span> <span class="mi">27</span> <span class="o">?</span>
				<span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span> <span class="o">-</span> <span class="mi">27</span><span class="p">)</span> <span class="o">*</span> <span class="mi">92</span> <span class="o">/</span> <span class="mi">127</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span> <span class="o">-</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span> <span class="o">-</span> <span class="mi">35</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">HFA384X_LEVEL_TO_dBm</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">HFA384X_LEVEL_TO_dBm</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_updated</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">);</span>

<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_len</span><span class="p">;</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
							  <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
							  <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">WLAN_CAPABILITY_PRIVACY</span><span class="p">)</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
					<span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
			<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
							  <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
							  <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">FREQ_COUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">freq_list</span><span class="p">[</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ap</span><span class="p">.</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
					<span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span>
					<span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
					<span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iwe</span><span class="p">));</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVCUSTOM</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;beacon_interval=%d&quot;</span><span class="p">,</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">);</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
							  <span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_updated</span> <span class="o">=</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>

		<span class="cm">/* To be continued, we should make good use of IWEVCUSTOM */</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">current_ev</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hostapd_add_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_add_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">)</span>
		<span class="n">hostap_event_new_sta</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_AUTH</span> <span class="o">|</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">add_sta</span><span class="p">.</span><span class="n">aid</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">add_sta</span><span class="p">.</span><span class="n">capability</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">add_sta</span><span class="p">.</span><span class="n">tx_supp_rates</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_1M</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_2M</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
 	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_5M5</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">&amp;</span> <span class="n">WLAN_RATE_11M</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span>
	<span class="n">prism2_check_tx_rates</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hostapd_remove_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ap_sta_hash_del</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">)</span>
		<span class="n">hostap_event_expired_sta</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">ap_free_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hostapd_get_info_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">get_info_sta</span><span class="p">.</span><span class="n">inactive_sec</span> <span class="o">=</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hostapd_set_flags_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set_flags_sta</span><span class="p">.</span><span class="n">flags_or</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">set_flags_sta</span><span class="p">.</span><span class="n">flags_and</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_hostapd_sta_clear_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">sta_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">rate</span> <span class="o">&lt;</span> <span class="n">WLAN_RATE_COUNT</span><span class="p">;</span> <span class="n">rate</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">prism2_hostapd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">prism2_hostapd_param</span> <span class="o">*</span><span class="n">param</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_FLUSH</span>:
		<span class="n">ap_control_kickall</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_ADD_STA</span>:
		<span class="k">return</span> <span class="n">prism2_hostapd_add_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_REMOVE_STA</span>:
		<span class="k">return</span> <span class="n">prism2_hostapd_remove_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_GET_INFO_STA</span>:
		<span class="k">return</span> <span class="n">prism2_hostapd_get_info_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_SET_FLAGS_STA</span>:
		<span class="k">return</span> <span class="n">prism2_hostapd_set_flags_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">PRISM2_HOSTAPD_STA_CLEAR_STATS</span>:
		<span class="k">return</span> <span class="n">prism2_hostapd_sta_clear_stats</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">param</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;prism2_hostapd: unknown cmd=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">param</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Update station info for host-based TX rate control and return current</span>
<span class="cm"> * TX rate */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ap_update_sta_tx_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_count</span><span class="p">[</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_since_last_failure</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_consecutive_exc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_since_last_failure</span> <span class="o">&gt;=</span> <span class="n">WLAN_RATE_UPDATE_COUNT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">&lt;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use next higher rate */</span>
		<span class="kt">int</span> <span class="n">old_rate</span><span class="p">,</span> <span class="n">new_rate</span><span class="p">;</span>
		<span class="n">old_rate</span> <span class="o">=</span> <span class="n">new_rate</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">new_rate</span> <span class="o">&lt;</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_rate</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ap_tx_rate_ok</span><span class="p">(</span><span class="n">new_rate</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">local</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="n">new_rate</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_rate</span> <span class="o">!=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: STA %pM TX rate raised to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_since_last_failure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only from software IRQ. Called for each TX frame prior possible</span>
<span class="cm"> * encryption and transmit. */</span>
<span class="n">ap_tx_ret</span> <span class="nf">hostap_handle_sta_tx</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_tx_data</span> <span class="o">*</span><span class="n">tx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set_tim</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="n">meta</span><span class="p">;</span>

	<span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_TX_CONTINUE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">||</span>
	    <span class="n">meta</span><span class="o">-&gt;</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HOSTAP_INTERFACE_STA</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* broadcast/multicast frame - no AP related processing */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">num_sta</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_TX_DROP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* unicast packet - check whether destination STA is associated */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HOSTAP_TX_FLAGS_WDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">meta</span><span class="o">-&gt;</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">HOSTAP_INTERFACE_MASTER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">meta</span><span class="o">-&gt;</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">HOSTAP_INTERFACE_AP</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">		/* This can happen, e.g., when wlan0 is added to a bridge and</span>
<span class="c">		 * bridging code does not know which port is the correct target</span>
<span class="c">		 * for a unicast frame. In this case, the packet is send to all</span>
<span class="c">		 * ports of the bridge. Since this is a valid scenario, do not</span>
<span class="c">		 * print out any errors here. */</span>
<span class="c">		if (net_ratelimit()) {</span>
<span class="c">			printk(KERN_DEBUG &quot;AP: drop packet to non-associated &quot;</span>
<span class="c">			       &quot;STA %pM\n&quot;, hdr-&gt;addr1);</span>
<span class="c">		}</span>
<span class="cp">#endif</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">tx_drop_nonassoc</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_TX_DROP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_TX_CONTINUE_NOT_AUTHORIZED</span><span class="p">;</span>

	<span class="cm">/* Set tx_rate if using host-based TX rate control */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">fw_tx_rate_control</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">last_tx_rate</span> <span class="o">=</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span>
			<span class="n">ap_update_sta_tx_rate</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PS</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HOSTAP_TX_FLAGS_ADD_MOREDATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* indicate to STA that more frames follow */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">|=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FCTL_MOREDATA</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">meta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HOSTAP_TX_FLAGS_BUFFERED_FRAME</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* packet was already buffered and now send due to</span>
<span class="cm">		 * PS poll, so do not rebuffer it */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">STA_MAX_TX_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS</span><span class="p">,</span> <span class="s">&quot;%s: No more space in STA (%pM)&#39;s&quot;</span>
		       <span class="s">&quot;PS mode buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="cm">/* Make sure that TIM is set for the station (it might not be</span>
<span class="cm">		 * after AP wlan hw reset). */</span>
		<span class="cm">/* FIX: should fix hw reset to restore bits based on STA</span>
<span class="cm">		 * buffer state.. */</span>
		<span class="n">hostap_set_tim</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_TIM</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_TX_DROP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* STA in PS mode, buffer frame for later delivery */</span>
	<span class="n">set_tim</span> <span class="o">=</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_buf</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="cm">/* FIX: could save RX time to skb and expire buffered frames after</span>
<span class="cm">	 * some time if STA does not poll for them */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_tim</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_TIM</span><span class="p">)</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span> <span class="s">&quot;Re-setting TIM for aid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
		<span class="n">hostap_set_tim</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_TIM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_TX_BUFFERED</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">AP_TX_CONTINUE</span> <span class="o">||</span>
		    <span class="n">ret</span> <span class="o">==</span> <span class="n">AP_TX_CONTINUE_NOT_AUTHORIZED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_tx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="n">AP_TX_CONTINUE</span> <span class="o">||</span>
		     <span class="n">ret</span> <span class="o">==</span> <span class="n">AP_TX_CONTINUE_NOT_AUTHORIZED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="n">tx</span><span class="o">-&gt;</span><span class="n">host_encrypt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx</span><span class="o">-&gt;</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">;</span>
			<span class="n">tx</span><span class="o">-&gt;</span><span class="n">sta_ptr</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span> <span class="cm">/* hostap_handle_sta_release() will</span>
<span class="cm">					    * be called to release sta info</span>
<span class="cm">					    * later */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">hostap_handle_sta_release</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="kt">void</span> <span class="nf">hostap_handle_sta_tx_exc</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="n">meta</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">meta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostap_skb_tx_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span> <span class="s">&quot;%s: Could not find STA %pM&quot;</span>
		       <span class="s">&quot; for this TX error (@%lu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_since_last_failure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_consecutive_exc</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_consecutive_exc</span> <span class="o">&gt;=</span> <span class="n">WLAN_RATE_DECREASE_THRESHOLD</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">meta</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use next lower rate */</span>
		<span class="kt">int</span> <span class="n">old</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span><span class="o">--</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ap_tx_rate_ok</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">local</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>: <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>: <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>: <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_AP</span><span class="p">,</span>
			       <span class="s">&quot;%s: STA %pM TX rate lowered to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_consecutive_exc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_update_sta_ps2</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">pwrmgt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">stype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pwrmgt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_PS</span><span class="p">;</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span> <span class="s">&quot;STA %pM changed to use PS &quot;</span>
		       <span class="s">&quot;mode (type=0x%02X, stype=0x%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pwrmgt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_PS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WLAN_STA_PS</span><span class="p">;</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_PS2</span><span class="p">,</span> <span class="s">&quot;STA %pM changed to not use &quot;</span>
		       <span class="s">&quot;PS mode (type=0x%02X, stype=0x%02X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">IEEE80211_FTYPE_CTL</span> <span class="o">||</span>
		    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_PSPOLL</span><span class="p">)</span>
			<span class="n">schedule_packet_send</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ). Called for each RX frame to update</span>
<span class="cm"> * STA power saving state. pwrmgt is a flag from 802.11 frame_control field. */</span>
<span class="kt">int</span> <span class="nf">hostap_update_sta_ps</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">hostap_update_sta_ps2</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PM</span><span class="p">,</span>
			      <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">,</span>
			      <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_STYPE</span><span class="p">);</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ). Called for each RX frame after</span>
<span class="cm"> * getting RX header and payload from hardware. */</span>
<span class="n">ap_rx_ret</span> <span class="nf">hostap_handle_sta_rx</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">wds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">AP_RX_CONTINUE</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">;</span>
	<span class="n">stype</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_STYPE</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_RX_CONTINUE_NOT_AUTHORIZED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_RX_CONTINUE</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wds</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">prism2_rx_80211</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span>
						<span class="n">PRISM2_RX_NON_ASSOC</span><span class="p">);</span>
<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dropped received packet&quot;</span>
				       <span class="s">&quot; from non-associated STA %pM&quot;</span>
				       <span class="s">&quot; (type=0x%02x, subtype=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
				       <span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
				<span class="n">hostap_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_RX_EXIT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wds</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* FromDS frame - not for us; probably</span>
<span class="cm">			 * broadcast/multicast in another BSS - drop */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Odd.. FromDS packet &quot;</span>
				       <span class="s">&quot;received with own BSSID</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">hostap_dump_rx_80211</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_RX_DROP</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span> <span class="o">&amp;&amp;</span> <span class="n">sta</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		   <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prism2_rx_80211</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span>
					<span class="n">PRISM2_RX_NON_ASSOC</span><span class="p">);</span>
<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* At least Lucent f/w seems to send data::nullfunc</span>
<span class="cm">			 * frames with no ToDS flag when the current AP returns</span>
<span class="cm">			 * after being unavailable for some time. Speed up</span>
<span class="cm">			 * re-association by informing the station about it not</span>
<span class="cm">			 * being associated. */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: rejected received nullfunc frame&quot;</span>
			       <span class="s">&quot; without ToDS from not associated STA %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
			<span class="n">hostap_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_RX_EXIT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* At least Lucent cards seem to send periodic nullfunc</span>
<span class="cm">		 * frames with ToDS. Let these through to update SQ</span>
<span class="cm">		 * stats and PS state. Nullfunc frames do not contain</span>
<span class="cm">		 * any data and they will be dropped below. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If BSSID (Addr3) is foreign, this frame is a normal</span>
<span class="cm">		 * broadcast frame from an IBSS network. Drop it silently.</span>
<span class="cm">		 * If BSSID is own, report the dropping of this frame. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dropped received packet from %pM&quot;</span>
			       <span class="s">&quot; with no ToDS flag &quot;</span>
			       <span class="s">&quot;(type=0x%02x, subtype=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">hostap_dump_rx_80211</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_RX_DROP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hostap_update_sta_ps2</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PM</span><span class="p">,</span>
				      <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">);</span>

		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">nullfunc_ack</span> <span class="o">&amp;&amp;</span> <span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prism2_rx_80211</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span>
					<span class="n">PRISM2_RX_NULLFUNC_ACK</span><span class="p">);</span>
<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* some STA f/w&#39;s seem to require control::ACK frame</span>
<span class="cm">			 * for data::nullfunc, but Prism2 f/w 0.8.0 (at least</span>
<span class="cm">			 * from Compaq) does not send this.. Try to generate</span>
<span class="cm">			 * ACK for these frames from the host driver to make</span>
<span class="cm">			 * power saving work with, e.g., Lucent WaveLAN f/w */</span>
			<span class="n">hostap_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">AP_RX_EXIT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="kt">int</span> <span class="nf">hostap_handle_sta_crypto</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">**</span><span class="n">crypt</span><span class="p">,</span>
			     <span class="kt">void</span> <span class="o">**</span><span class="n">sta_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">;</span>
		<span class="o">*</span><span class="n">sta_ptr</span> <span class="o">=</span> <span class="n">sta</span><span class="p">;</span>
		<span class="cm">/* hostap_handle_sta_release() will be called to release STA</span>
<span class="cm">		 * info */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="kt">int</span> <span class="nf">hostap_is_sta_assoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sta_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="kt">int</span> <span class="nf">hostap_is_sta_authorized</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sta_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">WLAN_STA_AUTHORIZED</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">ap</span><span class="o">-&gt;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ieee_802_1x</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="kt">int</span> <span class="nf">hostap_add_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sta_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_add_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">sta_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">WLAN_STA_AUTH</span> <span class="o">|</span> <span class="n">WLAN_STA_ASSOC</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">));</span>
		<span class="cm">/* No way of knowing which rates are supported since we did not</span>
<span class="cm">		 * get supported rates element from beacon/assoc req. Assume</span>
<span class="cm">		 * that remote end supports all 802.11b rates. */</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x82</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x84</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_supp_rates</span> <span class="o">=</span> <span class="n">WLAN_RATE_1M</span> <span class="o">|</span> <span class="n">WLAN_RATE_2M</span> <span class="o">|</span>
			<span class="n">WLAN_RATE_5M5</span> <span class="o">|</span> <span class="n">WLAN_RATE_11M</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_max_rate</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">tx_rate_idx</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="kt">int</span> <span class="nf">hostap_update_rx_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_silence</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_signal</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_rate</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">last_rx_updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">55</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">==</span> <span class="mi">110</span><span class="p">)</span>
			<span class="n">sta</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sta</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">hostap_update_rates</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ap</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prism2_check_tx_rates</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="o">*</span> <span class="nf">ap_crypt_get_ptrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">permanent</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">***</span><span class="n">crypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_get_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span> <span class="o">&amp;&amp;</span> <span class="n">permanent</span><span class="p">)</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="n">ap_add_sta</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">permanent</span><span class="p">)</span>
		<span class="n">sta</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">WLAN_STA_PERM</span><span class="p">;</span>

	<span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">crypt</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sta</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">hostap_add_wds_links</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ap_data</span> <span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta_info</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">)</span>
			<span class="n">hostap_wds_link_oper</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">WDS_ADD</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">sta_table_lock</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wds_oper_queue</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">hostap_wds_link_oper</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">wds_oper_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wds_oper_data</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wds_oper_entries</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wds_oper_entries</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">wds_oper_queue</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hostap_init_data</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hostap_init_ap_proc</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hostap_free_data</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hostap_check_sta_fw_version</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hostap_handle_sta_tx_exc</span><span class="p">);</span>
<span class="cp">#ifndef PRISM2_NO_KERNEL_IEEE80211_MGMT</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_NO_KERNEL_IEEE80211_MGMT */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
