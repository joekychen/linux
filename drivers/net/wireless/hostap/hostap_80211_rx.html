<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › hostap › hostap_80211_rx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>hostap_80211_rx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;net/lib80211.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>

<span class="cp">#include &quot;hostap_80211.h&quot;</span>
<span class="cp">#include &quot;hostap.h&quot;</span>
<span class="cp">#include &quot;hostap_ap.h&quot;</span>

<span class="cm">/* See IEEE 802.1H for LLC/SNAP encapsulation/decapsulation */</span>
<span class="cm">/* Ethernet-II snap header (RFC1042 for most EtherTypes) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rfc1042_header</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>
<span class="cm">/* Bridge-Tunnel header (for EtherTypes ETH_P_AARP and ETH_P_IPX) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bridge_tunnel_header</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0xaa</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xf8</span> <span class="p">};</span>
<span class="cm">/* No encapsulation header if EtherType &lt; 0x600 (=length) */</span>

<span class="kt">void</span> <span class="nf">hostap_dump_rx_80211</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX signal=%d noise=%d rate=%d len=%d &quot;</span>
	       <span class="s">&quot;jiffies=%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">name</span><span class="p">,</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">,</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">,</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">,</span>
	       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;   FC=0x%04x (type=%d:%d)%s%s&quot;</span><span class="p">,</span>
	       <span class="n">fc</span><span class="p">,</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_STYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
	       <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span> <span class="o">?</span> <span class="s">&quot; [ToDS]&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
	       <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">?</span> <span class="s">&quot; [FromDS]&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_DATA_HDR3_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; dur=0x%04x seq=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">duration_id</span><span class="p">),</span>
	       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;   A1=%pM&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; A2=%pM&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; A3=%pM&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; A4=%pM&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr4</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Send RX frame to netif with 802.11 (and possible prism) header.</span>
<span class="cm"> * Called from hardware or software IRQ context. */</span>
<span class="kt">int</span> <span class="nf">prism2_rx_80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">phdrlen</span><span class="p">,</span> <span class="n">head_need</span><span class="p">,</span> <span class="n">tail_need</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prism_header</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">fhdr</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ARPHRD_IEEE80211_PRISM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">==</span> <span class="n">PRISM2_MONITOR_PRISM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prism_header</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">phdrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">linux_wlan_ng_prism_hdr</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* local-&gt;monitor_type == PRISM2_MONITOR_CAPHDR */</span>
			<span class="n">prism_header</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">phdrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">linux_wlan_ng_cap_hdr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">ARPHRD_IEEE80211_RADIOTAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prism_header</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">phdrlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">hostap_radiotap_rx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">prism_header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">phdrlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fhdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">PRISM2_RX_MGMT</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_VERS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dropped management frame with header &quot;</span>
		       <span class="s">&quot;version %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_VERS</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">fhdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="cm">/* check if there is enough room for extra data; if not, expand skb</span>
<span class="cm">	 * buffer to be large enough for the changes */</span>
	<span class="n">head_need</span> <span class="o">=</span> <span class="n">phdrlen</span><span class="p">;</span>
	<span class="n">tail_need</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#ifdef PRISM2_ADD_BOGUS_CRC</span>
	<span class="n">tail_need</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_ADD_BOGUS_CRC */</span><span class="cp"></span>

	<span class="n">head_need</span> <span class="o">-=</span> <span class="n">skb_headroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">tail_need</span> <span class="o">-=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">head_need</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">tail_need</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pskb_expand_head</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">head_need</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">head_need</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">tail_need</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">tail_need</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: prism2_rx_80211 failed to &quot;</span>
			       <span class="s">&quot;reallocate skb buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* We now have an skb with enough head and tail room, so just insert</span>
<span class="cm">	 * the extra data */</span>

<span class="cp">#ifdef PRISM2_ADD_BOGUS_CRC</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span> <span class="cm">/* Prism2 strips CRC */</span>
<span class="cp">#endif </span><span class="cm">/* PRISM2_ADD_BOGUS_CRC */</span><span class="cp"></span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prism_header</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">linux_wlan_ng_prism_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">linux_wlan_ng_prism_hdr</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">phdrlen</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phdrlen</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">msgcode</span> <span class="o">=</span> <span class="n">LWNG_CAP_DID_BASE</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">msglen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">));</span>
<span class="cp">#define LWNG_SETVAL(f,i,s,l,d) \</span>
<span class="cp">hdr-&gt;f.did = LWNG_CAP_DID_BASE | (i &lt;&lt; 12); \</span>
<span class="cp">hdr-&gt;f.status = s; hdr-&gt;f.len = l; hdr-&gt;f.data = d</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">hosttime</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">mactime</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* no value */</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">rssi</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* no value */</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">sq</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span> <span class="cm">/* no value */</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">istx</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">LWNG_SETVAL</span><span class="p">(</span><span class="n">frmlen</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">phdrlen</span><span class="p">);</span>
<span class="cp">#undef LWNG_SETVAL</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prism_header</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">linux_wlan_ng_cap_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">linux_wlan_ng_cap_hdr</span> <span class="o">*</span><span class="p">)</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">phdrlen</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phdrlen</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">version</span>    <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">LWNG_CAPHDR_VERSION</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">length</span>     <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">phdrlen</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">mactime</span>    <span class="o">=</span> <span class="n">__cpu_to_be64</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hosttime</span>   <span class="o">=</span> <span class="n">__cpu_to_be64</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">phytype</span>    <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span> <span class="cm">/* dss_dot11_b */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">channel</span>    <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">datarate</span>   <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">antenna</span>    <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* unknown */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">priority</span>   <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* unknown */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ssi_type</span>   <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span> <span class="cm">/* raw */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ssi_signal</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ssi_noise</span>  <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">preamble</span>   <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="cm">/* unknown */</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">encoding</span>   <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* cck */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">prism_header</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">hostap_radiotap_rx</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostap_radiotap_rx</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">phdrlen</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phdrlen</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">it_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">phdrlen</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">it_present</span> <span class="o">=</span>
			<span class="n">cpu_to_le32</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_TSFT</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_CHANNEL</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_RATE</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_DBM_ANTSIGNAL</span><span class="p">)</span> <span class="o">|</span>
				    <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IEEE80211_RADIOTAP_DBM_ANTNOISE</span><span class="p">));</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">tsft</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">mac_time</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">chan_freq</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">freq_list</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">chan_flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_CHAN_CCK</span> <span class="o">|</span>
						 <span class="n">IEEE80211_CHAN_2GHZ</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">/</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dbm_antsignal</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">dbm_antnoise</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">phdrlen</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prism_header</span><span class="p">)</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">phdrlen</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">monitor_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">prism2_rx_80211</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">PRISM2_RX_MONITOR</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">prism2_frag_entry</span> <span class="o">*</span>
<span class="nf">prism2_frag_cache_find</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">,</span>
		       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">prism2_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PRISM2_FRAG_CACHE_LEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frag_cache</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
		    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: expiring fragment cache entry &quot;</span>
			       <span class="s">&quot;seq=%u last_frag=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">==</span> <span class="n">seq</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">frag</span> <span class="o">||</span> <span class="n">frag</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">prism2_frag_cache_get</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">,</span> <span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prism2_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">);</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">;</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reserve enough space to fit maximum frame length */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">+</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span><span class="p">)</span> <span class="o">+</span>
				    <span class="mi">8</span> <span class="cm">/* LLC */</span> <span class="o">+</span>
				    <span class="mi">2</span> <span class="cm">/* alignment */</span> <span class="o">+</span>
				    <span class="mi">8</span> <span class="cm">/* WEP */</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="cm">/* WDS */</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frag_cache</span><span class="p">[</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="p">];</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span> <span class="o">&gt;=</span> <span class="n">PRISM2_FRAG_CACHE_LEN</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">frag_next_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>

		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">first_frag_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
		<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">src_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">dst_addr</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* received a fragment of a frame for which the head fragment</span>
<span class="cm">		 * should have already been received */</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">prism2_frag_cache_find</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">frag</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span>
					       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span><span class="o">-&gt;</span><span class="n">last_frag</span> <span class="o">=</span> <span class="n">frag</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism2_frag_cache_invalidate</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">sc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">prism2_frag_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">);</span>
	<span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">prism2_frag_cache_find</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: could not invalidate fragment cache &quot;</span>
		       <span class="s">&quot;entry (seq=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">seq</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="nf">__hostap_get_bss</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ssid_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_bss_info</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ssid</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">&amp;&amp;</span>
		      <span class="n">memcmp</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">bss</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="nf">__hostap_add_bss</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
						<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ssid_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">num_bss_info</span> <span class="o">&gt;=</span> <span class="n">HOSTAP_MAX_BSS_COUNT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">hostap_bss_info</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">num_bss_info</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bss</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">bss</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bss</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">num_bss_info</span><span class="o">++</span><span class="p">;</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bss</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">__hostap_expire_bss</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">num_bss_info</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">bss_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">hostap_bss_info</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">last_update</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">num_bss_info</span><span class="o">--</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Both IEEE 802.11 Beacon and Probe Response frames have similar structure, so</span>
<span class="cm"> * the same routine can be used to parse both of them. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hostap_rx_sta_beacon</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">stype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">wpa</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">rsn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wpa_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rsn_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">hostap_bss_info</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_MGMT_HDR_LEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">hostap_ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span> <span class="cm">/* parse failed */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WLAN_EID_SSID</span>:
			<span class="n">ssid</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_GENERIC</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
			    <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
			    <span class="n">pos</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wpa</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
				<span class="n">wpa_len</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_RSN</span>:
			<span class="n">rsn</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
			<span class="n">rsn_len</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WLAN_EID_DS_PARAMS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">chan</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">left</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wpa_len</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">)</span>
		<span class="n">wpa_len</span> <span class="o">=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsn_len</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">)</span>
		<span class="n">rsn_len</span> <span class="o">=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ssid_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">))</span>
		<span class="n">ssid_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bss</span> <span class="o">=</span> <span class="n">__hostap_get_bss</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">__hostap_add_bss</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">capab_info</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">capab_info</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wpa</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">wpa</span><span class="p">,</span> <span class="n">wpa_len</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">wpa_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rsn</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">rsn_ie</span><span class="p">,</span> <span class="n">rsn</span><span class="p">,</span> <span class="n">rsn_len</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="n">rsn_len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">rsn_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">__hostap_expire_bss</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hostap_rx_frame_mgmt</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>
		     <span class="n">u16</span> <span class="n">stype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span>
		<span class="n">hostap_update_sta_ps</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span> <span class="o">&amp;&amp;</span> <span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_MGMT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span> <span class="o">&amp;&amp;</span>
		    <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb2</span><span class="p">;</span>
			<span class="cm">/* Process beacon frames also in kernel driver to</span>
<span class="cm">			 * update STA(AP) table statistics */</span>
			<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb2</span><span class="p">)</span>
				<span class="n">hostap_rx</span><span class="p">(</span><span class="n">skb2</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb2</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* send management frames to the user space daemon for</span>
<span class="cm">		 * processing */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">apdevstats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">apdevstats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">prism2_rx_80211</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">PRISM2_RX_MGMT</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">type</span> <span class="o">!=</span> <span class="n">IEEE80211_FTYPE_CTL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: unknown management frame &quot;</span>
			       <span class="s">&quot;(type=0x%02x, stype=0x%02x) dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hostap_rx</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_BEACON</span> <span class="o">||</span>
		    <span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hostap_rx_sta_beacon</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">stype</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_ASSOC_RESP</span> <span class="o">||</span>
		    <span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_REASSOC_RESP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Ignore (Re)AssocResp silently since these are not currently</span>
<span class="cm">		 * needed but are still received when WPA/RSN mode is enabled.</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: hostap_rx_frame_mgmt: dropped unhandled&quot;</span>
		       <span class="s">&quot; management frame in non-Host AP mode (type=%d:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">prism2_rx_get_wds</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
						   <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">read_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iface_lock</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostap_interfaces</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iface</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">hostap_interface</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">HOSTAP_INTERFACE_WDS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">wds</span><span class="p">.</span><span class="n">remote_addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">iface</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">read_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iface_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">iface</span> <span class="o">?</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hostap_rx_frame_wds</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">fc</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">net_device</span> <span class="o">**</span><span class="n">wds</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIX: is this really supposed to accept WDS frames only in Master</span>
<span class="cm">	 * mode? What about Repeater or Managed with WDS frames? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not a WDS frame */</span>

	<span class="cm">/* Possible WDS frame: either IEEE 802.11 compliant (if FromDS)</span>
<span class="cm">	 * or own non-standard frame with 4th address after payload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span>
	     <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span>
	     <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* RA (or BSSID) is not ours - drop */</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA2</span><span class="p">,</span> <span class="s">&quot;%s: received WDS frame with &quot;</span>
		       <span class="s">&quot;not own or broadcast %s=%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">?</span> <span class="s">&quot;RA&quot;</span> <span class="o">:</span> <span class="s">&quot;BSSID&quot;</span><span class="p">,</span>
		       <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if the frame came from a registered WDS connection */</span>
	<span class="o">*</span><span class="n">wds</span> <span class="o">=</span> <span class="n">prism2_rx_get_wds</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wds</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wds_type</span> <span class="o">&amp;</span> <span class="n">HOSTAP_WDS_AP_CLIENT</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* require that WDS link has been registered with TA or the</span>
<span class="cm">		 * frame is from current AP when using &#39;AP client mode&#39; */</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA</span><span class="p">,</span> <span class="s">&quot;%s: received WDS[4 addr] frame &quot;</span>
		       <span class="s">&quot;from unknown TA=%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">autom_ap_wds</span><span class="p">)</span>
			<span class="n">hostap_wds_link_oper</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">WDS_ADD</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">wds</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hostap_is_sta_assoc</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* STA is actually associated with us even though it has a</span>
<span class="cm">		 * registered WDS link. Assume it is in &#39;AP client&#39; mode.</span>
<span class="cm">		 * Since this is a 3-addr frame, assume it is not (bogus) WDS</span>
<span class="cm">		 * frame and process it like any normal ToDS frame from</span>
<span class="cm">		 * associated STA. */</span>
		<span class="o">*</span><span class="n">wds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">hostap_is_eapol_frame</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">ethertype</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="cm">/* check that the frame is unicast frame to us */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span>
	    <span class="n">IEEE80211_FCTL_TODS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ToDS frame with own addr BSSID and DA */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span>
		   <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">&amp;&amp;</span>
		   <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FromDS frame with own addr as DA */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* check for port access entity Ethernet type */</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">pos</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ethertype</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hostap_rx_frame_decrypt</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">tkip_countermeasures</span> <span class="o">&amp;&amp;</span>
	    <span class="n">strcmp</span><span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;TKIP&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: TKIP countermeasures: dropped &quot;</span>
			       <span class="s">&quot;received packet from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: decryption failed (SA=%pM) res=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">comm_tallies</span><span class="p">.</span><span class="n">rx_discards_wep_undecryptable</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called only as a tasklet (software IRQ) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">hostap_rx_frame_decrypt_msdu</span><span class="p">(</span><span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">keyidx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_msdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_msdu</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: MSDU decryption/MIC verification failed&quot;</span>
		       <span class="s">&quot; (SA=%pM keyidx=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* All received frames are sent to this function. @skb contains the frame in</span>
<span class="cm"> * IEEE 802.11 format, i.e., in the format it was sent over air.</span>
<span class="cm"> * This function is called only as a tasklet (software IRQ). */</span>
<span class="kt">void</span> <span class="nf">hostap_80211_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">hostap_80211_rx_status</span> <span class="o">*</span><span class="n">rx_stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">hostap_interface</span> <span class="o">*</span><span class="n">iface</span><span class="p">;</span>
	<span class="n">local_info_t</span> <span class="o">*</span><span class="n">local</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="n">sc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">wds</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ethertype</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">frame_authorized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">from_assoc_ap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dst</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">src</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">lib80211_crypt_data</span> <span class="o">*</span><span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keyidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">local</span> <span class="o">=</span> <span class="n">iface</span><span class="o">-&gt;</span><span class="n">local</span><span class="p">;</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">iface</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* dev is the master radio device; change this to be the default</span>
<span class="cm">	 * virtual interface (this may be changed to WDS device below) */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">ddev</span><span class="p">;</span>
	<span class="n">iface</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_FTYPE</span><span class="p">;</span>
	<span class="n">stype</span> <span class="o">=</span> <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_STYPE</span><span class="p">;</span>
	<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">);</span>
	<span class="n">frag</span> <span class="o">=</span> <span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_FRAG</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">hostap_80211_get_hdrlen</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>

	<span class="cm">/* Put this code here so that we avoid duplicating it in all</span>
<span class="cm">	 * Rx paths. - Jean II */</span>
<span class="cp">#ifdef IW_WIRELESS_SPY		</span><span class="cm">/* defined in iw_handler.h */</span><span class="cp"></span>
	<span class="cm">/* If spy monitoring on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iface</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">wstats</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">rx_stats</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_NOISE_UPDATED</span>
			<span class="o">|</span> <span class="n">IW_QUAL_QUAL_INVALID</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="cm">/* Update spy records */</span>
		<span class="n">wireless_spy_update</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wstats</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* IW_WIRELESS_SPY */</span><span class="cp"></span>
	<span class="n">hostap_update_rx_stats</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">monitor_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">crypt</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">crypt_info</span><span class="p">.</span><span class="n">crypt</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="cm">/* Use station specific key to override default keys if the</span>
<span class="cm">		 * receiver address is a unicast address (&quot;individual RA&quot;). If</span>
<span class="cm">		 * bcrx_sta_key parameter is set, station specific key is used</span>
<span class="cm">		 * even with broad/multicast targets (this is against IEEE</span>
<span class="cm">		 * 802.11, but makes it easier to use different keys with</span>
<span class="cm">		 * stations that do not support WEP key mapping). */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">bcrx_sta_key</span><span class="p">)</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">hostap_handle_sta_crypto</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crypt</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">sta</span><span class="p">);</span>

		<span class="cm">/* allow NULL decrypt to indicate an station specific override</span>
<span class="cm">		 * for default encryption */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
			      <span class="n">crypt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">decrypt_mpdu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="n">crypt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			/* This seems to be triggered by some (multicast?)</span>
<span class="c">			 * frames from other than current BSS, so just drop the</span>
<span class="c">			 * frames silently instead of filling system log with</span>
<span class="c">			 * these reports. */</span>
<span class="c">			printk(KERN_DEBUG &quot;%s: WEP decryption failed (not set)&quot;</span>
<span class="c">			       &quot; (SA=%pM)\n&quot;,</span>
<span class="c">			       local-&gt;dev-&gt;name, hdr-&gt;addr2);</span>
<span class="cp">#endif</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">comm_tallies</span><span class="p">.</span><span class="n">rx_discards_wep_undecryptable</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">IEEE80211_FTYPE_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">stype</span> <span class="o">==</span> <span class="n">IEEE80211_STYPE_AUTH</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">keyidx</span> <span class="o">=</span> <span class="n">hostap_rx_frame_decrypt</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">crypt</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: failed to decrypt mgmt::auth &quot;</span>
			       <span class="s">&quot;from %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
			<span class="cm">/* TODO: could inform hostapd about this so that it</span>
<span class="cm">			 * could send auth failure report */</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hostap_rx_frame_mgmt</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">stype</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data frame - extract src/dst addresses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_DATA_HDR3_LEN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">IEEE80211_DATA_HDR4_LEN</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr4</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hostap_rx_frame_wds</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wds</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wds</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">wds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wds</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span>
	    <span class="n">IEEE80211_FCTL_FROMDS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">stadev</span> <span class="o">&amp;&amp;</span>
	    <span class="n">memcmp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">assoc_ap_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Frame from BSSID of the AP for which we are a client */</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">stadev</span><span class="p">;</span>
		<span class="n">from_assoc_ap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">||</span>
	     <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_REPEAT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">from_assoc_ap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hostap_handle_sta_rx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span>
					     <span class="n">wds</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AP_RX_CONTINUE_NOT_AUTHORIZED</span>:
			<span class="n">frame_authorized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RX_CONTINUE</span>:
			<span class="n">frame_authorized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RX_DROP</span>:
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AP_RX_EXIT</span>:
			<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Nullfunc frames may have PS-bit set, so they must be passed to</span>
<span class="cm">	 * hostap_handle_sta_rx() before being dropped here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFACK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFPOLL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_DATA_CFACKPOLL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stype</span> <span class="o">!=</span> <span class="n">IEEE80211_STYPE_NULLFUNC</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: RX: dropped data frame &quot;</span>
			       <span class="s">&quot;with no data (type=0x%02x, subtype=0x%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stype</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* skb: hdr + (possibly fragmented, possibly encrypted) payload */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">keyidx</span> <span class="o">=</span> <span class="n">hostap_rx_frame_decrypt</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">crypt</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* skb: hdr + (possibly fragmented) plaintext payload */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">frag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">flen</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">frag_skb</span> <span class="o">=</span>
			<span class="n">prism2_frag_cache_get</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frag_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Rx cannot get skb from &quot;</span>
			       <span class="s">&quot;fragment cache (morefrag=%d seq=%u frag=%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">sc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">frag</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">flen</span> <span class="o">-=</span> <span class="n">hdrlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="n">flen</span> <span class="o">&gt;</span> <span class="n">frag_skb</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: host decrypted and &quot;</span>
			       <span class="s">&quot;reassembled frame did not fit skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">prism2_frag_cache_invalidate</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frag</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy first fragment (including full headers) into</span>
<span class="cm">			 * beginning of the fragment cache skb */</span>
			<span class="n">skb_copy_from_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">frag_skb</span><span class="p">,</span> <span class="n">flen</span><span class="p">),</span>
						  <span class="n">flen</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* append frame payload to the end of the fragment</span>
<span class="cm">			 * cache skb */</span>
			<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span>
							 <span class="n">skb_put</span><span class="p">(</span><span class="n">frag_skb</span><span class="p">,</span>
								 <span class="n">flen</span><span class="p">),</span> <span class="n">flen</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_MOREFRAGS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* more fragments expected - leave the skb in fragment</span>
<span class="cm">			 * cache for now; it will be delivered to upper layers</span>
<span class="cm">			 * after all fragments have been received */</span>
			<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* this was the last fragment and the frame will be</span>
<span class="cm">		 * delivered, so remove skb from fragment cache */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">frag_skb</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">prism2_frag_cache_invalidate</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* skb: hdr + (possible reassembled) full MSDU payload; possibly still</span>
<span class="cm">	 * encrypted/authenticated */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">host_decrypt</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hostap_rx_frame_decrypt_msdu</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">keyidx</span><span class="p">,</span> <span class="n">crypt</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">open_wep</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ieee_802_1x</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hostap_is_eapol_frame</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* pass unencrypted EAPOL frames even if encryption is</span>
<span class="cm">			 * configured */</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA2</span><span class="p">,</span> <span class="s">&quot;%s: RX: IEEE 802.1X - passing &quot;</span>
			       <span class="s">&quot;unencrypted EAPOL frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: encryption configured, but RX &quot;</span>
			       <span class="s">&quot;frame not encrypted (SA=%pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">drop_unencrypted</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">hostap_is_eapol_frame</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dropped unencrypted RX data &quot;</span>
			       <span class="s">&quot;frame from %pM (drop_unencrypted=1)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* skb: hdr + (possible reassembled) full plaintext payload */</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="n">ethertype</span> <span class="o">=</span> <span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">payload</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="cm">/* If IEEE 802.1X is used, check whether the port is authorized to send</span>
<span class="cm">	 * the received frame. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ieee_802_1x</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ethertype</span> <span class="o">==</span> <span class="n">ETH_P_PAE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DEBUG_EXTRA2</span><span class="p">,</span> <span class="s">&quot;%s: RX: IEEE 802.1X frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">hostapd</span> <span class="o">&amp;&amp;</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Send IEEE 802.1X frames to the user</span>
<span class="cm">				 * space daemon for processing */</span>
				<span class="n">prism2_rx_80211</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">apdev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">rx_stats</span><span class="p">,</span>
						<span class="n">PRISM2_RX_MGMT</span><span class="p">);</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">apdevstats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">apdevstats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame_authorized</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: dropped frame from &quot;</span>
			       <span class="s">&quot;unauthorized port (IEEE 802.1X): &quot;</span>
			       <span class="s">&quot;ethertype=0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ethertype</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">rx_dropped</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* convert hdr + possible LLC headers into Ethernet header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdrlen</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">memcmp</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">rfc1042_header</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	      <span class="n">ethertype</span> <span class="o">!=</span> <span class="n">ETH_P_AARP</span> <span class="o">&amp;&amp;</span> <span class="n">ethertype</span> <span class="o">!=</span> <span class="n">ETH_P_IPX</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">memcmp</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">bridge_tunnel_header</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* remove RFC1042 or Bridge-Tunnel encapsulation and</span>
<span class="cm">		 * replace EtherType */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">__be16</span> <span class="n">len</span><span class="p">;</span>
		<span class="cm">/* Leave Ethernet header part of hdr and full payload */</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">src</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">),</span> <span class="n">dst</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wds</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IEEE80211_FCTL_TODS</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_FROMDS</span><span class="p">))</span> <span class="o">==</span>
		    <span class="n">IEEE80211_FCTL_TODS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">ETH_HLEN</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Non-standard frame: get addr4 from its bogus location after</span>
<span class="cm">		 * the payload */</span>
		<span class="n">skb_copy_from_linear_data_offset</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ETH_ALEN</span><span class="p">,</span>
						 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span>
						 <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wds</span> <span class="o">&amp;&amp;</span>
	    <span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridge_packets</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dst</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* copy multicast frame both to the higher layers and</span>
<span class="cm">			 * to the wireless media */</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridged_multicast</span><span class="o">++</span><span class="p">;</span>
			<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb_clone</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: skb_clone failed for &quot;</span>
				       <span class="s">&quot;multicast frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hostap_is_sta_authorized</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">,</span> <span class="n">dst</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* send frame directly to the associated STA using</span>
<span class="cm">			 * wireless media and not passing to higher layers */</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">bridged_unicast</span><span class="o">++</span><span class="p">;</span>
			<span class="n">skb2</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb2</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* send to wireless media */</span>
		<span class="n">skb2</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">skb2</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_802_3</span><span class="p">);</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
		<span class="n">skb_reset_network_header</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
		<span class="cm">/* skb2-&gt;network_header += ETH_HLEN; */</span>
		<span class="n">dev_queue_xmit</span><span class="p">(</span><span class="n">skb2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">));</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">rx_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">hostap_handle_sta_release</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">rx_dropped:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">rx_exit</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">hostap_80211_rx</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
