<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › prism54 › isl_ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>isl_ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2002 Intersil Americas Inc.</span>
<span class="cm"> *            (C) 2003,2004 Aurelien Alleaume &lt;slts@free.fr&gt;</span>
<span class="cm"> *            (C) 2003 Herbert Valerio Riedel &lt;hvr@gnu.org&gt;</span>
<span class="cm"> *            (C) 2003 Luis R. Rodriguez &lt;mcgrof@ruslug.rutgers.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/capability.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;prismcompat.h&quot;</span>
<span class="cp">#include &quot;isl_ioctl.h&quot;</span>
<span class="cp">#include &quot;islpci_mgt.h&quot;</span>
<span class="cp">#include &quot;isl_oid.h&quot;		</span><span class="cm">/* additional types and defs for isl38xx fw */</span><span class="cp"></span>
<span class="cp">#include &quot;oid_mgt.h&quot;</span>

<span class="cp">#include &lt;net/iw_handler.h&gt;	</span><span class="cm">/* New driver API */</span><span class="cp"></span>

<span class="cp">#define KEY_SIZE_WEP104 13	</span><span class="cm">/* 104/128-bit WEP keys */</span><span class="cp"></span>
<span class="cp">#define KEY_SIZE_WEP40  5	</span><span class="cm">/* 40/64-bit WEP keys */</span><span class="cp"></span>
<span class="cm">/* KEY_SIZE_TKIP should match isl_oid.h, struct obj_key.key[] size */</span>
<span class="cp">#define KEY_SIZE_TKIP   32	</span><span class="cm">/* TKIP keys */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">prism54_wpa_bss_ie_add</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">wpa_ie_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">size_t</span> <span class="n">prism54_wpa_bss_ie_get</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">wpa_ie</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">prism54_set_wpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="p">,</span>
				<span class="n">__u32</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* In 500 kbps */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">scan_rate_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>
						<span class="mi">12</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span>
						<span class="mi">48</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">108</span> <span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * prism54_mib_mode_helper - MIB change mode helper function</span>
<span class="cm"> * @mib: the &amp;struct islpci_mib object to modify</span>
<span class="cm"> * @iw_mode: new mode (%IW_MODE_*)</span>
<span class="cm"> *</span>
<span class="cm"> *  This is a helper function, hence it does not lock. Make sure</span>
<span class="cm"> *  caller deals with locking *if* necessary. This function sets the</span>
<span class="cm"> *  mode-dependent mib values and does the mapping of the Linux</span>
<span class="cm"> *  Wireless API modes to Device firmware modes. It also checks for</span>
<span class="cm"> *  correct valid Linux wireless modes.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_mib_mode_helper</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iw_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">config</span> <span class="o">=</span> <span class="n">INL_CONFIG_MANUALRUN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mode</span><span class="p">,</span> <span class="n">bsstype</span><span class="p">;</span>

	<span class="cm">/* For now, just catch early the Repeater and Secondary modes here */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_REPEAT</span> <span class="o">||</span> <span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_SECOND</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;%s(): Sorry, Repeater mode and Secondary mode &quot;</span>
		       <span class="s">&quot;are not yet supported by this driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">iw_mode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">iw_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_MODE_AUTO</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">INL_MODE_CLIENT</span><span class="p">;</span>
		<span class="n">bsstype</span> <span class="o">=</span> <span class="n">DOT11_BSSTYPE_ANY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">INL_MODE_CLIENT</span><span class="p">;</span>
		<span class="n">bsstype</span> <span class="o">=</span> <span class="n">DOT11_BSSTYPE_IBSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">INL_MODE_CLIENT</span><span class="p">;</span>
		<span class="n">bsstype</span> <span class="o">=</span> <span class="n">DOT11_BSSTYPE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_MASTER</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">INL_MODE_AP</span><span class="p">;</span>
		<span class="n">bsstype</span> <span class="o">=</span> <span class="n">DOT11_BSSTYPE_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IW_MODE_MONITOR</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">INL_MODE_PROMISCUOUS</span><span class="p">;</span>
		<span class="n">bsstype</span> <span class="o">=</span> <span class="n">DOT11_BSSTYPE_ANY</span><span class="p">;</span>
		<span class="n">config</span> <span class="o">|=</span> <span class="n">INL_CONFIG_RXANNEX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">init_wds</span><span class="p">)</span>
		<span class="n">config</span> <span class="o">|=</span> <span class="n">INL_CONFIG_WDS</span><span class="p">;</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_BSSTYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bsstype</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * prism54_mib_init - fill MIB cache with defaults</span>
<span class="cm"> *</span>
<span class="cm"> *  this function initializes the struct given as @mib with defaults,</span>
<span class="cm"> *  of which many are retrieved from the global module parameter</span>
<span class="cm"> *  variables.</span>
<span class="cm"> */</span>

<span class="kt">void</span>
<span class="nf">prism54_mib_init</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">channel</span><span class="p">,</span> <span class="n">authen</span><span class="p">,</span> <span class="n">wep</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">dot1x</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="n">conformance</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">obj_buffer</span> <span class="n">psm_buffer</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PSM_BUFFER_SIZE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_psm_buffer</span>
	<span class="p">};</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_CHANNEL</span><span class="p">;</span>
	<span class="n">authen</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_AUTHEN</span><span class="p">;</span>
	<span class="n">wep</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_WEP</span><span class="p">;</span>
	<span class="n">filter</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_FILTER</span><span class="p">;</span> <span class="cm">/* (0) Do not filter un-encrypted data */</span>
	<span class="n">dot1x</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_DOT1X</span><span class="p">;</span>
	<span class="n">mlme</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_MLME_MODE</span><span class="p">;</span>
	<span class="n">conformance</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_CONFORMANCE</span><span class="p">;</span>
	<span class="n">power</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_IW_MODE</span><span class="p">;</span>

	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">authen</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wep</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PSMBUFFER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">psm_buffer</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filter</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DOT1XENABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dot1x</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlme</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_DOT11D_CONFORMANCE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conformance</span><span class="p">);</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_OUTPUTPOWER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">power</span><span class="p">);</span>

	<span class="cm">/* This sets all of the mode-dependent values */</span>
	<span class="n">prism54_mib_mode_helper</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* this will be executed outside of atomic context thanks to</span>
<span class="cm"> * schedule_work(), thus we can as well use sleeping semaphore</span>
<span class="cm"> * locking */</span>
<span class="kt">void</span>
<span class="nf">prism54_update_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">islpci_private</span><span class="p">,</span> <span class="n">stats_work</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">obj_bss</span> <span class="n">bss</span><span class="p">,</span> <span class="o">*</span><span class="n">bss2</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>

<span class="cm">/* Noise floor.</span>
<span class="cm"> * I&#39;m not sure if the unit is dBm.</span>
<span class="cm"> * Note : If we are not connected, this value seems to be irrelevant. */</span>

	<span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_NOISEFLOOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_iwstatistics</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>

<span class="cm">/* Get the rssi of the link. To do this we need to retrieve a bss. */</span>

	<span class="cm">/* First get the MAC address of the AP we are associated with. */</span>
	<span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_BSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* copy this MAC to the bss */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">bss</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* now ask for the corresponding bss */</span>
	<span class="n">j</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_BSSFIND</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bss</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">bss2</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="cm">/* report the rssi and use it to calculate</span>
<span class="cm">	 *  link quality through a signal-noise</span>
<span class="cm">	 *  ratio */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_iwstatistics</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">bss2</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_iwstatistics</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span>
	    <span class="n">bss2</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iwstatistics</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">bss2</span><span class="p">);</span>

	<span class="cm">/* report that the stats are new */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_iwstatistics</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>

<span class="cm">/* Rx : unable to decrypt the MPDU */</span>
	<span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVRXFAILED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_iwstatistics</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>

<span class="cm">/* Tx : Max MAC retries num reached */</span>
	<span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MPDUTXFAILED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_iwstatistics</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span>
<span class="nf">prism54_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* If the stats are being updated return old data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iwstatistics</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_iwstatistics</span><span class="p">,</span>
		       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_statistics</span><span class="p">));</span>
		<span class="cm">/* They won&#39;t be marked updated for the next time */</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">local_iwstatistics</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats_lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iwstatistics</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Update our wireless stats, but do not schedule to often</span>
<span class="cm">	 * (max 1 HZ) */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats_timestamp</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats_work</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats_timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iwstatistics</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	       <span class="kt">char</span> <span class="o">*</span><span class="n">cwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="cm">/* simply re-set the last set SSID, this should commit most stuff */</span>

	<span class="cm">/* Commit in Monitor mode is not necessary, also setting essid</span>
<span class="cm">	 * in Monitor mode does not make sense and isn&#39;t allowed for this</span>
<span class="cm">	 * device&#39;s firmware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="kt">char</span> <span class="o">*</span><span class="n">cwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">capabilities</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">cwrq</span><span class="p">,</span> <span class="s">&quot;NOT READY!&quot;</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_PHYCAPABILITIES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">INL_PHYCAP_5000MHZ</span>:
		<span class="n">capabilities</span> <span class="o">=</span> <span class="s">&quot;IEEE 802.11a/b/g&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INL_PHYCAP_FAA</span>:
		<span class="n">capabilities</span> <span class="o">=</span> <span class="s">&quot;IEEE 802.11b/g - FAA Support&quot;</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">INL_PHYCAP_2400MHZ</span>:
	<span class="nl">default:</span>
		<span class="n">capabilities</span> <span class="o">=</span> <span class="s">&quot;IEEE 802.11b/g&quot;</span><span class="p">;</span>	<span class="cm">/* Default */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">cwrq</span><span class="p">,</span> <span class="n">capabilities</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="cm">/* we have a channel number */</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">channel_of_freq</span><span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">c</span> <span class="o">?</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_CHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">)</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Call commit handler */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rvalue</span> <span class="o">?</span> <span class="n">rvalue</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_CHANNEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">i</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_FREQUENCY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mlmeautolevel</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_MLME_MODE</span><span class="p">;</span>

	<span class="cm">/* Let&#39;s see if the user passed a valid Linux Wireless mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">uwrq</span> <span class="o">&gt;</span> <span class="n">IW_MODE_MONITOR</span> <span class="o">||</span> <span class="o">*</span><span class="n">uwrq</span> <span class="o">&lt;</span> <span class="n">IW_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;%s: %s() You passed a non-valid init_mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prism54_mib_mode_helper</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the ACL code needs an intermediate mlmeautolevel. The wpa stuff an</span>
<span class="cm">	 * extended one.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">uwrq</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">.</span><span class="n">policy</span> <span class="o">!=</span> <span class="n">MAC_POLICY_OPEN</span><span class="p">))</span>
		<span class="n">mlmeautolevel</span> <span class="o">=</span> <span class="n">DOT11_MLME_INTERMEDIATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">)</span>
		<span class="n">mlmeautolevel</span> <span class="o">=</span> <span class="n">DOT11_MLME_EXTENDED</span><span class="p">;</span>

	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlmeautolevel</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mgt_commit</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
	    <span class="o">?</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">:</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Use mib cache */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">&lt;</span> <span class="n">IW_MODE_AUTO</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">&gt;</span>
						  <span class="n">IW_MODE_MONITOR</span><span class="p">));</span>
	<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* we use DOT11_OID_EDTHRESHOLD. From what I guess the card will not try to</span>
<span class="cm"> * emit data if (sensitivity &gt; rssi - noise) (in dBm).</span>
<span class="cm"> * prism54_set_sens does not seem to work.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sens</span><span class="p">;</span>

	<span class="cm">/* by default  the card sets this to 20. */</span>
	<span class="n">sens</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">?</span> <span class="mi">20</span> <span class="o">:</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EDTHRESHOLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sens</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EDTHRESHOLD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>

	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">obj_frequencies</span> <span class="o">*</span><span class="n">freq</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">));</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">);</span>

	<span class="cm">/* set the wireless extension version number */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="n">SUPPORTED_WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>

	<span class="cm">/* Now the encoding capabilities */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* 64(40) bits WEP */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="cm">/* 128(104) bits WEP */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
	<span class="cm">/* 256 bits for WPA-PSK */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="cm">/* 4 keys are allowed */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* we don&#39;t know the quality range... */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* these value describe an average quality. Needs more tweaking... */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">80</span><span class="p">;</span>	<span class="cm">/* -80 dBm */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* don&#39;t know what to put here */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

	<span class="cm">/* retry limit capabilities */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_capa</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">r_time_flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>

	<span class="cm">/* I don&#39;t know the range. Put stupid things here */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_retry</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_r_time</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_r_time</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="cm">/* txpower is supported in dBm&#39;s */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower_capa</span> <span class="o">=</span> <span class="n">IW_TXPOW_DBM</span><span class="p">;</span>

	<span class="cm">/* Event capability (kernel + driver) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">IW_EVENT_CAPA_K_0</span> <span class="o">|</span>
	<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">)</span> <span class="o">|</span>
	<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">));</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_EVENT_CAPA_K_1</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">IWEVCUSTOM</span><span class="p">);</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">enc_capa</span> <span class="o">=</span> <span class="n">IW_ENC_CAPA_WPA</span> <span class="o">|</span> <span class="n">IW_ENC_CAPA_WPA2</span> <span class="o">|</span>
		<span class="n">IW_ENC_CAPA_CIPHER_TKIP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Request the device for the supported frequencies</span>
<span class="cm">	 * not really relevant since some devices will report the 5 GHz band</span>
<span class="cm">	 * frequencies even if they don&#39;t support them.</span>
<span class="cm">	 */</span>
	<span class="n">rvalue</span> <span class="o">=</span>
	    <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SUPPORTEDFREQUENCIES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">freq</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>

	<span class="n">m</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">IW_MAX_FREQUENCIES</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">m</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">mhz</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">channel_of_freq</span><span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">mhz</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">freq</span><span class="p">);</span>

	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SUPPORTEDRATES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* We got an array of char. It is NULL terminated. */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_MAX_BITRATES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*       the result must be in bps. The card gives us 500Kbps */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set AP address*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* prepare the structure for the set object */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="cm">/* set the bssid -- does this make sense when in AP mode? */</span>
	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_BSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bssid</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">rvalue</span> <span class="o">?</span> <span class="n">rvalue</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">);</span>	<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/* get AP address*/</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_BSSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* hehe the device does this automagicaly */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* a little helper that will translate our data into a card independent</span>
<span class="cm"> * format that the Wireless Tools will understand. This was inspired by</span>
<span class="cm"> * the &quot;Aironet driver for 4500 and 4800 series cards&quot; (GPL)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">prism54_translate_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		      <span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">end_buf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">obj_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">,</span>
		      <span class="kt">char</span> <span class="n">noise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_event</span> <span class="n">iwe</span><span class="p">;</span>	<span class="cm">/* Temporary buffer */</span>
	<span class="kt">short</span> <span class="n">cap</span><span class="p">;</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">wpa_ie</span><span class="p">[</span><span class="n">MAX_WPA_IE_LEN</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">wpa_ie_len</span><span class="p">;</span>

	<span class="cm">/* The first entry must be the MAC address */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span>

	<span class="cm">/* The following entries will be displayed in the same order we give them */</span>

	<span class="cm">/* The ESSID. */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">length</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">octets</span><span class="p">);</span>

	<span class="cm">/* Capabilities */</span>
<span class="cp">#define CAP_ESS 0x01</span>
<span class="cp">#define CAP_IBSS 0x02</span>
<span class="cp">#define CAP_CRYPT 0x10</span>

	<span class="cm">/* Mode */</span>
	<span class="n">cap</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">capinfo</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CAP_ESS</span><span class="p">)</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CAP_IBSS</span><span class="p">)</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">);</span>

	<span class="cm">/* Encryption capability */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CAP_CRYPT</span><span class="p">)</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Add frequency. (short) bss-&gt;channel is the frequency in MHz */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>

	<span class="cm">/* Add quality statistics */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">noise</span><span class="p">;</span>
	<span class="cm">/* do a simple SNR for quality */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">-</span> <span class="n">noise</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVQUAL</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">);</span>

	<span class="cm">/* Add WPA/RSN Information Element, if any */</span>
	<span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">prism54_wpa_bss_ie_get</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wpa_ie_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">wpa_ie_len</span><span class="p">,</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="n">MAX_WPA_IE_LEN</span><span class="p">);</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Do the bitrates */</span>
	<span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">current_val</span> <span class="o">=</span> <span class="n">current_ev</span> <span class="o">+</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWRATE</span><span class="p">;</span>
		<span class="cm">/* Those two flags are ignored... */</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Parse the bitmask */</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scan_rate_list</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">scan_rate_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">);</span>
				<span class="n">current_val</span> <span class="o">=</span> <span class="n">iwe_stream_add_value</span><span class="p">(</span>
					<span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">current_val</span><span class="p">,</span>
					<span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_PARAM_LEN</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check if we added any event */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">current_val</span> <span class="o">-</span> <span class="n">current_ev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
			<span class="n">current_ev</span> <span class="o">=</span> <span class="n">current_val</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">current_ev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">obj_bsslist</span> <span class="o">*</span><span class="n">bsslist</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* device is not ready, fail gently */</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* first get the noise value. We will use it to report the link quality */</span>
	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_NOISEFLOOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">noise</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>

	<span class="cm">/* Ask the device for a list of known bss.</span>
<span class="cm">	* The old API, using SIOCGIWAPLIST, had a hard limit of IW_MAX_AP=64.</span>
<span class="cm">	* The new API, using SIOCGIWSCAN, is only limited by the buffer size.</span>
<span class="cm">	* WE-14-&gt;WE-16, the buffer is limited to IW_SCAN_MAX_DATA bytes.</span>
<span class="cm">	* Starting with WE-17, the buffer can be as big as needed.</span>
<span class="cm">	* But the device won&#39;t repport anything if you change the value</span>
<span class="cm">	* of IWMAX_BSS=24. */</span>

	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_BSSLIST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">bsslist</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

	<span class="cm">/* ok now, scan the list and translate its info */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">bsslist</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">prism54_translate_bss</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						   <span class="n">extra</span> <span class="o">+</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="p">(</span><span class="n">bsslist</span><span class="o">-&gt;</span><span class="n">bsslist</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
						   <span class="n">noise</span><span class="p">);</span>

		<span class="cm">/* Check if there is space for one more entry */</span>
		<span class="k">if</span><span class="p">((</span><span class="n">extra</span> <span class="o">+</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">current_ev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ask user space to try again with a bigger buffer */</span>
			<span class="n">rvalue</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">bsslist</span><span class="p">);</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_ev</span> <span class="o">-</span> <span class="n">extra</span><span class="p">);</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* todo */</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">obj_ssid</span> <span class="n">essid</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">essid</span><span class="p">.</span><span class="n">octets</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">33</span><span class="p">);</span>

	<span class="cm">/* Check if we were asked for `any&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;&amp;</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
		<span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">essid</span><span class="p">.</span><span class="n">octets</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">essid</span><span class="p">);</span>

	<span class="cm">/* If in monitor mode, just save to mib */</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SSID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">essid</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">obj_ssid</span> <span class="o">*</span><span class="n">essid</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">essid</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">essid</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* set ESSID to ON for Wireless Extensions */</span>
		<span class="cm">/* if it is too big, trunk it */</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="n">IW_ESSID_MAX_SIZE</span><span class="p">,</span> <span class="n">essid</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">essid</span><span class="o">-&gt;</span><span class="n">octets</span><span class="p">[</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">essid</span><span class="o">-&gt;</span><span class="n">octets</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">essid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Provides no functionality, just completes the ioctl. In essence this is a</span>
<span class="cm"> * just a cosmetic ioctl.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nickname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nickname</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nickname</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nickname</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nickname</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the allowed Bitrates */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">,</span> <span class="n">profile</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* auto mode. No limit. */</span>
		<span class="n">profile</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PROFILES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">profile</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SUPPORTEDRATES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="mi">500000</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rate</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Now, check if we want a fixed or auto value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	i = 0;</span>
<span class="cm">	printk(&quot;prism54 rate: &quot;);</span>
<span class="cm">	while(data[i]) {</span>
<span class="cm">		printk(&quot;%u &quot;, data[i]);</span>
<span class="cm">		i++;</span>
<span class="cm">	}</span>
<span class="cm">	printk(&quot;0\n&quot;);</span>
<span class="cm">*/</span>
	<span class="n">profile</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PROFILES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">profile</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXTENDEDRATES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_RATES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the current bit rate */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* Get the current bit rate */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">GEN_OID_LINKSTATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>

	<span class="cm">/* request the device for the enabled rates */</span>
	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_RATES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rvalue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_RTSTHRESH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="cm">/* get the rts threshold */</span>
	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_RTSTHRESH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_FRAGTHRESH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_FRAGTHRESH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Here we have (min,max) = max retries for (small frames, big frames). Where</span>
<span class="cm"> * big frame &lt;=&gt;  bigger than the rts threshold</span>
<span class="cm"> * small frame &lt;=&gt;  smaller than the rts threshold</span>
<span class="cm"> * This is not really the behavior expected by the wireless tool but it seems</span>
<span class="cm"> * to be a common behavior in other drivers.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">slimit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">llimit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* short and long limit */</span>
	<span class="n">u32</span> <span class="n">lifetime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="cm">/* we cannot disable this feature */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_SHORT</span><span class="p">)</span>
			<span class="n">slimit</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span>
			<span class="n">llimit</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* we are asked to set both */</span>
			<span class="n">slimit</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
			<span class="n">llimit</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span>
		<span class="cm">/* Wireless tools use us unit while the device uses 1024 us unit */</span>
		<span class="n">lifetime</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="cm">/* now set what is requested */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slimit</span><span class="p">)</span>
		<span class="n">rvalue</span> <span class="o">=</span>
		    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SHORTRETRIES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">slimit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">llimit</span><span class="p">)</span>
		<span class="n">rvalue</span> <span class="o">|=</span>
		    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_LONGRETRIES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">llimit</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lifetime</span><span class="p">)</span>
		<span class="n">rvalue</span> <span class="o">|=</span>
		    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MAXTXLIFETIME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">lifetime</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* It cannot be disabled */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we are asked for the life time */</span>
		<span class="n">rvalue</span> <span class="o">=</span>
		    <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MAXTXLIFETIME</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* we are asked for the long retry limit */</span>
		<span class="n">rvalue</span> <span class="o">|=</span>
		    <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_LONGRETRIES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LONG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* default. get the  short retry limit */</span>
		<span class="n">rvalue</span> <span class="o">|=</span>
		    <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_SHORTRETRIES</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_SHORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rvalue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">force</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_OS</span><span class="p">,</span> <span class="n">invoke</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* with the new API, it&#39;s impossible to get a NULL pointer.</span>
<span class="cm">	 * New version of iwconfig set the IW_ENCODE_NOKEY flag</span>
<span class="cm">	 * when no key is given, but older versions don&#39;t. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we have a key to set */</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">current_index</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">obj_key</span> <span class="n">key</span> <span class="o">=</span> <span class="p">{</span> <span class="n">DOT11_PRIV_WEP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">};</span>

		<span class="cm">/* get the current key index */</span>
		<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="n">current_index</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
		<span class="cm">/* Verify that the key is not marked as invalid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">KEY_SIZE_TKIP</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* User-provided key data too big */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">KEY_SIZE_WEP104</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* WPA-PSK TKIP */</span>
				<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DOT11_PRIV_TKIP</span><span class="p">;</span>
				<span class="n">key</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">KEY_SIZE_TKIP</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">KEY_SIZE_WEP40</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* WEP 104/128 */</span>
				<span class="n">key</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">KEY_SIZE_WEP104</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* WEP 40/64 */</span>
				<span class="n">key</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">KEY_SIZE_WEP40</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
				<span class="cm">/* no index provided use the current one */</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">current_index</span><span class="p">;</span>

			<span class="cm">/* now send the key to the card  */</span>
			<span class="n">rvalue</span> <span class="o">|=</span>
			    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYX</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If a valid key is set, encryption should be enabled</span>
<span class="cm">		 * (user may turn it off later).</span>
<span class="cm">		 * This is also how &quot;iwconfig ethX key on&quot; works</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">==</span> <span class="n">current_index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
			<span class="n">force</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* we want to set the key index */</span>
			<span class="n">rvalue</span> <span class="o">|=</span>
			    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">index</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_MODE</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* we cannot do anything. Complain. */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* now read the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Encoding disabled,</span>
<span class="cm">		 * authen = DOT11_AUTH_OS;</span>
<span class="cm">		 * invoke = 0;</span>
<span class="cm">		 * exunencrypt = 0; */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span>
		<span class="cm">/* Encode but accept non-encoded packets. No auth */</span>
		<span class="n">invoke</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span> <span class="o">||</span> <span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Refuse non-encoded packets. Auth */</span>
		<span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_BOTH</span><span class="p">;</span>
		<span class="n">invoke</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* do the change if requested  */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_MODE</span><span class="p">)</span> <span class="o">||</span> <span class="n">force</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rvalue</span> <span class="o">|=</span>
		    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">authen</span><span class="p">);</span>
		<span class="n">rvalue</span> <span class="o">|=</span>
		    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">invoke</span><span class="p">);</span>
		<span class="n">rvalue</span> <span class="o">|=</span>
		    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">exunencrypt</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">obj_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">devindex</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">authen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">invoke</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* first get the flags */</span>
	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">authen</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">invoke</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">exunencrypt</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">invoke</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">authen</span> <span class="o">==</span> <span class="n">DOT11_AUTH_BOTH</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">exunencrypt</span><span class="p">)</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">authen</span> <span class="o">==</span> <span class="n">DOT11_AUTH_OS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">exunencrypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">invoke</span><span class="p">)</span>
			<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* The card should not work in this state */</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* get the current device key index */</span>
	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">devindex</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="cm">/* Now get the key, return it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="cm">/* no index provided, use the current one */</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">devindex</span><span class="p">;</span>
	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYX</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">key</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
	<span class="cm">/* return the used key index */</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">devindex</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_OUTPUTPOWER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="cm">/* intersil firmware operates in 0.25 dBm (1/4 dBm) */</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* radio is not turned of</span>
<span class="cm">	 * btw: how is possible to turn off only the radio</span>
<span class="cm">	 */</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_txpower</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">u</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="cm">/* intersil firmware operates in 0.25 dBm (1/4) */</span>
	<span class="n">u</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t know how to disable radio */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;%s: %s() disabling radio is not yet supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span><span class="p">)</span>
		<span class="cm">/* currently only fixed value is supported */</span>
		<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_OUTPUTPOWER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;%s: %s() auto power will be implemented later.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism54_set_genie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">alen</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">obj_attachment</span> <span class="o">*</span><span class="n">attach</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="n">extra</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

	<span class="n">alen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">attach</span><span class="p">)</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="n">attach</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">alen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">attach</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cp">#define WLAN_FC_TYPE_MGMT 0</span>
<span class="cp">#define WLAN_FC_STYPE_ASSOC_REQ 0</span>
<span class="cp">#define WLAN_FC_STYPE_REASSOC_REQ 2</span>

	<span class="cm">/* Note: endianness is covered by mgt_set_varlen */</span>
	<span class="n">attach</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">WLAN_FC_TYPE_MGMT</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
               <span class="p">(</span><span class="n">WLAN_FC_STYPE_ASSOC_REQ</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">attach</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">attach</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">attach</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_varlen</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_ATTACHMENT</span><span class="p">,</span> <span class="n">attach</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attach</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">WLAN_FC_TYPE_MGMT</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">WLAN_FC_STYPE_REASSOC_REQ</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_varlen</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_ATTACHMENT</span><span class="p">,</span> <span class="n">attach</span><span class="p">,</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: WPA IE Attachment was set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">attach</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism54_get_genie</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism54_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mlmelevel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">authen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dot1x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">privinvoked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_wpa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* first get the flags */</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">wpa</span> <span class="o">=</span> <span class="n">old_wpa</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">authen</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">privinvoked</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">exunencrypt</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DOT1XENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">dot1x</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">mlmelevel</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="cm">/* Do the same thing as IW_AUTH_WPA_VERSION */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wpa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">privinvoked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* For privacy invoked */</span>
			<span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Filter out all unencrypted frames */</span>
			<span class="n">dot1x</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* To enable eap filter */</span>
			<span class="n">mlmelevel</span> <span class="o">=</span> <span class="n">DOT11_MLME_EXTENDED</span><span class="p">;</span>
			<span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_OS</span><span class="p">;</span> <span class="cm">/* Only WEP uses _SK and _BOTH */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">privinvoked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Do not filter un-encrypted data */</span>
			<span class="n">dot1x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mlmelevel</span> <span class="o">=</span> <span class="n">DOT11_MLME_AUTO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_WPA_VERSION_DISABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">privinvoked</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Do not filter un-encrypted data */</span>
			<span class="n">dot1x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mlmelevel</span> <span class="o">=</span> <span class="n">DOT11_MLME_AUTO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_WPA_VERSION_WPA</span><span class="p">)</span>
				<span class="n">wpa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_WPA_VERSION_WPA2</span><span class="p">)</span>
				<span class="n">wpa</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">privinvoked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* For privacy invoked */</span>
			<span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Filter out all unencrypted frames */</span>
			<span class="n">dot1x</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* To enable eap filter */</span>
			<span class="n">mlmelevel</span> <span class="o">=</span> <span class="n">DOT11_MLME_EXTENDED</span><span class="p">;</span>
			<span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_OS</span><span class="p">;</span> <span class="cm">/* Only WEP uses _SK and _BOTH */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="cm">/* dot1x should be the opposite of RX_UNENCRYPTED_EAPOL;</span>
<span class="cm">		 * turn off dot1x when allowing receipt of unencrypted EAPOL</span>
<span class="cm">		 * frames, turn on dot1x when receipt should be disallowed</span>
<span class="cm">		 */</span>
		<span class="n">dot1x</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="n">privinvoked</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="n">exunencrypt</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Only WEP uses _SK and _BOTH */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">wpa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_SK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_OS</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set all the values */</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span> <span class="o">=</span> <span class="n">wpa</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">authen</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">privinvoked</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exunencrypt</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DOT1XENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dot1x</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlmelevel</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism54_get_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* first get the flags */</span>
	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">wpa</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
		<span class="cm">/*</span>
<span class="cm">		 * wpa_supplicant will control these internally</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">wpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_WPA_VERSION_WPA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_WPA_VERSION_WPA2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>:
		<span class="nl">default:</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_WPA_VERSION_DISABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">DOT11_AUTH_OS</span>:
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DOT11_AUTH_BOTH</span>:
			<span class="k">case</span> <span class="n">DOT11_AUTH_SK</span>:
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">DOT11_AUTH_NONE</span>:
			<span class="nl">default:</span>
				<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">wpa</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DOT1XENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism54_set_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">alg</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">,</span> <span class="n">set_key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_OS</span><span class="p">,</span> <span class="n">invoke</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Determine and validate the key index */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span>
		<span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only set transmit key index here, actual</span>
<span class="cm">		 * key is set below if needed.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">set_key</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">obj_key</span> <span class="n">key</span> <span class="o">=</span> <span class="p">{</span> <span class="n">DOT11_PRIV_WEP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">};</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_NONE</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_WEP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">KEY_SIZE_WEP104</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">KEY_SIZE_WEP40</span><span class="p">)</span>
				<span class="n">key</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">KEY_SIZE_WEP104</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">key</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">KEY_SIZE_WEP40</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_TKIP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">KEY_SIZE_TKIP</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">key</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">DOT11_PRIV_TKIP</span><span class="p">;</span>
			<span class="n">key</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">KEY_SIZE_TKIP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYX</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">key</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Read the flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Encoding disabled,</span>
<span class="cm">		 * authen = DOT11_AUTH_OS;</span>
<span class="cm">		 * invoke = 0;</span>
<span class="cm">		 * exunencrypt = 0; */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Encode but accept non-encoded packets. No auth */</span>
		<span class="n">invoke</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Refuse non-encoded packets. Auth */</span>
		<span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_BOTH</span><span class="p">;</span>
		<span class="n">invoke</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* do the change if requested  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">authen</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">invoke</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">exunencrypt</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">prism54_get_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				 <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_key_len</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_OS</span><span class="p">,</span> <span class="n">invoke</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">exunencrypt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wpa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* first get the flags */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">authen</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">invoke</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">exunencrypt</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">max_key_len</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idx</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">u</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">authen</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">DOT11_AUTH_BOTH</span>:
	<span class="k">case</span> <span class="n">DOT11_AUTH_SK</span>:
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DOT11_AUTH_OS</span>:
	<span class="nl">default:</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">wpa</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">;</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">authen</span> <span class="o">==</span> <span class="n">DOT11_AUTH_OS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">exunencrypt</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">invoke</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No encryption */</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">obj_key</span> <span class="o">*</span><span class="n">key</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DEFKEYX</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">key</span> <span class="o">=</span> <span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">DOT11_PRIV_TKIP</span>:
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_TKIP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">DOT11_PRIV_WEP</span>:
			<span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_WEP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
	      <span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_reset</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_oid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">oid_res_t</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_get_request</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">);</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">mgt_response_to_str</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OID_TYPE_U32</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">.</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_u32</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">oid</span> <span class="o">=</span> <span class="n">uwrq</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span> <span class="o">=</span> <span class="n">uwrq</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span> <span class="n">oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">oid</span> <span class="o">=</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span> <span class="n">oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">prism54_acl_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">);</span>
	<span class="n">acl</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acl</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">=</span> <span class="n">MAC_POLICY_OPEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">prism54_clear_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">next</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	     <span class="n">ptr</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">;</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">next</span><span class="p">,</span> <span class="n">next</span> <span class="o">=</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mac_entry</span><span class="p">,</span> <span class="n">_list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">acl</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">prism54_acl_clean</span><span class="p">(</span><span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">prism54_clear_mac</span><span class="p">(</span><span class="n">acl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_add_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">mac_entry</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">);</span>
	<span class="n">acl</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_del_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span> <span class="n">_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">_list</span><span class="p">);</span>
			<span class="n">acl</span><span class="o">-&gt;</span><span class="n">size</span><span class="o">--</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>

	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span> <span class="n">_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">dst</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dst</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Setting policy also clears the MAC acl, even if we don&#39;t change the default</span>
<span class="cm"> * policy</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		   <span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mlmeautolevel</span><span class="p">;</span>

	<span class="n">prism54_clear_mac</span><span class="p">(</span><span class="n">acl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">uwrq</span> <span class="o">&lt;</span> <span class="n">MAC_POLICY_OPEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">uwrq</span> <span class="o">&gt;</span> <span class="n">MAC_POLICY_REJECT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="n">acl</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">=</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">;</span>

	<span class="cm">/* the ACL code needs an intermediate mlmeautolevel */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">!=</span> <span class="n">MAC_POLICY_OPEN</span><span class="p">))</span>
		<span class="n">mlmeautolevel</span> <span class="o">=</span> <span class="n">DOT11_MLME_INTERMEDIATE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mlmeautolevel</span> <span class="o">=</span> <span class="n">CARD_DEFAULT_MLME_MODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">)</span>
		<span class="n">mlmeautolevel</span> <span class="o">=</span> <span class="n">DOT11_MLME_EXTENDED</span><span class="p">;</span>
	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlmeautolevel</span><span class="p">);</span>
	<span class="cm">/* restart the card with our new policy */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mgt_commit</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		   <span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">;</span>

	<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="n">acl</span><span class="o">-&gt;</span><span class="n">policy</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Return 1 only if client should be accepted. */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_mac_accept</span><span class="p">(</span><span class="k">struct</span> <span class="n">islpci_acl</span> <span class="o">*</span><span class="n">acl</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mac_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">==</span> <span class="n">MAC_POLICY_OPEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span> <span class="n">_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">res</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">policy</span> <span class="o">==</span> <span class="n">MAC_POLICY_ACCEPT</span><span class="p">)</span> <span class="o">?</span> <span class="o">!</span><span class="n">res</span> <span class="o">:</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">acl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_kick_all</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="n">mlme</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_mlme</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlme</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Tell the card to kick every client */</span>
	<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rvalue</span> <span class="o">=</span>
	    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span> <span class="n">DOT11_OID_DISASSOCIATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mlme</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mlme</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_kick_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">mlme</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_mlme</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mlme</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Tell the card to only kick the corresponding bastard */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">rvalue</span> <span class="o">=</span>
	    <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span> <span class="n">DOT11_OID_DISASSOCIATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mlme</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mlme</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Translate a TRAP oid into a wireless event. Called in islpci_mgt_receive. */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">format_event</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span>
	     <span class="k">const</span> <span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">IW_CUSTOM_MAX</span><span class="p">,</span>
			 <span class="s">&quot;%s %s %pM %s (%2.2X)&quot;</span><span class="p">,</span>
			 <span class="n">str</span><span class="p">,</span>
			 <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;from&quot;</span> <span class="o">:</span> <span class="s">&quot;to&quot;</span><span class="p">),</span>
			 <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
			 <span class="p">(</span><span class="n">error</span> <span class="o">?</span> <span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">?</span> <span class="s">&quot; : REJECTED &quot;</span> <span class="o">:</span> <span class="s">&quot; : ACCEPTED &quot;</span><span class="p">)</span>
			  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="n">IW_CUSTOM_MAX</span><span class="p">);</span>
	<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">send_formatted_event</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">memptr</span><span class="p">;</span>

	<span class="n">memptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">IW_CUSTOM_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memptr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">memptr</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">format_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">memptr</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
		     <span class="n">error</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">IWEVCUSTOM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="n">memptr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">memptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">send_simple_event</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">memptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="n">memptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">IW_CUSTOM_MAX</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memptr</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">IW_CUSTOM_MAX</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">pointer</span> <span class="o">=</span> <span class="n">memptr</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">memptr</span><span class="p">,</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">IWEVCUSTOM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="n">memptr</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">memptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">link_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bitrate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitrate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">uwrq</span><span class="p">;</span>
			<span class="n">prism54_get_wap</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">uwrq</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">);</span>
			<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uwrq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">send_simple_event</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span>
					  <span class="s">&quot;Link established&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
		<span class="n">send_simple_event</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span> <span class="s">&quot;Link lost&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Beacon/ProbeResp payload header */</span>
<span class="k">struct</span> <span class="n">ieee80211_beacon_phdr</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">timestamp</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">beacon_int</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">capab_info</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cp">#define WLAN_EID_GENERIC 0xdd</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">wpa_oid</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">prism54_wpa_bss_ie_add</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="o">*</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">wpa_ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">islpci_bss_wpa_ie</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wpa_ie_len</span> <span class="o">&gt;</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">)</span>
		<span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">MAX_WPA_IE_LEN</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_lock</span><span class="p">);</span>

	<span class="cm">/* try to use existing entry */</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_wpa_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">islpci_bss_wpa_ie</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">list_move</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_wpa_list</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* add a new BSS entry; if max number of entries is already</span>
<span class="cm">		 * reached, replace the least recently updated */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_bss_wpa</span> <span class="o">&gt;=</span> <span class="n">MAX_BSS_WPA_IE_COUNT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_wpa_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">islpci_bss_wpa_ie</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">bss</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="o">*</span><span class="n">bss</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_bss_wpa</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_wpa_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">,</span> <span class="n">wpa_ie_len</span><span class="p">);</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">wpa_ie_len</span><span class="p">;</span>
		<span class="n">bss</span><span class="o">-&gt;</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Failed to add BSS WPA entry for &quot;</span>
		       <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* expire old entries from WPA list */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_bss_wpa</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_wpa_list</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">islpci_bss_wpa_ie</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">last_update</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">num_bss_wpa</span><span class="o">--</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">size_t</span>
<span class="nf">prism54_wpa_bss_ie_get</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">wpa_ie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">islpci_bss_wpa_ie</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_lock</span><span class="p">);</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_wpa_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">islpci_bss_wpa_ie</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">bss</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">wpa_ie</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">prism54_wpa_bss_ie_init</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_wpa_list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">prism54_wpa_bss_ie_clean</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">islpci_bss_wpa_ie</span> <span class="o">*</span><span class="n">bss</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">bss</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bss_wpa_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">prism54_process_bss_data</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">oid</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_beacon_phdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pos</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_beacon_phdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">payload</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">hdr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">end</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">pos</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Parsing Beacon/ProbeResp failed &quot;</span>
			       <span class="s">&quot;for %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_EID_GENERIC</span> <span class="o">&amp;&amp;</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
		    <span class="n">memcmp</span><span class="p">(</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">wpa_oid</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">prism54_wpa_bss_ie_add</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_request</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span><span class="p">,</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">oid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DOT11_STATE_AUTHING</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">DOT11_STATE_ASSOCING</span><span class="p">))</span>
	    <span class="o">&amp;&amp;</span> <span class="n">mgt_mlme_answer</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Someone is requesting auth and we must respond. Just send back</span>
<span class="cm">		 * the trap with error code set accordingly.</span>
<span class="cm">		 */</span>
		<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">prism54_mac_accept</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">acl</span><span class="p">,</span>
						<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mlme</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_process_trap_helper</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">oid</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">obj_mlmeex</span> <span class="o">*</span><span class="n">mlmeex</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_mlmeex</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">obj_mlmeex</span> <span class="o">*</span><span class="n">confirm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wpa_ie</span><span class="p">[</span><span class="n">MAX_WPA_IE_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">wpa_ie_len</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* u16, better? */</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* I think all trapable objects are listed here.</span>
<span class="cm">	 * Some oids have a EX version. The difference is that they are emitted</span>
<span class="cm">	 * in DOT11_MLME_EXTENDED mode (set with DOT11_OID_MLMEAUTOLEVEL)</span>
<span class="cm">	 * with more info.</span>
<span class="cm">	 * The few events already defined by the wireless tools are not really</span>
<span class="cm">	 * suited. We use the more flexible custom event facility.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oid</span> <span class="o">&gt;=</span> <span class="n">DOT11_OID_BEACON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="n">payload</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* I fear prism54_process_bss_data won&#39;t work with big endian data */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">oid</span> <span class="o">==</span> <span class="n">DOT11_OID_BEACON</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">oid</span> <span class="o">==</span> <span class="n">DOT11_OID_PROBE</span><span class="p">))</span>
		<span class="n">prism54_process_bss_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span>
					 <span class="n">payload</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">mgt_le_to_cpu</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">oid</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">mlme</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">oid</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">GEN_OID_LINKSTATE</span>:
		<span class="n">link_changed</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_MICFAILURE</span>:
		<span class="n">send_simple_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Mic failure&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_DEAUTHENTICATE</span>:
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;DeAuthenticate request&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_AUTHENTICATE</span>:
		<span class="n">handle_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="n">oid</span><span class="p">);</span>
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Authenticate request&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_DISASSOCIATE</span>:
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Disassociate request&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_ASSOCIATE</span>:
		<span class="n">handle_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="n">oid</span><span class="p">);</span>
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Associate request&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_REASSOCIATE</span>:
		<span class="n">handle_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="n">oid</span><span class="p">);</span>
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;ReAssociate request&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_BEACON</span>:
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
				     <span class="s">&quot;Received a beacon from an unknown AP&quot;</span><span class="p">,</span>
				     <span class="n">mlme</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_PROBE</span>:
		<span class="cm">/* we received a probe from a client. */</span>
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Received a probe from client&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span>
				     <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Note : &quot;mlme&quot; is actually a &quot;struct obj_mlmeex *&quot; here, but this</span>
<span class="cm">		 * is backward compatible layout-wise with &quot;struct obj_mlme&quot;.</span>
<span class="cm">		 */</span>

	<span class="k">case</span> <span class="n">DOT11_OID_DEAUTHENTICATEEX</span>:
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;DeAuthenticate request&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_AUTHENTICATEEX</span>:
		<span class="n">handle_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="n">oid</span><span class="p">);</span>
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Authenticate request (ex)&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span>
				<span class="o">&amp;&amp;</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DOT11_STATE_AUTHING</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">confirm</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">obj_mlmeex</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">confirm</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">confirm</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Authenticate from: address:</span><span class="se">\t</span><span class="s">%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* or mlmeex-&gt;id ? */</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not used */</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_varlen</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_ASSOCIATEEX</span><span class="p">,</span> <span class="n">confirm</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">confirm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_DISASSOCIATEEX</span>:
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Disassociate request (ex)&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_ASSOCIATEEX</span>:
		<span class="n">handle_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="n">oid</span><span class="p">);</span>
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Associate request (ex)&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span>
				<span class="o">&amp;&amp;</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DOT11_STATE_ASSOCING</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">confirm</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">obj_mlmeex</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">confirm</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">confirm</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">obj_mlmeex</span> <span class="o">*</span><span class="p">)</span><span class="n">mlme</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not used */</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">prism54_wpa_bss_ie_get</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wpa_ie_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;No WPA IE found from address:</span><span class="se">\t</span><span class="s">%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">confirm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">wpa_ie_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">confirm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">,</span> <span class="n">wpa_ie_len</span><span class="p">);</span>

		<span class="n">mgt_set_varlen</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">confirm</span><span class="p">,</span> <span class="n">wpa_ie_len</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">confirm</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">DOT11_OID_REASSOCIATEEX</span>:
		<span class="n">handle_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="n">oid</span><span class="p">);</span>
		<span class="n">send_formatted_event</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="s">&quot;Reassociate request (ex)&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MASTER</span>
				<span class="o">&amp;&amp;</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">DOT11_STATE_ASSOCING</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">confirm</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">obj_mlmeex</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">confirm</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">confirm</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not used */</span>
		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">wpa_ie_len</span> <span class="o">=</span> <span class="n">prism54_wpa_bss_ie_get</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wpa_ie_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;No WPA IE found from address:</span><span class="se">\t</span><span class="s">%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">mlmeex</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">confirm</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">confirm</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">wpa_ie_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">confirm</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">wpa_ie</span><span class="p">,</span> <span class="n">wpa_ie_len</span><span class="p">);</span>

		<span class="n">mgt_set_varlen</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">confirm</span><span class="p">,</span> <span class="n">wpa_ie_len</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">confirm</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process a device trap.  This is called via schedule_work(), outside of</span>
<span class="cm"> * interrupt context, no locks held.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">prism54_process_trap</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">islpci_mgmtframe</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">islpci_mgmtframe</span><span class="p">,</span> <span class="n">ws</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">n</span> <span class="o">=</span> <span class="n">mgt_oidtonum</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">oid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">!=</span> <span class="n">OID_NUM_LAST</span><span class="p">)</span>
		<span class="n">prism54_process_trap_helper</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">),</span> <span class="n">n</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">frame</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">prism54_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">GEN_OID_MACADDRESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span>
		       <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define PRISM54_SET_WPA			SIOCIWFIRSTPRIV+12</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_wpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mlme</span><span class="p">,</span> <span class="n">authen</span><span class="p">,</span> <span class="n">dot1x</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">wep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* For privacy invoked */</span>
	<span class="n">filter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Filter out all unencrypted frames */</span>
	<span class="n">dot1x</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* To enable eap filter */</span>
	<span class="n">mlme</span> <span class="o">=</span> <span class="n">DOT11_MLME_EXTENDED</span><span class="p">;</span>
	<span class="n">authen</span> <span class="o">=</span> <span class="n">DOT11_AUTH_OS</span><span class="p">;</span> <span class="cm">/* Only WEP uses _SK and _BOTH */</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span> <span class="o">=</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* Clears/disables WPA and friends */</span>
			<span class="n">wep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Do not filter un-encrypted data */</span>
			<span class="n">dot1x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mlme</span> <span class="o">=</span> <span class="n">DOT11_MLME_AUTO</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Disabling WPA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* WPA */</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Enabling WPA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">authen</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wep</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filter</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_DOT1XENABLE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dot1x</span><span class="p">);</span>
	<span class="n">mgt_set_request</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mlme</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_wpa</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_prismhdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		     <span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">=</span>
	    <span class="p">(</span><span class="o">*</span><span class="n">uwrq</span> <span class="o">?</span> <span class="n">ARPHRD_IEEE80211_PRISM</span> <span class="o">:</span> <span class="n">ARPHRD_IEEE80211</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">monitor_type</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_get_prismhdr</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		     <span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">monitor_type</span> <span class="o">==</span> <span class="n">ARPHRD_IEEE80211_PRISM</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_debug_oid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		  <span class="n">__u32</span> <span class="o">*</span> <span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_oid</span> <span class="o">=</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: oid 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_debug_get_oid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">islpci_mgmtframe</span> <span class="o">*</span><span class="n">response</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: get_oid 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_oid</span><span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">islpci_mgt_transaction</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">PIMFOR_OP_GET</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_oid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ret: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="o">!</span><span class="n">response</span>
		    <span class="o">||</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">==</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: len: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_debug_set_oid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">islpci_mgmtframe</span> <span class="o">*</span><span class="n">response</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">response_op</span> <span class="o">=</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: set_oid 0x%08X</span><span class="se">\t</span><span class="s">len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_oid</span><span class="p">,</span>
	       <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">islpci_mgt_transaction</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">PIMFOR_OP_SET</span><span class="p">,</span>
					   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv_oid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: ret: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="o">!</span><span class="n">response</span>
		    <span class="o">||</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">==</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: EIO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">response_op</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: response_op: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">response_op</span><span class="p">);</span>
			<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">prism54_set_spy</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ndev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
		<span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">ndev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">u</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">oid</span> <span class="o">=</span> <span class="n">OID_INL_CONFIG</span><span class="p">;</span>

	<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">mgt_get</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">uwrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="cm">/* disable spy */</span>
		<span class="n">u</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">INL_CONFIG_RXANNEX</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">uwrq</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="cm">/* enable spy */</span>
		<span class="n">u</span> <span class="o">|=</span> <span class="n">INL_CONFIG_RXANNEX</span><span class="p">;</span>

	<span class="n">mgt_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">OID_INL_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>
	<span class="n">mgt_commit_list</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">iw_handler_set_spy</span><span class="p">(</span><span class="n">ndev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">uwrq</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">prism54_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_commit</span><span class="p">,</span>	<span class="cm">/* SIOCSIWCOMMIT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_name</span><span class="p">,</span>	<span class="cm">/* SIOCGIWNAME */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCSIWNWID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCGIWNWID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_freq</span><span class="p">,</span>	<span class="cm">/* SIOCSIWFREQ */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_freq</span><span class="p">,</span>	<span class="cm">/* SIOCGIWFREQ */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_mode</span><span class="p">,</span>	<span class="cm">/* SIOCSIWMODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_mode</span><span class="p">,</span>	<span class="cm">/* SIOCGIWMODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_sens</span><span class="p">,</span>	<span class="cm">/* SIOCSIWSENS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_sens</span><span class="p">,</span>	<span class="cm">/* SIOCGIWSENS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCSIWRANGE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_range</span><span class="p">,</span>	<span class="cm">/* SIOCGIWRANGE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCSIWPRIV */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCGIWPRIV */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCSIWSTATS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCGIWSTATS */</span>
	<span class="n">prism54_set_spy</span><span class="p">,</span>	<span class="cm">/* SIOCSIWSPY */</span>
	<span class="n">iw_handler_get_spy</span><span class="p">,</span>	<span class="cm">/* SIOCGIWSPY */</span>
	<span class="n">iw_handler_set_thrspy</span><span class="p">,</span>	<span class="cm">/* SIOCSIWTHRSPY */</span>
	<span class="n">iw_handler_get_thrspy</span><span class="p">,</span>	<span class="cm">/* SIOCGIWTHRSPY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_wap</span><span class="p">,</span>	<span class="cm">/* SIOCSIWAP */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_wap</span><span class="p">,</span>	<span class="cm">/* SIOCGIWAP */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCGIWAPLIST deprecated */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_scan</span><span class="p">,</span>	<span class="cm">/* SIOCSIWSCAN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_scan</span><span class="p">,</span>	<span class="cm">/* SIOCGIWSCAN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_essid</span><span class="p">,</span>	<span class="cm">/* SIOCSIWESSID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_essid</span><span class="p">,</span>	<span class="cm">/* SIOCGIWESSID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_nick</span><span class="p">,</span>	<span class="cm">/* SIOCSIWNICKN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_nick</span><span class="p">,</span>	<span class="cm">/* SIOCGIWNICKN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_rate</span><span class="p">,</span>	<span class="cm">/* SIOCSIWRATE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_rate</span><span class="p">,</span>	<span class="cm">/* SIOCGIWRATE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_rts</span><span class="p">,</span>	<span class="cm">/* SIOCSIWRTS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_rts</span><span class="p">,</span>	<span class="cm">/* SIOCGIWRTS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_frag</span><span class="p">,</span>	<span class="cm">/* SIOCSIWFRAG */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_frag</span><span class="p">,</span>	<span class="cm">/* SIOCGIWFRAG */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_txpower</span><span class="p">,</span>	<span class="cm">/* SIOCSIWTXPOW */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_txpower</span><span class="p">,</span>	<span class="cm">/* SIOCGIWTXPOW */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_retry</span><span class="p">,</span>	<span class="cm">/* SIOCSIWRETRY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_retry</span><span class="p">,</span>	<span class="cm">/* SIOCGIWRETRY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_encode</span><span class="p">,</span>	<span class="cm">/* SIOCSIWENCODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_encode</span><span class="p">,</span>	<span class="cm">/* SIOCGIWENCODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCSIWPOWER */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>	<span class="cm">/* SIOCGIWPOWER */</span>
	<span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_genie</span><span class="p">,</span>	<span class="cm">/* SIOCSIWGENIE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_genie</span><span class="p">,</span>	<span class="cm">/* SIOCGIWGENIE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_auth</span><span class="p">,</span>	<span class="cm">/* SIOCSIWAUTH */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_auth</span><span class="p">,</span>	<span class="cm">/* SIOCGIWAUTH */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_encodeext</span><span class="p">,</span> <span class="cm">/* SIOCSIWENCODEEXT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_encodeext</span><span class="p">,</span> <span class="cm">/* SIOCGIWENCODEEXT */</span>
	<span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWPMKSA */</span>
<span class="p">};</span>

<span class="cm">/* The low order bit identify a SET (0) or a GET (1) ioctl.  */</span>

<span class="cp">#define PRISM54_RESET		SIOCIWFIRSTPRIV</span>
<span class="cp">#define PRISM54_GET_POLICY	SIOCIWFIRSTPRIV+1</span>
<span class="cp">#define PRISM54_SET_POLICY	SIOCIWFIRSTPRIV+2</span>
<span class="cp">#define PRISM54_GET_MAC		SIOCIWFIRSTPRIV+3</span>
<span class="cp">#define PRISM54_ADD_MAC		SIOCIWFIRSTPRIV+4</span>

<span class="cp">#define PRISM54_DEL_MAC		SIOCIWFIRSTPRIV+6</span>

<span class="cp">#define PRISM54_KICK_MAC	SIOCIWFIRSTPRIV+8</span>

<span class="cp">#define PRISM54_KICK_ALL	SIOCIWFIRSTPRIV+10</span>

<span class="cp">#define PRISM54_GET_WPA		SIOCIWFIRSTPRIV+11</span>
<span class="cp">#define PRISM54_SET_WPA		SIOCIWFIRSTPRIV+12</span>

<span class="cp">#define PRISM54_DBG_OID		SIOCIWFIRSTPRIV+14</span>
<span class="cp">#define PRISM54_DBG_GET_OID	SIOCIWFIRSTPRIV+15</span>
<span class="cp">#define PRISM54_DBG_SET_OID	SIOCIWFIRSTPRIV+16</span>

<span class="cp">#define PRISM54_GET_OID		SIOCIWFIRSTPRIV+17</span>
<span class="cp">#define PRISM54_SET_OID_U32	SIOCIWFIRSTPRIV+18</span>
<span class="cp">#define	PRISM54_SET_OID_STR	SIOCIWFIRSTPRIV+20</span>
<span class="cp">#define	PRISM54_SET_OID_ADDR	SIOCIWFIRSTPRIV+22</span>

<span class="cp">#define PRISM54_GET_PRISMHDR	SIOCIWFIRSTPRIV+23</span>
<span class="cp">#define PRISM54_SET_PRISMHDR	SIOCIWFIRSTPRIV+24</span>

<span class="cp">#define IWPRIV_SET_U32(n,x)	{ n, IW_PRIV_TYPE_INT | IW_PRIV_SIZE_FIXED | 1, 0, &quot;s_&quot;x }</span>
<span class="cp">#define IWPRIV_SET_SSID(n,x)	{ n, IW_PRIV_TYPE_CHAR | IW_PRIV_SIZE_FIXED | 1, 0, &quot;s_&quot;x }</span>
<span class="cp">#define IWPRIV_SET_ADDR(n,x)	{ n, IW_PRIV_TYPE_ADDR | IW_PRIV_SIZE_FIXED | 1, 0, &quot;s_&quot;x }</span>
<span class="cp">#define IWPRIV_GET(n,x)	{ n, 0, IW_PRIV_TYPE_CHAR | IW_PRIV_SIZE_FIXED | PRIV_STR_SIZE, &quot;g_&quot;x }</span>

<span class="cp">#define IWPRIV_U32(n,x)		IWPRIV_SET_U32(n,x), IWPRIV_GET(n,x)</span>
<span class="cp">#define IWPRIV_SSID(n,x)	IWPRIV_SET_SSID(n,x), IWPRIV_GET(n,x)</span>
<span class="cp">#define IWPRIV_ADDR(n,x)	IWPRIV_SET_ADDR(n,x), IWPRIV_GET(n,x)</span>

<span class="cm">/* Note : limited to 128 private ioctls (wireless tools 26) */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">prism54_private_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*{ cmd, set_args, get_args, name } */</span>
	<span class="p">{</span><span class="n">PRISM54_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;reset&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_GET_PRISMHDR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="s">&quot;get_prismhdr&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_SET_PRISMHDR</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;set_prismhdr&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_GET_POLICY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="s">&quot;getPolicy&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_SET_POLICY</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;setPolicy&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_GET_MAC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="mi">64</span><span class="p">,</span> <span class="s">&quot;getMac&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_ADD_MAC</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;addMac&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_DEL_MAC</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;delMac&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_KICK_MAC</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;kickMac&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_KICK_ALL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;kickAll&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_GET_WPA</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span>
	 <span class="s">&quot;get_wpa&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_SET_WPA</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;set_wpa&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_DBG_OID</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	 <span class="s">&quot;dbg_oid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_DBG_GET_OID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="mi">256</span><span class="p">,</span> <span class="s">&quot;dbg_get_oid&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_DBG_SET_OID</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;dbg_set_oid&quot;</span><span class="p">},</span>
	<span class="cm">/* --- sub-ioctls handlers --- */</span>
	<span class="p">{</span><span class="n">PRISM54_GET_OID</span><span class="p">,</span>
	 <span class="mi">0</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_SET_OID_U32</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_SET_OID_STR</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_CHAR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PRISM54_SET_OID_ADDR</span><span class="p">,</span>
	 <span class="n">IW_PRIV_TYPE_ADDR</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">},</span>
	<span class="cm">/* --- sub-ioctls definitions --- */</span>
	<span class="n">IWPRIV_ADDR</span><span class="p">(</span><span class="n">GEN_OID_MACADDRESS</span><span class="p">,</span> <span class="s">&quot;addr&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">GEN_OID_LINKSTATE</span><span class="p">,</span> <span class="s">&quot;linkstate&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_BSSTYPE</span><span class="p">,</span> <span class="s">&quot;bsstype&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_ADDR</span><span class="p">(</span><span class="n">DOT11_OID_BSSID</span><span class="p">,</span> <span class="s">&quot;bssid&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_STATE</span><span class="p">,</span> <span class="s">&quot;state&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_AID</span><span class="p">,</span> <span class="s">&quot;aid&quot;</span><span class="p">),</span>

	<span class="n">IWPRIV_SSID</span><span class="p">(</span><span class="n">DOT11_OID_SSIDOVERRIDE</span><span class="p">,</span> <span class="s">&quot;ssidoverride&quot;</span><span class="p">),</span>

	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_MEDIUMLIMIT</span><span class="p">,</span> <span class="s">&quot;medlimit&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_BEACONPERIOD</span><span class="p">,</span> <span class="s">&quot;beacon&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_DTIMPERIOD</span><span class="p">,</span> <span class="s">&quot;dtimperiod&quot;</span><span class="p">),</span>

	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="s">&quot;authenable&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="s">&quot;privinvok&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="s">&quot;exunencrypt&quot;</span><span class="p">),</span>

	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_REKEYTHRESHOLD</span><span class="p">,</span> <span class="s">&quot;rekeythresh&quot;</span><span class="p">),</span>

	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_MAXTXLIFETIME</span><span class="p">,</span> <span class="s">&quot;maxtxlife&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_MAXRXLIFETIME</span><span class="p">,</span> <span class="s">&quot;maxrxlife&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_ALOFT_FIXEDRATE</span><span class="p">,</span> <span class="s">&quot;fixedrate&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_MAXFRAMEBURST</span><span class="p">,</span> <span class="s">&quot;frameburst&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_PSM</span><span class="p">,</span> <span class="s">&quot;psm&quot;</span><span class="p">),</span>

	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_BRIDGELOCAL</span><span class="p">,</span> <span class="s">&quot;bridge&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_CLIENTS</span><span class="p">,</span> <span class="s">&quot;clients&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_CLIENTSASSOCIATED</span><span class="p">,</span> <span class="s">&quot;clientassoc&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_DOT1XENABLE</span><span class="p">,</span> <span class="s">&quot;dot1xenable&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_ANTENNARX</span><span class="p">,</span> <span class="s">&quot;rxant&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_ANTENNATX</span><span class="p">,</span> <span class="s">&quot;txant&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_ANTENNADIVERSITY</span><span class="p">,</span> <span class="s">&quot;antdivers&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_EDTHRESHOLD</span><span class="p">,</span> <span class="s">&quot;edthresh&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_PREAMBLESETTINGS</span><span class="p">,</span> <span class="s">&quot;preamble&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">DOT11_OID_RATES</span><span class="p">,</span> <span class="s">&quot;rates&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_OUTPUTPOWER</span><span class="p">,</span> <span class="s">&quot;.11outpower&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">DOT11_OID_SUPPORTEDRATES</span><span class="p">,</span> <span class="s">&quot;supprates&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">DOT11_OID_SUPPORTEDFREQUENCIES</span><span class="p">,</span> <span class="s">&quot;suppfreq&quot;</span><span class="p">),</span>

	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_NOISEFLOOR</span><span class="p">,</span> <span class="s">&quot;noisefloor&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">DOT11_OID_FREQUENCYACTIVITY</span><span class="p">,</span> <span class="s">&quot;freqactivity&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_NONERPPROTECTION</span><span class="p">,</span> <span class="s">&quot;nonerpprotec&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_PROFILES</span><span class="p">,</span> <span class="s">&quot;profile&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">DOT11_OID_EXTENDEDRATES</span><span class="p">,</span> <span class="s">&quot;extrates&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">,</span> <span class="s">&quot;mlmelevel&quot;</span><span class="p">),</span>

	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">DOT11_OID_BSSS</span><span class="p">,</span> <span class="s">&quot;bsss&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">DOT11_OID_BSSLIST</span><span class="p">,</span> <span class="s">&quot;bsslist&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">OID_INL_MODE</span><span class="p">,</span> <span class="s">&quot;mode&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">OID_INL_CONFIG</span><span class="p">,</span> <span class="s">&quot;config&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">OID_INL_DOT11D_CONFORMANCE</span><span class="p">,</span> <span class="s">&quot;.11dconform&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_GET</span><span class="p">(</span><span class="n">OID_INL_PHYCAPABILITIES</span><span class="p">,</span> <span class="s">&quot;phycapa&quot;</span><span class="p">),</span>
	<span class="n">IWPRIV_U32</span><span class="p">(</span><span class="n">OID_INL_OUTPUTPOWER</span><span class="p">,</span> <span class="s">&quot;outpower&quot;</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span> <span class="n">prism54_private_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_reset</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_policy</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_policy</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_mac</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_add_mac</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_del_mac</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_kick_mac</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_kick_all</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_wpa</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_wpa</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_debug_oid</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_debug_get_oid</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_debug_set_oid</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_oid</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_u32</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_raw</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_raw</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_get_prismhdr</span><span class="p">,</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">prism54_set_prismhdr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">prism54_handler_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_standard</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">prism54_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">prism54_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">prism54_private_args</span><span class="p">),</span>
	<span class="p">.</span><span class="n">standard</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span> <span class="n">prism54_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private</span> <span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span> <span class="n">prism54_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="o">*</span><span class="p">)</span> <span class="n">prism54_private_args</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">prism54_get_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
