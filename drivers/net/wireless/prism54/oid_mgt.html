<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › prism54 › oid_mgt.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>oid_mgt.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2003,2004 Aurelien Alleaume &lt;slts@free.fr&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;prismcompat.h&quot;</span>
<span class="cp">#include &quot;islpci_dev.h&quot;</span>
<span class="cp">#include &quot;islpci_mgt.h&quot;</span>
<span class="cp">#include &quot;isl_oid.h&quot;</span>
<span class="cp">#include &quot;oid_mgt.h&quot;</span>
<span class="cp">#include &quot;isl_ioctl.h&quot;</span>

<span class="cm">/* to convert between channel and freq */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">frequency_list_bg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2412</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span> <span class="mi">2432</span><span class="p">,</span>
	<span class="mi">2437</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span> <span class="mi">2484</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">channel_of_freq</span><span class="p">(</span><span class="kt">int</span> <span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="mi">2412</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="mi">2484</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">c</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="n">frequency_list_bg</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>
			<span class="n">c</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">14</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">++</span><span class="n">c</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">f</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="mi">6000</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span> <span class="p">(</span><span class="n">f</span> <span class="o">-</span> <span class="mi">5000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span> <span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define OID_STRUCT(name,oid,s,t) [name] = {oid, 0, sizeof(s), t}</span>
<span class="cp">#define OID_STRUCT_C(name,oid,s,t) OID_STRUCT(name,oid,s,t | OID_FLAG_CACHED)</span>
<span class="cp">#define OID_U32(name,oid) OID_STRUCT(name,oid,u32,OID_TYPE_U32)</span>
<span class="cp">#define OID_U32_C(name,oid) OID_STRUCT_C(name,oid,u32,OID_TYPE_U32)</span>
<span class="cp">#define OID_STRUCT_MLME(name,oid) OID_STRUCT(name,oid,struct obj_mlme,OID_TYPE_MLME)</span>
<span class="cp">#define OID_STRUCT_MLMEEX(name,oid) OID_STRUCT(name,oid,struct obj_mlmeex,OID_TYPE_MLMEEX)</span>

<span class="cp">#define OID_UNKNOWN(name,oid) OID_STRUCT(name,oid,0,0)</span>

<span class="k">struct</span> <span class="n">oid_t</span> <span class="n">isl_oid</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">GEN_OID_MACADDRESS</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">OID_TYPE_ADDR</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">GEN_OID_LINKSTATE</span><span class="p">,</span> <span class="mh">0x00000001</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">GEN_OID_WATCHDOG</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">GEN_OID_MIBOP</span><span class="p">,</span> <span class="mh">0x00000003</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">GEN_OID_OPTIONS</span><span class="p">,</span> <span class="mh">0x00000004</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">GEN_OID_LEDCONFIG</span><span class="p">,</span> <span class="mh">0x00000005</span><span class="p">),</span>

	<span class="cm">/* 802.11 */</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_BSSTYPE</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">),</span>
	<span class="n">OID_STRUCT_C</span><span class="p">(</span><span class="n">DOT11_OID_BSSID</span><span class="p">,</span> <span class="mh">0x10000001</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">OID_TYPE_RAW</span><span class="p">),</span>
	<span class="n">OID_STRUCT_C</span><span class="p">(</span><span class="n">DOT11_OID_SSID</span><span class="p">,</span> <span class="mh">0x10000002</span><span class="p">,</span> <span class="k">struct</span> <span class="n">obj_ssid</span><span class="p">,</span>
		     <span class="n">OID_TYPE_SSID</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_STATE</span><span class="p">,</span> <span class="mh">0x10000003</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_AID</span><span class="p">,</span> <span class="mh">0x10000004</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_COUNTRYSTRING</span><span class="p">,</span> <span class="mh">0x10000005</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">OID_TYPE_RAW</span><span class="p">),</span>
	<span class="n">OID_STRUCT_C</span><span class="p">(</span><span class="n">DOT11_OID_SSIDOVERRIDE</span><span class="p">,</span> <span class="mh">0x10000006</span><span class="p">,</span> <span class="k">struct</span> <span class="n">obj_ssid</span><span class="p">,</span>
		     <span class="n">OID_TYPE_SSID</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MEDIUMLIMIT</span><span class="p">,</span> <span class="mh">0x11000000</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_BEACONPERIOD</span><span class="p">,</span> <span class="mh">0x11000001</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_DTIMPERIOD</span><span class="p">,</span> <span class="mh">0x11000002</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ATIMWINDOW</span><span class="p">,</span> <span class="mh">0x11000003</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_LISTENINTERVAL</span><span class="p">,</span> <span class="mh">0x11000004</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CFPPERIOD</span><span class="p">,</span> <span class="mh">0x11000005</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CFPDURATION</span><span class="p">,</span> <span class="mh">0x11000006</span><span class="p">),</span>

	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span> <span class="mh">0x12000000</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span> <span class="mh">0x12000001</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span> <span class="mh">0x12000002</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_DEFKEYID</span><span class="p">,</span> <span class="mh">0x12000003</span><span class="p">),</span>
	<span class="p">[</span><span class="n">DOT11_OID_DEFKEYX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x12000004</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_key</span><span class="p">),</span>
			       <span class="n">OID_FLAG_CACHED</span> <span class="o">|</span> <span class="n">OID_TYPE_KEY</span><span class="p">},</span>	<span class="cm">/* DOT11_OID_DEFKEY1,...DOT11_OID_DEFKEY4 */</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_STAKEY</span><span class="p">,</span> <span class="mh">0x12000008</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_REKEYTHRESHOLD</span><span class="p">,</span> <span class="mh">0x12000009</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_STASC</span><span class="p">,</span> <span class="mh">0x1200000a</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_PRIVTXREJECTED</span><span class="p">,</span> <span class="mh">0x1a000000</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_PRIVRXPLAIN</span><span class="p">,</span> <span class="mh">0x1a000001</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_PRIVRXFAILED</span><span class="p">,</span> <span class="mh">0x1a000002</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_PRIVRXNOKEY</span><span class="p">,</span> <span class="mh">0x1a000003</span><span class="p">),</span>

	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_RTSTHRESH</span><span class="p">,</span> <span class="mh">0x13000000</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_FRAGTHRESH</span><span class="p">,</span> <span class="mh">0x13000001</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_SHORTRETRIES</span><span class="p">,</span> <span class="mh">0x13000002</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_LONGRETRIES</span><span class="p">,</span> <span class="mh">0x13000003</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_MAXTXLIFETIME</span><span class="p">,</span> <span class="mh">0x13000004</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MAXRXLIFETIME</span><span class="p">,</span> <span class="mh">0x13000005</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_AUTHRESPTIMEOUT</span><span class="p">,</span> <span class="mh">0x13000006</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ASSOCRESPTIMEOUT</span><span class="p">,</span> <span class="mh">0x13000007</span><span class="p">),</span>

	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_ALOFT_TABLE</span><span class="p">,</span> <span class="mh">0x1d000000</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_ALOFT_CTRL_TABLE</span><span class="p">,</span> <span class="mh">0x1d000001</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_ALOFT_RETREAT</span><span class="p">,</span> <span class="mh">0x1d000002</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_ALOFT_PROGRESS</span><span class="p">,</span> <span class="mh">0x1d000003</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ALOFT_FIXEDRATE</span><span class="p">,</span> <span class="mh">0x1d000004</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_ALOFT_RSSIGRAPH</span><span class="p">,</span> <span class="mh">0x1d000005</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_ALOFT_CONFIG</span><span class="p">,</span> <span class="mh">0x1d000006</span><span class="p">),</span>

	<span class="p">[</span><span class="n">DOT11_OID_VDCFX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1b000000</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MAXFRAMEBURST</span><span class="p">,</span> <span class="mh">0x1b000008</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_PSM</span><span class="p">,</span> <span class="mh">0x14000000</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CAMTIMEOUT</span><span class="p">,</span> <span class="mh">0x14000001</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_RECEIVEDTIMS</span><span class="p">,</span> <span class="mh">0x14000002</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ROAMPREFERENCE</span><span class="p">,</span> <span class="mh">0x14000003</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_BRIDGELOCAL</span><span class="p">,</span> <span class="mh">0x15000000</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CLIENTS</span><span class="p">,</span> <span class="mh">0x15000001</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CLIENTSASSOCIATED</span><span class="p">,</span> <span class="mh">0x15000002</span><span class="p">),</span>
	<span class="p">[</span><span class="n">DOT11_OID_CLIENTX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x15000003</span><span class="p">,</span> <span class="mi">2006</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>	<span class="cm">/* DOT11_OID_CLIENTX,...DOT11_OID_CLIENT2007 */</span>

	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_CLIENTFIND</span><span class="p">,</span> <span class="mh">0x150007DB</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">OID_TYPE_ADDR</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_WDSLINKADD</span><span class="p">,</span> <span class="mh">0x150007DC</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">OID_TYPE_ADDR</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_WDSLINKREMOVE</span><span class="p">,</span> <span class="mh">0x150007DD</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">OID_TYPE_ADDR</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_EAPAUTHSTA</span><span class="p">,</span> <span class="mh">0x150007DE</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">OID_TYPE_ADDR</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_EAPUNAUTHSTA</span><span class="p">,</span> <span class="mh">0x150007DF</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="n">OID_TYPE_ADDR</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_DOT1XENABLE</span><span class="p">,</span> <span class="mh">0x150007E0</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_MICFAILURE</span><span class="p">,</span> <span class="mh">0x150007E1</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_REKEYINDICATE</span><span class="p">,</span> <span class="mh">0x150007E2</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MPDUTXSUCCESSFUL</span><span class="p">,</span> <span class="mh">0x16000000</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MPDUTXONERETRY</span><span class="p">,</span> <span class="mh">0x16000001</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MPDUTXMULTIPLERETRIES</span><span class="p">,</span> <span class="mh">0x16000002</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MPDUTXFAILED</span><span class="p">,</span> <span class="mh">0x16000003</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MPDURXSUCCESSFUL</span><span class="p">,</span> <span class="mh">0x16000004</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_MPDURXDUPS</span><span class="p">,</span> <span class="mh">0x16000005</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_RTSSUCCESSFUL</span><span class="p">,</span> <span class="mh">0x16000006</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_RTSFAILED</span><span class="p">,</span> <span class="mh">0x16000007</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ACKFAILED</span><span class="p">,</span> <span class="mh">0x16000008</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_FRAMERECEIVES</span><span class="p">,</span> <span class="mh">0x16000009</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_FRAMEERRORS</span><span class="p">,</span> <span class="mh">0x1600000A</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_FRAMEABORTS</span><span class="p">,</span> <span class="mh">0x1600000B</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_FRAMEABORTSPHY</span><span class="p">,</span> <span class="mh">0x1600000C</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_SLOTTIME</span><span class="p">,</span> <span class="mh">0x17000000</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CWMIN</span><span class="p">,</span> <span class="mh">0x17000001</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CWMAX</span><span class="p">,</span> <span class="mh">0x17000002</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ACKWINDOW</span><span class="p">,</span> <span class="mh">0x17000003</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ANTENNARX</span><span class="p">,</span> <span class="mh">0x17000004</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ANTENNATX</span><span class="p">,</span> <span class="mh">0x17000005</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_ANTENNADIVERSITY</span><span class="p">,</span> <span class="mh">0x17000006</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_CHANNEL</span><span class="p">,</span> <span class="mh">0x17000007</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_EDTHRESHOLD</span><span class="p">,</span> <span class="mh">0x17000008</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_PREAMBLESETTINGS</span><span class="p">,</span> <span class="mh">0x17000009</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_RATES</span><span class="p">,</span> <span class="mh">0x1700000A</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="n">IWMAX_BITRATES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
		   <span class="n">OID_TYPE_RAW</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CCAMODESUPPORTED</span><span class="p">,</span> <span class="mh">0x1700000B</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_CCAMODE</span><span class="p">,</span> <span class="mh">0x1700000C</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_RSSIVECTOR</span><span class="p">,</span> <span class="mh">0x1700000D</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_OUTPUTPOWERTABLE</span><span class="p">,</span> <span class="mh">0x1700000E</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_OUTPUTPOWER</span><span class="p">,</span> <span class="mh">0x1700000F</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_SUPPORTEDRATES</span><span class="p">,</span> <span class="mh">0x17000010</span><span class="p">,</span>
		   <span class="n">u8</span><span class="p">[</span><span class="n">IWMAX_BITRATES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">OID_TYPE_RAW</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_FREQUENCY</span><span class="p">,</span> <span class="mh">0x17000011</span><span class="p">),</span>
	<span class="p">[</span><span class="n">DOT11_OID_SUPPORTEDFREQUENCIES</span><span class="p">]</span> <span class="o">=</span>
	    <span class="p">{</span><span class="mh">0x17000012</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_frequencies</span><span class="p">)</span>
	     <span class="o">+</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="o">*</span> <span class="n">IWMAX_FREQ</span><span class="p">,</span> <span class="n">OID_TYPE_FREQUENCIES</span><span class="p">},</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_NOISEFLOOR</span><span class="p">,</span> <span class="mh">0x17000013</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_FREQUENCYACTIVITY</span><span class="p">,</span> <span class="mh">0x17000014</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="n">IWMAX_FREQ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
		   <span class="n">OID_TYPE_RAW</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_IQCALIBRATIONTABLE</span><span class="p">,</span> <span class="mh">0x17000015</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_NONERPPROTECTION</span><span class="p">,</span> <span class="mh">0x17000016</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_SLOTSETTINGS</span><span class="p">,</span> <span class="mh">0x17000017</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_NONERPTIMEOUT</span><span class="p">,</span> <span class="mh">0x17000018</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_PROFILES</span><span class="p">,</span> <span class="mh">0x17000019</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_EXTENDEDRATES</span><span class="p">,</span> <span class="mh">0x17000020</span><span class="p">,</span>
		   <span class="n">u8</span><span class="p">[</span><span class="n">IWMAX_BITRATES</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span> <span class="n">OID_TYPE_RAW</span><span class="p">),</span>

	<span class="n">OID_STRUCT_MLME</span><span class="p">(</span><span class="n">DOT11_OID_DEAUTHENTICATE</span><span class="p">,</span> <span class="mh">0x18000000</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLME</span><span class="p">(</span><span class="n">DOT11_OID_AUTHENTICATE</span><span class="p">,</span> <span class="mh">0x18000001</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLME</span><span class="p">(</span><span class="n">DOT11_OID_DISASSOCIATE</span><span class="p">,</span> <span class="mh">0x18000002</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLME</span><span class="p">(</span><span class="n">DOT11_OID_ASSOCIATE</span><span class="p">,</span> <span class="mh">0x18000003</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">DOT11_OID_SCAN</span><span class="p">,</span> <span class="mh">0x18000004</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLMEEX</span><span class="p">(</span><span class="n">DOT11_OID_BEACON</span><span class="p">,</span> <span class="mh">0x18000005</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLMEEX</span><span class="p">(</span><span class="n">DOT11_OID_PROBE</span><span class="p">,</span> <span class="mh">0x18000006</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLMEEX</span><span class="p">(</span><span class="n">DOT11_OID_DEAUTHENTICATEEX</span><span class="p">,</span> <span class="mh">0x18000007</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLMEEX</span><span class="p">(</span><span class="n">DOT11_OID_AUTHENTICATEEX</span><span class="p">,</span> <span class="mh">0x18000008</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLMEEX</span><span class="p">(</span><span class="n">DOT11_OID_DISASSOCIATEEX</span><span class="p">,</span> <span class="mh">0x18000009</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLMEEX</span><span class="p">(</span><span class="n">DOT11_OID_ASSOCIATEEX</span><span class="p">,</span> <span class="mh">0x1800000A</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLMEEX</span><span class="p">(</span><span class="n">DOT11_OID_REASSOCIATE</span><span class="p">,</span> <span class="mh">0x1800000B</span><span class="p">),</span>
	<span class="n">OID_STRUCT_MLMEEX</span><span class="p">(</span><span class="n">DOT11_OID_REASSOCIATEEX</span><span class="p">,</span> <span class="mh">0x1800000C</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_NONERPSTATUS</span><span class="p">,</span> <span class="mh">0x1E000000</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_STATIMEOUT</span><span class="p">,</span> <span class="mh">0x19000000</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">,</span> <span class="mh">0x19000001</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_BSSTIMEOUT</span><span class="p">,</span> <span class="mh">0x19000002</span><span class="p">),</span>
	<span class="p">[</span><span class="n">DOT11_OID_ATTACHMENT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x19000003</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">obj_attachment</span><span class="p">),</span> <span class="n">OID_TYPE_ATTACH</span><span class="p">},</span>
	<span class="n">OID_STRUCT_C</span><span class="p">(</span><span class="n">DOT11_OID_PSMBUFFER</span><span class="p">,</span> <span class="mh">0x19000004</span><span class="p">,</span> <span class="k">struct</span> <span class="n">obj_buffer</span><span class="p">,</span>
		     <span class="n">OID_TYPE_BUFFER</span><span class="p">),</span>

	<span class="n">OID_U32</span><span class="p">(</span><span class="n">DOT11_OID_BSSS</span><span class="p">,</span> <span class="mh">0x1C000000</span><span class="p">),</span>
	<span class="p">[</span><span class="n">DOT11_OID_BSSX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1C000001</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_bss</span><span class="p">),</span>
			    <span class="n">OID_TYPE_BSS</span><span class="p">},</span>	<span class="cm">/*DOT11_OID_BSS1,...,DOT11_OID_BSS64 */</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">DOT11_OID_BSSFIND</span><span class="p">,</span> <span class="mh">0x1C000042</span><span class="p">,</span> <span class="k">struct</span> <span class="n">obj_bss</span><span class="p">,</span> <span class="n">OID_TYPE_BSS</span><span class="p">),</span>
	<span class="p">[</span><span class="n">DOT11_OID_BSSLIST</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x1C000043</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span>
						      <span class="n">obj_bsslist</span><span class="p">)</span> <span class="o">+</span>
			       <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">obj_bss</span><span class="p">[</span><span class="n">IWMAX_BSS</span><span class="p">]),</span>
			       <span class="n">OID_TYPE_BSSLIST</span><span class="p">},</span>

	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">OID_INL_TUNNEL</span><span class="p">,</span> <span class="mh">0xFF020000</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">OID_INL_MEMADDR</span><span class="p">,</span> <span class="mh">0xFF020001</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">OID_INL_MEMORY</span><span class="p">,</span> <span class="mh">0xFF020002</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">OID_INL_MODE</span><span class="p">,</span> <span class="mh">0xFF020003</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">OID_INL_COMPONENT_NR</span><span class="p">,</span> <span class="mh">0xFF020004</span><span class="p">),</span>
	<span class="n">OID_STRUCT</span><span class="p">(</span><span class="n">OID_INL_VERSION</span><span class="p">,</span> <span class="mh">0xFF020005</span><span class="p">,</span> <span class="n">u8</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">OID_TYPE_RAW</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">OID_INL_INTERFACE_ID</span><span class="p">,</span> <span class="mh">0xFF020006</span><span class="p">),</span>
	<span class="n">OID_UNKNOWN</span><span class="p">(</span><span class="n">OID_INL_COMPONENT_ID</span><span class="p">,</span> <span class="mh">0xFF020007</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">OID_INL_CONFIG</span><span class="p">,</span> <span class="mh">0xFF020008</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">OID_INL_DOT11D_CONFORMANCE</span><span class="p">,</span> <span class="mh">0xFF02000C</span><span class="p">),</span>
	<span class="n">OID_U32</span><span class="p">(</span><span class="n">OID_INL_PHYCAPABILITIES</span><span class="p">,</span> <span class="mh">0xFF02000D</span><span class="p">),</span>
	<span class="n">OID_U32_C</span><span class="p">(</span><span class="n">OID_INL_OUTPUTPOWER</span><span class="p">,</span> <span class="mh">0xFF02000F</span><span class="p">),</span>

<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">mgt_init</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">OID_NUM_LAST</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Alloc the cache */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OID_NUM_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_CACHED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">*</span>
					       <span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">range</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
					       <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">init_rwsem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">prism54_mib_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">mgt_clean</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OID_NUM_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">mgt_le_to_cpu</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OID_TYPE_U32</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BUFFER</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_buffer</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">buff</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buff</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="n">buff</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buff</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BSS</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_bss</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">capinfo</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">capinfo</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BSSLIST</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_bsslist</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">list</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">mgt_le_to_cpu</span><span class="p">(</span><span class="n">OID_TYPE_BSS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">bsslist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_FREQUENCIES</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_frequencies</span> <span class="o">*</span><span class="n">freq</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">freq</span><span class="o">-&gt;</span><span class="n">mhz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">mhz</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_MLME</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_MLMEEX</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_mlmeex</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_ATTACH</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_attachment</span> <span class="o">*</span><span class="n">attach</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">attach</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">attach</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">attach</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">attach</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_SSID</span>:
	<span class="k">case</span> <span class="n">OID_TYPE_KEY</span>:
	<span class="k">case</span> <span class="n">OID_TYPE_ADDR</span>:
	<span class="k">case</span> <span class="n">OID_TYPE_RAW</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">mgt_cpu_to_le</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OID_TYPE_U32</span>:
		<span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BUFFER</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_buffer</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">buff</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buff</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="n">buff</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">buff</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BSS</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_bss</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">age</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">capinfo</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">capinfo</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">rates</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">);</span>
			<span class="n">bss</span><span class="o">-&gt;</span><span class="n">basic_rates</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BSSLIST</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_bsslist</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">list</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">mgt_cpu_to_le</span><span class="p">(</span><span class="n">OID_TYPE_BSS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list</span><span class="o">-&gt;</span><span class="n">bsslist</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_FREQUENCIES</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_frequencies</span> <span class="o">*</span><span class="n">freq</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">freq</span><span class="o">-&gt;</span><span class="n">mhz</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">freq</span><span class="o">-&gt;</span><span class="n">mhz</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_MLME</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_MLMEEX</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_mlmeex</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
			<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mlme</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_ATTACH</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_attachment</span> <span class="o">*</span><span class="n">attach</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">attach</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">attach</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">attach</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">attach</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">OID_TYPE_SSID</span>:
	<span class="k">case</span> <span class="n">OID_TYPE_KEY</span>:
	<span class="k">case</span> <span class="n">OID_TYPE_ADDR</span>:
	<span class="k">case</span> <span class="n">OID_TYPE_RAW</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Note : data is modified during this function */</span>

<span class="kt">int</span>
<span class="nf">mgt_set_request</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">extra</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">islpci_mgmtframe</span> <span class="o">*</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">response_op</span> <span class="o">=</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="o">*</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oid</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">OID_NUM_LAST</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">extra</span> <span class="o">&gt;</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">range</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">)</span>
		<span class="cm">/* memory has been freed */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dlen</span> <span class="o">=</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">cache</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
	<span class="n">cache</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cache</span> <span class="o">?</span> <span class="n">extra</span> <span class="o">*</span> <span class="n">dlen</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">oid</span> <span class="o">=</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">oid</span> <span class="o">+</span> <span class="n">extra</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="cm">/* we are requested to re-set a cached value */</span>
		<span class="n">_data</span> <span class="o">=</span> <span class="n">cache</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mgt_cpu_to_le</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">,</span> <span class="n">_data</span><span class="p">);</span>
	<span class="cm">/* If we are going to write to the cache, we don&#39;t want anyone to read</span>
<span class="cm">	 * it -&gt; acquire write lock.</span>
<span class="cm">	 * Else we could acquire a read lock to be sure we don&#39;t bother the</span>
<span class="cm">	 * commit process (which takes a write lock). But I&#39;m not sure if it&#39;s</span>
<span class="cm">	 * needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">)</span>
		<span class="n">down_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PRV_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">islpci_mgt_transaction</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">PIMFOR_OP_SET</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span>
					     <span class="n">_data</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">response_op</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">;</span>
			<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">response_op</span> <span class="o">==</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cache</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">cache</span><span class="p">,</span> <span class="n">_data</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
		<span class="n">up_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* re-set given data to what it was */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">mgt_le_to_cpu</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* None of these are cached */</span>
<span class="kt">int</span>
<span class="nf">mgt_set_varlen</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">extra_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">islpci_mgmtframe</span> <span class="o">*</span><span class="n">response</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">response_op</span> <span class="o">=</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oid</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">OID_NUM_LAST</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">);</span>

	<span class="n">dlen</span> <span class="o">=</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">oid</span> <span class="o">=</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">oid</span><span class="p">;</span>

	<span class="n">mgt_cpu_to_le</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PRV_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">islpci_mgt_transaction</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">PIMFOR_OP_SET</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span>
					     <span class="n">data</span><span class="p">,</span> <span class="n">dlen</span> <span class="o">+</span> <span class="n">extra_len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">response_op</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">operation</span><span class="p">;</span>
			<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">response_op</span> <span class="o">==</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* re-set given data to what it was */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
		<span class="n">mgt_le_to_cpu</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">mgt_get_request</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">int</span> <span class="n">extra</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		<span class="k">union</span> <span class="n">oid_res_t</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reslen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">islpci_mgmtframe</span> <span class="o">*</span><span class="n">response</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">cache</span><span class="p">,</span> <span class="o">*</span><span class="n">_res</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">oid</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">OID_NUM_LAST</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">extra</span> <span class="o">&gt;</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">range</span><span class="p">);</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">)</span>
		<span class="cm">/* memory has been freed */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dlen</span> <span class="o">=</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
	<span class="n">cache</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
	<span class="n">cache</span> <span class="o">+=</span> <span class="n">cache</span> <span class="o">?</span> <span class="n">extra</span> <span class="o">*</span> <span class="n">dlen</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">oid</span> <span class="o">=</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">oid</span> <span class="o">+</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">reslen</span> <span class="o">=</span> <span class="n">dlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">)</span>
		<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PRV_STATE_READY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">islpci_mgt_transaction</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">PIMFOR_OP_GET</span><span class="p">,</span>
					     <span class="n">oid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="o">!</span><span class="n">response</span> <span class="o">||</span>
		    <span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">==</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span>
				<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_res</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">reslen</span> <span class="o">=</span> <span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_res</span> <span class="o">=</span> <span class="n">cache</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">OID_TYPE_U32</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">u</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">_res</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">reslen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">reslen</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">,</span> <span class="n">_res</span><span class="p">,</span> <span class="n">reslen</span><span class="p">);</span>
			<span class="n">mgt_le_to_cpu</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">,</span>
				      <span class="n">res</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cache</span><span class="p">)</span>
		<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">response</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reslen</span> <span class="o">&gt;</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
		       <span class="s">&quot;mgt_get_request(0x%x): received data length was bigger &quot;</span>
		       <span class="s">&quot;than expected (%d &gt; %d). Memory is probably corrupted...&quot;</span><span class="p">,</span>
		       <span class="n">oid</span><span class="p">,</span> <span class="n">reslen</span><span class="p">,</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* lock outside */</span>
<span class="kt">int</span>
<span class="nf">mgt_commit_list</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="o">*</span><span class="n">l</span><span class="p">,</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">islpci_mgmtframe</span> <span class="o">*</span><span class="n">response</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">oid_t</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]]);</span>
		<span class="kt">void</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
		<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">oid</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">oid</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">r</span> <span class="o">=</span> <span class="n">islpci_mgt_transaction</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">PIMFOR_OP_SET</span><span class="p">,</span>
						      <span class="n">oid</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">response</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">r</span> <span class="o">|=</span> <span class="p">(</span><span class="n">response</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">==</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">);</span>
				<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">response</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: mgt_commit_list: failure. &quot;</span>
					<span class="s">&quot;oid=%08x err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">oid</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">r</span><span class="p">;</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
			<span class="n">oid</span><span class="o">++</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Lock outside */</span>

<span class="kt">void</span>
<span class="nf">mgt_set</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">OID_NUM_LAST</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">data</span><span class="p">,</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
	<span class="n">mgt_cpu_to_le</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">n</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">mgt_get</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">n</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">OID_NUM_LAST</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">n</span><span class="p">],</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">);</span>
	<span class="n">mgt_le_to_cpu</span><span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Commits the cache. Lock outside. */</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">commit_part1</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">OID_INL_CONFIG</span><span class="p">,</span>
	<span class="n">OID_INL_MODE</span><span class="p">,</span>
	<span class="n">DOT11_OID_BSSTYPE</span><span class="p">,</span>
	<span class="n">DOT11_OID_CHANNEL</span><span class="p">,</span>
	<span class="n">DOT11_OID_MLMEAUTOLEVEL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">commit_part2</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DOT11_OID_SSID</span><span class="p">,</span>
	<span class="n">DOT11_OID_PSMBUFFER</span><span class="p">,</span>
	<span class="n">DOT11_OID_AUTHENABLE</span><span class="p">,</span>
	<span class="n">DOT11_OID_PRIVACYINVOKED</span><span class="p">,</span>
	<span class="n">DOT11_OID_EXUNENCRYPTED</span><span class="p">,</span>
	<span class="n">DOT11_OID_DEFKEYX</span><span class="p">,</span>	<span class="cm">/* MULTIPLE */</span>
	<span class="n">DOT11_OID_DEFKEYID</span><span class="p">,</span>
	<span class="n">DOT11_OID_DOT1XENABLE</span><span class="p">,</span>
	<span class="n">OID_INL_DOT11D_CONFORMANCE</span><span class="p">,</span>
	<span class="cm">/* Do not initialize this - fw &lt; 1.0.4.3 rejects it</span>
<span class="cm">	OID_INL_OUTPUTPOWER,</span>
<span class="cm">	*/</span>
<span class="p">};</span>

<span class="cm">/* update the MAC addr. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">mgt_update_addr</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">islpci_mgmtframe</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">islpci_mgt_transaction</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="p">,</span> <span class="n">PIMFOR_OP_GET</span><span class="p">,</span>
				     <span class="n">isl_oid</span><span class="p">[</span><span class="n">GEN_OID_MACADDRESS</span><span class="p">].</span><span class="n">oid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				     <span class="n">isl_oid</span><span class="p">[</span><span class="n">GEN_OID_MACADDRESS</span><span class="p">].</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">res</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">operation</span> <span class="o">!=</span> <span class="n">PIMFOR_OP_ERROR</span><span class="p">))</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">islpci_mgt_release</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: mgt_update_addr: failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">mgt_commit</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rvalue</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">islpci_get_state</span><span class="p">(</span><span class="n">priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">PRV_STATE_INIT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rvalue</span> <span class="o">=</span> <span class="n">mgt_commit_list</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">commit_part1</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">commit_part1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">!=</span> <span class="n">IW_MODE_MONITOR</span><span class="p">)</span>
		<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_commit_list</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">commit_part2</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">commit_part2</span><span class="p">));</span>

	<span class="n">u</span> <span class="o">=</span> <span class="n">OID_INL_MODE</span><span class="p">;</span>
	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_commit_list</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rvalue</span> <span class="o">|=</span> <span class="n">mgt_update_addr</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rvalue</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* some request have failed. The device might be in an</span>
<span class="cm">		   incoherent state. We should reset it ! */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: mgt_commit: failure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">ndev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rvalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The following OIDs need to be &quot;unlatched&quot;:</span>
<span class="cm"> *</span>
<span class="cm"> * MEDIUMLIMIT,BEACONPERIOD,DTIMPERIOD,ATIMWINDOW,LISTENINTERVAL</span>
<span class="cm"> * FREQUENCY,EXTENDEDRATES.</span>
<span class="cm"> *</span>
<span class="cm"> * The way to do this is to set ESSID. Note though that they may get</span>
<span class="cm"> * unlatch before though by setting another OID. */</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">void</span>
<span class="c">mgt_unlatch_all(islpci_private *priv)</span>
<span class="c">{</span>
<span class="c">	u32 u;</span>
<span class="c">	int rvalue = 0;</span>

<span class="c">	if (islpci_get_state(priv) &lt; PRV_STATE_INIT)</span>
<span class="c">		return;</span>

<span class="c">	u = DOT11_OID_SSID;</span>
<span class="c">	rvalue = mgt_commit_list(priv, &amp;u, 1);</span>
<span class="c">	/* Necessary if in MANUAL RUN mode? */</span>
<span class="cp">#if 0</span>
<span class="c">	u = OID_INL_MODE;</span>
<span class="c">	rvalue |= mgt_commit_list(priv, &amp;u, 1);</span>

<span class="c">	u = DOT11_OID_MLMEAUTOLEVEL;</span>
<span class="c">	rvalue |= mgt_commit_list(priv, &amp;u, 1);</span>

<span class="c">	u = OID_INL_MODE;</span>
<span class="c">	rvalue |= mgt_commit_list(priv, &amp;u, 1);</span>
<span class="cp">#endif</span>

<span class="c">	if (rvalue)</span>
<span class="c">		printk(KERN_DEBUG &quot;%s: Unlatching OIDs failed\n&quot;, priv-&gt;ndev-&gt;name);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* This will tell you if you are allowed to answer a mlme(ex) request .*/</span>

<span class="kt">int</span>
<span class="nf">mgt_mlme_answer</span><span class="p">(</span><span class="n">islpci_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mlmeautolevel</span><span class="p">;</span>
	<span class="cm">/* Acquire a read lock because if we are in a mode change, it&#39;s</span>
<span class="cm">	 * possible to answer true, while the card is leaving master to managed</span>
<span class="cm">	 * mode. Answering to a mlme in this situation could hang the card.</span>
<span class="cm">	 */</span>
	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>
	<span class="n">mlmeautolevel</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib</span><span class="p">[</span><span class="n">DOT11_OID_MLMEAUTOLEVEL</span><span class="p">]);</span>
	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mib_sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">IW_MODE_MASTER</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">mlmeautolevel</span> <span class="o">&gt;=</span> <span class="n">DOT11_MLME_INTERMEDIATE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">enum</span> <span class="n">oid_num_t</span>
<span class="nf">mgt_oidtonum</span><span class="p">(</span><span class="n">u32</span> <span class="n">oid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OID_NUM_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">oid</span> <span class="o">==</span> <span class="n">oid</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;looking for an unknown oid 0x%x&quot;</span><span class="p">,</span> <span class="n">oid</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">OID_NUM_LAST</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">mgt_response_to_str</span><span class="p">(</span><span class="k">enum</span> <span class="n">oid_num_t</span> <span class="n">n</span><span class="p">,</span> <span class="k">union</span> <span class="n">oid_res_t</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OID_FLAG_TYPE</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OID_TYPE_U32</span>:
		<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BUFFER</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_buffer</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span>
					<span class="s">&quot;size=%u</span><span class="se">\n</span><span class="s">addr=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buff</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					<span class="n">buff</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BSS</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_bss</span> <span class="o">*</span><span class="n">bss</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span>
					<span class="s">&quot;age=%u</span><span class="se">\n</span><span class="s">channel=%u</span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="s">&quot;capinfo=0x%X</span><span class="se">\n</span><span class="s">rates=0x%X</span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="s">&quot;basic_rates=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">age</span><span class="p">,</span>
					<span class="n">bss</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">capinfo</span><span class="p">,</span>
					<span class="n">bss</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_BSSLIST</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_bsslist</span> <span class="o">*</span><span class="n">list</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
			<span class="n">k</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span> <span class="s">&quot;nr=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">k</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">k</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span> <span class="o">-</span> <span class="n">k</span><span class="p">,</span>
					      <span class="s">&quot;bss[%u] :</span><span class="se">\n</span><span class="s">age=%u</span><span class="se">\n</span><span class="s">channel=%u</span><span class="se">\n</span><span class="s">&quot;</span>
					      <span class="s">&quot;capinfo=0x%X</span><span class="se">\n</span><span class="s">rates=0x%X</span><span class="se">\n</span><span class="s">&quot;</span>
					      <span class="s">&quot;basic_rates=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="n">i</span><span class="p">,</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">bsslist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">age</span><span class="p">,</span>
					      <span class="n">list</span><span class="o">-&gt;</span><span class="n">bsslist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">channel</span><span class="p">,</span>
					      <span class="n">list</span><span class="o">-&gt;</span><span class="n">bsslist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">capinfo</span><span class="p">,</span>
					      <span class="n">list</span><span class="o">-&gt;</span><span class="n">bsslist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rates</span><span class="p">,</span>
					      <span class="n">list</span><span class="o">-&gt;</span><span class="n">bsslist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">basic_rates</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">k</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_FREQUENCIES</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_frequencies</span> <span class="o">*</span><span class="n">freq</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;nr : %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span> <span class="s">&quot;nr=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">t</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span>
					      <span class="s">&quot;mhz[%u]=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">mhz</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_MLME</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_mlme</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span>
					<span class="s">&quot;id=0x%X</span><span class="se">\n</span><span class="s">state=0x%X</span><span class="se">\n</span><span class="s">code=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_MLMEEX</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_mlmeex</span> <span class="o">*</span><span class="n">mlme</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span>
					<span class="s">&quot;id=0x%X</span><span class="se">\n</span><span class="s">state=0x%X</span><span class="se">\n</span><span class="s">&quot;</span>
					<span class="s">&quot;code=0x%X</span><span class="se">\n</span><span class="s">size=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">mlme</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">mlme</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_ATTACH</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_attachment</span> <span class="o">*</span><span class="n">attach</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span>
					<span class="s">&quot;id=%d</span><span class="se">\n</span><span class="s">size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">attach</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
					<span class="n">attach</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_SSID</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_ssid</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span>
					<span class="s">&quot;length=%u</span><span class="se">\n</span><span class="s">octets=%.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">ssid</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">ssid</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
					<span class="n">ssid</span><span class="o">-&gt;</span><span class="n">octets</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_KEY</span>:<span class="p">{</span>
			<span class="k">struct</span> <span class="n">obj_key</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span>
				     <span class="s">&quot;type=0x%X</span><span class="se">\n</span><span class="s">length=0x%X</span><span class="se">\n</span><span class="s">key=0x&quot;</span><span class="p">,</span>
				     <span class="n">key</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">t</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span>
					      <span class="s">&quot;%02X:&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">t</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OID_TYPE_RAW</span>:
	<span class="k">case</span> <span class="n">OID_TYPE_ADDR</span>:<span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buff</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ptr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">t</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">t</span> <span class="o">=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span><span class="p">,</span> <span class="s">&quot;hex data=&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">isl_oid</span><span class="p">[</span><span class="n">n</span><span class="p">].</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">t</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span>
					      <span class="s">&quot;%02X:&quot;</span><span class="p">,</span> <span class="n">buff</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">t</span> <span class="o">+=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="n">PRIV_STR_SIZE</span> <span class="o">-</span> <span class="n">t</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">t</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
