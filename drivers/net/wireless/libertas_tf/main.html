<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › libertas_tf › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2008, cozybit Inc.</span>
<span class="cm"> *  Copyright (C) 2003-2006, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> *  your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &quot;libertas_tf.h&quot;</span>

<span class="cp">#define DRIVER_RELEASE_VERSION &quot;004.p0&quot;</span>
<span class="cm">/* thinfirm version: 5.132.X.pX */</span>
<span class="cp">#define LBTF_FW_VER_MIN		0x05840300</span>
<span class="cp">#define LBTF_FW_VER_MAX		0x0584ffff</span>
<span class="cp">#define QOS_CONTROL_LEN		2</span>

<span class="cm">/* Module parameters */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lbtf_debug</span><span class="p">;</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbtf_debug</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">libertas_tf_debug</span><span class="p">,</span> <span class="n">lbtf_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">lbtf_driver_version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;THINFIRM-USB8388-&quot;</span> <span class="n">DRIVER_RELEASE_VERSION</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="s">&quot;-dbg&quot;</span>
<span class="cp">#endif</span>
	<span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">lbtf_wq</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">lbtf_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2412</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2417</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2422</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2427</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2432</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2437</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2442</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2447</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2452</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2457</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2462</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2467</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2472</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2484</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">14</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* This table contains the hardware specific values for the modulation rates. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">lbtf_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_cmd_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lbtf_private</span><span class="p">,</span>
					 <span class="n">cmd_work</span><span class="p">);</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="cm">/* command response? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_response_rxed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_response_rxed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
		<span class="n">lbtf_process_rx_command</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_timed_out</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_retries</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbtf_complete_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmdnode</span><span class="p">,</span>
					      <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">);</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* Stick it back at the _top_ of the pending</span>
<span class="cm">			 * queue for immediate resubmission */</span>
			<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">,</span> <span class="s">&quot;fw not ready&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Execute the next command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span>
		<span class="n">lbtf_execute_next_command</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbtf_setup_firmware: initialize firmware.</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv    A pointer to struct lbtf_private structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbtf_setup_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_FW</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Read priv address from HW</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbtf_update_hw_spec</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lbtf_set_mac_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">lbtf_set_radio_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_FW</span><span class="p">,</span> <span class="s">&quot;ret: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  This function handles the timeout of command sending.</span>
<span class="cm"> *  It will re-send the same command again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">command_timer_fn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;libertastf: command timer expired; &quot;</span>
				  <span class="s">&quot;no pending command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;libertas: command %x timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">lbtf_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbtf_init_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_timer</span><span class="p">,</span> <span class="n">command_timer_fn</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdfreeq</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>

	<span class="cm">/* Allocate the command buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lbtf_allocate_cmd_buffer</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_free_adapter</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
	<span class="n">lbtf_free_cmd_buffer</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_timer</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_op_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_to_tx</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">lbtf_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * queue will be restarted when we receive transmission feedback if</span>
<span class="cm">	 * there are no buffered multicast frames to send</span>
<span class="cm">	 */</span>
	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_tx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">lbtf_private</span><span class="p">,</span>
					 <span class="n">tx_work</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">txpd</span> <span class="o">*</span><span class="n">txpd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span> <span class="o">|</span> <span class="n">LBTF_DEB_TX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bc_ps_buf</span><span class="p">)))</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bc_ps_buf</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_to_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_to_tx</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_to_tx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span> <span class="o">|</span> <span class="n">LBTF_DEB_TX</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">info</span>  <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">txpd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">txpd</span> <span class="o">*</span><span class="p">)</span>  <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txpd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">surpriseremoved</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span> <span class="o">|</span> <span class="n">LBTF_DEB_TX</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">txpd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txpd</span><span class="p">));</span>
	<span class="cm">/* Activate per-packet rate selection */</span>
	<span class="n">txpd</span><span class="o">-&gt;</span><span class="n">tx_control</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">MRVL_PER_PACKET_RATE</span> <span class="o">|</span>
			     <span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>

	<span class="cm">/* copy destination address from 802.11 header */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">txpd</span><span class="o">-&gt;</span><span class="n">tx_dest_addr_high</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txpd</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span>
		<span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">txpd</span><span class="o">-&gt;</span><span class="n">tx_packet_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">txpd</span><span class="o">-&gt;</span><span class="n">tx_packet_location</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txpd</span><span class="p">));</span>
	<span class="n">lbtf_deb_hex</span><span class="p">(</span><span class="n">LBTF_DEB_TX</span><span class="p">,</span> <span class="s">&quot;TX Data&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_host_to_card</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MVMS_DAT</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;TX error: %d&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span> <span class="o">|</span> <span class="n">LBTF_DEB_TX</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbtf_op_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_ready</span><span class="p">)</span>
		<span class="cm">/* Upload firmware */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_prog_firmware</span><span class="p">(</span><span class="n">card</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_prog_firmware</span><span class="p">;</span>

	<span class="cm">/* poke the firmware */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">WLAN_CAPABILITY_SHORT_PREAMBLE</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radioon</span> <span class="o">=</span> <span class="n">RADIO_ON</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">=</span> <span class="n">CMD_ACT_MAC_RX_ON</span> <span class="o">|</span> <span class="n">CMD_ACT_MAC_TX_ON</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbtf_setup_firmware</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_prog_firmware</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">&lt;</span> <span class="n">LBTF_FW_VER_MIN</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">&gt;</span> <span class="n">LBTF_FW_VER_MAX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_prog_firmware</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;libertastf: Marvell WLAN 802.11 thinfirm adapter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_prog_firmware:</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_reset_device</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">,</span> <span class="s">&quot;error programing fw; ret=%d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>

	<span class="cm">/* Flush pending command nodes */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">cmdnode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdwaitqwoken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdwait_q</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bc_ps_buf</span><span class="p">)))</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radioon</span> <span class="o">=</span> <span class="n">RADIO_OFF</span><span class="p">;</span>
	<span class="n">lbtf_set_radio_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbtf_op_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">lbtf_set_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">LBTF_AP_MODE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">lbtf_set_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">LBTF_STA_MODE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lbtf_set_mac_address</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span>
		<span class="n">lbtf_beacon_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lbtf_set_mode</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">LBTF_PASSIVE_MODE</span><span class="p">);</span>
	<span class="n">lbtf_set_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbtf_op_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_freq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_freq</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">;</span>
		<span class="n">lbtf_set_channel</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">lbtf_op_prepare_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">netdev_hw_addr_list</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_hw_addr_list_count</span><span class="p">(</span><span class="n">mc_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc_count</span> <span class="o">||</span> <span class="n">mc_count</span> <span class="o">&gt;</span> <span class="n">MRVDRV_MAX_MULTICAST_LIST_SIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">mc_count</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_of_multicastmacaddr</span> <span class="o">=</span> <span class="n">mc_count</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_hw_addr_list_for_each</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mc_list</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multicastlist</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">],</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">mc_count</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SUPPORTED_FIF_FLAGS  (FIF_PROMISC_IN_BSS | FIF_ALLMULTI)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_op_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">new_flags</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_mac_control</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>

	<span class="n">changed_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FIF_FLAGS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FIF_FLAGS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">changed_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIF_PROMISC_IN_BSS</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">|=</span> <span class="n">CMD_ACT_MAC_PROMISCUOUS_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_ACT_MAC_PROMISCUOUS_ENABLE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">multicast</span> <span class="o">&gt;</span> <span class="n">MRVDRV_MAX_MULTICAST_LIST_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">|=</span> <span class="n">CMD_ACT_MAC_ALL_MULTICAST_ENABLE</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_ACT_MAC_MULTICAST_ENABLE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">multicast</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">|=</span> <span class="n">CMD_ACT_MAC_MULTICAST_ENABLE</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CMD_ACT_MAC_ALL_MULTICAST_ENABLE</span><span class="p">;</span>
		<span class="n">lbtf_cmd_set_mac_multicast_addr</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CMD_ACT_MAC_MULTICAST_ENABLE</span> <span class="o">|</span>
				       <span class="n">CMD_ACT_MAC_ALL_MULTICAST_ENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_of_multicastmacaddr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_of_multicastmacaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lbtf_cmd_set_mac_multicast_addr</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span> <span class="o">!=</span> <span class="n">old_mac_control</span><span class="p">)</span>
		<span class="n">lbtf_set_mac_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_op_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BSS_CHANGED_BEACON</span> <span class="o">|</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
			<span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lbtf_beacon_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">beacon</span><span class="p">);</span>
				<span class="n">kfree_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>
				<span class="n">lbtf_beacon_ctrl</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						 <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">activate</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="n">lbtf_set_bssid</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">activate</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">CMD_TYPE_SHORT_PREAMBLE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">CMD_TYPE_LONG_PREAMBLE</span><span class="p">;</span>
		<span class="n">lbtf_set_radio_control</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MACOPS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lbtf_op_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">lbtf_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span>			<span class="o">=</span> <span class="n">lbtf_op_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>			<span class="o">=</span> <span class="n">lbtf_op_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>			<span class="o">=</span> <span class="n">lbtf_op_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span>		<span class="o">=</span> <span class="n">lbtf_op_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span>	<span class="o">=</span> <span class="n">lbtf_op_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span>			<span class="o">=</span> <span class="n">lbtf_op_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_multicast</span>	<span class="o">=</span> <span class="n">lbtf_op_prepare_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>	<span class="o">=</span> <span class="n">lbtf_op_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span>	<span class="o">=</span> <span class="n">lbtf_op_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_survey</span>		<span class="o">=</span> <span class="n">lbtf_op_get_survey</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">lbtf_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rxpd</span> <span class="o">*</span><span class="n">prxpd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_padding</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_RX</span><span class="p">);</span>

	<span class="n">prxpd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rxpd</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">prxpd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">MRVDRV_RXPD_STATUS_OK</span><span class="p">)))</span>
		<span class="n">stats</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_FAILED_FCS_CRC</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_freq</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">prxpd</span><span class="o">-&gt;</span><span class="n">snr</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">prxpd</span><span class="o">-&gt;</span><span class="n">nf</span><span class="p">;</span>
	<span class="cm">/* Marvell rate index has a hole at value 4 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prxpd</span><span class="o">-&gt;</span><span class="n">rx_rate</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="o">--</span><span class="n">prxpd</span><span class="o">-&gt;</span><span class="n">rx_rate</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">prxpd</span><span class="o">-&gt;</span><span class="n">rx_rate</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxpd</span><span class="p">));</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">need_padding</span> <span class="o">=</span> <span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">need_padding</span> <span class="o">^=</span> <span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">);</span>
	<span class="n">need_padding</span> <span class="o">^=</span> <span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">IEEE80211_QOS_CTL_A_MSDU_PRESENT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_padding</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">));</span>

	<span class="n">lbtf_deb_rx</span><span class="p">(</span><span class="s">&quot;rx data: skb-&gt;len-sizeof(RxPd) = %d-%zd = %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxpd</span><span class="p">),</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rxpd</span><span class="p">));</span>
	<span class="n">lbtf_deb_hex</span><span class="p">(</span><span class="n">LBTF_DEB_RX</span><span class="p">,</span> <span class="s">&quot;RX Data&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
	             <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">100</span><span class="p">));</span>

	<span class="n">ieee80211_rx_irqsafe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_RX</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbtf_rx</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * lbtf_add_card: Add and initialize the card, no fw upload yet.</span>
<span class="cm"> *</span>
<span class="cm"> *  @card    A pointer to card</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: pointer to struct lbtf_priv.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="nf">lbtf_add_card</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lbtf_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lbtf_init_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_init_adapter</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_HOST_BROADCAST_PS_BUFFERING</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txpd</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">lbtf_channels</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lbtf_channels</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">lbtf_rates</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lbtf_rates</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbtf_rates</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lbtf_channels</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>
	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bc_ps_buf</span><span class="p">);</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">dmdev</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">,</span> <span class="n">lbtf_cmd_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">lbtf_tx_work</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_init_adapter</span><span class="p">;</span>

	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

<span class="nl">err_init_adapter:</span>
	<span class="n">lbtf_free_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">,</span> <span class="s">&quot;priv %p&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbtf_add_card</span><span class="p">);</span>


<span class="kt">int</span> <span class="nf">lbtf_remove_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">surpriseremoved</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_timer</span><span class="p">);</span>
	<span class="n">lbtf_free_adapter</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

    <span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbtf_remove_card</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">lbtf_send_tx_feedback</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">retrycnt</span><span class="p">,</span> <span class="n">u8</span> <span class="n">fail</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>

	<span class="n">ieee80211_tx_info_clear_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Commented out, otherwise we never go beyond 1Mbit/s using mac80211</span>
<span class="cm">	 * default pid rc algorithm.</span>
<span class="cm">	 *</span>
<span class="cm">	 * info-&gt;status.retry_count = MRVL_DEFAULT_RETRIES - retrycnt;</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">fail</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">txpd</span><span class="p">));</span>
	<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">skb_to_tx</span> <span class="o">&amp;&amp;</span> <span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bc_ps_buf</span><span class="p">))</span>
		<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">lbtf_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbtf_send_tx_feedback</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">lbtf_bcn_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bc_ps_buf</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bool</span> <span class="n">tx_buff_bc</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_buffered_bc</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bc_ps_buf</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="n">tx_buff_bc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_buff_bc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">lbtf_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_beacon_set</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbtf_bcn_sent</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">lbtf_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
	<span class="n">lbtf_wq</span> <span class="o">=</span> <span class="n">create_workqueue</span><span class="p">(</span><span class="s">&quot;libertastf&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lbtf_wq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;libertastf: couldn&#39;t create workqueue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">lbtf_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">lbtf_wq</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_MAIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">lbtf_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">lbtf_exit_module</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Libertas WLAN Thinfirm Driver Library&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Cozybit Inc.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
