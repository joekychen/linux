<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › libertas_tf › cmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (C) 2008, cozybit Inc.</span>
<span class="cm"> *  Copyright (C) 2003-2006, Marvell International Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or (at</span>
<span class="cm"> *  your option) any later version.</span>
<span class="cm"> */</span>
<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/hardirq.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &quot;libertas_tf.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">channel_range</span> <span class="n">channel_ranges</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">LBTF_REGDOMAIN_US</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LBTF_REGDOMAIN_CA</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LBTF_REGDOMAIN_EU</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LBTF_REGDOMAIN_JP</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LBTF_REGDOMAIN_SP</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">LBTF_REGDOMAIN_FR</span><span class="p">,</span>		<span class="mi">1</span><span class="p">,</span> <span class="mi">14</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">u16</span> <span class="n">lbtf_region_code_to_index</span><span class="p">[</span><span class="n">MRVDRV_MAX_REGION_CODE</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="n">LBTF_REGDOMAIN_US</span><span class="p">,</span> <span class="n">LBTF_REGDOMAIN_CA</span><span class="p">,</span> <span class="n">LBTF_REGDOMAIN_EU</span><span class="p">,</span>
	<span class="n">LBTF_REGDOMAIN_SP</span><span class="p">,</span> <span class="n">LBTF_REGDOMAIN_FR</span><span class="p">,</span> <span class="n">LBTF_REGDOMAIN_JP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">lbtf_get_cmd_ctrl_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> *  lbtf_cmd_copyback - Simple callback that copies response back into command</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv	A pointer to struct lbtf_private structure</span>
<span class="cm"> *  @extra	A pointer to the original command structure for which</span>
<span class="cm"> *		&#39;resp&#39; is a response</span>
<span class="cm"> *  @resp	A pointer to the command response</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: 0 on success, error on failure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lbtf_cmd_copyback</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">extra</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">copy_len</span><span class="p">;</span>

	<span class="n">copy_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">resp</span><span class="p">,</span> <span class="n">copy_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbtf_cmd_copyback</span><span class="p">);</span>

<span class="cp">#define CHAN_TO_IDX(chan) ((chan) - 1)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_geo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">channel_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="n">channel_ranges</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">channel_ranges</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">regdomain</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">regioncode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">range</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">channel_ranges</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">.</span><span class="n">start</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">.</span><span class="n">end</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">CHAN_TO_IDX</span><span class="p">(</span><span class="n">ch</span><span class="p">)].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbtf_update_hw_spec: Updates the hardware details.</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv    	A pointer to struct lbtf_private structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: 0 on success, error on failure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lbtf_update_hw_spec</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_get_hw_spec</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">permanentaddr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbtf_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_GET_HW_SPEC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwcapinfo</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">fwcapinfo</span><span class="p">);</span>

	<span class="cm">/* The firmware release is in an interesting format: the patch</span>
<span class="cm">	 * level is in the most significant nibble ... so fix that: */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">fwrelease</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;libertastf: %pM, fw %u.%u.%up%u, cap 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">permanentaddr</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwrelease</span>       <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fwcapinfo</span><span class="p">);</span>
	<span class="n">lbtf_deb_cmd</span><span class="p">(</span><span class="s">&quot;GET_HW_SPEC: hardware interface 0x%x, hardware spec 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">cmd</span><span class="p">.</span><span class="n">hwifversion</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">version</span><span class="p">);</span>

	<span class="cm">/* Clamp region code to 8-bit since FW spec indicates that it should</span>
<span class="cm">	 * only ever be 8-bit, even though the field size is 16-bit.  Some</span>
<span class="cm">	 * firmware returns non-zero high 8 bits here.</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regioncode</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">regioncode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MRVDRV_MAX_REGION_CODE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* use the region code to search for the index */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">regioncode</span> <span class="o">==</span> <span class="n">lbtf_region_code_to_index</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if it&#39;s unidentified region code, use the default (USA) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MRVDRV_MAX_REGION_CODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">regioncode</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;unidentified region code; using the default (USA)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="n">memmove</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">permanentaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_addr</span><span class="p">);</span>

	<span class="n">lbtf_geo_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbtf_set_channel: Set the radio channel</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv	A pointer to struct lbtf_private structure</span>
<span class="cm"> *  @channel	The desired channel, or 0 to clear a locked channel</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: 0 on success, error on failure</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lbtf_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_rf_channel</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_OPT_802_11_RF_CHANNEL_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbtf_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_RF_CHANNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbtf_beacon_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_beacon_set</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">MRVL_MAX_BCN_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">size</span> <span class="o">=</span>  <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">beacon</span><span class="p">)</span> <span class="o">+</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">beacon</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_BEACON_SET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbtf_beacon_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">beacon_enable</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">beacon_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_beacon_control</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_SET</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">beacon_enable</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">beacon_enable</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">beacon_int</span><span class="p">);</span>

	<span class="n">lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_BEACON_CTRL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_queue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdnode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;QUEUE_CMD: cmdnode is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">qcmd_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;DNLD_CMD: cmd size is zero</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">qcmd_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;QUEUE_CMD: inserted command 0x%04x into cmdpendingq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>

<span class="nl">qcmd_done:</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_submit_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">cmdsize</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">command</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeo</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span> <span class="o">=</span> <span class="n">cmdnode</span><span class="p">;</span>
	<span class="n">cmdsize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">command</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>

	<span class="n">lbtf_deb_cmd</span><span class="p">(</span><span class="s">&quot;DNLD_CMD: command 0x%04x, seq %d, size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">command</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="p">),</span> <span class="n">cmdsize</span><span class="p">);</span>
	<span class="n">lbtf_deb_hex</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">,</span> <span class="s">&quot;DNLD_CMD&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="n">cmdsize</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw_host_to_card</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">MVMS_CMD</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">cmdsize</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;DNLD_CMD: hw_host_to_card failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="cm">/* Let the timer kick in and retry, and potentially reset</span>
<span class="cm">		   the whole thing if the condition persists */</span>
		<span class="n">timeo</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the timer after transmit command */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeo</span><span class="p">);</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  This function inserts command node to cmdfreeq</span>
<span class="cm"> *  after cleans it. Requires priv-&gt;driver_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__lbtf_cleanup_and_insert_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdnode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">cl_ins_out</span><span class="p">;</span>

	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">callback_arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">LBS_CMD_BUFFER_SIZE</span><span class="p">);</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdfreeq</span><span class="p">);</span>

<span class="nl">cl_ins_out:</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lbtf_cleanup_and_insert_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">ptempcmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__lbtf_cleanup_and_insert_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">ptempcmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbtf_complete_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">result</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdwaitqwoken</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmdwait_q</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">__lbtf_cleanup_and_insert_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbtf_cmd_set_mac_multicast_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_mac_multicast_addr</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_SET</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">nr_of_adrs</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_of_multicastmacaddr</span><span class="p">);</span>

	<span class="n">lbtf_deb_cmd</span><span class="p">(</span><span class="s">&quot;MULTICAST_ADR: setting %d addresses</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">nr_of_adrs</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">maclist</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">multicastlist</span><span class="p">,</span>
	       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_of_multicastmacaddr</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_MAC_MULTICAST_ADR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbtf_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">lbtf_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_set_mode</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_WEXT</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">lbtf_deb_wext</span><span class="p">(</span><span class="s">&quot;Switching to mode: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_SET_MODE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_WEXT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbtf_set_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">bool</span> <span class="n">activate</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_set_bssid</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">activate</span> <span class="o">=</span> <span class="n">activate</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">activate</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_SET_BSSID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbtf_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_mac_address</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_SET</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">macadd</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_MAC_ADDRESS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lbtf_set_radio_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ds_802_11_radio_control</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">CMD_ACT_SET</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CMD_TYPE_SHORT_PREAMBLE</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SET_SHORT_PREAMBLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_TYPE_LONG_PREAMBLE</span>:
		<span class="n">cmd</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SET_LONG_PREAMBLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CMD_TYPE_AUTO_PREAMBLE</span>:
	<span class="nl">default:</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">SET_AUTO_PREAMBLE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">radioon</span><span class="p">)</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">control</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TURN_ON_RF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">control</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="n">TURN_ON_RF</span><span class="p">);</span>

	<span class="n">lbtf_deb_cmd</span><span class="p">(</span><span class="s">&quot;RADIO_SET: radio %d, preamble %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">radioon</span><span class="p">,</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">preamble</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">lbtf_cmd_with_response</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_802_11_RADIO_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbtf_set_mac_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ds_mac_control</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_control</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">CMD_MAC_CONTROL</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">cmd</span><span class="p">.</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbtf_allocate_cmd_buffer - Allocates cmd buffer, links it to free cmd queue</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv	A pointer to struct lbtf_private structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lbtf_allocate_cmd_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdarray</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>

	<span class="cm">/* Allocate and initialize the command array */</span>
	<span class="n">bufsize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cmd_ctrl_node</span><span class="p">)</span> <span class="o">*</span> <span class="n">LBS_NUM_CMD_BUFFERS</span><span class="p">;</span>
	<span class="n">cmdarray</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">bufsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdarray</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;ALLOC_CMD_BUF: tempcmd_array is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_array</span> <span class="o">=</span> <span class="n">cmdarray</span><span class="p">;</span>

	<span class="cm">/* Allocate and initialize each command buffer in the command array */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LBS_NUM_CMD_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmdarray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">LBS_CMD_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmdarray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdbuf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;ALLOC_CMD_BUF: ptempvirtualaddr is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LBS_NUM_CMD_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdarray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdwait_q</span><span class="p">);</span>
		<span class="n">lbtf_cleanup_and_insert_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmdarray</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbtf_free_cmd_buffer - Frees the cmd buffer.</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv	A pointer to struct lbtf_private structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: 0</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lbtf_free_cmd_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdarray</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>

	<span class="cm">/* need to check if cmd array is allocated or not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_array</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;FREE_CMD_BUF: cmd_array is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdarray</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_array</span><span class="p">;</span>

	<span class="cm">/* Release shared memory buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LBS_NUM_CMD_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">cmdarray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdbuf</span><span class="p">);</span>
		<span class="n">cmdarray</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmdbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Release cmd_ctrl_node */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_array</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_array</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbtf_get_cmd_ctrl_node - Gets free cmd node from free cmd queue.</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv		A pointer to struct lbtf_private structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: pointer to a struct cmd_ctrl_node or NULL if none available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="nf">lbtf_get_cmd_ctrl_node</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">tempnode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdfreeq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tempnode</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdfreeq</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">cmd_ctrl_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempnode</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;GET_CMD_NODE: cmd_ctrl_node is not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tempnode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">tempnode</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *  lbtf_execute_next_command: execute next command in cmd pending queue.</span>
<span class="cm"> *</span>
<span class="cm"> *  @priv     A pointer to struct lbtf_private structure</span>
<span class="cm"> *</span>
<span class="cm"> *  Returns: 0 on success.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lbtf_execute_next_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Debug group is lbtf_deb_THREAD and not lbtf_deb_HOST, because the</span>
<span class="cm">	 * only caller to us is lbtf_thread() and we get even when a</span>
<span class="cm">	 * data packet is received */</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_THREAD</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_alert</span><span class="p">(</span><span class="s">&quot;EXEC_NEXT_CMD: already processing command!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmdnode</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmdpendingq</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">cmd_ctrl_node</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmdnode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">;</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;EXEC_NEXT_CMD: sending command 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">));</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">lbtf_submit_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmdnode</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_THREAD</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="nf">__lbtf_cmd_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
	<span class="kt">uint16_t</span> <span class="n">command</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">in_cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_cmd_size</span><span class="p">,</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="p">),</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">callback_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">surpriseremoved</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;PREP_CMD: card removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">cmdnode</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOENT</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdnode</span> <span class="o">=</span> <span class="n">lbtf_get_cmd_ctrl_node</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmdnode</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;PREP_CMD: cmdnode is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Wake up main thread to execute next command */</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">lbtf_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
		<span class="n">cmdnode</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOBUFS</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">callback</span> <span class="o">=</span> <span class="n">callback</span><span class="p">;</span>
	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">callback_arg</span> <span class="o">=</span> <span class="n">callback_arg</span><span class="p">;</span>

	<span class="cm">/* Copy the incoming command to the buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="p">,</span> <span class="n">in_cmd</span><span class="p">,</span> <span class="n">in_cmd_size</span><span class="p">);</span>

	<span class="cm">/* Set sequence number, clean result, move to buffer */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="o">++</span><span class="p">;</span>
	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">command</span><span class="p">);</span>
	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">size</span>    <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">in_cmd_size</span><span class="p">);</span>
	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">seqnum</span>  <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="p">);</span>
	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">result</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lbtf_deb_host</span><span class="p">(</span><span class="s">&quot;PREP_CMD: command 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>

	<span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdwaitqwoken</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lbtf_queue_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmdnode</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">lbtf_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">,</span> <span class="s">&quot;ret %p&quot;</span><span class="p">,</span> <span class="n">cmdnode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cmdnode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lbtf_cmd_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">command</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">in_cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_cmd_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
	<span class="n">__lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">in_cmd</span><span class="p">,</span> <span class="n">in_cmd_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__lbtf_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">uint16_t</span> <span class="n">command</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">in_cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in_cmd_size</span><span class="p">,</span>
	      <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="p">),</span>
	      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">callback_arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_ctrl_node</span> <span class="o">*</span><span class="n">cmdnode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">);</span>

	<span class="n">cmdnode</span> <span class="o">=</span> <span class="n">__lbtf_cmd_async</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">in_cmd</span><span class="p">,</span> <span class="n">in_cmd_size</span><span class="p">,</span>
				  <span class="n">callback</span><span class="p">,</span> <span class="n">callback_arg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">cmdnode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">cmdnode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdwait_q</span><span class="p">,</span>
				       <span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">cmdwaitqwoken</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PREP_CMD: command 0x%04x interrupted by signal: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">command</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cmdnode</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PREP_CMD: command 0x%04x failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">command</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">__lbtf_cleanup_and_insert_cmd</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cmdnode</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_HOST</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__lbtf_cmd</span><span class="p">);</span>

<span class="cm">/* Call holding driver_lock */</span>
<span class="kt">void</span> <span class="nf">lbtf_cmd_response_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_response_rxed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">lbtf_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_work</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lbtf_cmd_response_rx</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">lbtf_process_rx_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">lbtf_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint16_t</span> <span class="n">respcmd</span><span class="p">,</span> <span class="n">curcmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cmd_header</span> <span class="o">*</span><span class="n">resp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">uint16_t</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">lbtf_deb_enter</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">resp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_resp_buff</span><span class="p">;</span>
	<span class="n">curcmd</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="n">respcmd</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;libertastf: cmd response 0x%04x, seq %d, size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">respcmd</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">seqnum</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="o">-&gt;</span><span class="n">cmdbuf</span><span class="o">-&gt;</span><span class="n">seqnum</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">respcmd</span> <span class="o">!=</span> <span class="n">CMD_RET</span><span class="p">(</span><span class="n">curcmd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">resp</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0004</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* 0x0004 means -EAGAIN. Drop the response, let it time out</span>
<span class="cm">		   and be resubmitted */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now we got response from FW, cancel the command timer */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_timer</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cmd_timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_retries</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">nr_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* If the command is not successful, cleanup and return failure */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">respcmd</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Handling errors here</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">respcmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CMD_RET</span><span class="p">(</span><span class="n">CMD_GET_HW_SPEC</span><span class="p">)</span>:
		<span class="k">case</span> <span class="n">CMD_RET</span><span class="p">(</span><span class="n">CMD_802_11_RESET</span><span class="p">)</span>:
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;libertastf: reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">lbtf_complete_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="o">-&gt;</span><span class="n">callback</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="o">-&gt;</span><span class="n">callback_arg</span><span class="p">,</span>
				<span class="n">resp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Clean up and Put current command back to cmdfreeq */</span>
		<span class="n">lbtf_complete_command</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_cmd</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">driver_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">lbtf_deb_leave_args</span><span class="p">(</span><span class="n">LBTF_DEB_CMD</span><span class="p">,</span> <span class="s">&quot;ret %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
