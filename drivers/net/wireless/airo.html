<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › airo.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>airo.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*======================================================================</span>

<span class="cm">    Aironet driver for 4500 and 4800 series cards</span>

<span class="cm">    This code is released under both the GPL version 2 and BSD licenses.</span>
<span class="cm">    Either license may be used.  The respective licenses are found at</span>
<span class="cm">    the end of this file.</span>

<span class="cm">    This code was developed by Benjamin Reed &lt;breed@users.sourceforge.net&gt;</span>
<span class="cm">    including portions of which come from the Aironet PC4500</span>
<span class="cm">    Developer&#39;s Reference Manual and used with permission.  Copyright</span>
<span class="cm">    (C) 1999 Benjamin Reed.  All Rights Reserved.  Permission to use</span>
<span class="cm">    code in the Developer&#39;s manual was granted for this driver by</span>
<span class="cm">    Aironet.  Major code contributions were received from Javier Achirica</span>
<span class="cm">    &lt;achirica@users.sourceforge.net&gt; and Jean Tourrilhes &lt;jt@hpl.hp.com&gt;.</span>
<span class="cm">    Code was also integrated from the Cisco Aironet driver for Linux.</span>
<span class="cm">    Support for MPI350 cards was added by Fabrice Bellet</span>
<span class="cm">    &lt;fabrice@bellet.info&gt;.</span>

<span class="cm">======================================================================*/</span>

<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/scatterlist.h&gt;</span>
<span class="cp">#include &lt;linux/crypto.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>

<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;net/iw_handler.h&gt;</span>

<span class="cp">#include &quot;airo.h&quot;</span>

<span class="cp">#define DRV_NAME &quot;airo&quot;</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">card_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x14b9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14b9</span><span class="p">,</span> <span class="mh">0x4500</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14b9</span><span class="p">,</span> <span class="mh">0x4800</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14b9</span><span class="p">,</span> <span class="mh">0x0340</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14b9</span><span class="p">,</span> <span class="mh">0x0350</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14b9</span><span class="p">,</span> <span class="mh">0x5000</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x14b9</span><span class="p">,</span> <span class="mh">0xa504</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">card_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">airo_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">airo_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">airo_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">airo_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">airo_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">card_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">airo_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">airo_pci_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">airo_pci_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">airo_pci_resume</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PCI */</span><span class="cp"></span>

<span class="cm">/* Include Wireless Extension definition and check version - Jean II */</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#define WIRELESS_SPY		</span><span class="cm">/* enable iwspy support */</span><span class="cp"></span>
<span class="cp">#include &lt;net/iw_handler.h&gt;	</span><span class="cm">/* New driver API */</span><span class="cp"></span>

<span class="cp">#define CISCO_EXT		</span><span class="cm">/* enable Cisco extensions */</span><span class="cp"></span>
<span class="cp">#ifdef CISCO_EXT</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#endif</span>

<span class="cm">/* Hack to do some power saving */</span>
<span class="cp">#define POWER_ON_DOWN</span>

<span class="cm">/* As you can see this list is HUGH!</span>
<span class="cm">   I really don&#39;t know what a lot of these counts are about, but they</span>
<span class="cm">   are all here for completeness.  If the IGNLABEL macro is put in</span>
<span class="cm">   infront of the label, that statistic will not be included in the list</span>
<span class="cm">   of statistics in the /proc filesystem */</span>

<span class="cp">#define IGNLABEL(comment) NULL</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">statsLabels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;RxOverrun&quot;</span><span class="p">,</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;RxPlcpCrcErr&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;RxPlcpFormatErr&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;RxPlcpLengthErr&quot;</span><span class="p">),</span>
	<span class="s">&quot;RxMacCrcErr&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxMacCrcOk&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxWepErr&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxWepOk&quot;</span><span class="p">,</span>
	<span class="s">&quot;RetryLong&quot;</span><span class="p">,</span>
	<span class="s">&quot;RetryShort&quot;</span><span class="p">,</span>
	<span class="s">&quot;MaxRetries&quot;</span><span class="p">,</span>
	<span class="s">&quot;NoAck&quot;</span><span class="p">,</span>
	<span class="s">&quot;NoCts&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxAck&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxCts&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxAck&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxRts&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxCts&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxMc&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxBc&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxUcFrags&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxUcPackets&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxBeacon&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxBeacon&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxSinColl&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxMulColl&quot;</span><span class="p">,</span>
	<span class="s">&quot;DefersNo&quot;</span><span class="p">,</span>
	<span class="s">&quot;DefersProt&quot;</span><span class="p">,</span>
	<span class="s">&quot;DefersEngy&quot;</span><span class="p">,</span>
	<span class="s">&quot;DupFram&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxFragDisc&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxAged&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxAged&quot;</span><span class="p">,</span>
	<span class="s">&quot;LostSync-MaxRetry&quot;</span><span class="p">,</span>
	<span class="s">&quot;LostSync-MissedBeacons&quot;</span><span class="p">,</span>
	<span class="s">&quot;LostSync-ArlExceeded&quot;</span><span class="p">,</span>
	<span class="s">&quot;LostSync-Deauth&quot;</span><span class="p">,</span>
	<span class="s">&quot;LostSync-Disassoced&quot;</span><span class="p">,</span>
	<span class="s">&quot;LostSync-TsfTiming&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostTxMc&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostTxBc&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostTxUc&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostTxFail&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostRxMc&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostRxBc&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostRxUc&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostRxDiscard&quot;</span><span class="p">,</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacTxMc&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacTxBc&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacTxUc&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacTxFail&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacRxMc&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacRxBc&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacRxUc&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacRxDiscard&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;HmacRxAccepted&quot;</span><span class="p">),</span>
	<span class="s">&quot;SsidMismatch&quot;</span><span class="p">,</span>
	<span class="s">&quot;ApMismatch&quot;</span><span class="p">,</span>
	<span class="s">&quot;RatesMismatch&quot;</span><span class="p">,</span>
	<span class="s">&quot;AuthReject&quot;</span><span class="p">,</span>
	<span class="s">&quot;AuthTimeout&quot;</span><span class="p">,</span>
	<span class="s">&quot;AssocReject&quot;</span><span class="p">,</span>
	<span class="s">&quot;AssocTimeout&quot;</span><span class="p">,</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonOutsideTable&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus1&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus2&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus3&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus4&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus5&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus6&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus7&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus8&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus9&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus10&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus11&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus12&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus13&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus14&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus15&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus16&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus17&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus18&quot;</span><span class="p">),</span>
	<span class="n">IGNLABEL</span><span class="p">(</span><span class="s">&quot;ReasonStatus19&quot;</span><span class="p">),</span>
	<span class="s">&quot;RxMan&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxMan&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxRefresh&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxRefresh&quot;</span><span class="p">,</span>
	<span class="s">&quot;RxPoll&quot;</span><span class="p">,</span>
	<span class="s">&quot;TxPoll&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostRetries&quot;</span><span class="p">,</span>
	<span class="s">&quot;LostSync-HostReq&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostTxBytes&quot;</span><span class="p">,</span>
	<span class="s">&quot;HostRxBytes&quot;</span><span class="p">,</span>
	<span class="s">&quot;ElapsedUsec&quot;</span><span class="p">,</span>
	<span class="s">&quot;ElapsedSec&quot;</span><span class="p">,</span>
	<span class="s">&quot;LostSyncBetterAP&quot;</span><span class="p">,</span>
	<span class="s">&quot;PrivacyMismatch&quot;</span><span class="p">,</span>
	<span class="s">&quot;Jammed&quot;</span><span class="p">,</span>
	<span class="s">&quot;DiscRxNotWepped&quot;</span><span class="p">,</span>
	<span class="s">&quot;PhyEleMismatch&quot;</span><span class="p">,</span>
	<span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="cp">#ifndef RUN_AT</span>
<span class="cp">#define RUN_AT(x) (jiffies+(x))</span>
<span class="cp">#endif</span>


<span class="cm">/* These variables are for insmod, since it seems that the rates</span>
<span class="cm">   can only be set in setup_card.  Rates should be a comma separated</span>
<span class="cm">   (no spaces) list of rates (up to 8). */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rates</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ssids</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">io</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="n">maxencrypt</span> <span class="cm">/* = 0 */</span><span class="p">;</span> <span class="cm">/* The highest rate that the card can encrypt at.</span>
<span class="cm">		       0 means no limit.  For old cards this was 4 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">auto_wep</span> <span class="cm">/* = 0 */</span><span class="p">;</span> <span class="cm">/* If set, it tries to figure out the wep mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aux_bap</span> <span class="cm">/* = 0 */</span><span class="p">;</span> <span class="cm">/* Checks to see if the aux ports are needed to read</span>
<span class="cm">		    the bap, needed on some older cards and buses. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">adhoc</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">probe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_uid</span> <span class="cm">/* = 0 */</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_gid</span> <span class="cm">/* = 0 */</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">airo_perm</span> <span class="o">=</span> <span class="mo">0555</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_perm</span> <span class="o">=</span> <span class="mo">0644</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Benjamin Reed&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Support for Cisco/Aironet 802.11 wireless ethernet cards.  &quot;</span>
		   <span class="s">&quot;Direct support for ISA/PCI/MPI cards and support for PCMCIA when used with airo_cs.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;Aironet 4500, 4800 and Cisco 340/350&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">rates</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">ssids</span><span class="p">,</span> <span class="n">charp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">auto_wep</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">auto_wep</span><span class="p">,</span>
		 <span class="s">&quot;If non-zero, the driver will keep looping through the authentication options until an association is made.  &quot;</span>
		 <span class="s">&quot;The value of auto_wep is number of the wep keys to check.  &quot;</span>
		 <span class="s">&quot;A value of 2 will try using the key at index 0 and index 1.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">aux_bap</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">aux_bap</span><span class="p">,</span>
		 <span class="s">&quot;If non-zero, the driver will switch into a mode that seems to work better for older cards with some older buses.  &quot;</span>
		 <span class="s">&quot;Before switching it checks that the switch is needed.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">maxencrypt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">maxencrypt</span><span class="p">,</span>
		 <span class="s">&quot;The maximum speed that the card can do encryption.  &quot;</span>
		 <span class="s">&quot;Units are in 512kbs.  &quot;</span>
		 <span class="s">&quot;Zero (default) means there is no limit.  &quot;</span>
		 <span class="s">&quot;Older cards used to be limited to 2mbs (4).&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">adhoc</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adhoc</span><span class="p">,</span> <span class="s">&quot;If non-zero, the card will start in adhoc mode.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="s">&quot;If zero, the driver won&#39;t start the card.&quot;</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">proc_uid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">proc_uid</span><span class="p">,</span> <span class="s">&quot;The uid that the /proc files will belong to.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">proc_gid</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">proc_gid</span><span class="p">,</span> <span class="s">&quot;The gid that the /proc files will belong to.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">airo_perm</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">airo_perm</span><span class="p">,</span> <span class="s">&quot;The permission bits of /proc/[driver/]aironet.&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">proc_perm</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">proc_perm</span><span class="p">,</span> <span class="s">&quot;The permission bits of the files in /proc&quot;</span><span class="p">);</span>

<span class="cm">/* This is a kind of sloppy hack to get this information to OUT4500 and</span>
<span class="cm">   IN4500.  I would be extremely interested in the situation where this</span>
<span class="cm">   doesn&#39;t work though!!! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do8bitIO</span> <span class="cm">/* = 0 */</span><span class="p">;</span>

<span class="cm">/* Return codes */</span>
<span class="cp">#define SUCCESS 0</span>
<span class="cp">#define ERROR -1</span>
<span class="cp">#define NO_PACKET -2</span>

<span class="cm">/* Commands */</span>
<span class="cp">#define NOP2		0x0000</span>
<span class="cp">#define MAC_ENABLE	0x0001</span>
<span class="cp">#define MAC_DISABLE	0x0002</span>
<span class="cp">#define CMD_LOSE_SYNC	0x0003 </span><span class="cm">/* Not sure what this does... */</span><span class="cp"></span>
<span class="cp">#define CMD_SOFTRESET	0x0004</span>
<span class="cp">#define HOSTSLEEP	0x0005</span>
<span class="cp">#define CMD_MAGIC_PKT	0x0006</span>
<span class="cp">#define CMD_SETWAKEMASK	0x0007</span>
<span class="cp">#define CMD_READCFG	0x0008</span>
<span class="cp">#define CMD_SETMODE	0x0009</span>
<span class="cp">#define CMD_ALLOCATETX	0x000a</span>
<span class="cp">#define CMD_TRANSMIT	0x000b</span>
<span class="cp">#define CMD_DEALLOCATETX 0x000c</span>
<span class="cp">#define NOP		0x0010</span>
<span class="cp">#define CMD_WORKAROUND	0x0011</span>
<span class="cp">#define CMD_ALLOCATEAUX 0x0020</span>
<span class="cp">#define CMD_ACCESS	0x0021</span>
<span class="cp">#define CMD_PCIBAP	0x0022</span>
<span class="cp">#define CMD_PCIAUX	0x0023</span>
<span class="cp">#define CMD_ALLOCBUF	0x0028</span>
<span class="cp">#define CMD_GETTLV	0x0029</span>
<span class="cp">#define CMD_PUTTLV	0x002a</span>
<span class="cp">#define CMD_DELTLV	0x002b</span>
<span class="cp">#define CMD_FINDNEXTTLV	0x002c</span>
<span class="cp">#define CMD_PSPNODES	0x0030</span>
<span class="cp">#define CMD_SETCW	0x0031    </span>
<span class="cp">#define CMD_SETPCF	0x0032    </span>
<span class="cp">#define CMD_SETPHYREG	0x003e</span>
<span class="cp">#define CMD_TXTEST	0x003f</span>
<span class="cp">#define MAC_ENABLETX	0x0101</span>
<span class="cp">#define CMD_LISTBSS	0x0103</span>
<span class="cp">#define CMD_SAVECFG	0x0108</span>
<span class="cp">#define CMD_ENABLEAUX	0x0111</span>
<span class="cp">#define CMD_WRITERID	0x0121</span>
<span class="cp">#define CMD_USEPSPNODES	0x0130</span>
<span class="cp">#define MAC_ENABLERX	0x0201</span>

<span class="cm">/* Command errors */</span>
<span class="cp">#define ERROR_QUALIF 0x00</span>
<span class="cp">#define ERROR_ILLCMD 0x01</span>
<span class="cp">#define ERROR_ILLFMT 0x02</span>
<span class="cp">#define ERROR_INVFID 0x03</span>
<span class="cp">#define ERROR_INVRID 0x04</span>
<span class="cp">#define ERROR_LARGE 0x05</span>
<span class="cp">#define ERROR_NDISABL 0x06</span>
<span class="cp">#define ERROR_ALLOCBSY 0x07</span>
<span class="cp">#define ERROR_NORD 0x0B</span>
<span class="cp">#define ERROR_NOWR 0x0C</span>
<span class="cp">#define ERROR_INVFIDTX 0x0D</span>
<span class="cp">#define ERROR_TESTACT 0x0E</span>
<span class="cp">#define ERROR_TAGNFND 0x12</span>
<span class="cp">#define ERROR_DECODE 0x20</span>
<span class="cp">#define ERROR_DESCUNAV 0x21</span>
<span class="cp">#define ERROR_BADLEN 0x22</span>
<span class="cp">#define ERROR_MODE 0x80</span>
<span class="cp">#define ERROR_HOP 0x81</span>
<span class="cp">#define ERROR_BINTER 0x82</span>
<span class="cp">#define ERROR_RXMODE 0x83</span>
<span class="cp">#define ERROR_MACADDR 0x84</span>
<span class="cp">#define ERROR_RATES 0x85</span>
<span class="cp">#define ERROR_ORDER 0x86</span>
<span class="cp">#define ERROR_SCAN 0x87</span>
<span class="cp">#define ERROR_AUTH 0x88</span>
<span class="cp">#define ERROR_PSMODE 0x89</span>
<span class="cp">#define ERROR_RTYPE 0x8A</span>
<span class="cp">#define ERROR_DIVER 0x8B</span>
<span class="cp">#define ERROR_SSID 0x8C</span>
<span class="cp">#define ERROR_APLIST 0x8D</span>
<span class="cp">#define ERROR_AUTOWAKE 0x8E</span>
<span class="cp">#define ERROR_LEAP 0x8F</span>

<span class="cm">/* Registers */</span>
<span class="cp">#define COMMAND 0x00</span>
<span class="cp">#define PARAM0 0x02</span>
<span class="cp">#define PARAM1 0x04</span>
<span class="cp">#define PARAM2 0x06</span>
<span class="cp">#define STATUS 0x08</span>
<span class="cp">#define RESP0 0x0a</span>
<span class="cp">#define RESP1 0x0c</span>
<span class="cp">#define RESP2 0x0e</span>
<span class="cp">#define LINKSTAT 0x10</span>
<span class="cp">#define SELECT0 0x18</span>
<span class="cp">#define OFFSET0 0x1c</span>
<span class="cp">#define RXFID 0x20</span>
<span class="cp">#define TXALLOCFID 0x22</span>
<span class="cp">#define TXCOMPLFID 0x24</span>
<span class="cp">#define DATA0 0x36</span>
<span class="cp">#define EVSTAT 0x30</span>
<span class="cp">#define EVINTEN 0x32</span>
<span class="cp">#define EVACK 0x34</span>
<span class="cp">#define SWS0 0x28</span>
<span class="cp">#define SWS1 0x2a</span>
<span class="cp">#define SWS2 0x2c</span>
<span class="cp">#define SWS3 0x2e</span>
<span class="cp">#define AUXPAGE 0x3A</span>
<span class="cp">#define AUXOFF 0x3C</span>
<span class="cp">#define AUXDATA 0x3E</span>

<span class="cp">#define FID_TX 1</span>
<span class="cp">#define FID_RX 2</span>
<span class="cm">/* Offset into aux memory for descriptors */</span>
<span class="cp">#define AUX_OFFSET 0x800</span>
<span class="cm">/* Size of allocated packets */</span>
<span class="cp">#define PKTSIZE 1840</span>
<span class="cp">#define RIDSIZE 2048</span>
<span class="cm">/* Size of the transmit queue */</span>
<span class="cp">#define MAXTXQ 64</span>

<span class="cm">/* BAP selectors */</span>
<span class="cp">#define BAP0 0 </span><span class="cm">/* Used for receiving packets */</span><span class="cp"></span>
<span class="cp">#define BAP1 2 </span><span class="cm">/* Used for xmiting packets and working with RIDS */</span><span class="cp"></span>

<span class="cm">/* Flags */</span>
<span class="cp">#define COMMAND_BUSY 0x8000</span>

<span class="cp">#define BAP_BUSY 0x8000</span>
<span class="cp">#define BAP_ERR 0x4000</span>
<span class="cp">#define BAP_DONE 0x2000</span>

<span class="cp">#define PROMISC 0xffff</span>
<span class="cp">#define NOPROMISC 0x0000</span>

<span class="cp">#define EV_CMD 0x10</span>
<span class="cp">#define EV_CLEARCOMMANDBUSY 0x4000</span>
<span class="cp">#define EV_RX 0x01</span>
<span class="cp">#define EV_TX 0x02</span>
<span class="cp">#define EV_TXEXC 0x04</span>
<span class="cp">#define EV_ALLOC 0x08</span>
<span class="cp">#define EV_LINK 0x80</span>
<span class="cp">#define EV_AWAKE 0x100</span>
<span class="cp">#define EV_TXCPY 0x400</span>
<span class="cp">#define EV_UNKNOWN 0x800</span>
<span class="cp">#define EV_MIC 0x1000 </span><span class="cm">/* Message Integrity Check Interrupt */</span><span class="cp"></span>
<span class="cp">#define EV_AWAKEN 0x2000</span>
<span class="cp">#define STATUS_INTS (EV_AWAKE|EV_LINK|EV_TXEXC|EV_TX|EV_TXCPY|EV_RX|EV_MIC)</span>

<span class="cp">#ifdef CHECK_UNKNOWN_INTS</span>
<span class="cp">#define IGNORE_INTS ( EV_CMD | EV_UNKNOWN)</span>
<span class="cp">#else</span>
<span class="cp">#define IGNORE_INTS (~STATUS_INTS)</span>
<span class="cp">#endif</span>

<span class="cm">/* RID TYPES */</span>
<span class="cp">#define RID_RW 0x20</span>

<span class="cm">/* The RIDs */</span>
<span class="cp">#define RID_CAPABILITIES 0xFF00</span>
<span class="cp">#define RID_APINFO     0xFF01</span>
<span class="cp">#define RID_RADIOINFO  0xFF02</span>
<span class="cp">#define RID_UNKNOWN3   0xFF03</span>
<span class="cp">#define RID_RSSI       0xFF04</span>
<span class="cp">#define RID_CONFIG     0xFF10</span>
<span class="cp">#define RID_SSID       0xFF11</span>
<span class="cp">#define RID_APLIST     0xFF12</span>
<span class="cp">#define RID_DRVNAME    0xFF13</span>
<span class="cp">#define RID_ETHERENCAP 0xFF14</span>
<span class="cp">#define RID_WEP_TEMP   0xFF15</span>
<span class="cp">#define RID_WEP_PERM   0xFF16</span>
<span class="cp">#define RID_MODULATION 0xFF17</span>
<span class="cp">#define RID_OPTIONS    0xFF18</span>
<span class="cp">#define RID_ACTUALCONFIG 0xFF20 </span><span class="cm">/*readonly*/</span><span class="cp"></span>
<span class="cp">#define RID_FACTORYCONFIG 0xFF21</span>
<span class="cp">#define RID_UNKNOWN22  0xFF22</span>
<span class="cp">#define RID_LEAPUSERNAME 0xFF23</span>
<span class="cp">#define RID_LEAPPASSWORD 0xFF24</span>
<span class="cp">#define RID_STATUS     0xFF50</span>
<span class="cp">#define RID_BEACON_HST 0xFF51</span>
<span class="cp">#define RID_BUSY_HST   0xFF52</span>
<span class="cp">#define RID_RETRIES_HST 0xFF53</span>
<span class="cp">#define RID_UNKNOWN54  0xFF54</span>
<span class="cp">#define RID_UNKNOWN55  0xFF55</span>
<span class="cp">#define RID_UNKNOWN56  0xFF56</span>
<span class="cp">#define RID_MIC        0xFF57</span>
<span class="cp">#define RID_STATS16    0xFF60</span>
<span class="cp">#define RID_STATS16DELTA 0xFF61</span>
<span class="cp">#define RID_STATS16DELTACLEAR 0xFF62</span>
<span class="cp">#define RID_STATS      0xFF68</span>
<span class="cp">#define RID_STATSDELTA 0xFF69</span>
<span class="cp">#define RID_STATSDELTACLEAR 0xFF6A</span>
<span class="cp">#define RID_ECHOTEST_RID 0xFF70</span>
<span class="cp">#define RID_ECHOTEST_RESULTS 0xFF71</span>
<span class="cp">#define RID_BSSLISTFIRST 0xFF72</span>
<span class="cp">#define RID_BSSLISTNEXT  0xFF73</span>
<span class="cp">#define RID_WPA_BSSLISTFIRST 0xFF74</span>
<span class="cp">#define RID_WPA_BSSLISTNEXT  0xFF75</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">parm0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">parm1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">parm2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Cmd</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rsp0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rsp1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rsp2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Resp</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Rids and endian-ness:  The Rids will always be in cpu endian, since</span>
<span class="cm"> * this all the patches from the big-endian guys end up doing that.</span>
<span class="cm"> * so all rid access should use the read/writeXXXRid routines.</span>
<span class="cm"> */</span>

<span class="cm">/* This structure came from an email sent to me from an engineer at</span>
<span class="cm">   aironet for inclusion into this driver */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">WepKeyRid</span> <span class="n">WepKeyRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">WepKeyRid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">kindex</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">klen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* These structures are from the Aironet&#39;s PC4500 Developers Manual */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Ssid</span> <span class="n">Ssid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">Ssid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ssid</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">SsidRid</span> <span class="n">SsidRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">SsidRid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">Ssid</span> <span class="n">ssids</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">ModulationRid</span> <span class="n">ModulationRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ModulationRid</span> <span class="p">{</span>
        <span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
        <span class="n">__le16</span> <span class="n">modulation</span><span class="p">;</span>
<span class="cp">#define MOD_DEFAULT cpu_to_le16(0)</span>
<span class="cp">#define MOD_CCK cpu_to_le16(1)</span>
<span class="cp">#define MOD_MOK cpu_to_le16(2)</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">ConfigRid</span> <span class="n">ConfigRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">ConfigRid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span> <span class="cm">/* sizeof(ConfigRid) */</span>
	<span class="n">__le16</span> <span class="n">opmode</span><span class="p">;</span> <span class="cm">/* operating mode */</span>
<span class="cp">#define MODE_STA_IBSS cpu_to_le16(0)</span>
<span class="cp">#define MODE_STA_ESS cpu_to_le16(1)</span>
<span class="cp">#define MODE_AP cpu_to_le16(2)</span>
<span class="cp">#define MODE_AP_RPTR cpu_to_le16(3)</span>
<span class="cp">#define MODE_CFG_MASK cpu_to_le16(0xff)</span>
<span class="cp">#define MODE_ETHERNET_HOST cpu_to_le16(0&lt;&lt;8) </span><span class="cm">/* rx payloads converted */</span><span class="cp"></span>
<span class="cp">#define MODE_LLC_HOST cpu_to_le16(1&lt;&lt;8) </span><span class="cm">/* rx payloads left as is */</span><span class="cp"></span>
<span class="cp">#define MODE_AIRONET_EXTEND cpu_to_le16(1&lt;&lt;9) </span><span class="cm">/* enable Aironet extenstions */</span><span class="cp"></span>
<span class="cp">#define MODE_AP_INTERFACE cpu_to_le16(1&lt;&lt;10) </span><span class="cm">/* enable ap interface extensions */</span><span class="cp"></span>
<span class="cp">#define MODE_ANTENNA_ALIGN cpu_to_le16(1&lt;&lt;11) </span><span class="cm">/* enable antenna alignment */</span><span class="cp"></span>
<span class="cp">#define MODE_ETHER_LLC cpu_to_le16(1&lt;&lt;12) </span><span class="cm">/* enable ethernet LLC */</span><span class="cp"></span>
<span class="cp">#define MODE_LEAF_NODE cpu_to_le16(1&lt;&lt;13) </span><span class="cm">/* enable leaf node bridge */</span><span class="cp"></span>
<span class="cp">#define MODE_CF_POLLABLE cpu_to_le16(1&lt;&lt;14) </span><span class="cm">/* enable CF pollable */</span><span class="cp"></span>
<span class="cp">#define MODE_MIC cpu_to_le16(1&lt;&lt;15) </span><span class="cm">/* enable MIC */</span><span class="cp"></span>
	<span class="n">__le16</span> <span class="n">rmode</span><span class="p">;</span> <span class="cm">/* receive mode */</span>
<span class="cp">#define RXMODE_BC_MC_ADDR cpu_to_le16(0)</span>
<span class="cp">#define RXMODE_BC_ADDR cpu_to_le16(1) </span><span class="cm">/* ignore multicasts */</span><span class="cp"></span>
<span class="cp">#define RXMODE_ADDR cpu_to_le16(2) </span><span class="cm">/* ignore multicast and broadcast */</span><span class="cp"></span>
<span class="cp">#define RXMODE_RFMON cpu_to_le16(3) </span><span class="cm">/* wireless monitor mode */</span><span class="cp"></span>
<span class="cp">#define RXMODE_RFMON_ANYBSS cpu_to_le16(4)</span>
<span class="cp">#define RXMODE_LANMON cpu_to_le16(5) </span><span class="cm">/* lan style monitor -- data packets only */</span><span class="cp"></span>
<span class="cp">#define RXMODE_MASK cpu_to_le16(255)</span>
<span class="cp">#define RXMODE_DISABLE_802_3_HEADER cpu_to_le16(1&lt;&lt;8) </span><span class="cm">/* disables 802.3 header on rx */</span><span class="cp"></span>
<span class="cp">#define RXMODE_FULL_MASK (RXMODE_MASK | RXMODE_DISABLE_802_3_HEADER)</span>
<span class="cp">#define RXMODE_NORMALIZED_RSSI cpu_to_le16(1&lt;&lt;9) </span><span class="cm">/* return normalized RSSI */</span><span class="cp"></span>
	<span class="n">__le16</span> <span class="n">fragThresh</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">rtsThres</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">macAddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">shortRetryLimit</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">longRetryLimit</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">txLifetime</span><span class="p">;</span> <span class="cm">/* in kusec */</span>
	<span class="n">__le16</span> <span class="n">rxLifetime</span><span class="p">;</span> <span class="cm">/* in kusec */</span>
	<span class="n">__le16</span> <span class="n">stationary</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">ordering</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">u16deviceType</span><span class="p">;</span> <span class="cm">/* for overriding device type */</span>
	<span class="n">__le16</span> <span class="n">cfpRate</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">cfpDuration</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">_reserved1</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="cm">/*---------- Scanning/Associating ----------*/</span>
	<span class="n">__le16</span> <span class="n">scanMode</span><span class="p">;</span>
<span class="cp">#define SCANMODE_ACTIVE cpu_to_le16(0)</span>
<span class="cp">#define SCANMODE_PASSIVE cpu_to_le16(1)</span>
<span class="cp">#define SCANMODE_AIROSCAN cpu_to_le16(2)</span>
	<span class="n">__le16</span> <span class="n">probeDelay</span><span class="p">;</span> <span class="cm">/* in kusec */</span>
	<span class="n">__le16</span> <span class="n">probeEnergyTimeout</span><span class="p">;</span> <span class="cm">/* in kusec */</span>
        <span class="n">__le16</span> <span class="n">probeResponseTimeout</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">beaconListenTimeout</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">joinNetTimeout</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">authTimeout</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">authType</span><span class="p">;</span>
<span class="cp">#define AUTH_OPEN cpu_to_le16(0x1)</span>
<span class="cp">#define AUTH_ENCRYPT cpu_to_le16(0x101)</span>
<span class="cp">#define AUTH_SHAREDKEY cpu_to_le16(0x102)</span>
<span class="cp">#define AUTH_ALLOW_UNENCRYPTED cpu_to_le16(0x200)</span>
	<span class="n">__le16</span> <span class="n">associationTimeout</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">specifiedApTimeout</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">offlineScanInterval</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">offlineScanDuration</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">linkLossDelay</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">maxBeaconLostTime</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">refreshInterval</span><span class="p">;</span>
<span class="cp">#define DISABLE_REFRESH cpu_to_le16(0xFFFF)</span>
	<span class="n">__le16</span> <span class="n">_reserved1a</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="cm">/*---------- Power save operation ----------*/</span>
	<span class="n">__le16</span> <span class="n">powerSaveMode</span><span class="p">;</span>
<span class="cp">#define POWERSAVE_CAM cpu_to_le16(0)</span>
<span class="cp">#define POWERSAVE_PSP cpu_to_le16(1)</span>
<span class="cp">#define POWERSAVE_PSPCAM cpu_to_le16(2)</span>
	<span class="n">__le16</span> <span class="n">sleepForDtims</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">listenInterval</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fastListenInterval</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">listenDecay</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fastListenDelay</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">_reserved2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="cm">/*---------- Ap/Ibss config items ----------*/</span>
	<span class="n">__le16</span> <span class="n">beaconPeriod</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">atimDuration</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">hopPeriod</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">channelSet</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">dtimPeriod</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">bridgeDistance</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">radioID</span><span class="p">;</span>
	<span class="cm">/*---------- Radio configuration ----------*/</span>
	<span class="n">__le16</span> <span class="n">radioType</span><span class="p">;</span>
<span class="cp">#define RADIOTYPE_DEFAULT cpu_to_le16(0)</span>
<span class="cp">#define RADIOTYPE_802_11 cpu_to_le16(1)</span>
<span class="cp">#define RADIOTYPE_LEGACY cpu_to_le16(2)</span>
	<span class="n">u8</span> <span class="n">rxDiversity</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txDiversity</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">txPower</span><span class="p">;</span>
<span class="cp">#define TXPOWER_DEFAULT 0</span>
	<span class="n">__le16</span> <span class="n">rssiThreshold</span><span class="p">;</span>
<span class="cp">#define RSSI_DEFAULT 0</span>
        <span class="n">__le16</span> <span class="n">modulation</span><span class="p">;</span>
<span class="cp">#define PREAMBLE_AUTO cpu_to_le16(0)</span>
<span class="cp">#define PREAMBLE_LONG cpu_to_le16(1)</span>
<span class="cp">#define PREAMBLE_SHORT cpu_to_le16(2)</span>
	<span class="n">__le16</span> <span class="n">preamble</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">homeProduct</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">radioSpecific</span><span class="p">;</span>
	<span class="cm">/*---------- Aironet Extensions ----------*/</span>
	<span class="n">u8</span> <span class="n">nodeName</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">arlThreshold</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">arlDecay</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">arlDelay</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">_reserved4</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="cm">/*---------- Aironet Extensions ----------*/</span>
	<span class="n">u8</span> <span class="n">magicAction</span><span class="p">;</span>
<span class="cp">#define MAGIC_ACTION_STSCHG 1</span>
<span class="cp">#define MAGIC_ACTION_RESUME 2</span>
<span class="cp">#define MAGIC_IGNORE_MCAST (1&lt;&lt;8)</span>
<span class="cp">#define MAGIC_IGNORE_BCAST (1&lt;&lt;9)</span>
<span class="cp">#define MAGIC_SWITCH_TO_PSP (0&lt;&lt;10)</span>
<span class="cp">#define MAGIC_STAY_IN_CAM (1&lt;&lt;10)</span>
	<span class="n">u8</span> <span class="n">magicControl</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">autoWake</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">StatusRid</span> <span class="n">StatusRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">StatusRid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">errorCode</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">sigQuality</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">SSIDlen</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">SSID</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">apName</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">beaconPeriod</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">dimPeriod</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">atimDuration</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">hopPeriod</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">channelSet</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">hopsToBackbone</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">apTotalLoad</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">generatedLoad</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">accumulatedArl</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">signalQuality</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">currentXmitRate</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">apDevExtensions</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">normalizedSignalStrength</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">shortPreamble</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">apIP</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">noisePercent</span><span class="p">;</span> <span class="cm">/* Noise percent in last second */</span>
	<span class="n">u8</span> <span class="n">noisedBm</span><span class="p">;</span> <span class="cm">/* Noise dBm in last second */</span>
	<span class="n">u8</span> <span class="n">noiseAvePercent</span><span class="p">;</span> <span class="cm">/* Noise percent in last minute */</span>
	<span class="n">u8</span> <span class="n">noiseAvedBm</span><span class="p">;</span> <span class="cm">/* Noise dBm in last minute */</span>
	<span class="n">u8</span> <span class="n">noiseMaxPercent</span><span class="p">;</span> <span class="cm">/* Highest noise percent in last minute */</span>
	<span class="n">u8</span> <span class="n">noiseMaxdBm</span><span class="p">;</span> <span class="cm">/* Highest noise dbm in last minute */</span>
	<span class="n">__le16</span> <span class="n">load</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">carrier</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">assocStatus</span><span class="p">;</span>
<span class="cp">#define STAT_NOPACKETS 0</span>
<span class="cp">#define STAT_NOCARRIERSET 10</span>
<span class="cp">#define STAT_GOTCARRIERSET 11</span>
<span class="cp">#define STAT_WRONGSSID 20</span>
<span class="cp">#define STAT_BADCHANNEL 25</span>
<span class="cp">#define STAT_BADBITRATES 30</span>
<span class="cp">#define STAT_BADPRIVACY 35</span>
<span class="cp">#define STAT_APFOUND 40</span>
<span class="cp">#define STAT_APREJECTED 50</span>
<span class="cp">#define STAT_AUTHENTICATING 60</span>
<span class="cp">#define STAT_DEAUTHENTICATED 61</span>
<span class="cp">#define STAT_AUTHTIMEOUT 62</span>
<span class="cp">#define STAT_ASSOCIATING 70</span>
<span class="cp">#define STAT_DEASSOCIATED 71</span>
<span class="cp">#define STAT_ASSOCTIMEOUT 72</span>
<span class="cp">#define STAT_NOTAIROAP 73</span>
<span class="cp">#define STAT_ASSOCIATED 80</span>
<span class="cp">#define STAT_LEAPING 90</span>
<span class="cp">#define STAT_LEAPFAILED 91</span>
<span class="cp">#define STAT_LEAPTIMEDOUT 92</span>
<span class="cp">#define STAT_LEAPCOMPLETE 93</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">StatsRid</span> <span class="n">StatsRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">StatsRid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">spacer</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">vals</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">APListRid</span> <span class="n">APListRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">APListRid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ap</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">CapabilityRid</span> <span class="n">CapabilityRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">CapabilityRid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">oui</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">zero</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">prodNum</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">manName</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">prodName</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">prodVer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">factoryAddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">aironetAddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">radioType</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">country</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">callid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">supportedRates</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">rxDiversity</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">txDiversity</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">txPowerLevels</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">hardVer</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">hardCap</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">tempRange</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">softVer</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">softSubVer</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">interfaceVer</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">softCap</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">bootBlockVer</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">requiredHard</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">extSoftCap</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/* Only present on firmware &gt;= 5.30.17 */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">BSSListRidExtra</span> <span class="n">BSSListRidExtra</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">BSSListRidExtra</span> <span class="p">{</span>
  <span class="n">__le16</span> <span class="n">unknown</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
  <span class="n">u8</span> <span class="n">fixed</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span> <span class="cm">/* WLAN management frame */</span>
  <span class="n">u8</span> <span class="n">iep</span><span class="p">[</span><span class="mi">624</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">BSSListRid</span> <span class="n">BSSListRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">BSSListRid</span> <span class="p">{</span>
  <span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">__le16</span> <span class="n">index</span><span class="p">;</span> <span class="cm">/* First is 0 and 0xffff means end of list */</span>
<span class="cp">#define RADIO_FH 1 </span><span class="cm">/* Frequency hopping radio type */</span><span class="cp"></span>
<span class="cp">#define RADIO_DS 2 </span><span class="cm">/* Direct sequence radio type */</span><span class="cp"></span>
<span class="cp">#define RADIO_TMA 4 </span><span class="cm">/* Proprietary radio used in old cards (2500) */</span><span class="cp"></span>
  <span class="n">__le16</span> <span class="n">radioType</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span> <span class="cm">/* Mac address of the BSS */</span>
  <span class="n">u8</span> <span class="n">zero</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">ssidLen</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">ssid</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
  <span class="n">__le16</span> <span class="n">dBm</span><span class="p">;</span>
<span class="cp">#define CAP_ESS cpu_to_le16(1&lt;&lt;0)</span>
<span class="cp">#define CAP_IBSS cpu_to_le16(1&lt;&lt;1)</span>
<span class="cp">#define CAP_PRIVACY cpu_to_le16(1&lt;&lt;4)</span>
<span class="cp">#define CAP_SHORTHDR cpu_to_le16(1&lt;&lt;5)</span>
  <span class="n">__le16</span> <span class="n">cap</span><span class="p">;</span>
  <span class="n">__le16</span> <span class="n">beaconInterval</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span> <span class="cm">/* Same as rates for config rid */</span>
  <span class="k">struct</span> <span class="p">{</span> <span class="cm">/* For frequency hopping only */</span>
    <span class="n">__le16</span> <span class="n">dwell</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">hopSet</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">hopPattern</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">hopIndex</span><span class="p">;</span>
    <span class="n">u8</span> <span class="n">fill</span><span class="p">;</span>
  <span class="p">}</span> <span class="n">fh</span><span class="p">;</span>
  <span class="n">__le16</span> <span class="n">dsChannel</span><span class="p">;</span>
  <span class="n">__le16</span> <span class="n">atimWindow</span><span class="p">;</span>

  <span class="cm">/* Only present on firmware &gt;= 5.30.17 */</span>
  <span class="n">BSSListRidExtra</span> <span class="n">extra</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">BSSListRid</span> <span class="n">bss</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">list_head</span> <span class="n">list</span><span class="p">;</span>
<span class="p">}</span> <span class="n">BSSListElement</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tdsRssiEntry</span> <span class="n">tdsRssiEntry</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">tdsRssiEntry</span> <span class="p">{</span>
  <span class="n">u8</span> <span class="n">rssipct</span><span class="p">;</span>
  <span class="n">u8</span> <span class="n">rssidBm</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">tdsRssiRid</span> <span class="n">tdsRssiRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">tdsRssiRid</span> <span class="p">{</span>
  <span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
  <span class="n">tdsRssiEntry</span> <span class="n">x</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">MICRid</span> <span class="n">MICRid</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">MICRid</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">multicastValid</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">multicast</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">unicastValid</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">unicast</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">MICBuffer</span> <span class="n">MICBuffer</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">MICBuffer</span> <span class="p">{</span>
	<span class="n">__be16</span> <span class="n">typelen</span><span class="p">;</span>

	<span class="k">union</span> <span class="p">{</span>
	    <span class="n">u8</span> <span class="n">snap</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	    <span class="k">struct</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">dsap</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">ssap</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">control</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">orgcode</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">u8</span> <span class="n">fieldtype</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	    <span class="p">}</span> <span class="n">llc</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">mic</span><span class="p">;</span>
	<span class="n">__be32</span> <span class="n">seq</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">da</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">sa</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
<span class="p">}</span> <span class="n">etherHead</span><span class="p">;</span>

<span class="cp">#define TXCTL_TXOK (1&lt;&lt;1) </span><span class="cm">/* report if tx is ok */</span><span class="cp"></span>
<span class="cp">#define TXCTL_TXEX (1&lt;&lt;2) </span><span class="cm">/* report if tx fails */</span><span class="cp"></span>
<span class="cp">#define TXCTL_802_3 (0&lt;&lt;3) </span><span class="cm">/* 802.3 packet */</span><span class="cp"></span>
<span class="cp">#define TXCTL_802_11 (1&lt;&lt;3) </span><span class="cm">/* 802.11 mac packet */</span><span class="cp"></span>
<span class="cp">#define TXCTL_ETHERNET (0&lt;&lt;4) </span><span class="cm">/* payload has ethertype */</span><span class="cp"></span>
<span class="cp">#define TXCTL_LLC (1&lt;&lt;4) </span><span class="cm">/* payload is llc */</span><span class="cp"></span>
<span class="cp">#define TXCTL_RELEASE (0&lt;&lt;5) </span><span class="cm">/* release after completion */</span><span class="cp"></span>
<span class="cp">#define TXCTL_NORELEASE (1&lt;&lt;5) </span><span class="cm">/* on completion returns to host */</span><span class="cp"></span>

<span class="cp">#define BUSY_FID 0x10000</span>

<span class="cp">#ifdef CISCO_EXT</span>
<span class="cp">#define AIROMAGIC	0xa55a</span>
<span class="cm">/* Warning : SIOCDEVPRIVATE may disapear during 2.5.X - Jean II */</span>
<span class="cp">#ifdef SIOCIWFIRSTPRIV</span>
<span class="cp">#ifdef SIOCDEVPRIVATE</span>
<span class="cp">#define AIROOLDIOCTL	SIOCDEVPRIVATE</span>
<span class="cp">#define AIROOLDIDIFC 	AIROOLDIOCTL + 1</span>
<span class="cp">#endif </span><span class="cm">/* SIOCDEVPRIVATE */</span><span class="cp"></span>
<span class="cp">#else </span><span class="cm">/* SIOCIWFIRSTPRIV */</span><span class="cp"></span>
<span class="cp">#define SIOCIWFIRSTPRIV SIOCDEVPRIVATE</span>
<span class="cp">#endif </span><span class="cm">/* SIOCIWFIRSTPRIV */</span><span class="cp"></span>
<span class="cm">/* This may be wrong. When using the new SIOCIWFIRSTPRIV range, we probably</span>
<span class="cm"> * should use only &quot;GET&quot; ioctls (last bit set to 1). &quot;SET&quot; ioctls are root</span>
<span class="cm"> * only and don&#39;t return the modified struct ifreq to the application which</span>
<span class="cm"> * is usually a problem. - Jean II */</span>
<span class="cp">#define AIROIOCTL	SIOCIWFIRSTPRIV</span>
<span class="cp">#define AIROIDIFC 	AIROIOCTL + 1</span>

<span class="cm">/* Ioctl constants to be used in airo_ioctl.command */</span>

<span class="cp">#define	AIROGCAP  		0	</span><span class="c1">// Capability rid</span>
<span class="cp">#define AIROGCFG		1       </span><span class="c1">// USED A LOT</span>
<span class="cp">#define AIROGSLIST		2	</span><span class="c1">// System ID list</span>
<span class="cp">#define AIROGVLIST		3       </span><span class="c1">// List of specified AP&#39;s</span>
<span class="cp">#define AIROGDRVNAM		4	</span><span class="c1">//  NOTUSED</span>
<span class="cp">#define AIROGEHTENC		5	</span><span class="c1">// NOTUSED</span>
<span class="cp">#define AIROGWEPKTMP		6</span>
<span class="cp">#define AIROGWEPKNV		7</span>
<span class="cp">#define AIROGSTAT		8</span>
<span class="cp">#define AIROGSTATSC32		9</span>
<span class="cp">#define AIROGSTATSD32		10</span>
<span class="cp">#define AIROGMICRID		11</span>
<span class="cp">#define AIROGMICSTATS		12</span>
<span class="cp">#define AIROGFLAGS		13</span>
<span class="cp">#define AIROGID			14</span>
<span class="cp">#define AIRORRID		15</span>
<span class="cp">#define AIRORSWVERSION		17</span>

<span class="cm">/* Leave gap of 40 commands after AIROGSTATSD32 for future */</span>

<span class="cp">#define AIROPCAP               	AIROGSTATSD32 + 40</span>
<span class="cp">#define AIROPVLIST              AIROPCAP      + 1</span>
<span class="cp">#define AIROPSLIST		AIROPVLIST    + 1</span>
<span class="cp">#define AIROPCFG		AIROPSLIST    + 1</span>
<span class="cp">#define AIROPSIDS		AIROPCFG      + 1</span>
<span class="cp">#define AIROPAPLIST		AIROPSIDS     + 1</span>
<span class="cp">#define AIROPMACON		AIROPAPLIST   + 1	</span><span class="cm">/* Enable mac  */</span><span class="cp"></span>
<span class="cp">#define AIROPMACOFF		AIROPMACON    + 1 	</span><span class="cm">/* Disable mac */</span><span class="cp"></span>
<span class="cp">#define AIROPSTCLR		AIROPMACOFF   + 1</span>
<span class="cp">#define AIROPWEPKEY		AIROPSTCLR    + 1</span>
<span class="cp">#define AIROPWEPKEYNV		AIROPWEPKEY   + 1</span>
<span class="cp">#define AIROPLEAPPWD            AIROPWEPKEYNV + 1</span>
<span class="cp">#define AIROPLEAPUSR            AIROPLEAPPWD  + 1</span>

<span class="cm">/* Flash codes */</span>

<span class="cp">#define AIROFLSHRST	       AIROPWEPKEYNV  + 40</span>
<span class="cp">#define AIROFLSHGCHR           AIROFLSHRST    + 1</span>
<span class="cp">#define AIROFLSHSTFL           AIROFLSHGCHR   + 1</span>
<span class="cp">#define AIROFLSHPCHR           AIROFLSHSTFL   + 1</span>
<span class="cp">#define AIROFLPUTBUF           AIROFLSHPCHR   + 1</span>
<span class="cp">#define AIRORESTART            AIROFLPUTBUF   + 1</span>

<span class="cp">#define FLASHSIZE	32768</span>
<span class="cp">#define AUXMEMSIZE	(256 * 1024)</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">aironet_ioctl</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">command</span><span class="p">;</span>		<span class="c1">// What to do</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">;</span>		<span class="c1">// Len of data</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ridnum</span><span class="p">;</span>		<span class="c1">// rid number</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>	<span class="c1">// d-data</span>
<span class="p">}</span> <span class="n">aironet_ioctl</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">swversion</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;2.1&quot;</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CISCO_EXT */</span><span class="cp"></span>

<span class="cp">#define NUM_MODULES       2</span>
<span class="cp">#define MIC_MSGLEN_MAX    2400</span>
<span class="cp">#define EMMH32_MSGLEN_MAX MIC_MSGLEN_MAX</span>
<span class="cp">#define AIRO_DEF_MTU      2312</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span>   <span class="n">size</span><span class="p">;</span>            <span class="c1">// size</span>
	<span class="n">u8</span>    <span class="n">enabled</span><span class="p">;</span>         <span class="c1">// MIC enabled or not</span>
	<span class="n">u32</span>   <span class="n">rxSuccess</span><span class="p">;</span>       <span class="c1">// successful packets received</span>
	<span class="n">u32</span>   <span class="n">rxIncorrectMIC</span><span class="p">;</span>  <span class="c1">// pkts dropped due to incorrect MIC comparison</span>
	<span class="n">u32</span>   <span class="n">rxNotMICed</span><span class="p">;</span>      <span class="c1">// pkts dropped due to not being MIC&#39;d</span>
	<span class="n">u32</span>   <span class="n">rxMICPlummed</span><span class="p">;</span>    <span class="c1">// pkts dropped due to not having a MIC plummed</span>
	<span class="n">u32</span>   <span class="n">rxWrongSequence</span><span class="p">;</span> <span class="c1">// pkts dropped due to sequence number violation</span>
	<span class="n">u32</span>   <span class="n">reserve</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">}</span> <span class="n">mic_statistics</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">coeff</span><span class="p">[((</span><span class="n">EMMH32_MSGLEN_MAX</span><span class="p">)</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u64</span> <span class="n">accum</span><span class="p">;</span>	<span class="c1">// accumulated mic, reduced to u32 in final()</span>
	<span class="kt">int</span> <span class="n">position</span><span class="p">;</span>	<span class="c1">// current position (byte offset) in message</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">u8</span>  <span class="n">d8</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">__be32</span> <span class="n">d32</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">part</span><span class="p">;</span>	<span class="c1">// saves partial message word across update() calls</span>
<span class="p">}</span> <span class="n">emmh32_context</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">emmh32_context</span> <span class="n">seed</span><span class="p">;</span>	    <span class="c1">// Context - the seed</span>
	<span class="n">u32</span>		 <span class="n">rx</span><span class="p">;</span>	    <span class="c1">// Received sequence number</span>
	<span class="n">u32</span>		 <span class="n">tx</span><span class="p">;</span>	    <span class="c1">// Tx sequence number</span>
	<span class="n">u32</span>		 <span class="n">window</span><span class="p">;</span>    <span class="c1">// Start of window</span>
	<span class="n">u8</span>		 <span class="n">valid</span><span class="p">;</span>	    <span class="c1">// Flag to say if context is valid or not</span>
	<span class="n">u8</span>		 <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">miccntx</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">miccntx</span> <span class="n">mCtx</span><span class="p">;</span>		<span class="c1">// Multicast context</span>
	<span class="n">miccntx</span> <span class="n">uCtx</span><span class="p">;</span>		<span class="c1">// Unicast context</span>
<span class="p">}</span> <span class="n">mic_module</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">rid</span><span class="o">:</span> <span class="mi">16</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">len</span><span class="o">:</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">valid</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">host_addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Rid</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">offset</span><span class="o">:</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">eoc</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">len</span><span class="o">:</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">valid</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">host_addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">TxFid</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">rx_hdr</span> <span class="p">{</span>
	<span class="n">__le16</span> <span class="n">status</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rssi</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">ctl</span><span class="o">:</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">rdy</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">len</span><span class="o">:</span> <span class="mi">15</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">valid</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">host_addr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">RxFid</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Host receive descriptor</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">card_ram_off</span><span class="p">;</span> <span class="cm">/* offset into card memory of the</span>
<span class="cm">						desc */</span>
	<span class="n">RxFid</span>         <span class="n">rx_desc</span><span class="p">;</span>		     <span class="cm">/* card receive descriptor */</span>
	<span class="kt">char</span>          <span class="o">*</span><span class="n">virtual_host_addr</span><span class="p">;</span>    <span class="cm">/* virtual address of host receive</span>
<span class="cm">					        buffer */</span>
	<span class="kt">int</span>           <span class="n">pending</span><span class="p">;</span>
<span class="p">}</span> <span class="n">HostRxDesc</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Host transmit descriptor</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">card_ram_off</span><span class="p">;</span>	     <span class="cm">/* offset into card memory of the</span>
<span class="cm">						desc */</span>
	<span class="n">TxFid</span>         <span class="n">tx_desc</span><span class="p">;</span>		     <span class="cm">/* card transmit descriptor */</span>
	<span class="kt">char</span>          <span class="o">*</span><span class="n">virtual_host_addr</span><span class="p">;</span>    <span class="cm">/* virtual address of host receive</span>
<span class="cm">					        buffer */</span>
	<span class="kt">int</span>           <span class="n">pending</span><span class="p">;</span>
<span class="p">}</span> <span class="n">HostTxDesc</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Host RID descriptor</span>
<span class="cm"> */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">card_ram_off</span><span class="p">;</span>      <span class="cm">/* offset into card memory of the</span>
<span class="cm">					     descriptor */</span>
	<span class="n">Rid</span>           <span class="n">rid_desc</span><span class="p">;</span>		  <span class="cm">/* card RID descriptor */</span>
	<span class="kt">char</span>          <span class="o">*</span><span class="n">virtual_host_addr</span><span class="p">;</span> <span class="cm">/* virtual address of host receive</span>
<span class="cm">					     buffer */</span>
<span class="p">}</span> <span class="n">HostRidDesc</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">sw0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sw1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
<span class="cp">#define HOST_SET (1 &lt;&lt; 0)</span>
<span class="cp">#define HOST_INT_TX (1 &lt;&lt; 1) </span><span class="cm">/* Interrupt on successful TX */</span><span class="cp"></span>
<span class="cp">#define HOST_INT_TXERR (1 &lt;&lt; 2) </span><span class="cm">/* Interrupt on unseccessful TX */</span><span class="cp"></span>
<span class="cp">#define HOST_LCC_PAYLOAD (1 &lt;&lt; 4) </span><span class="cm">/* LLC payload, 0 = Ethertype */</span><span class="cp"></span>
<span class="cp">#define HOST_DONT_RLSE (1 &lt;&lt; 5) </span><span class="cm">/* Don&#39;t release buffer when done */</span><span class="cp"></span>
<span class="cp">#define HOST_DONT_RETRY (1 &lt;&lt; 6) </span><span class="cm">/* Don&#39;t retry trasmit */</span><span class="cp"></span>
<span class="cp">#define HOST_CLR_AID (1 &lt;&lt; 7) </span><span class="cm">/* clear AID failure */</span><span class="cp"></span>
<span class="cp">#define HOST_RTS (1 &lt;&lt; 9) </span><span class="cm">/* Force RTS use */</span><span class="cp"></span>
<span class="cp">#define HOST_SHORT (1 &lt;&lt; 10) </span><span class="cm">/* Do short preamble */</span><span class="cp"></span>
	<span class="n">u16</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">aid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">retries</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fill</span><span class="p">;</span>
<span class="p">}</span> <span class="n">TxCtlHdr</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
        <span class="n">u16</span> <span class="n">ctl</span><span class="p">;</span>
        <span class="n">u16</span> <span class="n">duration</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">addr1</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">addr2</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="kt">char</span> <span class="n">addr3</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
        <span class="n">u16</span> <span class="n">seq</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">addr4</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">}</span> <span class="n">WifiHdr</span><span class="p">;</span>


<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">TxCtlHdr</span> <span class="n">ctlhdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fill1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fill2</span><span class="p">;</span>
	<span class="n">WifiHdr</span> <span class="n">wifihdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gaplen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span> <span class="n">WifiCtlHdr</span><span class="p">;</span>

<span class="k">static</span> <span class="n">WifiCtlHdr</span> <span class="n">wifictlhdr8023</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ctlhdr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ctl</span>	<span class="o">=</span> <span class="n">HOST_DONT_RLSE</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>A few details needed for WEP (Wireless Equivalent Privacy)</p></td><td class="code"><div class="highlight"><pre><span class="cp">#define MAX_KEY_SIZE 13			</span><span class="c1">// 128 (?) bits</span>
<span class="cp">#define MIN_KEY_SIZE  5			</span><span class="c1">// 40 bits RC4 - WEP</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">wep_key_t</span> <span class="p">{</span>
	<span class="n">u16</span>	<span class="n">len</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>	<span class="cm">/* 40-bit and 104-bit keys */</span>
<span class="p">}</span> <span class="n">wep_key_t</span><span class="p">;</span>

<span class="cm">/* List of Wireless Handlers (new API) */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span>	<span class="n">airo_handler_def</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;airo.c 0.6 (Ben Reed &amp; Javier Achirica)&quot;</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">airo_info</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">get_dec_u16</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">OUT4500</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="k">register</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">IN4500</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="k">register</span> <span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">setup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enable_MAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">disable_MAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">issuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">Cmd</span> <span class="o">*</span><span class="n">pCmd</span><span class="p">,</span> <span class="n">Resp</span> <span class="o">*</span><span class="n">pRsp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bap_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whichbap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">aux_bap_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pu16Dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytelen</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">whichbap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fast_bap_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pu16Dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytelen</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">whichbap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">bap_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pu16Src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytelen</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">whichbap</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">PC4500_accessrid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">accmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pBuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">PC4500_writerid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span>
			   <span class="o">*</span><span class="n">pBuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_writerid</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rid_data</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span> <span class="p">);</span>
<span class="k">static</span> <span class="n">u16</span> <span class="n">transmit_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lenPayload</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">transmit_802_3_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pPacket</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">transmit_802_11_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pPacket</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">mpi_send_packet</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpi_unmap_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpi_receive_802_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">mpi_receive_802_11</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">waitbusy</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">airo_interrupt</span><span class="p">(</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">airo_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">timer_func</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">airo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">airo_get_wireless_stats</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">airo_read_wireless_stats</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span><span class="p">);</span>
<span class="cp">#ifdef CISCO_EXT</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">readrids</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">aironet_ioctl</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">writerids</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">aironet_ioctl</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flashcard</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">aironet_ioctl</span> <span class="o">*</span><span class="n">comp</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CISCO_EXT */</span><span class="cp"></span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">micinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">micsetup</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">encapsulate</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">etherHead</span> <span class="o">*</span><span class="n">pPacket</span><span class="p">,</span> <span class="n">MICBuffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">decapsulate</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">MICBuffer</span> <span class="o">*</span><span class="n">mic</span><span class="p">,</span> <span class="n">etherHead</span> <span class="o">*</span><span class="n">pPacket</span><span class="p">,</span> <span class="n">u16</span> <span class="n">payLen</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">airo_rssi_to_dbm</span> <span class="p">(</span><span class="n">tdsRssiEntry</span> <span class="o">*</span><span class="n">rssi_rid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rssi</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">airo_dbm_to_pct</span> <span class="p">(</span><span class="n">tdsRssiEntry</span> <span class="o">*</span><span class="n">rssi_rid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dbm</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">airo_networks_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">airo_info</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>             <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>              <span class="n">dev_list</span><span class="p">;</span>
	<span class="cm">/* Note, we can have MAX_FIDS outstanding.  FIDs are 16-bits, so we</span>
<span class="cm">	   use the high bit to mark whether it is in use. */</span>
<span class="cp">#define MAX_FIDS 6</span>
<span class="cp">#define MPI_MAX_FIDS 1</span>
	<span class="n">u32</span>                           <span class="n">fids</span><span class="p">[</span><span class="n">MAX_FIDS</span><span class="p">];</span>
	<span class="n">ConfigRid</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">keyindex</span><span class="p">;</span> <span class="c1">// Used with auto wep</span>
	<span class="kt">char</span> <span class="n">defindex</span><span class="p">;</span> <span class="c1">// Used with auto wep</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">proc_entry</span><span class="p">;</span>
        <span class="n">spinlock_t</span> <span class="n">aux_lock</span><span class="p">;</span>
<span class="cp">#define FLAG_RADIO_OFF	0	</span><span class="cm">/* User disabling of MAC */</span><span class="cp"></span>
<span class="cp">#define FLAG_RADIO_DOWN	1	</span><span class="cm">/* ifup/ifdown disabling of MAC */</span><span class="cp"></span>
<span class="cp">#define FLAG_RADIO_MASK 0x03</span>
<span class="cp">#define FLAG_ENABLED	2</span>
<span class="cp">#define FLAG_ADHOC	3	</span><span class="cm">/* Needed by MIC */</span><span class="cp"></span>
<span class="cp">#define FLAG_MIC_CAPABLE 4</span>
<span class="cp">#define FLAG_UPDATE_MULTI 5</span>
<span class="cp">#define FLAG_UPDATE_UNI 6</span>
<span class="cp">#define FLAG_802_11	7</span>
<span class="cp">#define FLAG_PROMISC	8	</span><span class="cm">/* IFF_PROMISC 0x100 - include/linux/if.h */</span><span class="cp"></span>
<span class="cp">#define FLAG_PENDING_XMIT 9</span>
<span class="cp">#define FLAG_PENDING_XMIT11 10</span>
<span class="cp">#define FLAG_MPI	11</span>
<span class="cp">#define FLAG_REGISTERED	12</span>
<span class="cp">#define FLAG_COMMIT	13</span>
<span class="cp">#define FLAG_RESET	14</span>
<span class="cp">#define FLAG_FLASHING	15</span>
<span class="cp">#define FLAG_WPA_CAPABLE	16</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define JOB_DIE	0</span>
<span class="cp">#define JOB_XMIT	1</span>
<span class="cp">#define JOB_XMIT11	2</span>
<span class="cp">#define JOB_STATS	3</span>
<span class="cp">#define JOB_PROMISC	4</span>
<span class="cp">#define JOB_MIC	5</span>
<span class="cp">#define JOB_EVENT	6</span>
<span class="cp">#define JOB_AUTOWEP	7</span>
<span class="cp">#define JOB_WSTATS	8</span>
<span class="cp">#define JOB_SCAN_RESULTS  9</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jobs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">bap_read</span><span class="p">)(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pu16Dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytelen</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">whichbap</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">flash</span><span class="p">;</span>
	<span class="n">tdsRssiEntry</span> <span class="o">*</span><span class="n">rssi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">list_bss_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">task_struct</span> <span class="o">*</span><span class="n">airo_thread_task</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">semaphore</span> <span class="n">sem</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">thr_wait</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">fid</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">xmit</span><span class="p">,</span> <span class="n">xmit11</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">wifidev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span>	<span class="n">wstats</span><span class="p">;</span>		<span class="c1">// wireless stats</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">scan_timeout</span><span class="p">;</span>	<span class="cm">/* Time scan should be read */</span>
	<span class="k">struct</span> <span class="n">iw_spy_data</span>	<span class="n">spy_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_public_data</span>	<span class="n">wireless_data</span><span class="p">;</span>
	<span class="cm">/* MIC stuff */</span>
	<span class="k">struct</span> <span class="n">crypto_cipher</span>	<span class="o">*</span><span class="n">tfm</span><span class="p">;</span>
	<span class="n">mic_module</span>		<span class="n">mod</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">mic_statistics</span>		<span class="n">micstats</span><span class="p">;</span>
	<span class="n">HostRxDesc</span> <span class="n">rxfids</span><span class="p">[</span><span class="n">MPI_MAX_FIDS</span><span class="p">];</span> <span class="c1">// rx/tx/config MPI350 descriptors</span>
	<span class="n">HostTxDesc</span> <span class="n">txfids</span><span class="p">[</span><span class="n">MPI_MAX_FIDS</span><span class="p">];</span>
	<span class="n">HostRidDesc</span> <span class="n">config_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ridbus</span><span class="p">;</span> <span class="c1">// phys addr of config_desc</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="n">txq</span><span class="p">;</span><span class="c1">// tx queue used by mpi350 code</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>          <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">__iomem</span> <span class="o">*</span><span class="n">pcimem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">__iomem</span> <span class="o">*</span><span class="n">pciaux</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>		<span class="o">*</span><span class="n">shared</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>		<span class="n">shared_dma</span><span class="p">;</span>
	<span class="n">pm_message_t</span>		<span class="n">power</span><span class="p">;</span>
	<span class="n">SsidRid</span>			<span class="o">*</span><span class="n">SSID</span><span class="p">;</span>
	<span class="n">APListRid</span>		<span class="o">*</span><span class="n">APList</span><span class="p">;</span>
<span class="cp">#define	PCI_SHARED_LEN		2*MPI_MAX_FIDS*PKTSIZE+RIDSIZE</span>
	<span class="kt">char</span>			<span class="n">proc_name</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="kt">int</span>			<span class="n">wep_capable</span><span class="p">;</span>
	<span class="kt">int</span>			<span class="n">max_wep_idx</span><span class="p">;</span>

	<span class="cm">/* WPA-related stuff */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bssListFirst</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bssListNext</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bssListRidLen</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">network_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">network_free_list</span><span class="p">;</span>
	<span class="n">BSSListElement</span> <span class="o">*</span><span class="n">networks</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bap_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pu16Dst</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bytelen</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">whichbap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">pu16Dst</span><span class="p">,</span> <span class="n">bytelen</span><span class="p">,</span> <span class="n">whichbap</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_proc_entry</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">apriv</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">takedown_proc_entry</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">apriv</span> <span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cmdreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setflashmode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flashgchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span><span class="kt">int</span> <span class="n">matchbyte</span><span class="p">,</span><span class="kt">int</span> <span class="n">dwelltime</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flashputbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flashrestart</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#define airo_print(type, name, fmt, args...) \</span>
<span class="cp">	printk(type DRV_NAME &quot;(%s): &quot; fmt &quot;\n&quot;, name, ##args)</span>

<span class="cp">#define airo_print_info(name, fmt, args...) \</span>
<span class="cp">	airo_print(KERN_INFO, name, fmt, ##args)</span>

<span class="cp">#define airo_print_dbg(name, fmt, args...) \</span>
<span class="cp">	airo_print(KERN_DEBUG, name, fmt, ##args)</span>

<span class="cp">#define airo_print_warn(name, fmt, args...) \</span>
<span class="cp">	airo_print(KERN_WARNING, name, fmt, ##args)</span>

<span class="cp">#define airo_print_err(name, fmt, args...) \</span>
<span class="cp">	airo_print(KERN_ERR, name, fmt, ##args)</span>

<span class="cp">#define AIRO_FLASH(dev) (((struct airo_info *)dev-&gt;ml_priv)-&gt;flash)</span>

<span class="cm">/***********************************************************************</span>
<span class="cm"> *                              MIC ROUTINES                           *</span>
<span class="cm"> ***********************************************************************</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">RxSeqValid</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span><span class="n">miccntx</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span><span class="kt">int</span> <span class="n">mcast</span><span class="p">,</span><span class="n">u32</span> <span class="n">micSeq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">MoveWindow</span><span class="p">(</span><span class="n">miccntx</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u32</span> <span class="n">micSeq</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">emmh32_setseed</span><span class="p">(</span><span class="n">emmh32_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pkey</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">crypto_cipher</span> <span class="o">*</span><span class="n">tfm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">emmh32_init</span><span class="p">(</span><span class="n">emmh32_context</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">emmh32_update</span><span class="p">(</span><span class="n">emmh32_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pOctets</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">emmh32_final</span><span class="p">(</span><span class="n">emmh32_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u8</span> <span class="n">digest</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flashpchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span><span class="kt">int</span> <span class="n">byte</span><span class="p">,</span><span class="kt">int</span> <span class="n">dwelltime</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">age_mic_context</span><span class="p">(</span><span class="n">miccntx</span> <span class="o">*</span><span class="n">cur</span><span class="p">,</span> <span class="n">miccntx</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_len</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">crypto_cipher</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* If the current MIC context is valid and its key is the same as</span>
<span class="cm">	 * the MIC register, there&#39;s nothing to do.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Age current mic Context */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">cur</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cur</span><span class="p">));</span>

	<span class="cm">/* Initialize new context */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">window</span>  <span class="o">=</span> <span class="mi">33</span><span class="p">;</span> <span class="cm">/* Window always points to the middle */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">rx</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Rx Sequence numbers */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">tx</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Tx sequence numbers */</span>
	<span class="n">cur</span><span class="o">-&gt;</span><span class="n">valid</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* Key is now valid */</span>

	<span class="cm">/* Give key to mic seed */</span>
	<span class="n">emmh32_setseed</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cur</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="n">tfm</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* micinit - Initialize mic seed */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">micinit</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">MICRid</span> <span class="n">mic_rid</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_MIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_MIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic_rid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mic_rid</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">mic_rid</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* So next time we have a valid key and mic is enabled, we will</span>
<span class="cm">		 * update the sequence number if the key is the same as before.</span>
<span class="cm">		 */</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uCtx</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mCtx</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mic_rid</span><span class="p">.</span><span class="n">multicastValid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">age_mic_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mCtx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">mCtx</span><span class="p">,</span>
		                <span class="n">mic_rid</span><span class="p">.</span><span class="n">multicast</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mic_rid</span><span class="p">.</span><span class="n">multicast</span><span class="p">),</span>
		                <span class="n">ai</span><span class="o">-&gt;</span><span class="n">tfm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mic_rid</span><span class="p">.</span><span class="n">unicastValid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">age_mic_context</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uCtx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">uCtx</span><span class="p">,</span>
				<span class="n">mic_rid</span><span class="p">.</span><span class="n">unicast</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mic_rid</span><span class="p">.</span><span class="n">unicast</span><span class="p">),</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">tfm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* micsetup - Get ready for business */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">micsetup</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">tfm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	        <span class="n">ai</span><span class="o">-&gt;</span><span class="n">tfm</span> <span class="o">=</span> <span class="n">crypto_alloc_cipher</span><span class="p">(</span><span class="s">&quot;aes&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CRYPTO_ALG_ASYNC</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">tfm</span><span class="p">))</span> <span class="p">{</span>
                <span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;failed to load transform for AES&quot;</span><span class="p">);</span>
                <span class="n">ai</span><span class="o">-&gt;</span><span class="n">tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
                <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_MODULES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mCtx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">miccntx</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">uCtx</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">miccntx</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">micsnap</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xAA</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x96</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x02</span><span class="p">};</span>

<span class="cm">/*===========================================================================</span>
<span class="cm"> * Description: Mic a packet</span>
<span class="cm"> *    </span>
<span class="cm"> *      Inputs: etherHead * pointer to an 802.3 frame</span>
<span class="cm"> *    </span>
<span class="cm"> *     Returns: BOOLEAN if successful, otherwise false.</span>
<span class="cm"> *             PacketTxLen will be updated with the mic&#39;d packets size.</span>
<span class="cm"> *</span>
<span class="cm"> *    Caveats: It is assumed that the frame buffer will already</span>
<span class="cm"> *             be big enough to hold the largets mic message possible.</span>
<span class="cm"> *            (No memory allocation is done here).</span>
<span class="cm"> *  </span>
<span class="cm"> *    Author: sbraneky (10/15/01)</span>
<span class="cm"> *    Merciless hacks by rwilcher (1/14/02)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">encapsulate</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="p">,</span><span class="n">etherHead</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="n">MICBuffer</span> <span class="o">*</span><span class="n">mic</span><span class="p">,</span> <span class="kt">int</span> <span class="n">payLen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">miccntx</span>   <span class="o">*</span><span class="n">context</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Determine correct context
If not adhoc, always use unicast key</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_ADHOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span>
		<span class="n">context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">mCtx</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">context</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">uCtx</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>

	<span class="n">mic</span><span class="o">-&gt;</span><span class="n">typelen</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">payLen</span> <span class="o">+</span> <span class="mi">16</span><span class="p">);</span> <span class="c1">//Length of Mic&#39;d packet</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">snap</span><span class="p">,</span> <span class="n">micsnap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">micsnap</span><span class="p">));</span> <span class="c1">// Add Snap</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Add Tx sequence</p></td><td class="code"><div class="highlight"><pre>	<span class="n">mic</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">);</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">tx</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">emmh32_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">);</span> <span class="c1">// Mic the packet</span>
	<span class="n">emmh32_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span><span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// DA,SA</span>
	<span class="n">emmh32_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">typelen</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span> <span class="c1">// Type/Length and Snap</span>
	<span class="n">emmh32_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">));</span> <span class="c1">//SEQ</span>
	<span class="n">emmh32_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,(</span><span class="n">u8</span><span class="o">*</span><span class="p">)(</span><span class="n">frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="n">payLen</span><span class="p">);</span> <span class="c1">//payload</span>
	<span class="n">emmh32_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">mic</span><span class="p">);</span>

	<span class="cm">/*    New Type/length ?????????? */</span>
	<span class="n">mic</span><span class="o">-&gt;</span><span class="n">typelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">//Let NIC know it could be an oversized packet</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">typedef</span> <span class="k">enum</span> <span class="p">{</span>
    <span class="n">NONE</span><span class="p">,</span>
    <span class="n">NOMIC</span><span class="p">,</span>
    <span class="n">NOMICPLUMMED</span><span class="p">,</span>
    <span class="n">SEQUENCE</span><span class="p">,</span>
    <span class="n">INCORRECTMIC</span><span class="p">,</span>
<span class="p">}</span> <span class="n">mic_error</span><span class="p">;</span>

<span class="cm">/*===========================================================================</span>
<span class="cm"> *  Description: Decapsulates a MIC&#39;d packet and returns the 802.3 packet</span>
<span class="cm"> *               (removes the MIC stuff) if packet is a valid packet.</span>
<span class="cm"> *      </span>
<span class="cm"> *       Inputs: etherHead  pointer to the 802.3 packet             </span>
<span class="cm"> *     </span>
<span class="cm"> *      Returns: BOOLEAN - TRUE if packet should be dropped otherwise FALSE</span>
<span class="cm"> *     </span>
<span class="cm"> *      Author: sbraneky (10/15/01)</span>
<span class="cm"> *    Merciless hacks by rwilcher (1/14/02)</span>
<span class="cm"> *---------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">decapsulate</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">MICBuffer</span> <span class="o">*</span><span class="n">mic</span><span class="p">,</span> <span class="n">etherHead</span> <span class="o">*</span><span class="n">eth</span><span class="p">,</span> <span class="n">u16</span> <span class="n">payLen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>      <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span>      <span class="n">micSEQ</span><span class="p">;</span>
	<span class="n">miccntx</span>  <span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="n">u8</span>       <span class="n">digest</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">mic_error</span> <span class="n">micError</span> <span class="o">=</span> <span class="n">NONE</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>Check if the packet is a Mic'd packet</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>No Mic set or Mic OFF but we received a MIC'd packet.</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span> <span class="p">((</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">eth</span> <span class="o">+</span> <span class="mi">14</span><span class="p">,</span> <span class="n">micsnap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">micsnap</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">rxMICPlummed</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">typelen</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x888E</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span> <span class="p">(</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">snap</span><span class="p">,</span> <span class="n">micsnap</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">micsnap</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>Mic enabled but packet isn't Mic'd</p></td><td class="code"><div class="highlight"><pre>		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">rxMICPlummed</span><span class="o">++</span><span class="p">;</span>
	    	<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">micSEQ</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">);</span>            <span class="c1">//store SEQ as CPU order</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>At this point we a have a mic'd packet and mic is enabled
Now do the mic error checking.</p></td><td class="code"><div class="highlight"><pre></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>Receive seq must be odd</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">micSEQ</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">rxWrongSequence</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_MODULES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">mcast</span> <span class="o">=</span> <span class="n">eth</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>Determine proper context </p></td><td class="code"><div class="highlight"><pre>		<span class="n">context</span> <span class="o">=</span> <span class="n">mcast</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mCtx</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">mod</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">uCtx</span><span class="p">;</span>
	</pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>Make sure context is valid</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">micError</span> <span class="o">=</span> <span class="n">NOMICPLUMMED</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>                
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>DeMic it </p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">typelen</span><span class="p">)</span>
			<span class="n">mic</span><span class="o">-&gt;</span><span class="n">typelen</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">payLen</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">MICBuffer</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	
		<span class="n">emmh32_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">);</span>
		<span class="n">emmh32_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span> <span class="n">eth</span><span class="o">-&gt;</span><span class="n">da</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span> 
		<span class="n">emmh32_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">typelen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">typelen</span><span class="p">)</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">snap</span><span class="p">));</span> 
		<span class="n">emmh32_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">));</span>	
		<span class="n">emmh32_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">eth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span><span class="n">payLen</span><span class="p">);</span>	</pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>Calculate MIC</p></td><td class="code"><div class="highlight"><pre>		<span class="n">emmh32_final</span><span class="p">(</span><span class="o">&amp;</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">seed</span><span class="p">,</span> <span class="n">digest</span><span class="p">);</span>
	
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">digest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mic</span><span class="o">-&gt;</span><span class="n">mic</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span> <span class="c1">//Make sure the mics match</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>Invalid Mic</p></td><td class="code"><div class="highlight"><pre>			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">micError</span> <span class="o">=</span> <span class="n">INCORRECTMIC</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>Check Sequence number if mics pass</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">RxSeqValid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">mcast</span><span class="p">,</span> <span class="n">micSEQ</span><span class="p">)</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">rxSuccess</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">micError</span> <span class="o">=</span> <span class="n">SEQUENCE</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-16"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-16">&#182;</a></div><p>Update statistics</p></td><td class="code"><div class="highlight"><pre>	<span class="k">switch</span> <span class="p">(</span><span class="n">micError</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NOMICPLUMMED</span>: <span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">rxMICPlummed</span><span class="o">++</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SEQUENCE</span>:    <span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">rxWrongSequence</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">INCORRECTMIC</span>: <span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">rxIncorrectMIC</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NONE</span>:  <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NOMIC</span>: <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*===========================================================================</span>
<span class="cm"> * Description:  Checks the Rx Seq number to make sure it is valid</span>
<span class="cm"> *               and hasn&#39;t already been received</span>
<span class="cm"> *   </span>
<span class="cm"> *     Inputs: miccntx - mic context to check seq against</span>
<span class="cm"> *             micSeq  - the Mic seq number</span>
<span class="cm"> *   </span>
<span class="cm"> *    Returns: TRUE if valid otherwise FALSE. </span>
<span class="cm"> *</span>
<span class="cm"> *    Author: sbraneky (10/15/01)</span>
<span class="cm"> *    Merciless hacks by rwilcher (1/14/02)</span>
<span class="cm"> *---------------------------------------------------------------------------</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">RxSeqValid</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span><span class="n">miccntx</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span><span class="kt">int</span> <span class="n">mcast</span><span class="p">,</span><span class="n">u32</span> <span class="n">micSeq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">seq</span><span class="p">,</span><span class="n">index</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-17"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-17">&#182;</a></div><p>Allow for the ap being rebooted - if it is then use the next 
sequence number of the current sequence number - might go backwards</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">mcast</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_UPDATE_MULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_UPDATE_MULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="p">(</span><span class="n">micSeq</span> <span class="o">&gt;</span> <span class="mi">33</span><span class="p">)</span> <span class="o">?</span> <span class="n">micSeq</span> <span class="o">:</span> <span class="mi">33</span><span class="p">;</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">rx</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>        <span class="c1">// Reset rx</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_UPDATE_UNI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_UPDATE_UNI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="p">(</span><span class="n">micSeq</span> <span class="o">&gt;</span> <span class="mi">33</span><span class="p">)</span> <span class="o">?</span> <span class="n">micSeq</span> <span class="o">:</span> <span class="mi">33</span><span class="p">;</span> <span class="c1">// Move window</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">rx</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>        <span class="c1">// Reset rx</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-18"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-18">&#182;</a></div><p>Make sequence number relative to START of window</p></td><td class="code"><div class="highlight"><pre>	<span class="n">seq</span> <span class="o">=</span> <span class="n">micSeq</span> <span class="o">-</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">-</span> <span class="mi">33</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-19"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-19">&#182;</a></div><p>Too old of a SEQ number to check.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">seq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
    
	<span class="k">if</span> <span class="p">(</span> <span class="n">seq</span> <span class="o">&gt;</span> <span class="mi">64</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-20"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-20">&#182;</a></div><p>Window is infinite forward</p></td><td class="code"><div class="highlight"><pre>		<span class="n">MoveWindow</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">micSeq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-21"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-21">&#182;</a></div><p>We are in the window. Now check the context rx bit to see if it was already sent</p></td><td class="code"><div class="highlight"><pre>	<span class="n">seq</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>         <span class="c1">//divide by 2 because we only have odd numbers</span>
	<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">seq</span><span class="p">;</span>  <span class="c1">//Get an index number</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-22"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-22">&#182;</a></div><p>micSEQ falls inside the window.
Add seqence number to the list of received numbers.</p></td><td class="code"><div class="highlight"><pre>		<span class="n">context</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">|=</span> <span class="n">index</span><span class="p">;</span>

		<span class="n">MoveWindow</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="n">micSeq</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">MoveWindow</span><span class="p">(</span><span class="n">miccntx</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u32</span> <span class="n">micSeq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">shift</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-23"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-23">&#182;</a></div><p>Move window if seq greater than the middle of the window</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">micSeq</span> <span class="o">&gt;</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">micSeq</span> <span class="o">-</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">window</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
    </pre></div></td></tr>


<tr id="section-24"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-24">&#182;</a></div><p>Shift out old</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">shift</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">&gt;&gt;=</span> <span class="n">shift</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">context</span><span class="o">-&gt;</span><span class="n">window</span> <span class="o">=</span> <span class="n">micSeq</span><span class="p">;</span>      <span class="c1">//Move window</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*==============================================*/</span>
<span class="cm">/*========== EMMH ROUTINES  ====================*/</span>
<span class="cm">/*==============================================*/</span>

<span class="cm">/* mic accumulate */</span>
<span class="cp">#define MIC_ACCUM(val)	\</span>
<span class="cp">	context-&gt;accum += (u64)(val) * context-&gt;coeff[coeff_position++];</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">aes_counter</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="cm">/* expand the key to fill the MMH coefficient array */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emmh32_setseed</span><span class="p">(</span><span class="n">emmh32_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pkey</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keylen</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">crypto_cipher</span> <span class="o">*</span><span class="n">tfm</span><span class="p">)</span>
<span class="p">{</span>
  <span class="cm">/* take the keying material, expand if necessary, truncate at 16-bytes */</span>
  <span class="cm">/* run through AES counter mode to generate context-&gt;coeff[] */</span>
  
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">counter</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">cipher</span><span class="p">,</span> <span class="n">plain</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="n">crypto_cipher_setkey</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">pkey</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">coeff</span><span class="p">);</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">aes_counter</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">aes_counter</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">aes_counter</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">aes_counter</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">counter</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span>
		<span class="n">counter</span><span class="o">++</span><span class="p">;</span>
		<span class="n">memcpy</span> <span class="p">(</span><span class="n">plain</span><span class="p">,</span> <span class="n">aes_counter</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">crypto_cipher_encrypt_one</span><span class="p">(</span><span class="n">tfm</span><span class="p">,</span> <span class="n">plain</span><span class="p">,</span> <span class="n">plain</span><span class="p">);</span>
		<span class="n">cipher</span> <span class="o">=</span> <span class="n">plain</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">coeff</span><span class="p">));</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">coeff</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">cipher</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">j</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* prepare for calculation of a new mic */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emmh32_init</span><span class="p">(</span><span class="n">emmh32_context</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* prepare for new mic calculation */</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">accum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">context</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* add some bytes to the mic calculation */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emmh32_update</span><span class="p">(</span><span class="n">emmh32_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pOctets</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">coeff_position</span><span class="p">,</span> <span class="n">byte_position</span><span class="p">;</span>
  
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
  
	<span class="n">coeff_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
  
	<span class="cm">/* deal with partial 32-bit word left over from last update */</span>
	<span class="n">byte_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte_position</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* have a partial word in part to deal with */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">.</span><span class="n">d8</span><span class="p">[</span><span class="n">byte_position</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pOctets</span><span class="o">++</span><span class="p">;</span>
			<span class="n">context</span><span class="o">-&gt;</span><span class="n">position</span><span class="o">++</span><span class="p">;</span>
			<span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">byte_position</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">MIC_ACCUM</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">.</span><span class="n">d32</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* deal with full 32-bit words */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">MIC_ACCUM</span><span class="p">(</span><span class="n">ntohl</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span><span class="n">pOctets</span><span class="p">));</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">pOctets</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* deal with partial 32-bit word that will be left over from this update */</span>
	<span class="n">byte_position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">.</span><span class="n">d8</span><span class="p">[</span><span class="n">byte_position</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">pOctets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">context</span><span class="o">-&gt;</span><span class="n">position</span><span class="o">++</span><span class="p">;</span>
		<span class="n">len</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* mask used to zero empty bytes for final partial word */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">mask32</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00000000L</span><span class="p">,</span> <span class="mh">0xFF000000L</span><span class="p">,</span> <span class="mh">0xFFFF0000L</span><span class="p">,</span> <span class="mh">0xFFFFFF00L</span> <span class="p">};</span>

<span class="cm">/* calculate the mic */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">emmh32_final</span><span class="p">(</span><span class="n">emmh32_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u8</span> <span class="n">digest</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">coeff_position</span><span class="p">,</span> <span class="n">byte_position</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">val</span><span class="p">;</span>
  
	<span class="n">u64</span> <span class="n">sum</span><span class="p">,</span> <span class="n">utmp</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">stmp</span><span class="p">;</span>

	<span class="n">coeff_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
  
	<span class="cm">/* deal with partial 32-bit word left over from last update */</span>
	<span class="n">byte_position</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">byte_position</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* have a partial word in part to deal with */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ntohl</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">part</span><span class="p">.</span><span class="n">d32</span><span class="p">);</span>
		<span class="n">MIC_ACCUM</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask32</span><span class="p">[</span><span class="n">byte_position</span><span class="p">]);</span>	<span class="cm">/* zero empty bytes */</span>
	<span class="p">}</span>

	<span class="cm">/* reduce the accumulated u64 to a 32-bit MIC */</span>
	<span class="n">sum</span> <span class="o">=</span> <span class="n">context</span><span class="o">-&gt;</span><span class="n">accum</span><span class="p">;</span>
	<span class="n">stmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">sum</span>  <span class="o">&amp;</span> <span class="mh">0xffffffffLL</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">sum</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span>  <span class="o">*</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">utmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">stmp</span> <span class="o">&amp;</span> <span class="mh">0xffffffffLL</span><span class="p">)</span> <span class="o">-</span> <span class="p">((</span><span class="n">stmp</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">sum</span> <span class="o">=</span> <span class="n">utmp</span> <span class="o">&amp;</span> <span class="mh">0xffffffffLL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">utmp</span> <span class="o">&gt;</span> <span class="mh">0x10000000fLL</span><span class="p">)</span>
		<span class="n">sum</span> <span class="o">-=</span> <span class="mi">15</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sum</span><span class="p">;</span>
	<span class="n">digest</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;&gt;</span><span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">digest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">digest</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="n">digest</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">readBSSListRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">first</span><span class="p">,</span>
		      <span class="n">BSSListRid</span> <span class="o">*</span><span class="n">list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_RADIO_MASK</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="o">=</span><span class="n">CMD_LISTBSS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">list_bss_task</span> <span class="o">=</span> <span class="n">current</span><span class="p">;</span>
		<span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="cm">/* Let the command take effect */</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">list_bss_task</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">first</span> <span class="o">?</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListFirst</span> <span class="o">:</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListNext</span><span class="p">,</span>
			    <span class="n">list</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListRidLen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">readWepKeyRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">WepKeyRid</span> <span class="o">*</span><span class="n">wkr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">temp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">temp</span> <span class="o">?</span> <span class="n">RID_WEP_TEMP</span> <span class="o">:</span> <span class="n">RID_WEP_PERM</span><span class="p">,</span>
				<span class="n">wkr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wkr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">writeWepKeyRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">WepKeyRid</span> <span class="o">*</span><span class="n">wkr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">perm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">PC4500_writerid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_WEP_TEMP</span><span class="p">,</span> <span class="n">wkr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wkr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">!=</span><span class="n">SUCCESS</span><span class="p">)</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WEP_TEMP set %x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PC4500_writerid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_WEP_PERM</span><span class="p">,</span> <span class="n">wkr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wkr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="o">!=</span><span class="n">SUCCESS</span><span class="p">)</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WEP_PERM set %x&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">readSsidRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">SsidRid</span> <span class="o">*</span><span class="n">ssidr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_SSID</span><span class="p">,</span> <span class="n">ssidr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ssidr</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">writeSsidRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">SsidRid</span> <span class="o">*</span><span class="n">pssidr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PC4500_writerid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_SSID</span><span class="p">,</span> <span class="n">pssidr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pssidr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">readConfigRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">ConfigRid</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_ACTUALCONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">checkThrottle</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cm">/* Old hardware had a limit on encryption speed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">!=</span> <span class="n">AUTH_OPEN</span> <span class="o">&amp;&amp;</span> <span class="n">maxencrypt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">maxencrypt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">writeConfigRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ConfigRid</span> <span class="n">cfgr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">checkThrottle</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="n">cfgr</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cfgr</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;</span> <span class="n">MODE_CFG_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_STA_IBSS</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_ADHOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_ADHOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PC4500_writerid</span><span class="p">(</span> <span class="n">ai</span><span class="p">,</span> <span class="n">RID_CONFIG</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfgr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfgr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">readStatusRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">StatusRid</span> <span class="o">*</span><span class="n">statr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_STATUS</span><span class="p">,</span> <span class="n">statr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">statr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">readAPListRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">APListRid</span> <span class="o">*</span><span class="n">aplr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_APLIST</span><span class="p">,</span> <span class="n">aplr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">aplr</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">writeAPListRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">APListRid</span> <span class="o">*</span><span class="n">aplr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PC4500_writerid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_APLIST</span><span class="p">,</span> <span class="n">aplr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">aplr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">readCapabilityRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">CapabilityRid</span> <span class="o">*</span><span class="n">capr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_CAPABILITIES</span><span class="p">,</span> <span class="n">capr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">capr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">readStatsRid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span><span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">StatsRid</span> <span class="o">*</span><span class="n">sr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">sr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sr</span><span class="p">),</span> <span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">try_auto_wep</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">auto_wep</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_RADIO_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_FLASHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Make sure the card is configured.</span>
<span class="cm">	 * Wireless Extensions may postpone config changes until the card</span>
<span class="cm">	 * is open (to pipeline changes and speed-up card setup). If</span>
<span class="cm">	 * those changes are not yet committed, do it now - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writeConfigRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_DIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">airo_thread_task</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">airo_thread</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">airo_thread_task</span><span class="p">))</span>
			<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">airo_thread_task</span><span class="p">);</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">airo_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="s">&quot;register interrupt %d failed, rc %d&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_DIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
			<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">airo_thread_task</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Power on the MAC controller (which may have been disabled) */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_RADIO_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">enable_interrupts</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>

		<span class="n">try_auto_wep</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">mpi_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">npacks</span><span class="p">,</span> <span class="n">pending</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s: skb == NULL!&quot;</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">npacks</span> <span class="o">=</span> <span class="n">skb_queue_len</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">npacks</span> <span class="o">&gt;=</span> <span class="n">MAXTXQ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npacks</span> <span class="o">&gt;</span> <span class="n">MAXTXQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_queue_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">aux_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb_queue_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">pending</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">aux_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pending</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">mpi_send_packet</span> <span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * @mpi_send_packet</span>
<span class="cm"> *</span>
<span class="cm"> * Attempt to transmit a packet. Can be called from interrupt</span>
<span class="cm"> * or transmit . return number of packets we tried to send</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_send_packet</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">payloadLen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">sendbuf</span><span class="p">;</span>

	<span class="cm">/* get a packet to send */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="s">&quot;%s: Dequeue&#39;d zero in send_packet()&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check min length*/</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">eoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span><span class="n">len</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">WifiHdr</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Magic, the cards firmware needs a length count (2 bytes) in the host buffer</span>
<span class="cm"> * right after  TXFID_HDR.The TXFID_HDR contains the status short so payloadlen</span>
<span class="cm"> * is immediately after it. ------------------------------------------------</span>
<span class="cm"> *                         |TXFIDHDR+STATUS|PAYLOADLEN|802.3HDR|PACKETDATA|</span>
<span class="cm"> *                         ------------------------------------------------</span>
<span class="cm"> */</span>

	<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_host_addr</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">wifictlhdr8023</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wifictlhdr8023</span><span class="p">));</span>

	<span class="n">payloadLen</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_host_addr</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">wifictlhdr8023</span><span class="p">));</span>
	<span class="n">sendbuf</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_host_addr</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">wifictlhdr8023</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Firmware automatically puts 802 header on so</span>
<span class="cm">	 * we don&#39;t need to account for it in the length</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MIC_CAPABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">ntohs</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">)[</span><span class="mi">6</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0x888E</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">MICBuffer</span> <span class="n">pMic</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">encapsulate</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">etherHead</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pMic</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">))</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>

		<span class="o">*</span><span class="n">payloadLen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="o">-</span><span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">)</span><span class="o">+</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pMic</span><span class="p">));</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pMic</span><span class="p">);</span>
		<span class="cm">/* copy data into airo dma buffer */</span>
		<span class="n">memcpy</span> <span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">));</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">);</span>
		<span class="n">sendbuf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">);</span>
		<span class="n">memcpy</span> <span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pMic</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pMic</span><span class="p">));</span>
		<span class="n">sendbuf</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pMic</span><span class="p">);</span>
		<span class="n">memcpy</span> <span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">payloadLen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">));</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

		<span class="cm">/* copy data into airo dma buffer */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_ram_off</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TxFid</span><span class="p">));</span>

	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_tx_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">s32</span> <span class="n">fid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="p">((</span><span class="n">WifiCtlHdr</span> <span class="o">*</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_host_addr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctlhdr</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="cm">/* Too many retries */</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="cm">/* Transmit lifetime exceeded */</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_heartbeat_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">8</span><span class="p">)</span> <span class="cm">/* Aid fail */</span>
		<span class="p">{</span> <span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="cm">/* MAC disabled */</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="cm">/* Association lost */</span>
		<span class="p">{</span> <span class="p">}</span>
	<span class="cm">/* We produce a TXDROP event only for retry or lifetime</span>
<span class="cm">	 * exceeded, because that&#39;s the only status that really mean</span>
<span class="cm">	 * that this particular node went away.</span>
<span class="cm">	 * Other errors means that *we* screwed up. - Jean II */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">union</span> <span class="n">iwreq_data</span>	<span class="n">wrqu</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">junk</span><span class="p">[</span><span class="mh">0x18</span><span class="p">];</span>

		<span class="cm">/* Faster to skip over useless data than to do</span>
<span class="cm">		 * another bap_setup(). We are at offset 0x6 and</span>
<span class="cm">		 * need to go to 0x18 and read 6 bytes - Jean II */</span>
		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">junk</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>

		<span class="cm">/* Copy 802.11 dest address.</span>
<span class="cm">		 * We use the 802.11 header because the frame may</span>
<span class="cm">		 * not be 802.3 or may be mangled...</span>
<span class="cm">		 * In Ad-Hoc mode, it will be the node address.</span>
<span class="cm">		 * In managed mode, it will be most likely the AP addr</span>
<span class="cm">		 * User space will figure out how to convert it to</span>
<span class="cm">		 * whatever it needs (IP address or else).</span>
<span class="cm">		 * - Jean II */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">junk</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

		<span class="cm">/* Send event to user space */</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">IWEVTXDROP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_end_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">fid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">fids</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">transmit_802_3_packet</span> <span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fids</span><span class="p">[</span><span class="n">fid</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">==</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">airo_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s16</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">fids</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s: skb == NULL!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find a vacant FID */</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">);</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fids</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* check min length*/</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
        <span class="cm">/* Mark fid as used &amp; save length for later */</span>
	<span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xmit</span><span class="p">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">airo_end_xmit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_end_xmit11</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xmit11</span><span class="p">.</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fid</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">xmit11</span><span class="p">.</span><span class="n">fid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">fids</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_XMIT11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">transmit_802_11_packet</span> <span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">fids</span><span class="p">[</span><span class="n">fid</span><span class="p">],</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">==</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">fid</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_window_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">airo_start_xmit11</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s16</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">fids</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Not implemented yet for MPI350 */</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s: skb == NULL!&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find a vacant FID */</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span> <span class="p">);</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fids</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span> <span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="n">MAX_FIDS</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">MAX_FIDS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* check min length*/</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ZLEN</span> <span class="o">&lt;</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">?</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">:</span> <span class="n">ETH_ZLEN</span><span class="p">;</span>
        <span class="cm">/* Mark fid as used &amp; save length for later */</span>
	<span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xmit11</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">xmit11</span><span class="p">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_XMIT11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">airo_end_xmit11</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_read_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">StatsRid</span> <span class="n">stats_rid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">vals</span> <span class="o">=</span> <span class="n">stats_rid</span><span class="p">.</span><span class="n">vals</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_STATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">readStatsRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats_rid</span><span class="p">,</span> <span class="n">RID_STATS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">43</span><span class="p">])</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">44</span><span class="p">])</span> <span class="o">+</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">45</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">39</span><span class="p">])</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">40</span><span class="p">])</span> <span class="o">+</span>
			       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">41</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">92</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">91</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
			      <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">+</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">42</span><span class="p">])</span> <span class="o">+</span>
			      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">multicast</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">43</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">89</span><span class="p">]);</span>

	<span class="cm">/* detailed rx_errors: */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">airo_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_STATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Get stats out of the card if available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_STATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">airo_read_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_set_promisc</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="o">=</span><span class="n">CMD_SETMODE</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_PROMISC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span><span class="o">=</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="o">?</span> <span class="n">PROMISC</span> <span class="o">:</span> <span class="n">NOPROMISC</span><span class="p">;</span>
	<span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change_bit</span><span class="p">(</span><span class="n">FLAG_PROMISC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_PROMISC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">airo_set_promisc</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="o">&amp;</span><span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">netdev_mc_empty</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Turn on multicast.  (Should be already setup...) */</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">macAddr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writeConfigRid</span> <span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memcpy</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">)</span>
		<span class="n">memcpy</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_mtu</span> <span class="o">&lt;</span> <span class="mi">68</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_mtu</span> <span class="o">&gt;</span> <span class="mi">2400</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">new_mtu</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">airo_devices</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">add_airo_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Upper layers already keep track of PCI devices,</span>
<span class="cm">	 * so we only need to remember our non-PCI cards. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">airo_devices</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">del_airo_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">)</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span> <span class="o">!=</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef POWER_ON_DOWN</span>
		<span class="cm">/* Shut power to the card. The idea is that the user can save</span>
<span class="cm">		 * power when he doesn&#39;t need the card with &quot;ifconfig down&quot;.</span>
<span class="cm">		 * That&#39;s the method that is most friendly towards the network</span>
<span class="cm">		 * stack (i.e. the network stack won&#39;t try to broadcast</span>
<span class="cm">		 * anything on the interface and routes are gone. Jean II */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_RADIO_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">disable_interrupts</span><span class="p">(</span> <span class="n">ai</span> <span class="p">);</span>

		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_DIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">airo_thread_task</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">stop_airo_card</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freeres</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_RADIO_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">disable_interrupts</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="n">takedown_proc_entry</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ai</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">unregister_netdev</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">);</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_REGISTERED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Clean out tx queue</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;(</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">));)</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">airo_networks_free</span> <span class="p">(</span><span class="n">ai</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freeres</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* PCMCIA frees this stuff, so only for PCI and ISA */</span>
	        <span class="n">release_region</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">64</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">)</span>
				<span class="n">mpi_unmap_card</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pcimem</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pcimem</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span><span class="p">)</span>
				<span class="n">iounmap</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span><span class="p">);</span>
			<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SHARED_LEN</span><span class="p">,</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared_dma</span><span class="p">);</span>
		<span class="p">}</span>
        <span class="p">}</span>
	<span class="n">crypto_free_cipher</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">tfm</span><span class="p">);</span>
	<span class="n">del_airo_dev</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">stop_airo_card</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wll_header_parse</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">haddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">haddr</span><span class="p">,</span> <span class="n">skb_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpi_unmap_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aux_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">aux_len</span> <span class="o">=</span> <span class="n">AUXMEMSIZE</span><span class="p">;</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">aux_start</span><span class="p">,</span> <span class="n">aux_len</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*************************************************************</span>
<span class="cm"> *  This routine assumes that descriptors have been setup .</span>
<span class="cm"> *  Run at insmod time or after reset  when the decriptors</span>
<span class="cm"> *  have been initialized . Returns 0 if all is well nz</span>
<span class="cm"> *  otherwise . Does not allocate memory but sets up card</span>
<span class="cm"> *  using previously allocated descriptors.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_init_descriptors</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="cm">/* Alloc  card RX descriptors */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_ALLOCATEAUX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">FID_RX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_ram_off</span> <span class="o">-</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="n">MPI_MAX_FIDS</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">=</span><span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate RX FID&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MPI_MAX_FIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_ram_off</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RxFid</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Alloc card TX descriptors */</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_ALLOCATEAUX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">FID_TX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_ram_off</span> <span class="o">-</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="n">MPI_MAX_FIDS</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MPI_MAX_FIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_ram_off</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TxFid</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">eoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Last descriptor has EOC set */</span>

	<span class="n">rc</span><span class="o">=</span><span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate TX FID&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Alloc card Rid descriptor */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_ALLOCATEAUX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">RID_RW</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">card_ram_off</span> <span class="o">-</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Magic number... */</span>
	<span class="n">rc</span><span class="o">=</span><span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t allocate RID&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">card_ram_off</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Rid</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We are setting up three things here:</span>
<span class="cm"> * 1) Map AUX memory for descriptors: Rid, TxFid, or RxFid.</span>
<span class="cm"> * 2) Map PCI memory for issuing commands.</span>
<span class="cm"> * 3) Allocate memory (shared) to send and receive ethernet frames.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">mpi_map_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">,</span> <span class="n">aux_start</span><span class="p">,</span> <span class="n">aux_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">busaddroff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vpackoff</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pciaddroff</span><span class="p">;</span>

	<span class="n">mem_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mem_len</span> <span class="o">=</span> <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">aux_start</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">aux_len</span> <span class="o">=</span> <span class="n">AUXMEMSIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t get region %x[%x]&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mem_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mem_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">aux_start</span><span class="p">,</span> <span class="n">aux_len</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t get region %x[%x]&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">aux_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">aux_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_region1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">pcimem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pcimem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t map region %x[%x]&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mem_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mem_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_region2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">aux_start</span><span class="p">,</span> <span class="n">aux_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t map region %x[%x]&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">aux_start</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">aux_len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_memmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reserve PKTSIZE for each fid and 2K for the Rids */</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SHARED_LEN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t alloc_consistent %d&quot;</span><span class="p">,</span>
			<span class="n">PCI_SHARED_LEN</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_auxmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup descriptor RX, TX, CONFIG</span>
<span class="cm">	 */</span>
	<span class="n">busaddroff</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared_dma</span><span class="p">;</span>
	<span class="n">pciaddroff</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span> <span class="o">+</span> <span class="n">AUX_OFFSET</span><span class="p">;</span>
	<span class="n">vpackoff</span>   <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">;</span>

	<span class="cm">/* RX descriptor setup */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MPI_MAX_FIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_ram_off</span> <span class="o">=</span> <span class="n">pciaddroff</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virtual_host_addr</span> <span class="o">=</span> <span class="n">vpackoff</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_desc</span><span class="p">.</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">busaddroff</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_desc</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_desc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">PKTSIZE</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rx_desc</span><span class="p">.</span><span class="n">rdy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">pciaddroff</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">RxFid</span><span class="p">);</span>
		<span class="n">busaddroff</span> <span class="o">+=</span> <span class="n">PKTSIZE</span><span class="p">;</span>
		<span class="n">vpackoff</span>   <span class="o">+=</span> <span class="n">PKTSIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TX descriptor setup */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MPI_MAX_FIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card_ram_off</span> <span class="o">=</span> <span class="n">pciaddroff</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virtual_host_addr</span> <span class="o">=</span> <span class="n">vpackoff</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">busaddroff</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">virtual_host_addr</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">wifictlhdr8023</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wifictlhdr8023</span><span class="p">));</span>

		<span class="n">pciaddroff</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TxFid</span><span class="p">);</span>
		<span class="n">busaddroff</span> <span class="o">+=</span> <span class="n">PKTSIZE</span><span class="p">;</span>
		<span class="n">vpackoff</span>   <span class="o">+=</span> <span class="n">PKTSIZE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">txfids</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">tx_desc</span><span class="p">.</span><span class="n">eoc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Last descriptor has EOC set */</span>

	<span class="cm">/* Rid descriptor setup */</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">card_ram_off</span> <span class="o">=</span> <span class="n">pciaddroff</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">virtual_host_addr</span> <span class="o">=</span> <span class="n">vpackoff</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">busaddroff</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">ridbus</span> <span class="o">=</span> <span class="n">busaddroff</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">rid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">RIDSIZE</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">pciaddroff</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Rid</span><span class="p">);</span>
	<span class="n">busaddroff</span> <span class="o">+=</span> <span class="n">RIDSIZE</span><span class="p">;</span>
	<span class="n">vpackoff</span>   <span class="o">+=</span> <span class="n">RIDSIZE</span><span class="p">;</span>

	<span class="cm">/* Tell card about descriptors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mpi_init_descriptors</span> <span class="p">(</span><span class="n">ai</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">free_shared</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">free_shared:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SHARED_LEN</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared_dma</span><span class="p">);</span>
 <span class="nl">free_auxmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span><span class="p">);</span>
 <span class="nl">free_memmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pcimem</span><span class="p">);</span>
 <span class="nl">free_region2:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">aux_start</span><span class="p">,</span> <span class="n">aux_len</span><span class="p">);</span>
 <span class="nl">free_region1:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">mem_len</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">header_ops</span> <span class="n">airo_header_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parse</span> <span class="o">=</span> <span class="n">wll_header_parse</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">airo11_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> 		<span class="o">=</span> <span class="n">airo_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> 		<span class="o">=</span> <span class="n">airo_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> 	<span class="o">=</span> <span class="n">airo_start_xmit11</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span> 		<span class="o">=</span> <span class="n">airo_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">airo_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">airo_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">airo_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wifi_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">airo11_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">airo_header_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">airo_handler_def</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>               <span class="o">=</span> <span class="n">ARPHRD_IEEE80211</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span>    <span class="o">=</span> <span class="n">ETH_HLEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span>                <span class="o">=</span> <span class="n">AIRO_DEF_MTU</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span>           <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>       <span class="o">=</span> <span class="mi">100</span><span class="p">;</span> 

	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">,</span><span class="mh">0xFF</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span>              <span class="o">=</span> <span class="n">IFF_BROADCAST</span><span class="o">|</span><span class="n">IFF_MULTICAST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">init_wifidev</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">ethdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&quot;wifi%d&quot;</span><span class="p">,</span> <span class="n">wifi_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="n">ethdev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">ethdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ethdev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_data</span> <span class="o">=</span> <span class="n">ethdev</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ethdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ethdev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reset_card</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">waitbusy</span> <span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">COMMAND</span><span class="p">,</span><span class="n">CMD_SOFTRESET</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="n">waitbusy</span> <span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define AIRO_MAX_NETWORK_COUNT	64</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_networks_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">networks</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">AIRO_MAX_NETWORK_COUNT</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BSSListElement</span><span class="p">),</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_warn</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Out of memory allocating beacons&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_networks_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">);</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">networks</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_networks_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AIRO_MAX_NETWORK_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">networks</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">airo_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">airo_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">airo_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">airo_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">airo_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">airo_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">airo_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">airo_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">airo_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">mpi_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">airo_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">airo_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">mpi_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">airo_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">airo_set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">airo_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">airo_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">airo_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">_init_airo_card</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span>
					   <span class="kt">int</span> <span class="n">is_pcmcia</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dmdev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">CapabilityRid</span> <span class="n">cap_rid</span><span class="p">;</span>

	<span class="cm">/* Create the network device object. */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ai</span><span class="p">),</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">ether_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t alloc_etherdev&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">FLAG_RADIO_DOWN</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5000</span> <span class="o">||</span> <span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0xa504</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">airo_print_dbg</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Found an MPI350 card&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">aux_lock</span><span class="p">);</span>
	<span class="n">sema_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">tfm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">add_airo_dev</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">airo_networks_allocate</span> <span class="p">(</span><span class="n">ai</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="n">airo_networks_initialize</span> <span class="p">(</span><span class="n">ai</span><span class="p">);</span>

	<span class="n">skb_queue_head_init</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">);</span>

	<span class="cm">/* The Airo-specific entries in the device structure. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mpi_netdev_ops</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">airo_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">airo_handler_def</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">.</span><span class="n">spy_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_TX_SKB_SHARING</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dmdev</span><span class="p">);</span>

	<span class="n">reset_card</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">400</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_pcmcia</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t request region&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_nets</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mpi_map_card</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">pci</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Could not map memory&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_out_res</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">setup_card</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;MAC could not be enabled&quot;</span> <span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">err_out_map</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bap_read</span> <span class="o">=</span> <span class="n">fast_bap_read</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_FLASHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;eth%d&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t register_netdev&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_map</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span> <span class="o">=</span> <span class="n">init_wifidev</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_reg</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">readCapabilityRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_wifi</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* WEP capability discovery */</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">wep_capable</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softCap</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x02</span><span class="p">))</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">max_wep_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softCap</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x80</span><span class="p">))</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">airo_print_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Firmware version %x.%x.%02d&quot;</span><span class="p">,</span>
	                <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softVer</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">),</span>
	                <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softVer</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">),</span>
	                <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softSubVer</span><span class="p">));</span>

	<span class="cm">/* Test for WPA support */</span>
	<span class="cm">/* Only firmware versions 5.30.17 or better can do WPA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softVer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x530</span>
	 <span class="o">||</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softVer</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x530</span>
	      <span class="o">&amp;&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softSubVer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">17</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">airo_print_info</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WPA supported.&quot;</span><span class="p">);</span>

		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_WPA_CAPABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListFirst</span> <span class="o">=</span> <span class="n">RID_WPA_BSSLISTFIRST</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListNext</span> <span class="o">=</span> <span class="n">RID_WPA_BSSLISTNEXT</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListRidLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BSSListRid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">airo_print_info</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WPA unsupported with firmware &quot;</span>
			<span class="s">&quot;versions older than 5.30.17.&quot;</span><span class="p">);</span>

		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListFirst</span> <span class="o">=</span> <span class="n">RID_BSSLISTFIRST</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListNext</span> <span class="o">=</span> <span class="n">RID_BSSLISTNEXT</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListRidLen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BSSListRid</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">BSSListRidExtra</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_REGISTERED</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">airo_print_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;MAC enabled %pM&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="cm">/* Allocate the transmit buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probe</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transmit_allocate</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">AIRO_DEF_MTU</span><span class="p">,</span><span class="n">i</span><span class="o">&gt;=</span><span class="n">MAX_FIDS</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">setup_proc_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_wifi</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>

<span class="nl">err_out_wifi:</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">);</span>
<span class="nl">err_out_reg:</span>
	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_out_map:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">pci</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">PCI_SHARED_LEN</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">shared_dma</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pcimem</span><span class="p">);</span>
		<span class="n">mpi_unmap_card</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">err_out_res:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_pcmcia</span><span class="p">)</span>
	        <span class="n">release_region</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">64</span> <span class="p">);</span>
<span class="nl">err_out_nets:</span>
	<span class="n">airo_networks_free</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
<span class="nl">err_out_free:</span>
	<span class="n">del_airo_dev</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">init_airo_card</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pcmcia</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dmdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">_init_airo_card</span> <span class="p">(</span> <span class="n">irq</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">is_pcmcia</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">dmdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">init_airo_card</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">waitbusy</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">COMMAND_BUSY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span> <span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">++</span><span class="n">delay</span> <span class="o">%</span> <span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_CLEARCOMMANDBUSY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">reset_airo_card</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset_card</span> <span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">setup_card</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;MAC could not be enabled&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">airo_print_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;MAC enabled %pM&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="cm">/* Allocate the transmit buffers if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transmit_allocate</span> <span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">AIRO_DEF_MTU</span><span class="p">,</span><span class="n">i</span><span class="o">&gt;=</span><span class="n">MAX_FIDS</span><span class="o">/</span><span class="mi">2</span><span class="p">);</span>

	<span class="n">enable_interrupts</span><span class="p">(</span> <span class="n">ai</span> <span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">reset_airo_card</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_send_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="n">StatusRid</span> <span class="n">status_rid</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RID_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status_rid</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="cm">/* Send event to user space */</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_process_scan_results</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span>	<span class="n">wrqu</span><span class="p">;</span>
	<span class="n">BSSListRid</span> <span class="n">bss</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">BSSListElement</span> <span class="o">*</span> <span class="n">loop_net</span><span class="p">;</span>
	<span class="n">BSSListElement</span> <span class="o">*</span> <span class="n">tmp_net</span><span class="p">;</span>

	<span class="cm">/* Blow away current list of scan results */</span>
	<span class="n">list_for_each_entry_safe</span> <span class="p">(</span><span class="n">loop_net</span><span class="p">,</span> <span class="n">tmp_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_move_tail</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">loop_net</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">);</span>
		<span class="cm">/* Don&#39;t blow away -&gt;list, just BSS data */</span>
		<span class="n">memset</span> <span class="p">(</span><span class="n">loop_net</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">loop_net</span><span class="o">-&gt;</span><span class="n">bss</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Try to read the first entry of the scan result */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListFirst</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bss</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListRidLen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">rc</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">bss</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* No scan results */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Read and parse all entries */</span>
	<span class="n">tmp_net</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span><span class="p">((</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bss</span><span class="p">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Grab a network off the free list */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp_net</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					    <span class="n">BSSListElement</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
			<span class="n">list_del</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_free_list</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp_net</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">tmp_net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bss</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp_net</span><span class="o">-&gt;</span><span class="n">bss</span><span class="p">));</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp_net</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">);</span>
			<span class="n">tmp_net</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Read next entry */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListNext</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">bss</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">bssListRidLen</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_SCAN_RESULTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="cm">/* Send an empty event to user space.</span>
<span class="cm">	 * We don&#39;t send the received data on</span>
<span class="cm">	 * the event because it would require</span>
<span class="cm">	 * us to do complex transcoding, and</span>
<span class="cm">	 * we want to minimise the work done in</span>
<span class="cm">	 * the irq handler. Use a request to</span>
<span class="cm">	 * extract the data - Jean II */</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">locked</span><span class="p">;</span>

	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* make swsusp happy with our thread */</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_DIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">locked</span> <span class="o">=</span> <span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>

			<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
			<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
				<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">||</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span> <span class="o">&amp;&amp;</span>
							<span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span><span class="p">)){</span>
						<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_SCAN_RESULTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">&amp;&amp;</span>
							<span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">)){</span>
						<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_AUTOWEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
					    <span class="o">!</span><span class="n">freezing</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
						<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">wake_at</span><span class="p">;</span>
						<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">||</span> <span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span><span class="p">)</span> <span class="p">{</span>
							<span class="n">wake_at</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">,</span>
								<span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span><span class="p">);</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="n">wake_at</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">,</span>
								<span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span><span class="p">);</span>
						<span class="p">}</span>
						<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">wake_at</span> <span class="o">-</span> <span class="n">jiffies</span><span class="p">);</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">()</span> <span class="o">&amp;&amp;</span>
					   <span class="o">!</span><span class="n">freezing</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">schedule</span><span class="p">();</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">current</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">TASK_RUNNING</span><span class="p">;</span>
			<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">locked</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_DIE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">event</span> <span class="o">||</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_FLASHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">airo_end_xmit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_XMIT11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">airo_end_xmit11</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_STATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">airo_read_stats</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_WSTATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">airo_read_wireless_stats</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_PROMISC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">airo_set_promisc</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_MIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">micinit</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">airo_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_AUTOWEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">timer_func</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_SCAN_RESULTS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span>
			<span class="n">airo_process_scan_results</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="k">else</span>  <span class="cm">/* Shouldn&#39;t get here, but we make sure to unlock */</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">header_len</span><span class="p">(</span><span class="n">__le16</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ctl</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">10</span><span class="p">;</span>	<span class="cm">/* one-address control packet */</span>
		<span class="k">return</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* two-address control packet */</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">fc</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x300</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">30</span><span class="p">;</span>	<span class="cm">/* WDS packet */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">24</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_handle_cisco_mic</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MIC_CAPABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_MIC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Airo Status codes */</span>
<span class="cp">#define STAT_NOBEACON	0x8000 </span><span class="cm">/* Loss of sync - missed beacons */</span><span class="cp"></span>
<span class="cp">#define STAT_MAXRETRIES	0x8001 </span><span class="cm">/* Loss of sync - max retries */</span><span class="cp"></span>
<span class="cp">#define STAT_MAXARL	0x8002 </span><span class="cm">/* Loss of sync - average retry level exceeded*/</span><span class="cp"></span>
<span class="cp">#define STAT_FORCELOSS	0x8003 </span><span class="cm">/* Loss of sync - host request */</span><span class="cp"></span>
<span class="cp">#define STAT_TSFSYNC	0x8004 </span><span class="cm">/* Loss of sync - TSF synchronization */</span><span class="cp"></span>
<span class="cp">#define STAT_DEAUTH	0x8100 </span><span class="cm">/* low byte is 802.11 reason code */</span><span class="cp"></span>
<span class="cp">#define STAT_DISASSOC	0x8200 </span><span class="cm">/* low byte is 802.11 reason code */</span><span class="cp"></span>
<span class="cp">#define STAT_ASSOC_FAIL	0x8400 </span><span class="cm">/* low byte is 802.11 reason code */</span><span class="cp"></span>
<span class="cp">#define STAT_AUTH_FAIL	0x0300 </span><span class="cm">/* low byte is 802.11 reason code */</span><span class="cp"></span>
<span class="cp">#define STAT_ASSOC	0x0400 </span><span class="cm">/* Associated */</span><span class="cp"></span>
<span class="cp">#define STAT_REASSOC    0x0600 </span><span class="cm">/* Reassociated?  Only on firmware &gt;= 5.30.17 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_print_status</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">devname</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">STAT_NOBEACON</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">STAT_NOBEACON</span>:
			<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;link lost (missed beacons)&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STAT_MAXRETRIES</span>:
		<span class="k">case</span> <span class="n">STAT_MAXARL</span>:
			<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;link lost (max retries)&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STAT_FORCELOSS</span>:
			<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;link lost (local choice)&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">STAT_TSFSYNC</span>:
			<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;link lost (TSF sync lost)&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;unknow status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STAT_DEAUTH</span>:
		<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;deauthenticated (reason: %d)&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STAT_DISASSOC</span>:
		<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;disassociated (reason: %d)&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STAT_ASSOC_FAIL</span>:
		<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;association failed (reason: %d)&quot;</span><span class="p">,</span>
			       <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STAT_AUTH_FAIL</span>:
		<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;authentication failed (reason: %d)&quot;</span><span class="p">,</span>
			       <span class="n">reason</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">STAT_ASSOC</span>:
	<span class="k">case</span> <span class="n">STAT_REASSOC</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">devname</span><span class="p">,</span> <span class="s">&quot;unknow status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_handle_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">iwreq_data</span> <span class="n">wrqu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scan_forceloss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* Get new status and acknowledge the link change */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">LINKSTAT</span><span class="p">));</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_LINK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">STAT_FORCELOSS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">scan_forceloss</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">airo_print_status</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="n">STAT_ASSOC</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">STAT_REASSOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">auto_wep</span><span class="p">)</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">list_bss_task</span><span class="p">)</span>
			<span class="n">wake_up_process</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">list_bss_task</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_UPDATE_UNI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_UPDATE_MULTI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_EVENT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">airo_send_event</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">scan_forceloss</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">auto_wep</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Send event to user space */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="sc">&#39;\0&#39;</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">wrqu</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">wireless_send_event</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_handle_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">fid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">mpi_receive_802_11</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">mpi_receive_802_3</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_RX</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fid</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RXFID</span><span class="p">);</span>

	<span class="cm">/* Get the packet length */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bap_setup</span> <span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="n">bap_read</span> <span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">),</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="cm">/* Bad CRC. Ignore packet */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="mh">0x36</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">AIRO_DEF_MTU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Bad size %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">fc</span><span class="p">),</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">header_len</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* This way the IP header is aligned */</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">fc</span><span class="p">;</span>
		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
			<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>

		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="n">gap</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gap</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gap</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">tmpbuf</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;gaplen too &quot;</span>
					<span class="s">&quot;big. Problems will follow...&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">MICBuffer</span> <span class="n">micbuf</span><span class="p">;</span>

		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">micbuf</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">micbuf</span><span class="p">),</span> <span class="n">BAP0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">micbuf</span><span class="p">.</span><span class="n">typelen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x05DC</span><span class="p">)</span>
				<span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">micbuf</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">micbuf</span><span class="p">);</span>
				<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">decapsulate</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">micbuf</span><span class="p">,</span> <span class="p">(</span><span class="n">etherHead</span><span class="o">*</span><span class="p">)</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span>
			<span class="n">dev_kfree_skb_irq</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef WIRELESS_SPY</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">success</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">wstats</span><span class="p">;</span>

		<span class="cm">/* Prepare spy data : addr + qual */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">fid</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
			<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="p">.</span><span class="n">rssi</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">BAP0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">buffer</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">rssi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">)</span>
			<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">[</span><span class="n">hdr</span><span class="p">.</span><span class="n">rssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]].</span><span class="n">rssidBm</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">rssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">321</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span>  <span class="n">IW_QUAL_LEVEL_UPDATED</span>
				<span class="o">|</span> <span class="n">IW_QUAL_QUAL_UPDATED</span>
				<span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="cm">/* Update spy records */</span>
		<span class="n">wireless_spy_update</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wstats</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* WIRELESS_SPY */</span><span class="cp"></span>

<span class="nl">done:</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_RX</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">;</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>

		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_handle_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EV_TXEXC</span><span class="p">)</span>
			<span class="n">get_tx_error</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">aux_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">aux_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">mpi_send_packet</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">aux_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EV_TX</span> <span class="o">|</span> <span class="n">EV_TXCPY</span> <span class="o">|</span> <span class="n">EV_TXEXC</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fid</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">TXCOMPLFID</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">==</span> <span class="n">fid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EV_TXEXC</span><span class="p">)</span>
			<span class="n">get_tx_error</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EV_TX</span> <span class="o">|</span> <span class="n">EV_TXEXC</span><span class="p">));</span>

		<span class="cm">/* Set up to be used again */</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EV_TX</span> <span class="o">|</span> <span class="n">EV_TXCPY</span> <span class="o">|</span> <span class="n">EV_TXEXC</span><span class="p">));</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Unallocated FID was used to xmit&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">airo_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">,</span> <span class="n">savedInterrupts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_device_present</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVSTAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STATUS_INTS</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0xffff</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EV_AWAKE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_AWAKE</span><span class="p">);</span>
			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_AWAKE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">savedInterrupts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">savedInterrupts</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVINTEN</span><span class="p">);</span>
			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVINTEN</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EV_MIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_MIC</span><span class="p">);</span>
			<span class="n">airo_handle_cisco_mic</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EV_LINK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Link status changed */</span>
			<span class="n">airo_handle_link</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Check to see if there is something to receive */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">EV_RX</span><span class="p">)</span>
			<span class="n">airo_handle_rx</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>

		<span class="cm">/* Check to see if a packet has been transmitted */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">EV_TX</span> <span class="o">|</span> <span class="n">EV_TXCPY</span> <span class="o">|</span> <span class="n">EV_TXEXC</span><span class="p">))</span>
			<span class="n">airo_handle_tx</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">STATUS_INTS</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IGNORE_INTS</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">airo_print_warn</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Got weird status %x&quot;</span><span class="p">,</span>
				<span class="n">status</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">STATUS_INTS</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IGNORE_INTS</span> <span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">savedInterrupts</span><span class="p">)</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVINTEN</span><span class="p">,</span> <span class="n">savedInterrupts</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  Routines to talk to the card</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  This was originally written for the 4500, hence the name</span>
<span class="cm"> *  NOTE:  If use with 8bit mode and SMP bad things will happen!</span>
<span class="cm"> *         Why would some one do 8 bit IO in an SMP machine?!?</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">OUT4500</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">do8bitIO</span> <span class="p">)</span>
		<span class="n">outw</span><span class="p">(</span> <span class="n">val</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">reg</span> <span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">reg</span> <span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">IN4500</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span> <span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">do8bitIO</span> <span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">inw</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">reg</span> <span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">reg</span> <span class="p">);</span>
		<span class="n">rc</span> <span class="o">+=</span> <span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">inb</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">enable_MAC</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>

	<span class="cm">/* FLAG_RADIO_OFF : Radio disabled via /proc or Wireless Extensions</span>
<span class="cm">	 * FLAG_RADIO_DOWN : Radio disabled via &quot;ifconfig ethX down&quot;</span>
<span class="cm">	 * Note : we could try to use !netif_running(dev) in enable_MAC()</span>
<span class="cm">	 * instead of this flag, but I don&#39;t trust it *within* the</span>
<span class="cm">	 * open/close functions, and testing both flags together is</span>
<span class="cm">	 * &quot;cheaper&quot; - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_RADIO_MASK</span><span class="p">)</span> <span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">MAC_ENABLE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
	    <span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Cannot enable MAC&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Bad MAC enable reason=%x, &quot;</span>
			<span class="s">&quot;rid=%x, offset=%d&quot;</span><span class="p">,</span> <span class="n">rsp</span><span class="p">.</span><span class="n">rsp0</span><span class="p">,</span> <span class="n">rsp</span><span class="p">.</span><span class="n">rsp1</span><span class="p">,</span> <span class="n">rsp</span><span class="p">.</span><span class="n">rsp2</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_MAC</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span> <span class="p">)</span> <span class="p">{</span>
        <span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">MAC_DISABLE</span><span class="p">;</span> <span class="c1">// disable in case already enabled</span>
		<span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_interrupts</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Enable the interrupts */</span>
	<span class="n">OUT4500</span><span class="p">(</span> <span class="n">ai</span><span class="p">,</span> <span class="n">EVINTEN</span><span class="p">,</span> <span class="n">STATUS_INTS</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_interrupts</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="p">)</span> <span class="p">{</span>
	<span class="n">OUT4500</span><span class="p">(</span> <span class="n">ai</span><span class="p">,</span> <span class="n">EVINTEN</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpi_receive_802_3</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RxFid</span> <span class="n">rxd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">MICBuffer</span> <span class="n">micbuf</span><span class="p">;</span>

	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxd</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_ram_off</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxd</span><span class="p">));</span>
	<span class="cm">/* Make sure we got something */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="p">.</span><span class="n">rdy</span> <span class="o">&amp;&amp;</span> <span class="n">rxd</span><span class="p">.</span><span class="n">valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">rxd</span><span class="p">.</span><span class="n">len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">badrx</span><span class="p">;</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">badrx</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_host_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">micbuf</span><span class="p">,</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_host_addr</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">micbuf</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ntohs</span><span class="p">(</span><span class="n">micbuf</span><span class="p">.</span><span class="n">typelen</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mh">0x05DC</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">micbuf</span><span class="p">)</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">badmic</span><span class="p">;</span>

				<span class="n">off</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">micbuf</span><span class="p">);</span>
				<span class="n">skb_trim</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">off</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_host_addr</span> <span class="o">+</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span>
			<span class="n">len</span> <span class="o">-</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">off</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">decapsulate</span> <span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">micbuf</span><span class="p">,</span> <span class="p">(</span><span class="n">etherHead</span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">off</span> <span class="o">-</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
<span class="nl">badmic:</span>
			<span class="n">dev_kfree_skb_irq</span> <span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">badrx</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#ifdef WIRELESS_SPY</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">wstats</span><span class="p">;</span>
			<span class="cm">/* Prepare spy data : addr + qual */</span>
			<span class="n">sa</span> <span class="o">=</span> <span class="n">buffer</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
			<span class="n">wstats</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* XXX Where do I get that info from ??? */</span>
			<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">wstats</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* Update spy records */</span>
			<span class="n">wireless_spy_update</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wstats</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* WIRELESS_SPY */</span><span class="cp"></span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">badrx:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="p">.</span><span class="n">valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxd</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rxd</span><span class="p">.</span><span class="n">rdy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rxd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">PKTSIZE</span><span class="p">;</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_ram_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxd</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpi_receive_802_11</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">RxFid</span> <span class="n">rxd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">hdrlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rx_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">gap</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">virtual_host_addr</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxd</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_ram_off</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxd</span><span class="p">));</span>
	<span class="n">memcpy</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
	<span class="cm">/* Bad CRC. Ignore packet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">hdr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">AIRO_DEF_MTU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Bad size %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">badrx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">badrx</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">get_unaligned</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">header_len</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span> <span class="n">len</span> <span class="o">+</span> <span class="n">hdrlen</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">skb</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">badrx</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="o">*</span><span class="p">)</span><span class="n">skb_put</span> <span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="n">memcpy</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">==</span> <span class="mi">24</span><span class="p">)</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">gap</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gap</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gap</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">gap</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			    <span class="s">&quot;gaplen too big. Problems will follow...&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">memcpy</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
<span class="cp">#ifdef IW_WIRELESS_SPY	  </span><span class="cm">/* defined in iw_handler.h */</span><span class="cp"></span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">.</span><span class="n">spy_number</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">sa</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">iw_quality</span> <span class="n">wstats</span><span class="p">;</span>
		<span class="cm">/* Prepare spy data : addr + qual */</span>
		<span class="n">sa</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">.</span><span class="n">rssi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">)</span>
			<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">[</span><span class="n">hdr</span><span class="p">.</span><span class="n">rssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]].</span><span class="n">rssidBm</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">wstats</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="p">.</span><span class="n">rssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">321</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span><span class="p">;</span>
		<span class="n">wstats</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_QUAL_UPDATED</span>
			<span class="o">|</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span>
			<span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="cm">/* Update spy records */</span>
		<span class="n">wireless_spy_update</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wstats</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* IW_WIRELESS_SPY */</span><span class="cp"></span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_OTHERHOST</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">wifidev</span><span class="p">;</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_802_2</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">ip_summed</span> <span class="o">=</span> <span class="n">CHECKSUM_NONE</span><span class="p">;</span>
	<span class="n">netif_rx</span><span class="p">(</span> <span class="n">skb</span> <span class="p">);</span>

<span class="nl">badrx:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxd</span><span class="p">.</span><span class="n">valid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rxd</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rxd</span><span class="p">.</span><span class="n">rdy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rxd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">PKTSIZE</span><span class="p">;</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rxfids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">card_ram_off</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxd</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">setup_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">SsidRid</span> <span class="n">mySsid</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">lastindex</span><span class="p">;</span>
	<span class="n">WepKeyRid</span> <span class="n">wkr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">mySsid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">mySsid</span> <span class="p">)</span> <span class="p">);</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">);</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">flash</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* The NOP is the first step in getting the card going */</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">NOP</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">parm1</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">.</span><span class="n">parm2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span> <span class="o">&amp;&amp;</span> <span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">issuecommand</span><span class="p">(</span> <span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">disable_MAC</span><span class="p">(</span> <span class="n">ai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-25"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-25">&#182;</a></div><p>Let's figure out if we need to use the AUX port</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_ENABLEAUX</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
				<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Error checking for AUX port&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aux_bap</span> <span class="o">||</span> <span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bap_read</span> <span class="o">=</span> <span class="n">fast_bap_read</span><span class="p">;</span>
			<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Doing fast bap_reads&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">bap_read</span> <span class="o">=</span> <span class="n">aux_bap_read</span><span class="p">;</span>
			<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Doing AUX bap_reads&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">tdsRssiRid</span> <span class="n">rssi_rid</span><span class="p">;</span>
		<span class="n">CapabilityRid</span> <span class="n">cap_rid</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span><span class="p">);</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">);</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-26"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-26">&#182;</a></div><p>general configuration (read/modify/write)</p></td><td class="code"><div class="highlight"><pre>		<span class="n">status</span> <span class="o">=</span> <span class="n">readConfigRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">readCapabilityRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">RID_RSSI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">rssi_rid</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">rssi_rid</span><span class="p">),</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">==</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">||</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rssi_rid</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span> <span class="cm">/* Skip RID length member */</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softCap</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">8</span><span class="p">))</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">|=</span> <span class="n">RXMODE_NORMALIZED_RSSI</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">airo_print_warn</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;unknown received signal &quot;</span>
						<span class="s">&quot;level scale&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">=</span> <span class="n">adhoc</span> <span class="o">?</span> <span class="n">MODE_STA_IBSS</span> <span class="o">:</span> <span class="n">MODE_STA_ESS</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_OPEN</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">MOD_CCK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">extSoftCap</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="n">micsetup</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_MIC</span><span class="p">;</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_MIC_CAPABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Save off the MAC */</span>
		<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">mac</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">macAddr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="cm">/* Check to see if there are any insmod configured</span>
<span class="cm">		   rates to add */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">));</span>
			<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Setup the SSIDs if present */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">mySsid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mySsid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span> <span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mySsid</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mySsid</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">writeConfigRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>

	<span class="cm">/* Set up the SSID list */</span>
	<span class="k">if</span> <span class="p">(</span> <span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">writeSsidRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mySsid</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">SUCCESS</span> <span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>

	<span class="cm">/* Grab the initial wep key, we gotta save it for auto_wep */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">readWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">lastindex</span> <span class="o">=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">defindex</span> <span class="o">=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">readWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">lastindex</span> <span class="o">!=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">);</span>

	<span class="n">try_auto_wep</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">issuecommand</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">Cmd</span> <span class="o">*</span><span class="n">pCmd</span><span class="p">,</span> <span class="n">Resp</span> <span class="o">*</span><span class="n">pRsp</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-27"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-27">&#182;</a></div><p>Im really paranoid about letting it run forever!</p></td><td class="code"><div class="highlight"><pre>	<span class="kt">int</span> <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">600000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EV_CMD</span><span class="p">)</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_CMD</span><span class="p">);</span>

	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">PARAM0</span><span class="p">,</span> <span class="n">pCmd</span><span class="o">-&gt;</span><span class="n">parm0</span><span class="p">);</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">PARAM1</span><span class="p">,</span> <span class="n">pCmd</span><span class="o">-&gt;</span><span class="n">parm1</span><span class="p">);</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">PARAM2</span><span class="p">,</span> <span class="n">pCmd</span><span class="o">-&gt;</span><span class="n">parm2</span><span class="p">);</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span> <span class="n">pCmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">max_tries</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EV_CMD</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">))</span> <span class="o">==</span> <span class="n">pCmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-28"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-28">&#182;</a></div><p>PC4500 didn't notice command, try again</p></td><td class="code"><div class="highlight"><pre>			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span> <span class="n">pCmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">in_atomic</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">max_tries</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span> <span class="n">max_tries</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="s">&quot;Max tries exceeded when issuing command&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">COMMAND_BUSY</span><span class="p">)</span>
			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_CLEARCOMMANDBUSY</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-29"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-29">&#182;</a></div><p>command completed</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">STATUS</span><span class="p">);</span>
	<span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">rsp0</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RESP0</span><span class="p">);</span>
	<span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">rsp1</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RESP1</span><span class="p">);</span>
	<span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">rsp2</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">RESP2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span><span class="o">!=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pCmd</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">CMD_SOFTRESET</span><span class="p">)</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="s">&quot;cmd:%x status:%x rsp0:%x rsp1:%x rsp2:%x&quot;</span><span class="p">,</span>
			<span class="n">pCmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">rsp0</span><span class="p">,</span> <span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">rsp1</span><span class="p">,</span>
			<span class="n">pRsp</span><span class="o">-&gt;</span><span class="n">rsp2</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-30"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-30">&#182;</a></div><p>clear stuck command busy if necessary</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">COMMAND_BUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_CLEARCOMMANDBUSY</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-31"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-31">&#182;</a></div><p>acknowledge processing the status/response</p></td><td class="code"><div class="highlight"><pre>	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_CMD</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sets up the bap to start exchange data.  whichbap should</span>
<span class="cm"> * be one of the BAP0 or BAP1 defines.  Locks should be held before</span>
<span class="cm"> * calling! */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bap_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whichbap</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_tries</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SELECT0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span> <span class="n">rid</span><span class="p">);</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">OFFSET0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">OFFSET0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAP_BUSY</span><span class="p">)</span> <span class="p">{</span>
                        <span class="cm">/* This isn&#39;t really a timeout, but its kinda</span>
<span class="cm">			   close */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAP_ERR</span> <span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* invalid rid or offset */</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;BAP error %x %d&quot;</span><span class="p">,</span>
				<span class="n">status</span><span class="p">,</span> <span class="n">whichbap</span> <span class="p">);</span>
			<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BAP_DONE</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// success</span>
			<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">max_tries</span><span class="o">--</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="s">&quot;BAP setup error too many retries</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-32"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-32">&#182;</a></div><p>-- PC4500 missed it, try again</p></td><td class="code"><div class="highlight"><pre>		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SELECT0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span> <span class="n">rid</span><span class="p">);</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">OFFSET0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* should only be called by aux_bap_read.  This aux function and the</span>
<span class="cm">   following use concepts not documented in the developers guide.  I</span>
<span class="cm">   got them from a patch given to my by Aironet */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">aux_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">page</span><span class="p">,</span>
		     <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">next</span><span class="p">;</span>

	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">AUXPAGE</span><span class="p">,</span> <span class="n">page</span><span class="p">);</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">AUXOFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">AUXDATA</span><span class="p">);</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">AUXDATA</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">AUXOFF</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">next</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* requires call to bap_setup() first */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">aux_bap_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pu16Dst</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">bytelen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whichbap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">page</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">words</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">aux_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SWS0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">);</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SWS2</span><span class="o">+</span><span class="n">whichbap</span><span class="p">);</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">aux_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">words</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytelen</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">words</span><span class="p">;)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">words</span><span class="o">-</span><span class="n">i</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">len</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">words</span><span class="o">-</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">do8bitIO</span> <span class="p">)</span>
			<span class="n">insw</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATA0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span>
			      <span class="n">pu16Dst</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">count</span> <span class="p">);</span>
		<span class="k">else</span>
			<span class="n">insb</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATA0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span>
			      <span class="n">pu16Dst</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">count</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">words</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">aux_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">aux_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* requires call to bap_setup() first */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fast_bap_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pu16Dst</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">bytelen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whichbap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bytelen</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// round up to even value</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">do8bitIO</span> <span class="p">)</span>
		<span class="n">insw</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATA0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span> <span class="n">pu16Dst</span><span class="p">,</span> <span class="n">bytelen</span><span class="o">&gt;&gt;</span><span class="mi">1</span> <span class="p">);</span>
	<span class="k">else</span>
		<span class="n">insb</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATA0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span> <span class="n">pu16Dst</span><span class="p">,</span> <span class="n">bytelen</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* requires call to bap_setup() first */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bap_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="k">const</span> <span class="n">__le16</span> <span class="o">*</span><span class="n">pu16Src</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">bytelen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">whichbap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bytelen</span> <span class="o">=</span> <span class="p">(</span><span class="n">bytelen</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// round up to even value</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">do8bitIO</span> <span class="p">)</span>
		<span class="n">outsw</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATA0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span>
		       <span class="n">pu16Src</span><span class="p">,</span> <span class="n">bytelen</span><span class="o">&gt;&gt;</span><span class="mi">1</span> <span class="p">);</span>
	<span class="k">else</span>
		<span class="n">outsb</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">DATA0</span><span class="o">+</span><span class="n">whichbap</span><span class="p">,</span> <span class="n">pu16Src</span><span class="p">,</span> <span class="n">bytelen</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">PC4500_accessrid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">accmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span> <span class="cm">/* for issuing commands */</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span> <span class="cm">/* response from commands */</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">accmd</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">rid</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x7F00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">accmd</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rsp</span><span class="p">.</span><span class="n">rsp0</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Note, that we are using BAP1 which is also used by transmit, so</span>
<span class="cm"> *  we must get a lock. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">PC4500_readrid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pBuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">RIDSIZE</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">rid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">host_addr</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">ridbus</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_ACCESS</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">rid</span><span class="p">;</span>

		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">card_ram_off</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Rid</span><span class="p">));</span>

		<span class="n">rc</span> <span class="o">=</span> <span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x7f00</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">.</span><span class="n">rsp0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">pBuf</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">virtual_host_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">PC4500_accessrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">CMD_ACCESS</span><span class="p">))</span><span class="o">!=</span><span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
	                <span class="n">rc</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	        <span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
	                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	        <span class="p">}</span></pre></div></td></tr>


<tr id="section-33"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-33">&#182;</a></div><p>read the rid length field</p></td><td class="code"><div class="highlight"><pre>		<span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">pBuf</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-34"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-34">&#182;</a></div><p>length for remaining part of rid</p></td><td class="code"><div class="highlight"><pre>		<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">pBuf</span><span class="p">))</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span> <span class="n">len</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="s">&quot;Rid %x has a length of %d which is too short&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">rid</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">len</span> <span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
	                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span></pre></div></td></tr>


<tr id="section-35"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-35">&#182;</a></div><p>read remainder of the rid</p></td><td class="code"><div class="highlight"><pre>		<span class="n">rc</span> <span class="o">=</span> <span class="n">bap_read</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">((</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">pBuf</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*  Note, that we are using BAP1 which is also used by transmit, so</span>
<span class="cm"> *  make sure this isn&#39;t called when a transmit is happening */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">PC4500_writerid</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">pBuf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">SUCCESS</span><span class="p">;</span>

	<span class="o">*</span><span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">pBuf</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">RID_WEP_TEMP</span> <span class="o">!=</span> <span class="n">rid</span><span class="p">))</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="s">&quot;%s: MAC should be disabled (rid=%04x)&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">rid</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">));</span>

		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">pBuf</span><span class="p">);</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">.</span><span class="n">rid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_WRITERID</span><span class="p">;</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">rid</span><span class="p">;</span>

		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">card_ram_off</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">rid_desc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Rid</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">2047</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s: len=%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config_desc</span><span class="p">.</span><span class="n">virtual_host_addr</span><span class="p">,</span>
				<span class="n">pBuf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">rc</span> <span class="o">=</span> <span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s: Write rid Error %d&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;%s: Cmd=%04x&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x7f00</span><span class="p">))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="n">rsp</span><span class="p">.</span><span class="n">rsp0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-36"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-36">&#182;</a></div><p>--- first access so that we can write the rid data</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">status</span> <span class="o">=</span> <span class="n">PC4500_accessrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">CMD_ACCESS</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	                <span class="n">rc</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
	                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	        <span class="p">}</span></pre></div></td></tr>


<tr id="section-37"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-37">&#182;</a></div><p>--- now write the rid data</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
	                <span class="n">rc</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
	                <span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	        <span class="p">}</span>
		<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">pBuf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-38"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-38">&#182;</a></div><p>---now commit the rid data</p></td><td class="code"><div class="highlight"><pre>		<span class="n">rc</span> <span class="o">=</span> <span class="n">PC4500_accessrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="mh">0x100</span><span class="o">|</span><span class="n">CMD_ACCESS</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Allocates a FID to be used for transmitting packets.  We only use</span>
<span class="cm">   one for now. */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">transmit_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lenPayload</span><span class="p">,</span> <span class="kt">int</span> <span class="n">raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">;</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txFid</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">txControl</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_ALLOCATETX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">lenPayload</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txFid</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txFid</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* wait for the allocate event/indication</span>
<span class="cm">	 * It makes me kind of nervous that this can just sit here and spin,</span>
<span class="cm">	 * but in practice it only loops like four times. */</span>
	<span class="k">while</span> <span class="p">(((</span><span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EV_ALLOC</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">loop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txFid</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-39"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-39">&#182;</a></div><p>get the allocated fid and acknowledge</p></td><td class="code"><div class="highlight"><pre>	<span class="n">txFid</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">TXALLOCFID</span><span class="p">);</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_ALLOC</span><span class="p">);</span>

	<span class="cm">/*  The CARD is pretty cool since it converts the ethernet packet</span>
<span class="cm">	 *  into 802.11.  Also note that we don&#39;t release the FID since we</span>
<span class="cm">	 *  will be using the same one over and over again. */</span>
	<span class="cm">/*  We only have to setup the control once since we are not</span>
<span class="cm">	 *  releasing the fid. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raw</span><span class="p">)</span>
		<span class="n">txControl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TXCTL_TXOK</span> <span class="o">|</span> <span class="n">TXCTL_TXEX</span> <span class="o">|</span> <span class="n">TXCTL_802_11</span>
			<span class="o">|</span> <span class="n">TXCTL_ETHERNET</span> <span class="o">|</span> <span class="n">TXCTL_NORELEASE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">txControl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">TXCTL_TXOK</span> <span class="o">|</span> <span class="n">TXCTL_TXEX</span> <span class="o">|</span> <span class="n">TXCTL_802_3</span>
			<span class="o">|</span> <span class="n">TXCTL_ETHERNET</span> <span class="o">|</span> <span class="n">TXCTL_NORELEASE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">txFid</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
		<span class="n">txFid</span> <span class="o">=</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">txControl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txControl</span><span class="p">),</span> <span class="n">BAP1</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">txFid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* In general BAP1 is dedicated to transmiting packets.  However,</span>
<span class="cm">   since we need a BAP when accessing RIDs, we also use BAP1 for that.</span>
<span class="cm">   Make sure the BAP1 spinlock is held when this is called. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">transmit_802_3_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pPacket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">payloadLen</span><span class="p">;</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">miclen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txFid</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">MICBuffer</span> <span class="n">pMic</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;=</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_warn</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Short packet %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MIC_CAPABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span> <span class="o">&amp;&amp;</span> 
	    <span class="p">(</span><span class="n">ntohs</span><span class="p">(((</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">pPacket</span><span class="p">)[</span><span class="mi">6</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0x888E</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">encapsulate</span><span class="p">(</span><span class="n">ai</span><span class="p">,(</span><span class="n">etherHead</span> <span class="o">*</span><span class="p">)</span><span class="n">pPacket</span><span class="p">,</span><span class="o">&amp;</span><span class="n">pMic</span><span class="p">,</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
		<span class="n">miclen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pMic</span><span class="p">);</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-40"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-40">&#182;</a></div><p>packet is destination[6], source[6], payload[len-12]
write the payload length and dst/src/payload</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">txFid</span><span class="p">,</span> <span class="mh">0x0036</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="cm">/* The hardware addresses aren&#39;t counted as part of the payload, so</span>
<span class="cm">	 * we have to subtract the 12 bytes for the addresses off */</span>
	<span class="n">payloadLen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="n">miclen</span><span class="p">);</span>
	<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payloadLen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payloadLen</span><span class="p">),</span><span class="n">BAP1</span><span class="p">);</span>
	<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">pPacket</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">),</span> <span class="n">BAP1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">miclen</span><span class="p">)</span>
		<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pMic</span><span class="p">,</span> <span class="n">miclen</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">);</span>
	<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)(</span><span class="n">pPacket</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">etherHead</span><span class="p">)),</span> <span class="n">len</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-41"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-41">&#182;</a></div><p>issue the transmit command</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">cmd</span> <span class="p">)</span> <span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_TRANSMIT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">txFid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">transmit_802_11_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pPacket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">,</span> <span class="n">payloadLen</span><span class="p">;</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hdrlen</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u8</span> <span class="n">tail</span><span class="p">[(</span><span class="mi">30</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">30</span><span class="o">-</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">};</span>
	<span class="cm">/* padding of header to full size + le16 gaplen (6) + gaplen bytes */</span>
	<span class="n">u16</span> <span class="n">txFid</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">pPacket</span><span class="p">;</span>
	<span class="n">hdrlen</span> <span class="o">=</span> <span class="n">header_len</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">hdrlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_warn</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Short packet %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* packet is 802.11 header +  payload</span>
<span class="cm">	 * write the payload length and dst/src/payload */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">txFid</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="cm">/* The 802.11 header aren&#39;t counted as part of the payload, so</span>
<span class="cm">	 * we have to subtract the header bytes off */</span>
	<span class="n">payloadLen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="o">-</span><span class="n">hdrlen</span><span class="p">);</span>
	<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">payloadLen</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">payloadLen</span><span class="p">),</span><span class="n">BAP1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bap_setup</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">txFid</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">pPacket</span><span class="p">,</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">);</span>
	<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">tail</span> <span class="o">+</span> <span class="p">(</span><span class="n">hdrlen</span> <span class="o">-</span> <span class="mi">10</span><span class="p">)),</span> <span class="mi">38</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">);</span>

	<span class="n">bap_write</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">pPacket</span> <span class="o">+</span> <span class="n">hdrlen</span><span class="p">),</span> <span class="n">len</span> <span class="o">-</span> <span class="n">hdrlen</span><span class="p">,</span> <span class="n">BAP1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-42"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-42">&#182;</a></div><p>issue the transmit command</p></td><td class="code"><div class="highlight"><pre>	<span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">cmd</span> <span class="p">)</span> <span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">CMD_TRANSMIT</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">parm0</span> <span class="o">=</span> <span class="n">txFid</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">rsp</span><span class="p">.</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">ERROR</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">SUCCESS</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  This is the proc_fs routines.  It is a bit messier than I would</span>
<span class="cm"> *  like!  Feel free to clean it up!</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">proc_read</span><span class="p">(</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			  <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">proc_write</span><span class="p">(</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			   <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_close</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_stats_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_statsdelta_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_status_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_SSID_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_APList_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_BSSList_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_config_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_wepkey_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_statsdelta_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_statsdelta_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">proc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_stats_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_stats_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">proc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_status_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_status_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">proc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_SSID_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">proc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_SSID_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">proc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_BSSList_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">proc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_BSSList_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">proc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_APList_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">proc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_APList_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">proc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_config_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">proc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_config_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">proc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">proc_wepkey_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">proc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">proc_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">proc_wepkey_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">proc_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">airo_entry</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">proc_data</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">release_buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">readlen</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">rbuffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">writelen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxwritelen</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">wbuffer</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">on_close</span><span class="p">)</span> <span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_proc_entry</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">apriv</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="cm">/* First setup the device directory */</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_name</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span> <span class="o">=</span> <span class="n">proc_mkdir_mode</span><span class="p">(</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_name</span><span class="p">,</span> <span class="n">airo_perm</span><span class="p">,</span>
					    <span class="n">airo_entry</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="cm">/* Setup the StatsDelta */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;StatsDelta&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">&amp;</span> <span class="n">proc_perm</span><span class="p">,</span>
				 <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_statsdelta_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_stats_delta</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="cm">/* Setup the Stats */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;Stats&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">&amp;</span> <span class="n">proc_perm</span><span class="p">,</span>
				 <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_stats_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_stats</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="cm">/* Setup the Status */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;Status&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">&amp;</span> <span class="n">proc_perm</span><span class="p">,</span>
				 <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_status_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_status</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="cm">/* Setup the Config */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;Config&quot;</span><span class="p">,</span> <span class="n">proc_perm</span><span class="p">,</span>
				 <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_config_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_config</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="cm">/* Setup the SSID */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;SSID&quot;</span><span class="p">,</span> <span class="n">proc_perm</span><span class="p">,</span>
				 <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_SSID_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_ssid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="cm">/* Setup the APList */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;APList&quot;</span><span class="p">,</span> <span class="n">proc_perm</span><span class="p">,</span>
				 <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_APList_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_aplist</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="cm">/* Setup the BSSList */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;BSSList&quot;</span><span class="p">,</span> <span class="n">proc_perm</span><span class="p">,</span>
				 <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_BSSList_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_bsslist</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="cm">/* Setup the WepKey */</span>
	<span class="n">entry</span> <span class="o">=</span> <span class="n">proc_create_data</span><span class="p">(</span><span class="s">&quot;WepKey&quot;</span><span class="p">,</span> <span class="n">proc_perm</span><span class="p">,</span>
				 <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">proc_wepkey_ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail_wepkey</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
	<span class="n">entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_wepkey:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;BSSList&quot;</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
<span class="nl">fail_bsslist:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;APList&quot;</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
<span class="nl">fail_aplist:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;SSID&quot;</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
<span class="nl">fail_ssid:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;Config&quot;</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
<span class="nl">fail_config:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;Status&quot;</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
<span class="nl">fail_status:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;Stats&quot;</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
<span class="nl">fail_stats:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;StatsDelta&quot;</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
<span class="nl">fail_stats_delta:</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_name</span><span class="p">,</span> <span class="n">airo_entry</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">takedown_proc_entry</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">apriv</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="o">-&gt;</span><span class="n">namelen</span> <span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;Stats&quot;</span><span class="p">,</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;StatsDelta&quot;</span><span class="p">,</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;Status&quot;</span><span class="p">,</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;Config&quot;</span><span class="p">,</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;SSID&quot;</span><span class="p">,</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;APList&quot;</span><span class="p">,</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;BSSList&quot;</span><span class="p">,</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;WepKey&quot;</span><span class="p">,</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_entry</span><span class="p">);</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">proc_name</span><span class="p">,</span><span class="n">airo_entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  What we want from the proc_fs is to be able to efficiently read</span>
<span class="cm"> *  and write the configuration.  To do this, we want to read the</span>
<span class="cm"> *  configuration when the file is opened and write it when the file is</span>
<span class="cm"> *  closed.  So basically we allocate a read buffer at open and fill it</span>
<span class="cm"> *  with data, and allocate a write buffer and read it at close.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> *  The read routine is generic, it relies on the preallocated rbuffer</span>
<span class="cm"> *  to supply the data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">proc_read</span><span class="p">(</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			  <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">readlen</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *  The write routine is generic, it fills in a preallocated rbuffer</span>
<span class="cm"> *  to supply the data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">proc_write</span><span class="p">(</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
			   <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
			   <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_write_to_buffer</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">maxwritelen</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span>
					<span class="n">buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">writelen</span><span class="p">,</span> <span class="o">*</span><span class="n">offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_status_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">apriv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">CapabilityRid</span> <span class="n">cap_rid</span><span class="p">;</span>
	<span class="n">StatusRid</span> <span class="n">status_rid</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_data</span> <span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">readStatusRid</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">readCapabilityRid</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>

        <span class="n">i</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">,</span> <span class="s">&quot;Status: %s%s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;CFG &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot;ACT &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x10</span> <span class="o">?</span> <span class="s">&quot;SYN &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x20</span> <span class="o">?</span> <span class="s">&quot;LNK &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x40</span> <span class="o">?</span> <span class="s">&quot;LEAP &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">?</span> <span class="s">&quot;PRIV &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x100</span> <span class="o">?</span> <span class="s">&quot;KEY &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x200</span> <span class="o">?</span> <span class="s">&quot;WEP &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
                    <span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x8000</span> <span class="o">?</span> <span class="s">&quot;ERR &quot;</span><span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;Mode: %x</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Signal Strength: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Signal Quality: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;SSID: %-.*s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;AP: %-.16s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Freq: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;BitRate: %dmbs</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Driver Version: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Device: %s</span><span class="se">\n</span><span class="s">Manufacturer: %s</span><span class="se">\n</span><span class="s">Firmware Version: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Radio type: %x</span><span class="se">\n</span><span class="s">Country: %x</span><span class="se">\n</span><span class="s">Hardware Version: %x</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Software Version: %x</span><span class="se">\n</span><span class="s">Software Subversion: %x</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Boot block version: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">mode</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">normalizedSignalStrength</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">signalQuality</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">SSIDlen</span><span class="p">),</span>
		 <span class="n">status_rid</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span>
		 <span class="n">status_rid</span><span class="p">.</span><span class="n">apName</span><span class="p">,</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">channel</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">currentXmitRate</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
		 <span class="n">version</span><span class="p">,</span>
		 <span class="n">cap_rid</span><span class="p">.</span><span class="n">prodName</span><span class="p">,</span>
		 <span class="n">cap_rid</span><span class="p">.</span><span class="n">manName</span><span class="p">,</span>
		 <span class="n">cap_rid</span><span class="p">.</span><span class="n">prodVer</span><span class="p">,</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">radioType</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">country</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">hardVer</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softVer</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softSubVer</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">bootBlockVer</span><span class="p">));</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">proc_stats_rid_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span><span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span><span class="o">*</span><span class="p">,</span> <span class="n">u16</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_statsdelta_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span><span class="o">&amp;</span><span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">proc_stats_rid_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">RID_STATSDELTACLEAR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">proc_stats_rid_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">RID_STATSDELTA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_stats_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="n">proc_stats_rid_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">RID_STATS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_stats_rid_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">rid</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">apriv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">StatsRid</span> <span class="n">stats</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">vals</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">vals</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_data</span> <span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span> <span class="mi">4096</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">readStatsRid</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">statsLabels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="o">&lt;</span><span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">statsLabels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="n">strlen</span><span class="p">(</span><span class="n">statsLabels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;</span><span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">airo_print_warn</span><span class="p">(</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="s">&quot;Potentially disastrous buffer overflow averted!&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">j</span><span class="o">+=</span><span class="n">sprintf</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="s">&quot;%s: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">statsLabels</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">4</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_warn</span><span class="p">(</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Got a short rid&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_dec_u16</span><span class="p">(</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">start</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span> <span class="p">)</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">*</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="o">*</span><span class="n">start</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span>
			<span class="n">buffer</span><span class="p">[</span><span class="o">*</span><span class="n">start</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;9&#39;</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span><span class="n">start</span><span class="p">)</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">*=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="o">*</span><span class="n">start</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">valid</span> <span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">airo_config_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">zwrq</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">);</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">sniffing_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">RXMODE_MASK</span><span class="p">))</span> <span class="o">&gt;=</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">RXMODE_RFMON</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_config_on_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">line</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">line</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
<span class="cm">/*** Mode processing */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;Mode: &quot;</span><span class="p">,</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">line</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sniffing_mode</span><span class="p">(</span><span class="n">ai</span><span class="p">))</span>
				<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_FULL_MASK</span><span class="p">;</span>
			<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MODE_CFG_MASK</span><span class="p">;</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">scanMode</span> <span class="o">=</span> <span class="n">SCANMODE_ACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;a&#39;</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_STA_IBSS</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_STA_ESS</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;r&#39;</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">|=</span> <span class="n">RXMODE_RFMON</span> <span class="o">|</span> <span class="n">RXMODE_DISABLE_802_3_HEADER</span><span class="p">;</span>
					<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">scanMode</span> <span class="o">=</span> <span class="n">SCANMODE_PASSIVE</span><span class="p">;</span>
					<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;y&#39;</span> <span class="p">)</span> <span class="p">{</span>
					<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">|=</span> <span class="n">RXMODE_RFMON_ANYBSS</span> <span class="o">|</span> <span class="n">RXMODE_DISABLE_802_3_HEADER</span><span class="p">;</span>
					<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">scanMode</span> <span class="o">=</span> <span class="n">SCANMODE_PASSIVE</span><span class="p">;</span>
					<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span> <span class="p">)</span>
					<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">|=</span> <span class="n">RXMODE_LANMON</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cm">/*** Radio status */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;Radio: &quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">line</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span><span class="s">&quot;off&quot;</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_RADIO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_RADIO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
<span class="cm">/*** NodeName processing */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;NodeName: &quot;</span><span class="p">,</span> <span class="mi">10</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

			<span class="n">line</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span> <span class="p">);</span>
<span class="cm">/* Do the name, assume a space between the mode and node name */</span>
			<span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">nodeName</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

<span class="cm">/*** PowerMode processing */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;PowerMode: &quot;</span><span class="p">,</span> <span class="mi">11</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">line</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;PSPCAM&quot;</span><span class="p">,</span> <span class="mi">6</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">=</span> <span class="n">POWERSAVE_PSPCAM</span><span class="p">;</span>
				<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;PSP&quot;</span><span class="p">,</span> <span class="mi">3</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">=</span> <span class="n">POWERSAVE_PSP</span><span class="p">;</span>
				<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">=</span> <span class="n">POWERSAVE_CAM</span><span class="p">;</span>
				<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;DataRates: &quot;</span><span class="p">,</span> <span class="mi">11</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* i is index into line,</span>
<span class="cm">						k is index to rates */</span>

			<span class="n">line</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="k">while</span><span class="p">((</span><span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">!=-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">v</span><span class="p">;</span>
				<span class="n">line</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;Channel: &quot;</span><span class="p">,</span> <span class="mi">9</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">line</span> <span class="o">+=</span> <span class="mi">9</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">v</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">channelSet</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
				<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;XmitPower: &quot;</span><span class="p">,</span> <span class="mi">11</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">line</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span> <span class="n">v</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txPower</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
				<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;WEP: &quot;</span><span class="p">,</span> <span class="mi">5</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">line</span> <span class="o">+=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">switch</span><span class="p">(</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;s&#39;</span>:
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_SHAREDKEY</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;e&#39;</span>:
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_ENCRYPT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_OPEN</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;LongRetryLimit: &quot;</span><span class="p">,</span> <span class="mi">16</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">line</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">((</span><span class="n">v</span><span class="o">&gt;</span><span class="mi">255</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="n">v</span><span class="p">);</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">longRetryLimit</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;ShortRetryLimit: &quot;</span><span class="p">,</span> <span class="mi">17</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">line</span> <span class="o">+=</span> <span class="mi">17</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">((</span><span class="n">v</span><span class="o">&gt;</span><span class="mi">255</span><span class="p">)</span> <span class="o">?</span> <span class="mi">255</span> <span class="o">:</span> <span class="n">v</span><span class="p">);</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">shortRetryLimit</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;RTSThreshold: &quot;</span><span class="p">,</span> <span class="mi">14</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">line</span> <span class="o">+=</span> <span class="mi">14</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">((</span><span class="n">v</span><span class="o">&gt;</span><span class="n">AIRO_DEF_MTU</span><span class="p">)</span> <span class="o">?</span> <span class="n">AIRO_DEF_MTU</span> <span class="o">:</span> <span class="n">v</span><span class="p">);</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rtsThres</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;TXMSDULifetime: &quot;</span><span class="p">,</span> <span class="mi">16</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">line</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">v</span><span class="p">;</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txLifetime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;RXMSDULifetime: &quot;</span><span class="p">,</span> <span class="mi">16</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">line</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">v</span><span class="p">;</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rxLifetime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;TXDiversity: &quot;</span><span class="p">,</span> <span class="mi">13</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txDiversity</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;l&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
				<span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;r&#39;</span><span class="p">)</span><span class="o">?</span> <span class="mi">2</span><span class="o">:</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;RXDiversity: &quot;</span><span class="p">,</span> <span class="mi">13</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rxDiversity</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;l&#39;</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span>
				<span class="p">((</span><span class="n">line</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span><span class="o">==</span><span class="sc">&#39;r&#39;</span><span class="p">)</span><span class="o">?</span> <span class="mi">2</span><span class="o">:</span> <span class="mi">3</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span> <span class="n">line</span><span class="p">,</span> <span class="s">&quot;FragThreshold: &quot;</span><span class="p">,</span> <span class="mi">15</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">line</span> <span class="o">+=</span> <span class="mi">15</span><span class="p">;</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">get_dec_u16</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">)</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="p">((</span><span class="n">v</span><span class="o">&gt;</span><span class="n">AIRO_DEF_MTU</span><span class="p">)</span> <span class="o">?</span> <span class="n">AIRO_DEF_MTU</span> <span class="o">:</span> <span class="n">v</span><span class="p">);</span>
			<span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">;</span> <span class="cm">/* Make sure its even */</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fragThresh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;Modulation: &quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">line</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;d&#39;</span>:  <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">modulation</span><span class="o">=</span><span class="n">MOD_DEFAULT</span><span class="p">;</span> <span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;c&#39;</span>:  <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">modulation</span><span class="o">=</span><span class="n">MOD_CCK</span><span class="p">;</span> <span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;m&#39;</span>:  <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">modulation</span><span class="o">=</span><span class="n">MOD_MOK</span><span class="p">;</span> <span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="n">airo_print_warn</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Unknown modulation&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;Preamble: &quot;</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">line</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="sc">&#39;a&#39;</span>: <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">preamble</span><span class="o">=</span><span class="n">PREAMBLE_AUTO</span><span class="p">;</span> <span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;l&#39;</span>: <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">preamble</span><span class="o">=</span><span class="n">PREAMBLE_LONG</span><span class="p">;</span> <span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="sc">&#39;s&#39;</span>: <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">preamble</span><span class="o">=</span><span class="n">PREAMBLE_SHORT</span><span class="p">;</span> <span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span> <span class="n">airo_print_warn</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Unknown preamble&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">airo_print_warn</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Couldn&#39;t figure out %s&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">while</span><span class="p">(</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="p">)</span> <span class="n">line</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span> <span class="n">line</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">airo_config_commit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_rmode</span><span class="p">(</span><span class="n">__le16</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">RXMODE_MASK</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">RXMODE_RFMON</span>:  <span class="k">return</span> <span class="s">&quot;rfmon&quot;</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">RXMODE_RFMON_ANYBSS</span>:  <span class="k">return</span> <span class="s">&quot;yna (any) bss rfmon&quot;</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">RXMODE_LANMON</span>:  <span class="k">return</span> <span class="s">&quot;lanmon&quot;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="s">&quot;ESS&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_config_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_data</span> <span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span> <span class="mi">2048</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">maxwritelen</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">on_close</span> <span class="o">=</span> <span class="n">proc_config_on_close</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;</span> <span class="n">MODE_CFG_MASK</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">,</span>
		     <span class="s">&quot;Mode: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Radio: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;NodeName: %-16s</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;PowerMode: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;DataRates: %d %d %d %d %d %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;Channel: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		     <span class="s">&quot;XmitPower: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_STA_IBSS</span> <span class="o">?</span> <span class="s">&quot;adhoc&quot;</span> <span class="o">:</span>
		     <span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_STA_ESS</span> <span class="o">?</span> <span class="n">get_rmode</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span><span class="p">)</span><span class="o">:</span>
		     <span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_AP</span> <span class="o">?</span> <span class="s">&quot;AP&quot;</span> <span class="o">:</span>
		     <span class="n">mode</span> <span class="o">==</span> <span class="n">MODE_AP_RPTR</span> <span class="o">?</span> <span class="s">&quot;AP RPTR&quot;</span> <span class="o">:</span> <span class="s">&quot;Error&quot;</span><span class="p">,</span>
		     <span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_RADIO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;off&quot;</span> <span class="o">:</span> <span class="s">&quot;on&quot;</span><span class="p">,</span>
		     <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span>
		     <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">==</span> <span class="n">POWERSAVE_CAM</span> <span class="o">?</span> <span class="s">&quot;CAM&quot;</span> <span class="o">:</span>
		     <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">==</span> <span class="n">POWERSAVE_PSP</span> <span class="o">?</span> <span class="s">&quot;PSP&quot;</span> <span class="o">:</span>
		     <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">==</span> <span class="n">POWERSAVE_PSPCAM</span> <span class="o">?</span> <span class="s">&quot;PSPCAM&quot;</span> <span class="o">:</span>
		     <span class="s">&quot;Error&quot;</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
		     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">channelSet</span><span class="p">),</span>
		     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txPower</span><span class="p">)</span>
		<span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
		 <span class="s">&quot;LongRetryLimit: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;ShortRetryLimit: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;RTSThreshold: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;TXMSDULifetime: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;RXMSDULifetime: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;TXDiversity: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;RXDiversity: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;FragThreshold: %d</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;WEP: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Modulation: %s</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;Preamble: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">longRetryLimit</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">shortRetryLimit</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rtsThres</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txLifetime</span><span class="p">),</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rxLifetime</span><span class="p">),</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txDiversity</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;left&quot;</span> <span class="o">:</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txDiversity</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot;right&quot;</span> <span class="o">:</span> <span class="s">&quot;both&quot;</span><span class="p">,</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rxDiversity</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;left&quot;</span> <span class="o">:</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rxDiversity</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="s">&quot;right&quot;</span> <span class="o">:</span> <span class="s">&quot;both&quot;</span><span class="p">,</span>
		 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fragThresh</span><span class="p">),</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">==</span> <span class="n">AUTH_ENCRYPT</span> <span class="o">?</span> <span class="s">&quot;encrypt&quot;</span> <span class="o">:</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">==</span> <span class="n">AUTH_SHAREDKEY</span> <span class="o">?</span> <span class="s">&quot;shared&quot;</span> <span class="o">:</span> <span class="s">&quot;open&quot;</span><span class="p">,</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">MOD_DEFAULT</span> <span class="o">?</span> <span class="s">&quot;default&quot;</span> <span class="o">:</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">MOD_CCK</span> <span class="o">?</span> <span class="s">&quot;cck&quot;</span> <span class="o">:</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">modulation</span> <span class="o">==</span> <span class="n">MOD_MOK</span> <span class="o">?</span> <span class="s">&quot;mok&quot;</span> <span class="o">:</span> <span class="s">&quot;error&quot;</span><span class="p">,</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">preamble</span> <span class="o">==</span> <span class="n">PREAMBLE_AUTO</span> <span class="o">?</span> <span class="s">&quot;auto&quot;</span> <span class="o">:</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">preamble</span> <span class="o">==</span> <span class="n">PREAMBLE_LONG</span> <span class="o">?</span> <span class="s">&quot;long&quot;</span> <span class="o">:</span>
		 <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">preamble</span> <span class="o">==</span> <span class="n">PREAMBLE_SHORT</span> <span class="o">?</span> <span class="s">&quot;short&quot;</span> <span class="o">:</span> <span class="s">&quot;error&quot;</span>
		<span class="p">);</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_SSID_on_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">SsidRid</span> <span class="n">SSID_rid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="o">*</span><span class="n">end</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span> <span class="cm">/* sentinel; we have space for it */</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SSID_rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* copy up to 32 characters from this line */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">[</span><span class="n">j</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
		<span class="cm">/* skip to the beginning of the next line */</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
			<span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="n">SSID_rid</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">));</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writeSsidRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SSID_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_APList_on_close</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">APListRid</span> <span class="n">APList_rid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">APList_rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">APList_rid</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">APList_rid</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">APList_rid</span><span class="p">));</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="o">*</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="mi">3</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span><span class="p">(</span><span class="n">j</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">APList_rid</span><span class="p">.</span><span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">/</span><span class="mi">3</span><span class="p">]</span><span class="o">=</span>
					<span class="n">hex_to_bin</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="mi">3</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">APList_rid</span><span class="p">.</span><span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="o">/</span><span class="mi">3</span><span class="p">]</span><span class="o">|=</span>
					<span class="n">hex_to_bin</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="mi">3</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writeAPListRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">APList_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function wraps PC4500_writerid with a MAC disable */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_writerid</span><span class="p">(</span> <span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rid_data</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dummy</span> <span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">PC4500_writerid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">rid</span><span class="p">,</span> <span class="n">rid_data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns the WEP key at the specified index, or -1 if that key does</span>
<span class="cm"> * not exist.  The buffer is assumed to be at least 16 bytes in length.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_wep_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WepKeyRid</span> <span class="n">wkr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">lastindex</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">readWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">lastindex</span> <span class="o">=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">)</span> <span class="o">==</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">klen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">klen</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">wkr</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">klen</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">klen</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">readWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">lastindex</span> <span class="o">!=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_wep_tx_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WepKeyRid</span> <span class="n">wkr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">lastindex</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">readWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">lastindex</span> <span class="o">=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">wkr</span><span class="p">.</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">readWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">lastindex</span> <span class="o">!=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_wep_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">keylen</span><span class="p">,</span> <span class="kt">int</span> <span class="n">perm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">macaddr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">WepKeyRid</span> <span class="n">wkr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">keylen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wkr</span><span class="p">));</span>
	<span class="n">wkr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wkr</span><span class="p">));</span>
	<span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">wkr</span><span class="p">.</span><span class="n">klen</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">keylen</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">keylen</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">mac</span><span class="p">,</span> <span class="n">macaddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">writeWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_wep_tx_idx</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="n">u16</span> <span class="n">index</span><span class="p">,</span> <span class="kt">int</span> <span class="n">perm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">WepKeyRid</span> <span class="n">wkr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wkr</span><span class="p">));</span>
	<span class="n">wkr</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">wkr</span><span class="p">));</span>
	<span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">);</span>
	<span class="n">wkr</span><span class="p">.</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">defindex</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">index</span><span class="p">;</span>
		<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">writeWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">perm</span><span class="p">)</span>
		<span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">proc_wepkey_on_close</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="sc">&#39;0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="sc">&#39;3&#39;</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">set_wep_tx_idx</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;failed to set &quot;</span>
				               <span class="s">&quot;WEP transmit index to %d: %d.&quot;</span><span class="p">,</span>
				               <span class="n">index</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;WepKey passed invalid key index&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="o">*</span><span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">i</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">])</span><span class="o">&lt;&lt;</span><span class="mi">4</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="o">/</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">hex_to_bin</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">set_wep_key</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">i</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_err</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;failed to set WEP key at index &quot;</span>
		               <span class="s">&quot;%d: %d.&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_wepkey_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">WepKeyRid</span> <span class="n">wkr</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">lastindex</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_data</span> <span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wkr</span><span class="p">));</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span> <span class="mi">180</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">maxwritelen</span> <span class="o">=</span> <span class="mi">80</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span> <span class="mi">80</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">on_close</span> <span class="o">=</span> <span class="n">proc_wepkey_on_close</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;No wep keys</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">readWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="n">SUCCESS</span><span class="p">)</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">lastindex</span> <span class="o">=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="s">&quot;Tx key = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">wkr</span><span class="p">.</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">j</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="s">&quot;Key %d set with length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">),</span>
				     <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">wkr</span><span class="p">.</span><span class="n">klen</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="n">readWepKeyRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wkr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">((</span><span class="n">lastindex</span> <span class="o">!=</span> <span class="n">wkr</span><span class="p">.</span><span class="n">kindex</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">180</span><span class="o">-</span><span class="mi">30</span><span class="p">));</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_SSID_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">SsidRid</span> <span class="n">SSID_rid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_data</span> <span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span> <span class="mi">104</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">maxwritelen</span> <span class="o">=</span> <span class="mi">33</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
	<span class="cm">/* allocate maxwritelen + 1; we&#39;ll want a sentinel */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">33</span><span class="o">*</span><span class="mi">3</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">on_close</span> <span class="o">=</span> <span class="n">proc_SSID_on_close</span><span class="p">;</span>

	<span class="n">readSsidRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SSID_rid</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">[</span><span class="n">j</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="o">*</span><span class="n">ptr</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_APList_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">APListRid</span> <span class="n">APList_rid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_data</span> <span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span> <span class="mi">104</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">maxwritelen</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="mi">6</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">maxwritelen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">);</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">on_close</span> <span class="o">=</span> <span class="n">proc_APList_on_close</span><span class="p">;</span>

	<span class="n">readAPListRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">APList_rid</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-43"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-43">&#182;</a></div><p>We end when we find a zero MAC</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span> <span class="o">!*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">APList_rid</span><span class="p">.</span><span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
		     <span class="o">!*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">APList_rid</span><span class="p">.</span><span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">APList_rid</span><span class="p">.</span><span class="n">ap</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;Not using specific APs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_BSSList_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">dp</span> <span class="o">=</span> <span class="n">PDE</span><span class="p">(</span><span class="n">inode</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="n">BSSListRid</span> <span class="n">BSSList_rid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="cm">/* If doLoseSync is not 1, we won&#39;t do a Lose Sync */</span>
	<span class="kt">int</span> <span class="n">doLoseSync</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">proc_data</span> <span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">writelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">maxwritelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">on_close</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_WRITE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_mode</span> <span class="o">&amp;</span> <span class="n">FMODE_READ</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
			<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_RADIO_MASK</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
			<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="o">=</span><span class="n">CMD_LISTBSS</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
			<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">doLoseSync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">;</span>
	<span class="cm">/* There is a race condition here if there are concurrent opens.</span>
<span class="cm">           Since it is a rare condition, we&#39;ll just live with it, otherwise</span>
<span class="cm">           we have to add a spin lock... */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">readBSSListRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">doLoseSync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BSSList_rid</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">BSSList_rid</span><span class="p">.</span><span class="n">index</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot;%pM %*s rssi = %d&quot;</span><span class="p">,</span>
			       <span class="n">BSSList_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">BSSList_rid</span><span class="p">.</span><span class="n">ssidLen</span><span class="p">,</span>
				<span class="n">BSSList_rid</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">BSSList_rid</span><span class="p">.</span><span class="n">dBm</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="s">&quot; channel = %d %s %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">BSSList_rid</span><span class="p">.</span><span class="n">dsChannel</span><span class="p">),</span>
				<span class="n">BSSList_rid</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CAP_ESS</span> <span class="o">?</span> <span class="s">&quot;ESS&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">BSSList_rid</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CAP_IBSS</span> <span class="o">?</span> <span class="s">&quot;adhoc&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">BSSList_rid</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY</span> <span class="o">?</span> <span class="s">&quot;wep&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">BSSList_rid</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">CAP_SHORTHDR</span> <span class="o">?</span> <span class="s">&quot;shorthdr&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">readBSSListRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BSSList_rid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">readlen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">proc_close</span><span class="p">(</span> <span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">on_close</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">on_close</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">rbuffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">wbuffer</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Since the card doesn&#39;t automatically switch to the right WEP mode,</span>
<span class="cm">   we will make it do it.  If the card isn&#39;t associated, every secs we</span>
<span class="cm">   will switch WEP modes to see if that will help.  If the card is</span>
<span class="cm">   associated we will check every minute to see if anything has</span>
<span class="cm">   changed. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">timer_func</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">apriv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

<span class="cm">/* We don&#39;t have a link so try changing the authtype */</span>
	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUTH_ENCRYPT</span>:
<span class="cm">/* So drop to OPEN */</span>
			<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_OPEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUTH_SHAREDKEY</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">keyindex</span> <span class="o">&lt;</span> <span class="n">auto_wep</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set_wep_tx_idx</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">keyindex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_SHAREDKEY</span><span class="p">;</span>
				<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">keyindex</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			        <span class="cm">/* Drop to ENCRYPT */</span>
				<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">keyindex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">set_wep_tx_idx</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="n">apriv</span><span class="o">-&gt;</span><span class="n">defindex</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_ENCRYPT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>  <span class="cm">/* We&#39;ll escalate to SHAREDKEY */</span>
			<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_SHAREDKEY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">writeConfigRid</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">apriv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

<span class="cm">/* Schedule check to see if the change worked */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_AUTOWEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">apriv</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="n">apriv</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="n">HZ</span><span class="o">*</span><span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">airo_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0x5000</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="mh">0xa504</span><span class="p">)</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">_init_airo_card</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
			<span class="n">dev</span> <span class="o">=</span> <span class="n">_init_airo_card</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">start</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">airo_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">airo_print_info</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Unregistering...&quot;</span><span class="p">);</span>
	<span class="n">stop_airo_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_pci_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span><span class="p">)</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">APListRid</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">)</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SsidRid</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">readAPListRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span><span class="p">);</span>
	<span class="n">readSsidRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="cm">/* the lock will be released at the end of the resume callback */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">HOSTSLEEP</span><span class="p">;</span>
	<span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_pci_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">pci_power_t</span> <span class="n">prev_state</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">current_state</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prev_state</span> <span class="o">!=</span> <span class="n">PCI_D1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reset_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mpi_init_descriptors</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="n">setup_card</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_RADIO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_PENDING_XMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_AWAKEN</span><span class="p">);</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">EVACK</span><span class="p">,</span> <span class="n">EV_AWAKEN</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">msleep</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeSsidRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span><span class="p">);</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">SSID</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">writeAPListRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span><span class="p">);</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">APList</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writeConfigRid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="n">PMSG_ON</span><span class="p">;</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">enable_interrupts</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">airo_init_module</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">airo_entry</span> <span class="o">=</span> <span class="n">proc_mkdir_mode</span><span class="p">(</span><span class="s">&quot;driver/aironet&quot;</span><span class="p">,</span> <span class="n">airo_perm</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">airo_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_entry</span><span class="o">-&gt;</span><span class="n">uid</span> <span class="o">=</span> <span class="n">proc_uid</span><span class="p">;</span>
		<span class="n">airo_entry</span><span class="o">-&gt;</span><span class="n">gid</span> <span class="o">=</span> <span class="n">proc_gid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">airo_print_info</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Trying to configure ISA adapter at irq=%d &quot;</span>
			<span class="s">&quot;io=0x%x&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">init_airo_card</span><span class="p">(</span> <span class="n">irq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">))</span>
			<span class="cm">/* do nothing */</span> <span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">airo_print_info</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Probing for PCI adapters&quot;</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">airo_driver</span><span class="p">);</span>
	<span class="n">airo_print_info</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;Finished probing for PCI adapters&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/aironet&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Always exit with success, as we are a library module</span>
<span class="cm">	 * as well as a driver module</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">airo_cleanup_module</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">airo_devices</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ai</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">airo_devices</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">airo_info</span><span class="p">,</span> <span class="n">dev_list</span><span class="p">);</span>
		<span class="n">airo_print_info</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Unregistering...&quot;</span><span class="p">);</span>
		<span class="n">stop_airo_card</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_PCI</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">airo_driver</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;driver/aironet&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initial Wireless Extension code for Aironet driver by :</span>
<span class="cm"> *	Jean Tourrilhes &lt;jt@hpl.hp.com&gt; - HPL - 17 November 00</span>
<span class="cm"> * Conversion to new driver API by :</span>
<span class="cm"> *	Jean Tourrilhes &lt;jt@hpl.hp.com&gt; - HPL - 26 March 02</span>
<span class="cm"> * Javier also did a good amount of work here, adding some new extensions</span>
<span class="cm"> * and fixing my code. Let&#39;s just say that without him this code just</span>
<span class="cm"> * would not work at all... - Jean II</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">airo_rssi_to_dbm</span> <span class="p">(</span><span class="n">tdsRssiEntry</span> <span class="o">*</span><span class="n">rssi_rid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rssi_rid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="mh">0x100</span> <span class="o">-</span> <span class="n">rssi_rid</span><span class="p">[</span><span class="n">rssi</span><span class="p">].</span><span class="n">rssidBm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">airo_dbm_to_pct</span> <span class="p">(</span><span class="n">tdsRssiEntry</span> <span class="o">*</span><span class="n">rssi_rid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rssi_rid</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rssi_rid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rssidBm</span> <span class="o">==</span> <span class="n">dbm</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rssi_rid</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rssipct</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_quality</span> <span class="p">(</span><span class="n">StatusRid</span> <span class="o">*</span><span class="n">status_rid</span><span class="p">,</span> <span class="n">CapabilityRid</span> <span class="o">*</span><span class="n">cap_rid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">sq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status_rid</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">))</span> <span class="o">!=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x3f</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cap_rid</span><span class="o">-&gt;</span><span class="n">hardCap</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sq</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="o">-&gt;</span><span class="n">signalQuality</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">cap_rid</span><span class="o">-&gt;</span><span class="n">prodName</span><span class="p">,</span> <span class="s">&quot;350&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sq</span> <span class="o">&gt;</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">quality</span> <span class="o">=</span> <span class="mh">0x20</span> <span class="o">-</span> <span class="n">sq</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sq</span> <span class="o">&gt;</span> <span class="mh">0xb0</span><span class="p">)</span>
			<span class="n">quality</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sq</span> <span class="o">&lt;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">quality</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">quality</span> <span class="o">=</span> <span class="mh">0xb0</span> <span class="o">-</span> <span class="n">sq</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">quality</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define airo_get_max_quality(cap_rid) (memcmp((cap_rid)-&gt;prodName, &quot;350&quot;, 3) ? 0x20 : 0xa0)</span>
<span class="cp">#define airo_get_avg_quality(cap_rid) (memcmp((cap_rid)-&gt;prodName, &quot;350&quot;, 3) ? 0x10 : 0x50);</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get protocol name</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">cwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cwrq</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11-DS&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>

	<span class="cm">/* If setting by frequency, convert to a channel */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">f</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">/</span> <span class="mi">100000</span><span class="p">;</span>

		<span class="cm">/* Hack to fall through... */</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_freq_to_dsss_chan</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Setting by channel number */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">;</span>
		<span class="cm">/* We should do a better check than that,</span>
<span class="cm">		 * based on the card capability !!! */</span>
		<span class="k">if</span><span class="p">((</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">airo_print_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;New channel value of %d is invalid!&quot;</span><span class="p">,</span>
				<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="cm">/* Yes ! We can set it !!! */</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">channelSet</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get frequency</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_freq</span> <span class="o">*</span><span class="n">fwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">StatusRid</span> <span class="n">status_rid</span><span class="p">;</span>		<span class="cm">/* Card status info */</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;</span> <span class="n">MODE_CFG_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_STA_ESS</span><span class="p">)</span>
		<span class="n">status_rid</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">channelSet</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">readStatusRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span><span class="p">((</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_dsss_chan_to_freq</span><span class="p">(</span><span class="n">ch</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">m</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">fwrq</span><span class="o">-&gt;</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set ESSID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">SsidRid</span> <span class="n">SSID_rid</span><span class="p">;</span>		<span class="cm">/* SSIDs */</span>

	<span class="cm">/* Reload the list of current SSID */</span>
	<span class="n">readSsidRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SSID_rid</span><span class="p">);</span>

	<span class="cm">/* Check if we asked for `any&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Just send an empty SSID list */</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SSID_rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Check the size of the string */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">IW_ESSID_MAX_SIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span> <span class="p">;</span>

		<span class="cm">/* Check if index is valid */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Set the SSID */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ssid</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">SSID_rid</span><span class="p">.</span><span class="n">ssids</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">SSID_rid</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">SSID_rid</span><span class="p">));</span>
	<span class="cm">/* Write it to the card */</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">writeSsidRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SSID_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get ESSID</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">StatusRid</span> <span class="n">status_rid</span><span class="p">;</span>		<span class="cm">/* Card status info */</span>

	<span class="n">readStatusRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Note : if dwrq-&gt;flags != 0, we should</span>
<span class="cm">	 * get the relevant SSID from the SSID list... */</span>

	<span class="cm">/* Get the current SSID */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">SSID</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">SSIDlen</span><span class="p">));</span>
	<span class="cm">/* If none, we may want to get the one that was set */</span>

	<span class="cm">/* Push it out ! */</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">SSIDlen</span><span class="p">);</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* active */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set AP address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="n">APListRid</span> <span class="n">APList_rid</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">any</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="mh">0xFF</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">off</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">any</span><span class="p">,</span> <span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)</span> <span class="o">||</span>
	         <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
		<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="o">=</span><span class="n">CMD_LOSE_SYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="n">issuecommand</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">APList_rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">APList_rid</span><span class="p">));</span>
		<span class="n">APList_rid</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">APList_rid</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">APList_rid</span><span class="p">.</span><span class="n">ap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">disable_MAC</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writeAPListRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">APList_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">enable_MAC</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get AP address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">awrq</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">StatusRid</span> <span class="n">status_rid</span><span class="p">;</span>		<span class="cm">/* Card status info */</span>

	<span class="n">readStatusRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Tentative. This seems to work, wow, I&#39;m lucky !!! */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">awrq</span><span class="o">-&gt;</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Nickname</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="cm">/* Check the size of the string */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">nodeName</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Nickname</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">nodeName</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">extra</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">extra</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Bit-Rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">CapabilityRid</span> <span class="n">cap_rid</span><span class="p">;</span>		<span class="cm">/* Card capability info */</span>
	<span class="n">u8</span>	<span class="n">brate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>

	<span class="cm">/* First : get a valid bit rate value */</span>
	<span class="n">readCapabilityRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Which type of value ? */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Setting by rate index */</span>
		<span class="cm">/* Find value in the magic rate table */</span>
		<span class="n">brate</span> <span class="o">=</span> <span class="n">cap_rid</span><span class="p">.</span><span class="n">supportedRates</span><span class="p">[</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Setting by frequency value */</span>
		<span class="n">u8</span>	<span class="n">normvalue</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">/</span><span class="mi">500000</span><span class="p">);</span>

		<span class="cm">/* Check if rate is valid */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">normvalue</span> <span class="o">==</span> <span class="n">cap_rid</span><span class="p">.</span><span class="n">supportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">brate</span> <span class="o">=</span> <span class="n">normvalue</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* -1 designed the max rate (mostly auto mode) */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get the highest available rate */</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">supportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">brate</span> <span class="o">=</span> <span class="n">cap_rid</span><span class="p">.</span><span class="n">supportedRates</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="cm">/* Check that it is valid */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">brate</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Now, check if we want a fixed or auto value */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Fill all the rates up to this max rate */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap_rid</span><span class="p">.</span><span class="n">supportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">brate</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Fixed mode */</span>
		<span class="cm">/* One rate, fixed */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">brate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Bit-Rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">StatusRid</span> <span class="n">status_rid</span><span class="p">;</span>		<span class="cm">/* Card status info */</span>

	<span class="n">readStatusRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">currentXmitRate</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
	<span class="cm">/* If more than one rate, set auto */</span>
	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set RTS threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rthr</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">rthr</span> <span class="o">=</span> <span class="n">AIRO_DEF_MTU</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">rthr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rthr</span> <span class="o">&gt;</span> <span class="n">AIRO_DEF_MTU</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rtsThres</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rthr</span><span class="p">);</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get RTS threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_rts</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rtsThres</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">AIRO_DEF_MTU</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Fragmentation threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fthr</span> <span class="o">=</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span>
		<span class="n">fthr</span> <span class="o">=</span> <span class="n">AIRO_DEF_MTU</span><span class="p">;</span>
	<span class="k">if</span><span class="p">((</span><span class="n">fthr</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">fthr</span> <span class="o">&gt;</span> <span class="n">AIRO_DEF_MTU</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fthr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1</span><span class="p">;</span>	<span class="cm">/* Get an even value - is it really needed ??? */</span>
	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fragThresh</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fthr</span><span class="p">);</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Fragmentation threshold</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_frag</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fragThresh</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">AIRO_DEF_MTU</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Mode of Operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="n">__u32</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sniffing_mode</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
		<span class="n">reset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="o">*</span><span class="n">uwrq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IW_MODE_ADHOC</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MODE_CFG_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_STA_IBSS</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_FULL_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">scanMode</span> <span class="o">=</span> <span class="n">SCANMODE_ACTIVE</span><span class="p">;</span>
			<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_MODE_INFRA</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MODE_CFG_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_STA_ESS</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_FULL_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">scanMode</span> <span class="o">=</span> <span class="n">SCANMODE_ACTIVE</span><span class="p">;</span>
			<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_MODE_MASTER</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MODE_CFG_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_AP</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_FULL_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">scanMode</span> <span class="o">=</span> <span class="n">SCANMODE_ACTIVE</span><span class="p">;</span>
			<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_MODE_REPEAT</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MODE_CFG_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_AP_RPTR</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_FULL_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">scanMode</span> <span class="o">=</span> <span class="n">SCANMODE_ACTIVE</span><span class="p">;</span>
			<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_MODE_MONITOR</span>:
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MODE_CFG_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_STA_ESS</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_FULL_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">|=</span> <span class="n">RXMODE_RFMON</span> <span class="o">|</span> <span class="n">RXMODE_DISABLE_802_3_HEADER</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">scanMode</span> <span class="o">=</span> <span class="n">SCANMODE_PASSIVE</span><span class="p">;</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_802_11</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Mode of Operation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="n">__u32</span> <span class="o">*</span><span class="n">uwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* If not managed, assume it&#39;s ad-hoc */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">opmode</span> <span class="o">&amp;</span> <span class="n">MODE_CFG_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">MODE_STA_ESS</span>:
			<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MODE_AP</span>:
			<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">MODE_AP_RPTR</span>:
			<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="n">IW_MODE_REPEAT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="o">*</span><span class="n">uwrq</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">valid_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">max_wep_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Encryption Key</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">perm</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_TEMP</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">__le16</span> <span class="n">currentAuthType</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wep_capable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Basic checking: do we have a key to set ?</span>
<span class="cm">	 * Note : with the new API, it&#39;s impossible to get a NULL pointer.</span>
<span class="cm">	 * Therefore, we need to check a key size == 0 instead.</span>
<span class="cm">	 * New version of iwconfig properly set the IW_ENCODE_NOKEY flag</span>
<span class="cm">	 * when no key is present (only change flags), but older versions</span>
<span class="cm">	 * don&#39;t do it. - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wep_key_t</span> <span class="n">key</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">current_index</span><span class="p">;</span>

		<span class="cm">/* Check the size of the key */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MAX_KEY_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">current_index</span> <span class="o">=</span> <span class="n">get_wep_tx_idx</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Check the index (none -&gt; use current) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_index</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">current_index</span><span class="p">;</span>

		<span class="cm">/* Set the length */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">MIN_KEY_SIZE</span><span class="p">)</span>
			<span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">MAX_KEY_SIZE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">MIN_KEY_SIZE</span><span class="p">;</span>
		<span class="cm">/* Check if the key is not marked as invalid */</span>
		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Cleanup */</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_KEY_SIZE</span><span class="p">);</span>
			<span class="cm">/* Copy the key in the driver */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
			<span class="cm">/* Send the key to the card */</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">set_wep_key</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">airo_print_err</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;failed to set&quot;</span>
				               <span class="s">&quot; WEP key at index %d: %d.&quot;</span><span class="p">,</span>
				               <span class="n">index</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* WE specify that if a valid key is set, encryption</span>
<span class="cm">		 * should be enabled (user may turn it off later)</span>
<span class="cm">		 * This is also how &quot;iwconfig ethX key on&quot; works */</span>
		<span class="k">if</span><span class="p">((</span><span class="n">index</span> <span class="o">==</span> <span class="n">current_index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">==</span> <span class="n">AUTH_OPEN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_ENCRYPT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Do we want to just set the transmit key index ? */</span>
		<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid_index</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">set_wep_tx_idx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">airo_print_err</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;failed to set&quot;</span>
				               <span class="s">&quot; WEP transmit index to %d: %d.&quot;</span><span class="p">,</span>
				               <span class="n">index</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Don&#39;t complain if only change the mode */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_MODE</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Read the flags */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_OPEN</span><span class="p">;</span>	<span class="c1">// disable encryption</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_SHAREDKEY</span><span class="p">;</span>	<span class="c1">// Only Both</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_ENCRYPT</span><span class="p">;</span>	<span class="c1">// Only Wep</span>
	<span class="cm">/* Commit the changes to flags if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">!=</span> <span class="n">currentAuthType</span><span class="p">)</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Encryption Key</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wep_key_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wep_capable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Check encryption mode */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">case</span> <span class="n">AUTH_ENCRYPT</span>:
			<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUTH_SHAREDKEY</span>:
			<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">AUTH_OPEN</span>:
			<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We can&#39;t return the key, so set the proper flag and return zero */</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Which key do we want ? -1 -&gt; tx index */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_index</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">index</span> <span class="o">=</span> <span class="n">get_wep_tx_idx</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Copy the key to the user buffer */</span>
	<span class="n">wep_key_len</span> <span class="o">=</span> <span class="n">get_wep_key</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wep_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">wep_key_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set extended Encryption parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">perm</span> <span class="o">=</span> <span class="p">(</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_TEMP</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span> <span class="p">);</span>
	<span class="n">__le16</span> <span class="n">currentAuthType</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key_len</span><span class="p">,</span> <span class="n">alg</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">alg</span><span class="p">,</span> <span class="n">set_key</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">wep_key_t</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wep_capable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Determine and validate the key index */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_index</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">get_wep_tx_idx</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span>
		<span class="n">alg</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">ext_flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_EXT_SET_TX_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only set transmit key index here, actual</span>
<span class="cm">		 * key is set below if needed.</span>
<span class="cm">		 */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">set_wep_tx_idx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">airo_print_err</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;failed to set &quot;</span>
			               <span class="s">&quot;WEP transmit index to %d: %d.&quot;</span><span class="p">,</span>
			               <span class="n">idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_key</span> <span class="o">=</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">set_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set the requested key first */</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MAX_KEY_SIZE</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">alg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_NONE</span>:
			<span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_ENCODE_ALG_WEP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="n">MIN_KEY_SIZE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">MAX_KEY_SIZE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">MIN_KEY_SIZE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">key_len</span> <span class="o">=</span> <span class="n">min</span> <span class="p">(</span><span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">set_wep_tx_idx</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">airo_print_err</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="s">&quot;failed to set WEP transmit index to %d: %d.&quot;</span><span class="p">,</span>
					       <span class="n">idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">set_wep_key</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">perm</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">airo_print_err</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					       <span class="s">&quot;failed to set WEP key at index %d: %d.&quot;</span><span class="p">,</span>
					       <span class="n">idx</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Read the flags */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_OPEN</span><span class="p">;</span>	<span class="c1">// disable encryption</span>
	<span class="k">if</span><span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_RESTRICTED</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_SHAREDKEY</span><span class="p">;</span>	<span class="c1">// Only Both</span>
	<span class="k">if</span><span class="p">(</span><span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_OPEN</span><span class="p">)</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_ENCRYPT</span><span class="p">;</span>	<span class="c1">// Only Wep</span>
	<span class="cm">/* Commit the changes to flags if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">!=</span> <span class="n">currentAuthType</span><span class="p">)</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get extended Encryption parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_encodeext</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">encoding</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="n">ext</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_encode_ext</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">max_key_len</span><span class="p">,</span> <span class="n">wep_key_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wep_capable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">max_key_len</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_ENCODE_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_index</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">get_wep_tx_idx</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ext</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ext</span><span class="p">));</span>

	<span class="cm">/* Check encryption mode */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUTH_ENCRYPT</span>:
			<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_WEP</span> <span class="o">|</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUTH_SHAREDKEY</span>:
			<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_WEP</span> <span class="o">|</span> <span class="n">IW_ENCODE_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">AUTH_OPEN</span>:
			<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ALG_NONE</span> <span class="o">|</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We can&#39;t return the key, so set the proper flag and return zero */</span>
	<span class="n">encoding</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	
	<span class="cm">/* Copy the key to the user buffer */</span>
	<span class="n">wep_key_len</span> <span class="o">=</span> <span class="n">get_wep_key</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wep_key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">wep_key_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ext</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set extended authentication parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">currentAuthType</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_WPA_VERSION</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_PAIRWISE</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_CIPHER_GROUP</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_KEY_MGMT</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_RX_UNENCRYPTED_EAPOL</span>:
	<span class="k">case</span> <span class="n">IW_AUTH_PRIVACY_INVOKED</span>:
		<span class="cm">/*</span>
<span class="cm">		 * airo does not use these parameters</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Only change auth type if unencrypted */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">currentAuthType</span> <span class="o">==</span> <span class="n">AUTH_OPEN</span><span class="p">)</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_ENCRYPT</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_OPEN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Commit the changes to flags if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">!=</span> <span class="n">currentAuthType</span><span class="p">)</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>: <span class="p">{</span>
			<span class="cm">/* FIXME: What about AUTH_OPEN?  This API seems to</span>
<span class="cm">			 * disallow setting our auth to AUTH_OPEN.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_SHAREDKEY</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">=</span> <span class="n">AUTH_ENCRYPT</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="cm">/* Commit the changes to flags if needed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span> <span class="o">!=</span> <span class="n">currentAuthType</span><span class="p">)</span>
				<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="cm">/* Silently accept disable of WPA */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get extended authentication parameters</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			       <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">param</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">currentAuthType</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">authType</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_AUTH_INDEX</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IW_AUTH_DROP_UNENCRYPTED</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">currentAuthType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUTH_SHAREDKEY</span>:
		<span class="k">case</span> <span class="n">AUTH_ENCRYPT</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_80211_AUTH_ALG</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">currentAuthType</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">AUTH_SHAREDKEY</span>:
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_SHARED_KEY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">AUTH_ENCRYPT</span>:
		<span class="nl">default:</span>
			<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">IW_AUTH_ALG_OPEN_SYSTEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IW_AUTH_WPA_ENABLED</span>:
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Tx-Power</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_txpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">CapabilityRid</span> <span class="n">cap_rid</span><span class="p">;</span>		<span class="cm">/* Card capability info */</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

	<span class="n">readCapabilityRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_RADIO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="n">IW_TXPOW_MWATT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_RADIO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">cap_rid</span><span class="p">.</span><span class="n">txPowerLevels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">==</span> <span class="n">cap_rid</span><span class="p">.</span><span class="n">txPowerLevels</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txPower</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>	<span class="cm">/* Call commit handler */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Tx-Power</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_txpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txPower</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* No power control */</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_RADIO_OFF</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_TXPOW_MWATT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Retry limits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">v</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">longRetryLimit</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_SHORT</span><span class="p">)</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">shortRetryLimit</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* No modifier : set both */</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">longRetryLimit</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">shortRetryLimit</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txLifetime</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Retry limits</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* Can&#39;t be disabled */</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Note : by default, display the min retry number */</span>
	<span class="k">if</span><span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">txLifetime</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LONG</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">longRetryLimit</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">shortRetryLimit</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">shortRetryLimit</span> <span class="o">!=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">longRetryLimit</span><span class="p">)</span>
			<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_RETRY_SHORT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get range info</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">CapabilityRid</span> <span class="n">cap_rid</span><span class="p">;</span>		<span class="cm">/* Card capability info */</span>
	<span class="kt">int</span>		<span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">k</span><span class="p">;</span>

	<span class="n">readCapabilityRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">));</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_nwid</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_nwid</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_channels</span> <span class="o">=</span> <span class="mi">14</span><span class="p">;</span>
	<span class="cm">/* Should be based on cap_rid.country to give only</span>
<span class="cm">	 * what the current card support */</span>
	<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* List index */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="p">].</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_dsss_chan_to_freq</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">[</span><span class="n">k</span><span class="o">++</span><span class="p">].</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Values in MHz -&gt; * 10^5 * 10 */</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_frequency</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">sensitivity</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="cm">/* Hum... Should put the right values there */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">)</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* % */</span>
	<span class="k">else</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">airo_get_max_quality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">);</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="mi">120</span><span class="p">;</span>	<span class="cm">/* -120 dBm */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="mi">120</span><span class="p">;</span>	<span class="cm">/* -120 dBm */</span>

	<span class="cm">/* Experimental measurements - boundary 11/5.5 Mb/s */</span>
	<span class="cm">/* Note : with or without the (local-&gt;rssi), results</span>
<span class="cm">	 * are somewhat different. - Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>		<span class="cm">/* % */</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="mi">70</span><span class="p">;</span>	<span class="cm">/* -70 dBm */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">airo_get_avg_quality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">);</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="mi">80</span><span class="p">;</span>	<span class="cm">/* -80 dBm */</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">avg_qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="mi">85</span><span class="p">;</span>		<span class="cm">/* -85 dBm */</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cap_rid</span><span class="p">.</span><span class="n">supportedRates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_bitrates</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Set an indication of the max TCP throughput</span>
<span class="cm">	 * in bit/s that we can expect using this interface.</span>
<span class="cm">	 * May be use for QoS stuff... Jean II */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">5000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span> <span class="o">=</span> <span class="mi">1500</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_rts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_rts</span> <span class="o">=</span> <span class="n">AIRO_DEF_MTU</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_frag</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_frag</span> <span class="o">=</span> <span class="n">AIRO_DEF_MTU</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softCap</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-44"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-44">&#182;</a></div><p>WEP: RC4 40 bits</p></td><td class="code"><div class="highlight"><pre>		<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-45"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-45">&#182;</a></div><p>RC4 ~128 bits</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">softCap</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x100</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">encoding_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span>
			<span class="n">cap_rid</span><span class="p">.</span><span class="n">softCap</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_encoding_sizes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_encoding_tokens</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_pmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_pmp</span> <span class="o">=</span> <span class="mi">5000000</span><span class="p">;</span>	<span class="cm">/* 5 secs */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_pmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_pmt</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>	<span class="cm">/* ??? */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmp_flags</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pmt_flags</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">pm_capa</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span> <span class="o">|</span> <span class="n">IW_POWER_TIMEOUT</span> <span class="o">|</span> <span class="n">IW_POWER_ALL_R</span><span class="p">;</span>

	<span class="cm">/* Transmit Power - values are in mW */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cap_rid</span><span class="p">.</span><span class="n">txPowerLevels</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">num_txpower</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">txpower_capa</span> <span class="o">=</span> <span class="n">IW_TXPOW_MWATT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span> <span class="o">=</span> <span class="mi">19</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span> <span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_capa</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">retry_flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">r_time_flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIFETIME</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_retry</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">min_r_time</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">max_r_time</span> <span class="o">=</span> <span class="mi">65535</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>

	<span class="cm">/* Event capability (kernel + driver) */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">IW_EVENT_CAPA_K_0</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">));</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_EVENT_CAPA_K_1</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">event_capa</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_EVENT_CAPA_MASK</span><span class="p">(</span><span class="n">IWEVTXDROP</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Power Management</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sniffing_mode</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">=</span> <span class="n">POWERSAVE_CAM</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_MASK</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">|=</span> <span class="n">RXMODE_BC_MC_ADDR</span><span class="p">;</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fastListenDelay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">=</span> <span class="n">POWERSAVE_PSPCAM</span><span class="p">;</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_POWER_PERIOD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fastListenInterval</span> <span class="o">=</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">listenInterval</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">+</span> <span class="mi">500</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span> <span class="o">=</span> <span class="n">POWERSAVE_PSPCAM</span><span class="p">;</span>
		<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_MODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IW_POWER_UNICAST_R</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sniffing_mode</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">|=</span> <span class="n">RXMODE_ADDR</span><span class="p">;</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IW_POWER_ALL_R</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">sniffing_mode</span><span class="p">(</span><span class="n">local</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXMODE_MASK</span><span class="p">;</span>
			<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">|=</span> <span class="n">RXMODE_BC_MC_ADDR</span><span class="p">;</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">case</span> <span class="n">IW_POWER_ON</span>:
			<span class="cm">/* This is broken, fixme ;-) */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-46"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-46">&#182;</a></div><p>Note : we may want to factor local->need<em>commit here
Note2 : may also want to factor RXMODE</em>RFMON test</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Power Management</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			  <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">powerSaveMode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">POWERSAVE_CAM</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_POWER_TYPE</span><span class="p">)</span> <span class="o">==</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fastListenDelay</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_TIMEOUT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">fastListenInterval</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_PERIOD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rmode</span> <span class="o">&amp;</span> <span class="n">RXMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">RXMODE_ADDR</span><span class="p">)</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_UNICAST_R</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IW_POWER_ALL_R</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : set Sensitivity</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rssiThreshold</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">?</span> <span class="n">RSSI_DEFAULT</span> <span class="o">:</span> <span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>		<span class="cm">/* Call commit handler */</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get Sensitivity</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_param</span> <span class="o">*</span><span class="n">vwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="n">readConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">rssiThreshold</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="p">(</span><span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vwrq</span><span class="o">-&gt;</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : get AP List</span>
<span class="cm"> * Note : this is deprecated in favor of IWSCAN</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_aplist</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">address</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_quality</span> <span class="o">*</span><span class="n">qual</span><span class="p">;</span>
	<span class="n">BSSListRid</span> <span class="n">BSSList</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loseSync</span> <span class="o">=</span> <span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">qual</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">IW_MAX_AP</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qual</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">qual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IW_MAX_AP</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">dBm</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">readBSSListRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">loseSync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">BSSList</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">loseSync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">BSSList</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">address</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">dBm</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">BSSList</span><span class="p">.</span><span class="n">dBm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="n">dBm</span><span class="p">;</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qual</span> <span class="o">=</span> <span class="n">airo_dbm_to_pct</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span> <span class="n">dBm</span><span class="p">);</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_QUAL_UPDATED</span>
					<span class="o">|</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span>
					<span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">dBm</span> <span class="o">+</span> <span class="mi">321</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">qual</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_QUAL_INVALID</span>
					<span class="o">|</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span>
					<span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">qual</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">noise</span> <span class="o">=</span> <span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">BSSList</span><span class="p">.</span><span class="n">index</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0xffff</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">StatusRid</span> <span class="n">status_rid</span><span class="p">;</span>		<span class="cm">/* Card status info */</span>
		<span class="n">readStatusRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		     <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">(</span><span class="n">IW_MAX_AP</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			      <span class="o">&amp;</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			      <span class="o">&amp;</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
			      <span class="o">&amp;</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
			      <span class="o">&amp;</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
			      <span class="o">&amp;</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">])</span><span class="o">!=</span><span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
			     <span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
			      <span class="o">|</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
			      <span class="o">|</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
			      <span class="o">|</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
			      <span class="o">|</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span>
			      <span class="o">|</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">5</span><span class="p">]);</span>
		     <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">address</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sa_data</span><span class="p">,</span>
			       <span class="n">status_rid</span><span class="p">.</span><span class="n">bssid</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">address</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* Should be define&#39;d */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">qual</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_quality</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">qual</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : Initiate Scan</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">Cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">Resp</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wake</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Note : you may have realised that, as this is a SET operation,</span>
<span class="cm">	 * this is privileged and therefore a normal user can&#39;t</span>
<span class="cm">	 * perform scanning.</span>
<span class="cm">	 * This is not an error, while the device perform scanning,</span>
<span class="cm">	 * traffic doesn&#39;t flow, so it&#39;s a perfect DoS...</span>
<span class="cm">	 * Jean II */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_RADIO_MASK</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">ENETDOWN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="cm">/* If there&#39;s already a scan in progress, don&#39;t</span>
<span class="cm">	 * trigger another one. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Initiate a scan command */</span>
	<span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span> <span class="o">=</span> <span class="n">RUN_AT</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">cmd</span><span class="o">=</span><span class="n">CMD_LISTBSS</span><span class="p">;</span>
	<span class="n">issuecommand</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="n">wake</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wake</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Translate scan data returned from the card to a card independent</span>
<span class="cm"> * format that the Wireless Tools will understand - Jean II</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">airo_translate_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">end_buf</span><span class="p">,</span>
					<span class="n">BSSListRid</span> <span class="o">*</span><span class="n">bss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_event</span>		<span class="n">iwe</span><span class="p">;</span>		<span class="cm">/* Temporary buffer */</span>
	<span class="n">__le16</span>			<span class="n">capabilities</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span>			<span class="n">current_val</span><span class="p">;</span>	<span class="cm">/* For rates */</span>
	<span class="kt">int</span>			<span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span>		<span class="n">buf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dBm</span><span class="p">;</span>

	<span class="cm">/* First entry *MUST* be the AP MAC address */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span>

	<span class="cm">/* Other entries will be displayed in the order we give them */</span>

	<span class="cm">/* Add the ESSID */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssidLen</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/* Add mode */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
	<span class="n">capabilities</span> <span class="o">=</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CAP_ESS</span> <span class="o">|</span> <span class="n">CAP_IBSS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_ESS</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_MASTER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">IW_MODE_ADHOC</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Add frequency */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">dsChannel</span><span class="p">);</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_dsss_chan_to_freq</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>

	<span class="n">dBm</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">dBm</span><span class="p">);</span>

	<span class="cm">/* Add quality statistics */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVQUAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="n">dBm</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">airo_dbm_to_pct</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span> <span class="n">dBm</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_QUAL_UPDATED</span>
				<span class="o">|</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span>
				<span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span> <span class="p">(</span><span class="n">dBm</span> <span class="o">+</span> <span class="mi">321</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_QUAL_INVALID</span>
				<span class="o">|</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span>
				<span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_QUAL_LEN</span><span class="p">);</span>

	<span class="cm">/* Add encryption capability */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">capabilities</span> <span class="o">&amp;</span> <span class="n">CAP_PRIVACY</span><span class="p">)</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">);</span>

	<span class="cm">/* Rate : stuffing multiple values in a single event require a bit</span>
<span class="cm">	 * more of magic - Jean II */</span>
	<span class="n">current_val</span> <span class="o">=</span> <span class="n">current_ev</span> <span class="o">+</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWRATE</span><span class="p">;</span>
	<span class="cm">/* Those two flags are ignored... */</span>
	<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Max 8 values */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NULL terminated */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Bit rate given in 500 kb/s units (+ 0x80) */</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">*</span> <span class="mi">500000</span><span class="p">);</span>
		<span class="cm">/* Add new value to event */</span>
		<span class="n">current_val</span> <span class="o">=</span> <span class="n">iwe_stream_add_value</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						   <span class="n">current_val</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_PARAM_LEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Check if we added any event */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">current_val</span> <span class="o">-</span> <span class="n">current_ev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">iwe_stream_lcp_len</span><span class="p">(</span><span class="n">info</span><span class="p">))</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">current_val</span><span class="p">;</span>

	<span class="cm">/* Beacon interval */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVCUSTOM</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;bcn_int=%d&quot;</span><span class="p">,</span> <span class="n">bss</span><span class="o">-&gt;</span><span class="n">beaconInterval</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Put WPA/RSN Information Elements into the event stream */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_WPA_CAPABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_null_ies</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">.</span><span class="n">iep</span><span class="p">);</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bss</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">.</span><span class="n">iep</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">((</span><span class="n">length</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">num_null_ies</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">+</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Invalid element, don&#39;t continue parsing IE */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">WLAN_EID_SSID</span>:
				<span class="cm">/* Two zero-length SSID elements</span>
<span class="cm">				 * mean we&#39;re done parsing elements */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
					<span class="n">num_null_ies</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">WLAN_EID_GENERIC</span>:
				<span class="k">if</span> <span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span>
				    <span class="n">ie</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span>
				    <span class="n">ie</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x50</span> <span class="o">&amp;&amp;</span>
				    <span class="n">ie</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xf2</span> <span class="o">&amp;&amp;</span>
				    <span class="n">ie</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
					<span class="cm">/* 64 is an arbitrary cut-off */</span>
					<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
								<span class="mi">64</span><span class="p">);</span>
					<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span>
							<span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
							<span class="n">end_buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">ie</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">WLAN_EID_RSN</span>:
				<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">IWEVGENIE</span><span class="p">;</span>
				<span class="cm">/* 64 is an arbitrary cut-off */</span>
				<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
				<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span>
					<span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span> <span class="n">end_buf</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">ie</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">length</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">ie</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ie</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">current_ev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Wireless Handler : Read Scan Results</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">iw_point</span> <span class="o">*</span><span class="n">dwrq</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="n">BSSListElement</span> <span class="o">*</span><span class="n">net</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>

	<span class="cm">/* If a scan is in-progress, return -EAGAIN */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">scan_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span> <span class="p">(</span><span class="n">net</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">network_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Translate to WE format this entry */</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">airo_translate_scan</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						 <span class="n">extra</span> <span class="o">+</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">bss</span><span class="p">);</span>

		<span class="cm">/* Check if there is space for one more entry */</span>
		<span class="k">if</span><span class="p">((</span><span class="n">extra</span> <span class="o">+</span> <span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">-</span> <span class="n">current_ev</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ask user space to try again with a bigger buffer */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Length of data */</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_ev</span> <span class="o">-</span> <span class="n">extra</span><span class="p">);</span>
	<span class="n">dwrq</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* todo */</span>

<span class="nl">out:</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Commit handler : called after a bunch of SET operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_config_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>	<span class="cm">/* NULL */</span>
			      <span class="kt">void</span> <span class="o">*</span><span class="n">zwrq</span><span class="p">,</span>			<span class="cm">/* NULL */</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>			<span class="cm">/* NULL */</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Some of the &quot;SET&quot; function may have modified some of the</span>
<span class="cm">	 * parameters. It&#39;s now time to commit them in the card */</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">FLAG_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">APListRid</span> <span class="n">APList_rid</span><span class="p">;</span>
		<span class="n">SsidRid</span> <span class="n">SSID_rid</span><span class="p">;</span>

		<span class="n">readAPListRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">APList_rid</span><span class="p">);</span>
		<span class="n">readSsidRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SSID_rid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">setup_card</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
		<span class="k">else</span>
			<span class="n">reset_airo_card</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">disable_MAC</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writeSsidRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">SSID_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">writeAPListRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">APList_rid</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">down_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="n">writeConfigRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">enable_MAC</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span> <span class="p">(</span><span class="n">FLAG_RESET</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">airo_set_promisc</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*------------------------------------------------------------------*/</span>
<span class="cm">/*</span>
<span class="cm"> * Structures to export the Wireless Handlers</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_priv_args</span> <span class="n">airo_private_args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*{ cmd,         set_args,                            get_args, name } */</span>
  <span class="p">{</span> <span class="n">AIROIOCTL</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">aironet_ioctl</span><span class="p">),</span>
    <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="mi">2047</span><span class="p">,</span> <span class="s">&quot;airoioctl&quot;</span> <span class="p">},</span>
  <span class="p">{</span> <span class="n">AIROIDIFC</span><span class="p">,</span> <span class="n">IW_PRIV_TYPE_BYTE</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">aironet_ioctl</span><span class="p">),</span>
    <span class="n">IW_PRIV_TYPE_INT</span> <span class="o">|</span> <span class="n">IW_PRIV_SIZE_FIXED</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;airoidifc&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span>		<span class="n">airo_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_config_commit</span><span class="p">,</span>	<span class="cm">/* SIOCSIWCOMMIT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_name</span><span class="p">,</span>		<span class="cm">/* SIOCGIWNAME */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWNWID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWNWID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_freq</span><span class="p">,</span>		<span class="cm">/* SIOCSIWFREQ */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_freq</span><span class="p">,</span>		<span class="cm">/* SIOCGIWFREQ */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_mode</span><span class="p">,</span>		<span class="cm">/* SIOCSIWMODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_mode</span><span class="p">,</span>		<span class="cm">/* SIOCGIWMODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_sens</span><span class="p">,</span>		<span class="cm">/* SIOCSIWSENS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_sens</span><span class="p">,</span>		<span class="cm">/* SIOCGIWSENS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWRANGE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_range</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRANGE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWPRIV */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWPRIV */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWSTATS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWSTATS */</span>
	<span class="n">iw_handler_set_spy</span><span class="p">,</span>			<span class="cm">/* SIOCSIWSPY */</span>
	<span class="n">iw_handler_get_spy</span><span class="p">,</span>			<span class="cm">/* SIOCGIWSPY */</span>
	<span class="n">iw_handler_set_thrspy</span><span class="p">,</span>			<span class="cm">/* SIOCSIWTHRSPY */</span>
	<span class="n">iw_handler_get_thrspy</span><span class="p">,</span>			<span class="cm">/* SIOCGIWTHRSPY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_wap</span><span class="p">,</span>		<span class="cm">/* SIOCSIWAP */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_wap</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAP */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_aplist</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAPLIST */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_scan</span><span class="p">,</span>		<span class="cm">/* SIOCSIWSCAN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_scan</span><span class="p">,</span>		<span class="cm">/* SIOCGIWSCAN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_essid</span><span class="p">,</span>		<span class="cm">/* SIOCSIWESSID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_essid</span><span class="p">,</span>		<span class="cm">/* SIOCGIWESSID */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_nick</span><span class="p">,</span>		<span class="cm">/* SIOCSIWNICKN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_nick</span><span class="p">,</span>		<span class="cm">/* SIOCGIWNICKN */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_rate</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRATE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_rate</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRATE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_rts</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRTS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_rts</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRTS */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_frag</span><span class="p">,</span>		<span class="cm">/* SIOCSIWFRAG */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_frag</span><span class="p">,</span>		<span class="cm">/* SIOCGIWFRAG */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_txpow</span><span class="p">,</span>		<span class="cm">/* SIOCSIWTXPOW */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_txpow</span><span class="p">,</span>		<span class="cm">/* SIOCGIWTXPOW */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_retry</span><span class="p">,</span>		<span class="cm">/* SIOCSIWRETRY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_retry</span><span class="p">,</span>		<span class="cm">/* SIOCGIWRETRY */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_encode</span><span class="p">,</span>		<span class="cm">/* SIOCSIWENCODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_encode</span><span class="p">,</span>		<span class="cm">/* SIOCGIWENCODE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_power</span><span class="p">,</span>		<span class="cm">/* SIOCSIWPOWER */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_power</span><span class="p">,</span>		<span class="cm">/* SIOCGIWPOWER */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* -- hole -- */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWGENIE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCGIWGENIE */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_auth</span><span class="p">,</span>		<span class="cm">/* SIOCSIWAUTH */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_auth</span><span class="p">,</span>		<span class="cm">/* SIOCGIWAUTH */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_set_encodeext</span><span class="p">,</span>	<span class="cm">/* SIOCSIWENCODEEXT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="n">airo_get_encodeext</span><span class="p">,</span>	<span class="cm">/* SIOCGIWENCODEEXT */</span>
	<span class="p">(</span><span class="n">iw_handler</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>			<span class="cm">/* SIOCSIWPMKSA */</span>
<span class="p">};</span>

<span class="cm">/* Note : don&#39;t describe AIROIDIFC and AIROOLDIDIFC in here.</span>
<span class="cm"> * We want to force the use of the ioctl code, because those can&#39;t be</span>
<span class="cm"> * won&#39;t work the iw_handler code (because they simultaneously read</span>
<span class="cm"> * and write data and iw_handler can&#39;t do that).</span>
<span class="cm"> * Note that it&#39;s perfectly legal to read/write on a single ioctl command,</span>
<span class="cm"> * you just can&#39;t use iwpriv and need to force it via the ioctl handler.</span>
<span class="cm"> * Jean II */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span>		<span class="n">airo_private_handler</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="nb">NULL</span><span class="p">,</span>				<span class="cm">/* SIOCIWFIRSTPRIV */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span>	<span class="n">airo_handler_def</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">num_standard</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">airo_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">airo_private_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">num_private_args</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">airo_private_args</span><span class="p">),</span>
	<span class="p">.</span><span class="n">standard</span>	<span class="o">=</span> <span class="n">airo_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private</span>	<span class="o">=</span> <span class="n">airo_private_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">private_args</span>	<span class="o">=</span> <span class="n">airo_private_args</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">airo_get_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This defines the configuration part of the Wireless Extensions</span>
<span class="cm"> * Note : irq and spinlock protection will occur in the subroutines</span>
<span class="cm"> *</span>
<span class="cm"> * TODO :</span>
<span class="cm"> *	o Check input value more carefully and fill correct values in range</span>
<span class="cm"> *	o Test and shakeout the bugs (if any)</span>
<span class="cm"> *</span>
<span class="cm"> * Jean II</span>
<span class="cm"> *</span>
<span class="cm"> * Javier Achirica did a great job of merging code from the unnamed CISCO</span>
<span class="cm"> * developer that added support for flashing the card.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">airo_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">event</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CISCO_EXT</span>
	<span class="k">case</span> <span class="n">AIROIDIFC</span>:
<span class="cp">#ifdef AIROOLDIDIFC</span>
	<span class="k">case</span> <span class="n">AIROOLDIDIFC</span>:
<span class="cp">#endif</span>
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="n">AIROMAGIC</span><span class="p">;</span>
		<span class="n">aironet_ioctl</span> <span class="n">com</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">com</span><span class="p">,</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">com</span><span class="p">)))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">data</span><span class="p">,(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">val</span><span class="p">)))</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIROIOCTL</span>:
<span class="cp">#ifdef AIROOLDIOCTL</span>
	<span class="k">case</span> <span class="n">AIROOLDIOCTL</span>:
<span class="cp">#endif</span>
		<span class="cm">/* Get the command struct and hand it off for evaluation by</span>
<span class="cm">		 * the proper subfunction</span>
<span class="cm">		 */</span>
	<span class="p">{</span>
		<span class="n">aironet_ioctl</span> <span class="n">com</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">com</span><span class="p">,</span><span class="n">rq</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">com</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Separate R/W functions bracket legality here</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span> <span class="n">com</span><span class="p">.</span><span class="n">command</span> <span class="o">==</span> <span class="n">AIRORSWVERSION</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">com</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">swversion</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">swversion</span><span class="p">)))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">com</span><span class="p">.</span><span class="n">command</span> <span class="o">&lt;=</span> <span class="n">AIRORRID</span><span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">readrids</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">com</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">com</span><span class="p">.</span><span class="n">command</span> <span class="o">&gt;=</span> <span class="n">AIROPCAP</span> <span class="o">&amp;&amp;</span> <span class="n">com</span><span class="p">.</span><span class="n">command</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">AIROPLEAPUSR</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">writerids</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">com</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">com</span><span class="p">.</span><span class="n">command</span> <span class="o">&gt;=</span> <span class="n">AIROFLSHRST</span> <span class="o">&amp;&amp;</span> <span class="n">com</span><span class="p">.</span><span class="n">command</span> <span class="o">&lt;=</span> <span class="n">AIRORESTART</span> <span class="p">)</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">flashcard</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">com</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>      <span class="cm">/* Bad command in ioctl */</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CISCO_EXT */</span><span class="cp"></span></pre></div></td></tr>


<tr id="section-47"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-47">&#182;</a></div><p>All other calls are currently unsupported</p></td><td class="code"><div class="highlight"><pre>	<span class="nl">default:</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the Wireless stats out of the driver</span>
<span class="cm"> * Note : irq and spinlock protection will occur in the subroutines</span>
<span class="cm"> *</span>
<span class="cm"> * TODO :</span>
<span class="cm"> *	o Check if work in Ad-Hoc mode (otherwise, use SPY, as in wvlan_cs)</span>
<span class="cm"> *</span>
<span class="cm"> * Jean</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">airo_read_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">StatusRid</span> <span class="n">status_rid</span><span class="p">;</span>
	<span class="n">StatsRid</span> <span class="n">stats_rid</span><span class="p">;</span>
	<span class="n">CapabilityRid</span> <span class="n">cap_rid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">vals</span> <span class="o">=</span> <span class="n">stats_rid</span><span class="p">.</span><span class="n">vals</span><span class="p">;</span>

	<span class="cm">/* Get stats out of the card */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">JOB_WSTATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">readCapabilityRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">readStatusRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">readStatsRid</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats_rid</span><span class="p">,</span> <span class="n">RID_STATS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">);</span>

	<span class="cm">/* The status */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>

	<span class="cm">/* Signal quality and co */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span>
			<span class="n">airo_rssi_to_dbm</span><span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">,</span>
					 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">sigQuality</span><span class="p">));</span>
		<span class="cm">/* normalizedSignalStrength appears to be a percentage */</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">normalizedSignalStrength</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">level</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">normalizedSignalStrength</span><span class="p">)</span> <span class="o">+</span> <span class="mi">321</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">qual</span> <span class="o">=</span> <span class="n">airo_get_quality</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status_rid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cap_rid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">status_rid</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">124</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mh">0x100</span> <span class="o">-</span> <span class="n">status_rid</span><span class="p">.</span><span class="n">noisedBm</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_ALL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">noise</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">qual</span><span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">IW_QUAL_QUAL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_LEVEL_UPDATED</span> <span class="o">|</span> <span class="n">IW_QUAL_NOISE_INVALID</span> <span class="o">|</span> <span class="n">IW_QUAL_DBM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Packets discarded in the wireless adapter due to wireless</span>
<span class="cm">	 * specific problems */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">nwid</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">56</span><span class="p">])</span> <span class="o">+</span>
				     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">57</span><span class="p">])</span> <span class="o">+</span>
				     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">58</span><span class="p">]);</span> <span class="cm">/* SSID Mismatch */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span><span class="cm">/* RxWepErr */</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">fragment</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">30</span><span class="p">]);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
				     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">32</span><span class="p">]);</span>
	<span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">.</span><span class="n">miss</span><span class="p">.</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="mi">34</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">airo_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">local</span> <span class="o">=</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">JOB_WSTATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Get stats out of the card if available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">down_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">sem</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">JOB_WSTATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">jobs</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">thr_wait</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">airo_read_wireless_stats</span><span class="p">(</span><span class="n">local</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CISCO_EXT</span>
<span class="cm">/*</span>
<span class="cm"> * This just translates from driver IOCTL codes to the command codes to</span>
<span class="cm"> * feed to the radio&#39;s host interface. Things can be added/deleted</span>
<span class="cm"> * as needed.  This represents the READ side of control I/O to</span>
<span class="cm"> * the card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">readrids</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">aironet_ioctl</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ridcode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iobuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_FLASHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">AIROGCAP</span>:      <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_CAPABILITIES</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGCFG</span>:      <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_CONFIG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">disable_MAC</span> <span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">writeConfigRid</span> <span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGSLIST</span>:    <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_SSID</span><span class="p">;</span>         <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGVLIST</span>:    <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_APLIST</span><span class="p">;</span>       <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGDRVNAM</span>:   <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_DRVNAME</span><span class="p">;</span>      <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGEHTENC</span>:   <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_ETHERENCAP</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGWEPKTMP</span>:  <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_WEP_TEMP</span><span class="p">;</span>
		<span class="cm">/* Only super-user can read WEP keys */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGWEPKNV</span>:   <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_WEP_PERM</span><span class="p">;</span>
		<span class="cm">/* Only super-user can read WEP keys */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGSTAT</span>:     <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_STATUS</span><span class="p">;</span>       <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGSTATSD32</span>: <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_STATSDELTA</span><span class="p">;</span>   <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGSTATSC32</span>: <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_STATS</span><span class="p">;</span>        <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROGMICSTATS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">,</span>
				 <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">))))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIRORRID</span>:      <span class="n">ridcode</span> <span class="o">=</span> <span class="n">comp</span><span class="o">-&gt;</span><span class="n">ridnum</span><span class="p">;</span>     <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">iobuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">RIDSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">ridcode</span><span class="p">,</span><span class="n">iobuf</span><span class="p">,</span><span class="n">RIDSIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* get the count of bytes in the rid  docs say 1st 2 bytes is it.</span>
<span class="cm">	 * then return it to the user</span>
<span class="cm">	 * 9/22/2000 Honor user given length</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">iobuf</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">RIDSIZE</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">iobuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">iobuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Danger Will Robinson write the rids here</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">writerids</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">aironet_ioctl</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">ridcode</span><span class="p">;</span>
        <span class="kt">int</span>  <span class="n">enabled</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span> <span class="n">writer</span><span class="p">)(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iobuf</span><span class="p">;</span>

	<span class="cm">/* Only super-user can write RIDs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_FLASHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">ridcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">writer</span> <span class="o">=</span> <span class="n">do_writerid</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">AIROPSIDS</span>:     <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_SSID</span><span class="p">;</span>         <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPCAP</span>:      <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_CAPABILITIES</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPAPLIST</span>:   <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_APLIST</span><span class="p">;</span>       <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPCFG</span>: <span class="n">ai</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			    <span class="n">clear_bit</span><span class="p">(</span><span class="n">FLAG_COMMIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			    <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_CONFIG</span><span class="p">;</span>       <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPWEPKEYNV</span>: <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_WEP_PERM</span><span class="p">;</span>     <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPLEAPUSR</span>:  <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_LEAPUSERNAME</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPLEAPPWD</span>:  <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_LEAPPASSWORD</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPWEPKEY</span>:   <span class="n">ridcode</span> <span class="o">=</span> <span class="n">RID_WEP_TEMP</span><span class="p">;</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">PC4500_writerid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPLEAPUSR</span><span class="o">+</span><span class="mi">1</span>: <span class="n">ridcode</span> <span class="o">=</span> <span class="mh">0xFF2A</span><span class="p">;</span>          <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">AIROPLEAPUSR</span><span class="o">+</span><span class="mi">2</span>: <span class="n">ridcode</span> <span class="o">=</span> <span class="mh">0xFF2B</span><span class="p">;</span>          <span class="k">break</span><span class="p">;</span>

		<span class="cm">/* this is not really a rid but a command given to the card</span>
<span class="cm">		 * same with MAC off</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">AIROPMACON</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">enable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Evidently this code in the airo driver does not get a symbol</span>
<span class="cm">		 * as disable_MAC. it&#39;s probably so short the compiler does not gen one.</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">AIROPMACOFF</span>:
		<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* This command merely clears the counts does not actually store any data</span>
<span class="cm">		 * only reads rid. But as it changes the cards state, I put it in the</span>
<span class="cm">		 * writerid routines.</span>
<span class="cm">		 */</span>
	<span class="k">case</span> <span class="n">AIROPSTCLR</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">iobuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">RIDSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">PC4500_readrid</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">RID_STATSDELTACLEAR</span><span class="p">,</span><span class="n">iobuf</span><span class="p">,</span><span class="n">RIDSIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">enabled</span> <span class="o">=</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">));</span>
		<span class="n">ai</span><span class="o">-&gt;</span><span class="n">micstats</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">iobuf</span><span class="p">,</span>
				 <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">RIDSIZE</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">kfree</span> <span class="p">(</span><span class="n">iobuf</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">iobuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>	<span class="cm">/* Blarg! */</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">RIDSIZE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">iobuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">RIDSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">iobuf</span><span class="p">,</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">iobuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">command</span> <span class="o">==</span> <span class="n">AIROPCFG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ConfigRid</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">ConfigRid</span> <span class="o">*</span><span class="p">)</span><span class="n">iobuf</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MIC_CAPABLE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">|=</span> <span class="n">MODE_MIC</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">&amp;</span> <span class="n">MODE_CFG_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">MODE_STA_IBSS</span><span class="p">)</span>
			<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_ADHOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_ADHOC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">((</span><span class="o">*</span><span class="n">writer</span><span class="p">)(</span><span class="n">ai</span><span class="p">,</span> <span class="n">ridcode</span><span class="p">,</span> <span class="n">iobuf</span><span class="p">,</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span> <span class="p">(</span><span class="n">iobuf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kfree</span> <span class="p">(</span><span class="n">iobuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> * Ancillary flash / mod functions much black magic lurkes here              *</span>
<span class="cm"> *****************************************************************************</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Flash command switch table</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flashcard</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">aironet_ioctl</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">z</span><span class="p">;</span>

	<span class="cm">/* Only super-user can modify flash */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">)</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">AIROFLSHRST</span>:
		<span class="k">return</span> <span class="n">cmdreset</span><span class="p">((</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">AIROFLSHSTFL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AIRO_FLASH</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">AIRO_FLASH</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">FLASHSIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">setflashmode</span><span class="p">((</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">AIROFLSHGCHR</span>: <span class="cm">/* Get char from aux */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">z</span><span class="p">,</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">flashgchar</span><span class="p">((</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">AIROFLSHPCHR</span>: <span class="cm">/* Send char to card. */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">z</span><span class="p">,</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">flashpchar</span><span class="p">((</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="mi">8000</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">AIROFLPUTBUF</span>: <span class="cm">/* Send 32k to card */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">AIRO_FLASH</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">FLASHSIZE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">AIRO_FLASH</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">comp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">comp</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="n">flashputbuf</span><span class="p">((</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AIRORESTART</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">flashrestart</span><span class="p">((</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ml_priv</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define FLASH_COMMAND  0x7e7e</span>

<span class="cm">/*</span>
<span class="cm"> * STEP 1)</span>
<span class="cm"> * Disable MAC and do soft reset on</span>
<span class="cm"> * card.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cmdreset</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">disable_MAC</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">waitbusy</span> <span class="p">(</span><span class="n">ai</span><span class="p">)){</span>
		<span class="n">airo_print_info</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Waitbusy hang before RESET&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">COMMAND</span><span class="p">,</span><span class="n">CMD_SOFTRESET</span><span class="p">);</span>

	<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>			<span class="cm">/* WAS 600 12/7/00 */</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">waitbusy</span> <span class="p">(</span><span class="n">ai</span><span class="p">)){</span>
		<span class="n">airo_print_info</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Waitbusy hang AFTER RESET&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* STEP 2)</span>
<span class="cm"> * Put the card in legendary flash</span>
<span class="cm"> * mode</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setflashmode</span> <span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">set_bit</span> <span class="p">(</span><span class="n">FLAG_FLASHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SWS0</span><span class="p">,</span> <span class="n">FLASH_COMMAND</span><span class="p">);</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SWS1</span><span class="p">,</span> <span class="n">FLASH_COMMAND</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">probe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SWS0</span><span class="p">,</span> <span class="n">FLASH_COMMAND</span><span class="p">);</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span><span class="mh">0x10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SWS2</span><span class="p">,</span> <span class="n">FLASH_COMMAND</span><span class="p">);</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SWS3</span><span class="p">,</span> <span class="n">FLASH_COMMAND</span><span class="p">);</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">COMMAND</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>		<span class="cm">/* 500ms delay */</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">waitbusy</span><span class="p">(</span><span class="n">ai</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_FLASHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">airo_print_info</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Waitbusy hang after setflash mode&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Put character to SWS0 wait for dwelltime</span>
<span class="cm"> * x 50us for  echo .</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">flashpchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span><span class="kt">int</span> <span class="n">byte</span><span class="p">,</span><span class="kt">int</span> <span class="n">dwelltime</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">echo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">waittime</span><span class="p">;</span>

	<span class="n">byte</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">dwelltime</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">dwelltime</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

	<span class="n">waittime</span><span class="o">=</span><span class="n">dwelltime</span><span class="p">;</span>

	<span class="cm">/* Wait for busy bit d15 to go false indicating buffer empty */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">IN4500</span> <span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">SWS0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">waittime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span> <span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">waittime</span> <span class="o">-=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* timeout for busy clear wait */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">waittime</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">){</span>
		<span class="n">airo_print_info</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;flash putchar busywait timeout!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Port is clear now write byte and wait for it to echo back */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">SWS0</span><span class="p">,</span><span class="n">byte</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">dwelltime</span> <span class="o">-=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="n">echo</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">SWS1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">dwelltime</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">echo</span> <span class="o">!=</span> <span class="n">byte</span><span class="p">);</span>

	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">SWS1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">echo</span> <span class="o">==</span> <span class="n">byte</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a character from the card matching matchbyte</span>
<span class="cm"> * Step 3)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flashgchar</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span><span class="kt">int</span> <span class="n">matchbyte</span><span class="p">,</span><span class="kt">int</span> <span class="n">dwelltime</span><span class="p">){</span>
	<span class="kt">int</span>           <span class="n">rchar</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rbyte</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">rchar</span> <span class="o">=</span> <span class="n">IN4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">SWS1</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="n">dwelltime</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">rchar</span><span class="p">)){</span>
			<span class="n">dwelltime</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rbyte</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">rchar</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">rbyte</span> <span class="o">==</span> <span class="n">matchbyte</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="mh">0x8000</span> <span class="o">&amp;</span> <span class="n">rchar</span><span class="p">)</span> <span class="p">){</span>
			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">SWS1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">rbyte</span> <span class="o">==</span> <span class="mh">0x81</span> <span class="o">||</span> <span class="n">rbyte</span> <span class="o">==</span> <span class="mh">0x82</span> <span class="o">||</span> <span class="n">rbyte</span> <span class="o">==</span> <span class="mh">0x83</span> <span class="o">||</span> <span class="n">rbyte</span> <span class="o">==</span> <span class="mh">0x1a</span> <span class="o">||</span> <span class="mh">0xffff</span> <span class="o">==</span> <span class="n">rchar</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">SWS1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="n">dwelltime</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Transfer 32k of firmware data from user buffer to our buffer and</span>
<span class="cm"> * send to the card</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">flashputbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">){</span>
	<span class="kt">int</span>            <span class="n">nwords</span><span class="p">;</span>

	<span class="cm">/* Write stuff */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">pciaux</span> <span class="o">+</span> <span class="mh">0x8000</span><span class="p">,</span> <span class="n">ai</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">,</span> <span class="n">FLASHSIZE</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">AUXPAGE</span><span class="p">,</span><span class="mh">0x100</span><span class="p">);</span>
		<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">AUXOFF</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

		<span class="k">for</span><span class="p">(</span><span class="n">nwords</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">nwords</span> <span class="o">!=</span> <span class="n">FLASHSIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span><span class="n">nwords</span><span class="o">++</span><span class="p">){</span>
			<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">AUXDATA</span><span class="p">,</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flash</span><span class="p">[</span><span class="n">nwords</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">OUT4500</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span><span class="n">SWS0</span><span class="p">,</span><span class="mh">0x8000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">flashrestart</span><span class="p">(</span><span class="k">struct</span> <span class="n">airo_info</span> <span class="o">*</span><span class="n">ai</span><span class="p">,</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">){</span>
	<span class="kt">int</span>    <span class="n">i</span><span class="p">,</span><span class="n">status</span><span class="p">;</span>

	<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>			<span class="cm">/* Added 12/7/00 */</span>
	<span class="n">clear_bit</span> <span class="p">(</span><span class="n">FLAG_FLASHING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">mpi_init_descriptors</span><span class="p">(</span><span class="n">ai</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SUCCESS</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">setup_card</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">FLAG_MPI</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ai</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FIDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">ai</span><span class="o">-&gt;</span><span class="n">fids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">transmit_allocate</span>
				<span class="p">(</span> <span class="n">ai</span><span class="p">,</span> <span class="n">AIRO_DEF_MTU</span><span class="p">,</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">MAX_FIDS</span> <span class="o">/</span> <span class="mi">2</span> <span class="p">);</span>
		<span class="p">}</span>

	<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>			<span class="cm">/* Added 12/7/00 */</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CISCO_EXT */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm">    This program is free software; you can redistribute it and/or</span>
<span class="cm">    modify it under the terms of the GNU General Public License</span>
<span class="cm">    as published by the Free Software Foundation; either version 2</span>
<span class="cm">    of the License, or (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    In addition:</span>

<span class="cm">    Redistribution and use in source and binary forms, with or without</span>
<span class="cm">    modification, are permitted provided that the following conditions</span>
<span class="cm">    are met:</span>

<span class="cm">    1. Redistributions of source code must retain the above copyright</span>
<span class="cm">       notice, this list of conditions and the following disclaimer.</span>
<span class="cm">    2. Redistributions in binary form must reproduce the above copyright</span>
<span class="cm">       notice, this list of conditions and the following disclaimer in the</span>
<span class="cm">       documentation and/or other materials provided with the distribution.</span>
<span class="cm">    3. The name of the author may not be used to endorse or promote</span>
<span class="cm">       products derived from this software without specific prior written</span>
<span class="cm">       permission.</span>

<span class="cm">    THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS&#39;&#39; AND ANY EXPRESS OR</span>
<span class="cm">    IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="cm">    WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
<span class="cm">    ARE DISCLAIMED. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT,</span>
<span class="cm">    INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES</span>
<span class="cm">    (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR</span>
<span class="cm">    SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
<span class="cm">    HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,</span>
<span class="cm">    STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING</span>
<span class="cm">    IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</span>
<span class="cm">    POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm">*/</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">airo_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">airo_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
