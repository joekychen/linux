<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › zd1211rw › zd_rf_rf2959.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>zd_rf_rf2959.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* ZD1211 USB-WLAN driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2007 Ulrich Kunitz &lt;kune@deine-taler.de&gt;</span>
<span class="cm"> * Copyright (C) 2006-2007 Daniel Drake &lt;dsd@gentoo.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>

<span class="cp">#include &quot;zd_rf.h&quot;</span>
<span class="cp">#include &quot;zd_usb.h&quot;</span>
<span class="cp">#include &quot;zd_chip.h&quot;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">rf2959_table</span><span class="p">[][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x181979</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x181989</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">3</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x181999</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1819a9</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">5</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1819b9</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">6</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1819c9</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">7</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1819d9</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">8</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1819e9</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span> <span class="mi">9</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x1819f9</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x181a09</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x181a19</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x181a29</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x181a39</span><span class="p">,</span> <span class="mh">0x1e6666</span> <span class="p">},</span>
	<span class="n">RF_CHANNEL</span><span class="p">(</span><span class="mi">14</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x181a60</span><span class="p">,</span> <span class="mh">0x1c0000</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int bits(u32 rw, int from, int to)</span>
<span class="c">{</span>
<span class="c">	rw &amp;= ~(0xffffffffU &lt;&lt; (to+1));</span>
<span class="c">	rw &gt;&gt;= from;</span>
<span class="c">	return rw;</span>
<span class="c">}</span>

<span class="c">static int bit(u32 rw, int bit)</span>
<span class="c">{</span>
<span class="c">	return bits(rw, bit, bit);</span>
<span class="c">}</span>

<span class="c">static void dump_regwrite(u32 rw)</span>
<span class="c">{</span>
<span class="c">	int reg = bits(rw, 18, 22);</span>
<span class="c">	int rw_flag = bits(rw, 23, 23);</span>
<span class="c">	PDEBUG(&quot;rf2959 %#010x reg %d rw %d&quot;, rw, reg, rw_flag);</span>

<span class="c">	switch (reg) {</span>
<span class="c">	case 0:</span>
<span class="c">		PDEBUG(&quot;reg0 CFG1 ref_sel %d hybernate %d rf_vco_reg_en %d&quot;</span>
<span class="c">		       &quot; if_vco_reg_en %d if_vga_en %d&quot;,</span>
<span class="c">		       bits(rw, 14, 15), bit(rw, 3), bit(rw, 2), bit(rw, 1),</span>
<span class="c">		       bit(rw, 0));</span>
<span class="c">		break;</span>
<span class="c">	case 1:</span>
<span class="c">		PDEBUG(&quot;reg1 IFPLL1 pll_en1 %d kv_en1 %d vtc_en1 %d lpf1 %d&quot;</span>
<span class="c">		       &quot; cpl1 %d pdp1 %d autocal_en1 %d ld_en1 %d ifloopr %d&quot;</span>
<span class="c">		       &quot; ifloopc %d dac1 %d&quot;,</span>
<span class="c">		       bit(rw, 17), bit(rw, 16), bit(rw, 15), bit(rw, 14),</span>
<span class="c">		       bit(rw, 13), bit(rw, 12), bit(rw, 11), bit(rw, 10),</span>
<span class="c">		       bits(rw, 7, 9), bits(rw, 4, 6), bits(rw, 0, 3));</span>
<span class="c">		break;</span>
<span class="c">	case 2:</span>
<span class="c">		PDEBUG(&quot;reg2 IFPLL2 n1 %d num1 %d&quot;,</span>
<span class="c">		       bits(rw, 6, 17), bits(rw, 0, 5));</span>
<span class="c">		break;</span>
<span class="c">	case 3:</span>
<span class="c">		PDEBUG(&quot;reg3 IFPLL3 num %d&quot;, bits(rw, 0, 17));</span>
<span class="c">		break;</span>
<span class="c">	case 4:</span>
<span class="c">		PDEBUG(&quot;reg4 IFPLL4 dn1 %#04x ct_def1 %d kv_def1 %d&quot;,</span>
<span class="c">		       bits(rw, 8, 16), bits(rw, 4, 7), bits(rw, 0, 3));</span>
<span class="c">		break;</span>
<span class="c">	case 5:</span>
<span class="c">		PDEBUG(&quot;reg5 RFPLL1 pll_en %d kv_en %d vtc_en %d lpf %d cpl %d&quot;</span>
<span class="c">		       &quot; pdp %d autocal_en %d ld_en %d rfloopr %d rfloopc %d&quot;</span>
<span class="c">		       &quot; dac %d&quot;,</span>
<span class="c">		       bit(rw, 17), bit(rw, 16), bit(rw, 15), bit(rw, 14),</span>
<span class="c">		       bit(rw, 13), bit(rw, 12), bit(rw, 11), bit(rw, 10),</span>
<span class="c">		       bits(rw, 7, 9), bits(rw, 4, 6), bits(rw, 0,3));</span>
<span class="c">		break;</span>
<span class="c">	case 6:</span>
<span class="c">		PDEBUG(&quot;reg6 RFPLL2 n %d num %d&quot;,</span>
<span class="c">		       bits(rw, 6, 17), bits(rw, 0, 5));</span>
<span class="c">		break;</span>
<span class="c">	case 7:</span>
<span class="c">		PDEBUG(&quot;reg7 RFPLL3 num2 %d&quot;, bits(rw, 0, 17));</span>
<span class="c">		break;</span>
<span class="c">	case 8:</span>
<span class="c">		PDEBUG(&quot;reg8 RFPLL4 dn %#06x ct_def %d kv_def %d&quot;,</span>
<span class="c">		       bits(rw, 8, 16), bits(rw, 4, 7), bits(rw, 0, 3));</span>
<span class="c">		break;</span>
<span class="c">	case 9:</span>
<span class="c">		PDEBUG(&quot;reg9 CAL1 tvco %d tlock %d m_ct_value %d ld_window %d&quot;,</span>
<span class="c">		       bits(rw, 13, 17), bits(rw, 8, 12), bits(rw, 3, 7),</span>
<span class="c">		       bits(rw, 0, 2));</span>
<span class="c">		break;</span>
<span class="c">	case 10:</span>
<span class="c">		PDEBUG(&quot;reg10 TXRX1 rxdcfbbyps %d pcontrol %d txvgc %d&quot;</span>
<span class="c">		       &quot; rxlpfbw %d txlpfbw %d txdiffmode %d txenmode %d&quot;</span>
<span class="c">		       &quot; intbiasen %d tybypass %d&quot;,</span>
<span class="c">		       bit(rw, 17), bits(rw, 15, 16), bits(rw, 10, 14),</span>
<span class="c">		       bits(rw, 7, 9), bits(rw, 4, 6), bit(rw, 3), bit(rw, 2),</span>
<span class="c">		       bit(rw, 1), bit(rw, 0));</span>
<span class="c">		break;</span>
<span class="c">	case 11:</span>
<span class="c">		PDEBUG(&quot;reg11 PCNT1 mid_bias %d p_desired %d pc_offset %d&quot;</span>
<span class="c">			&quot; tx_delay %d&quot;,</span>
<span class="c">			bits(rw, 15, 17), bits(rw, 9, 14), bits(rw, 3, 8),</span>
<span class="c">			bits(rw, 0, 2));</span>
<span class="c">		break;</span>
<span class="c">	case 12:</span>
<span class="c">		PDEBUG(&quot;reg12 PCNT2 max_power %d mid_power %d min_power %d&quot;,</span>
<span class="c">		       bits(rw, 12, 17), bits(rw, 6, 11), bits(rw, 0, 5));</span>
<span class="c">		break;</span>
<span class="c">	case 13:</span>
<span class="c">		PDEBUG(&quot;reg13 VCOT1 rfpll vco comp %d ifpll vco comp %d&quot;</span>
<span class="c">		       &quot; lobias %d if_biasbuf %d if_biasvco %d rf_biasbuf %d&quot;</span>
<span class="c">		       &quot; rf_biasvco %d&quot;,</span>
<span class="c">		       bit(rw, 17), bit(rw, 16), bit(rw, 15),</span>
<span class="c">		       bits(rw, 8, 9), bits(rw, 5, 7), bits(rw, 3, 4),</span>
<span class="c">		       bits(rw, 0, 2));</span>
<span class="c">		break;</span>
<span class="c">	case 14:</span>
<span class="c">		PDEBUG(&quot;reg14 IQCAL rx_acal %d rx_pcal %d&quot;</span>
<span class="c">		       &quot; tx_acal %d tx_pcal %d&quot;,</span>
<span class="c">		       bits(rw, 13, 17), bits(rw, 9, 12), bits(rw, 4, 8),</span>
<span class="c">		       bits(rw, 0, 3));</span>
<span class="c">		break;</span>
<span class="c">	}</span>
<span class="c">}</span>
<span class="cp">#endif /* 0 */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rf2959_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_rf</span> <span class="o">*</span><span class="n">rf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">zd_rf_to_chip</span><span class="p">(</span><span class="n">rf</span><span class="p">);</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zd_ioreq16</span> <span class="n">ioreqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ZD_CR2</span><span class="p">,</span>   <span class="mh">0x1E</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR9</span><span class="p">,</span>   <span class="mh">0x20</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR10</span><span class="p">,</span>  <span class="mh">0x89</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR11</span><span class="p">,</span>  <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR15</span><span class="p">,</span>  <span class="mh">0xD0</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR17</span><span class="p">,</span>  <span class="mh">0x68</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR19</span><span class="p">,</span>  <span class="mh">0x4a</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR20</span><span class="p">,</span>  <span class="mh">0x0c</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR21</span><span class="p">,</span>  <span class="mh">0x0E</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR23</span><span class="p">,</span>  <span class="mh">0x48</span> <span class="p">},</span>
		<span class="cm">/* normal size for cca threshold */</span>
		<span class="p">{</span> <span class="n">ZD_CR24</span><span class="p">,</span>  <span class="mh">0x14</span> <span class="p">},</span>
		<span class="cm">/* { ZD_CR24,  0x20 }, */</span>
		<span class="p">{</span> <span class="n">ZD_CR26</span><span class="p">,</span>  <span class="mh">0x90</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR27</span><span class="p">,</span>  <span class="mh">0x30</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR29</span><span class="p">,</span>  <span class="mh">0x20</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR31</span><span class="p">,</span>  <span class="mh">0xb2</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR32</span><span class="p">,</span>  <span class="mh">0x43</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR33</span><span class="p">,</span>  <span class="mh">0x28</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR38</span><span class="p">,</span>  <span class="mh">0x30</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR34</span><span class="p">,</span>  <span class="mh">0x0f</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR35</span><span class="p">,</span>  <span class="mh">0xF0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR41</span><span class="p">,</span>  <span class="mh">0x2a</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR46</span><span class="p">,</span>  <span class="mh">0x7F</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR47</span><span class="p">,</span>  <span class="mh">0x1E</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR51</span><span class="p">,</span>  <span class="mh">0xc5</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR52</span><span class="p">,</span>  <span class="mh">0xc5</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR53</span><span class="p">,</span>  <span class="mh">0xc5</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR79</span><span class="p">,</span>  <span class="mh">0x58</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR80</span><span class="p">,</span>  <span class="mh">0x30</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR81</span><span class="p">,</span>  <span class="mh">0x30</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR82</span><span class="p">,</span>  <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR83</span><span class="p">,</span>  <span class="mh">0x24</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR84</span><span class="p">,</span>  <span class="mh">0x04</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR85</span><span class="p">,</span>  <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR86</span><span class="p">,</span>  <span class="mh">0x10</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR87</span><span class="p">,</span>  <span class="mh">0x2A</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR88</span><span class="p">,</span>  <span class="mh">0x10</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR89</span><span class="p">,</span>  <span class="mh">0x24</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR90</span><span class="p">,</span>  <span class="mh">0x18</span> <span class="p">},</span>
		<span class="cm">/* { ZD_CR91,  0x18 }, */</span>
		<span class="cm">/* should solve continuous CTS frame problems */</span>
		<span class="p">{</span> <span class="n">ZD_CR91</span><span class="p">,</span>  <span class="mh">0x00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR92</span><span class="p">,</span>  <span class="mh">0x0a</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR93</span><span class="p">,</span>  <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR94</span><span class="p">,</span>  <span class="mh">0x01</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR95</span><span class="p">,</span>  <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR96</span><span class="p">,</span>  <span class="mh">0x40</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR97</span><span class="p">,</span>  <span class="mh">0x37</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR98</span><span class="p">,</span>  <span class="mh">0x05</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR99</span><span class="p">,</span>  <span class="mh">0x28</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR100</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR101</span><span class="p">,</span> <span class="mh">0x13</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR102</span><span class="p">,</span> <span class="mh">0x27</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR103</span><span class="p">,</span> <span class="mh">0x27</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR104</span><span class="p">,</span> <span class="mh">0x18</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR105</span><span class="p">,</span> <span class="mh">0x12</span> <span class="p">},</span>
		<span class="cm">/* normal size */</span>
		<span class="p">{</span> <span class="n">ZD_CR106</span><span class="p">,</span> <span class="mh">0x1a</span> <span class="p">},</span>
		<span class="cm">/* { ZD_CR106, 0x22 }, */</span>
		<span class="p">{</span> <span class="n">ZD_CR107</span><span class="p">,</span> <span class="mh">0x24</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR108</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR109</span><span class="p">,</span> <span class="mh">0x13</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR110</span><span class="p">,</span> <span class="mh">0x2F</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR111</span><span class="p">,</span> <span class="mh">0x27</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR112</span><span class="p">,</span> <span class="mh">0x27</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR113</span><span class="p">,</span> <span class="mh">0x27</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR114</span><span class="p">,</span> <span class="mh">0x27</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR115</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR116</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR117</span><span class="p">,</span> <span class="mh">0xF0</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR118</span><span class="p">,</span> <span class="mh">0xF0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR119</span><span class="p">,</span> <span class="mh">0x16</span> <span class="p">},</span>
		<span class="cm">/* no TX continuation */</span>
		<span class="p">{</span> <span class="n">ZD_CR122</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
		<span class="cm">/* { ZD_CR122, 0xff }, */</span>
		<span class="p">{</span> <span class="n">ZD_CR127</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR131</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR138</span><span class="p">,</span> <span class="mh">0x28</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR148</span><span class="p">,</span> <span class="mh">0x44</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR150</span><span class="p">,</span> <span class="mh">0x10</span> <span class="p">},</span> <span class="p">{</span> <span class="n">ZD_CR169</span><span class="p">,</span> <span class="mh">0xBB</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR170</span><span class="p">,</span> <span class="mh">0xBB</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">rv</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x000007</span><span class="p">,</span>  <span class="cm">/* REG0(CFG1) */</span>
		<span class="mh">0x07dd43</span><span class="p">,</span>  <span class="cm">/* REG1(IFPLL1) */</span>
		<span class="mh">0x080959</span><span class="p">,</span>  <span class="cm">/* REG2(IFPLL2) */</span>
		<span class="mh">0x0e6666</span><span class="p">,</span>
		<span class="mh">0x116a57</span><span class="p">,</span>  <span class="cm">/* REG4 */</span>
		<span class="mh">0x17dd43</span><span class="p">,</span>  <span class="cm">/* REG5 */</span>
		<span class="mh">0x1819f9</span><span class="p">,</span>  <span class="cm">/* REG6 */</span>
		<span class="mh">0x1e6666</span><span class="p">,</span>
		<span class="mh">0x214554</span><span class="p">,</span>
		<span class="mh">0x25e7fa</span><span class="p">,</span>
		<span class="mh">0x27fffa</span><span class="p">,</span>
		<span class="cm">/* The Zydas driver somehow forgets to set this value. It&#39;s</span>
<span class="cm">		 * only set for Japan. We are using internal power control</span>
<span class="cm">		 * for now.</span>
<span class="cm">		 */</span>
		<span class="mh">0x294128</span><span class="p">,</span> <span class="cm">/* internal power */</span>
		<span class="cm">/* 0x28252c, */</span> <span class="cm">/* External control TX power */</span>
		<span class="cm">/* ZD_CR31_CCK, ZD_CR51_6-36M, ZD_CR52_48M, ZD_CR53_54M */</span>
		<span class="mh">0x2c0000</span><span class="p">,</span>
		<span class="mh">0x300000</span><span class="p">,</span>
		<span class="mh">0x340000</span><span class="p">,</span>  <span class="cm">/* REG13(0xD) */</span>
		<span class="mh">0x381e0f</span><span class="p">,</span>  <span class="cm">/* REG14(0xE) */</span>
		<span class="cm">/* Bogus, RF2959&#39;s data sheet doesn&#39;t know register 27, which is</span>
<span class="cm">		 * actually referenced here. The commented 0x11 is 17.</span>
<span class="cm">		 */</span>
		<span class="mh">0x6c180f</span><span class="p">,</span>  <span class="cm">/* REG27(0x11) */</span>
	<span class="p">};</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_iowrite16a_locked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ioreqs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioreqs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">zd_rfwritev_locked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rv</span><span class="p">),</span> <span class="n">RF_RV_BITS</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rf2959_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_rf</span> <span class="o">*</span><span class="n">rf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rv</span> <span class="o">=</span> <span class="n">rf2959_table</span><span class="p">[</span><span class="n">channel</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">zd_rf_to_chip</span><span class="p">(</span><span class="n">rf</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">zd_rfwrite_locked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">rv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RF_RV_BITS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rf2959_switch_radio_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_rf</span> <span class="o">*</span><span class="n">rf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zd_ioreq16</span> <span class="n">ioreqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ZD_CR10</span><span class="p">,</span> <span class="mh">0x89</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR11</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">zd_rf_to_chip</span><span class="p">(</span><span class="n">rf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">zd_iowrite16a_locked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ioreqs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioreqs</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rf2959_switch_radio_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_rf</span> <span class="o">*</span><span class="n">rf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">zd_ioreq16</span> <span class="n">ioreqs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ZD_CR10</span><span class="p">,</span> <span class="mh">0x15</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ZD_CR11</span><span class="p">,</span> <span class="mh">0x81</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">zd_rf_to_chip</span><span class="p">(</span><span class="n">rf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">zd_iowrite16a_locked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ioreqs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioreqs</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">zd_rf_init_rf2959</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_rf</span> <span class="o">*</span><span class="n">rf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">zd_rf_to_chip</span><span class="p">(</span><span class="n">rf</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">zd_chip_is_zd1211b</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">zd_chip_dev</span><span class="p">(</span><span class="n">chip</span><span class="p">),</span>
		       <span class="s">&quot;RF2959 is currently not supported for ZD1211B&quot;</span>
		       <span class="s">&quot; devices</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rf</span><span class="o">-&gt;</span><span class="n">init_hw</span> <span class="o">=</span> <span class="n">rf2959_init_hw</span><span class="p">;</span>
	<span class="n">rf</span><span class="o">-&gt;</span><span class="n">set_channel</span> <span class="o">=</span> <span class="n">rf2959_set_channel</span><span class="p">;</span>
	<span class="n">rf</span><span class="o">-&gt;</span><span class="n">switch_radio_on</span> <span class="o">=</span> <span class="n">rf2959_switch_radio_on</span><span class="p">;</span>
	<span class="n">rf</span><span class="o">-&gt;</span><span class="n">switch_radio_off</span> <span class="o">=</span> <span class="n">rf2959_switch_radio_off</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
