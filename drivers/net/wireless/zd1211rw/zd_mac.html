<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › zd1211rw › zd_mac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>zd_mac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* ZD1211 USB-WLAN driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2007 Ulrich Kunitz &lt;kune@deine-taler.de&gt;</span>
<span class="cm"> * Copyright (C) 2006-2007 Daniel Drake &lt;dsd@gentoo.org&gt;</span>
<span class="cm"> * Copyright (C) 2006-2007 Michael Wu &lt;flamingice@sourmilk.net&gt;</span>
<span class="cm"> * Copyright (C) 2007-2008 Luis R. Rodriguez &lt;mcgrof@winlab.rutgers.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;net/ieee80211_radiotap.h&gt;</span>

<span class="cp">#include &quot;zd_def.h&quot;</span>
<span class="cp">#include &quot;zd_chip.h&quot;</span>
<span class="cp">#include &quot;zd_mac.h&quot;</span>
<span class="cp">#include &quot;zd_rf.h&quot;</span>

<span class="k">struct</span> <span class="n">zd_reg_alpha2_map</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">alpha2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">zd_reg_alpha2_map</span> <span class="n">reg_alpha2_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">ZD_REGDOMAIN_FCC</span><span class="p">,</span> <span class="s">&quot;US&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ZD_REGDOMAIN_IC</span><span class="p">,</span> <span class="s">&quot;CA&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ZD_REGDOMAIN_ETSI</span><span class="p">,</span> <span class="s">&quot;DE&quot;</span> <span class="p">},</span> <span class="cm">/* Generic ETSI, use most restrictive */</span>
	<span class="p">{</span> <span class="n">ZD_REGDOMAIN_JAPAN</span><span class="p">,</span> <span class="s">&quot;JP&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ZD_REGDOMAIN_JAPAN_2</span><span class="p">,</span> <span class="s">&quot;JP&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ZD_REGDOMAIN_JAPAN_3</span><span class="p">,</span> <span class="s">&quot;JP&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ZD_REGDOMAIN_SPAIN</span><span class="p">,</span> <span class="s">&quot;ES&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">ZD_REGDOMAIN_FRANCE</span><span class="p">,</span> <span class="s">&quot;FR&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* This table contains the hardware specific values for the modulation rates. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">zd_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_CCK_RATE_1M</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_CCK_RATE_2M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">ZD_CCK_RATE_2M</span> <span class="o">|</span> <span class="n">ZD_CCK_PREA_SHORT</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_CCK_RATE_5_5M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">ZD_CCK_RATE_5_5M</span> <span class="o">|</span> <span class="n">ZD_CCK_PREA_SHORT</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_CCK_RATE_11M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">ZD_CCK_RATE_11M</span> <span class="o">|</span> <span class="n">ZD_CCK_PREA_SHORT</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_OFDM_RATE_6M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_OFDM_RATE_9M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_OFDM_RATE_12M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_OFDM_RATE_18M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_OFDM_RATE_24M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_OFDM_RATE_36M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_OFDM_RATE_48M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">ZD_OFDM_RATE_54M</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Zydas retry rates table. Each line is listed in the same order as</span>
<span class="cm"> * in zd_rates[] and contains all the rate used when a packet is sent</span>
<span class="cm"> * starting with a given rates. Let&#39;s consider an example :</span>
<span class="cm"> *</span>
<span class="cm"> * &quot;11 Mbits : 4, 3, 2, 1, 0&quot; means :</span>
<span class="cm"> * - packet is sent using 4 different rates</span>
<span class="cm"> * - 1st rate is index 3 (ie 11 Mbits)</span>
<span class="cm"> * - 2nd rate is index 2 (ie 5.5 Mbits)</span>
<span class="cm"> * - 3rd rate is index 1 (ie 2 Mbits)</span>
<span class="cm"> * - 4th rate is index 0 (ie 1 Mbits)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">tx_retry_rate</span> <span class="n">zd_retry_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="cm">/*  1 Mbits */</span>	<span class="mi">1</span><span class="p">,</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/*  2 Mbits */</span>	<span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/*  5.5 Mbits */</span>	<span class="mi">3</span><span class="p">,</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/* 11 Mbits */</span>	<span class="mi">4</span><span class="p">,</span> <span class="p">{</span> <span class="mi">3</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/*  6 Mbits */</span>	<span class="mi">5</span><span class="p">,</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/*  9 Mbits */</span>	<span class="mi">6</span><span class="p">,</span> <span class="p">{</span> <span class="mi">5</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/* 12 Mbits */</span>	<span class="mi">5</span><span class="p">,</span> <span class="p">{</span> <span class="mi">6</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/* 18 Mbits */</span>	<span class="mi">6</span><span class="p">,</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/* 24 Mbits */</span>	<span class="mi">6</span><span class="p">,</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span>  <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/* 36 Mbits */</span>	<span class="mi">7</span><span class="p">,</span> <span class="p">{</span> <span class="mi">9</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/* 48 Mbits */</span>	<span class="mi">8</span><span class="p">,</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span>  <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}},</span>
	<span class="p">{</span> <span class="cm">/* 54 Mbits */</span>	<span class="mi">9</span><span class="p">,</span> <span class="p">{</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">zd_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2412</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2417</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2422</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">3</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2427</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">4</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2432</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">5</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2437</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2442</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">7</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2447</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2452</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">9</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2457</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2462</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2467</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2472</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">13</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2484</span><span class="p">,</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">14</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">housekeeping_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">housekeeping_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">housekeeping_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">beacon_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">beacon_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">beacon_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_rts_cts</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">short_preamble</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">zd_mac_config_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span> <span class="n">bool</span> <span class="n">in_intr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zd_reg2alpha2</span><span class="p">(</span><span class="n">u8</span> <span class="n">regdomain</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">alpha2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zd_reg_alpha2_map</span> <span class="o">*</span><span class="n">reg_map</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">reg_alpha2_map</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg_map</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reg_alpha2_map</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">regdomain</span> <span class="o">==</span> <span class="n">reg_map</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_map</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg_map</span><span class="o">-&gt;</span><span class="n">alpha2</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zd_check_signal</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">signal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">dev_dbg_f_cond</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="n">signal</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">signal</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">,</span>
			<span class="s">&quot;%s: signal value from device not in range 0..100, &quot;</span>
			<span class="s">&quot;but %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">signal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">signal</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">signal</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
		<span class="n">signal</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">signal</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">zd_mac_preinit_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_read_mac_addr_fw</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">zd_mac_init_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">alpha2</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">default_regdomain</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_enable_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_init_hw</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_int</span><span class="p">;</span>

	<span class="n">ZD_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">irqs_disabled</span><span class="p">());</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_read_regdomain</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_regdomain</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_int</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">regdomain</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">default_regdomain</span> <span class="o">=</span> <span class="n">default_regdomain</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* We must inform the device that we are doing encryption/decryption in</span>
<span class="cm">	 * software at the moment. */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_set_encryption_type</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ENC_SNIFFER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_int</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_reg2alpha2</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">regdomain</span><span class="p">,</span> <span class="n">alpha2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_int</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">regulatory_hint</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">alpha2</span><span class="p">);</span>
<span class="nl">disable_int:</span>
	<span class="n">zd_chip_disable_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">zd_mac_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">zd_workqueue</span><span class="p">);</span>
	<span class="n">zd_chip_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">ZD_ASSERT</span><span class="p">(</span><span class="o">!</span><span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>
	<span class="n">ZD_MEMCLEAR</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rx_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">STA_RX_FILTER</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">pass_ctrl</span><span class="p">)</span>
		<span class="n">filter</span> <span class="o">|=</span> <span class="n">RX_FILTER_CTRL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">zd_iowrite32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">CR_RX_FILTER</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_mac_and_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_write_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* Vendor driver after setting MAC either sets BSSID for AP or</span>
<span class="cm">	 * filter for other modes.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">set_rx_filter</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">zd_write_bssid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_mc_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mc_hash</span> <span class="n">hash</span><span class="p">;</span>
	<span class="n">zd_mc_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hash</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">zd_chip_set_multicast_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hash</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">zd_op_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zd_usb</span> <span class="o">*</span><span class="n">usb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">usb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">zd_usb_init_hw</span><span class="p">(</span><span class="n">usb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_enable_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_set_basic_rates</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">CR_RATES_80211B</span> <span class="o">|</span> <span class="n">CR_RATES_80211G</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_int</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">set_rx_filter</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_int</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">set_mc_hash</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_int</span><span class="p">;</span>

	<span class="cm">/* Wait after setting the multicast hash table and powering on</span>
<span class="cm">	 * the radio otherwise interface bring up will fail. This matches</span>
<span class="cm">	 * what the vendor driver did.</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_switch_radio_on</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">zd_chip_dev</span><span class="p">(</span><span class="n">chip</span><span class="p">),</span>
			<span class="s">&quot;%s: failed to set radio on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">disable_int</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_enable_rxtx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_radio</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_enable_hwint</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable_rxtx</span><span class="p">;</span>

	<span class="n">housekeeping_enable</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">beacon_enable</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">ZD_DEVICE_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">disable_rxtx:</span>
	<span class="n">zd_chip_disable_rxtx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="nl">disable_radio:</span>
	<span class="n">zd_chip_switch_radio_off</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="nl">disable_int:</span>
	<span class="n">zd_chip_disable_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">zd_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">ack_wait_queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_wait_queue</span><span class="p">;</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="n">ZD_DEVICE_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* The order here deliberately is a little different from the open()</span>
<span class="cm">	 * method, since we need to make sure there is no opportunity for RX</span>
<span class="cm">	 * frames to be processed by mac80211 after we have stopped it.</span>
<span class="cm">	 */</span>

	<span class="n">zd_chip_disable_rxtx</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">beacon_disable</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">housekeeping_disable</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">zd_workqueue</span><span class="p">);</span>

	<span class="n">zd_chip_disable_hwint</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">zd_chip_switch_radio_off</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">zd_chip_disable_int</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>


	<span class="k">while</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="n">ack_wait_queue</span><span class="p">)))</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">zd_restore_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zd_mc_hash</span> <span class="n">multicast_hash</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">short_preamble</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">beacon_interval</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">multicast_hash</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">multicast_hash</span><span class="p">;</span>
	<span class="n">short_preamble</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">short_preamble</span><span class="p">;</span>
	<span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">interval</span><span class="p">;</span>
	<span class="n">beacon_period</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">set_mac_and_bssid</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;set_mac_and_bssid failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_set_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;zd_chip_set_channel failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_rts_cts</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">short_preamble</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_set_multicast_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">multicast_hash</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span>
			  <span class="s">&quot;zd_chip_set_multicast_hash failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">||</span>
	    <span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">||</span>
	    <span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="p">)</span>
				<span class="n">zd_mac_config_beacon</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">zd_set_beacon_interval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">beacon_interval</span><span class="p">,</span>
					<span class="n">beacon_period</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zd_mac_tx_status - reports tx status of a packet if required</span>
<span class="cm"> * @hw - a &amp;struct ieee80211_hw pointer</span>
<span class="cm"> * @skb - a sk-buffer</span>
<span class="cm"> * @flags: extra flags to set in the TX status info</span>
<span class="cm"> * @ackssi: ACK signal strength</span>
<span class="cm"> * @success - True for successful transmission of the frame</span>
<span class="cm"> *</span>
<span class="cm"> * This information calls ieee80211_tx_status_irqsafe() if required by the</span>
<span class="cm"> * control information. It copies the control information into the status</span>
<span class="cm"> * information.</span>
<span class="cm"> *</span>
<span class="cm"> * If no status information has been requested, the skb is freed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_mac_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">ackssi</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tx_status</span> <span class="o">*</span><span class="n">tx_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">retry</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first_idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">tx_retry_rate</span> <span class="o">*</span><span class="n">retries</span><span class="p">;</span>

	<span class="n">ieee80211_tx_info_clear_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">success</span> <span class="o">=</span> <span class="o">!</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">failure</span><span class="p">;</span>
		<span class="n">retry</span> <span class="o">=</span> <span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">+</span> <span class="n">success</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* success */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* failure */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">first_idx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
	<span class="n">ZD_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;=</span><span class="n">first_idx</span> <span class="o">&amp;&amp;</span> <span class="n">first_idx</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">zd_retry_rates</span><span class="p">));</span>
	<span class="n">retries</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zd_retry_rates</span><span class="p">[</span><span class="n">first_idx</span><span class="p">];</span>
	<span class="n">ZD_ASSERT</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;=</span> <span class="n">retry</span> <span class="o">&amp;&amp;</span> <span class="n">retry</span> <span class="o">&lt;=</span> <span class="n">retries</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">retries</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// (retry &gt; 1 ? 2 : 1);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">IEEE80211_TX_MAX_RATES</span><span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">retry</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">retries</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// ((i==retry-1) &amp;&amp; success ? 1:2);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">IEEE80211_TX_MAX_RATES</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">retry</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">retries</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="n">retry</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// (success ? 1:2);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">IEEE80211_TX_MAX_RATES</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* terminate */</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ack_signal</span> <span class="o">=</span> <span class="n">zd_check_signal</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">ackssi</span><span class="p">);</span>
	<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zd_mac_tx_failed - callback for failed frames</span>
<span class="cm"> * @dev: the mac80211 wireless device</span>
<span class="cm"> *</span>
<span class="cm"> * This function is called if a frame couldn&#39;t be successfully</span>
<span class="cm"> * transferred. The first frame from the tx queue, will be selected and</span>
<span class="cm"> * reported as error to the upper layers.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zd_mac_tx_failed</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span> <span class="n">hw</span> <span class="o">=</span> <span class="n">zd_usb_to_hw</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_wait_queue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tx_status</span> <span class="o">*</span><span class="n">tx_status</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tx_status</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">success</span> <span class="o">=</span> <span class="o">!</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">failure</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry</span> <span class="o">=</span> <span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">retry</span> <span class="o">+</span> <span class="n">success</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_wait_queue</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">tx_hdr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">first_idx</span><span class="p">,</span> <span class="n">final_idx</span><span class="p">;</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">tx_retry_rate</span> <span class="o">*</span><span class="n">retries</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">final_rate</span><span class="p">;</span>

		<span class="n">position</span> <span class="o">++</span><span class="p">;</span>

		<span class="cm">/* if the hardware reports a failure and we had a 802.11 ACK</span>
<span class="cm">		 * pending, then we skip the first skb when searching for a</span>
<span class="cm">		 * matching frame */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">failure</span> <span class="o">&amp;&amp;</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">&amp;&amp;</span>
		    <span class="n">skb_queue_is_first</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">tx_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="cm">/* we skip all frames not matching the reported destination */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tx_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* we skip all frames not matching the reported final rate */</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">first_idx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
		<span class="n">ZD_ASSERT</span><span class="p">(</span><span class="mi">0</span><span class="o">&lt;=</span><span class="n">first_idx</span> <span class="o">&amp;&amp;</span> <span class="n">first_idx</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">zd_retry_rates</span><span class="p">));</span>
		<span class="n">retries</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">zd_retry_rates</span><span class="p">[</span><span class="n">first_idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">retry</span> <span class="o">&gt;</span> <span class="n">retries</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">final_idx</span> <span class="o">=</span> <span class="n">retries</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">[</span><span class="n">retry</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
		<span class="n">final_rate</span> <span class="o">=</span> <span class="n">zd_rates</span><span class="p">[</span><span class="n">final_idx</span><span class="p">].</span><span class="n">hw_value</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">final_rate</span> <span class="o">!=</span> <span class="n">tx_status</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;=</span><span class="n">position</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="n">zd_mac_tx_status</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					 <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">?</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_signal</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">i</span> <span class="o">==</span> <span class="n">position</span> <span class="o">?</span> <span class="n">tx_status</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zd_mac_tx_to_dev - callback for USB layer</span>
<span class="cm"> * @skb: a &amp;sk_buff pointer</span>
<span class="cm"> * @error: error value, 0 if transmission successful</span>
<span class="cm"> *</span>
<span class="cm"> * Informs the MAC layer that the frame has successfully transferred to the</span>
<span class="cm"> * device. If an ACK is required and the transfer to the device has been</span>
<span class="cm"> * successful, the packets are put on the @ack_wait_queue with</span>
<span class="cm"> * the control set removed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">zd_mac_tx_to_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">error</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">ieee80211_tx_info_clear_status</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_ctrlset</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">error</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME : do we need to fill in anything ?</span>
<span class="cm">		 */</span>
		<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_wait_queue</span><span class="p">;</span>

		<span class="n">skb_queue_tail</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ZD_MAC_MAX_ACK_WAITERS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zd_mac_tx_status</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="n">q</span><span class="p">),</span>
					 <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">?</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_signal</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zd_calc_tx_length_us</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">service</span><span class="p">,</span> <span class="n">u8</span> <span class="n">zd_rate</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* ZD_PURE_RATE() must be used to remove the modulation type flag of</span>
<span class="cm">	 * the zd-rate values.</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">rate_divisor</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_CCK_RATE_1M</span><span class="p">)]</span>   <span class="o">=</span>  <span class="mi">1</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_CCK_RATE_2M</span><span class="p">)]</span>	 <span class="o">=</span>  <span class="mi">2</span><span class="p">,</span>
		<span class="cm">/* Bits must be doubled. */</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_CCK_RATE_5_5M</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_CCK_RATE_11M</span><span class="p">)]</span>	 <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_OFDM_RATE_6M</span><span class="p">)]</span>  <span class="o">=</span>  <span class="mi">6</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_OFDM_RATE_9M</span><span class="p">)]</span>  <span class="o">=</span>  <span class="mi">9</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_OFDM_RATE_12M</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_OFDM_RATE_18M</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">18</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_OFDM_RATE_24M</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_OFDM_RATE_36M</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">36</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_OFDM_RATE_48M</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>
		<span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">ZD_OFDM_RATE_54M</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">54</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">u32</span> <span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">tx_length</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="n">divisor</span> <span class="o">=</span> <span class="n">rate_divisor</span><span class="p">[</span><span class="n">ZD_PURE_RATE</span><span class="p">(</span><span class="n">zd_rate</span><span class="p">)];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">zd_rate</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ZD_CCK_RATE_5_5M</span>:
		<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">bits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* round up to the next integer */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ZD_CCK_RATE_11M</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">service</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">t</span> <span class="o">=</span> <span class="n">bits</span> <span class="o">%</span> <span class="mi">11</span><span class="p">;</span>
			<span class="o">*</span><span class="n">service</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ZD_PLCP_SERVICE_LENGTH_EXTENSION</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">t</span> <span class="o">&amp;&amp;</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">service</span> <span class="o">|=</span> <span class="n">ZD_PLCP_SERVICE_LENGTH_EXTENSION</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">bits</span> <span class="o">+=</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/* round up to the next integer */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bits</span><span class="o">/</span><span class="n">divisor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cs_set_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zd_ctrlset</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
	                   <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span>
	                   <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * CONTROL TODO:</span>
<span class="cm">	 * - if backoff needed, enable bit 0</span>
<span class="cm">	 * - if burst (backoff not needed) disable bit 0</span>
<span class="cm">	 */</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* First fragment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_FIRST_FRAGMENT</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ZD_CS_NEED_RANDOM_BACKOFF</span><span class="p">;</span>

	<span class="cm">/* No ACK expected (multicast, etc.) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ZD_CS_NO_ACK</span><span class="p">;</span>

	<span class="cm">/* PS-POLL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ZD_CS_PS_POLL_FRAME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ZD_CS_RTS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">|=</span> <span class="n">ZD_CS_SELF_CTS</span><span class="p">;</span>

	<span class="cm">/* FIXME: Management frame? */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">zd_mac_match_cur_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">cur_beacon</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">cur_beacon</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">!=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">cur_beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_mac_free_cur_beacon_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ZD_ASSERT</span><span class="p">(</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">mutex</span><span class="p">));</span>

	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">cur_beacon</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">cur_beacon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_mac_free_cur_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">zd_mac_free_cur_beacon_locked</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zd_mac_config_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">in_intr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">num_cmds</span><span class="p">,</span> <span class="n">req_pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* 4 more bytes for tail CRC */</span>
	<span class="n">u32</span> <span class="n">full_len</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end_jiffies</span><span class="p">,</span> <span class="n">message_jiffies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zd_ioreq32</span> <span class="o">*</span><span class="n">ioreqs</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Check if hw already has this beacon. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zd_mac_match_cur_beacon</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">beacon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_nofree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Alloc memory for full beacon write at once. */</span>
	<span class="n">num_cmds</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">zd_chip_is_zd1211b</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">+</span> <span class="n">full_len</span><span class="p">;</span>
	<span class="n">ioreqs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">num_cmds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_ioreq32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioreqs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_nofree</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_iowrite32_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CR_BCN_FIFO_SEMAPHORE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_ioread32_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">CR_BCN_FIFO_SEMAPHORE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">release_sema</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_intr</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_sema</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">end_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/*~500ms*/</span>
	<span class="n">message_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span> <span class="cm">/*~100ms*/</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">zd_ioread32_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">CR_BCN_FIFO_SEMAPHORE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">release_sema</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_eq_jiffies</span><span class="p">(</span><span class="n">message_jiffies</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">message_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span>
					<span class="s">&quot;CR_BCN_FIFO_SEMAPHORE not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_is_before_eq_jiffies</span><span class="p">(</span><span class="n">end_jiffies</span><span class="p">))</span>  <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span>
						<span class="s">&quot;Giving up beacon config.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">r</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">reset_device</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ioreqs</span><span class="p">[</span><span class="n">req_pos</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">CR_BCN_FIFO</span><span class="p">;</span>
	<span class="n">ioreqs</span><span class="p">[</span><span class="n">req_pos</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">full_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">req_pos</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">zd_chip_is_zd1211b</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ioreqs</span><span class="p">[</span><span class="n">req_pos</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">CR_BCN_LENGTH</span><span class="p">;</span>
		<span class="n">ioreqs</span><span class="p">[</span><span class="n">req_pos</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="n">full_len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">req_pos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioreqs</span><span class="p">[</span><span class="n">req_pos</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">CR_BCN_FIFO</span><span class="p">;</span>
		<span class="n">ioreqs</span><span class="p">[</span><span class="n">req_pos</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">j</span><span class="p">));</span>
		<span class="n">req_pos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ioreqs</span><span class="p">[</span><span class="n">req_pos</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">CR_BCN_FIFO</span><span class="p">;</span>
		<span class="n">ioreqs</span><span class="p">[</span><span class="n">req_pos</span><span class="p">].</span><span class="n">value</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">req_pos</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">req_pos</span> <span class="o">!=</span> <span class="n">num_cmds</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_iowrite32a_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">ioreqs</span><span class="p">,</span> <span class="n">num_cmds</span><span class="p">);</span>

<span class="nl">release_sema:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Try very hard to release device beacon semaphore, as otherwise</span>
<span class="cm">	 * device/driver can be left in unusable state.</span>
<span class="cm">	 */</span>
	<span class="n">end_jiffies</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/*~500ms*/</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">zd_iowrite32_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CR_BCN_FIFO_SEMAPHORE</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">in_intr</span> <span class="o">||</span> <span class="n">time_is_before_eq_jiffies</span><span class="p">(</span><span class="n">end_jiffies</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">zd_iowrite32_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">CR_BCN_FIFO_SEMAPHORE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;Could not release &quot;</span>
					 <span class="s">&quot;CR_BCN_FIFO_SEMAPHORE!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* We don&#39;t know if beacon was written successfully or not,</span>
<span class="cm">		 * so clear current. */</span>
		<span class="n">zd_mac_free_cur_beacon_locked</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Beacon has now been written successfully, update current. */</span>
	<span class="n">zd_mac_free_cur_beacon_locked</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">cur_beacon</span> <span class="o">=</span> <span class="n">beacon</span><span class="p">;</span>
	<span class="n">beacon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* 802.11b/g 2.4G CCK 1Mb</span>
<span class="cm">	 * 802.11a, not yet implemented, uses different values (see GPL vendor</span>
<span class="cm">	 * driver)</span>
<span class="cm">	 */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_iowrite32_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00000400</span> <span class="o">|</span> <span class="p">(</span><span class="n">full_len</span> <span class="o">&lt;&lt;</span> <span class="mi">19</span><span class="p">),</span>
				<span class="n">CR_BCN_PLCP_CFG</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioreqs</span><span class="p">);</span>
<span class="nl">out_nofree:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>

<span class="nl">reset_device:</span>
	<span class="n">zd_mac_free_cur_beacon_locked</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ioreqs</span><span class="p">);</span>

	<span class="cm">/* semaphore stuck, reset device to avoid fw freeze later */</span>
	<span class="n">dev_warn</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;CR_BCN_FIFO_SEMAPHORE stuck, &quot;</span>
				  <span class="s">&quot;resetting device...&quot;</span><span class="p">);</span>
	<span class="n">usb_queue_reset_device</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">usb</span><span class="p">.</span><span class="n">intf</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fill_ctrlset</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frag_len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">packet_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">txrate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zd_ctrlset</span> <span class="o">*</span><span class="n">cs</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">zd_ctrlset</span> <span class="o">*</span><span class="p">)</span>
		<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_ctrlset</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">ZD_ASSERT</span><span class="p">(</span><span class="n">frag_len</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Firmware computes the duration itself (for all frames except PSPoll)</span>
<span class="cm">	 * and needs the field set to 0 at input, otherwise firmware messes up</span>
<span class="cm">	 * duration_id and sets bits 14 and 15 on.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_pspoll</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">txrate</span> <span class="o">=</span> <span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">txrate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">modulation</span> <span class="o">=</span> <span class="n">txrate</span><span class="o">-&gt;</span><span class="n">hw_value_short</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">frag_len</span><span class="p">);</span>

	<span class="n">cs_set_control</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">packet_length</span> <span class="o">=</span> <span class="n">frag_len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_ctrlset</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">ZD_ASSERT</span><span class="p">(</span><span class="n">packet_length</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="cm">/* ZD1211B: Computing the length difference this way, gives us</span>
<span class="cm">	 * flexibility to compute the packet length.</span>
<span class="cm">	 */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">packet_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">zd_chip_is_zd1211b</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">packet_length</span> <span class="o">-</span> <span class="n">frag_len</span> <span class="o">:</span> <span class="n">packet_length</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * CURRENT LENGTH:</span>
<span class="cm">	 * - transmit frame length in microseconds</span>
<span class="cm">	 * - seems to be derived from frame length</span>
<span class="cm">	 * - see Cal_Us_Service() in zdinlinef.h</span>
<span class="cm">	 * - if macp-&gt;bTxBurstEnable is enabled, then multiply by 4</span>
<span class="cm">	 *  - bTxBurstEnable is never set in the vendor driver</span>
<span class="cm">	 *</span>
<span class="cm">	 * SERVICE:</span>
<span class="cm">	 * - &quot;for PLCP configuration&quot;</span>
<span class="cm">	 * - always 0 except in some situations at 802.11b 11M</span>
<span class="cm">	 * - see line 53 of zdinlinef.h</span>
<span class="cm">	 */</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">service</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_calc_tx_length_us</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">service</span><span class="p">,</span> <span class="n">ZD_RATE</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">modulation</span><span class="p">),</span>
		                 <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">tx_length</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">current_length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">next_frame_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * zd_op_tx - transmits a network frame to the device</span>
<span class="cm"> *</span>
<span class="cm"> * @dev: mac80211 hardware device</span>
<span class="cm"> * @skb: socket buffer</span>
<span class="cm"> * @control: the control structure</span>
<span class="cm"> *</span>
<span class="cm"> * This function transmit an IEEE 802.11 network frame to the device. The</span>
<span class="cm"> * control block of the skbuff will be initialized. If necessary the incoming</span>
<span class="cm"> * mac80211 queues will be stopped.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_op_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">fill_ctrlset</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_usb_tx</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">usb</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * filter_ack - filters incoming packets for acknowledgements</span>
<span class="cm"> * @dev: the mac80211 device</span>
<span class="cm"> * @rx_hdr: received header</span>
<span class="cm"> * @stats: the status for the received packet</span>
<span class="cm"> *</span>
<span class="cm"> * This functions looks for ACK packets and tries to match them with the</span>
<span class="cm"> * frames in the tx queue. If a match is found the frame will be dequeued and</span>
<span class="cm"> * the upper layers is informed about the successful transmission. If</span>
<span class="cm"> * mac80211 queues have been stopped and the number of frames still to be</span>
<span class="cm"> * transmitted is low the queues will be opened again.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the frame was an ACK, 0 if it was ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">filter_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">rx_hdr</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">position</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_ack</span><span class="p">(</span><span class="n">rx_hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_wait_queue</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">tx_hdr</span><span class="p">;</span>

		<span class="n">position</span> <span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">&amp;&amp;</span> <span class="n">skb_queue_is_first</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		    <span class="k">continue</span><span class="p">;</span>

		<span class="n">tx_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">tx_hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">rx_hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">)))</span>
		<span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">position</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="n">zd_mac_tx_status</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span>
					 <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">?</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_signal</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_signal</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">;</span>

		<span class="cm">/* Prevent pending tx-packet on AP-mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">__skb_dequeue</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
			<span class="n">zd_mac_tx_status</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_signal</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">zd_mac_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">stats</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">rx_status</span> <span class="o">*</span><span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">need_padding</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">ZD_PLCP_HEADER_SIZE</span> <span class="o">+</span> <span class="mi">10</span> <span class="cm">/* IEEE80211_1ADDR_LEN */</span> <span class="o">+</span>
	             <span class="n">FCS_LEN</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_status</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">));</span>

	<span class="cm">/* Note about pass_failed_fcs and pass_ctrl access below:</span>
<span class="cm">	 * mac locking intentionally omitted here, as this is the only unlocked</span>
<span class="cm">	 * reader and the only writer is configure_filter. Plus, if there were</span>
<span class="cm">	 * any races accessing these variables, it wouldn&#39;t really matter.</span>
<span class="cm">	 * If mac80211 ever provides a way for us to access filter flags</span>
<span class="cm">	 * from outside configure_filter, we could improve on this. Also, this</span>
<span class="cm">	 * situation may change once we implement some kind of DMA-into-skb</span>
<span class="cm">	 * RX path. */</span>

	<span class="cm">/* Caller has to ensure that length &gt;= sizeof(struct rx_status). */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rx_status</span> <span class="o">*</span><span class="p">)</span>
		<span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_status</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">ZD_RX_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">pass_failed_fcs</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">status</span><span class="o">-&gt;</span><span class="n">frame_status</span> <span class="o">&amp;</span> <span class="n">ZD_RX_CRC32_ERROR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_FAILED_FCS_CRC</span><span class="p">;</span>
			<span class="n">bad_frame</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">stats</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">zd_channels</span><span class="p">[</span><span class="n">_zd_chip_get_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">center_freq</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
	<span class="n">stats</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">zd_check_signal</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">status</span><span class="o">-&gt;</span><span class="n">signal_strength</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">zd_rx_rate</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="cm">/* todo: return index in the big switches in zd_rx_rate instead */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span><span class="p">)</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">length</span> <span class="o">-=</span> <span class="n">ZD_PLCP_HEADER_SIZE</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rx_status</span><span class="p">);</span>
	<span class="n">buffer</span> <span class="o">+=</span> <span class="n">ZD_PLCP_HEADER_SIZE</span><span class="p">;</span>

	<span class="cm">/* Except for bad frames, filter each frame to see if it is an ACK, in</span>
<span class="cm">	 * which case our internal TX tracking is updated. Normally we then</span>
<span class="cm">	 * bail here as there&#39;s no need to pass ACKs on up to the stack, but</span>
<span class="cm">	 * there is also the case where the stack has requested us to pass</span>
<span class="cm">	 * control frames on up (pass_ctrl) which we must consider. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bad_frame</span> <span class="o">&amp;&amp;</span>
			<span class="n">filter_ack</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">)</span>
			<span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">pass_ctrl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">get_unaligned</span><span class="p">((</span><span class="n">__le16</span><span class="o">*</span><span class="p">)</span><span class="n">buffer</span><span class="p">);</span>
	<span class="n">need_padding</span> <span class="o">=</span> <span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">^</span> <span class="n">ieee80211_has_a4</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">length</span> <span class="o">+</span> <span class="p">(</span><span class="n">need_padding</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">need_padding</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make sure the payload data is 4 byte aligned. */</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME : could we avoid this big memcpy ? */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span><span class="p">),</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">ieee80211_rx_irqsafe</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zd_op_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* using NL80211_IFTYPE_UNSPECIFIED to indicate no mode selected */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_mac_and_bssid</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">zd_set_beacon_interval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">);</span>
	<span class="n">zd_write_mac_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">zd_mac_free_cur_beacon</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">zd_op_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">zd_chip_set_channel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_beacon_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="o">*</span><span class="n">beacon</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ZD_DEVICE_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">||</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send out buffered broad- and multicast frames.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_queue_stopped</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_get_buffered_bc</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">zd_op_tx</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Fetch next beacon so that tim_count is updated.</span>
<span class="cm">	 */</span>
	<span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="p">)</span>
		<span class="n">zd_mac_config_beacon</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_process_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">int_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zd_mac</span><span class="p">,</span> <span class="n">process_intr</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">int_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">intr_buffer</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">int_status</span> <span class="o">&amp;</span> <span class="n">INT_CFG_NEXT_BCN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*dev_dbg_f_limit(zd_mac_dev(mac), &quot;INT_CFG_NEXT_BCN\n&quot;);*/</span>
		<span class="n">zd_beacon_done</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;Unsupported interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">zd_chip_enable_hwint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u64</span> <span class="nf">zd_op_prepare_multicast</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">netdev_hw_addr_list</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zd_mc_hash</span> <span class="n">hash</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>

	<span class="n">zd_mc_clear</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hash</span><span class="p">);</span>

	<span class="n">netdev_hw_addr_list_for_each</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">mc_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;mc addr %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="n">zd_mc_add_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hash</span><span class="p">,</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hash</span><span class="p">.</span><span class="n">low</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">hash</span><span class="p">.</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define SUPPORTED_FIF_FLAGS \</span>
<span class="cp">	(FIF_PROMISC_IN_BSS | FIF_ALLMULTI | FIF_FCSFAIL | FIF_CONTROL | \</span>
<span class="cp">	FIF_OTHER_BSS | FIF_BCN_PRBRESP_PROMISC)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_op_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">new_flags</span><span class="p">,</span>
			<span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mc_hash</span> <span class="n">hash</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">low</span> <span class="o">=</span> <span class="n">multicast</span><span class="p">,</span>
		<span class="p">.</span><span class="n">high</span> <span class="o">=</span> <span class="n">multicast</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="cm">/* Only deal with supported flags */</span>
	<span class="n">changed_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FIF_FLAGS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;=</span> <span class="n">SUPPORTED_FIF_FLAGS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If multicast parameter (as returned by zd_op_prepare_multicast)</span>
<span class="cm">	 * has changed, no bit in changed_flags is set. To handle this</span>
<span class="cm">	 * situation, we do not return if changed_flags is 0. If we do so,</span>
<span class="cm">	 * we will have some issue with IPv6 which uses multicast for link</span>
<span class="cm">	 * layer address resolution.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span> <span class="n">FIF_ALLMULTI</span><span class="p">))</span>
		<span class="n">zd_mc_add_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hash</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">pass_failed_fcs</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">pass_ctrl</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="o">*</span><span class="n">new_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">multicast_hash</span> <span class="o">=</span> <span class="n">hash</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">zd_chip_set_multicast_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hash</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">set_rx_filter</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;set_rx_filter error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* no handling required for FIF_OTHER_BSS as we don&#39;t currently</span>
<span class="cm">	 * do BSSID filtering */</span>
	<span class="cm">/* FIXME: in future it would be nice to enable the probe response</span>
<span class="cm">	 * filter (so that the driver doesn&#39;t see them) until</span>
<span class="cm">	 * FIF_BCN_PRBRESP_PROMISC is set. however due to atomicity here, we&#39;d</span>
<span class="cm">	 * have to schedule work to enable prbresp reception, which might</span>
<span class="cm">	 * happen too late. For now we&#39;ll just listen and forward them all the</span>
<span class="cm">	 * time. */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_rts_cts</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">short_preamble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">zd_chip_set_rts_cts_rate_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">short_preamble</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">.</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">zd_op_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">associated</span><span class="p">;</span>

	<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;changes: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">changes</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span> <span class="o">||</span>
	    <span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">||</span>
	    <span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">associated</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">zd_chip_disable_hwint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
				<span class="n">zd_mac_config_beacon</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
				<span class="n">zd_chip_enable_hwint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">u8</span> <span class="n">period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">enable_beacon</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">period</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">;</span>
				<span class="n">interval</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">period</span> <span class="o">=</span> <span class="n">period</span><span class="p">;</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span><span class="p">;</span>
			<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">zd_set_beacon_interval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span>
					       <span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">associated</span> <span class="o">=</span> <span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">associated</span> <span class="o">=</span> <span class="n">associated</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* TODO: do hardware bssid filtering */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">short_preamble</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">set_rts_cts</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">zd_op_get_tsf</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">zd_chip_get_tsf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">zd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span>			<span class="o">=</span> <span class="n">zd_op_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>			<span class="o">=</span> <span class="n">zd_op_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>			<span class="o">=</span> <span class="n">zd_op_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span>		<span class="o">=</span> <span class="n">zd_op_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span>	<span class="o">=</span> <span class="n">zd_op_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span>			<span class="o">=</span> <span class="n">zd_op_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_multicast</span>	<span class="o">=</span> <span class="n">zd_op_prepare_multicast</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>	<span class="o">=</span> <span class="n">zd_op_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span>	<span class="o">=</span> <span class="n">zd_op_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tsf</span>		<span class="o">=</span> <span class="n">zd_op_get_tsf</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="nf">zd_mac_alloc_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">zd_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg_f</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mac</span> <span class="o">=</span> <span class="n">zd_hw_mac</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mac</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">zd_channels</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zd_channels</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">zd_rates</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">zd_rates</span><span class="p">));</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">zd_rates</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">zd_channels</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span> <span class="o">|</span>
		    <span class="n">IEEE80211_HW_SIGNAL_UNSPEC</span> <span class="o">|</span>
		    <span class="n">IEEE80211_HW_HOST_BROADCAST_PS_BUFFERING</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_MESH_POINT</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_signal</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_ctrlset</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Tell mac80211 that we support multi rate retries</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span> <span class="o">=</span> <span class="n">IEEE80211_TX_MAX_RATES</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rate_tries</span> <span class="o">=</span> <span class="mi">18</span><span class="p">;</span>	<span class="cm">/* 9 rates * 2 retries/rate */</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_wait_queue</span><span class="p">);</span>
	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">ack_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">zd_chip_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">hw</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
	<span class="n">housekeeping_init</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">beacon_init</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">process_intr</span><span class="p">,</span> <span class="n">zd_process_intr</span><span class="p">);</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define BEACON_WATCHDOG_DELAY round_jiffies_relative(HZ)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beacon_watchdog_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zd_mac</span><span class="p">,</span> <span class="n">beacon</span><span class="p">.</span><span class="n">watchdog_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">interval</span><span class="p">,</span> <span class="n">period</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ZD_DEVICE_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">rearm</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">||</span> <span class="o">!</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">rearm</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">interval</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">interval</span><span class="p">;</span>
	<span class="n">period</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">period</span><span class="p">;</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">last_update</span> <span class="o">+</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">interval</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">time_is_before_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;beacon interrupt stalled, &quot;</span>
					   <span class="s">&quot;restarting. &quot;</span>
					   <span class="s">&quot;(interval: %d, dtim: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">interval</span><span class="p">,</span> <span class="n">period</span><span class="p">);</span>

		<span class="n">zd_chip_disable_hwint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">beacon</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">zd_mac_free_cur_beacon</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>

			<span class="n">zd_mac_config_beacon</span><span class="p">(</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">beacon</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">zd_set_beacon_interval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">interval</span><span class="p">,</span> <span class="n">period</span><span class="p">,</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="n">zd_chip_enable_hwint</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">rearm:</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">zd_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">watchdog_work</span><span class="p">,</span>
			   <span class="n">BEACON_WATCHDOG_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beacon_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">watchdog_work</span><span class="p">,</span> <span class="n">beacon_watchdog_handler</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beacon_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">last_update</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">zd_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">watchdog_work</span><span class="p">,</span>
			   <span class="n">BEACON_WATCHDOG_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">beacon_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">beacon</span><span class="p">.</span><span class="n">watchdog_work</span><span class="p">);</span>

	<span class="n">zd_mac_free_cur_beacon</span><span class="p">(</span><span class="n">mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define LINK_LED_WORK_DELAY HZ</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">link_led_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">zd_mac</span><span class="p">,</span> <span class="n">housekeeping</span><span class="p">.</span><span class="n">link_led_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">zd_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_associated</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">ZD_DEVICE_RUNNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">requeue</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">is_associated</span> <span class="o">=</span> <span class="n">mac</span><span class="o">-&gt;</span><span class="n">associated</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">zd_chip_control_leds</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
		                 <span class="n">is_associated</span> <span class="o">?</span> <span class="n">ZD_LED_ASSOCIATED</span> <span class="o">:</span> <span class="n">ZD_LED_SCANNING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span>
		<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;zd_chip_control_leds error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>

<span class="nl">requeue:</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">zd_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">.</span><span class="n">link_led_work</span><span class="p">,</span>
		           <span class="n">LINK_LED_WORK_DELAY</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">housekeeping_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">.</span><span class="n">link_led_work</span><span class="p">,</span> <span class="n">link_led_handler</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">housekeeping_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">zd_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">.</span><span class="n">link_led_work</span><span class="p">,</span>
			   <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">housekeeping_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">zd_mac</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg_f</span><span class="p">(</span><span class="n">zd_mac_dev</span><span class="p">(</span><span class="n">mac</span><span class="p">),</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">housekeeping</span><span class="p">.</span><span class="n">link_led_work</span><span class="p">);</span>
	<span class="n">zd_chip_control_leds</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mac</span><span class="o">-&gt;</span><span class="n">chip</span><span class="p">,</span> <span class="n">ZD_LED_OFF</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
