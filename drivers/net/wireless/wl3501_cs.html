<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › wl3501_cs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>wl3501_cs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * WL3501 Wireless LAN PCMCIA Card Driver for Linux</span>
<span class="cm"> * Written originally for Linux 2.0.30 by Fox Chen, mhchen@golf.ccl.itri.org.tw</span>
<span class="cm"> * Ported to 2.2, 2.4 &amp; 2.5 by Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm"> * Wireless extensions in 2.4 by Gustavo Niemeyer &lt;niemeyer@conectiva.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * References used by Fox Chen while writing the original driver for 2.0.30:</span>
<span class="cm"> *</span>
<span class="cm"> *   1. WL24xx packet drivers (tooasm.asm)</span>
<span class="cm"> *   2. Access Point Firmware Interface Specification for IEEE 802.11 SUTRO</span>
<span class="cm"> *   3. IEEE 802.11</span>
<span class="cm"> *   4. Linux network driver (/usr/src/linux/drivers/net)</span>
<span class="cm"> *   5. ISA card driver - wl24.c</span>
<span class="cm"> *   6. Linux PCMCIA skeleton driver - skeleton.c</span>
<span class="cm"> *   7. Linux PCMCIA 3c589 network driver - 3c589_cs.c</span>
<span class="cm"> *</span>
<span class="cm"> * Tested with WL2400 firmware 1.2, Linux 2.0.30, and pcmcia-cs-2.9.12</span>
<span class="cm"> *   1. Performance: about 165 Kbytes/sec in TCP/IP with Ad-Hoc mode.</span>
<span class="cm"> *      rsh 192.168.1.3 &quot;dd if=/dev/zero bs=1k count=1000&quot; &gt; /dev/null</span>
<span class="cm"> *      (Specification 2M bits/sec. is about 250 Kbytes/sec., but we must deduct</span>
<span class="cm"> *       ETHER/IP/UDP/TCP header, and acknowledgement overhead)</span>
<span class="cm"> *</span>
<span class="cm"> * Tested with Planet AP in 2.4.17, 184 Kbytes/s in UDP in Infrastructure mode,</span>
<span class="cm"> * 173 Kbytes/s in TCP.</span>
<span class="cm"> *</span>
<span class="cm"> * Tested with Planet AP in 2.5.73-bk, 216 Kbytes/s in Infrastructure mode</span>
<span class="cm"> * with a SMP machine (dual pentium 100), using pktgen, 432 pps (pkt_size = 60)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/wireless.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>

<span class="cp">#include &lt;net/iw_handler.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/cisreg.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;wl3501.h&quot;</span>

<span class="cp">#ifndef __i386__</span>
<span class="cp">#define slow_down_io()</span>
<span class="cp">#endif</span>

<span class="cm">/* For rough constant delay */</span>
<span class="cp">#define WL3501_NOPLOOP(n) { int x = 0; while (x++ &lt; n) slow_down_io(); }</span>



<span class="cp">#define wl3501_outb(a, b) { outb(a, b); slow_down_io(); }</span>
<span class="cp">#define wl3501_outb_p(a, b) { outb_p(a, b); slow_down_io(); }</span>
<span class="cp">#define wl3501_outsb(a, b, c) { outsb(a, b, c); slow_down_io(); }</span>

<span class="cp">#define WL3501_RELEASE_TIMEOUT (25 * HZ)</span>
<span class="cp">#define WL3501_MAX_ADHOC_TRIES 16</span>

<span class="cp">#define WL3501_RESUME	0</span>
<span class="cp">#define WL3501_SUSPEND	1</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wl3501_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">wl3501_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">reg_domain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">deflt</span><span class="p">;</span>
<span class="p">}</span> <span class="n">iw_channel_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">IW_REG_DOMAIN_FCC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	    <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">deflt</span>	    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">IW_REG_DOMAIN_DOC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	    <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">deflt</span>	    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">IW_REG_DOMAIN_ETSI</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	    <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
		<span class="p">.</span><span class="n">deflt</span>	    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">IW_REG_DOMAIN_SPAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	    <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	    <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">deflt</span>	    <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">IW_REG_DOMAIN_FRANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	    <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	    <span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
		<span class="p">.</span><span class="n">deflt</span>	    <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">IW_REG_DOMAIN_MKK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	    <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	    <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">deflt</span>	    <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">IW_REG_DOMAIN_MKK1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	    <span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">deflt</span>	    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">IW_REG_DOMAIN_ISRAEL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	    <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	    <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">deflt</span>	    <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * iw_valid_channel - validate channel in regulatory domain</span>
<span class="cm"> * @reg_comain - regulatory domain</span>
<span class="cm"> * @channel - channel to validate</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if invalid in the specified regulatory domain, non-zero if valid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iw_valid_channel</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg_domain</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">iw_channel_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_domain</span> <span class="o">==</span> <span class="n">iw_channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_domain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="n">iw_channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">min</span> <span class="o">&amp;&amp;</span>
			     <span class="n">channel</span> <span class="o">&lt;=</span> <span class="n">iw_channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">max</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * iw_default_channel - get default channel for a regulatory domain</span>
<span class="cm"> * @reg_comain - regulatory domain</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the default channel for a regulatory domain</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">iw_default_channel</span><span class="p">(</span><span class="kt">int</span> <span class="n">reg_domain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">iw_channel_table</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg_domain</span> <span class="o">==</span> <span class="n">iw_channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">reg_domain</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">iw_channel_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">deflt</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iw_set_mgmt_info_element</span><span class="p">(</span><span class="k">enum</span> <span class="n">iw_mgmt_info_element_ids</span> <span class="n">id</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_mgmt_info_element</span> <span class="o">*</span><span class="n">el</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">id</span>  <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">el</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">el</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iw_copy_mgmt_info_element</span><span class="p">(</span><span class="k">struct</span> <span class="n">iw_mgmt_info_element</span> <span class="o">*</span><span class="n">to</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">iw_mgmt_info_element</span> <span class="o">*</span><span class="n">from</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">iw_set_mgmt_info_element</span><span class="p">(</span><span class="n">from</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">to</span><span class="p">,</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">from</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_switch_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u8</span> <span class="n">page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_BSS</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get Ethernet MAC address.</span>
<span class="cm"> *</span>
<span class="cm"> * WARNING: We switch to FPAGE0 and switc back again.</span>
<span class="cm"> *          Making sure there is no other WL function beening called by ISR.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_flash_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">base_addr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* get MAC addr */</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="n">WL3501_BSS_FPAGE3</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_BSS</span><span class="p">);</span> <span class="cm">/* BSS */</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_LMAL</span><span class="p">);</span>	<span class="cm">/* LMAL */</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_LMAH</span><span class="p">);</span>	<span class="cm">/* LMAH */</span>

	<span class="cm">/* wait for reading EEPROM */</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">reg_domain</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="n">WL3501_BSS_FPAGE0</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_BSS</span><span class="p">);</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="mh">0x04</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_LMAL</span><span class="p">);</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="mh">0x40</span><span class="p">,</span> <span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_LMAH</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">);</span>
	<span class="cm">/* switch to SRAM Page 0 (for safety) */</span>
	<span class="n">wl3501_switch_page</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_BSS_SPAGE0</span><span class="p">);</span>

	<span class="cm">/* The MAC addr should be 00:60:... */</span>
	<span class="k">return</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x60</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_set_to_wla - Move &#39;size&#39; bytes from PC to card</span>
<span class="cm"> * @dest: Card addressing space</span>
<span class="cm"> * @src: PC addressing space</span>
<span class="cm"> * @size: Bytes to move</span>
<span class="cm"> *</span>
<span class="cm"> * Move &#39;size&#39; bytes from PC to card. (Shouldn&#39;t be interrupted)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_set_to_wla</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* switch to SRAM Page 0 */</span>
	<span class="n">wl3501_switch_page</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">?</span> <span class="n">WL3501_BSS_SPAGE1</span> <span class="o">:</span>
						   <span class="n">WL3501_BSS_SPAGE0</span><span class="p">);</span>
	<span class="cm">/* set LMAL and LMAH */</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="n">dest</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_LMAL</span><span class="p">);</span>
	<span class="n">wl3501_outb</span><span class="p">(((</span><span class="n">dest</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">),</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_LMAH</span><span class="p">);</span>

	<span class="cm">/* rep out to Port A */</span>
	<span class="n">wl3501_outsb</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_get_from_wla - Move &#39;size&#39; bytes from card to PC</span>
<span class="cm"> * @src: Card addressing space</span>
<span class="cm"> * @dest: PC addressing space</span>
<span class="cm"> * @size: Bytes to move</span>
<span class="cm"> *</span>
<span class="cm"> * Move &#39;size&#39; bytes from card to PC. (Shouldn&#39;t be interrupted)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_get_from_wla</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="n">src</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dest</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* switch to SRAM Page 0 */</span>
	<span class="n">wl3501_switch_page</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">?</span> <span class="n">WL3501_BSS_SPAGE1</span> <span class="o">:</span>
						  <span class="n">WL3501_BSS_SPAGE0</span><span class="p">);</span>
	<span class="cm">/* set LMAL and LMAH */</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="n">src</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_LMAL</span><span class="p">);</span>
	<span class="n">wl3501_outb</span><span class="p">((</span><span class="n">src</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_LMAH</span><span class="p">);</span>

	<span class="cm">/* rep get from Port A */</span>
	<span class="n">insb</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_IODPA</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get/Allocate a free Tx Data Buffer</span>
<span class="cm"> *</span>
<span class="cm"> *  *--------------*-----------------*----------------------------------*</span>
<span class="cm"> *  |    PLCP      |    MAC Header   |  DST  SRC         Data ...       |</span>
<span class="cm"> *  |  (24 bytes)  |    (30 bytes)   |  (6)  (6)  (Ethernet Row Data)   |</span>
<span class="cm"> *  *--------------*-----------------*----------------------------------*</span>
<span class="cm"> *  \               \- IEEE 802.11 -/ \-------------- len --------------/</span>
<span class="cm"> *   \-struct wl3501_80211_tx_hdr--/   \-------- Ethernet Frame -------/</span>
<span class="cm"> *</span>
<span class="cm"> * Return = Position in Card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">wl3501_get_tx_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">next</span><span class="p">,</span> <span class="n">blk_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">full_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_80211_tx_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">full_len</span> <span class="o">&gt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_cnt</span> <span class="o">*</span> <span class="mi">254</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">full_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">full_len</span> <span class="o">&lt;</span> <span class="mi">254</span><span class="p">)</span>
			<span class="n">full_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">full_len</span> <span class="o">-=</span> <span class="mi">254</span><span class="p">;</span>
		<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span>
				    <span class="k">sizeof</span><span class="p">(</span><span class="n">next</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">full_len</span><span class="p">)</span>
			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">,</span>
					  <span class="k">sizeof</span><span class="p">(</span><span class="n">zero</span><span class="p">));</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="n">blk_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* if buffer is not enough */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">next</span> <span class="o">&amp;&amp;</span> <span class="n">full_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_cnt</span> <span class="o">-=</span> <span class="n">blk_cnt</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free an allocated Tx Buffer. ptr must be correct position.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_free_tx_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check if all space is not free */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_tail</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">next</span><span class="p">;</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">next</span><span class="p">));</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_tail</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_esbq_req_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_head</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_esbq_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_head</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_head</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_head</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_head</span> <span class="o">&gt;=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_end</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_head</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_esbq_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sig</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sig_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl3501_esbq_req_test</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">wl3501_get_tx_buffer</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">sig_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">sig_size</span><span class="p">);</span>
			<span class="n">wl3501_esbq_req</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_mib_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_get_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span>	    <span class="o">=</span> <span class="n">WL3501_SIG_GET_REQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mib_attrib</span> <span class="o">=</span> <span class="n">index</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl3501_esbq_req_test</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">wl3501_get_tx_buffer</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
			<span class="n">wl3501_esbq_req</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_get_confirm</span><span class="p">.</span><span class="n">mib_status</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_get_confirm</span><span class="p">.</span><span class="n">mib_status</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">bf</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_get_confirm</span><span class="p">.</span><span class="n">mib_value</span><span class="p">,</span>
				       <span class="n">size</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_pwr_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">int</span> <span class="n">suspend</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_pwr_mgmt_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span>		<span class="o">=</span> <span class="n">WL3501_SIG_PWR_MGMT_REQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pwr_save</span>	<span class="o">=</span> <span class="n">suspend</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wake_up</span>	<span class="o">=</span> <span class="o">!</span><span class="n">suspend</span><span class="p">,</span>
		<span class="p">.</span><span class="n">receive_dtims</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl3501_esbq_req_test</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">wl3501_get_tx_buffer</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
			<span class="n">wl3501_esbq_req</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="p">);</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_pwr_mgmt_confirm</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_pwr_mgmt_confirm</span><span class="p">.</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s status=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			       <span class="n">suspend</span> <span class="o">?</span> <span class="s">&quot;suspend&quot;</span> <span class="o">:</span> <span class="s">&quot;resume&quot;</span><span class="p">,</span>
			       <span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_pwr_mgmt_confirm</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_send_pkt - Send a packet.</span>
<span class="cm"> * @this - card</span>
<span class="cm"> *</span>
<span class="cm"> * Send a packet.</span>
<span class="cm"> *</span>
<span class="cm"> * data = Ethernet raw frame.  (e.g. data[0] - data[5] is Dest MAC Addr,</span>
<span class="cm"> *                                   data[6] - data[11] is Src MAC Addr)</span>
<span class="cm"> * Ref: IEEE 802.11</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_send_pkt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">bf</span><span class="p">,</span> <span class="n">sig_bf</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">tmplen</span><span class="p">,</span> <span class="n">pktlen</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_md_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span> <span class="o">=</span> <span class="n">WL3501_SIG_MD_REQ</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl3501_esbq_req_test</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sig_bf</span> <span class="o">=</span> <span class="n">wl3501_get_tx_buffer</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sig_bf</span><span class="p">)</span>	<span class="cm">/* No free buffer available */</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">bf</span> <span class="o">=</span> <span class="n">wl3501_get_tx_buffer</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">26</span> <span class="o">+</span> <span class="mi">24</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No free buffer available */</span>
			<span class="n">wl3501_free_tx_buffer</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">sig_bf</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sig</span><span class="p">.</span><span class="n">daddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pdata</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">pktlen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">pdata</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">sig</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">bf</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">pdata</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">pdata</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span> <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">addr4</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
			<span class="p">};</span>

			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">bf</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span>
					  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_tx_hdr</span><span class="p">,</span> <span class="n">addr4</span><span class="p">),</span>
					  <span class="n">addr4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr4</span><span class="p">));</span>
			<span class="n">sig</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">pktlen</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pktlen</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">254</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_tx_hdr</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">tmplen</span> <span class="o">=</span> <span class="mi">254</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_tx_hdr</span><span class="p">);</span>
				<span class="n">pktlen</span> <span class="o">-=</span> <span class="n">tmplen</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tmplen</span> <span class="o">=</span> <span class="n">pktlen</span><span class="p">;</span>
				<span class="n">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
					  <span class="n">bf</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_tx_hdr</span><span class="p">),</span>
					  <span class="n">pdata</span><span class="p">,</span> <span class="n">tmplen</span><span class="p">);</span>
			<span class="n">pdata</span> <span class="o">+=</span> <span class="n">tmplen</span><span class="p">;</span>
			<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">next</span><span class="p">));</span>
			<span class="n">bf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sig</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">pktlen</span> <span class="o">+</span> <span class="mi">24</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">pdata</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">pktlen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pktlen</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">254</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_tx_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tmplen</span> <span class="o">=</span> <span class="mi">254</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_tx_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">pktlen</span> <span class="o">-=</span> <span class="n">tmplen</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tmplen</span> <span class="o">=</span> <span class="n">pktlen</span><span class="p">;</span>
				<span class="n">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">bf</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span>
					  <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_tx_hdr</span><span class="p">,</span> <span class="n">addr4</span><span class="p">),</span>
					  <span class="n">pdata</span><span class="p">,</span> <span class="n">tmplen</span><span class="p">);</span>
			<span class="n">pdata</span> <span class="o">+=</span> <span class="n">tmplen</span><span class="p">;</span>
			<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">next</span><span class="p">));</span>
			<span class="n">bf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">pktlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pktlen</span> <span class="o">&gt;</span> <span class="mi">254</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tmplen</span> <span class="o">=</span> <span class="mi">254</span><span class="p">;</span>
				<span class="n">pktlen</span> <span class="o">-=</span> <span class="mi">254</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">tmplen</span> <span class="o">=</span> <span class="n">pktlen</span><span class="p">;</span>
				<span class="n">pktlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">bf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">tmplen</span><span class="p">);</span>
			<span class="n">pdata</span> <span class="o">+=</span> <span class="n">tmplen</span><span class="p">;</span>
			<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">next</span><span class="p">));</span>
			<span class="n">bf</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">sig_bf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
		<span class="n">wl3501_esbq_req</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig_bf</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_mgmt_resync</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_resync_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span> <span class="o">=</span> <span class="n">WL3501_SIG_RESYNC_REQ</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">wl3501_esbq_exec</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wl3501_fw_bss_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">?</span> <span class="n">WL3501_NET_TYPE_INFRA</span> <span class="o">:</span>
						 <span class="n">WL3501_NET_TYPE_ADHOC</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">wl3501_fw_cap_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">?</span> <span class="n">WL3501_MGMT_CAPABILITY_ESS</span> <span class="o">:</span>
						 <span class="n">WL3501_MGMT_CAPABILITY_IBSS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_mgmt_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="n">chan_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_scan_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span>		<span class="o">=</span> <span class="n">WL3501_SIG_SCAN_REQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scan_type</span>	<span class="o">=</span> <span class="n">WL3501_SCAN_TYPE_ACTIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe_delay</span>	<span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min_chan_time</span>	<span class="o">=</span> <span class="n">chan_time</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max_chan_time</span>	<span class="o">=</span> <span class="n">chan_time</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bss_type</span>	<span class="o">=</span> <span class="n">wl3501_fw_bss_type</span><span class="p">(</span><span class="n">this</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">wl3501_esbq_exec</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_mgmt_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="n">stas</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_join_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span>		  <span class="o">=</span> <span class="n">WL3501_SIG_JOIN_REQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">timeout</span>	  <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ds_pset</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">id</span>  <span class="o">=</span> <span class="n">IW_MGMT_INFO_ELEMENT_DS_PARAMETER_SET</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">chan</span>	<span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sig</span><span class="p">.</span><span class="n">beacon_period</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">stas</span><span class="p">].</span><span class="n">beacon_period</span><span class="p">,</span> <span class="mi">72</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wl3501_esbq_exec</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_mgmt_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_start_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span>			<span class="o">=</span> <span class="n">WL3501_SIG_START_REQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">beacon_period</span>		<span class="o">=</span> <span class="mi">400</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dtim_period</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">ds_pset</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">id</span>  <span class="o">=</span> <span class="n">IW_MGMT_INFO_ELEMENT_DS_PARAMETER_SET</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">chan</span>	<span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">bss_basic_rset</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">IW_MGMT_INFO_ELEMENT_SUPPORTED_RATES</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">data_rate_labels</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_MGMT_RATE_LABEL_MANDATORY</span> <span class="o">|</span>
				      <span class="n">IW_MGMT_RATE_LABEL_1MBIT</span><span class="p">,</span>
				<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_MGMT_RATE_LABEL_MANDATORY</span> <span class="o">|</span>
				      <span class="n">IW_MGMT_RATE_LABEL_2MBIT</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">operational_rset</span>	<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">IW_MGMT_INFO_ELEMENT_SUPPORTED_RATES</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">data_rate_labels</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_MGMT_RATE_LABEL_MANDATORY</span> <span class="o">|</span>
				      <span class="n">IW_MGMT_RATE_LABEL_1MBIT</span><span class="p">,</span>
				<span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">IW_MGMT_RATE_LABEL_MANDATORY</span> <span class="o">|</span>
				      <span class="n">IW_MGMT_RATE_LABEL_2MBIT</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">ibss_pset</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">el</span> <span class="o">=</span> <span class="p">{</span>
				<span class="p">.</span><span class="n">id</span>	 <span class="o">=</span> <span class="n">IW_MGMT_INFO_ELEMENT_IBSS_PARAMETER_SET</span><span class="p">,</span>
				<span class="p">.</span><span class="n">len</span>     <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">},</span>
			<span class="p">.</span><span class="n">atim_window</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">bss_type</span>		<span class="o">=</span> <span class="n">wl3501_fw_bss_type</span><span class="p">(</span><span class="n">this</span><span class="p">),</span>
		<span class="p">.</span><span class="n">cap_info</span>		<span class="o">=</span> <span class="n">wl3501_fw_cap_info</span><span class="p">(</span><span class="n">this</span><span class="p">),</span>
	<span class="p">};</span>

	<span class="n">iw_copy_mgmt_info_element</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sig</span><span class="p">.</span><span class="n">ssid</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
	<span class="n">iw_copy_mgmt_info_element</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">keep_essid</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wl3501_esbq_exec</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_mgmt_scan_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">matchflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_scan_confirm</span> <span class="n">sig</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">WL3501_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;success&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">WL3501_MGMT_CAPABILITY_ESS</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">WL3501_MGMT_CAPABILITY_IBSS</span><span class="p">))</span> <span class="o">||</span>
		    <span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
				<span class="n">matchflag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span>
				 <span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="s">&quot;ANY&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
				<span class="n">matchflag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">len</span> <span class="o">!=</span> <span class="n">sig</span><span class="p">.</span><span class="n">ssid</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
				<span class="n">matchflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">sig</span><span class="p">.</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span>
					<span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">len</span><span class="p">))</span>
				<span class="n">matchflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">matchflag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">matchflag</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span>
						    <span class="n">sig</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">matchflag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">matchflag</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">beacon_period</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">sig</span><span class="p">.</span><span class="n">beacon_period</span><span class="p">,</span> <span class="mi">73</span><span class="p">);</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">sig</span><span class="p">.</span><span class="n">rssi</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">WL3501_STATUS_TIMEOUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">);</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_mgmt_join</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span> <span class="o">==</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
				<span class="n">wl3501_mgmt_scan</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">adhoc_times</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">adhoc_times</span> <span class="o">&gt;</span> <span class="n">WL3501_MAX_ADHOC_TRIES</span><span class="p">)</span>
					<span class="n">wl3501_mgmt_start</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">wl3501_mgmt_scan</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_block_interrupt - Mask interrupt from SUTRO</span>
<span class="cm"> * @this - card</span>
<span class="cm"> *</span>
<span class="cm"> * Mask interrupt from SUTRO. (i.e. SUTRO cannot interrupt the HOST)</span>
<span class="cm"> * Return: 1 if interrupt is originally enabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_block_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">new</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="n">WL3501_GCR_ECINT</span> <span class="o">|</span> <span class="n">WL3501_GCR_INT2EC</span> <span class="o">|</span>
			<span class="n">WL3501_GCR_ENECINT</span><span class="p">));</span>

	<span class="n">wl3501_outb</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="n">WL3501_GCR_ENECINT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_unblock_interrupt - Enable interrupt from SUTRO</span>
<span class="cm"> * @this - card</span>
<span class="cm"> *</span>
<span class="cm"> * Enable interrupt from SUTRO. (i.e. SUTRO can interrupt the HOST)</span>
<span class="cm"> * Return: 1 if interrupt is originally enabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_unblock_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">old</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">new</span> <span class="o">=</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">WL3501_GCR_ECINT</span> <span class="o">|</span> <span class="n">WL3501_GCR_INT2EC</span><span class="p">))</span> <span class="o">|</span>
		  <span class="n">WL3501_GCR_ENECINT</span><span class="p">;</span>

	<span class="n">wl3501_outb</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="n">WL3501_GCR_ENECINT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_receive - Receive data from Receive Queue.</span>
<span class="cm"> *</span>
<span class="cm"> * Receive data from Receive Queue.</span>
<span class="cm"> *</span>
<span class="cm"> * @this: card</span>
<span class="cm"> * @bf: address of host</span>
<span class="cm"> * @size: size of buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">wl3501_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bf</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">next_addr</span><span class="p">,</span> <span class="n">next_addr1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">bf</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">start_seg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">next_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">next_addr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">WL3501_BLKSZ</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_rx_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
				    <span class="n">this</span><span class="o">-&gt;</span><span class="n">start_seg</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_rx_hdr</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span>
				    <span class="n">WL3501_BLKSZ</span> <span class="o">-</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_rx_hdr</span><span class="p">));</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">WL3501_BLKSZ</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_rx_hdr</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">WL3501_BLKSZ</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_rx_hdr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
				    <span class="n">this</span><span class="o">-&gt;</span><span class="n">start_seg</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_rx_hdr</span><span class="p">),</span>
				    <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">WL3501_BLKSZ</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">next_addr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span>
					    <span class="n">WL3501_BLKSZ</span> <span class="o">-</span> <span class="mi">5</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">-=</span> <span class="n">WL3501_BLKSZ</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">data</span> <span class="o">+=</span> <span class="n">WL3501_BLKSZ</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>
			<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">next_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next_addr1</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">next_addr1</span><span class="p">));</span>
			<span class="n">next_addr</span> <span class="o">=</span> <span class="n">next_addr1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">next_addr</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
			<span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_esbq_req_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_head</span> <span class="o">==</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_tail</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_tail</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_tail</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">wl3501_free_tx_buffer</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_tail</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_tail</span> <span class="o">&gt;=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_end</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_tail</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_start</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_esbq_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_online</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Wireless LAN online. BSSID: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_esbq_confirm_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm</span> <span class="o">&gt;=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm_end</span><span class="p">)</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm_start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_mgmt_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_auth_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span>	 <span class="o">=</span> <span class="n">WL3501_SIG_AUTH_REQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>	 <span class="o">=</span> <span class="n">WL3501_SYS_TYPE_OPEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wl3501_esbq_exec</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_mgmt_association</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_assoc_req</span> <span class="n">sig</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">sig_id</span>		 <span class="o">=</span> <span class="n">WL3501_SIG_ASSOC_REQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">timeout</span>	 <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">cap_info</span>	 <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">cap_info</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">wl3501_esbq_exec</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_mgmt_join_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl3501_join_confirm</span> <span class="n">sig</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">WL3501_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">const</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
				       <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ds_pset</span><span class="p">.</span><span class="n">chan</span><span class="p">;</span>
				<span class="n">iw_copy_mgmt_info_element</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">keep_essid</span><span class="p">.</span><span class="n">el</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
				<span class="n">wl3501_mgmt_auth</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">const</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ds_pset</span><span class="p">.</span><span class="n">chan</span><span class="p">;</span>
			<span class="n">iw_copy_mgmt_info_element</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">keep_essid</span><span class="p">.</span><span class="n">el</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">.</span><span class="n">el</span><span class="p">);</span>
			<span class="n">wl3501_online</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_mgmt_join</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span> <span class="o">==</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span>
				<span class="n">wl3501_mgmt_scan</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">this</span><span class="o">-&gt;</span><span class="n">adhoc_times</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">adhoc_times</span> <span class="o">&gt;</span> <span class="n">WL3501_MAX_ADHOC_TRIES</span><span class="p">)</span>
					<span class="n">wl3501_mgmt_start</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">wl3501_mgmt_scan</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_alarm_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Wireless LAN offline</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">wl3501_mgmt_resync</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_md_confirm_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
					       <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_md_confirm</span> <span class="n">sig</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
	<span class="n">wl3501_free_tx_buffer</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">sig</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_md_ind_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_md_ind</span> <span class="n">sig</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">addr4</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">pkt_len</span><span class="p">;</span>

	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">start_seg</span> <span class="o">=</span> <span class="n">sig</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
			    <span class="n">sig</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_rx_hdr</span><span class="p">,</span> <span class="n">rssi</span><span class="p">),</span>
			    <span class="o">&amp;</span><span class="n">rssi</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rssi</span><span class="p">));</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">rssi</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">&lt;=</span> <span class="mi">63</span> <span class="o">?</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">255</span><span class="p">;</span>

	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
			    <span class="n">sig</span><span class="p">.</span><span class="n">data</span> <span class="o">+</span>
				<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_rx_hdr</span><span class="p">,</span> <span class="n">addr4</span><span class="p">),</span>
			    <span class="o">&amp;</span><span class="n">addr4</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr4</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">addr4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xAA</span> <span class="o">&amp;&amp;</span> <span class="n">addr4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xAA</span> <span class="o">&amp;&amp;</span>
	      <span class="n">addr4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x03</span> <span class="o">&amp;&amp;</span> <span class="n">addr4</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Insupported packet type!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">sig</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">pkt_len</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t alloc a sk_buff of size %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="cm">/* IP headers on 16 bytes boundaries */</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sig</span><span class="p">.</span><span class="n">daddr</span><span class="p">,</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">wl3501_receive</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span>	<span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_get_confirm_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">sig</span><span class="p">,</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_get_confirm</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_get_confirm</span><span class="p">));</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_start_confirm_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
						  <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_start_confirm</span> <span class="n">sig</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">WL3501_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_assoc_confirm_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						  <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl3501_assoc_confirm</span> <span class="n">sig</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">WL3501_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">wl3501_online</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_auth_confirm_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span>
						 <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_auth_confirm</span> <span class="n">sig</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sig</span><span class="p">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">WL3501_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">wl3501_mgmt_association</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">wl3501_mgmt_resync</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">morepkts</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sig_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;entry&quot;</span><span class="p">);</span>
<span class="nl">loop:</span>
	<span class="n">morepkts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_esbq_confirm</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free</span><span class="p">;</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sig_id</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sig_id</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sig_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_DEAUTH_IND</span>:
	<span class="k">case</span> <span class="n">WL3501_SIG_DISASSOC_IND</span>:
	<span class="k">case</span> <span class="n">WL3501_SIG_ALARM</span>:
		<span class="n">wl3501_alarm_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">this</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_MD_CONFIRM</span>:
		<span class="n">wl3501_md_confirm_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_MD_IND</span>:
		<span class="n">wl3501_md_ind_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_GET_CONFIRM</span>:
		<span class="n">wl3501_get_confirm_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_get_confirm</span><span class="p">,</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_get_confirm</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_PWR_MGMT_CONFIRM</span>:
		<span class="n">wl3501_get_confirm_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
					     <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_pwr_mgmt_confirm</span><span class="p">,</span>
					    <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sig_pwr_mgmt_confirm</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_START_CONFIRM</span>:
		<span class="n">wl3501_start_confirm_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_SCAN_CONFIRM</span>:
		<span class="n">wl3501_mgmt_scan_confirm</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_JOIN_CONFIRM</span>:
		<span class="n">wl3501_mgmt_join_confirm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_ASSOC_CONFIRM</span>:
		<span class="n">wl3501_assoc_confirm_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_AUTH_CONFIRM</span>:
		<span class="n">wl3501_auth_confirm_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WL3501_SIG_RESYNC_CONFIRM</span>:
		<span class="n">wl3501_mgmt_resync</span><span class="p">(</span><span class="n">this</span><span class="p">);</span> <span class="cm">/* FIXME: should be resync_confirm */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wl3501_esbq_confirm_done</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">morepkts</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* free request if necessary */</span>
<span class="nl">free:</span>
	<span class="n">wl3501_esbq_req_free</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">morepkts</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">loop</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">wl3501_ack_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wl3501_outb</span><span class="p">(</span><span class="n">WL3501_GCR_ECINT</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_interrupt - Hardware interrupt from card.</span>
<span class="cm"> * @irq - Interrupt number</span>
<span class="cm"> * @dev_id - net_device</span>
<span class="cm"> *</span>
<span class="cm"> * We must acknowledge the interrupt as soon as possible, and block the</span>
<span class="cm"> * interrupt from the same card immediately to prevent re-entry.</span>
<span class="cm"> *</span>
<span class="cm"> * Before accessing the Control_Status_Block, we must lock SUTRO first.</span>
<span class="cm"> * On the other hand, to prevent SUTRO from malfunctioning, we must</span>
<span class="cm"> * unlock the SUTRO as soon as possible.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">wl3501_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>

	<span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">wl3501_ack_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">wl3501_block_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">wl3501_rx_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wl3501_unblock_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_reset_board</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Coreset */</span>
	<span class="n">wl3501_outb_p</span><span class="p">(</span><span class="n">WL3501_GCR_CORESET</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>
	<span class="n">wl3501_outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>
	<span class="n">wl3501_outb_p</span><span class="p">(</span><span class="n">WL3501_GCR_CORESET</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>

	<span class="cm">/* Reset SRAM 0x480 to zero */</span>
	<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x480</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="cm">/* Start up */</span>
	<span class="n">wl3501_outb_p</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">WL3501_NIC_GCR</span><span class="p">);</span>

	<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">50</span><span class="p">);</span>

	<span class="n">wl3501_unblock_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>	<span class="cm">/* acme: was commented */</span>

	<span class="cm">/* Polling Self_Test_Status */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x480</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="sc">&#39;W&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* firmware complete all test successfully */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="sc">&#39;A&#39;</span><span class="p">;</span>
			<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x480</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">WL3501_NOPLOOP</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: failed to reset the board!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_init_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">next</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_reset_board</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x1a00</span><span class="p">,</span>
			    <span class="n">this</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">));</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">firmware_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x1a40</span><span class="p">,</span>
			    <span class="n">this</span><span class="o">-&gt;</span><span class="n">firmware_date</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">firmware_date</span><span class="p">));</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">firmware_date</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">firmware_date</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="cm">/* Switch to SRAM Page 0 */</span>
	<span class="n">wl3501_switch_page</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_BSS_SPAGE0</span><span class="p">);</span>
	<span class="cm">/* Read parameter from card */</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x482</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_start</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x486</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_end</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x488</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm_start</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x48c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm_end</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x48e</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">wl3501_get_from_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mh">0x492</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_size</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_tail</span>	<span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_head</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_start</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_end</span>     <span class="o">+=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_req_start</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm</span>	<span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm_start</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm_end</span> <span class="o">+=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">esbq_confirm_start</span><span class="p">;</span>
	<span class="cm">/* Initial Tx Buffer */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">WL3501_BLKSZ</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">next</span> <span class="o">-</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_head</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">next</span><span class="p">));</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">ptr</span> <span class="o">+</span> <span class="n">WL3501_BLKSZ</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl3501_set_to_wla</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">next</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">next</span><span class="p">));</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_tail</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="n">link</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">--</span><span class="p">;</span>

	<span class="cm">/* Stop wl3501_hard_start_xmit() from now on */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wl3501_ack_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

	<span class="cm">/* Mask interrupts from the SUTRO */</span>
	<span class="n">wl3501_block_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: WL3501 closed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_reset - Reset the SUTRO.</span>
<span class="cm"> * @dev - network device</span>
<span class="cm"> *</span>
<span class="cm"> * It is almost the same as wl3501_open(). In fact, we may just wl3501_close()</span>
<span class="cm"> * and wl3501_open() again, but I wouldn&#39;t like to free_irq() when the driver</span>
<span class="cm"> * is running. It seems to be dangerous.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">wl3501_block_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl3501_init_firmware</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t initialize Firmware!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="cm">/* Free IRQ, and mark IRQ as unused */</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Queue has to be started only when the Card is Started</span>
<span class="cm">	 */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">adhoc_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl3501_ack_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">wl3501_unblock_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">wl3501_mgmt_scan</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: device reset&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Error %d resetting card on Tx timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* prevent tx timeout */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Return : 0 - OK</span>
<span class="cm"> *	    1 - Could not transmit (dev_queue_xmit will queue it)</span>
<span class="cm"> *		and try to sent it later</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">wl3501_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">enabled</span> <span class="o">=</span> <span class="n">wl3501_block_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_send_pkt</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">wl3501_unblock_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">tx_buffer_cnt</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">;</span>
	<span class="n">link</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">p_dev</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcmcia_dev_present</span><span class="p">(</span><span class="n">link</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Initial WL3501 firmware */</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: Initialize WL3501 firmware...&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl3501_init_firmware</span><span class="p">(</span><span class="n">this</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="cm">/* Initial device variables */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">adhoc_times</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Acknowledge Interrupt, for cleaning last state */</span>
	<span class="n">wl3501_ack_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>

	<span class="cm">/* Enable interrupt from card after all */</span>
	<span class="n">wl3501_unblock_interrupt</span><span class="p">(</span><span class="n">this</span><span class="p">);</span>
	<span class="n">wl3501_mgmt_scan</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s: WL3501 opened&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Card Name: %s</span><span class="se">\n</span><span class="s">&quot;</span>
			 <span class="s">&quot;%s: Firmware Date: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span>
			 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">firmware_date</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t initialize firmware!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="nf">wl3501_get_wireless_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">iw_statistics</span> <span class="o">*</span><span class="n">wstats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wstats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span> <span class="cm">/* size checked: it is u32 */</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">wstats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wstats</span><span class="p">));</span>
	<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_WEP_ICV_ERROR_COUNT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_WEP_UNDECRYPTABLE_COUNT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_WEP_EXCLUDED_COUNT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">code</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_RETRY_COUNT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">retries</span>	<span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_FAILED_COUNT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_RTS_FAILURE_COUNT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_ACK_FAILURE_COUNT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_FRAME_DUPLICATE_COUNT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
		<span class="n">wstats</span><span class="o">-&gt;</span><span class="n">discard</span><span class="p">.</span><span class="n">misc</span> <span class="o">+=</span> <span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">wstats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * wl3501_detach - deletes a driver &quot;instance&quot;</span>
<span class="cm"> * @link - FILL_IN</span>
<span class="cm"> *</span>
<span class="cm"> * This deletes a driver &quot;instance&quot;. The device is de-registered with Card</span>
<span class="cm"> * Services. If it has been released, all local data structures are freed.</span>
<span class="cm"> * Otherwise, the structures will be freed when the device is released.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* If the device is currently configured and active, we won&#39;t actually</span>
<span class="cm">	 * delete it yet.  Instead, it is marked so that when the release()</span>
<span class="cm">	 * function is called, that will trigger a proper detach(). */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl3501_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wl3501_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;IEEE 802.11-DS&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_set_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iw_valid_channel</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">reg_domain</span><span class="p">,</span> <span class="n">channel</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">chan</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">ieee80211_dsss_chan_to_freq</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">chan</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100000</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_INFRA</span> <span class="o">||</span>
	    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_ADHOC</span> <span class="o">||</span>
	    <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">IW_MODE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span> <span class="o">=</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_sens</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">sens</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_range</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">iw_range</span> <span class="o">*</span><span class="p">)</span><span class="n">extra</span><span class="p">;</span>

	<span class="cm">/* Set the length (very important for backward compatibility) */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">);</span>

	<span class="cm">/* Set all the info we don&#39;t care or don&#39;t know about to zero */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">range</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">range</span><span class="p">));</span>

	<span class="cm">/* Set the Wireless Extension versions */</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_compiled</span>	<span class="o">=</span> <span class="n">WIRELESS_EXT</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">we_version_source</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">throughput</span>		<span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>     <span class="cm">/* ~2 Mb/s */</span>
	<span class="cm">/* FIXME: study the code to fill in more fields... */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_set_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bcast</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">255</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* FIXME: we support other ARPHRDs...*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">!=</span> <span class="n">ARPHRD_ETHER</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">bcast</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* FIXME: rescan? */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="cm">/* FIXME: rescan? deassoc &amp; scan? */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_wap</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_set_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: trigger scanning with a reset, yes, I&#39;m lazy</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">wl3501_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">current_ev</span> <span class="o">=</span> <span class="n">extra</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iw_event</span> <span class="n">iwe</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span>			<span class="o">=</span> <span class="n">SIOCGIWAP</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_family</span> <span class="o">=</span> <span class="n">ARPHRD_ETHER</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">ap_addr</span><span class="p">.</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_ADDR_LEN</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span>		  <span class="o">=</span> <span class="n">SIOCGIWESSID</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span>
						  <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span>	   <span class="o">=</span> <span class="n">SIOCGIWMODE</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bss_type</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_UINT_LEN</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWFREQ</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">m</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ds_pset</span><span class="p">.</span><span class="n">chan</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">freq</span><span class="p">.</span><span class="n">e</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_event</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="n">IW_EV_FREQ_LEN</span><span class="p">);</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">SIOCGIWENCODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_set</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cap_info</span> <span class="o">&amp;</span> <span class="n">WL3501_MGMT_CAPABILITY_PRIVACY</span><span class="p">)</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_ENABLED</span> <span class="o">|</span> <span class="n">IW_ENCODE_NOKEY</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
		<span class="n">iwe</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">current_ev</span> <span class="o">=</span> <span class="n">iwe_stream_add_point</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">current_ev</span><span class="p">,</span>
						  <span class="n">extra</span> <span class="o">+</span> <span class="n">IW_SCAN_MAX_DATA</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">iwe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Length of data */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_ev</span> <span class="o">-</span> <span class="n">extra</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* FIXME: set properly these flags */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iw_set_mgmt_info_element</span><span class="p">(</span><span class="n">IW_MGMT_INFO_ELEMENT_SSID</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">,</span>
					 <span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* We accept any ESSID */</span>
		<span class="n">iw_set_mgmt_info_element</span><span class="p">(</span><span class="n">IW_MGMT_INFO_ELEMENT_SSID</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">,</span> <span class="s">&quot;ANY&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">wl3501_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">flags</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_set_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="n">extra</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_nick</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">extra</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			   <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * FIXME: have to see from where to get this info, perhaps this card</span>
<span class="cm">	 * works at 1 Mbit/s too... for now leave at 2 Mbit/s that is the most</span>
<span class="cm">	 * common with the Planet Access Points. -acme</span>
<span class="cm">	 */</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">2000000</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">threshold</span><span class="p">;</span> <span class="cm">/* size checked: it is u16 */</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_RTS_THRESHOLD</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">threshold</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">threshold</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">&gt;=</span> <span class="mi">2347</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">rts</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_frag_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
				     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">threshold</span><span class="p">;</span> <span class="cm">/* size checked: it is u16 */</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_FRAG_THRESHOLD</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">threshold</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">threshold</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">&gt;=</span> <span class="mi">2346</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">frag</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_txpow</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">txpow</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
				      <span class="n">WL3501_MIB_ATTR_CURRENT_TX_PWR_LEVEL</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">txpow</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txpow</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">txpow</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * From the MIB values I think this can be configurable,</span>
<span class="cm">		 * as it lists several tx power levels -acme</span>
<span class="cm">		 */</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">txpower</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_TXPOW_MWATT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">retry</span><span class="p">;</span> <span class="cm">/* size checked: it is u8 */</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
				      <span class="n">WL3501_MIB_ATTR_LONG_RETRY_LIMIT</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">retry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">retry</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IW_RETRY_LONG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_LONG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">set_value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_SHORT_RETRY_LIMIT</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">retry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">retry</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_RETRY_LIMIT</span> <span class="o">|</span> <span class="n">IW_RETRY_SHORT</span><span class="p">;</span>
<span class="nl">set_value:</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">retry</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">retry</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_encode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">implemented</span><span class="p">,</span> <span class="k">restricted</span><span class="p">,</span> <span class="n">keys</span><span class="p">[</span><span class="mi">100</span><span class="p">],</span> <span class="n">len_keys</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
				      <span class="n">WL3501_MIB_ATTR_PRIV_OPT_IMPLEMENTED</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">implemented</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">implemented</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">implemented</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_ENCODE_DISABLED</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_EXCLUDE_UNENCRYPTED</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="k">restricted</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">restricted</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="k">restricted</span> <span class="o">?</span> <span class="n">IW_ENCODE_RESTRICTED</span> <span class="o">:</span>
					    <span class="n">IW_ENCODE_OPEN</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_WEP_KEY_MAPPINGS_LEN</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">len_keys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len_keys</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span> <span class="n">WL3501_MIB_ATTR_WEP_KEY_MAPPINGS</span><span class="p">,</span>
				  <span class="n">keys</span><span class="p">,</span> <span class="n">len_keys</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">tocopy</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u16</span><span class="p">,</span> <span class="n">len_keys</span><span class="p">,</span> <span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">tocopy</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">tocopy</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">extra</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">tocopy</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_get_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">iw_request_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			    <span class="k">union</span> <span class="n">iwreq_data</span> <span class="o">*</span><span class="n">wrqu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">extra</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">pwr_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">wl3501_get_mib_value</span><span class="p">(</span><span class="n">this</span><span class="p">,</span>
				      <span class="n">WL3501_MIB_ATTR_CURRENT_PWR_STATE</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">pwr_state</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pwr_state</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="o">!</span><span class="n">pwr_state</span><span class="p">;</span>
	<span class="n">wrqu</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IW_POWER_ON</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">iw_handler</span>	<span class="n">wl3501_handler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNAME</span><span class="p">,</span> <span class="n">wl3501_get_name</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWFREQ</span><span class="p">,</span> <span class="n">wl3501_set_freq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFREQ</span><span class="p">,</span> <span class="n">wl3501_get_freq</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWMODE</span><span class="p">,</span> <span class="n">wl3501_set_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWMODE</span><span class="p">,</span> <span class="n">wl3501_get_mode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSENS</span><span class="p">,</span> <span class="n">wl3501_get_sens</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRANGE</span><span class="p">,</span> <span class="n">wl3501_get_range</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSPY</span><span class="p">,</span> <span class="n">iw_handler_set_spy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSPY</span><span class="p">,</span> <span class="n">iw_handler_get_spy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWTHRSPY</span><span class="p">,</span> <span class="n">iw_handler_set_thrspy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWTHRSPY</span><span class="p">,</span> <span class="n">iw_handler_get_thrspy</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWAP</span><span class="p">,</span> <span class="n">wl3501_set_wap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWAP</span><span class="p">,</span> <span class="n">wl3501_get_wap</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWSCAN</span><span class="p">,</span> <span class="n">wl3501_set_scan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWSCAN</span><span class="p">,</span> <span class="n">wl3501_get_scan</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWESSID</span><span class="p">,</span> <span class="n">wl3501_set_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWESSID</span><span class="p">,</span> <span class="n">wl3501_get_essid</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCSIWNICKN</span><span class="p">,</span> <span class="n">wl3501_set_nick</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWNICKN</span><span class="p">,</span> <span class="n">wl3501_get_nick</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRATE</span><span class="p">,</span> <span class="n">wl3501_get_rate</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRTS</span><span class="p">,</span> <span class="n">wl3501_get_rts_threshold</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWFRAG</span><span class="p">,</span> <span class="n">wl3501_get_frag_threshold</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWTXPOW</span><span class="p">,</span> <span class="n">wl3501_get_txpow</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWRETRY</span><span class="p">,</span> <span class="n">wl3501_get_retry</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWENCODE</span><span class="p">,</span> <span class="n">wl3501_get_encode</span><span class="p">),</span>
	<span class="n">IW_HANDLER</span><span class="p">(</span><span class="n">SIOCGIWPOWER</span><span class="p">,</span> <span class="n">wl3501_get_power</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">iw_handler_def</span> <span class="n">wl3501_handler_def</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">num_standard</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl3501_handler</span><span class="p">),</span>
	<span class="p">.</span><span class="n">standard</span>	<span class="o">=</span> <span class="p">(</span><span class="n">iw_handler</span> <span class="o">*</span><span class="p">)</span><span class="n">wl3501_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_wireless_stats</span> <span class="o">=</span> <span class="n">wl3501_get_wireless_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">wl3501_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">wl3501_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">wl3501_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">wl3501_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">wl3501_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>

	<span class="cm">/* The io structure describes IO port mapping */</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">end</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span>	<span class="o">=</span> <span class="n">IO_DATA_PATH_WIDTH_8</span><span class="p">;</span>

	<span class="cm">/* General socket configuration */</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_flags</span>	<span class="o">=</span> <span class="n">CONF_ENABLE_IRQ</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_index</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl3501_card</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_link</span><span class="p">;</span>


	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">wl3501_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span>	<span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

	<span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">.</span><span class="n">spy_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">spy_data</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">p_dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_data</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wireless_data</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wireless_handlers</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">wl3501_handler_def</span><span class="p">;</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wl3501_config</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
<span class="nl">out_link:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl3501_card</span> <span class="o">*</span><span class="n">this</span><span class="p">;</span>

	<span class="cm">/* Try allocating IO ports.  This tries a few fixed addresses.  If you</span>
<span class="cm">	 * want, you can also read the card&#39;s config table to pick addresses --</span>
<span class="cm">	 * see the serial driver for an example. */</span>
	<span class="n">link</span><span class="o">-&gt;</span><span class="n">io_lines</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mh">0x280</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">j</span> <span class="o">+=</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The &#39;^0x300&#39; is so that we probe 0x300-0x3ff first, then</span>
<span class="cm">		 * 0x200-0x2ff, and so on, because this seems safer */</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
		<span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">pcmcia_request_io</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="cm">/* Now allocate an interrupt line. Note that this does not actually</span>
<span class="cm">	 * assign a handler to the interrupt. */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_request_irq</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">wl3501_interrupt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;wl3501_cs: register_netdev() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">this</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl3501_get_flash_mac_addr</span><span class="p">(</span><span class="n">this</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: Can&#39;t read MAC addr in flash ROM?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">)[</span><span class="n">i</span><span class="p">];</span>

	<span class="cm">/* print probe information */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: wl3501 @ 0x%3.3x, IRQ %d, &quot;</span>
	       <span class="s">&quot;MAC addr in flash ROM:%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Initialize card parameters - added by jss</span>
<span class="cm">	 */</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">net_type</span>		<span class="o">=</span> <span class="n">IW_MODE_INFRA</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">bss_cnt</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">join_sta_bss</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">adhoc_times</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">iw_set_mgmt_info_element</span><span class="p">(</span><span class="n">IW_MGMT_INFO_ELEMENT_SSID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">essid</span><span class="p">.</span><span class="n">el</span><span class="p">,</span>
				 <span class="s">&quot;ANY&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">firmware_date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">rssi</span>		<span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="n">this</span><span class="o">-&gt;</span><span class="n">chan</span>		<span class="o">=</span> <span class="n">iw_default_channel</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">reg_domain</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">,</span> <span class="s">&quot;Planet WL3501&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">nick</span><span class="p">));</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">failed:</span>
	<span class="n">wl3501_release</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl3501_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcmcia_disable_device</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">wl3501_pwr_mgmt</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">WL3501_SUSPEND</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span>
		<span class="n">netif_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl3501_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">link</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">link</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">wl3501_pwr_mgmt</span><span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span> <span class="n">WL3501_RESUME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl3501_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="n">wl3501_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">PCMCIA_DEVICE_MANF_CARD</span><span class="p">(</span><span class="mh">0xd601</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">),</span>
	<span class="n">PCMCIA_DEVICE_NULL</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">,</span> <span class="n">wl3501_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="n">wl3501_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;wl3501_cs&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">wl3501_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">wl3501_detach</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">wl3501_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">wl3501_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">wl3501_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wl3501_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pcmcia_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl3501_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">wl3501_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pcmcia_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl3501_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">wl3501_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">wl3501_exit_module</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Fox Chen &lt;mhchen@golf.ccl.itri.org.tw&gt;, &quot;</span>
	      <span class="s">&quot;Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;,&quot;</span>
	      <span class="s">&quot;Gustavo Niemeyer &lt;niemeyer@conectiva.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Planet wl3501 wireless driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
