<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › p54 › fwio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>fwio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Firmware I/O code for mac80211 Prism54 drivers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006, Michael Wu &lt;flamingice@sourmilk.net&gt;</span>
<span class="cm"> * Copyright (c) 2007-2009, Christian Lamparter &lt;chunkeey@web.de&gt;</span>
<span class="cm"> * Copyright 2008, Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on:</span>
<span class="cm"> * - the islsm (softmac prism54) driver, which is:</span>
<span class="cm"> *   Copyright 2004-2006 Jean-Baptiste Note &lt;jbnote@gmail.com&gt;, et al.</span>
<span class="cm"> * - stlc45xx driver</span>
<span class="cm"> *   Copyright (C) 2008 Nokia Corporation and/or its subsidiary(-ies).</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>

<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &quot;p54.h&quot;</span>
<span class="cp">#include &quot;eeprom.h&quot;</span>
<span class="cp">#include &quot;lmac.h&quot;</span>

<span class="kt">int</span> <span class="nf">p54_parse_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">exp_if</span> <span class="o">*</span><span class="n">exp_if</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bootrec</span> <span class="o">*</span><span class="n">bootrec</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">end_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">fw_version</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxlen</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">end_data</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">end_data</span> <span class="o">&amp;&amp;</span> <span class="o">!*</span><span class="n">data</span><span class="p">)</span>
		<span class="n">data</span><span class="o">++</span><span class="p">;</span>

	<span class="n">bootrec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bootrec</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">end_data</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
	       <span class="p">(</span><span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)))</span> <span class="o">&lt;=</span> <span class="n">end_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">code</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">BR_CODE_COMPONENT_ID</span>:
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_interface</span> <span class="o">=</span> <span class="n">be32_to_cpup</span><span class="p">((</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span>
					     <span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_interface</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">FW_LM86</span>:
			<span class="k">case</span> <span class="n">FW_LM20</span>:
			<span class="k">case</span> <span class="n">FW_LM87</span>: <span class="p">{</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">iftype</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
				<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					   <span class="s">&quot;p54 detected a LM%c%c firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">iftype</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">iftype</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="n">FW_FMAC</span>:
			<span class="nl">default:</span>
				<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					  <span class="s">&quot;unsupported firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BR_CODE_COMPONENT_VERSION</span>:
			<span class="cm">/* 24 bytes should be enough for all firmwares */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strnlen</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">)</span>
				<span class="n">fw_version</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BR_CODE_DESCR</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bootrec_desc</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">bootrec_desc</span> <span class="o">*</span><span class="p">)</span><span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">);</span>
			<span class="cm">/* FIXME add sanity checking */</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">)</span> <span class="o">-</span> <span class="mh">0x3500</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">headroom</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">headroom</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tailroom</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">tailroom</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">privacy_caps</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">privacy_caps</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_keycache_size</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">rx_keycache_size</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">==</span> <span class="mi">11</span><span class="p">)</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_mtu</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">rx_mtu</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_mtu</span> <span class="o">=</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)</span>
					<span class="mh">0x620</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_hdr_len</span><span class="p">;</span>
			<span class="n">maxlen</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_hdr_len</span> <span class="o">+</span> <span class="cm">/* USB devices */</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_rx_data</span><span class="p">)</span> <span class="o">+</span>
				 <span class="mi">4</span> <span class="o">+</span> <span class="cm">/* rx alignment */</span>
				 <span class="n">IEEE80211_MAX_FRAG_THRESHOLD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_mtu</span> <span class="o">&gt;</span> <span class="n">maxlen</span> <span class="o">&amp;&amp;</span> <span class="n">PAGE_SIZE</span> <span class="o">==</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;p54: rx_mtu reduced from %d &quot;</span>
				       <span class="s">&quot;to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_mtu</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">);</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_mtu</span> <span class="o">=</span> <span class="n">maxlen</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="k">case</span> <span class="n">BR_CODE_EXPOSED_IF</span>:
			<span class="n">exp_if</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">exp_if</span> <span class="o">*</span><span class="p">)</span> <span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">exp_if</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">exp_if</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">if_id</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IF_ID_LMAC</span><span class="p">))</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">exp_if</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">variant</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BR_CODE_DEPENDENT_IF</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">BR_CODE_END_OF_BRA</span>:
		<span class="k">case</span> <span class="n">LEGACY_BR_CODE_END_OF_BRA</span>:
			<span class="n">end_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bootrec</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bootrec</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">bootrec</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">len</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_version</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			   <span class="s">&quot;FW rev %s - Softmac protocol %x.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">fw_version</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
				<span class="s">&quot;%s - %x.%x&quot;</span><span class="p">,</span> <span class="n">fw_version</span><span class="p">,</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&lt;</span> <span class="mh">0x500</span><span class="p">)</span>
		<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			   <span class="s">&quot;you are using an obsolete firmware. &quot;</span>
			   <span class="s">&quot;visit http://wireless.kernel.org/en/users/Drivers/p54 &quot;</span>
			   <span class="s">&quot;and grab one for </span><span class="se">\&quot;</span><span class="s">kernel &gt;= 2.6.28</span><span class="se">\&quot;</span><span class="s">!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&gt;=</span> <span class="mh">0x300</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Firmware supports QoS, use it! */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&gt;=</span> <span class="mh">0x500</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">P54_QUEUE_AC_VO</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">P54_QUEUE_AC_VI</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">P54_QUEUE_AC_BE</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">P54_QUEUE_AC_BK</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">P54_QUEUE_AC_VO</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">P54_QUEUE_AC_VI</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">P54_QUEUE_AC_BE</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">P54_QUEUE_AC_BK</span><span class="p">].</span><span class="n">limit</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">P54_QUEUE_AC_NUM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
		   <span class="s">&quot;cryptographic accelerator WEP:%s, TKIP:%s, CCMP:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">privacy_caps</span> <span class="o">&amp;</span> <span class="n">BR_DESC_PRIV_CAP_WEP</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">privacy_caps</span> <span class="o">&amp;</span>
		    <span class="p">(</span><span class="n">BR_DESC_PRIV_CAP_TKIP</span> <span class="o">|</span> <span class="n">BR_DESC_PRIV_CAP_MICHAEL</span><span class="p">))</span>
		   <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">privacy_caps</span> <span class="o">&amp;</span> <span class="n">BR_DESC_PRIV_CAP_AESCCMP</span><span class="p">)</span>
		   <span class="o">?</span> <span class="s">&quot;YES&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_keycache_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * NOTE:</span>
<span class="cm">		 *</span>
<span class="cm">		 * The firmware provides at most 255 (0 - 254) slots</span>
<span class="cm">		 * for keys which are then used to offload decryption.</span>
<span class="cm">		 * As a result the 255 entry (aka 0xff) can be used</span>
<span class="cm">		 * safely by the driver to mark keys that didn&#39;t fit</span>
<span class="cm">		 * into the full cache. This trick saves us from</span>
<span class="cm">		 * keeping a extra list for uploaded keys.</span>
<span class="cm">		 */</span>

		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">used_rxkeys</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">BITS_TO_LONGS</span><span class="p">(</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_keycache_size</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">used_rxkeys</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">p54_parse_firmware</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">p54_alloc_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">hdr_flags</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">payload_len</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">memflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">frame_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">payload_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame_len</span> <span class="o">&gt;</span> <span class="n">P54_MAX_CTRL_FRAME_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">__dev_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_hdr_len</span> <span class="o">+</span> <span class="n">frame_len</span><span class="p">,</span> <span class="n">memflags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_hdr_len</span><span class="p">);</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hdr_flags</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">payload_len</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">tries</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">rts_tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_download_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_eeprom_lm86</span> <span class="o">*</span><span class="n">eeprom_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">eeprom_hdr_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&gt;=</span> <span class="mh">0x509</span><span class="p">)</span>
		<span class="n">eeprom_hdr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">eeprom_hdr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">eeprom_hdr_size</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL</span><span class="p">,</span> <span class="n">eeprom_hdr_size</span> <span class="o">+</span>
			    <span class="n">len</span><span class="p">,</span> <span class="n">P54_CONTROL_TYPE_EEPROM_READBACK</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_mutex</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">eeprom_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_eeprom_lm86</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span>
		<span class="n">eeprom_hdr_size</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&lt;</span> <span class="mh">0x509</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eeprom_hdr</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">eeprom_hdr</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">eeprom_hdr</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
		<span class="n">eeprom_hdr</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
		<span class="n">eeprom_hdr</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">magic2</span> <span class="o">=</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">eeprom_hdr</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">magic</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="s">&quot;LOCK&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span>
	     <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_comp</span><span class="p">,</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;device does not respond!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_update_beacon_tim</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">aid</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_tim</span> <span class="o">*</span><span class="n">tim</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tim</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_TIM</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">tim</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_tim</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tim</span><span class="p">));</span>
	<span class="n">tim</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tim</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">set</span> <span class="o">?</span> <span class="p">(</span><span class="n">aid</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">:</span> <span class="n">aid</span><span class="p">);</span>
	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_sta_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_sta_unlock</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sta</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_PSM_STA_UNLOCK</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_sta_unlock</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sta</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_tx_cancel</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">req_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_txcancel</span> <span class="o">*</span><span class="n">cancel</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">_req_id</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">req_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">_req_id</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_start</span> <span class="o">||</span> <span class="n">_req_id</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cancel</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_TXCANCEL</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">cancel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_txcancel</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cancel</span><span class="p">));</span>
	<span class="n">cancel</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">req_id</span><span class="p">;</span>
	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_setup_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_setup_mac</span> <span class="o">*</span><span class="n">setup</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_SETUP</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">setup</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_setup_mac</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">setup</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
			<span class="n">mode</span> <span class="o">=</span> <span class="n">P54_FILTER_TYPE_STATION</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
			<span class="n">mode</span> <span class="o">=</span> <span class="n">P54_FILTER_TYPE_AP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
			<span class="n">mode</span> <span class="o">=</span> <span class="n">P54_FILTER_TYPE_IBSS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
			<span class="n">mode</span> <span class="o">=</span> <span class="n">P54_FILTER_TYPE_PROMISCUOUS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">P54_FILTER_TYPE_HIBERNATE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * &quot;TRANSPARENT and PROMISCUOUS are mutually exclusive&quot;</span>
<span class="cm">		 * STSW45X0C LMAC API - page 12</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_OTHER_BSS</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">P54_FILTER_TYPE_PROMISCUOUS</span><span class="p">))</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">P54_FILTER_TYPE_TRANSPARENT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">P54_FILTER_TYPE_HIBERNATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">setup</span><span class="o">-&gt;</span><span class="n">mac_mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">setup</span><span class="o">-&gt;</span><span class="n">rx_antenna</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_diversity_mask</span><span class="p">;</span> <span class="cm">/* automatic */</span>
	<span class="n">setup</span><span class="o">-&gt;</span><span class="n">rx_align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&lt;</span> <span class="mh">0x500</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">basic_rate_mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">basic_rate_mask</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">rts_rates</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">rx_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">max_rx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_mtu</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">rxhw</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">wakeup_timer</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wakeup_timer</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">unalloc0</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">rx_addr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_end</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">max_rx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_mtu</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">rxhw</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">timer</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wakeup_timer</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">truncate</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">48896</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">basic_rate_mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">basic_rate_mask</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">sbss_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">mcast_window</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">rx_rssi_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">rx_ed_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">ref_clock</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">644245094</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">lpf_bandwidth</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">65535</span><span class="p">);</span>
		<span class="n">setup</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">osc_start_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">65535</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_idle</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">P54_FILTER_TYPE_HIBERNATE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u16</span> <span class="n">mode</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dwell</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_scan_head</span> <span class="o">*</span><span class="n">head</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_iq_autocal_entry</span> <span class="o">*</span><span class="n">iq_autocal</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">p54_scan_body_union</span> <span class="o">*</span><span class="n">body</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_scan_tail_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pda_rssi_cal_entry</span> <span class="o">*</span><span class="n">rssi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_rssi_db_entry</span> <span class="o">*</span><span class="n">rssi_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">)</span> <span class="o">+</span>
			    <span class="mi">2</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iq_autocal</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">body</span><span class="p">)</span> <span class="o">+</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rate</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rssi</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_SCAN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_scan_head</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">head</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">scan_params</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">scan_params</span><span class="p">));</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">dwell</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span> <span class="o">==</span> <span class="n">PDR_SYNTH_FRONTEND_LONGBOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="o">*</span><span class="n">pa_power_points</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="o">*</span><span class="n">pa_power_points</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">iq_autocal</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">iq_autocal</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iq_autocal_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iq_autocal</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">freq</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">iq_autocal</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iq_autocal</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">params</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_iq_autocal_entry</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iq_autocal_len</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span> <span class="o">==</span> <span class="n">PDR_SYNTH_FRONTEND_LONGBOW</span><span class="p">)</span>
		<span class="n">body</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">longbow</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">body</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">output_limit</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="o">*</span><span class="n">entry_freq</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">output_limit</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				     <span class="n">priv</span><span class="o">-&gt;</span><span class="n">output_limit</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">entry_freq</span> <span class="o">!=</span> <span class="n">freq</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span> <span class="o">==</span> <span class="n">PDR_SYNTH_FRONTEND_LONGBOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">longbow</span><span class="p">.</span><span class="n">power_limits</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry_freq</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">),</span>
			       <span class="n">priv</span><span class="o">-&gt;</span><span class="n">output_limit</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pda_channel_output_limit</span> <span class="o">*</span><span class="n">limits</span> <span class="o">=</span>
			       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry_freq</span><span class="p">;</span>

			<span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">val_barker</span> <span class="o">=</span> <span class="mh">0x38</span><span class="p">;</span>
			<span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">val_bpsk</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">dup_bpsk</span> <span class="o">=</span>
				<span class="n">limits</span><span class="o">-&gt;</span><span class="n">val_bpsk</span><span class="p">;</span>
			<span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">val_qpsk</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">dup_qpsk</span> <span class="o">=</span>
				<span class="n">limits</span><span class="o">-&gt;</span><span class="n">val_qpsk</span><span class="p">;</span>
			<span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">val_16qam</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">dup_16qam</span> <span class="o">=</span>
				<span class="n">limits</span><span class="o">-&gt;</span><span class="n">val_16qam</span><span class="p">;</span>
			<span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">val_64qam</span> <span class="o">=</span> <span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">dup_64qam</span> <span class="o">=</span>
				<span class="n">limits</span><span class="o">-&gt;</span><span class="n">val_64qam</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">output_limit</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">entry</span><span class="p">)</span> <span class="o">!=</span> <span class="n">freq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">entry</span> <span class="o">+=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span> <span class="o">==</span> <span class="n">PDR_SYNTH_FRONTEND_LONGBOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">longbow</span><span class="p">.</span><span class="n">curve_data</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">),</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">p54_scan_body</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">body</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">pda_pa_curve_data</span> <span class="o">*</span><span class="n">curve_data</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="n">entry</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">pa_points_per_curve</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="p">));</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="p">,</span> <span class="n">entry</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_pa_curve_data_sample</span><span class="p">)</span> <span class="o">*</span>
			       <span class="n">min</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="mi">8</span><span class="p">,</span> <span class="n">curve_data</span><span class="o">-&gt;</span><span class="n">points_per_channel</span><span class="p">));</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curve_data</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&gt;=</span> <span class="mh">0x500</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&lt;</span> <span class="mh">0x509</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rate</span><span class="p">));</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">basic_rate_mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">basic_rate_mask</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">rts_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rate</span><span class="o">-&gt;</span><span class="n">rts_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rssi</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pda_rssi_cal_entry</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rssi</span><span class="p">));</span>
	<span class="n">rssi_data</span> <span class="o">=</span> <span class="n">p54_rssi_find</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">freq</span><span class="p">));</span>
	<span class="n">rssi</span><span class="o">-&gt;</span><span class="n">mul</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rssi_data</span><span class="o">-&gt;</span><span class="n">mul</span><span class="p">);</span>
	<span class="n">rssi</span><span class="o">-&gt;</span><span class="n">add</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rssi_data</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span> <span class="o">==</span> <span class="n">PDR_SYNTH_FRONTEND_LONGBOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Longbow frontend needs ever more */</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rssi</span><span class="p">));</span>
		<span class="n">rssi</span><span class="o">-&gt;</span><span class="n">mul</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rssi_data</span><span class="o">-&gt;</span><span class="n">longbow_unkn</span><span class="p">);</span>
		<span class="n">rssi</span><span class="o">-&gt;</span><span class="n">add</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rssi_data</span><span class="o">-&gt;</span><span class="n">longbow_unk2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&gt;=</span> <span class="mh">0x509</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rate</span><span class="p">));</span>
		<span class="n">rate</span><span class="o">-&gt;</span><span class="n">basic_rate_mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">basic_rate_mask</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">rts_rates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">rate</span><span class="o">-&gt;</span><span class="n">rts_rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>

	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi</span> <span class="o">=</span> <span class="n">rssi_data</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;frequency change to channel %d failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span>
			  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">));</span>

	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_set_leds</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_led</span> <span class="o">*</span><span class="n">led</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">led</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_LED</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">led</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_led</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">led</span><span class="p">));</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">led</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">softled_state</span><span class="p">);</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">led</span><span class="o">-&gt;</span><span class="n">delay</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_set_edcf</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_edcf</span> <span class="o">*</span><span class="n">edcf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rtd</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">edcf</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_DCFINIT</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">edcf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_edcf</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">edcf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">slottime</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">sifs</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">eofpad</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">slottime</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">sifs</span> <span class="o">=</span> <span class="mh">0x0a</span><span class="p">;</span>
		<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">eofpad</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * calculate the extra round trip delay according to the</span>
<span class="cm">	 * formula from 802.11-2007 17.3.8.6.</span>
<span class="cm">	 */</span>
	<span class="n">rtd</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">coverage_class</span><span class="p">;</span>
	<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">slottime</span> <span class="o">+=</span> <span class="n">rtd</span><span class="p">;</span>
	<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">round_trip_delay</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rtd</span><span class="p">);</span>
	<span class="cm">/* (see prism54/isl_oid.h for further details) */</span>
	<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">frameburst</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">edcf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">edcf</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">edcf</span><span class="o">-&gt;</span><span class="n">mapping</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">edcf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">qos_params</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">edcf</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">));</span>
	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_set_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_psm</span> <span class="o">*</span><span class="n">psm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">powersave_override</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">P54_PSM</span> <span class="o">|</span> <span class="n">P54_PSM_BEACON_TIMEOUT</span> <span class="o">|</span> <span class="n">P54_PSM_DTIM</span> <span class="o">|</span>
		       <span class="n">P54_PSM_CHECKSUM</span> <span class="o">|</span> <span class="n">P54_PSM_MCBC</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">P54_PSM_CAM</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psm</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_PSM</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">psm</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_psm</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">psm</span><span class="p">));</span>
	<span class="n">psm</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">psm</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">psm</span><span class="o">-&gt;</span><span class="n">intervals</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">psm</span><span class="o">-&gt;</span><span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">interval</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">listen_interval</span><span class="p">);</span>
		<span class="n">psm</span><span class="o">-&gt;</span><span class="n">intervals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">periods</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">psm</span><span class="o">-&gt;</span><span class="n">beacon_rssi_skip_max</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">psm</span><span class="o">-&gt;</span><span class="n">rssi_delta_threshold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">psm</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">psm</span><span class="o">-&gt;</span><span class="n">exclude</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_TIM</span><span class="p">;</span>

	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_ps</span> <span class="o">=</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">P54_PSM_CAM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_init_xbow_synth</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_xbow_synth</span> <span class="o">*</span><span class="n">xbow</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">xbow</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_XBOW_SYNTH_CFG</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">xbow</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_xbow_synth</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">xbow</span><span class="p">));</span>
	<span class="n">xbow</span><span class="o">-&gt;</span><span class="n">magic1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x1</span><span class="p">);</span>
	<span class="n">xbow</span><span class="o">-&gt;</span><span class="n">magic2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mh">0x2</span><span class="p">);</span>
	<span class="n">xbow</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">5390</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">xbow</span><span class="o">-&gt;</span><span class="n">padding</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">xbow</span><span class="o">-&gt;</span><span class="n">padding</span><span class="p">));</span>
	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_upload_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">algo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u8</span><span class="o">*</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_keycache</span> <span class="o">*</span><span class="n">rxkey</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxkey</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_RX_KEYCACHE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">rxkey</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_keycache</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rxkey</span><span class="p">));</span>
	<span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">entry</span> <span class="o">=</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key_id</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">algo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">algo</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P54_CRYPTO_WEP</span>:
	<span class="k">case</span> <span class="n">P54_CRYPTO_AESCCMP</span>:
		<span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">P54_CRYPTO_TKIPMICHAEL</span>:
		<span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">16</span><span class="p">]),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">key</span>
			<span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY</span><span class="p">]),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">P54_CRYPTO_NONE</span>:
		<span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rxkey</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;invalid cryptographic algorithm: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">algo</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_fetch_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">txinfo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_tx_info</span> <span class="o">*</span><span class="n">p54info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_statistics</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_STAT_READBACK</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The statistic feedback causes some extra headaches here, if it</span>
<span class="cm">	 * is not to crash/corrupt the firmware data structures.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Unlike all other Control Get OIDs we can not use helpers like</span>
<span class="cm">	 * skb_put to reserve the space for the data we&#39;re requesting.</span>
<span class="cm">	 * Instead the extra frame length -which will hold the results later-</span>
<span class="cm">	 * will only be told to the p54_assign_address, so that following</span>
<span class="cm">	 * frames won&#39;t be placed into the  allegedly empty area.</span>
<span class="cm">	 */</span>
	<span class="n">txinfo</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">p54info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">txinfo</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
	<span class="n">p54info</span><span class="o">-&gt;</span><span class="n">extra_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_statistics</span><span class="p">);</span>

	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">p54_set_groupfilter</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_group_address_table</span> <span class="o">*</span><span class="n">grp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">p54_alloc_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">P54_HDR_FLAG_CONTROL_OPSET</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">grp</span><span class="p">),</span>
			    <span class="n">P54_CONTROL_TYPE_GROUP_ADDRESS_TABLE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">grp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_group_address_table</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">grp</span><span class="p">));</span>

	<span class="n">on</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc_maclist_num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc_maclist_num</span> <span class="o">&lt;=</span> <span class="n">MC_FILTER_ADDRESS_NUM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">filter_enable</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">num_address</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc_maclist_num</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">mc_maclist</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">filter_enable</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">grp</span><span class="o">-&gt;</span><span class="n">num_address</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">grp</span><span class="o">-&gt;</span><span class="n">mac_list</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
