<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › p54 › txrx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>txrx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Common code for mac80211 Prism54 drivers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2006, Michael Wu &lt;flamingice@sourmilk.net&gt;</span>
<span class="cm"> * Copyright (c) 2007-2009, Christian Lamparter &lt;chunkeey@web.de&gt;</span>
<span class="cm"> * Copyright 2008, Johannes Berg &lt;johannes@sipsolutions.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on:</span>
<span class="cm"> * - the islsm (softmac prism54) driver, which is:</span>
<span class="cm"> *   Copyright 2004-2006 Jean-Baptiste Note &lt;jbnote@gmail.com&gt;, et al.</span>
<span class="cm"> * - stlc45xx driver</span>
<span class="cm"> *   Copyright (C) 2008 Nokia Corporation and/or its subsidiary(-ies).</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &quot;p54.h&quot;</span>
<span class="cp">#include &quot;lmac.h&quot;</span>

<span class="cp">#ifdef P54_MM_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_dump_tx_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_tx_info</span> <span class="o">*</span><span class="n">range</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">prev_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">largest_hole</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">free</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;/ --- tx queue dump (%d entries) ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">));</span>

	<span class="n">prev_addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">;</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="n">free</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">-</span> <span class="n">prev_addr</span><span class="p">;</span>
		<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="s">&quot;| [%02d] =&gt; [skb:%p skb_len:0x%04x &quot;</span>
			    <span class="s">&quot;hdr:{flags:%02x len:%04x req_id:%04x type:%02x} &quot;</span>
			    <span class="s">&quot;mem:{start:%04x end:%04x, free:%d}]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">),</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">),</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span>
			    <span class="n">range</span><span class="o">-&gt;</span><span class="n">start_addr</span><span class="p">,</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end_addr</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>

		<span class="n">prev_addr</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end_addr</span><span class="p">;</span>
		<span class="n">largest_hole</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">largest_hole</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">free</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">-</span> <span class="n">prev_addr</span><span class="p">;</span>
	<span class="n">largest_hole</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">largest_hole</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>
	<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
		    <span class="s">&quot;</span><span class="se">\\</span><span class="s"> --- [free: %d], largest free block: %d ---</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">free</span><span class="p">,</span> <span class="n">largest_hole</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* P54_MM_DEBUG */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * So, the firmware is somewhat stupid and doesn&#39;t know what places in its</span>
<span class="cm"> * memory incoming data should go to. By poking around in the firmware, we</span>
<span class="cm"> * can find some unused memory to upload our packets to. However, data that we</span>
<span class="cm"> * want the card to TX needs to stay intact until the card has told us that</span>
<span class="cm"> * it is done with it. This function finds empty places we can upload to and</span>
<span class="cm"> * marks allocated areas as reserved if necessary. p54_find_and_unlink_skb or</span>
<span class="cm"> * p54_free_skb frees allocated areas.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">p54_assign_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">entry</span><span class="p">,</span> <span class="o">*</span><span class="n">target_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_tx_info</span> <span class="o">*</span><span class="n">range</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">last_addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">target_addr</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_start</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">headroom</span> <span class="o">+</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tailroom</span> <span class="o">+</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">range</span><span class="o">-&gt;</span><span class="n">extra_len</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The tx_queue is now really full.</span>
<span class="cm">		 *</span>
<span class="cm">		 * TODO: check if the device has crashed and reset it.</span>
<span class="cm">		 */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">hole_size</span><span class="p">;</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
		<span class="n">hole_size</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">-</span> <span class="n">last_addr</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">target_skb</span> <span class="o">&amp;&amp;</span> <span class="n">hole_size</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">target_skb</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">prev</span><span class="p">;</span>
			<span class="n">hole_size</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">target_addr</span> <span class="o">=</span> <span class="n">last_addr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">last_addr</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end_addr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">target_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rx_end</span> <span class="o">-</span> <span class="n">last_addr</span> <span class="o">&gt;=</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">target_skb</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">prev</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb_queue_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">target_skb</span><span class="p">);</span>
				<span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
				<span class="n">target_addr</span> <span class="o">=</span> <span class="n">range</span><span class="o">-&gt;</span><span class="n">end_addr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">range</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">start_addr</span> <span class="o">=</span> <span class="n">target_addr</span><span class="p">;</span>
	<span class="n">range</span><span class="o">-&gt;</span><span class="n">end_addr</span> <span class="o">=</span> <span class="n">target_addr</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">target_addr</span> <span class="o">+</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">headroom</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DATA_FRAME</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">unlikely</span><span class="p">(</span><span class="n">GET_HW_QUEUE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">P54_QUEUE_BEACON</span><span class="p">))</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_req_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">;</span>

	<span class="n">__skb_queue_after</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">target_skb</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_tx_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p54_assign_address</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_wake_queues</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">p54_tx_pending</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">P54_QUEUE_DATA</span><span class="p">].</span><span class="n">len</span> <span class="o">&lt;</span>
		    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="n">P54_QUEUE_DATA</span><span class="p">].</span><span class="n">limit</span><span class="p">)</span>
			<span class="n">ieee80211_wake_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p54_tx_qos_accounting_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				       <span class="k">const</span> <span class="n">u16</span> <span class="n">p54_queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_tx_queue_stats</span> <span class="o">*</span><span class="n">queue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">p54_queue</span> <span class="o">&gt;=</span> <span class="n">P54_QUEUE_NUM</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">queue</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">p54_queue</span><span class="p">];</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">IS_QOS_QUEUE</span><span class="p">(</span><span class="n">p54_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">++</span><span class="p">;</span>
	<span class="n">queue</span><span class="o">-&gt;</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">==</span> <span class="n">queue</span><span class="o">-&gt;</span><span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">IS_QOS_QUEUE</span><span class="p">(</span><span class="n">p54_queue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">ac_queue</span> <span class="o">=</span> <span class="n">p54_queue</span> <span class="o">-</span> <span class="n">P54_QUEUE_DATA</span><span class="p">;</span>
		<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">ac_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_tx_qos_accounting_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_DATA_FRAME</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">GET_HW_QUEUE</span><span class="p">(</span><span class="n">skb</span><span class="p">)].</span><span class="n">len</span><span class="o">--</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">GET_HW_QUEUE</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">==</span> <span class="n">P54_QUEUE_BEACON</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_req_id</span> <span class="o">==</span> <span class="n">GET_REQ_ID</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* this is the  active beacon set anymore */</span>
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_req_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">beacon_comp</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">p54_wake_queues</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">p54_free_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">skb_unlink</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
	<span class="n">p54_tx_qos_accounting_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">ieee80211_free_txskb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">p54_free_skb</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">p54_find_and_unlink_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					       <span class="k">const</span> <span class="n">__le32</span> <span class="n">req_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">skb_queue_walk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">req_id</span> <span class="o">==</span> <span class="n">req_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">__skb_unlink</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">p54_tx_qos_accounting_free</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">entry</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">p54_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_pending</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">p54_tx_pending</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p54_rssi_to_dbm</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span> <span class="o">!=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="p">((</span><span class="n">rssi</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi</span><span class="o">-&gt;</span><span class="n">mul</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">+</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cur_rssi</span><span class="o">-&gt;</span><span class="n">add</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * TODO: find the correct formula</span>
<span class="cm">		 */</span>
		<span class="k">return</span> <span class="n">rssi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">110</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Even if the firmware is capable of dealing with incoming traffic,</span>
<span class="cm"> * while dozing, we have to prepared in case mac80211 uses PS-POLL</span>
<span class="cm"> * to retrieve outstanding frames from our AP.</span>
<span class="cm"> * (see comment in net/mac80211/mlme.c @ line 1993)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_pspoll_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tim_ie</span> <span class="o">*</span><span class="n">tim_ie</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">tim</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tim_len</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">new_psm</span><span class="p">;</span>

	<span class="cm">/* only beacons have a TIM IE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* only consider beacons from the associated BSSID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tim</span> <span class="o">=</span> <span class="n">p54_find_ie</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">WLAN_EID_TIM</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tim</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">tim_len</span> <span class="o">=</span> <span class="n">tim</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">tim_ie</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tim_ie</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">tim</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="n">new_psm</span> <span class="o">=</span> <span class="n">ieee80211_check_tim</span><span class="p">(</span><span class="n">tim_ie</span><span class="p">,</span> <span class="n">tim_len</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_psm</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">powersave_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">powersave_override</span> <span class="o">=</span> <span class="n">new_psm</span><span class="p">;</span>
		<span class="n">p54_set_ps</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p54_rx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_rx_data</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_rx_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">rx_status</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">header_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">tsf32</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the device is in a unspecified state we have to</span>
<span class="cm">	 * ignore all data frames. Else we could end up with a</span>
<span class="cm">	 * nasty crash.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">P54_HDR_FLAG_DATA_IN_FCS_GOOD</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">decrypt_status</span> <span class="o">==</span> <span class="n">P54_DECRYPT_OK</span><span class="p">)</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_DECRYPTED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">decrypt_status</span> <span class="o">==</span> <span class="n">P54_DECRYPT_FAIL_MICHAEL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">decrypt_status</span> <span class="o">==</span> <span class="n">P54_DECRYPT_FAIL_TKIP</span><span class="p">))</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MMIC_ERROR</span><span class="p">;</span>

	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">p54_rssi_to_dbm</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">rate</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">rate</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span>  <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">antenna</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">antenna</span><span class="p">;</span>

	<span class="n">tsf32</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">tsf32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tsf32</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tsf_low32</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tsf_high32</span><span class="o">++</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">mactime</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">tsf_high32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="n">tsf32</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tsf_low32</span> <span class="o">=</span> <span class="n">tsf32</span><span class="p">;</span>

	<span class="n">rx_status</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_MACTIME_MPDU</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">P54_HDR_FLAG_DATA_ALIGN</span><span class="p">))</span>
		<span class="n">header_len</span> <span class="o">+=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">header_len</span><span class="p">);</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">))</span>
		<span class="n">p54_pspoll_workaround</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">ieee80211_rx_irqsafe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span>
			   <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">P54_STATISTICS_UPDATE</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_rx_frame_sent</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_frame_sent</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_frame_sent</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">entry_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_tx_data</span> <span class="o">*</span><span class="n">entry_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">entry</span> <span class="o">=</span> <span class="n">p54_find_and_unlink_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">entry</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">frame_len</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
	<span class="n">entry_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">entry_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_tx_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dot11ACKFailureCount</span> <span class="o">+=</span> <span class="n">payload</span><span class="o">-&gt;</span><span class="n">tries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Frames in P54_QUEUE_FWSCAN and P54_QUEUE_BEACON are</span>
<span class="cm">	 * generated by the driver. Therefore tx_status is bogus</span>
<span class="cm">	 * and we don&#39;t want to confuse the mac80211 stack.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">entry_data</span><span class="o">-&gt;</span><span class="n">hw_queue</span> <span class="o">&lt;</span> <span class="n">P54_QUEUE_FWSCAN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear manually, ieee80211_tx_info_clear_status would</span>
<span class="cm">	 * clear the counts too and we need them.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span><span class="p">)</span> <span class="o">-</span>
	       <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span><span class="p">,</span> <span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">));</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_tx_info</span><span class="p">,</span>
			      <span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">23</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entry_hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">P54_HDR_FLAG_DATA_ALIGN</span><span class="p">))</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="n">entry_data</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* walk through the rates array and adjust the counts */</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">payload</span><span class="o">-&gt;</span><span class="n">tries</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="p">(</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">P54_TX_FAILED</span><span class="p">))</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">P54_TX_PSM_CANCELLED</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_TX_FILTERED</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ack_signal</span> <span class="o">=</span> <span class="n">p54_rssi_to_dbm</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
						  <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">payload</span><span class="o">-&gt;</span><span class="n">ack_rssi</span><span class="p">);</span>

	<span class="cm">/* Undo all changes to the frame. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">entry_data</span><span class="o">-&gt;</span><span class="n">key_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P54_CRYPTO_TKIPMICHAEL</span>: <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">entry_data</span><span class="o">-&gt;</span><span class="n">align</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span>
				<span class="n">entry_data</span><span class="o">-&gt;</span><span class="n">crypt_offset</span><span class="p">);</span>

		<span class="cm">/* Restore the original TKIP IV. */</span>
		<span class="n">iv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">iv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>	<span class="cm">/* WEPSeed - 8.3.2.2 */</span>

		<span class="n">frame_len</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span> <span class="cm">/* remove TKIP_MMIC + TKIP_ICV */</span>
		<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">P54_CRYPTO_AESCCMP</span>:
		<span class="n">frame_len</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span> <span class="cm">/* remove CCMP_MIC */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_CRYPTO_WEP</span>:
		<span class="n">frame_len</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* remove WEP_ICV */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_trim</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">frame_len</span><span class="p">);</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">pad</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entry_data</span><span class="p">));</span>
	<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_rx_eeprom_readback</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_eeprom_lm86</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_eeprom_lm86</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">fw_var</span> <span class="o">&gt;=</span> <span class="mh">0x509</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">v2</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
		       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">p54_find_and_unlink_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">eeprom_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_rx_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_statistics</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_statistics</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">cca</span><span class="p">,</span> <span class="n">dtime</span><span class="p">,</span> <span class="n">dtotal</span><span class="p">,</span> <span class="n">dcca</span><span class="p">,</span> <span class="n">dtx</span><span class="p">,</span> <span class="n">drssi</span><span class="p">,</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tsf32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_UNSPECIFIED</span><span class="p">))</span>
		<span class="k">return</span> <span class="p">;</span>

	<span class="n">tsf32</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">tsf32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tsf32</span> <span class="o">&lt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tsf_low32</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tsf_high32</span><span class="o">++</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">tsf_low32</span> <span class="o">=</span> <span class="n">tsf32</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dot11RTSFailureCount</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rts_fail</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dot11RTSSuccessCount</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rts_success</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">dot11FCSErrorCount</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bad_fcs</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">p54_rssi_to_dbm</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * STSW450X LMAC API page 26 - 3.8 Statistics</span>
<span class="cm">	 * &quot;The exact measurement period can be derived from the</span>
<span class="cm">	 * timestamp member&quot;.</span>
<span class="cm">	 */</span>
	<span class="n">dtime</span> <span class="o">=</span> <span class="n">tsf32</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * STSW450X LMAC API page 26 - 3.8.1 Noise histogram</span>
<span class="cm">	 * The LMAC samples RSSI, CCA and transmit state at regular</span>
<span class="cm">	 * periods (typically 8 times per 1k [as in 1024] usec).</span>
<span class="cm">	 */</span>
	<span class="n">cca</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sample_cca</span><span class="p">);</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sample_tx</span><span class="p">);</span>
	<span class="n">rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sample_noise</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rssi</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">stats</span><span class="o">-&gt;</span><span class="n">sample_noise</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">dcca</span> <span class="o">=</span> <span class="n">cca</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">cached_cca</span><span class="p">;</span>
	<span class="n">drssi</span> <span class="o">=</span> <span class="n">rssi</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">cached_rssi</span><span class="p">;</span>
	<span class="n">dtx</span> <span class="o">=</span> <span class="n">tx</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">cached_tx</span><span class="p">;</span>
	<span class="n">dtotal</span> <span class="o">=</span> <span class="n">dcca</span> <span class="o">+</span> <span class="n">drssi</span> <span class="o">+</span> <span class="n">dtx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * update statistics when more than a second is over since the</span>
<span class="cm">	 * last call, or when a update is badly needed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dtotal</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">update_stats</span> <span class="o">||</span> <span class="n">dtime</span> <span class="o">&gt;=</span> <span class="n">USEC_PER_SEC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dtime</span> <span class="o">&gt;=</span> <span class="n">dtotal</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">tsf32</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">update_stats</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">unit</span> <span class="o">=</span> <span class="n">dtime</span> <span class="o">/</span> <span class="n">dtotal</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dcca</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">cca</span> <span class="o">+=</span> <span class="n">dcca</span> <span class="o">*</span> <span class="n">unit</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">cached_cca</span> <span class="o">=</span> <span class="n">cca</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dtx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">tx</span> <span class="o">+=</span> <span class="n">dtx</span> <span class="o">*</span> <span class="n">unit</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">cached_tx</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">drssi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">rssi</span> <span class="o">+=</span> <span class="n">drssi</span> <span class="o">*</span> <span class="n">unit</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">cached_rssi</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* 1024 usec / 8 times = 128 usec / time */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_ps</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">phy_idle</span><span class="p">))</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">active</span> <span class="o">+=</span> <span class="n">dtotal</span> <span class="o">*</span> <span class="n">unit</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">active</span> <span class="o">+=</span> <span class="p">(</span><span class="n">dcca</span> <span class="o">+</span> <span class="n">dtx</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">curchan</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey</span><span class="p">[</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">];</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">s8</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">active</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_tx</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
		<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_busy</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">tx</span> <span class="o">+</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">survey_raw</span><span class="p">.</span><span class="n">cca</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_tx</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel_time_busy</span><span class="p">,</span> <span class="mi">1024</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">p54_find_and_unlink_skb</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">req_id</span><span class="p">);</span>
	<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">stat_comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_rx_trap</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_trap</span> <span class="o">*</span><span class="n">trap</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_trap</span> <span class="o">*</span><span class="p">)</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">event</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">trap</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P54_TRAP_BEACON_TX</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_TRAP_RADAR</span>:
		<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;radar (freq:%d MHz)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_TRAP_NO_BEACON</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span>
			<span class="n">ieee80211_beacon_loss</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_TRAP_SCAN</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_TRAP_TBTT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_TRAP_TIMER</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_TRAP_FAA_RADIO_OFF</span>:
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_TRAP_FAA_RADIO_ON</span>:
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wiphy_info</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;received event:%x freq:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">event</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">p54_rx_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">P54_CONTROL_TYPE_TXDONE</span>:
		<span class="n">p54_rx_frame_sent</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_CONTROL_TYPE_TRAP</span>:
		<span class="n">p54_rx_trap</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_CONTROL_TYPE_BBP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_CONTROL_TYPE_STAT_READBACK</span>:
		<span class="n">p54_rx_stats</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">P54_CONTROL_TYPE_EEPROM_READBACK</span>:
		<span class="n">p54_rx_eeprom_readback</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wiphy_debug</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			    <span class="s">&quot;not handling 0x%02x type control frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns zero if skb can be reused */</span>
<span class="kt">int</span> <span class="nf">p54_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">P54_HDR_FLAG_CONTROL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">p54_rx_control</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">p54_rx_data</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">p54_rx</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">p54_tx_80211_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">queue</span><span class="p">,</span>
				<span class="n">u32</span> <span class="o">*</span><span class="n">extra_len</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">aid</span><span class="p">,</span>
				<span class="n">bool</span> <span class="o">*</span><span class="n">burst_possible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
		<span class="o">*</span><span class="n">burst_possible</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">burst_possible</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_ASSIGN_SEQ</span><span class="p">))</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">P54_HDR_FLAG_DATA_OUT_SEQNR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_PS_BUFFER</span><span class="p">)</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">P54_HDR_FLAG_DATA_OUT_NOCANCEL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_CLEAR_PS_FILT</span><span class="p">)</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">P54_HDR_FLAG_DATA_OUT_NOCANCEL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">+</span> <span class="n">P54_QUEUE_DATA</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MONITOR</span>:
		<span class="cm">/*</span>
<span class="cm">		 * We have to set P54_HDR_FLAG_DATA_OUT_PROMISC for</span>
<span class="cm">		 * every frame in promiscuous/monitor mode.</span>
<span class="cm">		 * see STSW45x0C LMAC API - page 12.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">P54_HDR_FLAG_DATA_OUT_PROMISC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="o">*</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_AP</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_MESH_POINT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_SEND_AFTER_DTIM</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">P54_QUEUE_CAB</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">P54_HDR_FLAG_DATA_OUT_TIMESTAMP</span> <span class="o">|</span>
					  <span class="n">P54_HDR_FLAG_DATA_OUT_NOCANCEL</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_beacon</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_INJECTED</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * Injecting beacons on top of a AP is</span>
<span class="cm">					 * not a good idea... nevertheless,</span>
<span class="cm">					 * it should be doable.</span>
<span class="cm">					 */</span>

					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">P54_HDR_FLAG_DATA_OUT_TIMESTAMP</span><span class="p">;</span>
				<span class="o">*</span><span class="n">queue</span> <span class="o">=</span> <span class="n">P54_QUEUE_BEACON</span><span class="p">;</span>
				<span class="o">*</span><span class="n">extra_len</span> <span class="o">=</span> <span class="n">IEEE80211_MAX_TIM_LEN</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">)</span>
			<span class="o">*</span><span class="n">aid</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">p54_convert_algo</span><span class="p">(</span><span class="n">u32</span> <span class="n">cipher</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">return</span> <span class="n">P54_CRYPTO_WEP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="k">return</span> <span class="n">P54_CRYPTO_TKIPMICHAEL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="k">return</span> <span class="n">P54_CRYPTO_AESCCMP</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">p54_tx_80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">p54_common</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">p54_tx_info</span> <span class="o">*</span><span class="n">p54info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">p54_tx_data</span> <span class="o">*</span><span class="n">txhdr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">padding</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">extra_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ridx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">hdr_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">aid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">crypt_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cts_rate</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rc_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">calculated_tries</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">nrates</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nremaining</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">burst_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">p54_tx_80211_header</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">extra_len</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">hdr_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">aid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">burst_allowed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p54_tx_qos_accounting_alloc</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ieee80211_free_txskb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">padding</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txhdr</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crypt_offset</span> <span class="o">=</span> <span class="n">ieee80211_get_hdrlen_from_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">crypt_offset</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * The firmware excepts that the IV has to have</span>
<span class="cm">			 * this special format</span>
<span class="cm">			 */</span>
			<span class="n">iv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">iv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">iv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">txhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_tx_data</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">txhdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">padding</span><span class="p">);</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">p54_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span>
		<span class="n">hdr_flags</span> <span class="o">|=</span> <span class="n">P54_HDR_FLAG_DATA_ALIGN</span><span class="p">;</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">aid</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">rts_tries</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * we register the rates in perfect order, and</span>
<span class="cm">	 * RTS/CTS won&#39;t happen on 5 GHz</span>
<span class="cm">	 */</span>
	<span class="n">cts_rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rts_cts_rate_idx</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">));</span>

	<span class="cm">/* see how many rates got used */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_rates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">nrates</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* limit tries to 8/nrates per rate */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The magic expression here is equivalent to 8/nrates for</span>
<span class="cm">		 * all values that matter, but avoids division and jumps.</span>
<span class="cm">		 * Note that nrates can only take the values 1 through 4.</span>
<span class="cm">		 */</span>
		<span class="n">calculated_tries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="p">((</span><span class="mi">15</span> <span class="o">&gt;&gt;</span> <span class="n">nrates</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
						 <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">);</span>
		<span class="n">nremaining</span> <span class="o">-=</span> <span class="n">calculated_tries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* if there are tries left, distribute from back to front */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">nrates</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">nremaining</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">-</span> <span class="n">calculated_tries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* RC requested more tries at this rate */</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">nremaining</span><span class="p">);</span>
		<span class="n">calculated_tries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">nremaining</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ridx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nrates</span> <span class="o">&amp;&amp;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we register the rates in perfect order */</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">rate</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>

		<span class="cm">/* store the count we actually calculated for TX status */</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">calculated_tries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">rc_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_SHORT_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">cts_rate</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_RTS_CTS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">burst_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">rate</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rc_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_USE_CTS_PROTECT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="n">burst_allowed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">calculated_tries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">ridx</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">rateset</span><span class="p">[</span><span class="n">ridx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
			<span class="n">ridx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">burst_allowed</span><span class="p">)</span>
		<span class="n">hdr_flags</span> <span class="o">|=</span> <span class="n">P54_HDR_FLAG_DATA_OUT_BURST</span><span class="p">;</span>

	<span class="cm">/* TODO: enable bursting */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hdr_flags</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">tries</span> <span class="o">=</span> <span class="n">ridx</span><span class="p">;</span>
	<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">rts_rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">p54_convert_algo</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="n">u8</span><span class="p">)</span><span class="mi">16</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* reserve space for the MIC key */</span>
			<span class="n">len</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">key</span>
				<span class="p">[</span><span class="n">NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY</span><span class="p">]),</span> <span class="mi">8</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* reserve some space for ICV */</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">icv_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">key_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">crypt_offset</span> <span class="o">=</span> <span class="n">crypt_offset</span><span class="p">;</span>
	<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">hw_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="p">;</span>
	<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">backlog</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_stats</span><span class="p">[</span><span class="n">queue</span><span class="p">].</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">durations</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">durations</span><span class="p">));</span>
	<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">tx_antenna</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">tx_diversity_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rxhw</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">longbow</span><span class="p">.</span><span class="n">cts_rate</span> <span class="o">=</span> <span class="n">cts_rate</span><span class="p">;</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">longbow</span><span class="p">.</span><span class="n">output_power</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">output_power</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">output_power</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">output_power</span><span class="p">;</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">normal</span><span class="p">.</span><span class="n">cts_rate</span> <span class="o">=</span> <span class="n">cts_rate</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">padding</span><span class="p">)</span>
		<span class="n">txhdr</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">padding</span><span class="p">;</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="cm">/* modifies skb-&gt;cb and with it info, so must be last! */</span>
	<span class="n">p54info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rate_driver_data</span><span class="p">;</span>
	<span class="n">p54info</span><span class="o">-&gt;</span><span class="n">extra_len</span> <span class="o">=</span> <span class="n">extra_len</span><span class="p">;</span>

	<span class="n">p54_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
