<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ti › wl1251 › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is part of wl1251</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008-2009 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;wl1251.h&quot;</span>
<span class="cp">#include &quot;wl12xx_80211.h&quot;</span>
<span class="cp">#include &quot;reg.h&quot;</span>
<span class="cp">#include &quot;io.h&quot;</span>
<span class="cp">#include &quot;cmd.h&quot;</span>
<span class="cp">#include &quot;event.h&quot;</span>
<span class="cp">#include &quot;tx.h&quot;</span>
<span class="cp">#include &quot;rx.h&quot;</span>
<span class="cp">#include &quot;ps.h&quot;</span>
<span class="cp">#include &quot;init.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;boot.h&quot;</span>

<span class="kt">void</span> <span class="nf">wl1251_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="o">-&gt;</span><span class="n">enable_irq</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wl1251_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="o">-&gt;</span><span class="n">disable_irq</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_fetch_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wiphy_dev</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">WL1251_FW_NAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;could not get firmware: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;firmware size is not multiple of 32 bits: %zu&quot;</span><span class="p">,</span>
			     <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_len</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="n">vmalloc</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;could not allocate memory for the firmware&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_fetch_nvs</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wiphy_dev</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">WL1251_NVS_NAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;could not get nvs file: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;nvs size is not multiple of 32 bits: %zu&quot;</span><span class="p">,</span>
			     <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs_len</span> <span class="o">=</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;could not allocate memory for the nvs file&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1251_fw_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">elp_reg</span><span class="p">;</span>

	<span class="n">elp_reg</span> <span class="o">=</span> <span class="n">ELPCTRL_WAKE_UP</span><span class="p">;</span>
	<span class="n">wl1251_write_elp</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">HW_ACCESS_ELP_CTRL_REG_ADDR</span><span class="p">,</span> <span class="n">elp_reg</span><span class="p">);</span>
	<span class="n">elp_reg</span> <span class="o">=</span> <span class="n">wl1251_read_elp</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">HW_ACCESS_ELP_CTRL_REG_ADDR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">elp_reg</span> <span class="o">&amp;</span> <span class="n">ELPCTRL_WLAN_READY</span><span class="p">))</span>
		<span class="n">wl1251_warning</span><span class="p">(</span><span class="s">&quot;WLAN not ready&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_chip_wakeup</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_power_on</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">msleep</span><span class="p">(</span><span class="n">WL1251_POWER_ON_SLEEP</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">if_ops</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t need a real memory partition here, because we only want</span>
<span class="cm">	 * to use the registers at this point. */</span>
	<span class="n">wl1251_set_partition</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
			     <span class="mh">0x00000000</span><span class="p">,</span>
			     <span class="mh">0x00000000</span><span class="p">,</span>
			     <span class="n">REGISTERS_BASE</span><span class="p">,</span>
			     <span class="n">REGISTERS_DOWN_SIZE</span><span class="p">);</span>

	<span class="cm">/* ELP module wake up */</span>
	<span class="n">wl1251_fw_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="cm">/* whal_FwCtrl_BootSm() */</span>

	<span class="cm">/* 0. read chip id from CHIP_ID */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">=</span> <span class="n">wl1251_reg_read32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CHIP_ID_B</span><span class="p">);</span>

	<span class="cm">/* 1. check if chip id is valid */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CHIP_ID_1251_PG12</span>:
		<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_BOOT</span><span class="p">,</span> <span class="s">&quot;chip id 0x%x (1251 PG12)&quot;</span><span class="p">,</span>
			     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_ID_1251_PG11</span>:
		<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_BOOT</span><span class="p">,</span> <span class="s">&quot;chip id 0x%x (1251 PG11)&quot;</span><span class="p">,</span>
			     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CHIP_ID_1251_PG10</span>:
	<span class="nl">default:</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;unsupported chip id: 0x%x&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_fetch_firmware</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">use_eeprom</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No NVS from netlink, try to get it from the filesystem */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_fetch_nvs</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1251_IRQ_LOOP_COUNT 10</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1251_irq_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">intr</span><span class="p">,</span> <span class="n">ctr</span> <span class="o">=</span> <span class="n">WL1251_IRQ_LOOP_COUNT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl1251</span><span class="p">,</span> <span class="n">irq_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;IRQ work&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1251_STATE_OFF</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl1251_reg_write32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_REG_INTERRUPT_MASK</span><span class="p">,</span> <span class="n">WL1251_ACX_INTR_ALL</span><span class="p">);</span>

	<span class="n">intr</span> <span class="o">=</span> <span class="n">wl1251_reg_read32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_REG_INTERRUPT_CLEAR</span><span class="p">);</span>
	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;intr: 0x%x&quot;</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">data_path</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span> <span class="o">=</span> <span class="n">wl1251_mem_read32</span><span class="p">(</span>
				<span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">data_path</span><span class="o">-&gt;</span><span class="n">rx_control_addr</span><span class="p">);</span>

			<span class="cm">/* We handle a frmware bug here */</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span> <span class="o">-</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_handled</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
				<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span>
					     <span class="s">&quot;RX: FW and host in sync&quot;</span><span class="p">);</span>
				<span class="n">intr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WL1251_ACX_INTR_RX0_DATA</span><span class="p">;</span>
				<span class="n">intr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WL1251_ACX_INTR_RX1_DATA</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
				<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;RX: FW +1&quot;</span><span class="p">);</span>
				<span class="n">intr</span> <span class="o">|=</span> <span class="n">WL1251_ACX_INTR_RX0_DATA</span><span class="p">;</span>
				<span class="n">intr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WL1251_ACX_INTR_RX1_DATA</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
				<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;RX: FW +2&quot;</span><span class="p">);</span>
				<span class="n">intr</span> <span class="o">|=</span> <span class="n">WL1251_ACX_INTR_RX0_DATA</span><span class="p">;</span>
				<span class="n">intr</span> <span class="o">|=</span> <span class="n">WL1251_ACX_INTR_RX1_DATA</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">wl1251_warning</span><span class="p">(</span>
					<span class="s">&quot;RX: FW and host out of sync: %d&quot;</span><span class="p">,</span>
					<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span> <span class="o">-</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_handled</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_handled</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span><span class="p">;</span>

			<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;RX counter: %d&quot;</span><span class="p">,</span>
				     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">intr</span> <span class="o">&amp;=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;INTR is 0&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1251_ACX_INTR_RX0_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1251_ACX_INTR_RX0_DATA&quot;</span><span class="p">);</span>
			<span class="n">wl1251_rx</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1251_ACX_INTR_RX1_DATA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1251_ACX_INTR_RX1_DATA&quot;</span><span class="p">);</span>
			<span class="n">wl1251_rx</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1251_ACX_INTR_TX_RESULT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1251_ACX_INTR_TX_RESULT&quot;</span><span class="p">);</span>
			<span class="n">wl1251_tx_complete</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1251_ACX_INTR_EVENT_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1251_ACX_INTR_EVENT_A&quot;</span><span class="p">);</span>
			<span class="n">wl1251_event_handle</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1251_ACX_INTR_EVENT_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span> <span class="s">&quot;WL1251_ACX_INTR_EVENT_B&quot;</span><span class="p">);</span>
			<span class="n">wl1251_event_handle</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1251_ACX_INTR_INIT_COMPLETE</span><span class="p">)</span>
			<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_IRQ</span><span class="p">,</span>
				     <span class="s">&quot;WL1251_ACX_INTR_INIT_COMPLETE&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">ctr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">intr</span> <span class="o">=</span> <span class="n">wl1251_reg_read32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_REG_INTERRUPT_CLEAR</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">intr</span><span class="p">);</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1251_reg_write32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_REG_INTERRUPT_MASK</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">intr_mask</span><span class="p">));</span>
	<span class="n">wl1251_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_join</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bss_type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">beacon_interval</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dtim_period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_frame_rates</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">DEFAULT_HW_GEN_TX_RATE</span><span class="p">,</span>
				     <span class="n">DEFAULT_HW_GEN_MODULATION_TYPE</span><span class="p">,</span>
				     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_mgmt_frm_rate</span><span class="p">,</span>
				     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_mgmt_frm_mod</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_join</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">bss_type</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">beacon_interval</span><span class="p">,</span>
			      <span class="n">dtim_period</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_event_wait</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">JOIN_EVENT_COMPLETE_ID</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1251_warning</span><span class="p">(</span><span class="s">&quot;join timeout&quot;</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1251_filter_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl1251</span><span class="p">,</span> <span class="n">filter_work</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WL1251_STATE_OFF</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_join</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">,</span>
			  <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1251_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1251_op_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The chip specific setup must run before the first TX packet -</span>
<span class="cm">	 * before that, the tx_work will not be initialized!</span>
<span class="cm">	 */</span>

	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The workqueue is slow to process the tx_queue and we need stop</span>
<span class="cm">	 * the queue here, otherwise the queue will get too long.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">WL1251_TX_QUEUE_HIGH_WATERMARK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;op_tx: tx_queue full, stop queues&quot;</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_op_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 start&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL1251_STATE_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;cannot start because not in off state: %d&quot;</span><span class="p">,</span>
			     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_chip_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_boot</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_hw_init</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_station_id</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1251_STATE_ON</span><span class="p">;</span>

	<span class="n">wl1251_info</span><span class="p">(</span><span class="s">&quot;firmware booted (%s)&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">);</span>

	<span class="cm">/* update hw/fw version info in wiphy struct */</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">hw_version</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">;</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw_ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">));</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1251_power_off</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1251_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">wl1251_info</span><span class="p">(</span><span class="s">&quot;down&quot;</span><span class="p">);</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 stop&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WL1251_STATE_ON</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_scan_completed</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1251_STATE_OFF</span><span class="p">;</span>

	<span class="n">wl1251_disable_interrupts</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* let&#39;s notify MAC80211 about the remaining pending TX frames */</span>
	<span class="n">wl1251_tx_flush</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">wl1251_power_off</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">listen_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">MAX_BSS_TYPE</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">data_in_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_current_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_last_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">next_tx_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">station_mode</span> <span class="o">=</span> <span class="n">STATION_ACTIVE_MODE</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_POWER_LEVEL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rssi_thold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_CHANNEL</span><span class="p">;</span>

	<span class="n">wl1251_debugfs_reset</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_op_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vif</span><span class="o">-&gt;</span><span class="n">driver_flags</span> <span class="o">|=</span> <span class="n">IEEE80211_VIF_BEACON_FILTER</span> <span class="o">|</span>
			     <span class="n">IEEE80211_VIF_SUPPORTS_CQM_RSSI</span><span class="p">;</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 add interface type %d mac %pM&quot;</span><span class="p">,</span>
		     <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">BSS_TYPE_STA_BSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">=</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_station_id</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1251_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 remove interface&quot;</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_build_qos_null_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_qos_hdr</span> <span class="n">template</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">template</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">template</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">template</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">template</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span>
					     <span class="n">IEEE80211_STYPE_QOS_NULLFUNC</span> <span class="o">|</span>
					     <span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>

	<span class="cm">/* FIXME: not sure what priority to use here */</span>
	<span class="n">template</span><span class="p">.</span><span class="n">qos_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wl1251_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_QOS_NULL_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">template</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_op_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 config ch %d psm %s power %d&quot;</span><span class="p">,</span>
		     <span class="n">channel</span><span class="p">,</span>
		     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">,</span>
		     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">!=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_join</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
				  <span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">psm_requested</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_PSM</span><span class="p">,</span> <span class="s">&quot;psm enabled&quot;</span><span class="p">);</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">psm_requested</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">ps_dtim_period</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_wr_tbtt_and_dtim</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">,</span>
						  <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * mac80211 enables PSM only if we&#39;re already associated.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_set_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">STATION_POWER_SAVE_MODE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="n">wl</span><span class="o">-&gt;</span><span class="n">psm_requested</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_PSM</span><span class="p">,</span> <span class="s">&quot;psm disabled&quot;</span><span class="p">);</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">psm_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">station_mode</span> <span class="o">!=</span> <span class="n">STATION_ACTIVE_MODE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_set_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">STATION_ACTIVE_MODE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_IDLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_IDLE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_set_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">STATION_IDLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_set_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">STATION_ACTIVE_MODE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_join</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					  <span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">!=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_tx_power</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1251_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define WL1251_SUPPORTED_FILTERS (FIF_PROMISC_IN_BSS | \</span>
<span class="cp">				  FIF_ALLMULTI | \</span>
<span class="cp">				  FIF_FCSFAIL | \</span>
<span class="cp">				  FIF_BCN_PRBRESP_PROMISC | \</span>
<span class="cp">				  FIF_CONTROL | \</span>
<span class="cp">				  FIF_OTHER_BSS)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1251_op_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total</span><span class="p">,</span><span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 configure filter&quot;</span><span class="p">);</span>

	<span class="o">*</span><span class="n">total</span> <span class="o">&amp;=</span> <span class="n">WL1251_SUPPORTED_FILTERS</span><span class="p">;</span>
	<span class="n">changed</span> <span class="o">&amp;=</span> <span class="n">WL1251_SUPPORTED_FILTERS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="cm">/* no filters which we support changed */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* FIXME: wl-&gt;rx_config and wl-&gt;rx_filter are not protected */</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_RX_CONFIG</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_RX_FILTER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">|=</span> <span class="n">CFG_BSSID_FILTER_EN</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">|=</span> <span class="n">CFG_RX_ALL_GOOD</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * CFG_MC_FILTER_EN in rx_config needs to be 0 to receive</span>
<span class="cm">		 * all multicast frames</span>
<span class="cm">		 */</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_MC_FILTER_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_filter</span> <span class="o">|=</span> <span class="n">CFG_RX_FCS_ERROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_BSSID_FILTER_EN</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_SSID_FILTER_EN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_filter</span> <span class="o">|=</span> <span class="n">CFG_RX_CTL_EN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">total</span> <span class="o">&amp;</span> <span class="n">FIF_OTHER_BSS</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_filter</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CFG_BSSID_FILTER_EN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * FIXME: workqueues need to be properly cancelled on stop(), for</span>
<span class="cm">	 * now let&#39;s just disable changing the filter settings. They will</span>
<span class="cm">	 * be updated any on config().</span>
<span class="cm">	 */</span>
	<span class="cm">/* schedule_work(&amp;wl-&gt;filter_work); */</span>
<span class="p">}</span>

<span class="cm">/* HW encryption */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_set_key_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">wl1251_cmd_set_keys</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">mac80211_key</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mac80211_key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_WEP_DEFAULT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_WEP_ADDR</span><span class="p">;</span>

		<span class="n">mac80211_key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">mac80211_key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_TKIP_MIC_GROUP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_TKIP_MIC_PAIRWISE</span><span class="p">;</span>

		<span class="n">mac80211_key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">mac80211_key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_AES_GROUP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">key</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_AES_PAIRWISE</span><span class="p">;</span>
		<span class="n">mac80211_key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;Unknown key cipher 0x%x&quot;</span><span class="p">,</span> <span class="n">mac80211_key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_op_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1251_cmd_set_keys</span> <span class="o">*</span><span class="n">wl_cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">bcast_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span> <span class="p">};</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 set key&quot;</span><span class="p">);</span>

	<span class="n">wl_cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl_cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">sta</span> <span class="o">?</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">:</span> <span class="n">bcast_addr</span><span class="p">;</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;CMD: 0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">wl1251_dump</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;ADDR: &quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;Key: algo:0x%x, id:%d, len:%d flags 0x%x&quot;</span><span class="p">,</span>
		     <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">wl1251_dump</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;KEY: &quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We dont support TX only encryption */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key_action</span> <span class="o">=</span> <span class="n">KEY_ADD_OR_REPLACE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
		<span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key_action</span> <span class="o">=</span> <span class="n">KEY_REMOVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;Unsupported key cmd 0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_set_key_type</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl_cmd</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;Set KEY type failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">!=</span> <span class="n">KEY_WEP_DEFAULT</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_TKIP_MIC_GROUP</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_TKIP_MIC_PAIRWISE</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We get the key in the following form:</span>
<span class="cm">		 * TKIP (16 bytes) - TX MIC (8 bytes) - RX MIC (8 bytes)</span>
<span class="cm">		 * but the target is expecting:</span>
<span class="cm">		 * TKIP - RX MIC - TX MIC</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>

	<span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>
	<span class="n">wl_cmd</span><span class="o">-&gt;</span><span class="n">ssid_profile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1251_dump</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;TARGET KEY: &quot;</span><span class="p">,</span> <span class="n">wl_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl_cmd</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_SET_KEYS</span><span class="p">,</span> <span class="n">wl_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_warning</span><span class="p">(</span><span class="s">&quot;could not set keys&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1251_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl_cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_op_hw_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 hw scan&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ssid</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid</span><span class="p">;</span>
		<span class="n">ssid_len</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">scanning</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_SCAN</span><span class="p">,</span> <span class="s">&quot;scan already in progress&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_probereq_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span>
				     <span class="n">req</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_PROBE_REQ</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_trigger_scan_to</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_scan</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span>
			      <span class="n">req</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">,</span> <span class="n">WL1251_SCAN_NUM_PROBES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1251_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_op_set_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_rts_threshold</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1251_warning</span><span class="p">(</span><span class="s">&quot;wl1251_op_set_rts_threshold failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">wl1251_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wl1251_op_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">,</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 bss info changed&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_CQM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_low_rssi</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span><span class="p">,</span>
					  <span class="n">WL1251_DEFAULT_LOW_RSSI_WEIGHT</span><span class="p">,</span>
					  <span class="n">WL1251_DEFAULT_LOW_RSSI_DEPTH</span><span class="p">,</span>
					  <span class="n">WL1251_ACX_LOW_RSSI_TYPE_EDGE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rssi_thold</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_nullfunc_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_NULL_DATA</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_build_qos_null_data</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">!=</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_join</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
					  <span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">;</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_pspoll_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_PS_POLL</span><span class="p">,</span>
						      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
						      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_aid</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* use defaults when not associated */</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_BEACON_INT</span><span class="p">;</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_DTIM_PERIOD</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_slot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">SLOT_TIME_SHORT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_slot</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">SLOT_TIME_LONG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1251_warning</span><span class="p">(</span><span class="s">&quot;Set slot time failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_PREAMBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_short_preamble</span><span class="p">)</span>
			<span class="n">wl1251_acx_set_preamble</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_PREAMBLE_SHORT</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">wl1251_acx_set_preamble</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_PREAMBLE_LONG</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_CTS_PROT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">use_cts_prot</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_cts_protect</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CTSPROTECT_ENABLE</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_cts_protect</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CTSPROTECT_DISABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1251_warning</span><span class="p">(</span><span class="s">&quot;Set ctsprotect failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_BEACON</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_PROBE_RESP</span><span class="p">,</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					      <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">beacon</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_join</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">bss_type</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">,</span>
				  <span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1251_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* can&#39;t be const, mac80211 writes to this */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">wl1251_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x400</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x800</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* can&#39;t be const, mac80211 writes to this */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">wl1251_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2412</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2417</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2422</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2427</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2432</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2437</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2442</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2447</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2452</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2457</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">11</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2462</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2467</span><span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">hw_value</span> <span class="o">=</span> <span class="mi">13</span><span class="p">,</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2472</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_op_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">wl1251_acx_ps_scheme</span> <span class="n">ps_scheme</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl1251_debug</span><span class="p">(</span><span class="n">DEBUG_MAC80211</span><span class="p">,</span> <span class="s">&quot;mac80211 conf tx %d&quot;</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_ps_elp_wakeup</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* mac80211 uses units of 32 usec */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_ac_cfg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl1251_tx_get_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_min</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cw_max</span><span class="p">,</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">aifs</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">txop</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">uapsd</span><span class="p">)</span>
		<span class="n">ps_scheme</span> <span class="o">=</span> <span class="n">WL1251_ACX_PS_SCHEME_UPSD_TRIGGER</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ps_scheme</span> <span class="o">=</span> <span class="n">WL1251_ACX_PS_SCHEME_LEGACY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_acx_tid_cfg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl1251_tx_get_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span>
				 <span class="n">CHANNEL_TYPE_EDCF</span><span class="p">,</span>
				 <span class="n">wl1251_tx_get_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">),</span> <span class="n">ps_scheme</span><span class="p">,</span>
				 <span class="n">WL1251_ACX_ACK_POLICY_LEGACY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_sleep</span><span class="p">;</span>

<span class="nl">out_sleep:</span>
	<span class="n">wl1251_ps_elp_sleep</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_op_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
 
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
 
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">noise</span><span class="p">;</span>
 
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* can&#39;t be const, mac80211 writes to this */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">wl1251_band_2ghz</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">wl1251_channels</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl1251_channels</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">wl1251_rates</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl1251_rates</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">wl1251_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">wl1251_op_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">wl1251_op_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span> <span class="o">=</span> <span class="n">wl1251_op_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span> <span class="o">=</span> <span class="n">wl1251_op_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">wl1251_op_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span> <span class="o">=</span> <span class="n">wl1251_op_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">wl1251_op_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span> <span class="o">=</span> <span class="n">wl1251_op_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_scan</span> <span class="o">=</span> <span class="n">wl1251_op_hw_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span> <span class="o">=</span> <span class="n">wl1251_op_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_rts_threshold</span> <span class="o">=</span> <span class="n">wl1251_op_set_rts_threshold</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span> <span class="o">=</span> <span class="n">wl1251_op_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_survey</span> <span class="o">=</span> <span class="n">wl1251_op_get_survey</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_read_eeprom_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">wl1251_reg_write32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">EE_ADDR</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">wl1251_reg_write32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">EE_CTL</span><span class="p">,</span> <span class="n">EE_CTL_READ</span><span class="p">);</span>

	<span class="cm">/* EE_CTL_READ clears when data is ready */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wl1251_reg_read32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">EE_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">EE_CTL_READ</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">wl1251_reg_read32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">EE_DATA</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="kt">off_t</span> <span class="n">offset</span><span class="p">,</span>
			      <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1251_reg_write32</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">EE_START</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_read_eeprom_byte</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_read_eeprom_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1251_set_partition</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">REGISTERS_BASE</span><span class="p">,</span> <span class="n">REGISTERS_DOWN_SIZE</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_read_eeprom</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mac</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_warning</span><span class="p">(</span><span class="s">&quot;failed to read MAC address from EEPROM&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MAC is stored in reverse order */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">-</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1251_register_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;unable to register mac80211 hw: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">wl1251_notice</span><span class="p">(</span><span class="s">&quot;loaded&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1251_init_ieee80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* The tx descriptor buffer and the TKIP space */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tx_double_buffer_desc</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">WL1251_TKIP_IV_SPACE</span><span class="p">;</span>

	<span class="cm">/* unit us */</span>
	<span class="cm">/* FIXME: find a proper value */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SUPPORTS_PS</span> <span class="o">|</span>
		<span class="n">IEEE80211_HW_SUPPORTS_UAPSD</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
					 <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl1251_band_2ghz</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">use_eeprom</span><span class="p">)</span>
		<span class="n">wl1251_read_eeprom_mac</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1251_register_hw</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl1251_debugfs_init</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">wl1251_notice</span><span class="p">(</span><span class="s">&quot;initialized&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wl1251_init_ieee80211</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="nf">wl1251_alloc_hw</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">nokia_oui</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">};</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">wl1251_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;could not alloc ieee80211_hw&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="p">));</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">data_in_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_work</span><span class="p">,</span> <span class="n">wl1251_filter_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp_work</span><span class="p">,</span> <span class="n">wl1251_elp_work</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_CHANNEL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">scanning</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">default_key</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">listen_int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_current_buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_last_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_config</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_RX_CONFIG</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_filter</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_RX_FILTER</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">elp</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">station_mode</span> <span class="o">=</span> <span class="n">STATION_ACTIVE_MODE</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">psm_requested</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_POWER_LEVEL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rssi_thold</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_int</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_BEACON_INT</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">dtim_period</span> <span class="o">=</span> <span class="n">WL1251_DEFAULT_DTIM_PERIOD</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FW_TX_CMPLT_BLOCK_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_frames</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">next_tx_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">,</span> <span class="n">wl1251_irq_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">wl1251_tx_work</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * In case our MAC address is not correctly set,</span>
<span class="cm">	 * we use a random but Nokia MAC.</span>
<span class="cm">	 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">nokia_oui</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">get_random_bytes</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1251_STATE_OFF</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_mgmt_frm_rate</span> <span class="o">=</span> <span class="n">DEFAULT_HW_GEN_TX_RATE</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_mgmt_frm_mod</span> <span class="o">=</span> <span class="n">DEFAULT_HW_GEN_MODULATION_TYPE</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_descriptor</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_descriptor</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_descriptor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1251_error</span><span class="p">(</span><span class="s">&quot;could not allocate memory for rx descriptor&quot;</span><span class="p">);</span>
		<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">hw</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wl1251_alloc_hw</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">wl1251_free_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1251</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">wl1251_debugfs_exit</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">data_path</span><span class="p">);</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nvs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_descriptor</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rx_descriptor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wl1251_free_hw</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TI wl1251 Wireles LAN Driver Core&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kalle Valo &lt;kvalo@adurom.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">WL1251_FW_NAME</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
