<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ti › wlcore › cmd.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>cmd.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is part of wl1271</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009-2010 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Contact: Luciano Coelho &lt;luciano.coelho@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;wlcore.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;io.h&quot;</span>
<span class="cp">#include &quot;acx.h&quot;</span>
<span class="cp">#include &quot;wl12xx_80211.h&quot;</span>
<span class="cp">#include &quot;cmd.h&quot;</span>
<span class="cp">#include &quot;event.h&quot;</span>
<span class="cp">#include &quot;tx.h&quot;</span>

<span class="cp">#define WL1271_CMD_FAST_POLL_COUNT       50</span>

<span class="cm">/*</span>
<span class="cm"> * send command to firmware</span>
<span class="cm"> *</span>
<span class="cm"> * @wl: wl struct</span>
<span class="cm"> * @id: command id</span>
<span class="cm"> * @buf: buffer containing the command, must work with dma</span>
<span class="cm"> * @len: length of the buffer</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wl1271_cmd_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">res_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_cmd_header</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">len</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WL1271_FLAG_IN_ELP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="n">wl1271_write</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">cmd_box_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: we just need this because one bit is in a different</span>
<span class="cm">	 * place.  Is there any better way?</span>
<span class="cm">	 */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">trigger_cmd</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">cmd_box_addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">WL1271_COMMAND_TIMEOUT</span><span class="p">);</span>

	<span class="n">intr</span> <span class="o">=</span> <span class="n">wlcore_read_reg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">REG_INTERRUPT_NO_CLEAR</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">WL1271_ACX_INTR_CMD_COMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;command complete timeout&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">poll_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">&lt;</span> <span class="n">WL1271_CMD_FAST_POLL_COUNT</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="n">intr</span> <span class="o">=</span> <span class="n">wlcore_read_reg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">REG_INTERRUPT_NO_CLEAR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* read back the status code of the command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">res_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_cmd_header</span><span class="p">);</span>
	<span class="n">wl1271_read</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">cmd_box_addr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">res_len</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">CMD_STATUS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;command execute failure %d&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlcore_write_reg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">REG_INTERRUPT_ACK</span><span class="p">,</span> <span class="n">WL1271_ACX_INTR_CMD_COMPLETE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">wl12xx_queue_recovery_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Poll the mailbox event field until any of the bits in the mask is set or a</span>
<span class="cm"> * timeout occurs (WL1271_EVENT_TIMEOUT in msecs)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_cmd_wait_for_event_or_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">events_vector</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">events_vector</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">events_vector</span><span class="p">),</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">events_vector</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">WL1271_EVENT_TIMEOUT</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;timeout waiting for event %d&quot;</span><span class="p">,</span>
				     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">mask</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* read from both event fields */</span>
		<span class="n">wl1271_read</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mbox_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">events_vector</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">events_vector</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">event</span> <span class="o">=</span> <span class="o">*</span><span class="n">events_vector</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">wl1271_read</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mbox_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">events_vector</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">events_vector</span><span class="p">),</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">event</span> <span class="o">|=</span> <span class="o">*</span><span class="n">events_vector</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">event</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">events_vector</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl1271_cmd_wait_for_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_wait_for_event_or_timeout</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl12xx_queue_recovery_work</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_role_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">role_type</span><span class="p">,</span>
			   <span class="n">u8</span> <span class="o">*</span><span class="n">role_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_enable</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role enable&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">*</span><span class="n">role_id</span> <span class="o">!=</span> <span class="n">WL12XX_INVALID_ROLE_ID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get role id */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">roles_map</span><span class="p">,</span> <span class="n">WL12XX_MAX_ROLES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">&gt;=</span> <span class="n">WL12XX_MAX_ROLES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_type</span> <span class="o">=</span> <span class="n">role_type</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_ENABLE</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role enable&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">roles_map</span><span class="p">);</span>
	<span class="o">*</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_role_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">role_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_disable</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role disable&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">*</span><span class="n">role_id</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_ROLE_ID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">role_id</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_DISABLE</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role disable&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__clear_bit</span><span class="p">(</span><span class="o">*</span><span class="n">role_id</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">roles_map</span><span class="p">);</span>
	<span class="o">*</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_ROLE_ID</span><span class="p">;</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_allocate_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">link</span> <span class="o">=</span> <span class="n">find_first_zero_bit</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">,</span> <span class="n">WL12XX_MAX_LINKS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">link</span> <span class="o">&gt;=</span> <span class="n">WL12XX_MAX_LINKS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* these bits are used by op_tx */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">);</span>
	<span class="n">__set_bit</span><span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">wl12xx_free_link</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* these bits are used by op_tx */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="o">*</span><span class="n">hlid</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">);</span>
	<span class="n">__clear_bit</span><span class="p">(</span><span class="o">*</span><span class="n">hlid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">links_map</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wl_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point op_tx() will not add more packets to the queues. We</span>
<span class="cm">	 * can purge them.</span>
<span class="cm">	 */</span>
	<span class="n">wl1271_tx_reset_link_queues</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">*</span><span class="n">hlid</span><span class="p">);</span>

	<span class="o">*</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_get_new_session_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">session_counter</span> <span class="o">&gt;=</span> <span class="n">SESSION_COUNTER_MAX</span><span class="p">)</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">session_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">session_counter</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">session_counter</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_cmd_role_start_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_start</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role start dev %d&quot;</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WLCORE_BAND_5GHZ</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_allocate_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">wl12xx_get_new_session_id</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;role start: roleid=%d, hlid=%d, session=%d&quot;</span><span class="p">,</span>
		     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">hlid</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">.</span><span class="n">session</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_START</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role enable&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_hlid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

<span class="nl">err_hlid:</span>
	<span class="cm">/* clear links on error */</span>
	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_cmd_role_stop_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_stop</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role stop dev&quot;</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">disc_type</span> <span class="o">=</span> <span class="n">DISCONNECT_IMMEDIATE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_UNSPECIFIED</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_STOP</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role stop&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_wait_for_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ROLE_STOP_COMPLETE_EVENT_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;cmd role stop dev event completion error&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_hlid</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_role_start_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_start</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role start sta %d&quot;</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WLCORE_BAND_5GHZ</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">basic_rate_set</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ssid_type</span> <span class="o">=</span> <span class="n">WL12XX_SSID_TYPE_ANY</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">local_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_allocate_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">wl12xx_get_new_session_id</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">remote_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;role start: roleid=%d, hlid=%d, session=%d &quot;</span>
		     <span class="s">&quot;basic_rate_set: 0x%x, remote_rates: 0x%x&quot;</span><span class="p">,</span>
		     <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">session</span><span class="p">,</span>
		     <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_START</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role start sta&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_hlid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

<span class="nl">err_hlid:</span>
	<span class="cm">/* clear links on error. */</span>
	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* use this function to stop ibss as well */</span>
<span class="kt">int</span> <span class="nf">wl12xx_cmd_role_stop_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_stop</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role stop sta %d&quot;</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">disc_type</span> <span class="o">=</span> <span class="n">DISCONNECT_IMMEDIATE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">WLAN_REASON_UNSPECIFIED</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_STOP</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role stop sta&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_role_start_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_start</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role start ap %d&quot;</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>

	<span class="cm">/* trying to use hidden SSID with an old hostapd version */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">hidden_ssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;got a null SSID from beacon/bss&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_allocate_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">global_hlid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_allocate_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_global</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">aging_period</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">ap_aging_period</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bss_index</span> <span class="o">=</span> <span class="n">WL1271_AP_BSS_INDEX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">global_hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">global_hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">broadcast_hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">basic_rate_set</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">dtim_interval</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">beacon_expiry</span> <span class="o">=</span> <span class="n">WL1271_AP_DEF_BEACON_EXP</span><span class="p">;</span>
	<span class="cm">/* FIXME: Change when adding DFS */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">reset_tsf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>  <span class="cm">/* By default reset AP TSF */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">hidden_ssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* take the SSID from the beacon for backward compatibility */</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_type</span> <span class="o">=</span> <span class="n">WL12XX_SSID_TYPE_PUBLIC</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_type</span> <span class="o">=</span> <span class="n">WL12XX_SSID_TYPE_HIDDEN</span><span class="p">;</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">local_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WLCORE_BAND_2_4GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WLCORE_BAND_5GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;ap start - unknown band: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WLCORE_BAND_2_4GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_START</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role start ap&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free_bcast</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

<span class="nl">out_free_bcast:</span>
	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span><span class="p">);</span>

<span class="nl">out_free_global:</span>
	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">global_hlid</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_role_stop_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_stop</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role stop ap %d&quot;</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_STOP</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role stop ap&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span><span class="p">);</span>
	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">global_hlid</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_role_start_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_role_start</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">bss_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd role start ibss %d&quot;</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WLCORE_BAND_5GHZ</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">basic_rate_set</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">dtim_interval</span> <span class="o">=</span> <span class="n">bss_conf</span><span class="o">-&gt;</span><span class="n">dtim_period</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">ssid_type</span> <span class="o">=</span> <span class="n">WL12XX_SSID_TYPE_ANY</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">ssid_len</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">ssid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">local_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_allocate_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ibss</span><span class="p">.</span><span class="n">remote_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;role start: roleid=%d, hlid=%d, session=%d &quot;</span>
		     <span class="s">&quot;basic_rate_set: 0x%x, remote_rates: 0x%x&quot;</span><span class="p">,</span>
		     <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">session</span><span class="p">,</span>
		     <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;vif-&gt;bss_conf.bssid = %pM&quot;</span><span class="p">,</span>
		     <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ROLE_START</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd role enable&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_hlid</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>

<span class="nl">err_hlid:</span>
	<span class="cm">/* clear links on error. */</span>
	<span class="n">wl12xx_free_link</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * send test command to firmware</span>
<span class="cm"> *</span>
<span class="cm"> * @wl: wl struct</span>
<span class="cm"> * @buf: buffer containing the command, with all headers, must work with dma</span>
<span class="cm"> * @len: length of the buffer</span>
<span class="cm"> * @answer: is answer needed</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wl1271_cmd_test</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">answer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">res_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd test&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">answer</span><span class="p">)</span>
		<span class="n">res_len</span> <span class="o">=</span> <span class="n">buf_len</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_TEST</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">res_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;TEST command failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wl1271_cmd_test</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * read acx from firmware</span>
<span class="cm"> *</span>
<span class="cm"> * @wl: wl struct</span>
<span class="cm"> * @id: acx id</span>
<span class="cm"> * @buf: buffer for the response, including all headers, must work with dma</span>
<span class="cm"> * @len: length of buf</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wl1271_cmd_interrogate</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_header</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd interrogate&quot;</span><span class="p">);</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* payload length, does not include any headers */</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_INTERROGATE</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;INTERROGATE command failed&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * write acx value to firmware</span>
<span class="cm"> *</span>
<span class="cm"> * @wl: wl struct</span>
<span class="cm"> * @id: acx id</span>
<span class="cm"> * @buf: buffer containing acx, including all headers, must work with dma</span>
<span class="cm"> * @len: length of buf</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wl1271_cmd_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u16</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_header</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd configure (%d)&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="cm">/* payload length, does not include any headers */</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_CONFIGURE</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;CONFIGURE command NOK&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">wl1271_cmd_configure</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">wl1271_cmd_data_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cmd_enabledisable_path</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd_rx</span><span class="p">,</span> <span class="n">cmd_tx</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd data path&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the channel here is only used for calibration, so hardcoded to 1 */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd_rx</span> <span class="o">=</span> <span class="n">CMD_ENABLE_RX</span><span class="p">;</span>
		<span class="n">cmd_tx</span> <span class="o">=</span> <span class="n">CMD_ENABLE_TX</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cmd_rx</span> <span class="o">=</span> <span class="n">CMD_DISABLE_RX</span><span class="p">;</span>
		<span class="n">cmd_tx</span> <span class="o">=</span> <span class="n">CMD_DISABLE_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">cmd_rx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;rx %s cmd for channel %d failed&quot;</span><span class="p">,</span>
			     <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;start&quot;</span> <span class="o">:</span> <span class="s">&quot;stop&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_BOOT</span><span class="p">,</span> <span class="s">&quot;rx %s cmd channel %d&quot;</span><span class="p">,</span>
		     <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;start&quot;</span> <span class="o">:</span> <span class="s">&quot;stop&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">cmd_tx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;tx %s cmd for channel %d failed&quot;</span><span class="p">,</span>
			     <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;start&quot;</span> <span class="o">:</span> <span class="s">&quot;stop&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_BOOT</span><span class="p">,</span> <span class="s">&quot;tx %s cmd channel %d&quot;</span><span class="p">,</span>
		     <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;start&quot;</span> <span class="o">:</span> <span class="s">&quot;stop&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_cmd_ps_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="n">ps_mode</span><span class="p">,</span> <span class="n">u16</span> <span class="n">auto_ps_timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_cmd_ps_params</span> <span class="o">*</span><span class="n">ps_params</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd set ps mode&quot;</span><span class="p">);</span>

	<span class="n">ps_params</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ps_params</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ps_params</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ps_params</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">ps_params</span><span class="o">-&gt;</span><span class="n">ps_mode</span> <span class="o">=</span> <span class="n">ps_mode</span><span class="p">;</span>
	<span class="n">ps_params</span><span class="o">-&gt;</span><span class="n">auto_ps_timeout</span> <span class="o">=</span> <span class="n">auto_ps_timeout</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_SET_PS_MODE</span><span class="p">,</span> <span class="n">ps_params</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ps_params</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;cmd set_ps_mode failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ps_params</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_cmd_template_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">role_id</span><span class="p">,</span>
			    <span class="n">u16</span> <span class="n">template_id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">index</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_cmd_template_set</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd template_set %d (role %d)&quot;</span><span class="p">,</span>
		     <span class="n">template_id</span><span class="p">,</span> <span class="n">role_id</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">buf_len</span> <span class="o">&gt;</span> <span class="n">WL1271_CMD_TEMPL_MAX_SIZE</span><span class="p">);</span>
	<span class="n">buf_len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">WL1271_CMD_TEMPL_MAX_SIZE</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* during initialization wlvif is NULL */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">role_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">buf_len</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">template_type</span> <span class="o">=</span> <span class="n">template_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">enabled_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rates</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tmpl_short_retry_limit</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tmpl_long_retry_limit</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">template_data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_SET_TEMPLATE</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;cmd set_template failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_build_null_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_null_data_template</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_nullfunc_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					     <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">ptr</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
				      <span class="n">CMD_TEMPL_NULL_DATA</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;cmd buld null data failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_build_klv_null_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_nullfunc_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span> <span class="n">CMD_TEMPL_KLV</span><span class="p">,</span>
				      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				      <span class="n">CMD_TEMPL_KLV_IDX_NULL_DATA</span><span class="p">,</span>
				      <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;cmd build klv null data failed %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_cmd_build_ps_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">aid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_pspoll_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
				      <span class="n">CMD_TEMPL_PS_POLL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate_set</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_build_probe_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			       <span class="n">u8</span> <span class="n">role_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">band</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ssid</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ssid_len</span><span class="p">,</span>
			       <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">ie_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_probereq_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">ssid</span><span class="p">,</span> <span class="n">ssid_len</span><span class="p">,</span>
				     <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_dump</span><span class="p">(</span><span class="n">DEBUG_SCAN</span><span class="p">,</span> <span class="s">&quot;PROBE REQ: &quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bitrate_masks</span><span class="p">[</span><span class="n">band</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">role_id</span><span class="p">,</span>
					      <span class="n">CMD_TEMPL_CFG_PROBE_REQ_2_4</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">role_id</span><span class="p">,</span>
					      <span class="n">CMD_TEMPL_CFG_PROBE_REQ_5</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">wl1271_cmd_build_ap_probe_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">ieee80211_ap_probereq_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wl1271_dump</span><span class="p">(</span><span class="n">DEBUG_SCAN</span><span class="p">,</span> <span class="s">&quot;AP PROBE REQ: &quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">wl1271_tx_min_rate_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bitrate_masks</span><span class="p">[</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
					      <span class="n">CMD_TEMPL_CFG_PROBE_REQ_2_4</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
					      <span class="n">CMD_TEMPL_CFG_PROBE_REQ_5</span><span class="p">,</span>
					      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Unable to set ap probe request template.&quot;</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_cmd_build_arp_rsp</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">extra</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">wl12xx_wlvif_to_vif</span><span class="p">(</span><span class="n">wlvif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wl12xx_arp_rsp_template</span> <span class="o">*</span><span class="n">tmpl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">arphdr</span> <span class="o">*</span><span class="n">arp_hdr</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmpl</span><span class="p">)</span> <span class="o">+</span>
			    <span class="n">WL1271_EXTRA_SPACE_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to allocate buffer for arp rsp template&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">WL1271_EXTRA_SPACE_MAX</span><span class="p">);</span>

	<span class="n">tmpl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">wl12xx_arp_rsp_template</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmpl</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tmpl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tmpl</span><span class="p">));</span>

	<span class="cm">/* llc layer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmpl</span><span class="o">-&gt;</span><span class="n">llc_hdr</span><span class="p">,</span> <span class="n">rfc1042_header</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rfc1042_header</span><span class="p">));</span>
	<span class="n">tmpl</span><span class="o">-&gt;</span><span class="n">llc_type</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_ARP</span><span class="p">);</span>

	<span class="cm">/* arp header */</span>
	<span class="n">arp_hdr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tmpl</span><span class="o">-&gt;</span><span class="n">arp_hdr</span><span class="p">;</span>
	<span class="n">arp_hdr</span><span class="o">-&gt;</span><span class="n">ar_hrd</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ARPHRD_ETHER</span><span class="p">);</span>
	<span class="n">arp_hdr</span><span class="o">-&gt;</span><span class="n">ar_pro</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ETH_P_IP</span><span class="p">);</span>
	<span class="n">arp_hdr</span><span class="o">-&gt;</span><span class="n">ar_hln</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">arp_hdr</span><span class="o">-&gt;</span><span class="n">ar_pln</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">arp_hdr</span><span class="o">-&gt;</span><span class="n">ar_op</span> <span class="o">=</span> <span class="n">cpu_to_be16</span><span class="p">(</span><span class="n">ARPOP_REPLY</span><span class="p">);</span>

	<span class="cm">/* arp payload */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tmpl</span><span class="o">-&gt;</span><span class="n">sender_hw</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">tmpl</span><span class="o">-&gt;</span><span class="n">sender_ip</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ip_addr</span><span class="p">;</span>

	<span class="cm">/* encryption space */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">encryption_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">KEY_TKIP</span>:
		<span class="n">extra</span> <span class="o">=</span> <span class="n">WL1271_EXTRA_SPACE_TKIP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KEY_AES</span>:
		<span class="n">extra</span> <span class="o">=</span> <span class="n">WL1271_EXTRA_SPACE_AES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">KEY_NONE</span>:
	<span class="k">case</span> <span class="n">KEY_WEP</span>:
	<span class="k">case</span> <span class="n">KEY_GEM</span>:
		<span class="n">extra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Unknown encryption type: %d&quot;</span><span class="p">,</span>
			       <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">encryption_type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">extra</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">space</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* QoS header - BE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">qos</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">)),</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">));</span>

	<span class="cm">/* mac80211 header */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr_3addr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">fc</span> <span class="o">=</span> <span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span> <span class="n">IEEE80211_FCTL_TODS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">qos</span><span class="p">)</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">IEEE80211_STYPE_QOS_DATA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">IEEE80211_STYPE_DATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">encryption_type</span> <span class="o">!=</span> <span class="n">KEY_NONE</span><span class="p">)</span>
		<span class="n">fc</span> <span class="o">|=</span> <span class="n">IEEE80211_FCTL_PROTECTED</span><span class="p">;</span>

	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr2</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span> <span class="n">CMD_TEMPL_ARP_RSP</span><span class="p">,</span>
				      <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_build_qos_null_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span> <span class="o">=</span> <span class="n">wl12xx_vif_to_data</span><span class="p">(</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_qos_hdr</span> <span class="n">template</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">template</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">));</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">template</span><span class="p">.</span><span class="n">addr1</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">template</span><span class="p">.</span><span class="n">addr2</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">template</span><span class="p">.</span><span class="n">addr3</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">template</span><span class="p">.</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_DATA</span> <span class="o">|</span>
					     <span class="n">IEEE80211_STYPE_QOS_NULLFUNC</span> <span class="o">|</span>
					     <span class="n">IEEE80211_FCTL_TODS</span><span class="p">);</span>

	<span class="cm">/* FIXME: not sure what priority to use here */</span>
	<span class="n">template</span><span class="p">.</span><span class="n">qos_ctrl</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">wl1271_cmd_template_set</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">,</span>
				       <span class="n">CMD_TEMPL_QOS_NULL_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">template</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="n">template</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_set_default_wep_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_cmd_set_keys</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd set_default_wep_key %d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lid_key_type</span> <span class="o">=</span> <span class="n">WEP_DEFAULT_LID_TYPE</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">KEY_SET_ID</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">KEY_WEP</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_SET_KEYS</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;cmd set_default_wep_key failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_cmd_set_sta_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">action</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_type</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="n">key_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">tx_seq_32</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tx_seq_16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_cmd_set_keys</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* hlid might have already been deleted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_LINK_ID</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">hlid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_WEP</span><span class="p">)</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lid_key_type</span> <span class="o">=</span> <span class="n">WEP_DEFAULT_LID_TYPE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lid_key_type</span> <span class="o">=</span> <span class="n">BROADCAST_LID_TYPE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lid_key_type</span> <span class="o">=</span> <span class="n">UNICAST_LID_TYPE</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">key_size</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ac_seq_num16</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx_seq_16</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ac_seq_num32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tx_seq_32</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_TKIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We get the key in the following form:</span>
<span class="cm">		 * TKIP (16 bytes) - TX MIC (8 bytes) - RX MIC (8 bytes)</span>
<span class="cm">		 * but the target is expecting:</span>
<span class="cm">		 * TKIP - RX MIC - TX MIC</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wl1271_dump</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;TARGET KEY: &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_SET_KEYS</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;could not set keys&quot;</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TODO: merge with sta/ibss into 1 set_key function.</span>
<span class="cm"> * note there are slight diffs</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">wl1271_cmd_set_ap_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">action</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_type</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">key_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hlid</span><span class="p">,</span> <span class="n">u32</span> <span class="n">tx_seq_32</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">tx_seq_16</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_cmd_set_keys</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lid_type</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hlid</span> <span class="o">==</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">ap</span><span class="p">.</span><span class="n">bcast_hlid</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_WEP</span><span class="p">)</span>
			<span class="n">lid_type</span> <span class="o">=</span> <span class="n">WEP_DEFAULT_LID_TYPE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lid_type</span> <span class="o">=</span> <span class="n">BROADCAST_LID_TYPE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lid_type</span> <span class="o">=</span> <span class="n">UNICAST_LID_TYPE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;ap key action: %d id: %d lid: %d type: %d&quot;</span>
		     <span class="s">&quot; hlid: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">action</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">lid_type</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">key_type</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hlid</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">lid_key_type</span> <span class="o">=</span> <span class="n">lid_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_action</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">action</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">key_size</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_type</span> <span class="o">=</span> <span class="n">key_type</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ac_seq_num16</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tx_seq_16</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">ac_seq_num32</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">tx_seq_32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_type</span> <span class="o">==</span> <span class="n">KEY_TKIP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We get the key in the following form:</span>
<span class="cm">		 * TKIP (16 bytes) - TX MIC (8 bytes) - RX MIC (8 bytes)</span>
<span class="cm">		 * but the target is expecting:</span>
<span class="cm">		 * TKIP - RX MIC - TX MIC</span>
<span class="cm">		 */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wl1271_dump</span><span class="p">(</span><span class="n">DEBUG_CRYPT</span><span class="p">,</span> <span class="s">&quot;TARGET AP KEY: &quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_SET_KEYS</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;could not set ap keys&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_set_peer_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_set_peer_state</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd set peer state (hlid=%d)&quot;</span><span class="p">,</span> <span class="n">hlid</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">WL1271_CMD_STA_STATE_CONNECTED</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_SET_PEER_STATE</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to send set peer state command&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_add_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_add_peer</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sta_rates</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd add peer %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hlid</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bss_index</span> <span class="o">=</span> <span class="n">WL1271_AP_BSS_INDEX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">aid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">hlid</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">sp_len</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">max_sp</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">wmm</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">wme</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_ACCESS_CATEGORIES_COPY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">wme</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">uapsd_queues</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">psd_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WL1271_PSD_UPSD_TRIGGER</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">psd_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">WL1271_PSD_LEGACY</span><span class="p">;</span>

	<span class="n">sta_rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
		<span class="n">sta_rates</span> <span class="o">|=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">HW_HT_RATES_OFFSET</span><span class="p">;</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported_rates</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wl1271_tx_enabled_rates_get</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">sta_rates</span><span class="p">,</span>
							<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">));</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;new peer rates=0x%x queues=0x%x&quot;</span><span class="p">,</span>
		     <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported_rates</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">uapsd_queues</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_ADD_PEER</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd add peer&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_remove_peer</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_remove_peer</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd remove peer %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">hlid</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">hlid</span><span class="p">;</span>
	<span class="cm">/* We never send a deauth, mac80211 is in charge of this */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">reason_opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">send_deauth_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_REMOVE_PEER</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to initiate cmd remove peer&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are ok with a timeout here. The event is sometimes not sent</span>
<span class="cm">	 * due to a firmware bug.</span>
<span class="cm">	 */</span>
	<span class="n">wl1271_cmd_wait_for_event_or_timeout</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
					     <span class="n">PEER_REMOVE_COMPLETE_EVENT_ID</span><span class="p">);</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_config_fwlog</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_config_fwlog</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd config firmware logger&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">logger_mode</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">log_severity</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">severity</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">output</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">threshold</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_CONFIG_FWLOGGER</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to send config firmware logger command&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_start_fwlog</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_start_fwlog</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd start firmware logger&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_START_FWLOGGER</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to send start firmware logger command&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_stop_fwlog</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_stop_fwlog</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd stop firmware logger&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_STOP_FWLOGGER</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to send stop firmware logger command&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_cmd_roc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">role_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_roc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd roc %d (%d)&quot;</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">role_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">role_id</span> <span class="o">==</span> <span class="n">WL12XX_INVALID_ROLE_ID</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">role_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WLCORE_BAND_2_4GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">WLCORE_BAND_5GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;roc - unknown band: %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_REMAIN_ON_CHANNEL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to send ROC command&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wl12xx_cmd_croc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">role_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_croc</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_CMD</span><span class="p">,</span> <span class="s">&quot;cmd croc (%d)&quot;</span><span class="p">,</span> <span class="n">role_id</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">role_id</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_CANCEL_REMAIN_ON_CHANNEL</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to send ROC command&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_roc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span> <span class="n">u8</span> <span class="n">role_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">role_id</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_roc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">role_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_wait_for_event</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
					<span class="n">REMAIN_ON_CHANNEL_COMPLETE_EVENT_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;cmd roc event completion error&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__set_bit</span><span class="p">(</span><span class="n">role_id</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_croc</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">role_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">role_id</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_croc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">role_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">__clear_bit</span><span class="p">(</span><span class="n">role_id</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Rearm the tx watchdog when removing the last ROC. This prevents</span>
<span class="cm">	 * recoveries due to just finished ROCs - when Tx hasn&#39;t yet had</span>
<span class="cm">	 * a chance to get out.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">find_first_bit</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">,</span> <span class="n">WL12XX_MAX_ROLES</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">WL12XX_MAX_ROLES</span><span class="p">)</span>
		<span class="n">wl12xx_rearm_tx_watchdog_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_channel_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_channel_switch</span> <span class="o">*</span><span class="n">ch_switch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_channel_switch</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;cmd channel switch&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ch_switch</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">switch_time</span> <span class="o">=</span> <span class="n">ch_switch</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">stop_tx</span> <span class="o">=</span> <span class="n">ch_switch</span><span class="o">-&gt;</span><span class="n">block_tx</span><span class="p">;</span>

	<span class="cm">/* FIXME: control from mac80211 in the future */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">post_switch_tx_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* Enable TX on the target channel */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_CHANNEL_SWITCH</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to send channel switch command&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_cmd_stop_channel_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_cmd_stop_channel_switch</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;cmd stop channel switch&quot;</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_send</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">CMD_STOP_CHANNEL_SWICTH</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;failed to stop channel switch command&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_free</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* start dev role and roc on its channel */</span>
<span class="kt">int</span> <span class="nf">wl12xx_start_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span> <span class="o">||</span>
		      <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_start_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_roc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_stop</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_stop:</span>
	<span class="n">wl12xx_cmd_role_stop_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* croc dev hlid, and stop the role */</span>
<span class="kt">int</span> <span class="nf">wl12xx_stop_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_STA_BSS</span> <span class="o">||</span>
		      <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">bss_type</span> <span class="o">==</span> <span class="n">BSS_TYPE_IBSS</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* flush all pending packets */</span>
	<span class="n">wl1271_tx_work_locked</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">roc_map</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_croc</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">dev_role_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl12xx_cmd_role_stop_dev</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
