<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › ti › wlcore › acx.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>acx.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is part of wl1271</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008-2009 Nokia Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Contact: Luciano Coelho &lt;luciano.coelho@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;acx.h&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/spi/spi.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;wlcore.h&quot;</span>
<span class="cp">#include &quot;debug.h&quot;</span>
<span class="cp">#include &quot;wl12xx_80211.h&quot;</span>
<span class="cp">#include &quot;ps.h&quot;</span>
<span class="cp">#include &quot;hw_ops.h&quot;</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_wake_up_conditions</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">wake_up_event</span><span class="p">,</span> <span class="n">u8</span> <span class="n">listen_interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_wake_up_condition</span> <span class="o">*</span><span class="n">wake_up</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx wake up conditions (wake_up_event %d listen_interval %d)&quot;</span><span class="p">,</span>
		     <span class="n">wake_up_event</span><span class="p">,</span> <span class="n">listen_interval</span><span class="p">);</span>

	<span class="n">wake_up</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wake_up</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wake_up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wake_up</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="o">-&gt;</span><span class="n">wake_up_event</span> <span class="o">=</span> <span class="n">wake_up_event</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="o">-&gt;</span><span class="n">listen_interval</span> <span class="o">=</span> <span class="n">listen_interval</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_WAKE_UP_CONDITIONS</span><span class="p">,</span>
				   <span class="n">wake_up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wake_up</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;could not set wake up conditions: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wake_up</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_sleep_auth</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sleep_auth</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_sleep_auth</span> <span class="o">*</span><span class="n">auth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx sleep auth&quot;</span><span class="p">);</span>

	<span class="n">auth</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">auth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">auth</span><span class="o">-&gt;</span><span class="n">sleep_auth</span> <span class="o">=</span> <span class="n">sleep_auth</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SLEEP_AUTH</span><span class="p">,</span> <span class="n">auth</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="p">));</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">auth</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">power</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_current_tx_power</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx dot11_cur_tx_pwr %d&quot;</span><span class="p">,</span> <span class="n">power</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">power</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">current_tx_power</span> <span class="o">=</span> <span class="n">power</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">DOT11_CUR_TX_PWR</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;configure of tx power failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_feature_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_feature_config</span> <span class="o">*</span><span class="n">feature</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx feature cfg&quot;</span><span class="p">);</span>

	<span class="n">feature</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">feature</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">feature</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DF_ENCRYPTION_DISABLE and DF_SNIFF_MODE_ENABLE are disabled */</span>
	<span class="n">feature</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">feature</span><span class="o">-&gt;</span><span class="n">data_flow_options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">feature</span><span class="o">-&gt;</span><span class="n">options</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_FEATURE_CFG</span><span class="p">,</span>
				   <span class="n">feature</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">feature</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;Couldnt set HW encryption&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">feature</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_mem_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acx_header</span> <span class="o">*</span><span class="n">mem_map</span><span class="p">,</span>
		       <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx mem map&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_interrogate</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_MEM_MAP</span><span class="p">,</span> <span class="n">mem_map</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_rx_msdu_life_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_rx_msdu_lifetime</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx rx msdu life time&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">lifetime</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_msdu_life_time</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">DOT11_RX_MSDU_LIFE_TIME</span><span class="p">,</span>
				   <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set rx msdu life time: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_slot</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
		    <span class="k">enum</span> <span class="n">acx_slot_type</span> <span class="n">slot_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_slot</span> <span class="o">*</span><span class="n">slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx slot&quot;</span><span class="p">);</span>

	<span class="n">slot</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">slot</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">wone_index</span> <span class="o">=</span> <span class="n">STATION_WONE_INDEX</span><span class="p">;</span>
	<span class="n">slot</span><span class="o">-&gt;</span><span class="n">slot_time</span> <span class="o">=</span> <span class="n">slot_time</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SLOT</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">slot</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set slot time: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">slot</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_group_address_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="n">enable</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">mc_list</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mc_list_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_dot11_grp_addr_tbl</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx group address tbl&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* MAC filtering */</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">num_groups</span> <span class="o">=</span> <span class="n">mc_list_len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">acx</span><span class="o">-&gt;</span><span class="n">mac_table</span><span class="p">,</span> <span class="n">mc_list</span><span class="p">,</span> <span class="n">mc_list_len</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">DOT11_GROUP_ADDRESS_TBL</span><span class="p">,</span>
				   <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set group addr table: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_service_period_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_rx_timeout</span> <span class="o">*</span><span class="n">rx_timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">rx_timeout</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_timeout</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_timeout</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx service period timeout&quot;</span><span class="p">);</span>

	<span class="n">rx_timeout</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">rx_timeout</span><span class="o">-&gt;</span><span class="n">ps_poll_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">ps_poll_timeout</span><span class="p">);</span>
	<span class="n">rx_timeout</span><span class="o">-&gt;</span><span class="n">upsd_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">upsd_timeout</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SERVICE_PERIOD_TIMEOUT</span><span class="p">,</span>
				   <span class="n">rx_timeout</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_timeout</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set service period timeout: %d&quot;</span><span class="p">,</span>
			       <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rx_timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">rts_threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_rts_threshold</span> <span class="o">*</span><span class="n">rts</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the RTS threshold is not configured or out of range, use the</span>
<span class="cm">	 * default value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rts_threshold</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_RTS_THRESHOLD</span><span class="p">)</span>
		<span class="n">rts_threshold</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rts_threshold</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx rts threshold: %d&quot;</span><span class="p">,</span> <span class="n">rts_threshold</span><span class="p">);</span>

	<span class="n">rts</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rts</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rts</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">rts</span><span class="o">-&gt;</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">rts_threshold</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">DOT11_RTS_THRESHOLD</span><span class="p">,</span> <span class="n">rts</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rts</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set rts threshold: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rts</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_dco_itrim_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_dco_itrim_params</span> <span class="o">*</span><span class="n">dco</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_itrim_settings</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">itrim</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx dco itrim parameters&quot;</span><span class="p">);</span>

	<span class="n">dco</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dco</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dco</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dco</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">;</span>
	<span class="n">dco</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SET_DCO_ITRIM_PARAMS</span><span class="p">,</span>
				   <span class="n">dco</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dco</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set dco itrim parameters: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dco</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_beacon_filter_opt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="n">enable_filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_beacon_filter_option</span> <span class="o">*</span><span class="n">beacon_filter</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx beacon filter opt&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable_filter</span> <span class="o">&amp;&amp;</span>
	    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">bcn_filt_mode</span> <span class="o">==</span> <span class="n">CONF_BCN_FILT_MODE_DISABLED</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">beacon_filter</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">beacon_filter</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon_filter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">beacon_filter</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">beacon_filter</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable_filter</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * When set to zero, and the filter is enabled, beacons</span>
<span class="cm">	 * without the unicast TIM bit set are dropped.</span>
<span class="cm">	 */</span>
	<span class="n">beacon_filter</span><span class="o">-&gt;</span><span class="n">max_num_beacons</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_BEACON_FILTER_OPT</span><span class="p">,</span>
				   <span class="n">beacon_filter</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">beacon_filter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set beacon filter opt: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">beacon_filter</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_beacon_filter_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_beacon_filter_ie_table</span> <span class="o">*</span><span class="n">ie_table</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">vendor_spec</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx beacon filter table&quot;</span><span class="p">);</span>

	<span class="n">ie_table</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ie_table</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ie_table</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* configure default beacon pass-through rules */</span>
	<span class="n">ie_table</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">ie_table</span><span class="o">-&gt;</span><span class="n">num_ie</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">bcn_filt_ie_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">conf_bcn_filt_rule</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">bcn_filt_ie</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ie_table</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">;</span>
		<span class="n">ie_table</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">rule</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">ie</span> <span class="o">==</span> <span class="n">WLAN_EID_VENDOR_SPECIFIC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* only one vendor specific ie allowed */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vendor_spec</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* for vendor specific rules configure the</span>
<span class="cm">			   additional fields */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ie_table</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">,</span>
			       <span class="n">CONF_BCN_IE_OUI_LEN</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="n">CONF_BCN_IE_OUI_LEN</span><span class="p">;</span>
			<span class="n">ie_table</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">ie_table</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">[</span><span class="n">idx</span><span class="p">]),</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span>
			       <span class="n">CONF_BCN_IE_VER_LEN</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="n">CONF_BCN_IE_VER_LEN</span><span class="p">;</span>
			<span class="n">vendor_spec</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ie_table</span><span class="o">-&gt;</span><span class="n">num_ie</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_BEACON_FILTER_TABLE</span><span class="p">,</span>
				   <span class="n">ie_table</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ie_table</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set beacon filter table: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ie_table</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ACX_CONN_MONIT_DISABLE_VALUE  0xffffffff</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_conn_monit_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				 <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_conn_monit_params</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">threshold</span> <span class="o">=</span> <span class="n">ACX_CONN_MONIT_DISABLE_VALUE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">ACX_CONN_MONIT_DISABLE_VALUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx connection monitor parameters: %s&quot;</span><span class="p">,</span>
		     <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">threshold</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">synch_fail_thold</span><span class="p">;</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">bss_lose_timeout</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">synch_fail_thold</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">threshold</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">bss_lose_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_CONN_MONIT_PARAMS</span><span class="p">,</span>
				   <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set connection monitor &quot;</span>
			       <span class="s">&quot;parameters: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">wl1271_acx_sg_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_bt_wlan_coex</span> <span class="o">*</span><span class="n">pta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx sg enable&quot;</span><span class="p">);</span>

	<span class="n">pta</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pta</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">pta</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">sg</span><span class="p">.</span><span class="n">state</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pta</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">CONF_SG_DISABLE</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SG_ENABLE</span><span class="p">,</span> <span class="n">pta</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pta</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set softgemini enable: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pta</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_acx_sg_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_bt_wlan_coex_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_sg_settings</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">sg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx sg cfg&quot;</span><span class="p">);</span>

	<span class="n">param</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">param</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BT-WLAN coext parameters */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CONF_SG_PARAMS_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">param</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">param</span><span class="o">-&gt;</span><span class="n">param_idx</span> <span class="o">=</span> <span class="n">CONF_SG_PARAMS_ALL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SG_CFG</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">param</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set sg config: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_cca_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_energy_detection</span> <span class="o">*</span><span class="n">detection</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx cca threshold&quot;</span><span class="p">);</span>

	<span class="n">detection</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">detection</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">detection</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">detection</span><span class="o">-&gt;</span><span class="n">rx_cca_threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">rx_cca_threshold</span><span class="p">);</span>
	<span class="n">detection</span><span class="o">-&gt;</span><span class="n">tx_energy_detection</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_energy_detection</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_CCA_THRESHOLD</span><span class="p">,</span>
				   <span class="n">detection</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">detection</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set cca threshold: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">detection</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_bcn_dtim_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_beacon_broadcast</span> <span class="o">*</span><span class="n">bb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx bcn dtim options&quot;</span><span class="p">);</span>

	<span class="n">bb</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bb</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bb</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">bb</span><span class="o">-&gt;</span><span class="n">beacon_rx_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">beacon_rx_timeout</span><span class="p">);</span>
	<span class="n">bb</span><span class="o">-&gt;</span><span class="n">broadcast_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">broadcast_timeout</span><span class="p">);</span>
	<span class="n">bb</span><span class="o">-&gt;</span><span class="n">rx_broadcast_in_ps</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">rx_broadcast_in_ps</span><span class="p">;</span>
	<span class="n">bb</span><span class="o">-&gt;</span><span class="n">ps_poll_threshold</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">ps_poll_threshold</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_BCN_DTIM_OPTIONS</span><span class="p">,</span> <span class="n">bb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bb</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set rx config: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">bb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_aid</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">aid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_aid</span> <span class="o">*</span><span class="n">acx_aid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx aid&quot;</span><span class="p">);</span>

	<span class="n">acx_aid</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx_aid</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx_aid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx_aid</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx_aid</span><span class="o">-&gt;</span><span class="n">aid</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">aid</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_AID</span><span class="p">,</span> <span class="n">acx_aid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx_aid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set aid: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx_aid</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_event_mbox_mask</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_event_mask</span> <span class="o">*</span><span class="n">mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx event mbox mask&quot;</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* high event mask is unused */</span>
	<span class="n">mask</span><span class="o">-&gt;</span><span class="n">high_event_mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">);</span>
	<span class="n">mask</span><span class="o">-&gt;</span><span class="n">event_mask</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">event_mask</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_EVENT_MBOX_MASK</span><span class="p">,</span>
				   <span class="n">mask</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mask</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set acx_event_mbox_mask: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_set_preamble</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">acx_preamble_type</span> <span class="n">preamble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_preamble</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx_set_preamble&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">preamble</span> <span class="o">=</span> <span class="n">preamble</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_PREAMBLE_TYPE</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of preamble failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_cts_protect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">acx_ctsprotect_type</span> <span class="n">ctsprotect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_ctsprotect</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx_set_ctsprotect&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ctsprotect</span> <span class="o">=</span> <span class="n">ctsprotect</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_CTS_PROTECTION</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of ctsprotect failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_statistics</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">acx_statistics</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx statistics&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_interrogate</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_STATISTICS</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx statistics failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_sta_rate_policies</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_rate_policy</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_tx_rate_class</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">sta_rc_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx rate policies&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;basic_rate: 0x%x, full_rate: 0x%x&quot;</span><span class="p">,</span>
		<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">,</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">rate_set</span><span class="p">);</span>

	<span class="cm">/* configure one basic rate class */</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy_idx</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">basic_rate_idx</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">enabled_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">aflags</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">aflags</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_RATE_POLICY</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of rate policies failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* configure one AP supported rate class */</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy_idx</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">ap_rate_idx</span><span class="p">);</span>

	<span class="cm">/* the AP policy is HW specific */</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">enabled_rates</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlcore_hw_sta_get_ap_rate_mask</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wlvif</span><span class="p">));</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">aflags</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">aflags</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_RATE_POLICY</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of rate policies failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * configure one rate class for basic p2p operations.</span>
<span class="cm">	 * (p2p packets should always go out with OFDM rates, even</span>
<span class="cm">	 * if we are currently connected to 11b AP)</span>
<span class="cm">	 */</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy_idx</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">sta</span><span class="p">.</span><span class="n">p2p_rate_idx</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">enabled_rates</span> <span class="o">=</span>
				<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">CONF_TX_RATE_MASK_BASIC_P2P</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">aflags</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">aflags</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_RATE_POLICY</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of rate policies failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_ap_rate_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">conf_tx_rate_class</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_rate_policy</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx ap rate policy %d rates 0x%x&quot;</span><span class="p">,</span>
		     <span class="n">idx</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">enabled_rates</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">enabled_rates</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">enabled_rates</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">short_retry_limit</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">short_retry_limit</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">long_retry_limit</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">long_retry_limit</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy</span><span class="p">.</span><span class="n">aflags</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">aflags</span><span class="p">;</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_policy_idx</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">idx</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_RATE_POLICY</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of ap rate policy failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_ac_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
		      <span class="n">u8</span> <span class="n">ac</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cw_min</span><span class="p">,</span> <span class="n">u16</span> <span class="n">cw_max</span><span class="p">,</span> <span class="n">u8</span> <span class="n">aifsn</span><span class="p">,</span> <span class="n">u16</span> <span class="n">txop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_ac_cfg</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx ac cfg %d cw_ming %d cw_max %d &quot;</span>
		     <span class="s">&quot;aifs %d txop %d&quot;</span><span class="p">,</span> <span class="n">ac</span><span class="p">,</span> <span class="n">cw_min</span><span class="p">,</span> <span class="n">cw_max</span><span class="p">,</span> <span class="n">aifsn</span><span class="p">,</span> <span class="n">txop</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ac</span> <span class="o">=</span> <span class="n">ac</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">cw_min</span> <span class="o">=</span> <span class="n">cw_min</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">cw_max</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cw_max</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">aifsn</span> <span class="o">=</span> <span class="n">aifsn</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tx_op_limit</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">txop</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_AC_CFG</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx ac cfg failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_tid_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="n">queue_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel_type</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="n">tsid</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ps_scheme</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ack_policy</span><span class="p">,</span>
		       <span class="n">u32</span> <span class="n">apsd_conf0</span><span class="p">,</span> <span class="n">u32</span> <span class="n">apsd_conf1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_tid_config</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx tid config&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">=</span> <span class="n">queue_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">=</span> <span class="n">channel_type</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tsid</span> <span class="o">=</span> <span class="n">tsid</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ps_scheme</span> <span class="o">=</span> <span class="n">ps_scheme</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ack_policy</span> <span class="o">=</span> <span class="n">ack_policy</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">apsd_conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">apsd_conf0</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">apsd_conf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">apsd_conf1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_TID_CFG</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of tid config failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_frag_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">frag_threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_frag_threshold</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the fragmentation is not configured or out of range, use the</span>
<span class="cm">	 * default value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frag_threshold</span> <span class="o">&gt;</span> <span class="n">IEEE80211_MAX_FRAG_THRESHOLD</span><span class="p">)</span>
		<span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">frag_threshold</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx frag threshold: %d&quot;</span><span class="p">,</span> <span class="n">frag_threshold</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">frag_threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">frag_threshold</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_FRAG_CFG</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of frag threshold failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_tx_config_options</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_tx_config_options</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx tx config options&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tx_compl_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_compl_timeout</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tx_compl_threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_compl_threshold</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_TX_CONFIG_OPT</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;Setting of tx options failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_acx_mem_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_acx_config_memory</span> <span class="o">*</span><span class="n">mem_conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_memory_settings</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;wl1271 mem cfg&quot;</span><span class="p">);</span>

	<span class="n">mem_conf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_conf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem_conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">mem</span><span class="p">;</span>

	<span class="cm">/* memory config */</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">num_stations</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">num_stations</span><span class="p">;</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">rx_mem_block_num</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">rx_block_num</span><span class="p">;</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">tx_min_mem_block_num</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">tx_min_block_num</span><span class="p">;</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">num_ssid_profiles</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">ssid_profiles</span><span class="p">;</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">total_tx_descriptors</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">num_tx_desc</span><span class="p">);</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">dyn_mem_enable</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">dynamic_memory</span><span class="p">;</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">tx_free_req</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">min_req_tx_blocks</span><span class="p">;</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">rx_free_req</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">min_req_rx_blocks</span><span class="p">;</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">tx_min</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">tx_min</span><span class="p">;</span>
	<span class="n">mem_conf</span><span class="o">-&gt;</span><span class="n">fwlog_blocks</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fwlog</span><span class="p">.</span><span class="n">mem_blocks</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_MEM_CFG</span><span class="p">,</span> <span class="n">mem_conf</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mem_conf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;wl1271 mem config failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mem_conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_init_mem_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_acx_mem_map</span><span class="p">),</span>
				     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;couldn&#39;t allocate target memory map&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we now ask for the firmware built memory map */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_acx_mem_map</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271_acx_mem_map</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_error</span><span class="p">(</span><span class="s">&quot;couldn&#39;t retrieve firmware memory map&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize TX block book keeping */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_available</span> <span class="o">=</span>
		<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">target_mem_map</span><span class="o">-&gt;</span><span class="n">num_tx_mem_blocks</span><span class="p">);</span>
	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_TX</span><span class="p">,</span> <span class="s">&quot;available tx blocks: %d&quot;</span><span class="p">,</span>
		     <span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_blocks_available</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_init_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_rx_config_opt</span> <span class="o">*</span><span class="n">rx_conf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;wl1271 rx interrupt config&quot;</span><span class="p">);</span>

	<span class="n">rx_conf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_conf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_conf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rx_conf</span><span class="o">-&gt;</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">irq_pkt_threshold</span><span class="p">);</span>
	<span class="n">rx_conf</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">irq_timeout</span><span class="p">);</span>
	<span class="n">rx_conf</span><span class="o">-&gt;</span><span class="n">mblk_threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">irq_blk_threshold</span><span class="p">);</span>
	<span class="n">rx_conf</span><span class="o">-&gt;</span><span class="n">queue_type</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">queue_type</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_RX_CONFIG_OPT</span><span class="p">,</span> <span class="n">rx_conf</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_conf</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;wl1271 rx config opt failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rx_conf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_bet_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			  <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_bet_enable</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx bet enable&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">bet_enable</span> <span class="o">==</span> <span class="n">CONF_BET_MODE_DISABLE</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">CONF_BET_MODE_ENABLE</span> <span class="o">:</span> <span class="n">CONF_BET_MODE_DISABLE</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">max_consecutive</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">bet_max_consecutive</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_BET_ENABLE</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx bet enable failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_arp_ip_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">enable</span><span class="p">,</span> <span class="n">__be32</span> <span class="n">address</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_arp_filter</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx arp ip filter, enable: %d&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">ACX_IPV4_VERSION</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">acx</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">address</span><span class="p">,</span> <span class="n">ACX_IPV4_ADDR_SIZE</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_ARP_IP_FILTER</span><span class="p">,</span>
				   <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;failed to set arp ip filter: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_pm_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_pm_config</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span>  <span class="n">conf_pm_config_settings</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">pm_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx pm config&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">host_clk_settling_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">host_clk_settling_time</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">host_fast_wakeup_support</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">host_fast_wakeup_support</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_PM_CONFIG</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx pm config failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_keep_alive_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_keep_alive_mode</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx keep alive mode: %d&quot;</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_KEEP_ALIVE_MODE</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx keep alive mode failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_keep_alive_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tpl_valid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_keep_alive_config</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx keep alive config&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">keep_alive_interval</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tpl_validation</span> <span class="o">=</span> <span class="n">tpl_valid</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">=</span> <span class="n">ACX_KEEP_ALIVE_NO_TX</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SET_KEEP_ALIVE_CONFIG</span><span class="p">,</span>
				   <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx keep alive config failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_rssi_snr_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">enable</span><span class="p">,</span> <span class="n">s16</span> <span class="n">thold</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hyst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_rssi_snr_trigger</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx rssi snr trigger&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">last_rssi_event</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">pacing</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">roam_trigger</span><span class="p">.</span><span class="n">trigger_pacing</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">metric</span> <span class="o">=</span> <span class="n">WL1271_ACX_TRIG_METRIC_RSSI_BEACON</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">WL1271_ACX_TRIG_TYPE_EDGE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">WL1271_ACX_TRIG_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">WL1271_ACX_TRIG_DISABLE</span><span class="p">;</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">WL1271_ACX_TRIG_IDX_RSSI</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">dir</span> <span class="o">=</span> <span class="n">WL1271_ACX_TRIG_DIR_BIDIR</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">thold</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">hysteresis</span> <span class="o">=</span> <span class="n">hyst</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_RSSI_SNR_TRIGGER</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx rssi snr trigger setting failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_rssi_snr_avg_weights</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_rssi_snr_avg_weights</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_roam_trigger_settings</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">roam_trigger</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx rssi snr avg weights&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rssi_beacon</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">avg_weight_rssi_beacon</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rssi_data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">avg_weight_rssi_data</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">snr_beacon</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">avg_weight_snr_beacon</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">snr_data</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">avg_weight_snr_data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_RSSI_SNR_WEIGHTS</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx rssi snr trigger weights failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_set_ht_capabilities</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span><span class="p">,</span>
				    <span class="n">bool</span> <span class="n">allow_ht_operation</span><span class="p">,</span> <span class="n">u8</span> <span class="n">hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_ht_capabilities</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ht_capabilites</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx ht capabilities setting &quot;</span>
		     <span class="s">&quot;sta supp: %d sta cap: %d&quot;</span><span class="p">,</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ht_supported</span><span class="p">,</span>
		     <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">allow_ht_operation</span> <span class="o">&amp;&amp;</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ht_supported</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no need to translate capabilities - use the spec values */</span>
		<span class="n">ht_capabilites</span> <span class="o">=</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * this bit is not employed by the spec but only by FW to</span>
<span class="cm">		 * indicate peer HT support</span>
<span class="cm">		 */</span>
		<span class="n">ht_capabilites</span> <span class="o">|=</span> <span class="n">WL12XX_HT_CAP_HT_OPERATION</span><span class="p">;</span>

		<span class="cm">/* get data from A-MPDU parameters field */</span>
		<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ampdu_max_length</span> <span class="o">=</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_factor</span><span class="p">;</span>
		<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ampdu_min_spacing</span> <span class="o">=</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">ampdu_density</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">hlid</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ht_capabilites</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ht_capabilites</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_PEER_HT_CAP</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx ht capabilities setting failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_set_ht_information</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
				   <span class="n">u16</span> <span class="n">ht_operation_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_ht_information</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx ht information setting&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ht_protection</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">ht_operation_mode</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rifs_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">gf_protection</span> <span class="o">=</span>
		<span class="o">!!</span><span class="p">(</span><span class="n">ht_operation_mode</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_OP_MODE_NON_GF_STA_PRSNT</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ht_tx_burst_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">dual_cts_protection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_HT_BSS_OPERATION</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx ht information setting failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Configure BA session initiator/receiver parameters setting in the FW. */</span>
<span class="kt">int</span> <span class="nf">wl12xx_acx_set_ba_initiator_policy</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_ba_initiator_policy</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx ba initiator policy&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set for the current role */</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tid_bitmap</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">tx_ba_tid_bitmap</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">win_size</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">tx_ba_win_size</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">inactivity_timeout</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">inactivity_timeout</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span>
				   <span class="n">ACX_BA_SESSION_INIT_POLICY</span><span class="p">,</span>
				   <span class="n">acx</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx ba initiator policy failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* setup BA session receiver setting in the FW. */</span>
<span class="kt">int</span> <span class="nf">wl12xx_acx_set_ba_receiver_session</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid_index</span><span class="p">,</span>
				       <span class="n">u16</span> <span class="n">ssn</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">,</span> <span class="n">u8</span> <span class="n">peer_hlid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_ba_receiver_setup</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx ba receiver session setting&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">hlid</span> <span class="o">=</span> <span class="n">peer_hlid</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">tid_index</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">win_size</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">ht</span><span class="p">.</span><span class="n">rx_ba_win_size</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ssn</span> <span class="o">=</span> <span class="n">ssn</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_BA_SESSION_RX_SETUP</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx ba receiver session failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_acx_tsf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			<span class="n">u64</span> <span class="o">*</span><span class="n">mactime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_acx_fw_tsf_information</span> <span class="o">*</span><span class="n">tsf_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">tsf_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tsf_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tsf_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tsf_info</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_interrogate</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_TSF_INFO</span><span class="p">,</span>
				     <span class="n">tsf_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tsf_info</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx tsf info interrogate failed&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">mactime</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsf_info</span><span class="o">-&gt;</span><span class="n">current_tsf_low</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tsf_info</span><span class="o">-&gt;</span><span class="n">current_tsf_high</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">tsf_info</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_ps_rx_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">,</span>
			       <span class="n">bool</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_ps_rx_streaming</span> <span class="o">*</span><span class="n">rx_streaming</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">conf_queues</span><span class="p">,</span> <span class="n">enable_queues</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx ps rx streaming&quot;</span><span class="p">);</span>

	<span class="n">rx_streaming</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_streaming</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">conf_queues</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_streaming</span><span class="p">.</span><span class="n">queues</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">enable_queues</span> <span class="o">=</span> <span class="n">conf_queues</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">enable_queues</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Skip non-changed queues, to avoid redundant acxs.</span>
<span class="cm">		 * this check assumes conf.rx_streaming.queues can&#39;t</span>
<span class="cm">		 * be changed while rx_streaming is enabled.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">conf_queues</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">rx_streaming</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
		<span class="n">rx_streaming</span><span class="o">-&gt;</span><span class="n">tid</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rx_streaming</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable_queues</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
		<span class="n">rx_streaming</span><span class="o">-&gt;</span><span class="n">period</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_streaming</span><span class="p">.</span><span class="n">interval</span><span class="p">;</span>
		<span class="n">rx_streaming</span><span class="o">-&gt;</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rx_streaming</span><span class="p">.</span><span class="n">interval</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_PS_RX_STREAMING</span><span class="p">,</span>
					   <span class="n">rx_streaming</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_streaming</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx ps rx streaming failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">rx_streaming</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_ap_max_tx_retry</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_ap_max_tx_retry</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx ap max tx retry&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">role_id</span> <span class="o">=</span> <span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">role_id</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">max_tx_retry</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">tx</span><span class="p">.</span><span class="n">max_tx_retries</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_MAX_TX_FAILURE</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx ap max tx retry failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_acx_config_ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wl12xx_vif</span> <span class="o">*</span><span class="n">wlvif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_config_ps</span> <span class="o">*</span><span class="n">config_ps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx config ps&quot;</span><span class="p">);</span>

	<span class="n">config_ps</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">config_ps</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config_ps</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config_ps</span><span class="o">-&gt;</span><span class="n">exit_retries</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">psm_exit_retries</span><span class="p">;</span>
	<span class="n">config_ps</span><span class="o">-&gt;</span><span class="n">enter_retries</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">conn</span><span class="p">.</span><span class="n">psm_entry_retries</span><span class="p">;</span>
	<span class="n">config_ps</span><span class="o">-&gt;</span><span class="n">null_data_rate</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wlvif</span><span class="o">-&gt;</span><span class="n">basic_rate</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_CONFIG_PS</span><span class="p">,</span> <span class="n">config_ps</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">config_ps</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx config ps failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">config_ps</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_set_inconnection_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_inconnection_sta</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx set inconnaction sta %pM&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">acx</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_UPDATE_INCONNECTION_STA_LIST</span><span class="p">,</span>
				   <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx set inconnaction sta failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl1271_acx_fm_coex</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl1271_acx_fm_coex</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx fm coex setting&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">enable</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">swallow_period</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">swallow_period</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">n_divider_fref_set_1</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">n_divider_fref_set_1</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">n_divider_fref_set_2</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">n_divider_fref_set_2</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">m_divider_fref_set_1</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">m_divider_fref_set_1</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">m_divider_fref_set_2</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">m_divider_fref_set_2</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">coex_pll_stabilization_time</span> <span class="o">=</span>
		<span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">coex_pll_stabilization_time</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">ldo_stabilization_time</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">ldo_stabilization_time</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">fm_disturbed_band_margin</span> <span class="o">=</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">fm_disturbed_band_margin</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">swallow_clk_diff</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">fm_coex</span><span class="p">.</span><span class="n">swallow_clk_diff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_FM_COEX_CFG</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx fm coex setting failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_acx_set_rate_mgmt_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_acx_set_rate_mgmt_params</span> <span class="o">*</span><span class="n">acx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_rate_policy_settings</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx set rate mgmt params&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">ACX_RATE_MGMT_ALL_PARAMS</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_retry_score</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">rate_retry_score</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">per_add</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">per_add</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">per_th1</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">per_th1</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">per_th2</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">per_th2</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">max_per</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_per</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">inverse_curiosity_factor</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">inverse_curiosity_factor</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tx_fail_low_th</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">tx_fail_low_th</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">tx_fail_high_th</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">tx_fail_high_th</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">per_alpha_shift</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">per_alpha_shift</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">per_add_shift</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">per_add_shift</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">per_beta1_shift</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">per_beta1_shift</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">per_beta2_shift</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">per_beta2_shift</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_check_up</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">rate_check_up</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_check_down</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">rate_check_down</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_retry_policy</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">rate_retry_policy</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">acx</span><span class="o">-&gt;</span><span class="n">rate_retry_policy</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SET_RATE_MGMT_PARAMS</span><span class="p">,</span>
				   <span class="n">acx</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx set rate mgmt params failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">wl12xx_acx_config_hangover</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wl12xx_acx_config_hangover</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_hangover_settings</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">.</span><span class="n">hangover</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx config hangover&quot;</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">recover_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">recover_time</span><span class="p">);</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">hangover_period</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">hangover_period</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">dynamic_mode</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">dynamic_mode</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">early_termination_mode</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">early_termination_mode</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">max_period</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">max_period</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">min_period</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">min_period</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">increase_delta</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">increase_delta</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">decrease_delta</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">decrease_delta</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">quiet_time</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">quiet_time</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">increase_time</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">increase_time</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">acx</span><span class="o">-&gt;</span><span class="n">window_size</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_CONFIG_HANGOVER</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx config hangover failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/* Set the global behaviour of RX filters - On/Off + default action */</span>
<span class="kt">int</span> <span class="nf">wl1271_acx_default_rx_filter_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">rx_filter_action</span> <span class="n">action</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_default_rx_filter</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;acx default rx filter en: %d act: %d&quot;</span><span class="p">,</span>
		     <span class="n">enable</span><span class="p">,</span> <span class="n">action</span><span class="p">);</span>

	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">default_action</span> <span class="o">=</span> <span class="n">action</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_ENABLE_RX_DATA_FILTER</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;acx default rx filter enable failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Configure or disable a specific RX filter pattern */</span>
<span class="kt">int</span> <span class="nf">wl1271_acx_set_rx_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">wl1271</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">enable</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">wl12xx_rx_filter</span> <span class="o">*</span><span class="n">filter</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">acx_rx_filter_cfg</span> <span class="o">*</span><span class="n">acx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fields_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">acx_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">filter</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">WL1271_MAX_RX_FILTERS</span><span class="p">);</span>

	<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span>
		     <span class="s">&quot;acx set rx filter idx: %d enable: %d filter: %p&quot;</span><span class="p">,</span>
		     <span class="n">index</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">filter</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fields_size</span> <span class="o">=</span> <span class="n">wl1271_rx_filter_get_fields_size</span><span class="p">(</span><span class="n">filter</span><span class="p">);</span>

		<span class="n">wl1271_debug</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;act: %d num_fields: %d field_size: %d&quot;</span><span class="p">,</span>
		      <span class="n">filter</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">,</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">num_fields</span><span class="p">,</span> <span class="n">fields_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">acx_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">acx</span><span class="p">)</span> <span class="o">+</span> <span class="n">fields_size</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">acx</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">acx_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acx</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="n">acx</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acx</span><span class="o">-&gt;</span><span class="n">num_fields</span> <span class="o">=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">num_fields</span><span class="p">;</span>
		<span class="n">acx</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">filter</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
		<span class="n">wl1271_rx_filter_flatten_fields</span><span class="p">(</span><span class="n">filter</span><span class="p">,</span> <span class="n">acx</span><span class="o">-&gt;</span><span class="n">fields</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wl1271_dump</span><span class="p">(</span><span class="n">DEBUG_ACX</span><span class="p">,</span> <span class="s">&quot;RX_FILTER: &quot;</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="n">acx_size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wl1271_cmd_configure</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">ACX_SET_RX_DATA_FILTER</span><span class="p">,</span> <span class="n">acx</span><span class="p">,</span> <span class="n">acx_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl1271_warning</span><span class="p">(</span><span class="s">&quot;setting rx filter failed: %d&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">acx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
